<!doctype html>
<html>
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile â€” Stay Hi</title>
  <style>
    body{font-family:system-ui;background:#FFFDF9;margin:0}
    .wrap{max-width:720px;margin:40px auto;background:#fff;border:1px solid #eee;border-radius:16px;padding:20px}
    .row{display:flex;gap:14px;align-items:center}
    .avatar{width:72px;height:72px;border-radius:50%;object-fit:cover;border:1px solid #ddd}
    label{display:block;font-size:14px;margin-top:12px}
    input[type="text"]{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;margin-top:6px}
    input[type="file"]{margin-top:6px}
    button{padding:12px 16px;border:0;border-radius:10px;background:#065f46;color:#fff;font-weight:700;cursor:pointer}
    .ghost{background:#fff;color:#111;border:1px solid #ddd}
    .err{color:#b00020;margin-top:10px}
    .ok{color:#065f46;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <img id="av" class="avatar" src="https://ucarecdn.com/4233fafa-2eee-45bf-bee2-eb6578070c5b/-/format/auto/" alt="avatar">
      <div>
        <div id="e" style="font-weight:700"></div>
        <div id="u" style="color:#666"></div>
      </div>
    </div>

    <form id="f">
      <label>Username
        <input type="text" id="username" placeholder="yourname">
      </label>
      <label>Avatar (PNG/JPEG/WEBP up to 8MB)
        <input type="file" id="file" accept="image/png,image/jpeg,image/webp">
      </label>
      <div class="row" style="margin-top:16px">
        <button type="submit" id="save">Save changes</button>
        <button class="ghost" id="home">Home</button>
        <button class="ghost" id="logout" type="button">Log out</button>
      </div>
      <div class="err" id="err"></div>
      <div class="ok" id="ok"></div>
    </form>
  </div>

<script>
  function fileToDataURL(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file);});}
  async function downscale(dataUrl, max=512){
    try{
      const img=new Image(); img.crossOrigin='anonymous';
      await new Promise((r,j)=>{img.onload=r; img.onerror=j; img.src=dataUrl;});
      const scale=Math.min(1, max/Math.max(img.width,img.height));
      if(scale>=1) return dataUrl;
      const c=document.createElement('canvas'); c.width=Math.round(img.width*scale); c.height=Math.round(img.height*scale);
      const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height);
      const mime=(dataUrl.split(';')[0]||'image/png').replace('data:','');
      return c.toDataURL(mime,0.92);
    }catch{ return dataUrl; }
  }

  // load user
  (async ()=>{
    const m = await fetch('/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'me'})}).then(r=>r.json());
    if(!m?.user){ location.href='signin.html'; return; }
    e.textContent = m.user.email||'';
    u.textContent = m.user.username ? `@${m.user.username}` : 'No username yet';
    if(m.user.avatar_url) av.src=m.user.avatar_url;
    username.value = m.user.username||'';
  })();

  home.onclick=(ev)=>{ev.preventDefault();location.href='index.html';};
  logout.onclick=async ()=>{ await fetch('/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'logout'})}); location.href='index.html'; };

  f.onsubmit = async (e)=>{
    e.preventDefault(); err.textContent=''; ok.textContent=''; save.disabled=true;
    let avatarDataUrl=null;
    const fEl=document.getElementById('file');
    if(fEl.files && fEl.files[0]){
      const data = await fileToDataURL(fEl.files[0]);
      avatarDataUrl = await downscale(data,512);
      av.src = avatarDataUrl; // preview
    }
    const r = await fetch('/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'profile.update', username:username.value||null, avatarDataUrl})});
    const x = await r.json().catch(()=>({}));
    save.disabled=false;
    if(r.ok && x?.ok){ ok.textContent='Saved!'; if(x.user?.username) u.textContent='@'+x.user.username; if(x.user?.avatar_url) av.src = x.user.avatar_url; }
    else{ err.textContent = x?.error || 'Save failed'; }
  };
</script>
</body>
</html>
