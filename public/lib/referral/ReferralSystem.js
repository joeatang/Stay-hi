/**
 * ReferralSystem.js - Tesla-Grade Hi Network Referral Engine
 * 
 * FEATURES:
 * - Automated code generation for Stan community signups
 * - Referral tracking with attribution 
 * - Leaderboards for top referrers
 * - Badges and rewards for referral milestones
 * - Time-limited trial codes for beta testing
 * 
 * CODE TIERS:
 * - Owner codes: Manual distribution for data collection
 * - Member codes: Community referral incentives  
 * - Auto codes: Stan integration for new memberships
 */

export class HiReferralSystem {
  constructor() {
    this.codeTypes = {
      OWNER: 'owner',      // Manual distribution by you
      MEMBER: 'member',    // Generated by community members
      AUTO: 'auto',       // Automated Stan integration
      BETA: 'beta'        // Special beta testing codes
    };
    
    this.initialized = false;
  }

  /**
   * Initialize referral system
   */
  async initialize() {
    console.log('ðŸ”— [Referral] Initializing Hi Network referral engine...');
    
    try {
      // Set up code validation
      await this.setupCodeValidation();
      
      // Initialize leaderboard tracking
      await this.initializeLeaderboards();
      
      // Set up member code generation
      await this.setupMemberCodeGeneration();
      
      this.initialized = true;
      console.log('âœ… [Referral] System initialized');
      
    } catch (error) {
      console.error('âŒ [Referral] Initialization failed:', error);
    }
  }

  /**
   * Generate referral code for member
   */
  async generateMemberCode(userId, tier = 'TIER_1', options = {}) {
    console.log('ðŸŽ« [Referral] Generating member code for:', userId);
    
    try {
      // Generate unique code
      const code = this.generateUniqueCode(userId, 'MEMBER');
      
      // Code configuration
      const codeConfig = {
        code,
        type: this.codeTypes.MEMBER,
        generatedBy: userId,
        targetTier: tier,
        maxUses: options.maxUses || 10,
        validForHours: options.validForHours || 24,
        createdAt: Date.now(),
        expiresAt: Date.now() + ((options.validForHours || 24) * 60 * 60 * 1000),
        uses: 0,
        attribution: []
      };
      
      // Store in Supabase (would be actual implementation)
      await this.storeReferralCode(codeConfig);
      
      // Track code generation
      await this.trackReferralEvent(userId, 'code_generated', { code, tier });
      
      console.log('âœ… [Referral] Member code generated:', code);
      return { success: true, code, config: codeConfig };
      
    } catch (error) {
      console.error('âŒ [Referral] Member code generation failed:', error);
      return { success: false, error: error.message };
    }
  }

  /**
   * Generate beta testing code (owner distribution)
   */
  async generateBetaCode(purpose, options = {}) {
    console.log('ðŸ§ª [Referral] Generating beta code for:', purpose);
    
    const code = this.generateUniqueCode('owner', 'BETA');
    
    const codeConfig = {
      code,
      type: this.codeTypes.BETA,
      generatedBy: 'owner',
      purpose,
      targetTier: options.tier || 'TIER_2',
      maxUses: options.maxUses || 5,
      validForHours: options.validForHours || 72,
      createdAt: Date.now(),
      expiresAt: Date.now() + ((options.validForHours || 72) * 60 * 60 * 1000),
      uses: 0,
      attribution: []
    };
    
    await this.storeReferralCode(codeConfig);
    
    console.log('âœ… [Referral] Beta code generated:', code);
    return { success: true, code, config: codeConfig };
  }

  /**
   * Generate unique referral code
   */
  generateUniqueCode(userId, type) {
    const timestamp = Date.now().toString(36);
    const userHash = userId.slice(0, 4).toUpperCase();
    const typePrefix = {
      'MEMBER': 'HI',
      'BETA': 'HIBETA', 
      'AUTO': 'HIAUTO',
      'OWNER': 'HIOWN'
    }[type] || 'HI';
    
    return `${typePrefix}${userHash}${timestamp}`.toUpperCase();
  }

  /**
   * Validate and use referral code
   */
  async useReferralCode(code, newUserId) {
    console.log('ðŸŽŸï¸ [Referral] Validating code:', code);
    
    try {
      // Get code configuration
      const codeConfig = await this.getReferralCode(code);
      
      if (!codeConfig) {
        throw new Error('Invalid referral code');
      }
      
      // Check expiration
      if (Date.now() > codeConfig.expiresAt) {
        throw new Error('Referral code has expired');
      }
      
      // Check usage limit
      if (codeConfig.uses >= codeConfig.maxUses) {
        throw new Error('Referral code has reached usage limit');
      }
      
      // Record usage
      await this.recordCodeUsage(code, newUserId, codeConfig);
      
      // Award referrer if applicable
      if (codeConfig.type === this.codeTypes.MEMBER && codeConfig.generatedBy !== newUserId) {
        await this.awardReferrer(codeConfig.generatedBy, newUserId, codeConfig);
      }
      
      console.log('âœ… [Referral] Code validated and used:', code);
      return { 
        success: true, 
        tier: codeConfig.targetTier,
        referrer: codeConfig.generatedBy 
      };
      
    } catch (error) {
      console.error('âŒ [Referral] Code validation failed:', error);
      return { success: false, error: error.message };
    }
  }

  /**
   * Record code usage and update attribution
   */
  async recordCodeUsage(code, userId, codeConfig) {
    // Update usage count
    codeConfig.uses += 1;
    codeConfig.attribution.push({
      userId,
      usedAt: Date.now(),
      ip: this.getUserIP() // For analytics
    });
    
    // Update stored configuration
    await this.updateReferralCode(code, codeConfig);
    
    // Track usage event
    await this.trackReferralEvent(codeConfig.generatedBy, 'code_used', {
      code,
      newUser: userId,
      totalUses: codeConfig.uses
    });
  }

  /**
   * Award referrer with points/badges
   */
  async awardReferrer(referrerId, newUserId, codeConfig) {
    console.log('ðŸ† [Referral] Awarding referrer:', referrerId);
    
    try {
      // Get referrer's current stats
      const referrerStats = await this.getReferrerStats(referrerId);
      
      // Award points based on tier
      const points = this.getTierPoints(codeConfig.targetTier);
      referrerStats.totalPoints += points;
      referrerStats.totalReferrals += 1;
      referrerStats.lastReferralAt = Date.now();
      
      // Check for badge awards
      const newBadges = this.checkBadgeEligibility(referrerStats);
      
      // Update referrer stats
      await this.updateReferrerStats(referrerId, referrerStats, newBadges);
      
      // Track award event
      await this.trackReferralEvent(referrerId, 'referral_awarded', {
        points,
        newUser: userId,
        badges: newBadges,
        totalReferrals: referrerStats.totalReferrals
      });
      
      console.log('ðŸ† Referrer awarded:', { points, badges: newBadges });
      
    } catch (error) {
      console.error('âŒ [Referral] Award failed:', error);
    }
  }

  /**
   * Get points for tier referral
   */
  getTierPoints(tier) {
    const pointMap = {
      'TIER_1': 10,
      'TIER_2': 25, 
      'TIER_3': 55
    };
    return pointMap[tier] || 5;
  }

  /**
   * Check badge eligibility based on stats
   */
  checkBadgeEligibility(stats) {
    const badges = [];
    
    // Referral milestone badges
    if (stats.totalReferrals >= 1 && !stats.badges?.includes('first_referral')) {
      badges.push('first_referral');
    }
    if (stats.totalReferrals >= 5 && !stats.badges?.includes('hi_connector')) {
      badges.push('hi_connector');
    }
    if (stats.totalReferrals >= 10 && !stats.badges?.includes('hi_ambassador')) {
      badges.push('hi_ambassador');
    }
    if (stats.totalReferrals >= 25 && !stats.badges?.includes('hi_legend')) {
      badges.push('hi_legend');
    }
    
    // Points milestone badges
    if (stats.totalPoints >= 100 && !stats.badges?.includes('point_collector')) {
      badges.push('point_collector');
    }
    if (stats.totalPoints >= 500 && !stats.badges?.includes('point_master')) {
      badges.push('point_master');
    }
    
    return badges;
  }

  /**
   * Get referral leaderboard
   */
  async getLeaderboard(type = 'referrals', limit = 10) {
    console.log('ðŸ… [Referral] Fetching leaderboard:', type);
    
    try {
      // Would query Supabase for actual data
      // Mock implementation for now
      const mockLeaderboard = [
        { userId: 'user1', username: 'HiPioneer', referrals: 15, points: 375, badges: ['hi_ambassador'] },
        { userId: 'user2', username: 'WaveRider', referrals: 8, points: 200, badges: ['hi_connector'] },
        { userId: 'user3', username: 'HiInfluencer', referrals: 12, points: 300, badges: ['hi_ambassador'] }
      ];
      
      // Sort by requested type
      mockLeaderboard.sort((a, b) => {
        if (type === 'points') return b.points - a.points;
        return b.referrals - a.referrals;
      });
      
      return mockLeaderboard.slice(0, limit);
      
    } catch (error) {
      console.error('âŒ [Referral] Leaderboard fetch failed:', error);
      return [];
    }
  }

  /**
   * Get user's referral stats
   */
  async getUserReferralStats(userId) {
    try {
      const stats = await this.getReferrerStats(userId);
      const activeCodes = await this.getUserActiveCodes(userId);
      
      return {
        totalReferrals: stats.totalReferrals || 0,
        totalPoints: stats.totalPoints || 0,
        badges: stats.badges || [],
        activeCodes: activeCodes.length,
        leaderboardRank: await this.getUserRank(userId)
      };
      
    } catch (error) {
      console.error('âŒ [Referral] Stats fetch failed:', error);
      return {
        totalReferrals: 0,
        totalPoints: 0,
        badges: [],
        activeCodes: 0,
        leaderboardRank: null
      };
    }
  }

  // Database operations (would be implemented with Supabase)
  async storeReferralCode(config) {
    // Store in Supabase referral_codes table
    console.log('ðŸ’¾ [Referral] Storing code config:', config.code);
  }

  async getReferralCode(code) {
    // Query Supabase for code config
    console.log('ðŸ” [Referral] Fetching code config:', code);
    return null; // Mock implementation
  }

  async updateReferralCode(code, config) {
    // Update Supabase referral_codes table
    console.log('ðŸ“ [Referral] Updating code config:', code);
  }

  async getReferrerStats(userId) {
    // Query Supabase for referrer stats
    return {
      totalReferrals: 0,
      totalPoints: 0,
      badges: [],
      lastReferralAt: null
    };
  }

  async updateReferrerStats(userId, stats, newBadges) {
    // Update Supabase referrer_stats table
    console.log('ðŸ“Š [Referral] Updating referrer stats:', userId);
  }

  async trackReferralEvent(userId, event, data) {
    // Track in Supabase referral_events table for analytics
    console.log('ðŸ“ˆ [Referral] Tracking event:', { userId, event, data });
  }

  async getUserActiveCodes(userId) {
    // Get active codes generated by user
    return [];
  }

  async getUserRank(userId) {
    // Get user's current leaderboard position
    return null;
  }

  getUserIP() {
    // Get user IP for analytics (privacy-conscious)
    return 'hidden';
  }

  // Setup methods
  async setupCodeValidation() {
    console.log('ðŸ” [Referral] Setting up code validation...');
  }

  async initializeLeaderboards() {
    console.log('ðŸ… [Referral] Initializing leaderboards...');
  }

  async setupMemberCodeGeneration() {
    console.log('ðŸŽ« [Referral] Setting up member code generation...');
  }
}

// Global instance
window.HiReferral = new HiReferralSystem();

// Auto-initialize
document.addEventListener('DOMContentLoaded', () => {
  window.HiReferral.initialize();
});