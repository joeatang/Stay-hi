<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hi Mission Control ‚Äî Administrative Command Center</title>
    
    <!-- üì± PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFD166">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Hi Control">
    <link rel="apple-touch-icon" href="assets/brand/hi-logo-192.png">
    
    <!-- Using unified ESM client; remove UMD to avoid dual init -->
    <script type="module" src="./lib/HiSupabase.v3.js"></script>
    <script type="module" src="./lib/HiMonitor.js"></script>
    <script type="module" src="./lib/AuthReady.js"></script>
    <script type="module" src="./lib/HiLoading.js"></script>
    <!-- PWA Session Sync (browser ‚Üî PWA auth state) -->
    <script src="./lib/PWASessionSync.js"></script>
    <!-- Unified Admin Access Orchestrator -->
    <script src="./lib/admin/AdminAccessManager.js"></script>
    <!-- Embedded Self-Check (diagnostics overlay, hash: #self-check) -->
    <script src="./lib/admin/self-check-embed.js"></script>
    <!-- Env-safe path resolver + membership/access bridges -->
    <script src="./assets/hi-paths.js"></script>
    <!-- üéØ TIER CONFIG - Must load BEFORE HiMembership -->
    <script src="./lib/config/TIER_CONFIG.js"></script>
    <script src="./lib/membership/HiMembershipBridge.js"></script>
    <script src="./lib/access/AccessGate.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #ffffff;
            overflow-x: hidden;
        }
        
        /* üîí Security Loading Screen */
        .security-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #000428 0%, #004e92 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .security-logo {
            width: 120px;
            height: 120px;
            border: 3px solid #00d4ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 30px;
            animation: securityPulse 2s infinite;
        }
        
        @keyframes securityPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 212, 255, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 40px rgba(0, 212, 255, 0.6); }
        }
        
        .security-text {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #00d4ff;
        }
        
        .security-status {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 30px;
        }
        
        .security-progress {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .security-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0ea5e9);
            width: 0%;
            transition: width 0.3s ease;
            animation: progressGlow 2s infinite;
        }
        
        @keyframes progressGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 212, 255, 0.5); }
            50% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.8); }
        }
        
        /* üèõÔ∏è Main Dashboard */
        .dashboard-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dashboard-header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }
        
        /* üîô Back to Dashboard Button */
        .back-to-app {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e2e8f0;
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-to-app:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateX(-3px);
        }
        
        .back-to-app:active {
            transform: translateX(-1px);
        }
        
        .dashboard-title {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4ff, #0ea5e9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .dashboard-subtitle {
            color: #94a3b8;
            font-size: 16px;
        }
        
        .security-badge {
            display: inline-block;
            background: linear-gradient(135deg, #059669, #10b981);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 15px;
        }
        
        /* üìä Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 212, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.1);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* üõ†Ô∏è Control Panel */
        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }
        /* üé´ Invite Code Cards */
        .invite-cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-top:22px;}
        .invite-card{background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.25);border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:10px;position:relative;overflow:hidden;}
        .invite-card.active{box-shadow:0 0 0 1px rgba(0,212,255,0.4),0 6px 18px -4px rgba(0,212,255,0.25);}
        .invite-card.exhausted{opacity:.55;filter:grayscale(.3);}
        .invite-code-value{font-family:Menlo,monospace;font-size:18px;letter-spacing:2px;background:#0f2538;padding:10px 12px;border-radius:10px;color:#e2e8f0;text-align:center;}
        .invite-meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;font-size:11px;line-height:1.3;}
        .invite-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;}
        .invite-actions button{background:#00d4ff;color:#0f172a;border:none;padding:6px 10px;border-radius:8px;font-weight:600;font-size:11px;cursor:pointer;}
        .invite-actions button:hover{filter:brightness(1.1);}        
        
        .panel-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #ffffff;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .control-btn {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .control-btn.danger {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }
        
        .control-btn.success {
            background: linear-gradient(135deg, #059669, #10b981);
        }
        
        /* üìã Results Display */
        .results-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-top: 20px;
            display: none;
        }
        
        .results-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #00d4ff;
        }
        
        .results-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            color: #e2e8f0;
        }
        
        /* üö® Error States */
        .error-message {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            padding: 15px 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }
        
        .success-message {
            background: linear-gradient(135deg, #059669, #10b981);
            padding: 15px 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }
        
        /* üîí Security Footer */
        .security-footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #64748b;
            font-size: 12px;
        }
        
        .unauthorized-access {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #7f1d1d, #991b1b);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .unauthorized-content {
            text-align: center;
            max-width: 500px;
            padding: 40px;
        }
        
        .unauthorized-icon {
            font-size: 72px;
            margin-bottom: 20px;
            color: #fecaca;
        }
        
        .unauthorized-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #ffffff;
        }
        
        .unauthorized-message {
            font-size: 16px;
            color: #fecaca;
            line-height: 1.6;
        }
    </style>
</head>
<body>
        <a class="skip-link" href="#main">Skip to main content</a>
        <style>
            .skip-link{position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden}
            .skip-link:focus{left:16px;top:12px;width:auto;height:auto;background:#111827;color:#fff;padding:8px 12px;border-radius:8px;z-index:100001}
        </style>
        <!-- üöÄ Unified Loading Skeleton (shared system) -->
        <div id="hiLoading" class="hi-loading-skeleton" role="status" aria-live="polite" data-loading-state="pending" style="display:none;">
            <div class="loading-line"></div>
            <div class="loading-block"></div>
            <div class="loading-text" data-loading-msg>Establishing secure mission channel‚Ä¶</div>
        </div>
    <!-- üîí Security Loading Screen -->
    <div class="security-loading" id="securityLoading">
        <div class="security-logo">üõ°Ô∏è</div>
        <div class="security-text">Hi Mission Control</div>
        <div class="security-status" id="securityStatus" role="status" aria-live="polite">Initializing secure connection...</div>
        <div class="security-progress">
            <div class="security-progress-bar" id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-describedby="securityStatus"></div>
        </div>
    </div>
    
    <!-- üö® Unauthorized Access Screen -->
    <div class="unauthorized-access" id="unauthorizedScreen">
        <div class="unauthorized-content">
            <div class="unauthorized-icon">üö´</div>
            <div class="unauthorized-title">Access Denied</div>
            <div class="unauthorized-message">
                Administrative privileges required to access Hi Mission Control.<br><br>
                This incident has been logged and security has been notified.
            </div>
            <div style="margin-top:24px; display:flex; gap:12px; justify-content:center;">
                <a href="/signin.html?redirect=/hi-mission-control.html" style="
                    background:#10b981; color:#0b1b1e; padding:10px 16px; border-radius:8px;
                    text-decoration:none; font-weight:600;">Sign in to Continue</a>
                <a href="/welcome.html" style="
                    border:1px solid #334155; color:#e2e8f0; padding:10px 16px; border-radius:8px;
                    text-decoration:none;">Back to Home</a>
            </div>
        </div>
    </div>
    
    <!-- üèõÔ∏è Main Dashboard -->
    <div class="dashboard-container" id="dashboardContainer" role="main" tabindex="-1" aria-label="Mission Control Main"  >
        <header class="dashboard-header">
            <a href="/hi-dashboard.html" class="back-to-app">
                ‚Üê Back to Dashboard
            </a>
            <h1 class="dashboard-title">Hi Mission Control</h1>
            <p class="dashboard-subtitle">Enterprise Administrative Command Center</p>
            <span class="security-badge">üîí SECURED BY FORTUNE 500-GRADE AUTHENTICATION</span>
        </header>
        
        <!-- üìä Statistics Dashboard -->
        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be populated by JavaScript -->
        </div>
        
        <!-- üõ†Ô∏è Administrative Controls -->
        <div class="control-panel">
            <h2 class="panel-title">üéØ Invitation Management</h2>
            <div class="control-buttons">
                <button class="control-btn success" onclick="generateInviteCode()">
                    üé´ Generate New Invite Code
                </button>
                <button class="control-btn" onclick="listInviteCodes()">
                    üìã View All Invitations
                </button>
                <button class="control-btn" onclick="getActiveInvites()">
                    ‚úÖ Active Invitations Only
                </button>
                <button class="control-btn danger" onclick="deactivateExpiredCodes()">
                    üóëÔ∏è Clean Expired Codes
                </button>
            </div>
            <!-- Dynamically injected invitation cards -->
            <div id="inviteCardsContainer" class="invite-cards-grid" aria-live="polite"></div>
        </div>

                <!-- üîê Admin Passcode Management (Super Admin Only) -->
                <div class="control-panel" id="passcodePanel" style="display:none;">
                    <h2 class="panel-title">üîê Admin Passcode Management</h2>
                    <div style="display:grid;gap:14px;font-size:14px;color:#cbd5e1;">
                        <div>Rotate the admin passcode regularly. Only super admins can set a new one. Existing active passcode will be invalidated automatically.</div>
                        <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
                            <input id="newPasscode" placeholder="New passcode" autocomplete="off" inputmode="numeric" style="flex:1;min-width:200px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:10px;padding:10px;color:#fff" />
                            <input id="passcodeNotes" placeholder="Notes (optional)" style="flex:2;min-width:240px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:10px;padding:10px;color:#fff" />
                            <button class="control-btn success" style="flex:0 0 auto" onclick="rotatePasscode()">üîÑ Rotate Passcode</button>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;">
                            <button class="control-btn" onclick="fetchPasscodeMeta()">üì• View Current Metadata</button>
                            <button class="control-btn" onclick="testPasscodeUnlock()">üß™ Test Unlock</button>
                        </div>
                        <div id="passcodeMeta" style="background:rgba(0,0,0,0.35);padding:12px 16px;border-radius:10px;font-family:Menlo,monospace;font-size:12px;white-space:pre-wrap;display:none;"></div>
                        <div id="passcodeMsg" style="min-height:18px;font-size:12px;color:#9fb0ff;"></div>
                    </div>
                </div>

        <!-- üìò Mission Control Guide -->
        <div class="control-panel" id="missionGuidePanel" style="display:block;">
            <h2 class="panel-title">üß≠ Mission Control Guide</h2>
            <div style="display:grid; gap:14px; font-size:14px; line-height:1.5; color:#cbd5e1;">
                <div><strong>Purpose:</strong> Manage platform growth (invite codes) and monitor system health (stats & security events).</div>
                <div><strong>Quick Flow (Invites):</strong> 1) Press <em>Generate New Invite Code</em>. 2) Copy the surfaced code card. 3) Share with a trusted tester. 4) They redeem via standard sign-in flow entering their email; code applied automatically when used on invite endpoint (future UI).</div>
                <div><strong>Code Anatomy:</strong> Each generated record includes: <code>code</code>, <code>max_uses</code>, <code>uses_remaining</code>, <code>expires_at</code>, <code>created_by</code>. A code is valid if <code>is_active=true</code>, <code>uses_remaining>0</code>, and <code>expires_at</code> is in the future.</div>
                <div><strong>Operational Tips:</strong> Use <em>Active Invitations Only</em> before sharing to confirm availability; run <em>Clean Expired Codes</em> to keep database lean; after major events, check <em>Security Events</em> for anomalies.</div>
                <div><strong>Stats Sync:</strong> Global unified stats card appended after admin dashboard stats (source labeled). Use <code>?debugstats=1</code> query param for overlay diagnostics.</div>
                <div><strong>Next Up:</strong> We can add one-click redemption test harness & bulk generation. Ask if you‚Äôd like those accelerated.</div>
            </div>
        </div>
        
        <div class="control-panel">
            <h2 class="panel-title">üë• User Management</h2>
            <div class="control-buttons">
                <button class="control-btn" onclick="getUserStats()">
                    üìä User Statistics
                </button>
                <button class="control-btn" onclick="getRecentSignups()">
                    üÜï Recent Signups
                </button>
                <button class="control-btn" onclick="getMembershipStats()">
                    üíé Membership Analytics
                </button>
                <button class="control-btn danger" onclick="getSecurityEvents()">
                    üö® Security Events
                </button>
            </div>
        </div>
        
        <!-- üìã Results Display -->
        <div class="results-container" id="resultsContainer">
            <div class="results-header" id="resultsHeader">Results</div>
            <div class="results-content" id="resultsContent"></div>
        </div>
        
        <!-- üîí Security Footer -->
        <footer class="security-footer">
            <p>Hi Mission Control ‚Ä¢ Enterprise Administrative Interface</p>
            <p>üîí All actions are logged ‚Ä¢ üõ°Ô∏è Multi-factor authentication enabled</p>
            <p>Session expires in <span id="sessionTimer">60</span> minutes</p>
        </footer>
    </div>

        <!-- üé® Invite Code Generation Modal -->
        <script src="./lib/admin/InviteCodeModal.js"></script>
        
        <script src="./lib/boot/mission-control-init.js"></script>
        <script>
            // Mission Control Admin Tools (Passcode + Invite RPCs)
            (function(){
                const getClient = ()=> (window.HiSupabase && window.HiSupabase.getClient && window.HiSupabase.getClient()) || window.supabaseClient || window.sb || null;
                                async function initPasscodePanel(){
                                        try {
                                            const state = window.AdminAccessManager?.getState?.() || {};
                                            if (state.roleType === 'super_admin'){ document.getElementById('passcodePanel').style.display='block'; return; }
                                            // If admin but roleType not yet loaded, wait for role-known event
                                            if (state.isAdmin && !state.roleType){
                                                window.addEventListener('hi:admin-role-known', (e)=>{
                                                    if (e.detail?.roleType === 'super_admin'){
                                                        document.getElementById('passcodePanel').style.display='block';
                                                    }
                                                }, { once:true });
                                            }
                                        } catch {}
                                }
                async function rotatePasscode(){
                    const msg = document.getElementById('passcodeMsg'); msg.textContent='Rotating‚Ä¶';
                    const pc = (document.getElementById('newPasscode').value||'').trim();
                    const notes = (document.getElementById('passcodeNotes').value||'').trim();
                    if (!pc){ msg.textContent='Enter a passcode.'; return; }
                    try { const sb = getClient(); if(!sb){ msg.textContent='Supabase unavailable'; return; }
                        const { data, error } = await sb.rpc('set_admin_passcode', { p_new_passcode: pc, p_notes: notes||null });
                        if (error){ msg.textContent = error.message || 'Rotation failed.'; return; }
                        msg.textContent = 'Passcode rotated. Metadata reloading‚Ä¶';
                        document.getElementById('newPasscode').value='';
                        await fetchPasscodeMeta();
                        try { window.HiAudit?.log('rotate_passcode', { resource: 'admin_passcode_config' }, { success:true }); } catch {}
                    } catch(e){ msg.textContent = e.message || 'Error rotating passcode.'; }
                }
                async function fetchPasscodeMeta(){
                    const box = document.getElementById('passcodeMeta'); const msg = document.getElementById('passcodeMsg');
                    msg.textContent='Loading metadata‚Ä¶';
                    try { const sb = getClient(); if(!sb){ msg.textContent='Supabase unavailable'; return; }
                        const { data, error } = await sb.from('admin_passcode_config').select('id,created_at,created_by,is_active,notes').order('created_at', { ascending:false }).limit(5);
                        if (error){ msg.textContent = error.message || 'Metadata fetch failed.'; return; }
                        box.style.display='block';
                        box.textContent = (data||[]).map(r=> `${r.is_active?'ACTIVE':'OLD'} | ${r.id} | ${r.created_at} | by:${r.created_by} | ${r.notes||''}`).join('\n') || 'No records.';
                        msg.textContent='Metadata loaded.';
                    } catch(e){ msg.textContent = e.message || 'Error fetching metadata.'; }
                }
                async function testPasscodeUnlock(){
                    const msg = document.getElementById('passcodeMsg'); const pc = prompt('Enter passcode to test unlock:',''); if(!pc){ msg.textContent='Test cancelled.'; return; }
                    msg.textContent='Testing unlock‚Ä¶';
                    try { const sb = getClient(); if(!sb){ msg.textContent='Supabase unavailable'; return; }
                        const { data, error } = await sb.rpc('admin_unlock_with_passcode', { p_passcode: pc });
                        if (error){ msg.textContent = error.message || 'Unlock failed.'; return; }
                        msg.textContent = data?.success ? 'Success: admin access confirmed (force recheck next).' : (data?.message || 'Invalid passcode.');
                        if (data?.success){ try { await window.AdminAccessManager?.checkAdmin({ force:true }); } catch {} }
                        try { window.HiAudit?.log('test_passcode_unlock', { resource: 'admin_unlock_with_passcode' }, { success: !!data?.success, failureReason: data?.success ? null : (data?.message || 'invalid') }); } catch {}
                    } catch(e){ msg.textContent = e.message || 'Error during unlock.'; }
                }
                window.rotatePasscode = rotatePasscode;
                window.fetchPasscodeMeta = fetchPasscodeMeta;
                window.testPasscodeUnlock = testPasscodeUnlock;
                document.addEventListener('DOMContentLoaded', initPasscodePanel);
                // Also react when admin confirmed to reveal panel if role upgraded post-load
                window.addEventListener('hi:admin-confirmed', initPasscodePanel);
            })();
        </script>
        <script>
            // üîí Tesla-Grade Auth Gate - Zero Extra Steps
            (async function initMissionControlAuth() {
                const securityLoading = document.getElementById('securityLoading');
                const unauthorizedScreen = document.getElementById('unauthorizedScreen');
                const dashboardContainer = document.getElementById('dashboardContainer');
                const securityStatus = document.getElementById('securityStatus');
                const progressBar = document.getElementById('progressBar');
                
                // Update progress
                function updateProgress(percent, message) {
                    if (progressBar) {
                        progressBar.style.width = `${percent}%`;
                        progressBar.setAttribute('aria-valuenow', percent);
                    }
                    if (securityStatus) securityStatus.textContent = message;
                }
                
                try {
                    updateProgress(30, 'Checking authentication...');
                    
                    // Wait for AdminAccessManager to be ready
                    if (!window.AdminAccessManager) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    updateProgress(60, 'Verifying admin privileges...');
                    
                    // Check admin access
                    const result = await window.AdminAccessManager.checkAdmin({ force: true });
                    
                    updateProgress(90, 'Access granted...');
                    
                    if (result.isAdmin) {
                        // ‚úÖ ADMIN - Show Mission Control
                        console.log('[Mission Control] ‚úÖ Admin access granted:', result);
                        
                        setTimeout(() => {
                            securityLoading.style.opacity = '0';
                            setTimeout(() => {
                                securityLoading.style.display = 'none';
                                unauthorizedScreen.style.display = 'none';
                                dashboardContainer.style.display = 'block';
                                dashboardContainer.focus();
                            }, 500);
                        }, 300);
                        
                    } else {
                        // ‚ùå NOT ADMIN - Show access denied
                        console.warn('[Mission Control] ‚ùå Access denied:', result);
                        
                        setTimeout(() => {
                            securityLoading.style.opacity = '0';
                            setTimeout(() => {
                                securityLoading.style.display = 'none';
                                unauthorizedScreen.style.display = 'flex';
                                dashboardContainer.style.display = 'none';
                            }, 500);
                        }, 300);
                    }
                    
                } catch (error) {
                    console.error('[Mission Control] Auth check failed:', error);
                    updateProgress(100, 'Authentication error');
                    
                    // Show unauthorized on error
                    setTimeout(() => {
                        securityLoading.style.opacity = '0';
                        setTimeout(() => {
                            securityLoading.style.display = 'none';
                            unauthorizedScreen.style.display = 'flex';
                            dashboardContainer.style.display = 'none';
                        }, 500);
                    }, 500);
                }
            })();
            
            // Auto-focus main after load for accessibility
            window.addEventListener('load', ()=>{
                const mc = document.getElementById('dashboardContainer');
                if (mc && mc.style.display==='block') mc.focus();
            });
        </script>
    
    <!-- üöÄ PWA Manager -->
    <script type="module" src="./lib/HiPWA.js"></script>
    <!-- üîç Auth Diagnostics (optional via ?authdebug=1) -->
    <script src="./lib/boot/auth-diagnostics.js"></script>
    <!-- üß™ Auth QA Harness (runs only with ?runAuthQA=1) -->
    <script src="./lib/qa/auth-flow-qa.js"></script>
</body>
</html><- Hi Boosts: 10 short messages with Hi frequency Cache bust 1763212285 -->
