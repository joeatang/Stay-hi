<link rel="stylesheet" href="assets/theme.css"/>

<!-- public/assets/auth.js -->
<script>
/* Assumes window.sb (Supabase client) is created by assets/supabase-init.js */
(function () {
  if (!window.sb) {
    console.error('Supabase client (window.sb) not found. Include assets/supabase-init.js before auth.js');
    return;
  }

  // Local-dev bypass: lets you preview UI without a real session when using file:// or localhost
  const DEV_BYPASS = (location.protocol === 'file:' || location.hostname === 'localhost');

  async function getSession() {
    try {
      const { data: { session } } = await sb.auth.getSession();
      return session || null;
    } catch {
      return null;
    }
  }

  async function getUser() {
    try {
      const { data: { user } } = await sb.auth.getUser();
      return user || null;
    } catch {
      return null;
    }
  }

  async function getMembership() {
    try {
      const { data, error } = await sb.rpc('get_my_membership');
      if (error) return { is_member: false };
      const row = Array.isArray(data) ? data[0] : data;
      return row || { is_member: false };
    } catch {
      return { is_member: false };
    }
  }

  async function requireAuth(opts = {}) {
    const { redirectTo = 'signin.html', allowDevBypass = true } = opts;
    const session = await getSession();
    if (session) return true;
    if (allowDevBypass && DEV_BYPASS && localStorage.getItem('hi_dev_user')) return true;
    window.location.href = redirectTo;
    return false;
  }

  async function requireMember(opts = {}) {
    const { redirectTo = 'membership-required.html', soft = false } = opts;
    const m = await getMembership();
    const ok = !!m.is_member;
    if (ok) return true;
    if (soft) return false;
    window.location.href = redirectTo;
    return false;
  }

  async function signOut() {
    try {
      await sb.auth.signOut();
    } catch {}
    try {
      localStorage.removeItem('hi_dev_user');
      localStorage.removeItem('hi_member');
    } catch {}
    window.location.href = 'index.html';
  }

  // UI helpers: show/hide elements with data-show-auth / data-show-member
  async function applyAuthVisibility() {
    const session = await getSession();
    const authed = !!session || (DEV_BYPASS && localStorage.getItem('hi_dev_user'));
    const mem = authed ? await getMembership() : { is_member: false };

    document.querySelectorAll('[data-show-auth]')
      .forEach(el => {
        const want = el.getAttribute('data-show-auth'); // "in" | "out"
        const show = (want === 'in') ? authed : !authed;
        el.style.display = show ? '' : 'none';
      });

    document.querySelectorAll('[data-show-member]')
      .forEach(el => {
        const want = el.getAttribute('data-show-member'); // "yes" | "no"
        const show = (want === 'yes') ? !!mem.is_member : !mem.is_member;
        el.style.display = show ? '' : 'none';
      });

    // Wire logout buttons/links
    document.querySelectorAll('[data-action="logout"]').forEach(el => {
      el.onclick = (e) => { e.preventDefault(); signOut(); };
    });
  }

  // Expose a tiny API
  window.hiAuth = {
    requireAuth,
    requireMember,
    getUser,
    getMembership,
    signOut,
    applyAuthVisibility
  };

  // Keep visibility in sync on auth changes
  sb.auth.onAuthStateChange((_event, _session) => {
    applyAuthVisibility();
  });

  // Initial pass
  document.addEventListener('DOMContentLoaded', applyAuthVisibility);
})();
</script>
