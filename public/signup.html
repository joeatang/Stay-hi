<link rel="stylesheet" href="assets/theme.css"/>
<link rel="stylesheet" href="assets/create-parity.css"/>
<link rel="stylesheet" href="assets/tesla-mobile-fixes.css">
<script src="assets/tesla-instant-auth.js"></script>
<script src="assets/tesla-data-isolation.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: var(--f-sans);
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #2d1e4f 0%, #ff7a18 60%, #ffd166 100%);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
  }
  
  /* Tesla-grade background particles */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%), 
                radial-gradient(circle at 80% 20%, rgba(255, 177, 153, 0.15) 0%, transparent 50%);
    pointer-events: none;
    z-index: 1;
  }
  .signup-glass {
    max-width: 480px;
    margin: 3.5rem auto 2rem auto;
    background: rgba(15, 16, 34, 0.85);
    border-radius: 28px;
    box-shadow: 
      0 32px 80px rgba(0, 0, 0, 0.4),
      0 8px 32px rgba(255, 215, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    padding: 3rem 2.5rem 2.5rem 2.5rem;
    backdrop-filter: blur(25px) saturate(1.4);
    -webkit-backdrop-filter: blur(25px) saturate(1.4);
    border: 2px solid rgba(255, 215, 0, 0.2);
    position: relative;
    z-index: 2;
    animation: welcomeFloat 0.8s ease-out;
  }
  
  @keyframes welcomeFloat {
    from { 
      opacity: 0; 
      transform: translateY(30px) scale(0.95); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0) scale(1); 
    }
  }
  .signup-glass::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    pointer-events: none;
    background: linear-gradient(135deg, #fff2 0%, #ffd16622 100%);
    z-index: 1;
  }
  .signup-title {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    font-weight: 900;
    background: linear-gradient(135deg, #FFD166, #FF7B24);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-align: center;
    margin: 0 0 0.8rem 0;
    line-height: 1.1;
    text-shadow: 0 4px 16px rgba(255, 123, 24, 0.3);
    position: relative;
    z-index: 2;
  }
  .signup-lead {
    color: rgba(255, 255, 255, 0.9);
    text-align: center;
    font-size: clamp(1rem, 2.5vw, 1.1rem);
    margin-bottom: 1.2rem;
    position: relative;
    z-index: 2;
    font-weight: 500;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    position: relative;
    z-index: 2;
  }
  label {
    font-weight: 600;
    margin-bottom: 0.3rem;
    color: #111;
    font-size: 1rem;
    letter-spacing: 0.01em;
  }
  input[type="text"], input[type="email"], input[type="password"] {
    padding: 0.85rem 1rem;
    border: 1.5px solid var(--hi-border);
    border-radius: var(--r-btn);
    font-size: 1.05rem;
    background: rgba(255,255,255,0.12);
    color: #111;
    box-shadow: 0 2px 8px #ffd16622;
    outline: none;
    transition: border 0.2s, box-shadow 0.2s;
  }
  input:focus {
    border-color: var(--ring);
    box-shadow: 0 0 0 2px var(--ring);
  }
  button[type="submit"] {
    background: var(--grad-sunrise);
    color: #fff;
    border: none;
    border-radius: var(--r-btn);
    padding: 1rem;
    font-size: 1.1rem;
    font-weight: 800;
    box-shadow: 0 10px 24px #ff7a1812;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s;
    margin-top: 0.5rem;
  }
  button[type="submit"]:hover {
    background: var(--grad-ember);
    box-shadow: 0 14px 34px #ff7a1833;
  }
  .error {
    color: #ff4d00;
    font-size: 0.98rem;
    margin-top: -0.5rem;
    margin-bottom: 0.5rem;
    text-align: center;
    font-weight: 600;
    letter-spacing: 0.01em;
  }
  .success {
    color: #F5A623;
    font-size: 1.05rem;
    text-align: center;
    margin-top: 1rem;
    font-weight: 700;
    letter-spacing: 0.01em;
  }
  @media (max-width: 500px) {
    .signup-glass { padding: 1.2rem 0.5rem; margin: 1.5rem 0.5rem; }
    .signup-title { font-size: 1.2rem; }
  }
</style>

<div class="signup-glass">
  <div style="display:flex;flex-direction:column;align-items:center;gap:0.5rem;margin-bottom:1.2rem;">
    <img src="assets/brand/hi-logo-light.png" alt="Stay Hi" style="width:72px;height:72px;object-fit:contain;filter:drop-shadow(0 8px 22px rgba(255,210,102,.55));margin-bottom:0.2rem;" />
    <div class="signup-title" style="color:#fff;text-shadow:0 2px 12px #0008;">Sign Up for Stay Hi</div>
  </div>
  <div class="signup-lead" style="color:#f7f8ff;text-align:center;font-size:1rem;margin-bottom:1.2rem;font-weight:500;text-shadow:0 1px 8px #0006;">Unlock your 24hr beta pass. Enter your invite code to join the Hi experience.</div>
  <form id="signup-form" autocomplete="off">
    <label for="email" style="color:#fff;text-shadow:0 1px 8px #0006;">Email</label>
    <input type="email" id="email" name="email" required placeholder="you@email.com" class="input" style="background:#181a22cc;color:#fff;border:1.5px solid var(--hi-border);box-shadow:0 2px 8px #ffd16622;" />

    <label for="password" style="color:#fff;text-shadow:0 1px 8px #0006;">Password</label>
    <input type="password" id="password" name="password" required minlength="8" placeholder="Create a password" class="input" style="background:#181a22cc;color:#fff;border:1.5px solid var(--hi-border);box-shadow:0 2px 8px #ffd16622;" />

    <label for="invite" style="color:#fff;text-shadow:0 1px 8px #0006;">Invite Code</label>
    <input type="text" id="invite" name="invite" required placeholder="Enter invite code" class="input" style="background:#181a22cc;color:#fff;border:1.5px solid var(--hi-border);box-shadow:0 2px 8px #ffd16622;" />

    <button type="submit" class="btn" style="background:linear-gradient(90deg,#FFD166,#FF7A18);color:#111;font-weight:800;box-shadow:0 10px 24px #ff7a1812,0 2px 8px #ffd16622;">Create Account</button>
    <div id="form-error" class="error" style="display:none;color:#ff4d00;text-align:center;font-weight:600;text-shadow:0 1px 8px #0006;"></div>
    <div id="form-success" class="success" style="display:none;color:#FFD166;text-align:center;font-weight:700;text-shadow:0 1px 8px #0006;"></div>
  </form>
</div>

<script src="assets/supabase-init.js"></script>
<script>
// Modular sign up logic with invite code validation
const form = document.getElementById('signup-form');
const errorDiv = document.getElementById('form-error');
const successDiv = document.getElementById('form-success');

function showError(msg) {
  errorDiv.textContent = msg;
  errorDiv.style.display = 'block';
  successDiv.style.display = 'none';
}
function showSuccess(msg) {
  successDiv.textContent = msg;
  successDiv.style.display = 'block';
  errorDiv.style.display = 'none';
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  errorDiv.style.display = 'none';
  successDiv.style.display = 'none';

  const email = form.email.value.trim();
  const password = form.password.value;
  const invite = form.invite.value.trim();

  if (!email || !password || !invite) {
    showError('All fields are required.');
    return;
  }
  if (password.length < 8) {
    showError('Password must be at least 8 characters.');
    return;
  }

  // 1. Validate invite code via Supabase RPC
  let validCode = false;
  let codeId = null;
  try {
    const { data, error } = await sb.rpc('validate_invite_code', { code: invite });
    if (error || !data || !data.is_valid) {
      showError('Invalid or expired invite code.');
      return;
    }
    validCode = true;
    codeId = data.code_id;
  } catch (err) {
    showError('Error validating invite code.');
    return;
  }

  // 2. Create user in Supabase auth
  let userId = null;
  try {
    const { data, error } = await sb.auth.signUp({ email, password });
    if (error) {
      showError(error.message || 'Sign up failed.');
      return;
    }
    userId = data.user?.id;
  } catch (err) {
    showError('Error creating account.');
    return;
  }

  // 3. Mark invite code as used (track usage)
  try {
    const { error } = await sb.rpc('use_invite_code', { code: invite, user_id: userId });
    if (error) {
      showError('Error tracking invite code usage.');
      return;
    }
  } catch (err) {
    showError('Error tracking invite code usage.');
    return;
  }

  // 4. Success: show message and redirect
  showSuccess('Account created! Check your email to verify and sign in.');
  setTimeout(() => {
    window.location.href = 'signin.html';
  }, 2000);
});
</script>

<!-- public/assets/auth.js -->
<script>
/* Assumes window.sb (Supabase client) is created by assets/supabase-init.js */
(function () {
  if (!window.sb) {
    console.error('Supabase client (window.sb) not found. Include assets/supabase-init.js before auth.js');
    return;
  }

  // Local-dev bypass: lets you preview UI without a real session when using file:// or localhost
  const DEV_BYPASS = (location.protocol === 'file:' || location.hostname === 'localhost');

  async function getSession() {
    try {
      const { data: { session } } = await sb.auth.getSession();
      return session || null;
    } catch {
      return null;
    }
  }

  async function getUser() {
    try {
      const { data: { user } } = await sb.auth.getUser();
      return user || null;
    } catch {
      return null;
    }
  }

  async function getMembership() {
    try {
      const { data, error } = await sb.rpc('get_my_membership');
      if (error) return { is_member: false };
      const row = Array.isArray(data) ? data[0] : data;
      return row || { is_member: false };
    } catch {
      return { is_member: false };
    }
  }

  async function requireAuth(opts = {}) {
    const { redirectTo = 'signin.html', allowDevBypass = true } = opts;
    const session = await getSession();
    if (session) return true;
    if (allowDevBypass && DEV_BYPASS && localStorage.getItem('hi_dev_user')) return true;
    window.location.href = redirectTo;
    return false;
  }

  async function requireMember(opts = {}) {
    const { redirectTo = 'membership-required.html', soft = false } = opts;
    const m = await getMembership();
    const ok = !!m.is_member;
    if (ok) return true;
    if (soft) return false;
    window.location.href = redirectTo;
    return false;
  }

  async function signOut() {
    try {
      await sb.auth.signOut();
    } catch {}
    try {
      localStorage.removeItem('hi_dev_user');
      localStorage.removeItem('hi_member');
    } catch {}
    window.location.href = 'index.html';
  }

  // UI helpers: show/hide elements with data-show-auth / data-show-member
  async function applyAuthVisibility() {
    const session = await getSession();
    const authed = !!session || (DEV_BYPASS && localStorage.getItem('hi_dev_user'));
    const mem = authed ? await getMembership() : { is_member: false };

    document.querySelectorAll('[data-show-auth]')
      .forEach(el => {
        const want = el.getAttribute('data-show-auth'); // "in" | "out"
        const show = (want === 'in') ? authed : !authed;
        el.style.display = show ? '' : 'none';
      });

    document.querySelectorAll('[data-show-member]')
      .forEach(el => {
        const want = el.getAttribute('data-show-member'); // "yes" | "no"
        const show = (want === 'yes') ? !!mem.is_member : !mem.is_member;
        el.style.display = show ? '' : 'none';
      });

    // Wire logout buttons/links
    document.querySelectorAll('[data-action="logout"]').forEach(el => {
      el.onclick = (e) => { e.preventDefault(); signOut(); };
    });
  }

  // Expose a tiny API
  window.hiAuth = {
    requireAuth,
    requireMember,
    getUser,
    getMembership,
    signOut,
    applyAuthVisibility
  };

  // Keep visibility in sync on auth changes
  sb.auth.onAuthStateChange((_event, _session) => {
    applyAuthVisibility();
  });

  // Initial pass
  document.addEventListener('DOMContentLoaded', applyAuthVisibility);
})();
</script>
