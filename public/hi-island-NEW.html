<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  
  <title>Hi Island ‚Äî Stay Hi</title>

  <!-- üì± PWA Configuration -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD166">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Hi Island">

  <!-- Resource Hints for Cross-Navigation Performance -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" as="script">
  <link rel="prefetch" href="index.html">
  <link rel="prefetch" href="hi-muscle.html">
  <link rel="dns-prefetch" href="//unpkg.com">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.81.1/dist/umd/supabase.min.js" integrity="sha384-XLEuzmdNfK1V09d59bu+Uv3EFtEp5kFP8BmseBq85CUpeFZXhUfqjk4ZeR/biZmS" crossorigin="anonymous"></script>

  <!-- Unified Access Gate (replaces legacy anonymous modal) -->
  <script src="assets/hi-paths.js"></script>
  <!-- üéØ TIER CONFIG - Must load BEFORE HiMembership (GLOBAL SCRIPT, not module) -->
  <script src="lib/config/TIER_CONFIG.js"></script>
  <script src="lib/membership/HiMembershipBridge.js"></script>
  <script src="lib/access/AccessGate.js"></script>
  <script src="components/AccessGateModal.js"></script>
  
  <!-- üîê Authentication System (Tesla-Grade Progressive Auth) -->
  <script src="assets/post-auth-path.js"></script>
  <!-- Unified Auth Shim replaces progressive-auth.js -->
  <script src="lib/access/AuthShim.js"></script>
  <!-- Silence verbose logs in production unless debug flags are present -->
  <script src="lib/boot/prod-quiet-console.js"></script>
  
  <!-- üöÄ Hi Upgrade Modal System -->
  <link rel="stylesheet" href="ui/HiUpgradeModal/HiUpgradeModal.css">
  <script type="module" src="ui/HiUpgradeModal/HiUpgradeModal.js" defer></script>

  <!-- üåü WOZNIAK-GRADE: Gold Standard Modal System (Unified Auth/Share Modals) -->
  <script src="lib/HiGoldStandardModal.js" async></script>
  
  <!-- üõ°Ô∏è WOZ-GRADE: Stats Write Guard (prevents navigation increments) -->
  <script src="lib/stats/StatsWriteGuard.js"></script>
  
  <!-- üé® Hi Brand Tier System (Single Source of Truth) -->
  <script src="lib/HiBrandTiers.js" async></script>

  <!-- Design System -->
  <link rel="stylesheet" href="styles/tokens.css"/>
  <link rel="stylesheet" href="styles/base.css"/>
  
  <!-- Shared UI -->
  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>
  <link rel="stylesheet" href="assets/premium-ux.css"/>
  <link rel="stylesheet" href="assets/premium-calendar.css"/>
  
  <!-- Tesla-Grade Navigation System -->
  <link rel="stylesheet" href="./lib/navigation/HiStandardNavigation.css"/>

  <!-- Component Styles -->
  <link rel="stylesheet" href="components/hi-island-map/map.css"/>
  <link rel="stylesheet" href="components/hi-island-feed/feed.css"/>
  <link rel="stylesheet" href="ui/HiShareSheet/HiShareSheet.css"/>
  <link rel="stylesheet" href="components/profile-preview-modal/profile-modal.css"/>
  
  <!-- Hi Feature Flags & Rewards -->
  <link rel="stylesheet" href="assets/hi-rewards-styles.css"/>

  <!-- Leaflet (for map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  
  <!-- Leaflet MarkerCluster Plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  
  <!-- üöÄ PWA Manager -->
  <script type="module" src="./lib/HiPWA.js"></script>
  
  <!-- Tesla-Grade Milestone Celebration System -->
  <script src="assets/milestone-celebration-system.js" defer></script>
  
  <!-- Tesla-Grade Contextual Spotlight System -->
  <script src="assets/contextual-spotlight-system.js" defer></script>
  
  <!-- Tesla-Grade Smart Conversion System -->
  <script src="assets/smart-conversion-system.js" defer></script>

  <!-- Unified Admin Access Manager + auto-reveal/gating -->
  <script src="./lib/admin/AdminAccessManager.js"></script>
  <!-- Admin smart auto-redirect retained -->
  <script src="./lib/boot/admin-auto-redirect.js"></script>
  <!-- Access telemetry + upgrade handlers + SW register -->
  <script src="./lib/access/AccessGateTelemetry.js"></script>
  <script src="./lib/access/AccessGateTelemetryExport.js"></script>
  <script src="./lib/boot/upgrade-cta.js"></script>
  <script src="./lib/boot/sw-register.js"></script>

  <!-- Lightweight diagnostics (only runs with ?diag=1) -->
  <script>
    (function(){
      try {
        const p = new URLSearchParams(location.search);
        if (p.get('diag') !== '1') return;
        const box = document.createElement('div');
        box.style.cssText = 'position:fixed;bottom:12px;left:12px;z-index:99999;background:rgba(17,17,17,0.9);color:#fff;padding:10px 12px;border-radius:10px;font:12px/1.4 -apple-system,system-ui,Segoe UI,Roboto;box-shadow:0 4px 16px rgba(0,0,0,.35);max-width:60vw';
        box.setAttribute('role','status');
        function line(k, v){ return `<div><b style="color:#FFD166">${k}:</b> <span>${v}</span></div>`; }
        function swState(){
          if (!('serviceWorker' in navigator)) return 'unsupported';
          return navigator.serviceWorker.controller ? 'controlled' : 'not-controlled';
        }
        function supaState(){
          const c = window.__HI_SUPABASE_CLIENT || window.hiSupabase || window.supabaseClient || window.sb;
          if (!c) return 'missing';
          const rpcOK = typeof c.rpc === 'function';
          const isStub = !rpcOK;
          return isStub ? 'stub' : 'ready';
        }
        function metricsState(){
          return window.HiMetrics ? 'present' : 'missing';
        }
        function update(){
          box.innerHTML = [
            line('SW', swState()),
            line('Supabase', supaState()),
            line('RPC fn', (window.__HI_SUPABASE_CLIENT && typeof window.__HI_SUPABASE_CLIENT.rpc==='function')?'yes':'no'),
            line('HiMetrics', metricsState()),
            line('TotalHis(el)', (document.getElementById('globalTotalHis')||{}).textContent||'n/a')
          ].join('');
        }
        update();
        document.body.appendChild(box);
        const iv = setInterval(update, 1000);
        window.addEventListener('beforeunload', ()=>clearInterval(iv));
      } catch(e) { console.warn('diag init failed', e); }
    })();
  </script>
  
  <style>
    /* ===================================================================
       üé® HI ISLAND PAGE STYLES (Scoped to this page only)
    =================================================================== */
    
    body {
      background: var(--gradient-island);
      background-attachment: fixed;
      min-height: 100vh;
    }

    /* ============================================================================
       üèóÔ∏è GOLD STANDARD ARCHITECTURE: SCOPED CSS
       ============================================================================
       All Hi Island styles are namespaced to prevent conflicts with other pages.
       This follows BEM methodology + CSS namespacing for component isolation.
    ============================================================================ */

    /* Tesla-Grade Header - Dashboard Standard */
    .tesla-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
      
      /* üéØ Smooth auto-hide transitions (gold-standard UX) */
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), 
                  opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: transform, opacity;
    }

    .header-left {
      display: flex;
      align-items: center;
      width: 60px;
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      width: 140px;
      gap: 8px;
    }
    
    /* üé® TESLA-GRADE: Spatially Intelligent Tier Indicator */
    .tier-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.3px;
      color: var(--hi-tier-color, #FFD166);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
    }
    
    /* Subtle shine effect on hover */
    .tier-indicator::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.1), 
        transparent
      );
      transition: left 0.5s ease;
    }
    
    .tier-indicator:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .tier-indicator:hover::before {
      left: 100%;
    }
    
    .tier-text {
      white-space: nowrap;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .hiffirmations-header-pill {
      display: flex;
      align-items: center;
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 11px;
      font-weight: 600;
      color: #6B7280;
      transition: all 0.3s ease;
      cursor: pointer;
      min-width: 90px;
      text-align: center;
      margin-left: 8px;
    }
    
    .hiffirmations-header-pill:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }

    .brand-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-hi-logo {
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .brand-text {
      font-size: 18px;
      font-weight: 600;
      color: #FFD166;
      letter-spacing: -0.5px;
    }

    .calendar-btn, .menu-btn, .home-nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: #FFD166;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .calendar-btn:hover, .menu-btn:hover, .home-nav-btn:hover {
      background: rgba(255, 209, 102, 0.2);
      transform: translateY(-1px);
    }

    /* Navigation Modal */
    .navigation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .navigation-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .navigation-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
    }

    .navigation-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(400px, 90vw);
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 24px;
      padding: 24px;
      color: white;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .navigation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .navigation-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #FFD166;
    }

    .close-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-nav-btn:hover {
      background: rgba(255, 0, 0, 0.2);
    }

    .navigation-menu {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .nav-section-title {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      text-decoration: none;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .nav-item.admin-item {
      background: rgba(255, 215, 0, 0.1);
      border-color: rgba(255, 215, 0, 0.2);
    }

    .nav-item.admin-item:hover {
      background: rgba(255, 215, 0, 0.2);
    }

    /* Active link highlight */
    .nav-item.active {
      background: rgba(255, 209, 102, 0.2);
      border-color: rgba(255, 209, 102, 0.3);
    }

    .nav-icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    /* Mobile Responsive Navigation */
    @media (max-width: 768px) {
      .navigation-content {
        width: min(360px, 95vw);
        padding: 20px;
        margin: 16px;
      }
      
      .navigation-menu {
        gap: 20px;
      }
      
      .nav-item {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      .nav-icon {
        font-size: 20px;
        width: 28px;
      }
    }

    @media (max-width: 480px) {
      .navigation-content {
        width: calc(100vw - 32px);
        padding: 16px;
        margin: 16px;
      }
      
      .navigation-header h3 {
        font-size: 18px;
      }
    }

    /* Account for fixed header */
    body[data-page="hi-island"] {
      padding-top: 60px;
      transition: background 0.2s ease !important;
    }

    body[data-page="hi-island"] #btnMore:hover {
      background: rgba(0, 0, 0, 0.12) !important;
    }

    body[data-page="hi-island"] #btnMore svg {
      color: #333 !important;
    }

    /* üé® HI ISLAND CONTAINER (Main wrapper - all styles descend from here) */
    .wrap{ 
      max-width: 1040px; 
      margin: 0 auto; 
      padding: 16px;
    }

    /* üìç MAP SECTION */
    .mapwrap{
      position: relative; 
      overflow: hidden; 
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      min-height: 380px;
      display: grid; 
      grid-template-rows: auto 1fr;
      color: white;
      animation: fadeInUp 0.8s ease-out;
      margin-bottom: 16px;
    }
    
    .mapwrap .hero{
      padding: 20px 20px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px; 
      flex-wrap: wrap;
    }
    
    .mapwrap .title{ 
      font-size: 2.5rem; 
      font-weight: 900; 
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .mapwrap .sub{ 
      font-size: 0.95rem; 
      color: rgba(255, 255, 255, 0.8); 
    }
    
    #globe{
      height: 280px; 
      margin: 0 12px 12px; 
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      background: #1a1a2e;
    }

    /* ÔøΩ GOLD STANDARD: Drop a Hi Button - Orange Glassmorphic */
    .drop-hi-button-gold-standard {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px 24px;
      background: linear-gradient(135deg, 
        rgba(255, 122, 24, 0.9) 0%,
        rgba(255, 209, 102, 0.95) 50%,
        rgba(255, 179, 71, 0.9) 100%
      );
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 209, 102, 0.4);
      border-radius: 16px;
      color: #1a1a1a;
      font-weight: 700;
      font-size: 16px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      box-shadow: 
        0 8px 32px rgba(255, 122, 24, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.4),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateY(0px);
      z-index: 10;
      overflow: hidden;
    }

    .drop-hi-button-gold-standard::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(135deg, 
        rgba(255, 122, 24, 0.6) 0%,
        rgba(255, 209, 102, 0.8) 50%,
        rgba(255, 179, 71, 0.6) 100%
      );
      border-radius: 18px;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .drop-hi-button-gold-standard:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 12px 40px rgba(255, 122, 24, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.5),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
      border-color: rgba(255, 209, 102, 0.6);
    }

    .drop-hi-button-gold-standard:hover::before {
      opacity: 1;
    }

    .drop-hi-button-gold-standard:active {
      transform: translateY(-1px);
      box-shadow: 
        0 6px 24px rgba(255, 122, 24, 0.3),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .drop-hi-button-gold-standard.loading {
      animation: pulse-orange 2s infinite;
    }

    .drop-hi-button-gold-standard .button-icon {
      font-size: 18px;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
    }

    .drop-hi-button-gold-standard .button-glow {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at center, 
        rgba(255, 209, 102, 0.4) 0%,
        rgba(255, 209, 102, 0.2) 40%,
        transparent 70%
      );
      border-radius: inherit;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .drop-hi-button-gold-standard:hover .button-glow {
      opacity: 1;
    }

    @keyframes pulse-orange {
      0%, 100% { 
        box-shadow: 0 8px 32px rgba(255, 122, 24, 0.3);
        border-color: rgba(255, 209, 102, 0.4);
      }
      50% { 
        box-shadow: 0 8px 32px rgba(255, 122, 24, 0.6);
        border-color: rgba(255, 209, 102, 0.8);
      }
    }

    /* üìä FEED CONTAINER - UNIFIED SCROLL STREAM */
    .feed-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      /* ‚úÖ GOLD STANDARD: No height constraint, no overflow=scroll
         Everything flows in ONE unified page scroll stream */
      overflow: visible;
    }
    
    /* üé® PREMIUM TABS - Integrated into feed container */
    .tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0;
      margin: 0;
      position: relative;
      z-index: 10;
      pointer-events: auto;
      overflow-x: auto; /* Handle mobile overflow */
      overflow-y: hidden;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
    }
    
    .tabs::-webkit-scrollbar {
      display: none; /* Chrome/Safari */
    }
    
    /* Tesla-Grade Mobile Tab Optimization */
    @media (max-width: 768px) {
      .tabs {
        padding: 0 8px;
        gap: 4px;
      }
      
      .tab {
        min-width: 120px; /* Prevent tab squashing */
        padding: 14px 8px;
        font-size: 13px;
        white-space: nowrap;
        flex: none; /* Allow natural width on mobile */
      }
    }
    
    .tab {
      flex: 1;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      padding: 16px 12px;
      min-height: 44px; /* Tesla minimum touch target */
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.15s ease, background-color 0.15s ease, border-bottom-color 0.15s ease;
      border-bottom: 3px solid transparent;
      will-change: color, background-color, border-bottom-color;
      transform: translateZ(0);
      pointer-events: auto;
      position: relative;
      z-index: 10;
      outline: none; /* Custom focus styling below */
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    /* Tesla-Grade Focus State */
    .tab:focus-visible {
      outline: 2px solid rgba(78, 205, 196, 0.6);
      outline-offset: -2px;
    }
    
    /* Loading State for Tabs */
    .tab.loading {
      opacity: 0.6;
      cursor: wait;
    }
    
    .tab.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      right: 8px;
      width: 12px;
      height: 12px;
      margin-top: -6px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      animation: tabSpinner 0.8s linear infinite;
    }
    
    @keyframes tabSpinner {
      to { transform: rotate(360deg); }
    }

    /* üîß Tesla-Grade Loading Spinner */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .tab:hover {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.9);
      transform: translateZ(0);
    }
    
    .tab:active {
      transform: translateZ(0) scale(0.98);
      transition: transform 0.1s ease;
    }
    
    .tab[aria-selected="true"] {
      color: white;
      background: rgba(255, 255, 255, 0.1);
      border-bottom-color: #4ECDC4;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* üî• Hi Experience Layer Styles */
    #hiExperienceLayer {
      margin: 2rem 0;
    }

    .hi-experience-section {
      margin-bottom: 2rem;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
      overflow: hidden;
    }

    /* Hi-Island Stats Bar Responsive */
    .hi-island-stats-bar {
      animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* üéØ Tesla-Grade Drop Hi Button Styling */
    #dropHiButton {
      background: linear-gradient(135deg, #4ECDC4 0%, #44B3AA 100%);
      color: white;
      border: none;
      padding: 16px 32px; /* Tesla minimum 44px height */
      min-height: 44px; /* Explicit Tesla touch target */
      border-radius: 25px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
      text-transform: none;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
      outline: none; /* Custom focus styling below */
    }
    
    /* Tesla-Grade Focus State */
    #dropHiButton:focus-visible {
      outline: 3px solid rgba(78, 205, 196, 0.6);
      outline-offset: 2px;
    }
    
    /* Loading State */
    #dropHiButton.loading {
      opacity: 0.7;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    #dropHiButton.loading::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: dropHiButtonSpinner 0.8s linear infinite;
    }
    
    #dropHiButton.loading .button-text {
      opacity: 0;
    }
    
    @keyframes dropHiButtonSpinner {
      to { transform: rotate(360deg); }
    }
    
    /* Disabled State */
    #dropHiButton:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    #dropHiButton:hover {
      background: linear-gradient(135deg, #5EDDD4 0%, #4ECDC4 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
    }
    
    #dropHiButton:active {
      transform: translateY(0px);
      box-shadow: 0 2px 10px rgba(78, 205, 196, 0.3);
    }
    
    #dropHiButton::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    #dropHiButton:active::after {
      width: 300px;
      height: 300px;
    }
    
    /* Tesla-Grade Mobile Drop Hi button */
    @media (max-width: 768px) {
      #dropHiButton {
        padding: 14px 24px; /* Maintain 44px+ height on mobile */
        min-height: 44px;
        font-size: 15px; /* Slightly larger for mobile readability */
        min-width: 140px; /* Prevent too-narrow buttons */
      }
      
      .mapwrap .hero {
        flex-direction: column;
        text-align: center;
        gap: 16px;
      }
    }

    /* Responsive adjustments for experience layer */
    @media (max-width: 768px) {
      .hi-experience-section {
        margin: 1rem 0;
        border-radius: 0.75rem;
      }
      
      .hi-island-stats-bar {
        padding: 12px;
        margin: 12px 0;
        border-radius: 12px;
      }
      
      .hi-island-stats-bar .stat-item > div:first-child {
        font-size: 20px !important;
      }
      
      .hi-island-stats-bar .stat-item > div:last-child {
        font-size: 10px !important;
      }
    }

    @media (max-width: 480px) {
      .hi-island-stats-bar {
        flex-direction: column;
        gap: 8px;
        padding: 16px;
      }
      
      .hi-island-stats-bar .stat-item {
        flex: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
      }
      
      .hi-island-stats-bar .stat-item > div:first-child {
        order: 2;
        font-size: 18px !important;
      }
      
      .hi-island-stats-bar .stat-item > div:last-child {
        order: 1;
        font-size: 12px !important;
        text-align: left;
      }
    }

    /* ===================================================================
       üéØ TESLA-GRADE HI FEED ITEM STYLES (Phase 1 Gold Standard)
    =================================================================== */
    
    .hi-share-item {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .hi-share-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .share-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .share-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .share-avatar, .share-avatar-placeholder {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gradient-island);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }

    .share-username {
      font-weight: 600;
      color: #333;
    }

    .share-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #666;
    }

    .share-visibility {
      background: rgba(103, 126, 234, 0.1);
      color: #677eea;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 500;
    }

    /* üéØ TESLA-GRADE: Hi Content Formatting */
    .hi-formatted-content {
      padding: 16px;
      background: linear-gradient(135deg, rgba(103, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
      border: 1px solid rgba(103, 126, 234, 0.1);
      border-radius: 12px;
      margin: 12px 0;
    }

    .hi-current-state {
      display: inline-block;
      background: rgba(255, 193, 7, 0.1);
      color: #ff6b35;
      padding: 8px 12px;
      border-radius: 20px;
      font-weight: 600;
      margin: 4px;
      border: 1px solid rgba(255, 107, 53, 0.2);
    }

    .hi-desired-state {
      display: inline-block;
      background: rgba(34, 197, 94, 0.1);
      color: #059669;
      padding: 8px 12px;
      border-radius: 20px;
      font-weight: 600;
      margin: 4px;
      border: 1px solid rgba(5, 150, 105, 0.2);
    }

    .hi-additional-text {
      margin-top: 12px;
      color: #444;
      font-style: italic;
      line-height: 1.5;
    }

    .share-text {
      color: #555;
      line-height: 1.6;
      margin: 8px 0;
    }

    .share-location {
      color: #666;
      font-size: 12px;
      margin-top: 8px;
    }

    .share-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .share-action-btn {
      background: rgba(103, 126, 234, 0.1);
      color: #677eea;
      border: 1px solid rgba(103, 126, 234, 0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .share-action-btn:hover {
      background: rgba(103, 126, 234, 0.2);
      transform: translateY(-1px);
    }

    /* Floating Refresh Button */
    .floating-refresh {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #FFD166 0%, #F4A261 100%);
      border: none;
      border-radius: 50%;
      color: #1E2A4A;
      font-size: 20px;
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(255, 209, 102, 0.3);
    }

    .floating-refresh:hover {
      transform: translateY(-2px) rotate(90deg);
      box-shadow: 0 6px 20px rgba(255, 209, 102, 0.4);
    }

    .floating-refresh:active {
      transform: translateY(0) rotate(180deg);
    }

    /* Floating Hiffirmations System */
    .floating-hiffirmations {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #E91E63 0%, #9C27B0 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      z-index: 999;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(233, 30, 99, 0.3);
      animation: gentlePulse 4s infinite;
    }

    .floating-hiffirmations:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 20px rgba(233, 30, 99, 0.4);
      animation-play-state: paused;
    }

    .floating-hiffirmations:active {
      transform: translateY(0) scale(0.95);
    }

    @keyframes gentlePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    /* Hiffirmation Popup */
    .hiffirmation-popup {
      position: fixed;
      bottom: 85px;
      left: 20px;
      max-width: 280px;
      background: rgba(26, 32, 56, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 16px 20px;
      color: white;
      font-size: 14px;
      line-height: 1.4;
      transform: translateY(20px) scale(0.9);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 1000;
      pointer-events: none;
    }

    .hiffirmation-popup.show {
      transform: translateY(0) scale(1);
      opacity: 1;
      pointer-events: auto;
    }

    .hiffirmation-popup::before {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 28px;
      width: 16px;
      height: 16px;
      background: rgba(26, 32, 56, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-top: none;
      border-left: none;
      transform: rotate(45deg);
      border-radius: 0 0 4px 0;
    }

    /* Tesla-Grade Wave Emoji Map Markers */
    .custom-wave-marker {
      background: transparent;
      border: none;
    }
    
    .wave-marker {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      font-size: 20px;
      background: radial-gradient(60% 60% at 50% 50%, rgba(255, 209, 102, 0.28) 0%, rgba(255, 123, 36, 0.12) 70%);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 209, 102, 0.75);
      border-radius: 50%;
      box-shadow:
        0 0 0 2px rgba(0, 0, 0, 0.22), /* contrast ring for bright oceans */
        0 6px 20px rgba(255, 123, 36, 0.35),
        0 0 0 8px rgba(255, 209, 102, 0.22);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      animation: gentle-pulse 3s infinite ease-in-out;
    }
    
    .wave-marker:hover {
      transform: scale(1.1);
      background: radial-gradient(60% 60% at 50% 50%, rgba(255, 209, 102, 0.35) 0%, rgba(255, 123, 36, 0.18) 70%);
      border-color: rgba(255, 209, 102, 0.9);
      box-shadow:
        0 0 0 2px rgba(0, 0, 0, 0.24),
        0 10px 28px rgba(255, 123, 36, 0.45),
        0 0 0 10px rgba(255, 209, 102, 0.26);
    }
    
    @keyframes gentle-pulse {
      0%, 100% { 
        box-shadow:
          0 0 0 2px rgba(0, 0, 0, 0.20),
          0 6px 18px rgba(255, 123, 36, 0.30),
          0 0 0 6px rgba(255, 209, 102, 0.18);
      }
      50% { 
        box-shadow:
          0 0 0 2px rgba(0, 0, 0, 0.22),
          0 12px 28px rgba(255, 123, 36, 0.42),
          0 0 0 10px rgba(255, 209, 102, 0.24);
      }
    }

    /* Brand-styled cluster markers */
    .hi-cluster-wrapper { background: transparent; border: 0; }
    .hi-cluster {
      display: inline-flex;
      align-items: center; justify-content: center;
      width: 44px; height: 44px; border-radius: 50%;
      background: radial-gradient(60% 60% at 50% 50%, rgba(255,209,102,0.32) 0%, rgba(255,123,36,0.14) 70%);
      border: 2px solid rgba(255,209,102,0.85);
      box-shadow:
        0 0 0 2px rgba(0,0,0,0.25),
        0 10px 28px rgba(255,123,36,0.45),
        0 0 0 12px rgba(255,209,102,0.22);
      position: relative;
      font-weight: 700;
      color: #1a2038;
    }
    .hi-cluster__emoji { font-size: 16px; margin-right: 4px; }
    .hi-cluster__count { font-size: 14px; }
  </style>
  
  <!-- Tier Loading Skeleton CSS -->
  <link rel="stylesheet" href="./assets/tier-loading-skeleton.css">
  
  <!-- HiFooter CSS - Dashboard Parity -->
  <link rel="preload" href="./ui/HiFooter/HiFooter.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./ui/HiFooter/HiFooter.css"></noscript>
</head>
<body data-page="hi-island">
  <!-- Tesla-Grade Dashboard Header -->
  <header class="tesla-header">
    <div class="header-left">
      <button class="calendar-btn" onclick="showCalendar()">
        üìÖ
      </button>
      
      <button class="home-nav-btn" onclick="navigateToHome()" aria-label="Go to Hi Today" title="Navigate to Hi Today">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9,22 9,12 15,12 15,22"/>
        </svg>
      </button>
    </div>
    
    <div class="header-center">
      <div class="brand-container">
        <img src="./assets/brand/hi-logo-light.png" alt="Hi" class="brand-hi-logo">
        <span class="brand-text">Hi Island</span>
      </div>
    </div>
    
    <div class="header-right">
      <div id="hi-tier-indicator" class="tier-indicator" title="Loading tier..." data-auth-loading="true">
        <span class="tier-text tier-loading">‚è≥</span>
      </div>
      <button class="menu-btn" onclick="openNavigation()">
        <span style="font-size: 18px;">‚ò∞</span>
      </button>
    </div>
  </header>

  <!-- Navigation Modal -->
  <div id="navigationModal" class="navigation-modal" style="display: none;">
    <div class="navigation-backdrop" id="navigationBackdrop"></div>
    <div class="navigation-content">
      <div class="navigation-header">
        <h3>Stay Hi Navigation</h3>
        <button id="closeNavigation" class="close-nav-btn">‚úï</button>
      </div>
      
      <div class="navigation-menu">
        <div class="nav-section">
          <div class="nav-section-title">Navigate</div>
          <a href="hi-dashboard.html" class="nav-item">
            <span class="nav-icon">üè†</span>
            <span>Hi Today</span>
          </a>
          <a href="hi-island-NEW.html" class="nav-item" style="background: rgba(255, 209, 102, 0.2); border-color: rgba(255, 209, 102, 0.3);">
            <span class="nav-icon">üèùÔ∏è</span>
            <span>Hi Island</span>
          </a>
          <a href="hi-muscle.html" class="nav-item">
            <span class="nav-icon">üí™</span>
            <span>Hi Gym</span>
          </a>
          <a href="profile.html?from=hi-island-NEW.html" class="nav-item">
            <span class="nav-icon">üë§</span>
            <span>Profile</span>
          </a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Tools</div>
          <a href="#" onclick="showCalendar(); window.closeNavigation(); return false;" class="nav-item">
            <span class="nav-icon">üìÖ</span>
            <span>Calendar</span>
          </a>
          <a href="#" onclick="openHiffirmations(); window.closeNavigation(); return false;" class="nav-item">
            <span class="nav-icon">‚ú®</span>
            <span>Hiffirmations</span>
          </a>
        </div>
        <div class="nav-section" id="adminSection" style="display: none;">
          <div class="nav-section-title">Admin</div>
          <a href="hi-mission-control.html" class="nav-item admin-item" data-mc-link>
            <span class="nav-icon">üéõÔ∏è</span>
            <span>Hi Mission Control</span>
          </a>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function(){
      function resolveMC(){ try { return window.hiPaths?.resolve ? window.hiPaths.resolve('hi-mission-control.html') : 'hi-mission-control.html'; } catch { return 'hi-mission-control.html'; } }
      function showAdminSectionIfNeeded(){
        try {
          const st = window.AdminAccessManager?.getState?.();
          if (st?.isAdmin){ const sec = document.getElementById('adminSection'); if (sec) sec.style.display='block'; }
        } catch {}
      }
      function attach(){
        document.querySelectorAll('[data-mc-link]').forEach(a=>{
          a.setAttribute('href', resolveMC());
          if (!a.__mcBound){
            a.__mcBound=true;
            a.addEventListener('click', function(e){ if(window.HiMissionControlAccess){ e.preventDefault(); window.HiMissionControlAccess.openGate(); } });
          }
        });
      }
      showAdminSectionIfNeeded();
      attach();
      window.addEventListener('hi:admin-confirmed', ()=>{ showAdminSectionIfNeeded(); attach(); });
    })();
  </script>

  <!-- Main Content -->
  <main class="wrap">
    <!-- üèùÔ∏è GOLD STANDARD: Hero Section with Drop Hi Button -->
    <section class="mapwrap" aria-label="Hi Island ‚Äì world map">
      <div class="hero">
        <div>
          <div class="title">Hi Island</div>
          <div class="sub">A gentle stream of Hi Shares from around the world</div>
        </div>
        <button 
          class="hi-btn drop-hi-button-gold-standard" 
          onclick="handleDropHiClick()" 
          id="dropHiButton"
          aria-label="Drop a Hi moment on the island"
          type="button">
          <span class="button-icon">üèùÔ∏è</span>
          <span class="button-text">Drop a Hi</span>
          <span class="button-glow"></span>
        </button>
        <div style="margin-top: 8px;">
          <button id="tryHiLink" type="button" aria-label="Try a Hi without saving"
            style="background: none; border: none; color: rgba(255,255,255,0.8); font-size: 12px; cursor: pointer; text-decoration: underline; padding: 4px 6px;">
            Try it ‚Äî nothing is saved
          </button>
        </div>
      </div>
      <!-- üó∫Ô∏è Map Component: Shows Hi Shares with location pins -->
      <div id="hi-island-map-root"></div>
    </section>

    <!-- üöÄ HI-ISLAND STATS BAR: Tesla-Grade Instant Display (Dashboard Parity) -->
    <div class="hi-island-stats-bar" style="
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      border: 1px solid rgba(255, 255, 255, 0.15);
      transition: all 0.3s ease;
    ">
      <div class="stat-item" style="text-align: center; flex: 1;">
        <div style="font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 4px;" id="globalHiWaves">...</div>
        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); text-transform: uppercase; letter-spacing: 0.5px;" title="Global Waves: Ambient encouragement sent to everyone. Wave Backs are direct responses on individual shares.">Global Waves</div>
      </div>
      <div class="stat-item" style="text-align: center; flex: 1;">
        <div style="font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 4px;" id="globalTotalHis">...</div>
        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); text-transform: uppercase; letter-spacing: 0.5px;">Total His</div>
      </div>
      <div class="stat-item" style="text-align: center; flex: 1;">
        <div style="font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 4px;" id="globalTotalUsers">...</div>
        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); text-transform: uppercase; letter-spacing: 0.5px;">Total Users</div>
      </div>
    </div>

    <!-- üèùÔ∏è GOLD STANDARD: Tabbed Feed Container -->
    <div class="feed-container">
      <nav class="tabs" role="tablist" aria-label="Hi Island tabs">
        <button class="tab" id="tab-general" role="tab" aria-selected="true" aria-controls="hi-island-feed-root" data-target="general">General Shares</button>
        <button class="tab" id="tab-archive" role="tab" aria-selected="false" aria-controls="hi-island-feed-root" data-target="archive">My Archive</button>
        <button class="tab" id="tab-trends" role="tab" aria-selected="false" aria-controls="hi-island-feed-root" data-target="trends">Emotional Trends</button>
        <button class="tab" id="tab-milestones" role="tab" aria-selected="false" aria-controls="hi-island-feed-root" data-target="milestones">Points Milestones</button>
        <button class="tab" id="tab-show" role="tab" aria-selected="false" aria-controls="hi-island-feed-root" data-target="show">Hi Show Shares</button>
      </nav>
      
      <!-- üöÄ ORIGIN FILTER CONTROLS -->
      <div class="feed-filter-controls" style="
        display: flex; 
        gap: 8px; 
        margin: 16px 0; 
        padding: 12px; 
        background: rgba(255, 255, 255, 0.05); 
        border-radius: 12px; 
        flex-wrap: wrap; 
        justify-content: center;
        position: relative;
        z-index: 10;
        pointer-events: auto;
      ">
        <button class="origin-filter-btn active" data-filter="all" style="
          padding: 6px 12px; 
          border: 1px solid rgba(255, 255, 255, 0.2); 
          border-radius: 20px; 
          background: rgba(255, 255, 255, 0.9); 
          color: #111; 
          font-size: 12px; 
          font-weight: 600; 
          cursor: pointer; 
          transition: all 0.3s ease;
          pointer-events: auto;
          position: relative;
          z-index: 10;
        ">All</button>
        <button class="origin-filter-btn" data-filter="quick" style="
          padding: 6px 12px; 
          border: 1px solid rgba(255, 255, 255, 0.2); 
          border-radius: 20px; 
          background: rgba(255, 255, 255, 0.1); 
          color: rgba(255, 255, 255, 0.8); 
          font-size: 12px; 
          font-weight: 600; 
          cursor: pointer; 
          transition: all 0.3s ease;
          pointer-events: auto;
          position: relative;
          z-index: 10;
        "><span class="emoji-test">‚ö° Hi5</span></button>
        <button class="origin-filter-btn" data-filter="muscle" style="
          padding: 6px 12px; 
          border: 1px solid rgba(255, 255, 255, 0.2); 
          border-radius: 20px; 
          background: rgba(255, 255, 255, 0.1); 
          color: rgba(255, 255, 255, 0.8); 
          font-size: 12px; 
          font-weight: 600; 
          cursor: pointer; 
          transition: all 0.3s ease;
          pointer-events: auto;
          position: relative;
          z-index: 10;
        ">üí™ HiGym</button>
        <button class="origin-filter-btn" data-filter="island" style="
          padding: 6px 12px; 
          border: 1px solid rgba(255, 255, 255, 0.2); 
          border-radius: 20px; 
          background: rgba(255, 255, 255, 0.1); 
          color: rgba(255, 255, 255, 0.8); 
          font-size: 12px; 
          font-weight: 600; 
          cursor: pointer; 
          transition: all 0.3s ease;
          pointer-events: auto;
          position: relative;
          z-index: 10;
        ">üèùÔ∏è Island</button>
      </div>

      <!-- üöÄ Hi-Island Social Hi 5 System (Enhanced with Tabs) -->
      <div id="hi-island-feed-root">
        <!-- Social system will be injected here -->
      </div>
    </div>
  </main>

  <!-- Toast Notifications -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- ===================================================================
       SCRIPTS (Load Order Matters - Tesla-Grade Timing)
  =================================================================== -->
  
  <!-- Core Dependencies (Load First) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha384-cxOPjt7s7Iz04uaHJceBmS+qpjv2JkIHNVcuOrM+YHwZOmJGBXI00mdUXEq65HTH" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" integrity="sha384-RLIyj5q1b5XJTn0tqUhucRZe40nFTocRP91R/NkRJHwAe4XxnTV77FXy/vGLiec2" crossorigin="anonymous"></script>
  <!-- Unified Monitoring Init (errors + tracking) -->
  <script src="./lib/boot/monitoring-init.js"></script>
  <!-- üöÄ TESLA FIX: Initialize HiSupabase before HiDB -->
  <script type="module" src="./lib/boot/island-supabase-prime.mjs"></script>
  
  <!-- üèÜ WOZ FIX: ProfileManager - Single Source of Truth -->
  <script src="./lib/ProfileManager.js"></script>
  
  <script src="./lib/HiDB.js" defer></script>
  <script src="assets/avatar-utils.js"></script>
  <script src="assets/geocoding-service.js"></script>
  
  <!-- Feature Flags & Rewards System -->
  <script src="assets/feature-flags.js"></script>
  <script src="assets/hi-rewards-controller.js"></script>
  
  <!-- HiBase Integration (Flagged Rollout) -->
  <script type="module" src="./lib/boot/island-hibase-shares.mjs"></script>
  
  <!-- Legacy competing feed systems removed (phase 1) -->

  <!-- üéØ PHASE 1: Use ONLY UnifiedHiIslandController for clean architecture -->
  <script type="module" src="./ui/HiStreaks/HiStreaks.js"></script>

  <!-- Component Scripts -->
  <script type="module" src="./lib/boot/island-sharesheet-global.mjs"></script>
  
  <!-- üö® EMERGENCY DISABLE: Multiple competing feed systems causing conflicts -->
  <!-- TEMPORARILY DISABLED: HiIslandIntegration.js - conflicts with main feed -->
  <!-- TEMPORARILY DISABLED: HiGoldStandardIntegration.js - DOM structure mismatch -->
  <!-- ‚úÖ UNIFIED FEED SYSTEM: Single controller for all feed operations -->
  <script src="components/hi-real-feed/HiRealFeed.js?v=20241213" type="module"></script>
  <script src="components/hi-real-feed/UnifiedHiIslandController.js?v=20241213" type="module"></script>
  
  <!-- üö® EMERGENCY: Freeze diagnostic tool for Tesla-grade debugging -->
  <!-- WOZ FIX: Diagnostic script crashes on line 88 - interceptAsyncFunction doesn't exist -->
  <!-- <script src="lib/diagnostic/HiShareFreezeDiagnostic.js"></script> -->
  
  <!-- üöÄ TESLA FIX: Initialize Supabase client before other modules -->
  <script type="module" src="./lib/boot/island-supabase-verify.mjs"></script>

  <!-- üéØ PHASE 1: Validation test for architectural consolidation -->
  <script src="phase1-validation-test.js"></script>
  
  <!-- Legacy Social System (Deprecated - replaced by REAL system above) -->
  <!-- <script src="components/hi-social-system/HiSocialSystem.js" type="module"></script> -->
  
  <script src="components/profile-preview-modal/profile-modal.js" type="module"></script>
  
  <!-- Optional Components -->
  <script src="components/hi-island-map/map.js" type="module"></script>
  <!-- <script src="components/hi-island-feed/feed.js" type="module"></script> -->
  
  <!-- üéØ TESLA-GRADE: Total His Tracking System (Hi-Island Support) -->
  <script src="lib/stats/GoldStandardTracker.js" type="module"></script>
  
  <!-- üöÄ TESLA-GRADE STATS: HiMetrics System for Dashboard Parity -->
  <script src="lib/HiMetrics.js" type="module"></script>
  <script src="lib/stats/GoldStandardTracker.js" type="module"></script>
  
  <!-- üöÄ HI OS ENHANCEMENT: Optional enhancement layer -->
  <script type="module" src="./lib/boot/island-enhancement-delay.mjs"></script>

  <!-- üß™ BACKEND PLUMBING TEST (opt-in: add ?diag=backend) -->
  <script>
    (() => {
      const params = new URLSearchParams(location.search);
      if (params.get('diag') !== 'backend') return;
      const s = document.createElement('script');
      s.src = 'test-backend-plumbing.js';
      document.head.appendChild(s);
    })();
  </script>
  
  <!-- Header: Using Tesla-Grade Dashboard Header (no HiHeader.js needed) -->
  
  <!-- Footer - Dashboard Parity -->
  <script src="./ui/HiFooter/HiFooter.js" defer></script>
  
  <!-- üéâ Premium UX System (Celebrations + Confetti + Haptics) -->
  <script src="assets/premium-ux.js" defer></script>
  
  <!-- Integrity + quick access merged into mc-access-core.js -->
  
  <!-- Premium Calendar lazy loader (on-demand) -->
  <script src="./lib/lazy/lazy-loaders.js"></script>
  <!-- Island Header Controls (navigation + calendar hooks) -->
  <script src="./lib/boot/island-header.js"></script>

  <!-- Page Orchestrator -->
  <script type="module" src="./lib/boot/island-main.mjs?v=20241122-woz"></script>
  <!-- Tesla Navigation + Floating Systems -->
  <!-- Removed floating refresh & hiffirmations on Island (dashboard-only) -->
  <!-- <script src="./lib/boot/island-floating.js"></script> -->
  
  <!-- Removed mc-quick-access (replaced by mc-access-core.js) -->
  
  <!-- üéØ TIER STATUS UPDATE: Listen for auth ready and update tier display -->
  <script>
    (function() {
      console.log('üéØ Tier update script loaded');
      
      // Store the latest tier data in case HiBrandTiers loads late
      let pendingTierUpdate = null;
      
      function updateBrandTierDisplay(data) {
        const indicator = document.getElementById('hi-tier-indicator');
        if (!indicator) {
          console.warn('‚ö†Ô∏è Tier indicator element not found');
          return;
        }
        
        // Extract membership from event detail (could be {session, membership} or just membership)
        const membership = data?.membership || data;
        // tier might be a function (HiMembership.tier()) or a string
        const tierValue = typeof membership?.tier === 'function' ? membership.tier() : membership?.tier;
        const tier = tierValue || 'explorer';
        const tierText = indicator.querySelector('.tier-text');
        
        if (!tierText) {
          console.warn('‚ö†Ô∏è Tier text element not found');
          return;
        }
        
        // Check if HiBrandTiers is loaded
        if (!window.HiBrandTiers) {
          console.log('‚è≥ HiBrandTiers not loaded yet, storing pending update for tier:', tier);
          pendingTierUpdate = { tier, membership, indicator, tierText };
          return;
        }
        
        console.log('üéØ Updating tier display:', { tier, membership, tierText: tierText.textContent });
        
        // Remove loading state
        indicator.removeAttribute('data-auth-loading');
        tierText.classList.remove('tier-loading');
        
        // Get tier config from HiBrandTiers
        const tierConfig = window.HiBrandTiers.getDisplayInfo(tier);
        
        if (tierConfig) {
          tierText.textContent = tierConfig.emoji;
          tierText.className = `tier-text tier-${tier.toLowerCase()}`;
          indicator.title = tierConfig.name;
          indicator.style.setProperty('--tier-color', tierConfig.color);
          console.log('‚úÖ Tier display updated to:', tierConfig.name, tierConfig.emoji);
          pendingTierUpdate = null; // Clear pending update
        } else {
          console.warn('‚ö†Ô∏è No tier config found for:', tier, 'HiBrandTiers:', !!window.HiBrandTiers);
        }
      }
      
      // Listen for HiBrandTiers to load and process pending updates
      function checkForPendingUpdate() {
        if (window.HiBrandTiers && pendingTierUpdate) {
          console.log('‚úÖ HiBrandTiers loaded, processing pending tier update');
          updateBrandTierDisplay(pendingTierUpdate);
        }
      }
      
      // Check periodically for HiBrandTiers
      const brandTiersCheck = setInterval(() => {
        if (window.HiBrandTiers) {
          clearInterval(brandTiersCheck);
          checkForPendingUpdate();
        }
      }, 100);
      
      // Listen for auth ready event (detail: {session, membership})
      window.addEventListener('hi:auth-ready', (e) => {
        console.log('üéØ Received hi:auth-ready event:', e.detail);
        updateBrandTierDisplay(e.detail);
      });
      
      // Also listen for membership status changes
      window.addEventListener('membershipStatusChanged', (e) => {
        console.log('üéØ Received membershipStatusChanged event:', e.detail);
        updateBrandTierDisplay(e.detail);
      });
      
      // Also listen for hi:membership-changed (from AuthReady.js)
      window.addEventListener('hi:membership-changed', (e) => {
        console.log('üéØ Received hi:membership-changed event:', e.detail);
        updateBrandTierDisplay({ membership: e.detail });
      });
      
      // Check if already initialized (with retry)
      let attempts = 0;
      const checkInterval = setInterval(() => {
        attempts++;
        if (window.HiBrandTiers && (window.HiMembership?.tier || window.__hiMembership?.tier)) {
          clearInterval(checkInterval);
          const membership = window.HiMembership || window.__hiMembership;
          console.log('üéØ Found existing membership on attempt', attempts, ':', membership);
          updateBrandTierDisplay({ membership });
        } else if (attempts >= 20) {
          clearInterval(checkInterval);
          console.warn('‚ö†Ô∏è Tier membership not found after 20 attempts (10 seconds)', {
            HiBrandTiers: !!window.HiBrandTiers,
            HiMembership: !!window.HiMembership,
            __hiMembership: !!window.__hiMembership
          });
        }
      }, 500);
    })();
  </script>
</body>
</html>
