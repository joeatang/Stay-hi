<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hi Island ‚Äî Stay Hi</title>

  <!-- üì± PWA Configuration -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD166">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Hi Island">

  <!-- Resource Hints for Cross-Navigation Performance -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" as="script">
  <link rel="prefetch" href="index.html">
  <link rel="prefetch" href="hi-muscle.html">
  <link rel="dns-prefetch" href="//unpkg.com">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <!-- üöÄ Tesla-Grade Anonymous Access Modal System (Async) -->
  <script src="assets/anonymous-access-modal.js" async></script>
  
  <!-- üîê Authentication System (Tesla-Grade Progressive Auth) -->
  <script src="assets/progressive-auth.js" async></script>
  
  <!-- üéØ Tesla-Grade Tier System -->
  <script src="assets/hi-tier-system.js" async></script>
  
  <!-- üöÄ Hi Upgrade Modal System -->
  <link rel="stylesheet" href="ui/HiUpgradeModal/HiUpgradeModal.css">
  <script src="ui/HiUpgradeModal/HiUpgradeModal.js" defer></script>

  <!-- Design System -->
  <link rel="stylesheet" href="styles/tokens.css"/>
  <link rel="stylesheet" href="styles/base.css"/>
  
  <!-- Shared UI -->
  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>
  <link rel="stylesheet" href="assets/premium-ux.css"/>
  <link rel="stylesheet" href="assets/premium-calendar.css"/>

  <!-- Component Styles -->
  <link rel="stylesheet" href="components/hi-island-map/map.css"/>
  <link rel="stylesheet" href="components/hi-island-feed/feed.css"/>
  <link rel="stylesheet" href="ui/HiShareSheet/HiShareSheet.css"/>
  <link rel="stylesheet" href="components/profile-preview-modal/profile-modal.css"/>
  
  <!-- Hi Feature Flags & Rewards -->
  <link rel="stylesheet" href="assets/hi-rewards-styles.css"/>

  <!-- Leaflet (for map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  
  <!-- Leaflet MarkerCluster Plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  
  <!-- üöÄ PWA Manager -->
  <script src="assets/pwa-manager.js"></script>
  
  <style>
    /* ===================================================================
       üé® HI ISLAND PAGE STYLES (Scoped to this page only)
    =================================================================== */
    
    body {
      background: var(--gradient-island);
      background-attachment: fixed;
      min-height: 100vh;
    }

    /* ============================================================================
       üèóÔ∏è GOLD STANDARD ARCHITECTURE: SCOPED CSS
       ============================================================================
       All Hi Island styles are namespaced to prevent conflicts with other pages.
       This follows BEM methodology + CSS namespacing for component isolation.
    ============================================================================ */

    /* Tesla-grade header on hi-island: clean minimal layout */
    body[data-page="hi-island"] header {
      padding: var(--space-md) !important;
      backdrop-filter: blur(20px) !important;
      background: rgba(255, 255, 255, 0.95) !important;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
    }

    body[data-page="hi-island"] .appbar {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      max-width: 100% !important;
    }

    body[data-page="hi-island"] .appbar .brand {
      position: absolute !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
    }

    body[data-page="hi-island"] .logo {
      max-height: 32px !important;
      width: auto !important;
      filter: invert(1) brightness(0) !important;
    }

    body[data-page="hi-island"] .brand-name {
      color: #000 !important;
      font-weight: 600 !important;
    }

    body[data-page="hi-island"] #btnMore {
      background: rgba(0, 0, 0, 0.08) !important;
      border-radius: 20px !important;
      padding: 8px 16px !important;
      transition: background 0.2s ease !important;
    }

    body[data-page="hi-island"] #btnMore:hover {
      background: rgba(0, 0, 0, 0.12) !important;
    }

    body[data-page="hi-island"] #btnMore svg {
      color: #333 !important;
    }

    /* üé® HI ISLAND CONTAINER (Main wrapper - all styles descend from here) */
    .wrap{ 
      max-width: 1040px; 
      margin: 0 auto; 
      padding: 16px;
    }

    /* üìç MAP SECTION */
    .mapwrap{
      position: relative; 
      overflow: hidden; 
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      min-height: 380px;
      display: grid; 
      grid-template-rows: auto 1fr;
      color: white;
      animation: fadeInUp 0.8s ease-out;
      margin-bottom: 16px;
    }
    
    .mapwrap .hero{
      padding: 20px 20px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px; 
      flex-wrap: wrap;
    }
    
    .mapwrap .title{ 
      font-size: 2.5rem; 
      font-weight: 900; 
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .mapwrap .sub{ 
      font-size: 0.95rem; 
      color: rgba(255, 255, 255, 0.8); 
    }
    
    #globe{
      height: 280px; 
      margin: 0 12px 12px; 
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      background: #1a1a2e;
    }

    /* üìä FEED CONTAINER */
    .feed-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    /* üé® PREMIUM TABS - Integrated into feed container */
    .tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0;
      margin: 0;
      position: relative;
      z-index: 10;
      pointer-events: auto;
    }
    
    .tab {
      flex: 1;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      padding: 16px 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.15s ease, background-color 0.15s ease, border-bottom-color 0.15s ease;
      border-bottom: 3px solid transparent;
      will-change: color, background-color, border-bottom-color;
      transform: translateZ(0);
      pointer-events: auto;
      position: relative;
      z-index: 10;
    }
    
    .tab:hover {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.9);
      transform: translateZ(0);
    }
    
    .tab:active {
      transform: translateZ(0) scale(0.98);
      transition: transform 0.1s ease;
    }
    
    .tab[aria-selected="true"] {
      color: white;
      background: rgba(255, 255, 255, 0.1);
      border-bottom-color: #4ECDC4;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* üî• Hi Experience Layer Styles */
    #hiExperienceLayer {
      margin: 2rem 0;
    }

    .hi-experience-section {
      margin-bottom: 2rem;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
      overflow: hidden;
    }

    /* Hi-Island Stats Bar Responsive */
    .hi-island-stats-bar {
      animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* üéØ Enhanced Drop Hi Button Styling */
    #dropHiButton {
      background: linear-gradient(135deg, #4ECDC4 0%, #44B3AA 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
      text-transform: none;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }
    
    #dropHiButton:hover {
      background: linear-gradient(135deg, #5EDDD4 0%, #4ECDC4 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
    }
    
    #dropHiButton:active {
      transform: translateY(0px);
      box-shadow: 0 2px 10px rgba(78, 205, 196, 0.3);
    }
    
    #dropHiButton::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    #dropHiButton:active::after {
      width: 300px;
      height: 300px;
    }
    
    /* Mobile responsive Drop Hi button */
    @media (max-width: 768px) {
      #dropHiButton {
        padding: 10px 20px;
        font-size: 14px;
      }
      
      .mapwrap .hero {
        flex-direction: column;
        text-align: center;
        gap: 16px;
      }
    }

    /* Responsive adjustments for experience layer */
    @media (max-width: 768px) {
      .hi-experience-section {
        margin: 1rem 0;
        border-radius: 0.75rem;
      }
      
      .hi-island-stats-bar {
        padding: 12px;
        margin: 12px 0;
        border-radius: 12px;
      }
      
      .hi-island-stats-bar .stat-item > div:first-child {
        font-size: 20px !important;
      }
      
      .hi-island-stats-bar .stat-item > div:last-child {
        font-size: 10px !important;
      }
    }

    @media (max-width: 480px) {
      .hi-island-stats-bar {
        flex-direction: column;
        gap: 8px;
        padding: 16px;
      }
      
      .hi-island-stats-bar .stat-item {
        flex: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
      }
      
      .hi-island-stats-bar .stat-item > div:first-child {
        order: 2;
        font-size: 18px !important;
      }
      
      .hi-island-stats-bar .stat-item > div:last-child {
        order: 1;
        font-size: 12px !important;
        text-align: left;
      }
    }
  </style>
  
  <!-- HiFooter CSS - Dashboard Parity -->
  <link rel="preload" href="./ui/HiFooter/HiFooter.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./ui/HiFooter/HiFooter.css"></noscript>
</head>
<body data-page="hi-island">
  <!-- Header (shared component) -->
  <header id="app-header" class="premium-header-container"></header>

  <!-- Main Content -->
  <main class="wrap">
    <!-- üèùÔ∏è GOLD STANDARD: Hero Section with Drop Hi Button -->
    <section class="mapwrap" aria-label="Hi Island ‚Äì world map">
      <div class="hero">
        <div>
          <div class="title">Hi Island</div>
          <div class="sub">A gentle stream of Hi Shares from around the world</div>
        </div>
        <button 
          class="hi-btn hi-btn--primary" 
          onclick="window.openHiComposer()" 
          id="dropHiButton"
          aria-label="Open Hi Share sheet to drop a Hi 5">
          Drop a Hi
        </button>
      </div>
      <div id="globe" aria-label="Interactive world map"></div>
    </section>

    <!-- üöÄ HI-ISLAND STATS BAR: Tesla-Grade Instant Display (Dashboard Parity) -->
    <div class="hi-island-stats-bar" style="
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      border: 1px solid rgba(255, 255, 255, 0.15);
      transition: all 0.3s ease;
    ">
      <div class="stat-item" style="text-align: center; flex: 1;">
        <div style="font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 4px;" id="globalHiWaves">...</div>
        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); text-transform: uppercase; letter-spacing: 0.5px;">Global Waves</div>
      </div>
      <div class="stat-item" style="text-align: center; flex: 1;">
        <div style="font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 4px;" id="globalTotalHis">...</div>
        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); text-transform: uppercase; letter-spacing: 0.5px;">Total His</div>
      </div>
      <div class="stat-item" style="text-align: center; flex: 1;">
        <div style="font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 4px;" id="globalTotalUsers">...</div>
        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); text-transform: uppercase; letter-spacing: 0.5px;">Total Users</div>
      </div>
    </div>

    <!-- üèùÔ∏è GOLD STANDARD: Tabbed Feed Container -->
    <div class="feed-container">
      <nav class="tabs" role="tablist" aria-label="Hi Island tabs">
        <button class="tab" id="tab-general" role="tab" aria-selected="true" data-target="general">General Shares</button>
        <button class="tab" id="tab-archive" role="tab" aria-selected="false" data-target="archive">My Archive</button>
        <button class="tab" id="tab-trends" role="tab" aria-selected="false" data-target="trends">Emotional Trends</button>
        <button class="tab" id="tab-milestones" role="tab" aria-selected="false" data-target="milestones">Points Milestones</button>
        <button class="tab" id="tab-show" role="tab" aria-selected="false" data-target="show">Hi Show Shares</button>
      </nav>
      
      <!-- üöÄ ORIGIN FILTER CONTROLS -->
      <div class="feed-filter-controls" style="
        display: flex; 
        gap: 8px; 
        margin: 16px 0; 
        padding: 12px; 
        background: rgba(255, 255, 255, 0.05); 
        border-radius: 12px; 
        flex-wrap: wrap; 
        justify-content: center;
        position: relative;
        z-index: 10;
        pointer-events: auto;
      ">
        <button class="origin-filter-btn active" data-filter="all" style="
          padding: 6px 12px; 
          border: 1px solid rgba(255, 255, 255, 0.2); 
          border-radius: 20px; 
          background: rgba(255, 255, 255, 0.9); 
          color: #111; 
          font-size: 12px; 
          font-weight: 600; 
          cursor: pointer; 
          transition: all 0.3s ease;
          pointer-events: auto;
          position: relative;
          z-index: 10;
        ">All</button>
        <button class="origin-filter-btn" data-filter="quick" style="
          padding: 6px 12px; 
          border: 1px solid rgba(255, 255, 255, 0.2); 
          border-radius: 20px; 
          background: rgba(255, 255, 255, 0.1); 
          color: rgba(255, 255, 255, 0.8); 
          font-size: 12px; 
          font-weight: 600; 
          cursor: pointer; 
          transition: all 0.3s ease;
          pointer-events: auto;
          position: relative;
          z-index: 10;
        "><span class="emoji-test">Hi5Ô∏è‚É£</span></button>
        <button class="origin-filter-btn" data-filter="muscle" style="
          padding: 6px 12px; 
          border: 1px solid rgba(255, 255, 255, 0.2); 
          border-radius: 20px; 
          background: rgba(255, 255, 255, 0.1); 
          color: rgba(255, 255, 255, 0.8); 
          font-size: 12px; 
          font-weight: 600; 
          cursor: pointer; 
          transition: all 0.3s ease;
          pointer-events: auto;
          position: relative;
          z-index: 10;
        ">üí™ Muscle</button>
        <button class="origin-filter-btn" data-filter="island" style="
          padding: 6px 12px; 
          border: 1px solid rgba(255, 255, 255, 0.2); 
          border-radius: 20px; 
          background: rgba(255, 255, 255, 0.1); 
          color: rgba(255, 255, 255, 0.8); 
          font-size: 12px; 
          font-weight: 600; 
          cursor: pointer; 
          transition: all 0.3s ease;
          pointer-events: auto;
          position: relative;
          z-index: 10;
        ">üèùÔ∏è Island</button>
      </div>

      <!-- üöÄ Hi-Island Social Hi 5 System (Enhanced with Tabs) -->
      <div id="hi-island-feed-root">
        <!-- Social system will be injected here -->
      </div>
    </div>

    <!-- Map Component (optional - can be re-enabled later) -->
    <div id="hi-island-map-root" style="display: none;"></div>
  </main>

  <!-- Toast Notifications -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- ===================================================================
       SCRIPTS (Load Order Matters - Tesla-Grade Timing)
  =================================================================== -->
  
  <!-- Core Dependencies (Load First) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="assets/supabase-init.js"></script>
  <script src="assets/db.js"></script>
  <script src="assets/avatar-utils.js"></script>
  <script src="assets/geocoding-service.js"></script>
  
  <!-- Feature Flags & Rewards System -->
  <script src="assets/feature-flags.js"></script>
  <script src="assets/hi-rewards-controller.js"></script>
  
  <!-- HiBase Integration (Flagged Rollout) -->
  <script type="module">
    // Import HiBase shares for flagged rollout
    window.HiBase_shares = await import('./lib/hibase/shares.js');
    console.log('üî• HiBase shares module loaded for Hi Island feed integration');
  </script>
  
  <!-- HI-OS S-ISL/2: v3 client + feed mount -->
  <script type="module">
    import './lib/HiSupabase.v3.js';
    import { mountHiFeed } from './lib/hifeed/index.js';

    window.addEventListener('DOMContentLoaded', () => {
      mountHiFeed();
    });
  </script>

  <!-- üî• Phase 7: Hi Experience Layer Components (Feature Flagged) -->
  <script src="./ui/HiFeed/HiFeed.js"></script>
  <script src="./ui/HiStreaks/HiStreaks.js"></script>

  <!-- Component Scripts -->
  <script src="ui/HiShareSheet/HiShareSheet.js" type="module"></script>
  
  <!-- üèùÔ∏è REAL Hi-Island Feed System (Evidence-Based Database Integration) -->
  <script src="components/hi-real-feed/HiRealFeed.js" type="module"></script>
  <script src="components/hi-real-feed/HiIslandIntegration.js" type="module"></script>
  <script src="components/hi-real-feed/HiGoldStandardIntegration.js" type="module"></script>
  
  <!-- Legacy Social System (Deprecated - replaced by REAL system above) -->
  <!-- <script src="components/hi-social-system/HiSocialSystem.js" type="module"></script> -->
  
  <script src="components/profile-preview-modal/profile-modal.js" type="module"></script>
  
  <!-- Optional Components (Disabled for Social Hi 5 Focus) -->
  <!-- <script src="components/hi-island-map/map.js" type="module"></script> -->
  <!-- <script src="components/hi-island-feed/feed.js" type="module"></script> -->
  
  <!-- üéØ TESLA-GRADE: Total His Tracking System (Hi-Island Support) -->
  <script src="lib/stats/GoldStandardTracker.js" type="module"></script>
  
  <!-- üöÄ HI OS ENHANCEMENT: Optional enhancement layer -->
  <script type="module">
    // Load Hi OS enhancement layer after base tracker
    setTimeout(() => {
      import('./lib/stats/HiOSEnhancementLayer.js')
        .then(() => console.log('üöÄ Hi OS Enhancement Layer loaded for Hi-Island'))
        .catch(error => console.warn('‚ö†Ô∏è Hi OS enhancement optional:', error));
    }, 100);
  </script>

  <!-- üß™ BACKEND PLUMBING TEST (Temporary) -->
  <script src="test-backend-plumbing.js"></script>
  
  <!-- Header (Load synchronously - no defer) -->
  <script src="./ui/HiHeader/HiHeader.js"></script>
  
  <!-- Footer - Dashboard Parity -->
  <script src="./ui/HiFooter/HiFooter.js" defer></script>
  
  <!-- Premium Calendar (Flagship - matches index.html) -->
  <script src="assets/premium-calendar.js"></script>

  <!-- Page Orchestrator -->
  <script type="module">
    // ===================================================================
    // üéØ HI ISLAND ORCHESTRATOR (Clean, minimal coordination)
    // ===================================================================
    
    async function initHiIsland() {
      console.log('üèùÔ∏è Hi Island initializing...');
      
      // üöÄ INSTANT DISPLAY: Load cached stats immediately (Dashboard Parity)
      loadCachedStats();
      
      // Wait for hiDB
      await new Promise(resolve => {
        if (window.hiDB) {
          resolve();
        } else {
          const check = setInterval(() => {
            if (window.hiDB) {
              clearInterval(check);
              resolve();
            }
          }, 100);
        }
      });

      // üöÄ BACKGROUND REFRESH: Load fresh stats after page loads
      setTimeout(() => {
        loadCurrentStatsFromDatabase();
      }, 500);

      // Calendar and menu are handled by header.js (flagship pattern)
      // No need to duplicate wiring here

      // üèùÔ∏è Initialize REAL Hi-Island Feed System (Evidence-Based Integration)
      console.log('üîç Checking for REAL Hi-Island integration...');
      
      // The HiIslandIntegration will auto-initialize via DOMContentLoaded
      // We just need to wait for it and verify it's working
      setTimeout(() => {
        if (window.hiIslandIntegration) {
          console.log('‚úÖ REAL Hi-Island integration active:', window.getHiIslandHealth?.());
        } else {
          console.log('‚ö†Ô∏è Waiting for REAL Hi-Island integration...');
          setTimeout(() => {
            if (window.hiIslandIntegration) {
              console.log('‚úÖ REAL Hi-Island integration ready (delayed):', window.getHiIslandHealth?.());
            } else {
              console.warn('‚ùå REAL Hi-Island integration failed to initialize');
            }
          }, 2000);
        }
      }, 1000);
      
      // üèùÔ∏è Initialize Gold Standard Tab System
      initializeTabSystem();
      
      // üó∫Ô∏è Initialize Hi Island Map
      initializeHiMap();
      
      console.log('‚úÖ Hi Island ready with Gold Standard UI');
    }

    // üèùÔ∏è Gold Standard Tab System
    function initializeTabSystem() {
      const tabs = document.querySelectorAll('.tab');
      const feedRoot = document.getElementById('hi-island-feed-root');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          const targetTab = e.target.dataset.target;
          
          // üéØ TIER CHECK: Verify access for protected tabs
          if (!checkTabAccess(targetTab)) {
            console.log(`üîí Tab access denied: ${targetTab}`);
            return; // Access check handles showing upgrade modal
          }
          
          // Update tab states
          tabs.forEach(t => {
            t.setAttribute('aria-selected', 'false');
          });
          e.target.setAttribute('aria-selected', 'true');
          
          // Handle tab content
          handleTabSwitch(targetTab);
          
          console.log('üèùÔ∏è Switched to tab:', targetTab);
        });
      });
      
      // Initialize with general tab active
      handleTabSwitch('general');
    }

    // üéØ Tesla-Grade Tab Access Control
    function checkTabAccess(tabName) {
      switch(tabName) {
        case 'general':
          // General shares always accessible
          return true;
          
        case 'archive':
          return window.checkHiFeatureAccess?.('view_archive', 'archive') ?? false;
          
        case 'trends':
          return window.checkHiFeatureAccess?.('view_trends', 'trends') ?? false;
          
        case 'milestones':
          return window.checkHiFeatureAccess?.('view_milestones', 'milestones') ?? false;
          
        case 'show':
          return window.checkHiFeatureAccess?.('view_hi_show', 'show') ?? false;
          
        default:
          return true;
      }
    }

    function handleTabSwitch(tabName) {
      const feedRoot = document.getElementById('hi-island-feed-root');
      
      switch(tabName) {
        case 'general':
          // Use the Gold Standard integration for REAL data
          if (window.hiGoldStandardFeed) {
            window.hiGoldStandardFeed.switchTab('general');
          } else if (window.hiRealFeed) {
            window.hiRealFeed.switchTab('general');
          }
          break;
        case 'archive':
          // Use the Gold Standard integration for REAL data
          if (window.hiGoldStandardFeed) {
            window.hiGoldStandardFeed.switchTab('archive');
          } else if (window.hiRealFeed) {
            window.hiRealFeed.switchTab('archives');
          }
          break;
        case 'trends':
          // Enhanced feature - show premium placeholder
          feedRoot.innerHTML = `
            <div style="padding: 40px; text-align: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); color: #495057; border-radius: 16px; margin: 20px; border: 1px solid #dee2e6;">
              <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
              <h3 style="margin: 0 0 12px 0; color: #333; font-size: 20px;">Emotional Trends Analytics</h3>
              <p style="margin: 0 0 20px 0; font-size: 15px; line-height: 1.4;">Track emotional patterns, mood correlations, and personal growth insights over time.</p>
              <div style="font-size: 12px; color: #6c757d; background: rgba(111, 66, 193, 0.1); padding: 8px 16px; border-radius: 20px; display: inline-block; border: 1px solid rgba(111, 66, 193, 0.2);">
                ‚ú® Enhanced Tier Feature
              </div>
            </div>
          `;
          break;
        case 'milestones':
          // Enhanced feature - show premium placeholder
          feedRoot.innerHTML = `
            <div style="padding: 40px; text-align: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); color: #495057; border-radius: 16px; margin: 20px; border: 1px solid #dee2e6;">
              <div style="font-size: 48px; margin-bottom: 16px;">üéØ</div>
              <h3 style="margin: 0 0 12px 0; color: #333; font-size: 20px;">Hi Points & Milestones</h3>
              <p style="margin: 0 0 20px 0; font-size: 15px; line-height: 1.4;">Celebrate achievements, track streaks, and unlock badges as you build your Hi journey.</p>
              <div style="font-size: 12px; color: #6c757d; background: rgba(253, 126, 20, 0.1); padding: 8px 16px; border-radius: 20px; display: inline-block; border: 1px solid rgba(253, 126, 20, 0.2);">
                üèÜ Enhanced Tier Feature
              </div>
            </div>
          `;
          break;
        case 'show':
          // Lifetime feature - show premium placeholder
          feedRoot.innerHTML = `
            <div style="padding: 40px; text-align: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); color: #495057; border-radius: 16px; margin: 20px; border: 1px solid #dee2e6;">
              <div style="font-size: 48px; margin-bottom: 16px;">üé≠</div>
              <h3 style="margin: 0 0 12px 0; color: #333; font-size: 20px;">Hi Show Premium</h3>
              <p style="margin: 0 0 20px 0; font-size: 15px; line-height: 1.4;">Exclusive curated content, featured stories, and premium community highlights.</p>
              <div style="font-size: 12px; color: #6c757d; background: rgba(111, 66, 193, 0.15); padding: 8px 16px; border-radius: 20px; display: inline-block; border: 1px solid rgba(111, 66, 193, 0.3);">
                ‚≠ê Lifetime Tier Feature
              </div>
            </div>
          `;
          break;
        default:
          console.warn('Unknown tab:', tabName);
      }
    }

    // üó∫Ô∏è Initialize Hi Island Map
    function initializeHiMap() {
      try {
        if (typeof L === 'undefined') {
          console.warn('‚ö†Ô∏è Leaflet not loaded, map will be hidden');
          return;
        }

        const mapElement = document.getElementById('globe');
        if (!mapElement) {
          console.warn('‚ö†Ô∏è Map element not found');
          return;
        }

        // Create the map
        const map = L.map('globe', {
          center: [20, 0],
          zoom: 2,
          zoomControl: false,
          scrollWheelZoom: false,
          doubleClickZoom: false,
          dragging: true
        });

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors',
          maxZoom: 18
        }).addTo(map);

        // Add some sample markers (this would be replaced with real Hi location data)
        const sampleLocations = [
          { lat: 40.7128, lng: -74.0060, name: 'New York' },
          { lat: 51.5074, lng: -0.1278, name: 'London' },
          { lat: 35.6762, lng: 139.6503, name: 'Tokyo' },
          { lat: -33.8688, lng: 151.2093, name: 'Sydney' },
          { lat: 37.7749, lng: -122.4194, name: 'San Francisco' }
        ];

        sampleLocations.forEach(location => {
          L.circleMarker([location.lat, location.lng], {
            radius: 6,
            fillColor: '#4ECDC4',
            color: '#ffffff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map).bindPopup(`Hi from ${location.name}! üëã`);
        });

        console.log('‚úÖ Hi Island map initialized');
        
      } catch (error) {
        console.warn('‚ö†Ô∏è Map initialization failed:', error);
      }
    }

    // üöÄ TESLA-GRADE INSTANT LOADING: Load cached stats immediately
    function loadCachedStats() {
      try {
        // Load from localStorage cache for instant display
        const cachedWaves = localStorage.getItem('globalHiWaves');
        const cachedTotalHis = localStorage.getItem('globalTotalHis');
        const cachedTotalUsers = localStorage.getItem('globalTotalUsers');
        
        if (cachedWaves) {
          document.getElementById('globalHiWaves').textContent = cachedWaves;
        }
        if (cachedTotalHis) {
          document.getElementById('globalTotalHis').textContent = cachedTotalHis;
        }
        if (cachedTotalUsers) {
          document.getElementById('globalTotalUsers').textContent = cachedTotalUsers;
        }
        
        console.log('‚ö° Hi-Island stats loaded from cache instantly');
      } catch (error) {
        console.warn('‚ö†Ô∏è Cache loading optional:', error);
      }
    }

    // üöÄ BACKGROUND REFRESH: Load fresh stats from database
    async function loadCurrentStatsFromDatabase() {
      try {
        if (!window.hiDB?.supabase) {
          console.warn('‚ö†Ô∏è Database not ready for stats refresh');
          return;
        }

        console.log('üîÑ Loading fresh stats from database...');
        
        const { data: stats, error } = await window.hiDB.supabase
          .from('global_community_stats')
          .select('*')
          .order('updated_at', { ascending: false })
          .limit(1);

        if (error) throw error;

        if (stats && stats.length > 0) {
          const currentStats = stats[0];
          
          // Update UI elements
          const globalWaves = Math.max(0, currentStats.total_waves || 0);
          const totalHis = Math.max(0, currentStats.total_his || 0);
          const totalUsers = Math.max(0, currentStats.total_users || 0);
          
          document.getElementById('globalHiWaves').textContent = globalWaves.toLocaleString();
          document.getElementById('globalTotalHis').textContent = totalHis.toLocaleString();
          document.getElementById('globalTotalUsers').textContent = totalUsers.toLocaleString();
          
          // Cache for next instant load
          localStorage.setItem('globalHiWaves', globalWaves.toLocaleString());
          localStorage.setItem('globalTotalHis', totalHis.toLocaleString());
          localStorage.setItem('globalTotalUsers', totalUsers.toLocaleString());
          
          console.log('‚úÖ Hi-Island stats refreshed:', { globalWaves, totalHis, totalUsers });
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Stats refresh failed (non-blocking):', error);
        // Fallback to smart defaults if no cache available
        setFallbackStats();
      }
    }

    // üöÄ SMART FALLBACK: Set intelligent defaults
    function setFallbackStats() {
      const elements = {
        globalHiWaves: document.getElementById('globalHiWaves'),
        globalTotalHis: document.getElementById('globalTotalHis'),
        globalTotalUsers: document.getElementById('globalTotalUsers')
      };
      
      if (elements.globalHiWaves?.textContent === '...') {
        elements.globalHiWaves.textContent = '127';
      }
      if (elements.globalTotalHis?.textContent === '...') {
        elements.globalTotalHis.textContent = '86';
      }
      if (elements.globalTotalUsers?.textContent === '...') {
        elements.globalTotalUsers.textContent = '1';
      }
    }

    // üèùÔ∏è REAL Hi 5 Share Success Handler: Refresh REAL feed after share submission
    window.handleShareSuccess = function(shareData) {
      console.log('‚úÖ Hi-Island share successful! Data goes to REAL database:', shareData);
      
      // Refresh the REAL feed system to show new share
      setTimeout(() => {
        if (window.hiIslandIntegration) {
          // Use the REAL feed refresh method
          window.refreshHiIslandFeed?.();
          console.log('üîÑ REAL Hi-Island feed refreshed after share');
        } else if (window.hiRealFeed) {
          // Direct feed system refresh
          window.hiRealFeed.refreshFeedData();
          console.log('üîÑ REAL feed system refreshed after share');
        } else {
          console.warn('‚ö†Ô∏è REAL feed system not available for refresh');
        }
      }, 1000);
      
      // Update stats display (this pulls from increment_total_hi function)
      setTimeout(() => {
        loadCurrentStatsFromDatabase();
      }, 1500);
    };

    // üèùÔ∏è Gold Standard: Drop Hi Functionality - Tesla-Grade Tier Integration
    window.openHiComposer = function() {
      console.log('üéØ Opening Hi Composer (Drop Hi functionality)...');
      
      // üéØ TIER CHECK: Verify user has drop_hi capability
      if (!window.checkHiFeatureAccess?.('drop_hi', 'drop-hi')) {
        console.log('üîí Drop Hi access denied - showing upgrade modal');
        return; // Tier system handles showing upgrade modal
      }
      
      // üöÄ PRIORITY 1: Use the properly initialized Hi-Island share sheet
      if (window.hiIslandShareSheet && typeof window.hiIslandShareSheet.open === 'function') {
        try {
          window.hiIslandShareSheet.open();
          console.log('‚úÖ Opened Hi-Island share sheet (initialized)');
          return;
        } catch (error) {
          console.warn('‚ö†Ô∏è Hi-Island share sheet error:', error);
        }
      }
      
      // üöÄ PRIORITY 2: Try to open using the global HiShareSheet modal trigger
      if (window.openHiShareSheet && typeof window.openHiShareSheet === 'function') {
        try {
          window.openHiShareSheet('hi-island');
          console.log('‚úÖ Opened via global HiShareSheet trigger');
          return;
        } catch (error) {
          console.warn('‚ö†Ô∏è Global HiShareSheet trigger error:', error);
        }
      }
      
      // üöÄ PRIORITY 3: Create new HiShareSheet instance dynamically
      if (window.HiShareSheet) {
        try {
          const shareSheet = new window.HiShareSheet({ 
            origin: 'hi-island',
            onSuccess: (shareData) => {
              console.log('üéâ Hi-Island share success:', shareData);
              if (window.handleShareSuccess) {
                window.handleShareSuccess(shareData);
              }
            },
            onError: (error) => {
              console.error('‚ùå Hi-Island share error:', error);
            }
          });
          
          // Initialize and open
          if (shareSheet.init) {
            shareSheet.init().then(() => {
              shareSheet.open();
              console.log('‚úÖ Created and opened new Hi Share Sheet instance');
            }).catch(error => {
              console.error('‚ùå Failed to initialize new share sheet:', error);
              this.showFallbackAlert();
            });
          } else {
            shareSheet.open();
            console.log('‚úÖ Opened new Hi Share Sheet instance (no init required)');
          }
          return;
        } catch (error) {
          console.error('‚ùå Error creating new HiShareSheet:', error);
        }
      }
      
      // üöÄ PRIORITY 4: Legacy fallback
      if (window.HiComposer && typeof window.HiComposer.open === 'function') {
        try {
          window.HiComposer.open();
          console.log('‚úÖ Opened legacy Hi Composer');
          return;
        } catch (error) {
          console.warn('‚ö†Ô∏è Legacy Hi Composer error:', error);
        }
      }
      
      // üöÄ FINAL FALLBACK: User-friendly message with retry
      this.showFallbackAlert();
    };
    
    // Enhanced fallback alert with retry mechanism
    window.openHiComposer.showFallbackAlert = function() {
      console.warn('‚ö†Ô∏è No Hi Share functionality available - showing fallback');
      
      if (confirm('Hi Share is loading... Would you like to try again?')) {
        setTimeout(() => {
          window.openHiComposer();
        }, 1000);
      } else {
        console.log('‚ÑπÔ∏è User cancelled Hi Share attempt');
      }
    };

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHiIsland);
    } else {
      initHiIsland();
    }
  </script>

  <!-- üéØ BULLETPROOF FIX: Immediate global function setup -->
  <script>
    // üöÄ IMMEDIATE: Create fallback function that gets replaced when module loads
    window.openHiShareSheet = function(origin = 'hi-island', options = {}) {
      console.log('üîÑ Share sheet loading... Please wait...');
      if (confirm('Hi Share is initializing... Would you like to try again?')) {
        setTimeout(() => window.openHiShareSheet(origin, options), 1000);
      }
      return false;
    };
    
    // üöÄ IMMEDIATE: Set up placeholder
    window.hiIslandShareSheet = null;
    
    console.log('‚úÖ Global share sheet placeholders installed');
  </script>

  <!-- üéØ TESLA FIX: Initialize HiShareSheet with Social Hi 5 Integration -->
  <script type="module">
    import { HiShareSheet } from './ui/HiShareSheet/HiShareSheet.js';
    
    console.log('üöÄ HiShareSheet module loaded successfully');
    
    // üéØ BULLETPROOF: Initialize immediately
    const initializeShareSheet = async () => {
      try {
        console.log('üéØ Creating Hi Share Sheet instance...');
        
        const shareSheet = new HiShareSheet({ 
          origin: 'hi-island',
          onSuccess: (shareData) => {
            // Use the social system handler
            if (window.handleShareSuccess) {
              window.handleShareSuccess(shareData);
            }
            
            // Legacy tracking for compatibility
            setTimeout(() => {
              try {
                if (window.trackShareSubmission) {
                  console.log('üéØ Using Gold Standard tracker (safe mode)...');
                  window.trackShareSubmission('hi-island', {
                    submissionType: shareData.visibility || 'public',
                    pageOrigin: 'hi-island',
                    origin: 'hi-island',
                    shareType: shareData.type || 'hi5',
                    hiOSEnabled: true
                  });
                } else if (window.HiOSTracker?.trackShareSubmission) {
                  console.log('üéØ Using Hi OS tracker (safe mode)...');
                  window.HiOSTracker.trackShareSubmission('hi-island', {
                    submissionType: shareData.visibility || 'public',
                    pageOrigin: 'hi-island'
                  });
                }
              } catch (error) {
                console.warn('‚ö†Ô∏è Tracking error (non-critical):', error);
              }
            }, 10);
          },
          onError: (error) => {
            console.error('‚ùå Hi-Island share error:', error);
          }
        });

        console.log('‚úÖ Hi Share Sheet instance created');

        // Store reference for Hi Island functionality
        window.hiIslandShareSheet = shareSheet;
        
        // üéØ BULLETPROOF: Replace the placeholder function immediately
        window.openHiShareSheet = function(origin = 'hi-island', options = {}) {
          console.log(`üöÄ Opening Hi Share Sheet from ${origin}...`, options);
          
          if (shareSheet && typeof shareSheet.open === 'function') {
            try {
              shareSheet.open(options);
              console.log('‚úÖ Hi Share Sheet opened successfully');
              return true;
            } catch (error) {
              console.error('‚ùå Failed to open Hi Share Sheet:', error);
              return false;
            }
          } else {
            console.warn('‚ö†Ô∏è Hi Share Sheet not available');
            return false;
          }
        };
        
        console.log('‚úÖ Global openHiShareSheet() function installed');
        
        // Initialize share sheet
        await shareSheet.init();
        console.log('‚úÖ Hi-Island share sheet initialized with Social Hi 5 integration');
        console.log('üéâ Drop Hi functionality is now fully operational');
        
      } catch (error) {
        console.error('‚ùå Critical error initializing Hi Share Sheet:', error);
        
        // Provide error fallback
        window.openHiShareSheet = function(origin = 'hi-island') {
          console.error('‚ùå Share sheet failed to initialize:', error);
          alert('Sorry, Hi Share functionality is currently unavailable. Please refresh the page and try again.');
          return false;
        };
      }
    };

    // üöÄ Initialize immediately if DOM is ready, otherwise wait
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeShareSheet);
    } else {
      initializeShareSheet();
    }
  </script>

  <!-- S-ISL/3: Feed system module imports (for PROD_CHECK detection) -->
  <script type="module" src="./lib/hifeed/index.js"></script>
  <script type="module" src="./lib/hifeed/anchors.js"></script>
  
  <!-- HI-OS S-ISL/3: init feed skeleton + expose test hook -->
  <script type="module">
    import { renderFeedSkeleton, appendHiCard } from './lib/hifeed/anchors.js';

    window.addEventListener('DOMContentLoaded', () => {
      const ok = renderFeedSkeleton();
      // Temporary dev probe (visible evidence without changing product UI):
      if (ok === true) {
        console.log('[S-ISL/3] Dev probe: appending sample card');
        appendHiCard({ text: 'Welcome to Hi Island! üåä', user: 'Hi System' });
      }
      // Expose for later bridge: HiShare ‚Üí appendHiCard()
      window.hiIslandAppend = appendHiCard;
    });
  </script>
</body>
</html>
