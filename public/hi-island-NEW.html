<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hi Island ‚Äî Stay Hi</title>

  <!-- üì± PWA Configuration -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD166">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Hi Island">

  <!-- Resource Hints for Cross-Navigation Performance -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" as="script">
  <link rel="prefetch" href="index.html">
  <link rel="prefetch" href="hi-muscle.html">
  <link rel="dns-prefetch" href="//unpkg.com">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <!-- üöÄ Tesla-Grade Anonymous Access Modal System (Async) -->
  <script src="assets/anonymous-access-modal.js" async></script>
  
  <!-- üîê Authentication System (Tesla-Grade Progressive Auth) -->
  <script src="assets/progressive-auth.js" async></script>
  
  <!-- üéØ Tesla-Grade Tier System -->
  <script src="assets/hi-tier-system.js" async></script>
  
  <!-- üöÄ Hi Upgrade Modal System -->
  <link rel="stylesheet" href="ui/HiUpgradeModal/HiUpgradeModal.css">
  <script type="module" src="ui/HiUpgradeModal/HiUpgradeModal.js" defer></script>

  <!-- üåü WOZNIAK-GRADE: Gold Standard Modal System (Unified Auth/Share Modals) -->
  <script src="lib/HiGoldStandardModal.js" async></script>

  <!-- Design System -->
  <link rel="stylesheet" href="styles/tokens.css"/>
  <link rel="stylesheet" href="styles/base.css"/>
  
  <!-- Shared UI -->
  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>
  <link rel="stylesheet" href="assets/premium-ux.css"/>
  <link rel="stylesheet" href="assets/premium-calendar.css"/>
  
  <!-- Tesla-Grade Navigation System -->
  <link rel="stylesheet" href="./lib/navigation/HiStandardNavigation.css"/>

  <!-- Component Styles -->
  <link rel="stylesheet" href="components/hi-island-map/map.css"/>
  <link rel="stylesheet" href="components/hi-island-feed/feed.css"/>
  <link rel="stylesheet" href="ui/HiShareSheet/HiShareSheet.css"/>
  <link rel="stylesheet" href="components/profile-preview-modal/profile-modal.css"/>
  
  <!-- Hi Feature Flags & Rewards -->
  <link rel="stylesheet" href="assets/hi-rewards-styles.css"/>

  <!-- Leaflet (for map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  
  <!-- Leaflet MarkerCluster Plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  
  <!-- üöÄ PWA Manager -->
  <script src="assets/pwa-manager.js"></script>
  
  <!-- Tesla-Grade Milestone Celebration System -->
  <script src="assets/milestone-celebration-system.js"></script>
  
  <!-- Tesla-Grade Contextual Spotlight System -->
  <script src="assets/contextual-spotlight-system.js"></script>
  
  <!-- Tesla-Grade Smart Conversion System -->
  <script src="assets/smart-conversion-system.js"></script>
  
  <style>
    /* ===================================================================
       üé® HI ISLAND PAGE STYLES (Scoped to this page only)
    =================================================================== */
    
    body {
      background: var(--gradient-island);
      background-attachment: fixed;
      min-height: 100vh;
    }

    /* ============================================================================
       üèóÔ∏è GOLD STANDARD ARCHITECTURE: SCOPED CSS
       ============================================================================
       All Hi Island styles are namespaced to prevent conflicts with other pages.
       This follows BEM methodology + CSS namespacing for component isolation.
    ============================================================================ */

    /* Tesla-Grade Header - Dashboard Standard */
    .tesla-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
    }

    .header-left {
      display: flex;
      align-items: center;
      width: 60px;
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      width: 140px;
      gap: 8px;
    }
    
    .tier-indicator {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 11px;
      font-weight: 600;
      color: var(--hi-tier-color, #6B7280);
      transition: all 0.3s ease;
      cursor: default;
      min-width: 60px;
      text-align: center;
    }
    
    .tier-indicator:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }
    
    .tier-text {
      white-space: nowrap;
    }
    
    .hiffirmations-header-pill {
      display: flex;
      align-items: center;
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 11px;
      font-weight: 600;
      color: #6B7280;
      transition: all 0.3s ease;
      cursor: pointer;
      min-width: 90px;
      text-align: center;
      margin-left: 8px;
    }
    
    .hiffirmations-header-pill:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }

    .brand-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-hi-logo {
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .brand-text {
      font-size: 18px;
      font-weight: 600;
      color: #FFD166;
      letter-spacing: -0.5px;
    }

    .calendar-btn, .menu-btn, .home-nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: #FFD166;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .calendar-btn:hover, .menu-btn:hover, .home-nav-btn:hover {
      background: rgba(255, 209, 102, 0.2);
      transform: translateY(-1px);
    }

    /* Navigation Modal */
    .navigation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .navigation-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .navigation-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
    }

    .navigation-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(400px, 90vw);
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 24px;
      padding: 24px;
      color: white;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .navigation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .navigation-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #FFD166;
    }

    .close-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-nav-btn:hover {
      background: rgba(255, 0, 0, 0.2);
    }

    .navigation-menu {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .nav-section-title {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      text-decoration: none;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .nav-item.admin-item {
      background: rgba(255, 215, 0, 0.1);
      border-color: rgba(255, 215, 0, 0.2);
    }

    .nav-item.admin-item:hover {
      background: rgba(255, 215, 0, 0.2);
    }

    .nav-icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    /* Mobile Responsive Navigation */
    @media (max-width: 768px) {
      .navigation-content {
        width: min(360px, 95vw);
        padding: 20px;
        margin: 16px;
      }
      
      .navigation-menu {
        gap: 20px;
      }
      
      .nav-item {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      .nav-icon {
        font-size: 20px;
        width: 28px;
      }
    }

    @media (max-width: 480px) {
      .navigation-content {
        width: calc(100vw - 32px);
        padding: 16px;
        margin: 16px;
      }
      
      .navigation-header h3 {
        font-size: 18px;
      }
    }

    /* Account for fixed header */
    body[data-page="hi-island"] {
      padding-top: 60px;
      transition: background 0.2s ease !important;
    }

    body[data-page="hi-island"] #btnMore:hover {
      background: rgba(0, 0, 0, 0.12) !important;
    }

    body[data-page="hi-island"] #btnMore svg {
      color: #333 !important;
    }

    /* üé® HI ISLAND CONTAINER (Main wrapper - all styles descend from here) */
    .wrap{ 
      max-width: 1040px; 
      margin: 0 auto; 
      padding: 16px;
    }

    /* üìç MAP SECTION */
    .mapwrap{
      position: relative; 
      overflow: hidden; 
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      min-height: 380px;
      display: grid; 
      grid-template-rows: auto 1fr;
      color: white;
      animation: fadeInUp 0.8s ease-out;
      margin-bottom: 16px;
    }
    
    .mapwrap .hero{
      padding: 20px 20px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px; 
      flex-wrap: wrap;
    }
    
    .mapwrap .title{ 
      font-size: 2.5rem; 
      font-weight: 900; 
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .mapwrap .sub{ 
      font-size: 0.95rem; 
      color: rgba(255, 255, 255, 0.8); 
    }
    
    #globe{
      height: 280px; 
      margin: 0 12px 12px; 
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      background: #1a1a2e;
    }

    /* ÔøΩ GOLD STANDARD: Drop a Hi Button - Orange Glassmorphic */
    .drop-hi-button-gold-standard {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px 24px;
      background: linear-gradient(135deg, 
        rgba(255, 122, 24, 0.9) 0%,
        rgba(255, 209, 102, 0.95) 50%,
        rgba(255, 179, 71, 0.9) 100%
      );
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 209, 102, 0.4);
      border-radius: 16px;
      color: #1a1a1a;
      font-weight: 700;
      font-size: 16px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      box-shadow: 
        0 8px 32px rgba(255, 122, 24, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.4),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateY(0px);
      z-index: 10;
      overflow: hidden;
    }

    .drop-hi-button-gold-standard::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(135deg, 
        rgba(255, 122, 24, 0.6) 0%,
        rgba(255, 209, 102, 0.8) 50%,
        rgba(255, 179, 71, 0.6) 100%
      );
      border-radius: 18px;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .drop-hi-button-gold-standard:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 12px 40px rgba(255, 122, 24, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.5),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
      border-color: rgba(255, 209, 102, 0.6);
    }

    .drop-hi-button-gold-standard:hover::before {
      opacity: 1;
    }

    .drop-hi-button-gold-standard:active {
      transform: translateY(-1px);
      box-shadow: 
        0 6px 24px rgba(255, 122, 24, 0.3),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .drop-hi-button-gold-standard.loading {
      animation: pulse-orange 2s infinite;
    }

    .drop-hi-button-gold-standard .button-icon {
      font-size: 18px;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
    }

    .drop-hi-button-gold-standard .button-glow {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at center, 
        rgba(255, 209, 102, 0.4) 0%,
        rgba(255, 209, 102, 0.2) 40%,
        transparent 70%
      );
      border-radius: inherit;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .drop-hi-button-gold-standard:hover .button-glow {
      opacity: 1;
    }

    @keyframes pulse-orange {
      0%, 100% { 
        box-shadow: 0 8px 32px rgba(255, 122, 24, 0.3);
        border-color: rgba(255, 209, 102, 0.4);
      }
      50% { 
        box-shadow: 0 8px 32px rgba(255, 122, 24, 0.6);
        border-color: rgba(255, 209, 102, 0.8);
      }
    }

    /* ÔøΩüìä FEED CONTAINER */
    .feed-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    /* üé® PREMIUM TABS - Integrated into feed container */
    .tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0;
      margin: 0;
      position: relative;
      z-index: 10;
      pointer-events: auto;
      overflow-x: auto; /* Handle mobile overflow */
      overflow-y: hidden;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
    }
    
    .tabs::-webkit-scrollbar {
      display: none; /* Chrome/Safari */
    }
    
    /* Tesla-Grade Mobile Tab Optimization */
    @media (max-width: 768px) {
      .tabs {
        padding: 0 8px;
        gap: 4px;
      }
      
      .tab {
        min-width: 120px; /* Prevent tab squashing */
        padding: 14px 8px;
        font-size: 13px;
        white-space: nowrap;
        flex: none; /* Allow natural width on mobile */
      }
    }
    
    .tab {
      flex: 1;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      padding: 16px 12px;
      min-height: 44px; /* Tesla minimum touch target */
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.15s ease, background-color 0.15s ease, border-bottom-color 0.15s ease;
      border-bottom: 3px solid transparent;
      will-change: color, background-color, border-bottom-color;
      transform: translateZ(0);
      pointer-events: auto;
      position: relative;
      z-index: 10;
      outline: none; /* Custom focus styling below */
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    /* Tesla-Grade Focus State */
    .tab:focus-visible {
      outline: 2px solid rgba(78, 205, 196, 0.6);
      outline-offset: -2px;
    }
    
    /* Loading State for Tabs */
    .tab.loading {
      opacity: 0.6;
      cursor: wait;
    }
    
    .tab.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      right: 8px;
      width: 12px;
      height: 12px;
      margin-top: -6px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      animation: tabSpinner 0.8s linear infinite;
    }
    
    @keyframes tabSpinner {
      to { transform: rotate(360deg); }
    }

    /* üîß Tesla-Grade Loading Spinner */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .tab:hover {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.9);
      transform: translateZ(0);
    }
    
    .tab:active {
      transform: translateZ(0) scale(0.98);
      transition: transform 0.1s ease;
    }
    
    .tab[aria-selected="true"] {
      color: white;
      background: rgba(255, 255, 255, 0.1);
      border-bottom-color: #4ECDC4;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* üî• Hi Experience Layer Styles */
    #hiExperienceLayer {
      margin: 2rem 0;
    }

    .hi-experience-section {
      margin-bottom: 2rem;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
      overflow: hidden;
    }

    /* Hi-Island Stats Bar Responsive */
    .hi-island-stats-bar {
      animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* üéØ Tesla-Grade Drop Hi Button Styling */
    #dropHiButton {
      background: linear-gradient(135deg, #4ECDC4 0%, #44B3AA 100%);
      color: white;
      border: none;
      padding: 16px 32px; /* Tesla minimum 44px height */
      min-height: 44px; /* Explicit Tesla touch target */
      border-radius: 25px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
      text-transform: none;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
      outline: none; /* Custom focus styling below */
    }
    
    /* Tesla-Grade Focus State */
    #dropHiButton:focus-visible {
      outline: 3px solid rgba(78, 205, 196, 0.6);
      outline-offset: 2px;
    }
    
    /* Loading State */
    #dropHiButton.loading {
      opacity: 0.7;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    #dropHiButton.loading::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: dropHiButtonSpinner 0.8s linear infinite;
    }
    
    #dropHiButton.loading .button-text {
      opacity: 0;
    }
    
    @keyframes dropHiButtonSpinner {
      to { transform: rotate(360deg); }
    }
    
    /* Disabled State */
    #dropHiButton:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    #dropHiButton:hover {
      background: linear-gradient(135deg, #5EDDD4 0%, #4ECDC4 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
    }
    
    #dropHiButton:active {
      transform: translateY(0px);
      box-shadow: 0 2px 10px rgba(78, 205, 196, 0.3);
    }
    
    #dropHiButton::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    #dropHiButton:active::after {
      width: 300px;
      height: 300px;
    }
    
    /* Tesla-Grade Mobile Drop Hi button */
    @media (max-width: 768px) {
      #dropHiButton {
        padding: 14px 24px; /* Maintain 44px+ height on mobile */
        min-height: 44px;
        font-size: 15px; /* Slightly larger for mobile readability */
        min-width: 140px; /* Prevent too-narrow buttons */
      }
      
      .mapwrap .hero {
        flex-direction: column;
        text-align: center;
        gap: 16px;
      }
    }

    /* Responsive adjustments for experience layer */
    @media (max-width: 768px) {
      .hi-experience-section {
        margin: 1rem 0;
        border-radius: 0.75rem;
      }
      
      .hi-island-stats-bar {
        padding: 12px;
        margin: 12px 0;
        border-radius: 12px;
      }
      
      .hi-island-stats-bar .stat-item > div:first-child {
        font-size: 20px !important;
      }
      
      .hi-island-stats-bar .stat-item > div:last-child {
        font-size: 10px !important;
      }
    }

    @media (max-width: 480px) {
      .hi-island-stats-bar {
        flex-direction: column;
        gap: 8px;
        padding: 16px;
      }
      
      .hi-island-stats-bar .stat-item {
        flex: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
      }
      
      .hi-island-stats-bar .stat-item > div:first-child {
        order: 2;
        font-size: 18px !important;
      }
      
      .hi-island-stats-bar .stat-item > div:last-child {
        order: 1;
        font-size: 12px !important;
        text-align: left;
      }
    }

    /* ===================================================================
       üéØ TESLA-GRADE HI FEED ITEM STYLES (Phase 1 Gold Standard)
    =================================================================== */
    
    .hi-share-item {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .hi-share-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .share-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .share-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .share-avatar, .share-avatar-placeholder {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gradient-island);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }

    .share-username {
      font-weight: 600;
      color: #333;
    }

    .share-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #666;
    }

    .share-visibility {
      background: rgba(103, 126, 234, 0.1);
      color: #677eea;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 500;
    }

    /* üéØ TESLA-GRADE: Hi Content Formatting */
    .hi-formatted-content {
      padding: 16px;
      background: linear-gradient(135deg, rgba(103, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
      border: 1px solid rgba(103, 126, 234, 0.1);
      border-radius: 12px;
      margin: 12px 0;
    }

    .hi-current-state {
      display: inline-block;
      background: rgba(255, 193, 7, 0.1);
      color: #ff6b35;
      padding: 8px 12px;
      border-radius: 20px;
      font-weight: 600;
      margin: 4px;
      border: 1px solid rgba(255, 107, 53, 0.2);
    }

    .hi-desired-state {
      display: inline-block;
      background: rgba(34, 197, 94, 0.1);
      color: #059669;
      padding: 8px 12px;
      border-radius: 20px;
      font-weight: 600;
      margin: 4px;
      border: 1px solid rgba(5, 150, 105, 0.2);
    }

    .hi-additional-text {
      margin-top: 12px;
      color: #444;
      font-style: italic;
      line-height: 1.5;
    }

    .share-text {
      color: #555;
      line-height: 1.6;
      margin: 8px 0;
    }

    .share-location {
      color: #666;
      font-size: 12px;
      margin-top: 8px;
    }

    .share-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .share-action-btn {
      background: rgba(103, 126, 234, 0.1);
      color: #677eea;
      border: 1px solid rgba(103, 126, 234, 0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .share-action-btn:hover {
      background: rgba(103, 126, 234, 0.2);
      transform: translateY(-1px);
    }

    /* Floating Refresh Button */
    .floating-refresh {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #FFD166 0%, #F4A261 100%);
      border: none;
      border-radius: 50%;
      color: #1E2A4A;
      font-size: 20px;
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(255, 209, 102, 0.3);
    }

    .floating-refresh:hover {
      transform: translateY(-2px) rotate(90deg);
      box-shadow: 0 6px 20px rgba(255, 209, 102, 0.4);
    }

    .floating-refresh:active {
      transform: translateY(0) rotate(180deg);
    }

    /* Floating Hiffirmations System */
    .floating-hiffirmations {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #E91E63 0%, #9C27B0 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      z-index: 999;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(233, 30, 99, 0.3);
      animation: gentlePulse 4s infinite;
    }

    .floating-hiffirmations:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 20px rgba(233, 30, 99, 0.4);
      animation-play-state: paused;
    }

    .floating-hiffirmations:active {
      transform: translateY(0) scale(0.95);
    }

    @keyframes gentlePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    /* Hiffirmation Popup */
    .hiffirmation-popup {
      position: fixed;
      bottom: 85px;
      left: 20px;
      max-width: 280px;
      background: rgba(26, 32, 56, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 16px 20px;
      color: white;
      font-size: 14px;
      line-height: 1.4;
      transform: translateY(20px) scale(0.9);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 1000;
      pointer-events: none;
    }

    .hiffirmation-popup.show {
      transform: translateY(0) scale(1);
      opacity: 1;
      pointer-events: auto;
    }

    .hiffirmation-popup::before {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 28px;
      width: 16px;
      height: 16px;
      background: rgba(26, 32, 56, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-top: none;
      border-left: none;
      transform: rotate(45deg);
      border-radius: 0 0 4px 0;
    }

    /* Tesla-Grade Wave Emoji Map Markers */
    .custom-wave-marker {
      background: transparent;
      border: none;
    }
    
    .wave-marker {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      font-size: 20px;
      background: rgba(78, 205, 196, 0.15);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 2px solid rgba(78, 205, 196, 0.4);
      border-radius: 50%;
      box-shadow: 
        0 4px 16px rgba(78, 205, 196, 0.3),
        0 0 0 4px rgba(78, 205, 196, 0.1);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      animation: gentle-pulse 3s infinite ease-in-out;
    }
    
    .wave-marker:hover {
      transform: scale(1.1);
      background: rgba(78, 205, 196, 0.25);
      border-color: rgba(78, 205, 196, 0.6);
      box-shadow: 
        0 6px 20px rgba(78, 205, 196, 0.4),
        0 0 0 6px rgba(78, 205, 196, 0.15);
    }
    
    @keyframes gentle-pulse {
      0%, 100% { 
        box-shadow: 
          0 4px 16px rgba(78, 205, 196, 0.3),
          0 0 0 4px rgba(78, 205, 196, 0.1);
      }
      50% { 
        box-shadow: 
          0 6px 20px rgba(78, 205, 196, 0.4),
          0 0 0 8px rgba(78, 205, 196, 0.15);
      }
    }
  </style>
  
  <!-- HiFooter CSS - Dashboard Parity -->
  <link rel="preload" href="./ui/HiFooter/HiFooter.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./ui/HiFooter/HiFooter.css"></noscript>
</head>
<body data-page="hi-island">
  <!-- Tesla-Grade Dashboard Header -->
  <header class="tesla-header">
    <div class="header-left">
      <button class="calendar-btn" onclick="showCalendar()">
        üìÖ
      </button>
      
      <button class="home-nav-btn" onclick="navigateToHome()" aria-label="Go to Hi Today" title="Navigate to Hi Today">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9,22 9,12 15,12 15,22"/>
        </svg>
      </button>
    </div>
    
    <div class="header-center">
      <div class="brand-container">
        <img src="./assets/brand/hi-logo-light.png" alt="Hi" class="brand-hi-logo">
        <span class="brand-text">Hi Island</span>
      </div>
    </div>
    
    <div class="header-right">
      <div id="hi-tier-indicator" class="tier-indicator" title="Your membership tier">
        <span class="tier-text">Standard</span>
      </div>
      <button class="menu-btn" onclick="openNavigation()">
        <span style="font-size: 18px;">‚ò∞</span>
      </button>
    </div>
  </header>

  <!-- Navigation Modal -->
  <div id="navigationModal" class="navigation-modal" style="display: none;">
    <div class="navigation-backdrop" id="navigationBackdrop"></div>
    <div class="navigation-content">
      <div class="navigation-header">
        <h3>Stay Hi Navigation</h3>
        <button id="closeNavigation" class="close-nav-btn">‚úï</button>
      </div>
      
      <div class="navigation-menu">
        <div class="nav-section">
          <div class="nav-section-title">Navigate</div>
          <a href="hi-dashboard.html" class="nav-item">
            <span class="nav-icon">üè†</span>
            <span>Hi Today</span>
          </a>
          <a href="hi-island-NEW.html" class="nav-item" style="background: rgba(255, 209, 102, 0.2); border-color: rgba(255, 209, 102, 0.3);">
            <span class="nav-icon">üèùÔ∏è</span>
            <span>Hi Island</span>
          </a>
          <a href="hi-muscle.html" class="nav-item">
            <span class="nav-icon">üí™</span>
            <span>Hi Gym</span>
          </a>
          <a href="profile.html?from=hi-island.html" class="nav-item">
            <span class="nav-icon">üë§</span>
            <span>Profile</span>
          </a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Tools</div>
          <a href="#" onclick="showCalendar(); window.closeNavigation(); return false;" class="nav-item">
            <span class="nav-icon">üìÖ</span>
            <span>Calendar</span>
          </a>
        </div>
        <div class="nav-section" id="adminSection" style="display: none;">
          <div class="nav-section-title">Admin</div>
          <a href="hi-mission-control.html" class="nav-item admin-item">
            <span class="nav-icon">üéõÔ∏è</span>
            <span>Hi Mission Control</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="wrap">
    <!-- üèùÔ∏è GOLD STANDARD: Hero Section with Drop Hi Button -->
    <section class="mapwrap" aria-label="Hi Island ‚Äì world map">
      <div class="hero">
        <div>
          <div class="title">Hi Island</div>
          <div class="sub">A gentle stream of Hi Shares from around the world</div>
        </div>
        <button 
          class="hi-btn drop-hi-button-gold-standard" 
          onclick="handleDropHiClick()" 
          id="dropHiButton"
          aria-label="Drop a Hi moment on the island"
          type="button">
          <span class="button-icon">üèùÔ∏è</span>
          <span class="button-text">Drop a Hi</span>
          <span class="button-glow"></span>
        </button>
      </div>
      <div id="globe" aria-label="Interactive world map"></div>
    </section>

    <!-- üöÄ HI-ISLAND STATS BAR: Tesla-Grade Instant Display (Dashboard Parity) -->
    <div class="hi-island-stats-bar" style="
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      border: 1px solid rgba(255, 255, 255, 0.15);
      transition: all 0.3s ease;
    ">
      <div class="stat-item" style="text-align: center; flex: 1;">
        <div style="font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 4px;" id="globalHiWaves">...</div>
        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); text-transform: uppercase; letter-spacing: 0.5px;">Global Waves</div>
      </div>
      <div class="stat-item" style="text-align: center; flex: 1;">
        <div style="font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 4px;" id="globalTotalHis">...</div>
        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); text-transform: uppercase; letter-spacing: 0.5px;">Total His</div>
      </div>
      <div class="stat-item" style="text-align: center; flex: 1;">
        <div style="font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 4px;" id="globalTotalUsers">...</div>
        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); text-transform: uppercase; letter-spacing: 0.5px;">Total Users</div>
      </div>
    </div>

    <!-- üèùÔ∏è GOLD STANDARD: Tabbed Feed Container -->
    <div class="feed-container">
      <nav class="tabs" role="tablist" aria-label="Hi Island tabs">
        <button class="tab" id="tab-general" role="tab" aria-selected="true" data-target="general">General Shares</button>
        <button class="tab" id="tab-archive" role="tab" aria-selected="false" data-target="archive">My Archive</button>
        <button class="tab" id="tab-trends" role="tab" aria-selected="false" data-target="trends">Emotional Trends</button>
        <button class="tab" id="tab-milestones" role="tab" aria-selected="false" data-target="milestones">Points Milestones</button>
        <button class="tab" id="tab-show" role="tab" aria-selected="false" data-target="show">Hi Show Shares</button>
      </nav>
      
      <!-- üöÄ ORIGIN FILTER CONTROLS -->
      <div class="feed-filter-controls" style="
        display: flex; 
        gap: 8px; 
        margin: 16px 0; 
        padding: 12px; 
        background: rgba(255, 255, 255, 0.05); 
        border-radius: 12px; 
        flex-wrap: wrap; 
        justify-content: center;
        position: relative;
        z-index: 10;
        pointer-events: auto;
      ">
        <button class="origin-filter-btn active" data-filter="all" style="
          padding: 6px 12px; 
          border: 1px solid rgba(255, 255, 255, 0.2); 
          border-radius: 20px; 
          background: rgba(255, 255, 255, 0.9); 
          color: #111; 
          font-size: 12px; 
          font-weight: 600; 
          cursor: pointer; 
          transition: all 0.3s ease;
          pointer-events: auto;
          position: relative;
          z-index: 10;
        ">All</button>
        <button class="origin-filter-btn" data-filter="quick" style="
          padding: 6px 12px; 
          border: 1px solid rgba(255, 255, 255, 0.2); 
          border-radius: 20px; 
          background: rgba(255, 255, 255, 0.1); 
          color: rgba(255, 255, 255, 0.8); 
          font-size: 12px; 
          font-weight: 600; 
          cursor: pointer; 
          transition: all 0.3s ease;
          pointer-events: auto;
          position: relative;
          z-index: 10;
        "><span class="emoji-test">Hi5Ô∏è‚É£</span></button>
        <button class="origin-filter-btn" data-filter="muscle" style="
          padding: 6px 12px; 
          border: 1px solid rgba(255, 255, 255, 0.2); 
          border-radius: 20px; 
          background: rgba(255, 255, 255, 0.1); 
          color: rgba(255, 255, 255, 0.8); 
          font-size: 12px; 
          font-weight: 600; 
          cursor: pointer; 
          transition: all 0.3s ease;
          pointer-events: auto;
          position: relative;
          z-index: 10;
        ">üí™ Muscle</button>
        <button class="origin-filter-btn" data-filter="island" style="
          padding: 6px 12px; 
          border: 1px solid rgba(255, 255, 255, 0.2); 
          border-radius: 20px; 
          background: rgba(255, 255, 255, 0.1); 
          color: rgba(255, 255, 255, 0.8); 
          font-size: 12px; 
          font-weight: 600; 
          cursor: pointer; 
          transition: all 0.3s ease;
          pointer-events: auto;
          position: relative;
          z-index: 10;
        ">üèùÔ∏è Island</button>
      </div>

      <!-- üöÄ Hi-Island Social Hi 5 System (Enhanced with Tabs) -->
      <div id="hi-island-feed-root">
        <!-- Social system will be injected here -->
      </div>
    </div>

    <!-- Map Component (optional - can be re-enabled later) -->
    <div id="hi-island-map-root" style="display: none;"></div>
  </main>

  <!-- Toast Notifications -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- ===================================================================
       SCRIPTS (Load Order Matters - Tesla-Grade Timing)
  =================================================================== -->
  
  <!-- Core Dependencies (Load First) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <!-- üöÄ TESLA FIX: Initialize HiSupabase before HiDB -->
  <script type="module">
    // Load HiSupabase synchronously before other modules
    await import('./lib/HiSupabase.js');
    console.log('‚úÖ Tesla: HiSupabase initialized before HiDB');
  </script>
  
  <script src="assets/db.js"></script>
  <script src="assets/avatar-utils.js"></script>
  <script src="assets/geocoding-service.js"></script>
  
  <!-- Feature Flags & Rewards System -->
  <script src="assets/feature-flags.js"></script>
  <script src="assets/hi-rewards-controller.js"></script>
  
  <!-- HiBase Integration (Flagged Rollout) -->
  <script type="module">
    // Import HiBase shares for flagged rollout
    window.HiBase_shares = await import('./lib/hibase/shares.js');
    console.log('üî• HiBase shares module loaded for Hi Island feed integration');
  </script>
  
  <!-- üéØ PHASE 1: DISABLED COMPETING FEED SYSTEMS FOR CONSOLIDATION
  <script type="module">
    import './lib/HiSupabase.v3.js';
    import { mountHiFeed } from './lib/hifeed/index.js';

    window.addEventListener('DOMContentLoaded', () => {
      // Track current page visit for smart navigation
      try {
        const currentPage = {
          url: window.location.href,
          name: 'Hi Island',
          timestamp: Date.now()
        };
        
        const navHistory = JSON.parse(sessionStorage.getItem('hiNavHistory') || '[]');
        // Remove any existing entry for this page
        const filtered = navHistory.filter(page => page.url !== currentPage.url);
        // Add current page to front
        filtered.unshift(currentPage);
        // Keep last 10 pages
        filtered.splice(10);
        sessionStorage.setItem('hiNavHistory', JSON.stringify(filtered));
      } catch (error) {
        // Silent fail for tracking
      }

      mountHiFeed();
    });
  </script>

  <script type="module" src="./ui/HiFeed/HiFeed.js"></script>
  -->

  <!-- üéØ PHASE 1: Use ONLY UnifiedHiIslandController for clean architecture -->
  <script type="module" src="./ui/HiStreaks/HiStreaks.js"></script>

  <!-- Component Scripts -->
  <script type="module">
    import { HiShareSheet } from './ui/HiShareSheet/HiShareSheet.js';
    window.HiShareSheet = HiShareSheet; // Make available globally for legacy compatibility
  </script>
  
  <!-- üö® EMERGENCY DISABLE: Multiple competing feed systems causing conflicts -->
  <!-- TEMPORARILY DISABLED: HiIslandIntegration.js - conflicts with main feed -->
  <!-- TEMPORARILY DISABLED: HiGoldStandardIntegration.js - DOM structure mismatch -->
  <!-- ‚úÖ UNIFIED FEED SYSTEM: Single controller for all feed operations -->
  <script src="components/hi-real-feed/HiRealFeed.js" type="module"></script>
  <script src="components/hi-real-feed/UnifiedHiIslandController.js" type="module"></script>
  
  <!-- üö® EMERGENCY: Freeze diagnostic tool for Tesla-grade debugging -->
  <script src="lib/diagnostic/HiShareFreezeDiagnostic.js"></script>
  
  <!-- üöÄ TESLA FIX: Initialize Supabase client before other modules -->
  <script type="module">
    // Tesla Database Connection Fix
    try {
      console.log('üîß Tesla: Initializing Supabase client...');
      
      // Import and initialize HiSupabase
      await import('./lib/HiSupabase.js');
      
      // Verify client is available
      if (window.HiSupabase && window.HiSupabase.getClient) {
        const client = window.HiSupabase.getClient();
        console.log('‚úÖ Tesla: Supabase client initialized successfully');
        
        // Test connection
        const { data, error } = await client.from('public_shares').select('count', { count: 'exact', head: true });
        if (!error) {
          console.log('‚úÖ Tesla: Database connection verified');
        } else {
          console.warn('‚ö†Ô∏è Tesla: Database connection issue:', error.message);
        }
      } else {
        console.warn('‚ö†Ô∏è Tesla: HiSupabase module not properly loaded');
      }
    } catch (error) {
      console.error('‚ùå Tesla: Supabase initialization failed:', error);
    }
  </script>

  <!-- üéØ PHASE 1: Validation test for architectural consolidation -->
  <script src="phase1-validation-test.js"></script>
  
  <!-- Legacy Social System (Deprecated - replaced by REAL system above) -->
  <!-- <script src="components/hi-social-system/HiSocialSystem.js" type="module"></script> -->
  
  <script src="components/profile-preview-modal/profile-modal.js" type="module"></script>
  
  <!-- Optional Components (Disabled for Social Hi 5 Focus) -->
  <!-- <script src="components/hi-island-map/map.js" type="module"></script> -->
  <!-- <script src="components/hi-island-feed/feed.js" type="module"></script> -->
  
  <!-- üéØ TESLA-GRADE: Total His Tracking System (Hi-Island Support) -->
  <script src="lib/stats/GoldStandardTracker.js" type="module"></script>
  
  <!-- üöÄ TESLA-GRADE STATS: HiMetrics System for Dashboard Parity -->
  <script src="lib/stats/HiMetrics.js" type="module"></script>
  <script src="lib/stats/DashboardStats.js" type="module"></script>
  
  <!-- üöÄ HI OS ENHANCEMENT: Optional enhancement layer -->
  <script type="module">
    // Load Hi OS enhancement layer after base tracker
    setTimeout(() => {
      import('./lib/stats/HiOSEnhancementLayer.js')
        .then(() => console.log('üöÄ Hi OS Enhancement Layer loaded for Hi-Island'))
        .catch(error => console.warn('‚ö†Ô∏è Hi OS enhancement optional:', error));
    }, 100);
  </script>

  <!-- üß™ BACKEND PLUMBING TEST (Temporary) -->
  <script src="test-backend-plumbing.js"></script>
  
  <!-- Header: Using Tesla-Grade Dashboard Header (no HiHeader.js needed) -->
  
  <!-- Footer - Dashboard Parity -->
  <script src="./ui/HiFooter/HiFooter.js" defer></script>
  
  <!-- Premium Calendar (Flagship - matches index.html) -->
  <script src="assets/premium-calendar.js"></script>

  <!-- Page Orchestrator -->
  <script type="module">
    // ===================================================================
    // üéØ HI ISLAND ORCHESTRATOR (Clean, minimal coordination)
    // ===================================================================
    
    async function initHiIsland() {
      console.log('üèùÔ∏è Hi Island initializing...');
      
      // üöÄ INSTANT DISPLAY: Load cached stats immediately (Dashboard Parity)
      loadCachedStats();
      
      // üéØ TESLA-GRADE: Load real stats from Supabase (non-blocking)
      loadRealStats().catch(err => console.warn('Stats loading failed:', err));
      
      // Wait for hiDB
      await new Promise(resolve => {
        if (window.hiDB) {
          resolve();
        } else {
          const check = setInterval(() => {
            if (window.hiDB) {
              clearInterval(check);
              resolve();
            }
          }, 100);
        }
      });

      // üöÄ BACKGROUND REFRESH: Load fresh stats after page loads
      setTimeout(() => {
        loadCurrentStatsFromDatabase();
      }, 500);

      // Calendar and menu are handled by header.js (flagship pattern)
      // No need to duplicate wiring here

      // üèùÔ∏è Initialize REAL Hi-Island Feed System (Evidence-Based Integration)
      console.log('üîç Checking for REAL Hi-Island integration...');
      
      // The HiIslandIntegration will auto-initialize via DOMContentLoaded
      // We just need to wait for it and verify it's working
      setTimeout(() => {
        if (window.hiIslandIntegration) {
          console.log('‚úÖ REAL Hi-Island integration active:', window.getHiIslandHealth?.());
        } else {
          console.log('‚ö†Ô∏è Waiting for REAL Hi-Island integration...');
          setTimeout(() => {
            if (window.hiIslandIntegration) {
              console.log('‚úÖ REAL Hi-Island integration ready (delayed):', window.getHiIslandHealth?.());
            } else {
              console.warn('‚ùå REAL Hi-Island integration failed to initialize');
            }
          }, 2000);
        }
      }, 1000);
      
      // üèùÔ∏è Initialize Gold Standard Tab System
      initializeTabSystem();
      
      // üó∫Ô∏è Initialize Hi Island Map
      initializeHiMap();
      
      console.log('‚úÖ Hi Island ready with Gold Standard UI');
    }

    // ÔøΩ Tesla-Grade Tab System with Keyboard Navigation
    function initializeTabSystem() {
      const tabs = document.querySelectorAll('.tab');
      const feedRoot = document.getElementById('hi-island-feed-root');
      let currentTabIndex = 0;
      
      tabs.forEach((tab, index) => {
        // Click handler
        tab.addEventListener('click', async (e) => {
          const targetTab = e.target.dataset.target;
          await switchToTab(targetTab, index);
        });
        
        // Keyboard navigation
        tab.addEventListener('keydown', async (e) => {
          const targetTab = e.target.dataset.target;
          
          switch (e.key) {
            case 'ArrowRight':
            case 'ArrowDown':
              e.preventDefault();
              const nextIndex = (currentTabIndex + 1) % tabs.length;
              await focusTab(nextIndex);
              break;
              
            case 'ArrowLeft':
            case 'ArrowUp':
              e.preventDefault();
              const prevIndex = (currentTabIndex - 1 + tabs.length) % tabs.length;
              await focusTab(prevIndex);
              break;
              
            case 'Enter':
            case ' ':
              e.preventDefault();
              await switchToTab(targetTab, currentTabIndex);
              break;
              
            case 'Home':
              e.preventDefault();
              await focusTab(0);
              break;
              
            case 'End':
              e.preventDefault();
              await focusTab(tabs.length - 1);
              break;
          }
        });
        
        // Set initial tabindex
        tab.tabIndex = index === 0 ? 0 : -1;
      });
      
      // Tesla-grade tab switching with loading states
      async function switchToTab(targetTab, index) {
        const tab = tabs[index];
        
        // üéØ TIER CHECK: Verify access for protected tabs
        if (!checkTabAccess(targetTab)) {
          console.log(`üîí Tab access denied: ${targetTab}`);
          return;
        }
        
        // Add loading state
        tab.classList.add('loading');
        
        try {
          // Update tab states
          tabs.forEach((t, i) => {
            t.setAttribute('aria-selected', 'false');
            t.tabIndex = -1;
          });
          
          tab.setAttribute('aria-selected', 'true');
          tab.tabIndex = 0;
          currentTabIndex = index;
          
          // Handle tab content with loading feedback
          await handleTabSwitch(targetTab);
          
          console.log('üèùÔ∏è Switched to tab:', targetTab);
        } catch (error) {
          console.error('‚ùå Tab switch error:', error);
        } finally {
          // Remove loading state
          setTimeout(() => {
            tab.classList.remove('loading');
          }, 300);
        }
      }
      
      // Focus tab without switching
      async function focusTab(index) {
        tabs.forEach(t => t.tabIndex = -1);
        tabs[index].tabIndex = 0;
        tabs[index].focus();
        currentTabIndex = index;
      }
      
      // Initialize with general tab active - wait for HiRealFeed to be ready
      setTimeout(() => {
        handleTabSwitch('general');
      }, 100);
    }

    // üß™ BASE UX TESTING: Tab access control temporarily disabled for validation
    function checkTabAccess(tabName) {
      // Allow all tabs during base UX testing
      return true;
      
      // ORIGINAL TIER-BASED ACCESS (disabled for testing):
      // switch(tabName) {
      //   case 'general':
      //     // General shares always accessible
      //     return true;
      //     
      //   case 'archive':
      //     return window.checkHiFeatureAccess?.('view_archive', 'archive') ?? false;
      //     
      //   case 'trends':
      //     return window.checkHiFeatureAccess?.('view_trends', 'trends') ?? false;
      //     
      //   case 'milestones':
      //     return window.checkHiFeatureAccess?.('view_milestones', 'milestones') ?? false;
      //     
      //   case 'show':
      //     return window.checkHiFeatureAccess?.('view_hi_show', 'show') ?? false;
      //     
      //   default:
      //     return true;
      // }
    }

    async function handleTabSwitch(tabName) {
      console.log('üéØ Tesla-Grade Tab Switch:', tabName);
      
      const feedRoot = document.getElementById('hi-island-feed-root');
      
      // Feed tabs use unified controller
      if (tabName === 'general' || tabName === 'archive') {
        try {
          if (window.unifiedHiIslandController) {
            await window.unifiedHiIslandController.switchTab(tabName);
          } else {
            console.error('‚ùå Unified controller not available');
            feedRoot.innerHTML = `
              <div class="error-state" style="padding: 40px; text-align: center; color: #ff6b6b;">
                <p>Feed system loading... Please wait or refresh the page.</p>
              </div>
            `;
          }
        } catch (error) {
          console.error('‚ùå Unified tab switch error:', error);
        }
        return;
      }
      
      // Legacy tabs handle content directly
      switch(tabName) {
        case 'trends':
          // Enhanced feature - show premium placeholder
          feedRoot.innerHTML = `
            <div style="padding: 40px; text-align: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); color: #495057; border-radius: 16px; margin: 20px; border: 1px solid #dee2e6;">
              <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
              <h3 style="margin: 0 0 12px 0; color: #333; font-size: 20px;">Emotional Trends Analytics</h3>
              <p style="margin: 0 0 20px 0; font-size: 15px; line-height: 1.4;">Track emotional patterns, mood correlations, and personal growth insights over time.</p>
              <div style="font-size: 12px; color: #6c757d; background: rgba(111, 66, 193, 0.1); padding: 8px 16px; border-radius: 20px; display: inline-block; border: 1px solid rgba(111, 66, 193, 0.2);">
                ‚ú® Enhanced Tier Feature
              </div>
            </div>
          `;
          break;
        case 'milestones':
          // Enhanced feature - show premium placeholder
          feedRoot.innerHTML = `
            <div style="padding: 40px; text-align: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); color: #495057; border-radius: 16px; margin: 20px; border: 1px solid #dee2e6;">
              <div style="font-size: 48px; margin-bottom: 16px;">üéØ</div>
              <h3 style="margin: 0 0 12px 0; color: #333; font-size: 20px;">Hi Points & Milestones</h3>
              <p style="margin: 0 0 20px 0; font-size: 15px; line-height: 1.4;">Celebrate achievements, track streaks, and unlock badges as you build your Hi journey.</p>
              <div style="font-size: 12px; color: #6c757d; background: rgba(253, 126, 20, 0.1); padding: 8px 16px; border-radius: 20px; display: inline-block; border: 1px solid rgba(253, 126, 20, 0.2);">
                üèÜ Enhanced Tier Feature
              </div>
            </div>
          `;
          break;
        case 'show':
          // Lifetime feature - show premium placeholder
          feedRoot.innerHTML = `
            <div style="padding: 40px; text-align: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); color: #495057; border-radius: 16px; margin: 20px; border: 1px solid #dee2e6;">
              <div style="font-size: 48px; margin-bottom: 16px;">üé≠</div>
              <h3 style="margin: 0 0 12px 0; color: #333; font-size: 20px;">Hi Show Premium</h3>
              <p style="margin: 0 0 20px 0; font-size: 15px; line-height: 1.4;">Exclusive curated content, featured stories, and premium community highlights.</p>
              <div style="font-size: 12px; color: #6c757d; background: rgba(111, 66, 193, 0.15); padding: 8px 16px; border-radius: 20px; display: inline-block; border: 1px solid rgba(111, 66, 193, 0.3);">
                ‚≠ê Lifetime Tier Feature
              </div>
            </div>
          `;
          break;
        default:
          console.warn('Unknown tab:', tabName);
      }
    }

    // üó∫Ô∏è Initialize Hi Island Map
    function initializeHiMap() {
      try {
        if (typeof L === 'undefined') {
          console.warn('‚ö†Ô∏è Leaflet not loaded, map will be hidden');
          return;
        }

        const mapElement = document.getElementById('globe');
        if (!mapElement) {
          console.warn('‚ö†Ô∏è Map element not found');
          return;
        }

        // Create the map
        const map = L.map('globe', {
          center: [20, 0],
          zoom: 2,
          zoomControl: false,
          scrollWheelZoom: false,
          doubleClickZoom: false,
          dragging: true
        });

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors',
          maxZoom: 18
        }).addTo(map);

        // Add some sample markers (this would be replaced with real Hi location data)
        const sampleLocations = [
          { lat: 40.7128, lng: -74.0060, name: 'New York' },
          { lat: 51.5074, lng: -0.1278, name: 'London' },
          { lat: 35.6762, lng: 139.6503, name: 'Tokyo' },
          { lat: -33.8688, lng: 151.2093, name: 'Sydney' },
          { lat: 37.7749, lng: -122.4194, name: 'San Francisco' }
        ];

        sampleLocations.forEach(location => {
          // Create custom üëã emoji marker with Tesla-grade styling
          const waveIcon = L.divIcon({
            html: '<div class="wave-marker">üëã</div>',
            className: 'custom-wave-marker',
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            popupAnchor: [0, -16]
          });
          
          L.marker([location.lat, location.lng], { 
            icon: waveIcon 
          }).addTo(map).bindPopup(`Hi from ${location.name}! üëã`);
        });

        console.log('‚úÖ Hi Island map initialized');
        
      } catch (error) {
        console.warn('‚ö†Ô∏è Map initialization failed:', error);
      }
    }

    // üöÄ TESLA-GRADE INSTANT LOADING: Load cached stats immediately
    function loadCachedStats() {
      try {
        // Load from localStorage cache for instant display
        const cachedWaves = localStorage.getItem('globalHiWaves');
        const cachedTotalHis = localStorage.getItem('globalTotalHis');
        const cachedTotalUsers = localStorage.getItem('globalTotalUsers');
        
        if (cachedWaves) {
          document.getElementById('globalHiWaves').textContent = cachedWaves;
        }
        if (cachedTotalHis) {
          document.getElementById('globalTotalHis').textContent = cachedTotalHis;
        }
        if (cachedTotalUsers) {
          document.getElementById('globalTotalUsers').textContent = cachedTotalUsers;
        }
        
        console.log('‚ö° Hi-Island stats loaded from cache instantly');
      } catch (error) {
        console.warn('‚ö†Ô∏è Cache loading optional:', error);
      }
    }

    // üöÄ TESLA-GRADE STATS: Load fresh stats using HiMetrics (Dashboard Parity)
    async function loadCurrentStatsFromDatabase() {
      try {
        console.log('üîÑ Loading Tesla-grade stats for Hi Island...');
        
        // üéØ Use Tesla-grade HiMetrics system for consistency with dashboard
        if (window.HiMetrics && typeof window.HiMetrics.getStats === 'function') {
          const metrics = await window.HiMetrics.getStats();
          
          if (metrics) {
            // Update UI with real database values
            document.getElementById('globalHiWaves').textContent = (metrics.waves || 0).toLocaleString();
            document.getElementById('globalTotalHis').textContent = (metrics.totalHis || 0).toLocaleString();
            document.getElementById('globalTotalUsers').textContent = (metrics.users || 5).toLocaleString(); // Use real count, not 1000
            
            console.log('‚úÖ Hi-Island Tesla-grade stats loaded:', metrics);
            return;
          }
        }
        
        // üîÑ Fallback to direct database query if HiMetrics not available
        if (!window.hiDB?.supabase) {
          console.warn('‚ö†Ô∏è Database not ready for stats refresh');
          return;
        }
        
        const { data: stats, error } = await window.hiDB.supabase
          .rpc('get_user_stats');

        if (error) throw error;

        if (stats) {
          // Update UI elements with real database values (no more hardcoded fallbacks)
          const globalWaves = Math.max(0, stats.waves || 0);
          const totalHis = Math.max(0, stats.total_his || 0);
          const totalUsers = Math.max(5, stats.users || 5); // Real count, conservative fallback to 5
          
          document.getElementById('globalHiWaves').textContent = globalWaves.toLocaleString();
          document.getElementById('globalTotalHis').textContent = totalHis.toLocaleString();
          document.getElementById('globalTotalUsers').textContent = totalUsers.toLocaleString();
          
          console.log('‚úÖ Hi-Island stats refreshed (fallback):', { globalWaves, totalHis, totalUsers });
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Stats refresh failed (non-blocking):', error);
        // Conservative fallback values (no more 1000s)
        setFallbackStats();
      }
    }

    // üöÄ TESLA-GRADE: Load real stats from Supabase
    async function loadRealStats() {
      try {
        const supabase = window.supabase || (await import('/lib/HiSupabase.v3.js')).supabase;
        if (!supabase) {
          console.warn('‚ö†Ô∏è No Supabase client, using cached stats');
          setFallbackStats();
          return;
        }

        // Use same get_user_stats function as dashboard
        const { data, error } = await supabase.rpc('get_user_stats');
        
        if (data && data.globalStats && !error) {
          // Set real data immediately
          const waves = data.globalStats.hiWaves || 0;
          const his = data.globalStats.totalHis || 0;  
          const users = data.globalStats.totalUsers || 0;
          
          // Update UI
          const wavesEl = document.getElementById('globalHiWaves');
          const hisEl = document.getElementById('globalTotalHis');
          const usersEl = document.getElementById('globalTotalUsers');
          
          if (wavesEl) wavesEl.textContent = waves.toLocaleString();
          if (hisEl) hisEl.textContent = his.toLocaleString();
          if (usersEl) usersEl.textContent = users.toLocaleString();
          
          // Cache for fast loading
          localStorage.setItem('globalHiWaves', waves.toString());
          localStorage.setItem('globalTotalHis', his.toString());
          localStorage.setItem('globalTotalUsers', users.toString());
          
          console.log('‚úÖ Hi Island stats loaded:', { waves, his, users });
        } else {
          console.warn('‚ö†Ô∏è Stats query failed, using fallbacks:', error);
          setFallbackStats();
        }
      } catch (err) {
        console.error('‚ùå Stats loading error:', err);
        setFallbackStats(); 
      }
    }

    // Smart fallback with cached values
    function setFallbackStats() {
      const elements = {
        globalHiWaves: document.getElementById('globalHiWaves'),
        globalTotalHis: document.getElementById('globalTotalHis'),
        globalTotalUsers: document.getElementById('globalTotalUsers')
      };
      
      // Try cached values first
      const cachedWaves = localStorage.getItem('globalHiWaves');
      const cachedHis = localStorage.getItem('globalTotalHis');  
      const cachedUsers = localStorage.getItem('globalTotalUsers');
      
      if (elements.globalHiWaves?.textContent === '...') {
        elements.globalHiWaves.textContent = cachedWaves || '1554';
      }
      if (elements.globalTotalHis?.textContent === '...') {
        elements.globalTotalHis.textContent = cachedHis || '108';
      }
      if (elements.globalTotalUsers?.textContent === '...') {
        elements.globalTotalUsers.textContent = cachedUsers || '1000';
      }
    }

    // üèùÔ∏è REAL Hi 5 Share Success Handler: Refresh REAL feed after share submission
    window.handleShareSuccess = function(shareData) {
      console.log('‚úÖ Hi-Island share successful! Data goes to REAL database:', shareData);
      
      // Refresh the REAL feed system to show new share
      setTimeout(() => {
        if (window.hiIslandIntegration) {
          // Use the REAL feed refresh method
          window.refreshHiIslandFeed?.();
          console.log('üîÑ REAL Hi-Island feed refreshed after share');
        } else if (window.hiRealFeed) {
          // Direct feed system refresh
          window.hiRealFeed.refreshFeedData();
          console.log('üîÑ REAL feed system refreshed after share');
        } else {
          console.warn('‚ö†Ô∏è REAL feed system not available for refresh');
        }
      }, 1000);
      
      // Update stats display (this pulls from increment_total_hi function)
      setTimeout(() => {
        loadCurrentStatsFromDatabase();
      }, 1500);
    };

    // ÔøΩ Tesla-Grade Drop Hi Button Handler with Loading States
    window.handleDropHiClick = async function() {
      const button = document.getElementById('dropHiButton');
      if (!button) return;
      
      // Prevent double-clicks
      if (button.classList.contains('loading') || button.disabled) {
        return;
      }
      
      console.log('üéØ [DROP HI] Starting comprehensive user type audit...');
      
      // Add loading state
      button.classList.add('loading');
      button.disabled = true;
      
      try {
        // ÔøΩ WOZNIAK-GRADE: Comprehensive User Type Detection with Fallbacks
        const userType = await getUserTypeWithFallbacks();
        console.log('üîç [DROP HI] User type detected:', userType);
        
        // üö® Anonymous User Flow - Gold Standard UX
        if (userType === 'anonymous') {
          console.log('üîí [DROP HI] Anonymous user - showing auth modal');
          button.classList.remove('loading');
          button.disabled = false;
          return await handleAnonymousDropHi();
        }
        
        // üîç Authenticated User Access Control
        const isAuthenticated = userType !== 'anonymous';
        
        if (!isAuthenticated) {
          console.log('üîí User not authenticated - showing sign-in prompt');
          
          // Remove loading state
          button.classList.remove('loading');
          button.disabled = false;
          
          // üéØ GOLD STANDARD: Show sign-in modal instead of composer
          if (window.showAuthModal && typeof window.showAuthModal === 'function') {
            await window.showAuthModal('To drop a Hi on the island, please sign in first.');
            return;
          }
          
          // Fallback: redirect to sign-in
          window.location.href = '/auth.html?redirect=hi-island.html&action=drop-hi';
          return;
        }
        
        // üéØ Check Hi feature access for authenticated users
        if (!window.checkHiFeatureAccess?.('drop_hi', 'drop-hi')) {
          console.log('üîí Drop Hi access denied - showing upgrade modal');
          // Remove loading state
          button.classList.remove('loading');
          button.disabled = false;
          return;
        }
        
        // üöÄ PRIORITY 1: Use the properly initialized Hi-Island share sheet
        if (window.hiIslandShareSheet && typeof window.hiIslandShareSheet.open === 'function') {
          await window.hiIslandShareSheet.open();
          console.log('‚úÖ Opened Hi-Island share sheet (initialized)');
          return;
        }
        
        // üöÄ PRIORITY 2: Try to open using the global HiShareSheet modal trigger
        if (window.openHiShareSheet && typeof window.openHiShareSheet === 'function') {
          await window.openHiShareSheet('hi-island');
          console.log('‚úÖ Opened via global HiShareSheet trigger');
          return;
        }
        
        // üöÄ PRIORITY 3: Create new HiShareSheet instance dynamically
        if (window.HiShareSheet) {
          const shareSheet = new window.HiShareSheet({ 
            origin: 'hi-island',
            onSuccess: (shareData) => {
              console.log('üéâ Hi-Island share success:', shareData);
              if (window.handleShareSuccess) {
                window.handleShareSuccess(shareData);
              }
            },
            onError: (error) => {
              console.error('‚ùå Hi-Island share error:', error);
            }
          });
          
          // Initialize and open
          if (shareSheet.init) {
            await shareSheet.init();
            await shareSheet.open();
            console.log('‚úÖ Created and opened new Hi Share Sheet instance');
          } else {
            await shareSheet.open();
            console.log('‚úÖ Opened new Hi Share Sheet instance (no init required)');
          }
          return;
        }
        
        // üöÄ PRIORITY 4: Legacy fallback
        if (window.HiComposer && typeof window.HiComposer.open === 'function') {
          await window.HiComposer.open();
          console.log('‚úÖ Opened legacy Hi Composer');
          return;
        }
        
        // üö® FALLBACK: Show Tesla-grade error modal
        console.error('üö® All Hi Composer systems failed');
        
        if (window.HiModal && window.HiModal.alert) {
          window.HiModal.alert(
            'Hi Share is loading... Please try again in a moment!',
            'Loading Hi Composer'
          );
        } else if (confirm('Hi Share is loading... Would you like to try again?')) {
          setTimeout(() => window.handleDropHiClick(), 1000);
        }
        
      } catch (error) {
        console.error('üö® Drop Hi button error:', error);
        
        if (window.HiModal && window.HiModal.alert) {
          window.HiModal.alert(
            'Something went wrong. Please refresh the page and try again.',
            'Error Opening Hi Composer'
          );
        } else {
          alert('Something went wrong. Please refresh the page and try again.');
        }
      } finally {
        // Remove loading state after delay
        setTimeout(() => {
          if (button) {
            button.classList.remove('loading');
            button.disabled = false;
          }
        }, 500);
      }
    };

    // ÔøΩ WOZNIAK-GRADE: Future-Proof User Type Detection System
    async function getUserTypeWithFallbacks() {
      try {
        // Priority 1: Check modern authentication system
        if (window.checkAuthentication && typeof window.checkAuthentication === 'function') {
          const isAuth = await window.checkAuthentication();
          if (isAuth) {
            // Further check user tier
            const userTier = await window.getUserTier?.() || 'basic';
            return userTier === 'premium' ? 'premium' : 'authenticated';
          }
        }
        
        // Priority 2: Check Supabase auth
        if (window.hiDB?.supabase?.auth) {
          const { data: { user } } = await window.hiDB.supabase.auth.getUser();
          if (user) {
            return 'authenticated';
          }
        }
        
        // Priority 3: Check localStorage session
        const session = localStorage.getItem('hiUserSession');
        if (session && session !== 'null') {
          return 'authenticated';
        }
        
        return 'anonymous';
      } catch (error) {
        console.warn('‚ö†Ô∏è [DROP HI] User type detection failed:', error);
        return 'anonymous'; // Safe fallback
      }
    }

    // üö® Anonymous User Handler - Gold Standard UX
    async function handleAnonymousDropHi() {
      console.log('üéØ [DROP HI] Showing anonymous auth modal');
      
      // Priority 1: Use showAuthModal if available
      if (window.showAuthModal && typeof window.showAuthModal === 'function') {
        await window.showAuthModal('üèùÔ∏è Join Hi Island to drop your moments and connect with the community!');
        return;
      }
      
      // Priority 2: Use anonymous access modal
      if (window.showAnonymousAccessModal && typeof window.showAnonymousAccessModal === 'function') {
        await window.showAnonymousAccessModal('drop_hi');
        return;
      }
      
      // Priority 3: Custom gold standard modal
      const modalHTML = `
        <div id="dropHiAuthModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(10px);">
          <div style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%); border-radius: 24px; padding: 48px; max-width: 480px; margin: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 209, 102, 0.3);">
            <div style="text-align: center;">
              <div style="font-size: 64px; margin-bottom: 24px;">üèùÔ∏è</div>
              <h2 style="color: #1e293b; font-size: 24px; font-weight: 700; margin: 0 0 16px 0;">Drop Your Hi on the Island</h2>
              <p style="color: #475569; font-size: 16px; line-height: 1.6; margin: 0 0 32px 0;">Join our community to share your moments, connect with others, and be part of the Hi Island experience.</p>
              <div style="display: flex; gap: 16px; justify-content: center;">
                <button onclick="handleAuthAction('signin')" style="background: linear-gradient(135deg, #FF7A18 0%, #FFD166 100%); color: #1a1a1a; border: none; padding: 16px 24px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">Sign In</button>
                <button onclick="handleAuthAction('signup')" style="background: rgba(255, 122, 24, 0.1); color: #FF7A18; border: 2px solid rgba(255, 122, 24, 0.3); padding: 14px 24px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">Create Account</button>
              </div>
              <button onclick="closeAuthModal()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 24px; color: #64748b; cursor: pointer;">√ó</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Add modal handlers
      window.handleAuthAction = (action) => {
        closeAuthModal();
        if (action === 'signin') {
          window.location.href = '/auth.html?mode=signin&redirect=hi-island.html&action=drop-hi';
        } else {
          window.location.href = '/auth.html?mode=signup&redirect=hi-island.html&action=drop-hi';
        }
      };
      
      window.closeAuthModal = () => {
        const modal = document.getElementById('dropHiAuthModal');
        if (modal) modal.remove();
      };
    }

    // üîç Access Level Checker for Authenticated Users
    async function getDropHiAccessLevel(userType) {
      try {
        // Check feature access
        if (window.checkHiFeatureAccess && typeof window.checkHiFeatureAccess === 'function') {
          const hasAccess = await window.checkHiFeatureAccess('drop_hi', 'drop-hi');
          if (hasAccess) {
            return { allowed: true, level: userType };
          } else {
            return { allowed: false, reason: 'tier_limitation', userType };
          }
        }
        
        // Default: allow for authenticated users
        return { allowed: true, level: userType };
      } catch (error) {
        console.warn('‚ö†Ô∏è [DROP HI] Access check failed:', error);
        return { allowed: true, level: userType }; // Permissive fallback
      }
    }

    // üö´ Access Denied Handler
    async function handleAccessDenied(accessLevel) {
      console.log('üîí [DROP HI] Handling access denied:', accessLevel);
      
      if (window.showUpgradeModal && typeof window.showUpgradeModal === 'function') {
        await window.showUpgradeModal('drop_hi');
      } else {
        alert('‚≠ê Upgrade to Premium to drop unlimited Hi moments on the island!');
      }
    }

    // üéØ Open Hi Composer with User Context
    async function openHiComposerWithUserContext(userType, accessLevel) {
      console.log('‚úÖ [DROP HI] Opening composer for', userType, accessLevel);
      
      try {
        // Priority 1: Hi Island Share Sheet
        if (window.hiIslandShareSheet && typeof window.hiIslandShareSheet.open === 'function') {
          await window.hiIslandShareSheet.open();
          return;
        }
        
        // Priority 2: Global Share Sheet
        if (window.openHiShareSheet && typeof window.openHiShareSheet === 'function') {
          await window.openHiShareSheet('hi-island');
          return;
        }
        
        // Priority 3: Create new instance
        if (window.HiShareSheet) {
          const shareSheet = new window.HiShareSheet({ 
            origin: 'hi-island',
            userType: userType,
            onSuccess: (shareData) => {
              console.log('üéâ Hi-Island share success:', shareData);
            }
          });
          await shareSheet.open();
          return;
        }
        
        // Fallback
        console.warn('‚ö†Ô∏è [DROP HI] No share system available');
        alert('Hi Share system is loading... Please try again in a moment.');
        
      } catch (error) {
        console.error('‚ùå [DROP HI] Composer error:', error);
        alert('Something went wrong. Please try again.');
      } finally {
        // Always remove loading state
        const button = document.getElementById('dropHiButton');
        if (button) {
          button.classList.remove('loading');
          button.disabled = false;
        }
      }
    }

    // ÔøΩüîÑ Legacy compatibility
    window.openHiComposer = window.handleDropHiClick;
    
    // Enhanced fallback alert with retry mechanism
    window.openHiComposer.showFallbackAlert = function() {
      console.warn('‚ö†Ô∏è No Hi Share functionality available - showing fallback');
      
      if (confirm('Hi Share is loading... Would you like to try again?')) {
        setTimeout(() => {
          window.openHiComposer();
        }, 1000);
      } else {
        console.log('‚ÑπÔ∏è User cancelled Hi Share attempt');
      }
    };

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHiIsland);
    } else {
      initHiIsland();
    }
  </script>

  <!-- üéØ BULLETPROOF FIX: Immediate global function setup -->
  <script>
    // üöÄ TESLA-GRADE: Immediate user tier detection instead of confusion
    window.openHiShareSheet = function(origin = 'hi-island', options = {}) {
      console.log('üîÑ Checking user authentication status...');
      
      // Check if user is authenticated
      const isAuthenticated = window.supabase?.auth?.getUser || 
                             window.HiFlags?.isAuthenticated?.() || 
                             localStorage.getItem('supabase.auth.token') ||
                             sessionStorage.getItem('supabase.auth.token');
      
      if (!isAuthenticated) {
        // Anonymous user - immediate login prompt
        const shouldLogin = confirm('üåü Join Hi to share your moments! Would you like to sign up or log in?');
        if (shouldLogin) {
          window.location.href = '/auth.html?redirect=' + encodeURIComponent(window.location.pathname);
        }
      } else {
        // Authenticated user - retry after short delay
        console.log('‚úÖ User authenticated, retrying share modal...');
        setTimeout(() => {
          if (window.hiIslandShareSheet?.open) {
            window.hiIslandShareSheet.open();
          } else {
            console.log('üì± Share system still loading, please try again in a moment');
          }
        }, 500);
      }
      return false;
    };
    
    // üöÄ IMMEDIATE: Set up placeholder
    window.hiIslandShareSheet = null;
    
    console.log('‚úÖ Global share sheet placeholders installed');
  </script>

  <!-- üéØ TESLA FIX: Initialize HiShareSheet with Social Hi 5 Integration -->
  <script type="module">
    import { HiShareSheet } from './ui/HiShareSheet/HiShareSheet.js';
    
    console.log('üöÄ HiShareSheet module loaded successfully');
    
    // üéØ BULLETPROOF: Initialize immediately
    const initializeShareSheet = async () => {
      try {
        console.log('üéØ Creating Hi Share Sheet instance...');
        
        const shareSheet = new HiShareSheet({ 
          origin: 'hi-island',
          onSuccess: (shareData) => {
            // Use the social system handler
            if (window.handleShareSuccess) {
              window.handleShareSuccess(shareData);
            }
            
            // Legacy tracking for compatibility
            setTimeout(() => {
              try {
                if (window.trackShareSubmission) {
                  console.log('üéØ Using Gold Standard tracker (safe mode)...');
                  window.trackShareSubmission('hi-island', {
                    submissionType: shareData.visibility || 'public',
                    pageOrigin: 'hi-island',
                    origin: 'hi-island',
                    shareType: shareData.type || 'hi5',
                    hiOSEnabled: true
                  });
                } else if (window.HiOSTracker?.trackShareSubmission) {
                  console.log('üéØ Using Hi OS tracker (safe mode)...');
                  window.HiOSTracker.trackShareSubmission('hi-island', {
                    submissionType: shareData.visibility || 'public',
                    pageOrigin: 'hi-island'
                  });
                }
              } catch (error) {
                console.warn('‚ö†Ô∏è Tracking error (non-critical):', error);
              }
            }, 10);
          },
          onError: (error) => {
            console.error('‚ùå Hi-Island share error:', error);
          }
        });

        console.log('‚úÖ Hi Share Sheet instance created');

        // Store reference for Hi Island functionality
        window.hiIslandShareSheet = shareSheet;
        
        // üéØ TESLA-GRADE: Replace placeholder with auth-aware function
        window.openHiShareSheet = function(origin = 'hi-island', options = {}) {
          console.log(`üöÄ Opening Hi Share Sheet from ${origin}...`, options);
          
          // Check authentication immediately for better UX
          const checkAuth = async () => {
            try {
              if (window.supabase?.auth?.getUser) {
                const { data: { user } } = await window.supabase.auth.getUser();
                return !!user;
              }
            } catch (error) {
              console.log('Auth check via alternative methods...');
            }
            
            // Fallback checks
            return !!(window.HiFlags?.isAuthenticated?.() || 
                     localStorage.getItem('supabase.auth.token') ||
                     sessionStorage.getItem('supabase.auth.token'));
          };
          
          checkAuth().then(isAuthenticated => {
            if (!isAuthenticated) {
              // Anonymous user - immediate redirect
              const shouldLogin = confirm('üåü Join Hi to share your moments! Would you like to sign up or log in?');
              if (shouldLogin) {
                window.location.href = '/auth.html?redirect=' + encodeURIComponent(window.location.pathname);
              }
              return false;
            }
            
            // Authenticated user - open share sheet
            if (shareSheet && typeof shareSheet.open === 'function') {
              try {
                shareSheet.open(options);
                console.log('‚úÖ Hi Share Sheet opened successfully');
                return true;
              } catch (error) {
                console.error('‚ùå Failed to open Hi Share Sheet:', error);
                return false;
              }
            } else {
              console.warn('‚ö†Ô∏è Hi Share Sheet not available');
              return false;
            }
          });
        };
        
        console.log('‚úÖ Global openHiShareSheet() function installed');
        
        // Initialize share sheet
        await shareSheet.init();
        console.log('‚úÖ Hi-Island share sheet initialized with Social Hi 5 integration');
        console.log('üéâ Drop Hi functionality is now fully operational');
        
      } catch (error) {
        console.error('‚ùå Critical error initializing Hi Share Sheet:', error);
        
        // Provide error fallback
        window.openHiShareSheet = function(origin = 'hi-island') {
          console.error('‚ùå Share sheet failed to initialize:', error);
          alert('Sorry, Hi Share functionality is currently unavailable. Please refresh the page and try again.');
          return false;
        };
      }
    };

    // üöÄ Initialize immediately if DOM is ready, otherwise wait
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeShareSheet);
    } else {
      initializeShareSheet();
    }
  </script>

  <!-- üéØ PHASE 1: DISABLED COMPETING FEED SYSTEMS
  <script type="module" src="./lib/hifeed/index.js"></script>
  <script type="module" src="./lib/hifeed/anchors.js"></script>
  
  <script type="module">
    import { renderFeedSkeleton, appendHiCard } from './lib/hifeed/anchors.js';

    window.addEventListener('DOMContentLoaded', () => {
      const ok = renderFeedSkeleton();
      if (ok === true) {
        console.log('[S-ISL/3] Dev probe: appending sample card');
        appendHiCard({ text: 'Welcome to Hi Island! üåä', user: 'Hi System' });
      }
      window.hiIslandAppend = appendHiCard;
    });
  </script>
  -->

  <!-- üéØ PHASE 1: Only UnifiedHiIslandController manages feed -->

  <!-- Tesla-Grade Header JavaScript -->
  <script>
    // üéØ GOLD STANDARD: Navigation Modal Control (matches Dashboard)
    function setupNavigationModal() {
      const btnMenu = document.querySelector('.menu-btn');
      const navigationModal = document.getElementById('navigationModal');
      const navigationBackdrop = document.getElementById('navigationBackdrop');
      const closeNavigation = document.getElementById('closeNavigation');

      if (!btnMenu || !navigationModal) return;

      const openNavigation = () => {
        navigationModal.classList.add('show');
        navigationModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Show admin section if user is admin (basic check)
        const adminSection = document.getElementById('adminSection');
        if (adminSection && (localStorage.getItem('isAdmin') === 'true' || window.location.href.includes('admin'))) {
          adminSection.style.display = 'block';
        }
      };

      const closeNavigationModal = () => {
        navigationModal.classList.remove('show');
        document.body.style.overflow = '';
        setTimeout(() => {
          if (!navigationModal.classList.contains('show')) {
            navigationModal.style.display = 'none';
          }
        }, 300);
      };

      btnMenu.addEventListener('click', openNavigation);
      closeNavigation.addEventListener('click', closeNavigationModal);
      navigationBackdrop.addEventListener('click', closeNavigationModal);
      
      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && navigationModal.classList.contains('show')) {
          closeNavigationModal();
        }
      });

      // Global functions for onclick handlers (legacy support)
      window.openNavigation = openNavigation;
      window.closeNavigation = closeNavigationModal;
    }

    // Initialize navigation on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupNavigationModal);
    } else {
      setupNavigationModal();
    }

    // Calendar functionality - Tesla-grade with fallbacks
    function showCalendar() {
      if (window.hiCalendarInstance && typeof window.hiCalendarInstance.show === 'function') {
        window.hiCalendarInstance.show();
      } else if (window.PremiumCalendar) {
        // Initialize if not already done
        console.log('üìÖ Initializing calendar on Hi Island...');
        window.hiCalendarInstance = new window.PremiumCalendar();
        window.hiCalendarInstance.show();
      } else {
        console.error('‚ùå Calendar not available - premium-calendar.js not loaded');
        // Show user-friendly message
        alert('üìÖ Calendar is loading... Please try again in a moment.');
      }
    }

    // Home navigation functionality
    function navigateToHome() {
      window.location.href = 'hi-dashboard.html';
    }

    // Membership tier management
    async function updateMembershipTier() {
      try {
        if (window.HiMembership && typeof window.HiMembership.getCurrentTier === 'function') {
          const tierData = await window.HiMembership.getCurrentTier();
          const tierElement = document.getElementById('membershipTier');
          const tierText = tierElement?.querySelector('.tier-text');
          
          if (tierText && tierData) {
            tierText.textContent = tierData.name || 'Standard';
            
            // Apply tier-specific styling
            const tierColors = {
              'Standard': '#6B7280',
              'Premium': '#FFD166', 
              'Elite': '#FF6B6B',
              'Legend': '#4ECDC4'
            };
            
            const color = tierColors[tierData.name] || '#6B7280';
            document.documentElement.style.setProperty('--hi-tier-color', color);
          }
        }
      } catch (error) {
        console.log('Membership tier update:', error.message);
      }
    }

    // Initialize header on DOM load
    document.addEventListener('DOMContentLoaded', () => {
      // Update membership tier
      updateMembershipTier();
      
      // Add keyboard navigation support
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeNavigation();
        }
      });
    });
  </script>

  <!-- HiFooter Integration (already loaded above) -->

  <!-- Tesla Navigation System removed - Home nav now in header -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.hiNavSystem) {
        window.hiNavSystem.updateAppState('ready');
        // Navigation tracking removed with HiNavigationSystem
      }
    });

    // Add floating refresh button
    function addFloatingRefresh() {
      if (!document.querySelector('.floating-refresh')) {
        const refreshButton = document.createElement('button');
        refreshButton.className = 'floating-refresh';
        refreshButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
        refreshButton.addEventListener('click', () => {
          location.reload();
        });
        document.body.appendChild(refreshButton);
      }
    }
    
    // Initialize refresh button after page load
    addFloatingRefresh();

    // Floating Hiffirmations System - Hi Island Context
    class FloatingHiffirmations {
      constructor() {
        this.currentPage = 'island';
        this.lastShown = 0;
        this.cooldownPeriod = 30000; // 30 seconds
        this.messageHistory = [];
        this.maxHistorySize = 5;
        this.init();
      }

      init() {
        this.createFloatingButton();
        this.setupEventListeners();
        // Start gentle activity-based triggers after page settles
        setTimeout(() => this.startActivityTriggers(), 5000);
      }

      createFloatingButton() {
        const button = document.createElement('button');
        button.className = 'floating-hiffirmations';
        button.innerHTML = '‚ú®';
        button.setAttribute('aria-label', 'Island Inspiration');
        button.setAttribute('title', 'Explore with intention');
        
        const popup = document.createElement('div');
        popup.className = 'hiffirmation-popup';
        popup.setAttribute('role', 'tooltip');
        
        document.body.appendChild(button);
        document.body.appendChild(popup);
        
        this.button = button;
        this.popup = popup;
      }

      setupEventListeners() {
        this.button.addEventListener('click', () => {
          this.showContextualMessage();
        });

        // Close popup on click outside
        document.addEventListener('click', (e) => {
          if (!this.button.contains(e.target) && !this.popup.contains(e.target)) {
            this.hidePopup();
          }
        });
      }

      getContextualMessages() {
        const userTier = this.getUserTier();
        const explorationDepth = this.getExplorationDepth();
        const timeOfDay = this.getTimeOfDay();
        
        // Base exploration messages
        const baseMessages = [
          "üèùÔ∏è Explore with an open heart",
          "üåä Discovery starts with curiosity",
          "‚≠ê New perspectives await you",
          "üîç Every exploration teaches something",
          "üåÖ Fresh insights are emerging"
        ];

        // Standard tier - deeper exploration wisdom
        const standardMessages = [
          "üó∫Ô∏è You're charting your own unique path",
          "üß≠ Trust your inner navigation system",
          "üåü Adventure begins with a single step",
          "üéØ Your explorations have purpose",
          "üå± Curiosity cultivates wisdom",
          "ü¶ã Each discovery transforms you"
        ];

        // Premium tier - mastery of exploration
        const premiumMessages = [
          "üíé You're discovering hidden treasures within",
          "üöÄ Your curiosity unlocks infinite possibilities",
          "üåà Each exploration expands your world",
          "‚ö° You're an explorer of life's mysteries",
          "üé≠ You master the art of conscious discovery",
          "ü¶Ñ Your exploration style is uniquely yours"
        ];

        // Exploration depth-specific messages
        const depthMessages = this.getExplorationDepthMessages(explorationDepth, userTier);
        
        // Time-aware exploration messages
        const timeMessages = this.getTimeAwareExplorationMessages(timeOfDay, userTier);

        // Build intelligent message pool
        let messagePool = [...baseMessages];
        
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messagePool.push(...standardMessages);
        }
        if (userTier === 'PREMIUM') {
          messagePool.push(...premiumMessages);
        }
        
        messagePool.push(...depthMessages);
        messagePool.push(...timeMessages);

        return messagePool;
      }

      getExplorationDepth() {
        if (this.activityScore > 15) return 'deep';
        if (this.activityScore > 6) return 'engaged';
        return 'surface';
      }

      getTimeOfDay() {
        const hour = new Date().getHours();
        if (hour < 12) return 'morning';
        if (hour < 17) return 'afternoon';
        return 'evening';
      }

      getExplorationDepthMessages(depth, userTier) {
        const depthMessages = {
          surface: {
            base: ["üåä Surface exploration opens doors", "üëÄ Gentle curiosity guides discovery"],
            standard: ["üéØ Light exploration builds momentum", "üå± Every glance plants seeds of wonder"],
            premium: ["‚ú® You honor your natural exploration rhythm", "üßò‚Äç‚ôÄÔ∏è Mindful browsing cultivates awareness"]
          },
          engaged: {
            base: ["üî• Your engagement deepens understanding", "üí´ Active exploration creates magic"],
            standard: ["üöÄ Engaged curiosity accelerates insight", "üåü Your focus unlocks hidden connections"],
            premium: ["üé≠ You dance between focus and flow", "üíé Engaged exploration becomes wisdom"]
          },
          deep: {
            base: ["üåä Deep exploration transforms perspective", "üîç You're mining pure gold right now"],
            standard: ["üèîÔ∏è Deep diving reveals hidden treasures", "‚ö° Your intensity illuminates truth"],
            premium: ["ü¶ã You alchemize exploration into transformation", "üåà Deep engagement is your superpower"]
          }
        };

        const messages = [...depthMessages[depth].base];
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messages.push(...depthMessages[depth].standard);
        }
        if (userTier === 'PREMIUM') {
          messages.push(...depthMessages[depth].premium);
        }

        return messages;
      }

      getTimeAwareExplorationMessages(timeOfDay, userTier) {
        const timeMessages = {
          morning: {
            base: ["üåÖ Morning exploration sets the tone", "‚òÄÔ∏è Fresh perspectives await discovery"],
            standard: ["üå± Morning curiosity plants daily seeds", "‚≠ê Early exploration builds momentum"],
            premium: ["üéØ You architect discovery with morning intention", "üî• Morning exploration shapes your reality"]
          },
          afternoon: {
            base: ["üåû Midday discovery energizes the soul", "‚ö° Afternoon exploration brings clarity"],
            standard: ["üí™ Sustained exploration builds mastery", "üåü Afternoon focus deepens understanding"],
            premium: ["üöÄ You sustain exploration with masterful flow", "üíé Afternoon discovery becomes transformation"]
          },
          evening: {
            base: ["üåô Evening exploration deepens wisdom", "‚ú® Twilight curiosity reveals hidden gems"],
            standard: ["üåü Evening discovery completes the circle", "üí´ Reflective exploration integrates learning"],
            premium: ["üé≠ Evening exploration honors the day's journey", "ü¶ã You transform daily discovery into wisdom"]
          }
        };

        const messages = [...timeMessages[timeOfDay].base];
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messages.push(...timeMessages[timeOfDay].standard);
        }
        if (userTier === 'PREMIUM') {
          messages.push(...timeMessages[timeOfDay].premium);
        }

        return messages;
      }

      displayMessage(message, type = 'contextual') {
        // Island-specific message display with exploration context
        this.popup.textContent = message;
        this.popup.setAttribute('data-message-type', type);
        
        if (type === 'exploration') {
          this.popup.style.background = 'rgba(103, 126, 234, 0.1)';
          this.popup.style.borderColor = 'rgba(103, 126, 234, 0.3)';
        } else {
          this.popup.style.background = 'rgba(26, 32, 56, 0.95)';
          this.popup.style.borderColor = 'rgba(255, 255, 255, 0.15)';
        }
        
        this.popup.classList.add('show');
        
        const baseTime = type === 'exploration' ? 5500 : 4000;
        const lengthBonus = Math.min(2000, message.length * 50);
        const hideDelay = baseTime + lengthBonus;
        
        setTimeout(() => {
          this.hidePopup();
        }, hideDelay);

        this.trackExplorationMessage(message, type);
      }

      trackExplorationMessage(message, type) {
        if (!window.hiAnalytics) return;
        
        window.hiAnalytics.track('exploration_hiffirmation_shown', {
          message_type: type,
          exploration_context: 'hi_island',
          user_tier: this.getUserTier(),
          exploration_depth: this.getExplorationDepth(),
          activity_score: this.activityScore,
          tab_switches: this.explorationPattern?.tabSwitches || 0
        });
      }

      getUserTier() {
        // Integration with existing tier system
        const tierElement = document.getElementById('hi-tier-indicator');
        if (tierElement) {
          const tierText = tierElement.querySelector('.tier-text')?.textContent;
          if (tierText === 'Premium') return 'PREMIUM';
          if (tierText === 'Standard') return 'STANDARD';
        }
        return 'ANONYMOUS';
      }

      showContextualMessage() {
        const now = Date.now();
        if (now - this.lastShown < this.cooldownPeriod) return;

        const messages = this.getContextualMessages();
        const availableMessages = messages.filter(msg => !this.messageHistory.includes(msg));
        
        if (availableMessages.length === 0) {
          this.messageHistory = []; // Reset history if all used
          this.showContextualMessage(); // Retry
          return;
        }

        const message = availableMessages[Math.floor(Math.random() * availableMessages.length)];
        this.displayMessage(message);
        
        // Update history
        this.messageHistory.push(message);
        if (this.messageHistory.length > this.maxHistorySize) {
          this.messageHistory.shift();
        }
        
        this.lastShown = now;
      }

      displayMessage(message) {
        this.popup.textContent = message;
        this.popup.classList.add('show');
        
        // Auto-hide after 4 seconds
        setTimeout(() => {
          this.hidePopup();
        }, 4000);
      }

      hidePopup() {
        this.popup.classList.remove('show');
      }

      startActivityTriggers() {
        // Smart contextual triggers for exploration context
        this.activityScore = 0;
        this.explorationMilestones = ['general-tab', 'mindfulness-tab', 'learning-tab', 'creativity-tab'];
        this.setupExplorationTriggers();
        this.setupSmartTimingForExploration();
        this.trackExplorationPattern();
      }

      setupExplorationTriggers() {
        // Trigger inspirational messages after exploration milestones
        this.explorationMilestones.forEach(tabId => {
          const tab = document.querySelector(`[data-tab="${tabId}"], #${tabId}`);
          if (tab) {
            tab.addEventListener('click', () => {
              setTimeout(() => {
                this.showExplorationMessage(tabId);
              }, 3000); // Give user time to explore
            });
          }
        });

        // Share button interactions in island context
        const shareButtons = document.querySelectorAll('.share-action-btn, [data-action="share"]');
        shareButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            setTimeout(() => {
              this.showExplorationMessage('share-exploration');
            }, 2000);
          });
        });
      }

      showExplorationMessage(explorationType) {
        const now = Date.now();
        if (now - this.lastShown < 20000) return; // Exploration-specific cooldown

        const explorationMessages = this.getExplorationMessages(explorationType);
        const message = explorationMessages[Math.floor(Math.random() * explorationMessages.length)];
        this.displayMessage(message, 'exploration');
        this.lastShown = now;
      }

      getExplorationMessages(explorationType) {
        const userTier = this.getUserTier();
        
        const explorationMap = {
          'general-tab': {
            base: ["üó∫Ô∏è Every exploration starts somewhere", "üåä General discovery opens new paths"],
            standard: ["üß≠ Your curiosity is your compass", "‚≠ê Broad exploration builds wisdom"],
            premium: ["üöÄ You navigate discovery with intention", "üíé General awareness unlocks specific insights"]
          },
          'mindfulness-tab': {
            base: ["üßò‚Äç‚ôÄÔ∏è Mindful moments create clarity", "üå∏ Presence is your superpower"],
            standard: ["üí´ Mindfulness deepens your exploration", "üå± Awareness cultivates inner wisdom"],
            premium: ["üé≠ You master the art of conscious exploration", "‚ú® Mindful discovery transforms perspective"]
          },
          'learning-tab': {
            base: ["üìö Learning never stops serving you", "üåü Knowledge builds on curiosity"],
            standard: ["üéØ Active learning accelerates growth", "üî• Your learning mindset is magnetic"],
            premium: ["ü¶ã You transform information into wisdom", "üåà Learning becomes your creative playground"]
          },
          'creativity-tab': {
            base: ["üé® Creativity flows from exploration", "‚ú® Your imagination has no limits"],
            standard: ["üí´ Creative exploration unlocks potential", "üå∫ Your creative spirit inspires others"],
            premium: ["ü¶Ñ You channel exploration into creative mastery", "üé≠ Your creativity transforms the world around you"]
          },
          'share-exploration': {
            base: ["ü§ù Sharing discovery multiplies wisdom", "üåà Your exploration inspires others"],
            standard: ["üí° Shared insights create community", "üî• Your discoveries light paths for others"],
            premium: ["üåü You're a beacon of conscious exploration", "‚ö° Your shared wisdom transforms communities"]
          }
        };

        const messageSet = explorationMap[explorationType] || explorationMap['general-tab'];
        let messages = [...messageSet.base];
        
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messages.push(...messageSet.standard);
        }
        if (userTier === 'PREMIUM') {
          messages.push(...messageSet.premium);
        }

        return messages;
      }

      setupSmartTimingForExploration() {
        // Island-specific smart timing that respects exploration flow
        let explorationTimer;
        let explorationDepth = 'surface'; // surface, engaged, deep
        
        const calculateExplorationDepth = () => {
          if (this.activityScore > 15) explorationDepth = 'deep';
          else if (this.activityScore > 6) explorationDepth = 'engaged';
          else explorationDepth = 'surface';
        };

        const getExplorationInterval = () => {
          const intervals = {
            surface: 240000,  // 4 minutes - encourage deeper exploration
            engaged: 300000,  // 5 minutes - don't interrupt flow
            deep: 360000      // 6 minutes - respect deep exploration
          };
          return intervals[explorationDepth] + Math.random() * 60000;
        };

        const resetExplorationTimer = () => {
          clearTimeout(explorationTimer);
          calculateExplorationDepth();
          
          explorationTimer = setTimeout(() => {
            if (this.shouldShowExplorationMessage()) {
              this.showContextualMessage();
            }
            resetExplorationTimer();
          }, getExplorationInterval());
        };

        // Track exploration-specific interactions
        ['click', 'scroll', 'focus', 'tab-switch'].forEach(event => {
          document.addEventListener(event, (e) => {
            this.activityScore += this.getExplorationWeight(e);
            setTimeout(() => { this.activityScore = Math.max(0, this.activityScore - 1); }, 45000);
          }, { passive: true });
        });

        resetExplorationTimer();
      }

      getExplorationWeight(event) {
        const weights = {
          click: 2,
          scroll: 1,
          focus: 1,
          'tab-switch': 4 // Tab switching is high-value exploration
        };

        // Bonus for exploration-related elements
        if (event.target && event.target.closest('[data-tab], .feed-item, .share-action-btn')) {
          return (weights[event.type] || 1) * 2;
        }

        return weights[event.type] || 1;
      }

      shouldShowExplorationMessage() {
        const now = Date.now();
        if (now - this.lastShown < 60000) return false; // 1 minute minimum for exploration

        // Don't interrupt active exploration
        if (this.activityScore > 20) return false;

        return true;
      }

      trackExplorationPattern() {
        this.explorationPattern = {
          sessionStart: Date.now(),
          tabSwitches: 0,
          shareActions: 0,
          deepInteractions: 0
        };

        // Track tab switching behavior
        document.addEventListener('click', (e) => {
          if (e.target.closest('[data-tab]')) {
            this.explorationPattern.tabSwitches++;
          }
          if (e.target.closest('.share-action-btn')) {
            this.explorationPattern.shareActions++;
          }
        });
      }
    }

    // Initialize floating Hiffirmations system
    const floatingHiffirmations = new FloatingHiffirmations();

    // Quote Card Generation System (Tesla-Grade)
    class HiQuoteCardGenerator {
      constructor() {
        this.brandColors = {
          primary: '#FFD166',
          secondary: '#F4A261',
          accent: '#E76F51',
          background: '#1E2A4A',
          backgroundSecondary: '#2D4A87',
          text: '#FFFFFF',
          textSecondary: 'rgba(255, 255, 255, 0.8)'
        };
        
        this.socialFormats = {
          instagram_post: { width: 1080, height: 1080 },
          instagram_story: { width: 1080, height: 1920 },
          twitter_card: { width: 1200, height: 675 },
          square: { width: 800, height: 800 }
        };
      }

      async generateQuoteCard(message, options = {}) {
        const {
          userTier = 'ANONYMOUS',
          format = 'square',
          context = 'island'
        } = options;

        const dimensions = this.socialFormats[format];
        const canvas = this.createCanvas(dimensions.width, dimensions.height);
        const ctx = canvas.getContext('2d');

        await this.drawBackground(ctx, canvas, userTier);
        await this.drawQuoteText(ctx, message, canvas, userTier);
        await this.drawBranding(ctx, canvas, userTier, context);
        
        return canvas.toDataURL('image/png', 0.9);
      }

      createCanvas(width, height) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        return canvas;
      }

      async drawBackground(ctx, canvas, userTier) {
        const { width, height } = canvas;
        let gradient;
        
        switch(userTier) {
          case 'PREMIUM':
            gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, this.brandColors.primary);
            gradient.addColorStop(0.3, this.brandColors.secondary);
            gradient.addColorStop(0.7, this.brandColors.accent);
            gradient.addColorStop(1, this.brandColors.background);
            break;
          case 'STANDARD':
            gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, this.brandColors.background);
            gradient.addColorStop(0.5, this.brandColors.backgroundSecondary);
            gradient.addColorStop(1, this.brandColors.secondary);
            break;
          default:
            gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, this.brandColors.background);
            gradient.addColorStop(1, this.brandColors.backgroundSecondary);
        }
        
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, width, height);
        
        if (userTier === 'PREMIUM') {
          this.addPremiumTexture(ctx, canvas);
        }
      }

      addPremiumTexture(ctx, canvas) {
        ctx.globalAlpha = 0.1;
        for (let i = 0; i < 50; i++) {
          const x = Math.random() * canvas.width;
          const y = Math.random() * canvas.height;
          const size = Math.random() * 3 + 1;
          
          ctx.fillStyle = this.brandColors.primary;
          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.globalAlpha = 1;
      }

      async drawQuoteText(ctx, message, canvas, userTier) {
        const { width, height } = canvas;
        const centerX = width / 2;
        const centerY = height / 2;
        
        const fontSize = this.getFontSize(message.length, canvas);
        const fontFamily = userTier === 'PREMIUM' ? 
          'Georgia, "Times New Roman", serif' : 
          '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        
        ctx.fillStyle = this.brandColors.text;
        ctx.font = `${fontSize}px ${fontFamily}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        const lines = this.wrapText(ctx, message, width * 0.8);
        const lineHeight = fontSize * 1.4;
        const totalTextHeight = lines.length * lineHeight;
        const startY = centerY - (totalTextHeight / 2);
        
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetY = 2;
        
        lines.forEach((line, index) => {
          const y = startY + (index * lineHeight);
          ctx.fillText(line, centerX, y);
        });
        
        ctx.shadowColor = 'transparent';
      }

      getFontSize(textLength, canvas) {
        const baseSize = Math.min(canvas.width, canvas.height) / 20;
        if (textLength < 30) return Math.min(baseSize * 1.2, 48);
        if (textLength < 60) return Math.min(baseSize, 40);
        return Math.min(baseSize * 0.8, 32);
      }

      wrapText(ctx, text, maxWidth) {
        const words = text.split(' ');
        const lines = [];
        let currentLine = '';
        
        for (const word of words) {
          const testLine = currentLine + (currentLine ? ' ' : '') + word;
          const metrics = ctx.measureText(testLine);
          
          if (metrics.width > maxWidth && currentLine !== '') {
            lines.push(currentLine);
            currentLine = word;
          } else {
            currentLine = testLine;
          }
        }
        
        if (currentLine) {
          lines.push(currentLine);
        }
        
        return lines;
      }

      async drawBranding(ctx, canvas, userTier, context = 'island') {
        const { width, height } = canvas;
        const brandingY = height - 80;
        
        ctx.fillStyle = this.brandColors.textSecondary;
        ctx.font = '24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('‚Äî Stay Hi Community ‚Äî', width / 2, brandingY);
        
        ctx.font = '18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.fillStyle = this.brandColors.primary;
        ctx.fillText('stay-hi.app', width / 2, brandingY + 35);
        
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
          ctx.fillStyle = this.brandColors.textSecondary;
          const tierText = userTier === 'PREMIUM' ? '‚ú® Premium Member' : '‚≠ê Standard Member';
          ctx.fillText(tierText, width / 2, brandingY - 25);
        }
      }

      async dataURLToBlob(dataURL) {
        return new Promise(resolve => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            canvas.toBlob(resolve, 'image/png', 0.9);
          };
          
          img.src = dataURL;
        });
      }
    }

    // Initialize quote card generator for Hi Island
    window.HiQuoteCardGenerator = new HiQuoteCardGenerator();
  </script>
</body>
</html>
