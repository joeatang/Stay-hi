<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hi Island ‚Äî Stay Hi</title>

  <!-- üì± PWA Configuration -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD166">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Hi Island">

  <!-- Preload Supabase CDN for instant client init -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" as="script">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <!-- üöÄ Tesla-Grade Anonymous Access Modal System -->
  <script src="assets/anonymous-access-modal.js"></script>

  <!-- Design System -->
  <link rel="stylesheet" href="styles/tokens.css"/>
  <link rel="stylesheet" href="styles/base.css"/>
  
  <!-- Shared UI -->
  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>
  <link rel="stylesheet" href="assets/premium-ux.css"/>
  <link rel="stylesheet" href="assets/premium-calendar.css"/>

  <!-- Component Styles -->
  <link rel="stylesheet" href="components/hi-island-map/map.css"/>
  <link rel="stylesheet" href="components/hi-island-feed/feed.css"/>
  <link rel="stylesheet" href="../ui/HiShareSheet/HiShareSheet.css"/>
  <link rel="stylesheet" href="components/profile-preview-modal/profile-modal.css"/>
  
  <!-- Hi Feature Flags & Rewards -->
  <link rel="stylesheet" href="assets/hi-rewards-styles.css"/>

  <!-- Leaflet (for map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  
  <!-- Leaflet MarkerCluster Plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  
  <!-- üöÄ PWA Manager -->
  <script src="assets/pwa-manager.js"></script>
  
  <style>
    /* ===================================================================
       üé® HI ISLAND PAGE STYLES (Scoped to this page only)
    =================================================================== */
    
    body {
      background: var(--gradient-island);
      background-attachment: fixed;
      min-height: 100vh;
    }

    /* Tesla-grade header on hi-island: clean minimal layout */
    body[data-page="hi-island"] header {
      padding: var(--space-md) !important;
      backdrop-filter: blur(20px) !important;
      background: rgba(255, 255, 255, 0.95) !important;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
    }

    body[data-page="hi-island"] .appbar {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      max-width: 100% !important;
    }

    body[data-page="hi-island"] .appbar .brand {
      position: absolute !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
    }

    body[data-page="hi-island"] .logo {
      max-height: 32px !important;
      width: auto !important;
      filter: invert(1) brightness(0) !important;
    }

    body[data-page="hi-island"] .brand-name {
      color: #000 !important;
      font-weight: 600 !important;
    }

    body[data-page="hi-island"] #btnMore {
      background: rgba(0, 0, 0, 0.08) !important;
      border-radius: 20px !important;
      padding: 8px 16px !important;
      transition: background 0.2s ease !important;
    }

    body[data-page="hi-island"] #btnMore:hover {
      background: rgba(0, 0, 0, 0.12) !important;
    }

    body[data-page="hi-island"] #btnMore svg {
      color: #333 !important;
    }

    .hi-island-container {
      max-width: 1040px;
      margin: 0 auto;
      padding: var(--space-md);
    }

    /* üî• Hi Experience Layer Styles */
    #hiExperienceLayer {
      margin: 2rem 0;
    }

    .hi-experience-section {
      margin-bottom: 2rem;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
      overflow: hidden;
    }

    /* Responsive adjustments for experience layer */
    @media (max-width: 768px) {
      .hi-experience-section {
        margin: 1rem 0;
        border-radius: 0.75rem;
      }
    }
  </style>
  
  <!-- HiFooter CSS - Dashboard Parity -->
  <link rel="preload" href="../ui/HiFooter/HiFooter.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="../ui/HiFooter/HiFooter.css"></noscript>
</head>
<body data-page="hi-island">
  <!-- Header (shared component) -->
  <header id="app-header" class="premium-header-container"></header>

  <!-- Main Content -->
  <main class="hi-island-container">
    <!-- Map Component (will be injected) -->
    <div id="hi-island-map-root"></div>

    <!-- Feed Component (will be injected) -->
    <div id="hi-island-feed-root"></div>

    <!-- üî• NEW: Hi Experience Layer Components (Feature Flagged) -->
    <div id="hiExperienceLayer" style="display: none;">
      <!-- HiFeed Component Container -->
      <div id="hiFeedContainer" class="hi-experience-section"></div>
      
      <!-- HiStreaks Component Container -->
      <div id="hiStreaksContainer" class="hi-experience-section"></div>
    </div>
  </main>

  <!-- Toast Notifications -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- ===================================================================
       SCRIPTS (Load Order Matters - Tesla-Grade Timing)
  =================================================================== -->
  
  <!-- Core Dependencies (Load First) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="assets/supabase-init.js"></script>
  <script src="assets/db.js"></script>
  <script src="assets/avatar-utils.js"></script>
  <script src="assets/geocoding-service.js"></script>
  
  <!-- Feature Flags & Rewards System -->
  <script src="assets/feature-flags.js"></script>
  <script src="assets/hi-rewards-controller.js"></script>
  
  <!-- HiBase Integration (Flagged Rollout) -->
  <script type="module">
    // Import HiBase shares for flagged rollout
    window.HiBase_shares = await import('../lib/hibase/shares.js');
    console.log('üî• HiBase shares module loaded for Hi Island feed integration');
  </script>
  
  <!-- üî• Phase 7: Hi Experience Layer Components (Feature Flagged) -->
  <script src="../lib/hifeed/index.js"></script>
  <script src="../ui/HiFeed/HiFeed.js"></script>
  <script src="../ui/HiStreaks/HiStreaks.js"></script>

  <!-- Component Scripts -->
  <script src="../ui/HiShareSheet/HiShareSheet.js" type="module"></script>
  <script src="components/hi-island-map/map.js" type="module"></script>
  <script src="components/hi-island-feed/feed.js" type="module"></script>
  <script src="components/profile-preview-modal/profile-modal.js" type="module"></script>
  
  <!-- Header (Load synchronously - no defer) -->
  <script src="../ui/HiHeader/HiHeader.js"></script>
  
  <!-- Footer - Dashboard Parity -->
  <script src="../ui/HiFooter/HiFooter.js" defer></script>
  
  <!-- Premium Calendar (Flagship - matches index.html) -->
  <script src="assets/premium-calendar.js"></script>

  <!-- Page Orchestrator -->
  <script type="module">
    // ===================================================================
    // üéØ HI ISLAND ORCHESTRATOR (Clean, minimal coordination)
    // ===================================================================
    
    async function initHiIsland() {
      console.log('üèùÔ∏è Hi Island initializing...');
      
      // Wait for hiDB
      await new Promise(resolve => {
        if (window.hiDB) {
          resolve();
        } else {
          const check = setInterval(() => {
            if (window.hiDB) {
              clearInterval(check);
              resolve();
            }
          }, 100);
        }
      });

      // Calendar and menu are handled by header.js (flagship pattern)
      // No need to duplicate wiring here

      // Initialize components (they handle their own rendering)
      
      // üî• Phase 7: Initialize Hi Experience Layer (Feature Flagged)
      await initializeHiExperienceLayer();
      
      console.log('‚úÖ Hi Island ready');
    }

    // üî• Phase 7: Hi Experience Layer Initialization (Feature Flagged)
    async function initializeHiExperienceLayer() {
      try {
        // Check if hifeed_enabled flag is active (cohort-aware)
        const { isEnabledCohort } = await import('../lib/flags/HiFlags.js');
        const { trackEvent } = await import('../lib/monitoring/HiMonitor.js');
        
        const flagEnabled = await isEnabledCohort('hifeed_enabled');
        
        // Track flag evaluation for telemetry
        trackEvent('flag_check', {
          key: 'hifeed_enabled',
          enabled: flagEnabled,
          rollout: true,
          location: 'island'
        });
        
        console.log('üîç HiFeed flag check (island - cohort):', { flagEnabled, rollout: true });
        
        if (flagEnabled) {
          console.log('üî• HiFeed enabled - initializing experience layer components on Hi Island');
          
          // Show the experience layer container
          const experienceLayer = document.getElementById('hiExperienceLayer');
          if (experienceLayer) {
            experienceLayer.style.display = 'block';
          }
          
          // Initialize HiFeed component (public feed for Hi Island)
          if (window.HiFeed) {
            const hiFeed = new window.HiFeed('#hiFeedContainer', { publicFeed: true });
            await hiFeed.initialize();
            console.log('‚úÖ HiFeed component initialized on Hi Island (public feed mode)');
          }
          
          // Initialize HiStreaks component
          if (window.HiStreaks) {
            const hiStreaks = new window.HiStreaks('#hiStreaksContainer');
            await hiStreaks.initialize();
            console.log('‚úÖ HiStreaks component initialized on Hi Island');
          }
          
        } else {
          console.log('üö´ HiFeed disabled - experience layer components not loaded on Hi Island');
        }
        
      } catch (error) {
        console.error('‚ùå Hi Experience Layer initialization error on Hi Island:', error);
      }
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHiIsland);
    } else {
      initHiIsland();
    }
  </script>
</body>
</html>
