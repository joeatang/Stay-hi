<link rel="stylesheet" href="assets/theme.css"/>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile — Stay Hi</title>
  <style>
    :root{--hi-green:#006400}
    body{font-family:system-ui;background:#FFFDF9;margin:0}
    .wrap{max-width:960px;margin:0 auto;padding:24px}
    .card{background:#fff;border:1px solid #eee;border-radius:16px;padding:20px;box-shadow:0 8px 18px rgba(0,0,0,.05)}
    .row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .avatar{width:72px;height:72px;border-radius:50%;object-fit:cover;border:1px solid #ddd;background:#fff}
    label{display:block;font-size:14px;margin-top:12px}
    input[type="text"]{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;margin-top:6px}
    input[type="file"]{margin-top:6px}
    button.btn{padding:12px 16px;border:0;border-radius:12px;background:var(--hi-green);color:#fff;font-weight:800;cursor:pointer}
    .ghost{background:#fff;color:#111;border:1px solid #ddd}
    .err{color:#b00020;margin-top:10px}
    .ok{color:#006400;margin-top:10px}
    /* header with menu (app page) */
    header.slim{position:sticky;top:0;backdrop-filter:saturate(1.2) blur(6px);-webkit-backdrop-filter:saturate(1.2) blur(6px);background:rgba(255,255,255,.85);border-bottom:1px solid rgba(0,0,0,.06);z-index:10}
    .bar{height:56px;max-width:960px;margin:0 auto;padding:0 12px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:8px;margin:0 auto}
    .brand img{width:20px;height:20px}
    details.menu{position:relative}
    details.menu>summary{list-style:none;width:40px;height:40px;display:grid;place-items:center;border-radius:999px;border:1px solid #e5e5e5;background:#fff;cursor:pointer;font-size:22px}
    details.menu[open] > div{display:block}
    details.menu>div{display:none;position:absolute;right:0;top:48px;width:220px;background:#fff;border:1px solid #e5e5e5;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);overflow:hidden}
    .menu a,.menu button{display:block;width:100%;text-align:left;padding:10px 14px;font-size:14px;color:#111;text-decoration:none;background:#fff;border:0}
    .menu a:hover,.menu button:hover{background:#f6f6f6}
  </style>
</head>
<body>
  <header class="slim">
    <div class="bar">
      <div style="width:40px"></div>
      <a class="brand" href="index.html">
        <img src="https://ucarecdn.com/4233fafa-2eee-45bf-bee2-eb6578070c5b/-/format/auto/" alt="Stay Hi" />
        <strong>Stay Hi</strong>
      </a>
      <details class="menu" id="menu">
        <summary aria-label="Menu">⋯</summary>
        <div>
          <a href="index.html">Home</a>
          <a href="hi-island.html">Hi Island</a>
          <a href="profile.html">Profile</a>
          <a id="menuSignin" href="signin.html">Sign in</a>
          <button id="menuLogout" type="button" style="display:none">Logout</button>
        </div>
      </details>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <img id="av" class="avatar" src="https://ucarecdn.com/4233fafa-2eee-45bf-bee2-eb6578070c5b/-/format/auto/" alt="avatar">
        <div>
          <div id="e" style="font-weight:800"></div>
          <div id="u" style="color:#666"></div>
        </div>
      </div>

      <form id="f" style="margin-top:12px">
        <label>Username
          <input type="text" id="username" placeholder="yourname">
        </label>
        <label>Avatar (PNG/JPEG/WEBP up to 8MB)
          <input type="file" id="file" accept="image/png,image/jpeg,image/webp">
        </label>
        <div class="row" style="margin-top:16px">
          <button class="btn" type="submit" id="save">Save changes</button>
          <button class="btn ghost" id="home">Home</button>
        </div>
        <div class="err" id="err"></div>
        <div class="ok" id="ok"></div>
      </form>
    </div>
  </div>

<script>
  // Shared helpers
  function fileToDataURL(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file);});}
  async function downscale(dataUrl, max=512){
    try{
      const img=new Image(); img.crossOrigin='anonymous';
      await new Promise((r,j)=>{img.onload=r; img.onerror=j; img.src=dataUrl;});
      const scale=Math.min(1, max/Math.max(img.width,img.height));
      if(scale>=1) return dataUrl;
      const c=document.createElement('canvas'); c.width=Math.round(img.width*scale); c.height=Math.round(img.height*scale);
      const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height);
      const mime=(dataUrl.split(';')[0]||'image/png').replace('data:','');
      return c.toDataURL(mime,0.92);
    }catch{ return dataUrl; }
  }

  // Init header session state
  (async ()=>{
    const me = await fetch('/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'me'})}).then(r=>r.json()).catch(()=>({}));
    const signed = !!me?.user;
    if(!signed){ location.href='signin.html'; return; }
    // header toggle
    document.getElementById('menuSignin').style.display = signed ? 'none':'block';
    document.getElementById('menuLogout').style.display = signed ? 'block':'none';
    document.getElementById('menuLogout').onclick = async ()=>{
      await fetch('/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'logout'})});
      location.href='index.html';
    };
    // fill profile
    e.textContent = me.user.email||'';
    u.textContent = me.user.username ? ('@'+me.user.username) : 'No username yet';
    username.value = me.user.username||'';
    if(me.user.avatar_url) av.src = me.user.avatar_url;
  })();

  home.onclick=(ev)=>{ev.preventDefault();location.href='index.html';};

  f.onsubmit = async (ev)=>{
    ev.preventDefault(); err.textContent=''; ok.textContent=''; save.disabled=true;
    let avatarDataUrl=null;
    const fEl=document.getElementById('file');
    if(fEl.files && fEl.files[0]){
      const data = await fileToDataURL(fEl.files[0]);
      avatarDataUrl = await downscale(data,512);
      av.src = avatarDataUrl; // local preview
    }
    const r = await fetch('/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'profile.update', username:username.value||null, avatarDataUrl})});
    const x = await r.json().catch(()=>({}));
    save.disabled=false;
    if(r.ok && x?.ok){
      ok.textContent='Saved!';
      if(x.user?.username) u.textContent='@'+x.user.username;
      if(x.user?.avatar_url) av.src = x.user.avatar_url;
    } else {
      err.textContent = x?.error || 'Save failed';
    }
  };
</script>
</body>
</html>
