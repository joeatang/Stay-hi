<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Profile ‚Äî Stay Hi</title>
  
  <!-- üé¨ CRITICAL: Inline Blocking Splash Screen (Prevents FOUC) -->
  <style id="splash-critical-css">
    body { visibility: hidden !important; }
    body.splash-ready { visibility: visible !important; }
    .hi-splash-instant {
      position: fixed !important;
      top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important;
      z-index: 999999 !important;
      background: linear-gradient(135deg, 
        rgba(26, 29, 58, 1) 0%,
        rgba(37, 43, 82, 1) 25%,
        rgba(45, 30, 79, 1) 50%,
        rgba(55, 35, 70, 1) 75%,
        rgba(26, 29, 58, 1) 100%) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      opacity: 1 !important;
      visibility: visible !important;
    }
    .hi-splash-logo {
      width: 140px; height: 140px; border-radius: 32px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      animation: logoGlow 3s ease-in-out infinite;
    }
    @keyframes logoGlow {
      0%, 100% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(255, 122, 24, 0.4)); }
      50% { transform: scale(1.05); filter: drop-shadow(0 0 30px rgba(255, 122, 24, 0.6)); }
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.body.classList.add('splash-ready');
    });
    window.splashStartTime = performance.now();
    window.addEventListener('load', function() {
      const splash = document.getElementById('instant-splash');
      if (!splash) return;
      const elapsed = performance.now() - window.splashStartTime;
      const minDuration = window.innerWidth <= 768 ? 1400 : 1200;
      const remaining = Math.max(0, minDuration - elapsed);
      setTimeout(() => {
        splash.style.transition = 'opacity 0.3s ease-out';
        splash.style.opacity = '0';
        setTimeout(() => splash.remove(), 300);
      }, remaining);
    }, { once: true });
  </script>
  
  <!-- üî• CRITICAL: Force service worker update on mobile Chrome -->
  <script>
    console.time('‚è±Ô∏è TOTAL_PAGE_LOAD');
    console.time('‚è±Ô∏è HEAD_SCRIPTS');
    (function() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(regs => {
          regs.forEach(reg => reg.update());
        });
      }
    })();
  </script>
  
  <!-- Optional High-Contrast Accessibility Mode (non-destructive) -->
  <script type="module" src="./lib/boot/contrast-mode.js"></script>
  
  <!-- Tesla-Grade Performance: Essential Assets Only -->
  <!-- Env-safe path resolver for dev/prod safe navigation -->
  <script src="assets/hi-paths.js"></script>
  
  <!-- üîí SECURE: Load Supabase configuration FIRST -->
  <!-- Load config-local.js BEFORE config.js so local values take priority -->
  <script src="./assets/config-local.js" onerror="console.log('No config-local.js found, using env vars')"></script>
  <script src="./assets/config.js"></script>
  
  <script src="assets/avatar-utils.js"></script>
  <script src="assets/location-picker.js"></script>
  <script type="module" src="./lib/HiPerformance.js"></script>
  <script src="assets/image-optimizer.js"></script>
  <script src="assets/social-avatar-uploader.js"></script>
   <!-- Lazy loader replaces direct premium calendar include -->
   <script src="./lib/lazy/lazy-loaders.js"></script>
   <script src="assets/premium-calendar.js?v=20241222-streak-fix" defer></script>
  <!-- Centralized streak milestone registry (load early for streak displays; calendar now lazy) -->
  <script src="./lib/streaks/HiStreakMilestones.js"></script>
  <!-- Centralized streak milestone toast component -->
  <script src="./lib/streaks/HiMilestoneToast.js"></script>
  <!-- Auth QA harness (runs only when ?runAuthQA=1) -->
  <script src="./lib/qa/auth-flow-qa.js"></script>
  
  <!-- Supabase Integration -->
  <!-- üöÄ DEPENDENCY MANAGER: Prevents race conditions on first load -->
  <script src="./lib/boot/dependency-manager.js"></script>

  <!-- üöÄ CRITICAL: Remove async - HiSupabase.v3.js needs window.supabase BEFORE it loads -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.81.1" integrity="sha384-XLEuzmdNfK1V09d59bu+Uv3EFtEp5kFP8BmseBq85CUpeFZXhUfqjk4ZeR/biZmS" crossorigin="anonymous"></script>
  <script src="./lib/HiSupabase.v3.js"></script>
  <!-- üöÄ WOZ FIX: Query timeout + retry logic -->
  <script src="./lib/query-timeout.js" defer></script>
  <!-- ‚úÖ CRITICAL: AuthReady orchestrates session + membership and fires hi:auth-ready event -->
  <script type="module" src="./lib/AuthReady.js"></script>
  
  <!-- üèÜ WOZ FIX: ProfileManager - Single Source of Truth -->
  <script src="./lib/ProfileManager.js"></script>
  
  <!-- üéØ TIER CONFIG - Must load BEFORE HiTier.js and MembershipSystem -->
  <script src="./lib/config/TIER_CONFIG.js" type="module"></script>
  <!-- ‚úÖ Unified Membership Bridge for tier detection -->
  <script src="./lib/membership/HiMembershipBridge.js"></script>
  <!-- Tier & Points Helpers -->
  <script src="./lib/access/HiTier.js"></script>
  <script src="./lib/rewards/HiPoints.js"></script>
  <script src="./lib/HiBrandTiers.js" async></script>
  
  <!-- üî• CRITICAL: Expose loadProfileData EARLY before boot scripts -->
  <script>
    // Prevent race condition: auth-ready fires before function exists
    window.__loadProfileData = null; // Placeholder, will be replaced by actual function
    console.log('‚úÖ __loadProfileData placeholder exposed early (prevents race condition)');
  </script>
  
  <!-- CRITICAL: Daily Check-in Button Init -->
  <script>
    console.log('üé¨ Check-in init script loaded in HEAD');
    window.initDailyCheckin = function() {
      console.log('üéØ initDailyCheckin() called');
      const btn = document.getElementById('dailyCheckinBtn');
      if(!btn) { console.error('‚ùå Button not found'); return false; }
      
      const client = window.supabaseClient || window.hiSupabase;
      if(!client) { console.warn('‚è≥ Client not ready, will retry on auth-ready'); return false; }
      
      console.log('‚úÖ Attaching handler NOW');
      btn.addEventListener('click', async ()=>{
        console.log('üéØ CLICKED!');
        const status = document.getElementById('checkinStatus');
        btn.disabled = true; btn.textContent = 'Checking...';
        try {
          const { data, error } = await client.rpc('award_daily_checkin');
          console.log('üì¨', data, error);
          if(error){ status.textContent = error.message; status.style.color = '#f66'; }
          else {
            if(data?.awarded){ status.textContent = `+${data.delta}!`; status.style.color = '#6c6'; }
            else { status.textContent = 'Done today'; status.style.color = '#aaa'; }
            const el = document.getElementById('pointsBalance'); 
            if(el && data?.balance !== undefined) el.textContent = data.balance;
          }
        } catch(e){ 
          console.error('‚ùå', e);
          status.textContent = 'Error'; status.style.color = '#f66';
        }
        finally { btn.disabled = false; btn.textContent = 'Daily Check-in +5'; }
      });
      return true;
    };
    
    // Try on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', ()=>{
      console.log('üìÑ DOM loaded, trying init...');
      if(!window.initDailyCheckin()) {
        console.log('‚è≥ Waiting for auth-ready...');
        document.addEventListener('hi:auth-ready', ()=>{
          console.log('üîê Auth ready, retrying...');
          window.initDailyCheckin();
        }, { once: true });
      }
    });
  </script>
  
  <!-- üöÄ INTEGRATION #2: HiBase + HiFlags for Profile operations (flagged rollout) -->
  <script type="module" src="./lib/flags/HiFlags.js"></script>
  <script type="module" src="./lib/hibase/index.js"></script>
  
  <!-- üöÄ Tesla-Grade Anonymous Access Modal System -->
  <script src="assets/anonymous-access-modal.js"></script>
  <!-- Unified Admin Access Manager -->
  <script src="./lib/admin/AdminAccessManager.js"></script>
  
  <!-- Tesla CSS: Critical + Progressive Enhancement -->
  <link rel="stylesheet" href="assets/location-picker.css">
  <link rel="preload" href="assets/premium-ux.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="assets/premium-stats.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="assets/premium-calendar.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="./ui/HiFooter/HiFooter.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="assets/premium-ux.css">
    <link rel="stylesheet" href="assets/premium-stats.css">
      const ensureShow = () => {
      if (window.hiCalendarInstance && typeof window.hiCalendarInstance.show === 'function') {
        window.hiCalendarInstance.show();
        return true;
      }
    <link rel="stylesheet" href="assets/premium-calendar.css">
    <link rel="stylesheet" href="ui/HiFooter/HiFooter.css">
  </noscript>
  
  <!-- Tesla-Grade Mobile & Data Fixes -->
  <link rel="stylesheet" href="assets/tesla-mobile-fixes.css">
  <script src="assets/tesla-data-isolation.js"></script>
  
  <style>
    /* Tesla-Grade Gold Standard Profile System */
    :root {
      --tesla-primary: #4ECDC4;
      --tesla-secondary: #FFD93D;
      --tesla-danger: #FF6B6B;
      --tesla-bg: linear-gradient(135deg, #0F0F23 0%, #1A1A2E 50%, #16213E 100%);
      --tesla-surface: rgba(255,255,255,0.05);
      --tesla-border: rgba(255,255,255,0.1);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* üèóÔ∏è TESLA-GRADE: Universal viewport header (matches dashboard) */
    .tesla-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      max-width: 100vw;
      height: clamp(50px, calc(60px + env(safe-area-inset-top, 0px)), 100px);
      min-height: calc(44px + env(safe-area-inset-top, 10px));
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0 clamp(12px, 4vw, 24px) clamp(8px, 2vh, 12px);
      padding-top: clamp(8px, env(safe-area-inset-top, 10px), 20px);
      z-index: 10000;
      box-sizing: border-box;
      contain: layout style paint;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      width: auto;
      min-width: 90px;
      flex-shrink: 0;
    }

    .header-center {
      flex: 0 1 auto;
      display: flex;
      justify-content: center;
      align-items: center;
      max-width: 200px;
    }

    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      width: auto;
      min-width: 220px;
      max-width: 300px;
      gap: 8px;
      overflow: visible !important;
      position: relative;
      z-index: 10001;
      flex-shrink: 0;
    }
    
    /* üé® TESLA-GRADE: Spatially Intelligent Tier Indicator */
    .tier-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.3px;
      color: var(--hi-tier-color, #FFD166);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
    }
    
    .tier-indicator::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s ease;
    }
    
    .tier-indicator:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .tier-indicator:hover::before {
      left: 100%;
    }
    
    .tier-text {
      white-space: nowrap;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    /* üéØ GOLD STANDARD: Hide profile content until real data loads (prevents flash) */
    [data-profile-loading="true"] .profile-display-name,
    [data-profile-loading="true"] .profile-username,
    [data-profile-loading="true"] .profile-bio,
    [data-profile-loading="true"] .profile-location,
    [data-profile-loading="true"] .profile-joined {
      opacity: 0;
      pointer-events: none;
    }
    
    [data-profile-loading="false"] .profile-display-name,
    [data-profile-loading="false"] .profile-username,
    [data-profile-loading="false"] .profile-bio,
    [data-profile-loading="false"] .profile-location,
    [data-profile-loading="false"] .profile-joined {
      opacity: 1;
      transition: opacity 0.4s ease;
    }
    
    /* Smart Hiffirmations Pill - Contextual Access */
    .hiffirmations-smart-pill {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      cursor: pointer;
      margin-right: 8px;
    }
    
    .hiffirmations-smart-pill:hover {
      background: rgba(255, 209, 102, 0.2);
      transform: translateY(-1px);
      border-color: rgba(255, 209, 102, 0.3);
    }
    
    .pill-icon {
      font-size: 14px;
      opacity: 0.9;
    }

    .calendar-btn, .menu-btn, .home-nav-btn {
      display: flex !important;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.15) !important;
      color: #FFD166 !important;
      cursor: pointer;
      transition: all 0.3s ease;
      visibility: visible !important;
      opacity: 1 !important;
      z-index: 10001 !important;
      position: relative !important;
      flex-shrink: 0 !important;
    }

    .calendar-btn:hover, .menu-btn:hover, .home-nav-btn:hover {
      background: rgba(255, 209, 102, 0.2) !important;
      transform: translateY(-1px);
    }
    
    .calendar-btn svg, .menu-btn svg, .home-nav-btn svg {
      display: block;
      pointer-events: none;
    }

    .brand-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-hi-logo {
      width: 32px;
      height: 32px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .brand-text {
      font-size: 18px;
      font-weight: 600;
      color: #FFD166;
      letter-spacing: -0.5px;
    }

    /* Tesla-Grade Smart Navigation Container */
    .smart-nav-container {
      background: rgba(15, 15, 35, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px 20px;
      position: sticky;
      top: 70px;
      z-index: 999;
    }

    .smart-back-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      height: 40px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: #FFD166;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 0 12px;
      font-size: 14px;
      font-weight: 600;
    }

    .smart-back-btn:hover {
      background: rgba(255, 209, 102, 0.2);
      transform: translateY(-1px);
    }
    
    .smart-back-btn.loading {
      opacity: 0.6;
      cursor: wait;
    }
    
    .back-text {
      white-space: nowrap;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    @media (max-width: 768px) {
      .back-text {
        display: none;
      }
      .smart-back-btn {
        width: 40px;
        padding: 0;
      }
    }

    /* Navigation Modal - Dashboard Standard */
    .navigation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .navigation-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .navigation-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 1;
    }

    .navigation-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(400px, 90vw);
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 24px;
      padding: 24px;
      color: white;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      z-index: 2;
    }

    .navigation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .navigation-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #FFD166;
    }

    .close-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-nav-btn:hover {
      background: rgba(255, 0, 0, 0.2);
    }

    .navigation-menu {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .nav-section-title {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      text-decoration: none;
      color: white !important;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }
    
    .nav-item:visited {
      color: white !important;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .nav-item.admin-item {
      background: rgba(255, 215, 0, 0.1);
      border-color: rgba(255, 215, 0, 0.2);
    }

    .nav-item.admin-item:hover {
      background: rgba(255, 215, 0, 0.2);
    }

    .nav-icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui;
      background: var(--tesla-bg);
      color: white;
      min-height: 100vh; /* iOS 14 fallback */
      min-height: 100dvh; /* iOS 15.4+: Dynamic viewport */
      overflow-x: hidden;
      padding-top: 60px; /* Account for fixed header */
    }
    
    
    
    @media (min-width: 768px) {
      .back-navigation {
        top: 20px;
        left: 20px;
      }
      
      .nav-back {
        font-size: 14px;
        min-height: auto;
      }
    }
    
    .nav-back:hover {
      background: rgba(78, 205, 196, 0.15);
      border-color: var(--tesla-primary);
      transform: translateX(-4px);
      box-shadow: 0 8px 25px rgba(78, 205, 196, 0.3);
    }
    
    .nav-back:active {
      transform: translateX(-2px) scale(0.98);
      background: rgba(78, 205, 196, 0.2);
    }
    
    .nav-back::before {
      content: '‚Üê';
      font-size: 18px;
      font-weight: 600;
      transition: transform 0.2s ease;
    }
    
    .nav-back:hover::before {
      transform: translateX(-2px);
    }
    
    /* Profile Container - Mobile First */
    .profile-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px 16px 60px; /* FIXED: Reduced from 80px to 20px (body already has 60px) */
      
      /* Tesla mobile optimization */
      padding-bottom: env(safe-area-inset-bottom, 60px);
    }
    
    @media (min-width: 768px) {
      .profile-container {
        padding: 80px 24px 40px;
      }
    }
    
    /* Profile Hero Section - Mobile First */
    .profile-hero {
      text-align: center;
      margin-bottom: 24px;
      padding: 32px 20px;
      background: var(--tesla-surface);
      border-radius: 20px;
      border: 1px solid var(--tesla-border);
      
      /* Tesla mobile touch targets */
      min-height: 44px;
    }
    
    @media (min-width: 768px) {
      .profile-hero {
        margin-bottom: 40px;
        padding: 40px 24px;
        border-radius: 24px;
      }
    }
    
    /* Tesla Avatar - Mobile Optimized */
    .profile-avatar-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 0 auto 20px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid var(--tesla-primary);
      cursor: pointer;
      transition: all 0.3s ease;
      
      /* Tesla mobile touch target */
      min-width: 44px;
      min-height: 44px;
    }
    
    .profile-avatar-container:hover,
    .profile-avatar-container:active {
      transform: scale(1.05);
      box-shadow: 0 8px 32px rgba(78, 205, 196, 0.3);
    }
    
    @media (min-width: 768px) {
      .profile-avatar-container {
        width: 120px;
        height: 120px;
        margin: 0 auto 24px;
      }
    }
    
    /* Tesla Touch Feedback */
    @media (hover: none) {
      .profile-avatar-container:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
      }
    }
    
    .profile-avatar {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    
    .avatar-placeholder {
      width: 100%;
      height: 100%;
      background: var(--tesla-surface);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 8px;
    }
    
    .placeholder-content svg {
      opacity: 0.6;
    }
    
    .placeholder-text {
      font-size: 12px;
      opacity: 0.8;
    }
    
    .avatar-upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .profile-avatar-container:hover .avatar-upload-overlay {
      opacity: 1;
    }
    
    .upload-content {
      text-align: center;
    }
    
    .upload-text {
      font-size: 12px;
      margin-top: 8px;
    }
    
    .profile-info {
      margin-bottom: 24px;
    }
    
    .profile-display-name {
      font-size: 32px;
      font-weight: 700;
      color: white;
      margin-bottom: 4px;
    }
    
    .profile-username {
      font-size: 20px;
      font-weight: 500;
      color: var(--tesla-primary);
      margin-bottom: 12px;
      opacity: 0.9;
    }
    
    .profile-bio {
      font-size: 16px;
      opacity: 0.8;
      line-height: 1.5;
      margin-bottom: 8px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .profile-location {
      font-size: 14px;
      opacity: 0.6;
      margin-bottom: 8px;
    }
    
    .profile-joined {
      font-size: 12px;
      opacity: 0.5;
    }
    
    /* Profile Actions */
    .profile-actions {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .btn-tesla {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .btn-primary {
      background: var(--tesla-primary);
      color: #000;
    }
    
    .btn-primary:hover {
      background: #3eb3a6;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(78, 205, 196, 0.3);
    }
    
    .btn-secondary {
      background: var(--tesla-surface);
      color: white;
      border: 1px solid var(--tesla-border);
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--tesla-primary);
    }
    
    /* Dashboard Grid */
    .profile-dashboard {
      display: grid;
      gap: 24px;
      margin-top: 40px;
    }
    
    .dashboard-section {
      background: var(--tesla-surface);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--tesla-border);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .section-icon {
      font-size: 20px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
    }
    
    .stat-item {
      text-align: center;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--tesla-primary);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      opacity: 0.7;
    }
    
    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 16px;
    }
    
    .achievement {
      text-align: center;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      opacity: 0.5;
      transition: all 0.3s ease;
    }
    
    .achievement.unlocked {
      opacity: 1;
      background: rgba(78, 205, 196, 0.1);
      border: 1px solid rgba(78, 205, 196, 0.3);
    }
    
    .achievement-icon {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }
    
    .achievement-name {
      font-size: 12px;
      font-weight: 500;
    }
    
    /* Tesla Avatar Crop Modal - Mobile First */
    .tesla-crop-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(20px);
      display: flex;
      align-items: flex-end; /* Mobile: Bottom sheet */
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.2, 0, 0.2, 1);
      padding: 0;
    }
    
    .tesla-crop-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .tesla-crop-content {
      background: #1a1a2e;
      border-radius: 24px 24px 0 0; /* Mobile: Rounded top only */
      padding: 24px;
      width: 100%;
      max-width: 100vw;
      max-height: 90vh;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.2, 0, 0.2, 1);
      position: relative;
      overflow-y: auto;
    }
    
    .tesla-crop-modal.active .tesla-crop-content {
      transform: translateY(0);
    }
    
    /* Desktop: Center modal on larger screens */
    @media (min-width: 768px) {
      .tesla-crop-modal {
        align-items: center;
        padding: 20px;
      }
      
      .tesla-crop-content {
        border-radius: 16px;
        max-width: 500px;
        max-height: 80vh;
        transform: scale(0.9) translateY(20px);
      }
      
      .tesla-crop-modal.active .tesla-crop-content {
        transform: scale(1) translateY(0);
      }
    }
    
    .crop-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    
    .crop-header h3 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .tesla-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    
    .tesla-close:hover {
      background: rgba(255,255,255,0.1);
    }
    
    /* Upload Area Styles */
    .crop-upload-area {
      border: 2px dashed var(--tesla-border);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .crop-upload-area:hover {
      border-color: var(--tesla-primary);
      background: rgba(78, 205, 196, 0.05);
    }
    
    .upload-prompt svg {
      opacity: 0.6;
      margin-bottom: 16px;
    }
    
    .upload-prompt p {
      margin-bottom: 8px;
      font-size: 16px;
    }
    
    .upload-hint {
      font-size: 12px !important;
      opacity: 0.6;
    }
    
    /* Preview Container */
    .crop-preview-container {
      margin-bottom: 20px;
    }
    
    .crop-preview {
      position: relative;
      max-height: 300px;
      overflow: hidden;
      border-radius: 12px;
      background: var(--tesla-surface);
    }
    
    /* Processing Animation */
    .crop-processing {
      text-align: center;
      padding: 40px 20px;
    }
    
    .processing-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--tesla-border);
      border-top: 3px solid var(--tesla-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Edit Profile Form Styles */
    .edit-profile-form {
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--tesla-primary);
    }
    
    .form-group input[type="text"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      background: var(--tesla-surface);
      border: 1px solid var(--tesla-border);
      border-radius: 8px;
      color: white;
      font-size: 16px;
      transition: all 0.3s ease;
      font-family: inherit;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 12px center;
      background-repeat: no-repeat;
      background-size: 16px;
    }
    
    .form-group input[type="text"]:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--tesla-primary);
      background: rgba(78, 205, 196, 0.1);
      box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
    }

    .location-selects {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .location-selects select {
      margin-bottom: 0;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-hint {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 4px;
      display: block;
    }
    
    /* Tesla Toggle Switch */
    .toggle-label {
      display: flex !important;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      font-weight: 500 !important;
      margin-bottom: 0 !important;
    }
    
    .toggle-label input[type="checkbox"] {
      display: none;
    }
    
    .toggle-slider {
      width: 48px;
      height: 24px;
      background: var(--tesla-border);
      border-radius: 24px;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .toggle-slider::before {
      content: '';
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: all 0.3s ease;
    }
    
    .toggle-label input[type="checkbox"]:checked + .toggle-slider {
      background: var(--tesla-primary);
    }
    
    .toggle-label input[type="checkbox"]:checked + .toggle-slider::before {
      transform: translateX(24px);
    }
    
    .crop-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    /* Tesla Button System - Mobile First */
    .tesla-btn {
      padding: 14px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      
      /* Tesla mobile touch target */
      min-height: 48px;
      min-width: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      
      /* Tesla touch feedback */
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
    }
    
    .tesla-btn:active {
      transform: scale(0.95);
      transition: transform 0.1s ease;
    }
    
    @media (min-width: 768px) {
      .tesla-btn {
        padding: 12px 20px;
        font-size: 14px;
        min-height: auto;
      }
      
      .tesla-btn:active {
        transform: none;
      }
    }
    
    .tesla-btn.tesla-secondary {
      background: var(--tesla-surface);
      color: white;
    }
    
    .tesla-btn.tesla-primary {
      background: var(--tesla-primary);
      color: #000;
    }
    
    /* Toast Notifications */
    .success-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--tesla-primary);
      color: #000;
      padding: 16px 20px;
      border-radius: 12px;
      font-weight: 600;
      z-index: 3000;
      animation: toastSlideIn 0.3s ease;
    }
    
    @keyframes toastSlideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .profile-container {
        padding: 60px 16px 20px;
      }
      
      .profile-actions {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn-tesla {
        justify-content: center;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .achievements-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
  
  <!-- Tier Loading Skeleton CSS -->
  <link rel="stylesheet" href="./assets/tier-loading-skeleton.css">
  
  <!-- üî¨ WOZ DIAGNOSTIC: Log HEAD load time -->
  <script>
    console.timeEnd('‚è±Ô∏è HEAD_SCRIPTS');
    console.log('‚è±Ô∏è HEAD complete, BODY starting...');
    console.time('‚è±Ô∏è BODY_RENDER');
  </script>
</head>
<body>
  <!-- üé¨ STATIC SPLASH: First element rendered -->
  <div class="hi-splash-instant" id="instant-splash">
    <img src="assets/brand/hi-logo-dark.png" alt="Hi" class="hi-splash-logo" />
  </div>
  
  <script>console.log('‚è±Ô∏è BODY tag parsed');</script>
  <!-- Tesla-Grade Header (matches Dashboard pattern) -->
  <header class="tesla-header">
    <!-- Smart Calendar & Home Access -->
    <div class="header-left">
      <button id="btnCal" class="calendar-btn" aria-label="Open calendar" title="View Hi Calendar">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="3" ry="3"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      </button>
      
      <button id="btnHome" class="home-nav-btn" aria-label="Go to Hi Today" title="Navigate to Hi Today">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9,22 9,12 15,12 15,22"/>
        </svg>
      </button>
    </div>
    
    <!-- Centered Brand with Maximum Prominence -->
    <div class="header-center">
      <div class="brand-container">
        <picture class="brand-hi-logo-wrapper" aria-hidden="true">
          <source type="image/avif" srcset="assets/brand/hi-logo-192.avif 192w, assets/brand/hi-logo-512.avif 512w" sizes="32px" />
          <source type="image/webp" srcset="assets/brand/hi-logo-192.webp 192w, assets/brand/hi-logo-512.webp 512w" sizes="32px" />
          <img
            src="assets/brand/hi-logo-192.png"
            srcset="assets/brand/hi-logo-192.png 192w, assets/brand/hi-logo-512.png 512w"
            sizes="32px"
            alt=""
            aria-hidden="true"
            class="brand-hi-logo"
            width="32"
            height="32"
            decoding="async"
            fetchpriority="high"
          />
        </picture>
        <span class="brand-text">Stay Hi</span>
      </div>
    </div>
    
    <!-- Navigation & Smart Hiffirmation Access -->
    <div class="header-right">
      <!-- Contextual Hiffirmations Access -->
      <button id="hiffirmationsTrigger" class="hiffirmations-smart-pill" aria-label="Daily Hiffirmations" title="Daily Hiffirmations">
        <span class="pill-icon">‚ú®</span>
      </button>
      
      <!-- Membership Tier Indicator (Brand-consistent) -->
      <div id="hi-tier-indicator" class="tier-indicator" title="Loading tier..." data-auth-loading="true">
        <span class="tier-text tier-loading">‚è≥</span>
      </div>
      
      <button id="btnMenu" class="menu-btn" aria-label="Open menu" title="Navigation Menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFD166" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </header>
  
  <!-- Navigation Menu Modal -->
  <div id="navigationModal" class="navigation-modal" style="display: none;">
    <div class="navigation-backdrop" id="navigationBackdrop"></div>
    <div class="navigation-content">
      <div class="navigation-header">
        <h3>Stay Hi Navigation</h3>
        <button id="closeNavigation" class="close-nav-btn">‚úï</button>
      </div>
      <div class="navigation-menu">
        <div class="nav-section">
          <div class="nav-section-title">Navigate</div>
          <a href="hi-dashboard.html" class="nav-item">
            <span class="nav-icon">üè†</span>
            <span>Hi Dashboard</span>
          </a>
          <a href="hi-island-NEW.html" class="nav-item">
            <span class="nav-icon">üèùÔ∏è</span>
            <span>Hi Island</span>
          </a>
          <a href="hi-muscle.html" class="nav-item">
            <span class="nav-icon">üí™</span>
            <span>Hi Gym</span>
          </a>
          <a href="profile.html?from=profile.html" class="nav-item" style="opacity: 0.7; font-weight: 700;">
            <span class="nav-icon">üë§</span>
            <span>Profile (Current)</span>
          </a>
        </div>
        <div class="nav-section" id="adminSection" style="display: none;">
          <div class="nav-section-title">Admin</div>
          <a href="hi-mission-control.html" class="nav-item admin-item" data-mc-link>
            <span class="nav-icon">üéõÔ∏è</span>
            <span>Hi Mission Control</span>
          </a>
        </div>
      </div>
    </div>
  </div>


  
  <!-- Profile Container -->
  <div class="profile-container">
    <!-- Profile Hero Section -->
    <section class="profile-hero">
      <div class="profile-avatar-container" onclick="openAvatarCrop()">
        <img id="profileAvatar" class="profile-avatar" src="" alt="Profile avatar image" aria-describedby="profileAvatarDesc" />
        <div id="profileAvatarDesc" class="sr-only" style="position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden;">User avatar. Use the edit controls to update your image.</div>
        <div class="avatar-placeholder" id="avatarPlaceholder">
          <div class="placeholder-content">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span class="placeholder-text">Add Photo</span>
          </div>
        </div>
        <div class="avatar-upload-overlay">
          <div class="upload-content">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
              <circle cx="12" cy="13" r="3"/>
            </svg>
            <div class="upload-text">Update Photo</div>
          </div>
        </div>
        <input type="file" id="avatarFileInput" accept="image/jpeg,image/jpg,image/png,image/webp" style="display: none;" />
      </div>
      
      <div class="profile-info" data-profile-loading="true">
        <h1 id="profileDisplayName" class="profile-display-name">Loading...</h1>
        <h2 id="profileUsername" class="profile-username">@...</h2>
        <p id="profileBio" class="profile-bio">Loading profile...</p>
        <p id="profileLocation" class="profile-location">üìç ...</p>
        <p id="profileJoined" class="profile-joined">Member since October 2025</p>
      </div>
      
      <div class="profile-actions">
        <button class="btn-tesla btn-primary" onclick="editProfile()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Edit Profile
        </button>
        
        <button class="btn-tesla btn-secondary" onclick="shareProfile()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
          Share Profile
        </button>
        
        <button class="btn-tesla btn-secondary" onclick="openCalendar()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          View Calendar
        </button>
      </div>
    </section>
    
    <!-- Dashboard Grid -->
    <div class="profile-dashboard">
      <!-- Tier Perks Section -->
      <section class="dashboard-section">
        <div class="section-header">
          <span class="section-icon">üéÅ</span>
          <h3 class="section-title">Your Tier Perks</h3>
        </div>
        <div id="tierPerks" class="stats-grid">
          <div class="stat-item"><div class="stat-value">T1</div><div class="stat-label">Core access</div></div>
          <div class="stat-item"><div class="stat-value">Ôºã Daily</div><div class="stat-label">Check-in points</div></div>
          <div class="stat-item"><div class="stat-value">‚Üí Upgrade</div><div class="stat-label">More perks at T2</div></div>
        </div>
      </section>
      <!-- Statistics Section -->
      <section class="dashboard-section">
        <div class="section-header">
          <span class="section-icon">üìä</span>
          <h3 class="section-title">Hi Statistics</h3>
        </div>
        <div class="stats-grid" id="statsGrid">
          <div class="stat-item">
            <div class="stat-value" data-stat="hi_moments">‚Äî</div>
            <div class="stat-label">Hi Moments</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" data-stat="current_streak">‚Äî</div>
            <div class="stat-label">Day Streak</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" data-stat="total_waves">‚Äî</div>
            <div class="stat-label">Hi Waves</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" data-stat="personal_medallion_taps">‚Äî</div>
            <div class="stat-label">üèÖ Medallion Taps</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" data-stat="total_starts">‚Äî</div>
            <div class="stat-label">Hi Starts</div>
          </div>
        </div>
      </section>
      
      <!-- Points & Rewards Section -->
      <section class="dashboard-section">
        <div class="section-header">
          <span class="section-icon">üíé</span>
          <h3 class="section-title">Points & Rewards</h3>
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="pointsBalance">0</div>
            <div class="stat-label">Hi Points</div>
          </div>
          <div class="stat-item">
            <button id="dailyCheckinBtn" class="menu-btn" style="width:100%">Daily Check-in +5</button>
            <div class="stat-label" id="checkinStatus"></div>
            
            <!-- Initialize immediately after button -->
            <script>
              console.log('üé¨ Daily check-in button inline init...');
              (function(){
                const btn = document.getElementById('dailyCheckinBtn');
                if(!btn) { console.error('‚ùå Button not found'); return; }
                console.log('‚úÖ Button found');
                
                const tryInit = () => {
                  const client = window.supabaseClient || window.hiSupabase;
                  console.log('üîå Client check:', !!client);
                  if(!client) return false;
                  
                  console.log('‚úÖ Attaching click handler');
                  btn.addEventListener('click', async ()=>{
                    console.log('üéØ CLICKED! Calling checkin RPC...');
                    const status = document.getElementById('checkinStatus');
                    btn.disabled = true; btn.textContent = 'Checking...';
                    try {
                      // üî• FIX: Use correct RPC name - checkin_and_award_points
                      const { data, error } = await client.rpc('checkin_and_award_points');
                      console.log('üì¨ Check-in RPC response:', { data, error });
                      
                      if(error){ 
                        console.error('‚ùå Check-in error:', error);
                        status.textContent = error.message; 
                        status.style.color = '#f66'; 
                      }
                      else {
                        console.log('‚úÖ Check-in success:', data);
                        if(data?.awarded || data?.points_awarded){ 
                          const delta = data.delta || data.points_awarded || 5;
                          status.textContent = `+${delta} points!`; 
                          status.style.color = '#6c6'; 
                          
                          // Update points display
                          const el = document.getElementById('pointsBalance'); 
                          if(el && data?.new_balance) {
                            el.textContent = data.new_balance;
                            console.log('üí∞ Points updated:', data.new_balance);
                          }
                          
                          // Disable button (already checked in today)
                          btn.disabled = true;
                          btn.textContent = '‚úÖ Checked in!';
                        }
                        else { 
                          console.log('‚ÑπÔ∏è Already checked in today');
                          status.textContent = 'Already done today'; 
                          status.style.color = '#aaa'; 
                          btn.disabled = true;
                        }
                      }
                    } catch(e){ 
                      console.error('‚ùå Check-in exception:', e);
                      status.textContent = 'Error - check console'; 
                      status.style.color = '#f66';
                      btn.disabled = false;
                      btn.textContent = 'Try again';
                    }
                  });
                  return true;
                };
                
                if(tryInit()) return;
                console.log('‚è≥ Waiting for auth-ready...');
                document.addEventListener('hi:auth-ready', ()=>{
                  console.log('üîê Auth ready!');
                  tryInit();
                }, { once: true });
              })();
            </script>
          </div>
        </div>
        <div style="margin-top:14px">
          <div class="section-header" style="margin-bottom:8px">
            <span class="section-icon">üìú</span>
            <h3 class="section-title">Recent Points</h3>
          </div>
          <ul id="pointsLedger" style="list-style:none;padding:0;margin:0;display:grid;gap:8px"></ul>
        </div>
      </section>

      <!-- Achievements Section -->
      <section class="dashboard-section">
        <div class="section-header">
          <span class="section-icon">üèÜ</span>
          <h3 class="section-title">Achievements</h3>
        </div>
        <div class="achievements-grid" id="achievementsGrid">
          <div class="achievement unlocked">
            <span class="achievement-icon">üëã</span>
            <div class="achievement-name">First Hi</div>
          </div>
          <div class="achievement unlocked">
            <span class="achievement-icon">üî•</span>
            <div class="achievement-name">Week Streak</div>
          </div>
          <div class="achievement">
            <span class="achievement-icon">‚≠ê</span>
            <div class="achievement-name">Popular</div>
          </div>
          <div class="achievement unlocked">
            <span class="achievement-icon">üåç</span>
            <div class="achievement-name">Explorer</div>
          </div>
          <div class="achievement">
            <span class="achievement-icon">üë•</span>
            <div class="achievement-name">Social</div>
          </div>
          <div class="achievement">
            <span class="achievement-icon">üéñÔ∏è</span>
            <div class="achievement-name">Veteran</div>
          </div>
        </div>
      </section>

      <!-- Archives -->
      <section class="dashboard-section" id="archivesSection">
        <div class="section-header">
          <span class="section-icon">üóÇÔ∏è</span>
          <h3 class="section-title">Archives</h3>
        </div>
        <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:16px;display:grid;gap:16px;font-size:14px;line-height:1.4">
          <!-- Streak Summary -->
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
            <div style="font-weight:700">Current streak:</div>
            <div id="archivesStreakValue" style="padding:6px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:10px">‚Äî</div>
          </div>
          <!-- 35-day Heatmap -->
          <div>
            <div style="opacity:.8;margin:0 0 8px">Last 35 days</div>
            <div id="archivesHeatmap"></div>
          </div>
          <!-- Recent Check-ins -->
          <div>
            <div style="opacity:.8;margin:0 0 8px">Recent check-ins (14 days)</div>
            <div id="archivesCheckinsList" style="font-family:ui-monospace,Menlo,monospace"></div>
          </div>
          <!-- Points Summary -->
          <div>
            <div style="opacity:.8;margin:0 0 8px">Points in last 30 days</div>
            <div id="archivesPointsSummary" style="display:flex;gap:8px;flex-wrap:wrap"></div>
          </div>
        </div>
      </section>

      <!-- üèÜ Gold Standard: Profile History Timeline -->
      <section class="dashboard-section" id="historySection" style="display: none;">
        <div class="section-header">
          <span class="section-icon">üìä</span>
          <h3 class="section-title">Your Journey</h3>
        </div>
        <div id="profileHistoryTimeline" style="
          background: rgba(255,255,255,0.05);
          border: 1px solid rgba(255,255,255,0.08);
          border-radius: 14px;
          padding: 20px;
        "></div>
      </section>
    </div>
  </div>
  
  <!-- Social Avatar Uploader will create its own overlay dynamically -->
  <script src="./lib/profile-archives.js"></script>

  <!-- Tesla Edit Profile Modal -->
  <div class="tesla-crop-modal" id="editProfileModal">
    <div class="tesla-crop-content">
      <div class="crop-header">
        <h3>Edit Profile</h3>
        <button onclick="closeEditProfile()" class="tesla-close">√ó</button>
      </div>
      
      <form id="editProfileForm" class="edit-profile-form">
        <div class="form-group">
          <label for="editDisplayName">Display Name</label>
          <input type="text" id="editDisplayName" placeholder="Your display name" maxlength="50">
        </div>
        
        <div class="form-group">
          <label for="editUsername">Username</label>
          <input type="text" id="editUsername" placeholder="@username" maxlength="30">
          <small class="form-hint">Only letters, numbers, and underscores</small>
        </div>
        
        <div class="form-group">
          <label for="editBio">Bio</label>
          <textarea id="editBio" placeholder="Tell us about yourself..." maxlength="160" rows="3"></textarea>
          <small class="form-hint" id="bioCounter">0/160</small>
        </div>
        
        <div class="form-group">
          <label for="sheetLocationInput">Location</label>
          <div class="location-input-container">
            <input type="text" id="sheetLocationInput" class="form-input" placeholder="Click to select location..." maxlength="100" readonly style="cursor: pointer;" onclick="openLocationPicker()" />
          </div>
          <p class="location-privacy">üîí Only country and state/region are shared for privacy</p>
        </div>

        <!-- Tesla Security: Public profile feature removed for data protection -->
      </form>
      
      <div class="crop-actions">
        <button onclick="closeEditProfile()" class="tesla-btn tesla-secondary">Cancel</button>
        <button onclick="saveProfileChanges()" class="tesla-btn tesla-primary">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Profile Main Script (externalized) -->
  <script src="./lib/boot/profile-main.js"></script>
  <script type="module">
    
    // Tesla Profile Data - Production Ready
    // Tesla-Grade Profile System - Persistent by Default
    let currentProfile = {
      username: '',
      display_name: '', 
      bio: '',
      location: '',
      avatar_url: null,
      created_at: new Date().toISOString().split('T')[0],
      id: null
    };
    
    // Tesla Stats Data - Live Ready (loaded from database)
    let userStats = {
      hi_moments: 0,
      current_streak: 0,
      longest_streak: 0,
      total_waves: 0,
      total_starts: 0,
      days_active: 0,
      loading: true
    };

    // üéØ TESLA-GRADE: Load real user stats from database
    async function loadUserStats(userId) {
      if (!userId) {
        console.log('üìä No user ID, using default stats for anonymous');
        userStats.loading = false;
        updateStatsDisplay();
        return;
      }

      try {
        console.log('üìä Loading stats for user:', userId);
        
        // üßπ Clear any stale localStorage cache
        localStorage.removeItem('user_current_streak');
        
        // üéØ FIX: Load points balance FIRST (critical for check-in display)
        if (window.HiPoints?.getBalance) {
          try {
            const { balance } = await window.HiPoints.getBalance();
            const el = document.getElementById('pointsBalance');
            if (el) {
              el.textContent = balance || 0;
              console.log('üí∞ Points balance loaded:', balance);
            }
          } catch (e) {
            console.warn('‚ö†Ô∏è Could not load points balance:', e);
          }
        }
        
        // üéØ ALWAYS use direct Supabase query (single source of truth)
        // Skip HiBase to avoid stale data
        const supabase = window.hiSupabase || window.supabase;
        if (supabase) {
          console.log('üìä Fetching stats from SOURCE OF TRUTH (VIEW)');
          
          // üéØ WOZ ARCHITECTURAL FIX: Query VIEW that counts from public_shares
          // This ensures stats ALWAYS show correct count, never stale cache
          const queryPromise = supabase
            .from('v_user_profile_stats')
            .select('*')
            .eq('user_id', userId)
            .single();
          
          const { data, error, timedOut } = window.withQueryTimeout 
            ? await window.withQueryTimeout(queryPromise, 5000, 3)
            : await queryPromise;

          if (timedOut) {
            console.error('‚ùå Stats query timed out after retries - showing fallback');
            userStats.loading = false;
            updateStatsDisplay(); // Will show 0s
            return;
          }

          if (error && error.code !== 'PGRST116') { // PGRST116 = no rows
            console.warn('‚ö†Ô∏è Stats query error:', error.message);
            userStats.loading = false;
            updateStatsDisplay(); // Show 0s on error
            return;
          }

          if (data) {
            userStats = {
              hi_moments: data.total_hi_moments || 0,
              current_streak: data.current_streak || 0,
              longest_streak: data.longest_streak || 0,
              total_waves: data.wave_reactions_received || 0,  // Wave reactions from VIEW
              personal_medallion_taps: data.personal_medallion_taps || 0,  // NEW: Personal taps
              total_starts: data.total_starts || 0,
              days_active: data.days_active || 0,
              loading: false
            };
            console.log('‚úÖ Stats loaded from VIEW (SOURCE OF TRUTH):', userStats);
            console.log('üìä Real-time calculated values:', {
              'total_hi_moments': data.total_hi_moments,
              'wave_reactions_received': data.wave_reactions_received,
              'personal_medallion_taps': data.personal_medallion_taps,
              'current_streak': data.current_streak,
              'updated_at (from DB)': data.updated_at
            });
          } else {
            console.log('üìä No stats found, user is new - using zeros');
            userStats.loading = false;
          }
        }

        updateStatsDisplay();
      } catch (error) {
        console.error('‚ùå Failed to load user stats:', error);
        userStats.loading = false;
        updateStatsDisplay();
      }
    }
    
    // üî• CRITICAL: Expose loadUserStats globally so profile-main.js can call it
    window.loadUserStats = loadUserStats;

    // Update stats display in DOM
    function updateStatsDisplay() {
      console.log('üéØ updateStatsDisplay() called with userStats:', userStats);
      
      const statElements = {
        'hi_moments': document.querySelector('[data-stat="hi_moments"]'),
        'current_streak': document.querySelector('[data-stat="current_streak"]'),
        'longest_streak': document.querySelector('[data-stat="longest_streak"]'),
        'total_waves': document.querySelector('[data-stat="total_waves"]'),
        'personal_medallion_taps': document.querySelector('[data-stat="personal_medallion_taps"]'),
        'total_starts': document.querySelector('[data-stat="total_starts"]'),
        'days_active': document.querySelector('[data-stat="days_active"]')
      };

      Object.keys(statElements).forEach(key => {
        const el = statElements[key];
        if (el) {
          // üöÄ WOZ FIX: Show pulsing skeleton while loading, actual value when done
          if (userStats.loading) {
            el.textContent = '‚Äî';
            el.classList.add('loading');
            // üé® Add pulse animation for better UX
            el.style.animation = 'pulse 1.5s ease-in-out infinite';
          } else {
            // Show actual value or 0 (never stuck on dashes)
            const newValue = userStats[key] || 0;
            console.log(`  üìä Setting ${key} = ${newValue} (database value)`);
            el.textContent = newValue;
            el.classList.remove('loading');
            el.style.animation = ''; // Clear animation
            
            // üî• CRITICAL: Lock the value by setting data attribute
            el.setAttribute('data-db-value', newValue);
            el.setAttribute('data-last-update', Date.now());
          }
        } else {
          console.warn(`  ‚ö†Ô∏è Element not found for ${key}`);
        }
      });
      
      console.log('‚úÖ Stats display updated - all values from database');
    }

    // Optional debug overlay: ?profiledebug=1 shows live streak + milestone progress
    function initProfileDebug(){
      if (!window.location.search.includes('profiledebug=1')) return;
      if (document.getElementById('profileDebugPanel')) return;
      const panel=document.createElement('div');
      panel.id='profileDebugPanel';
      panel.style.position='fixed';panel.style.bottom='12px';panel.style.left='12px';panel.style.zIndex='9999';
      panel.style.background='rgba(30,34,40,0.85)';panel.style.color='#fff';panel.style.padding='10px 14px';panel.style.border='1px solid rgba(255,255,255,0.15)';
      panel.style.borderRadius='10px';panel.style.font='12px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif';panel.style.boxShadow='0 4px 14px rgba(0,0,0,0.4)';panel.style.backdropFilter='blur(8px)';
      panel.innerHTML='<strong>üß™ Profile Debug</strong><div id="profileDebugContent" style="margin-top:6px;font-size:11px;white-space:nowrap">Loading...</div>';
      document.body.appendChild(panel);
      refreshProfileDebug();
      setInterval(refreshProfileDebug, 9000);
    }
    function resolveProfileStreak(){
      // Attempt HiBase streak first
      let hibase=null; try{ hibase=window.HiBase?.streaks?.myStreak?.current ?? null; }catch{}
      const inlineStat=document.querySelector('[data-stat="current_streak"]');
      const uiValue=inlineStat? parseInt(inlineStat.textContent||'0',10): null;
      const stored=parseInt(localStorage.getItem('user_current_streak')||'0',10);
      const final=hibase?? uiValue?? stored?? 0;
      return { hibase, uiValue, stored, final };
    }
    function refreshProfileDebug(){
      const content=document.getElementById('profileDebugContent'); if(!content) return;
      const user=window.hiAuth?.getCurrentUser?.();
      const tier=document.querySelector('#hi-tier-indicator .tier-text')?.textContent||'Unknown';
      const streakInfo=resolveProfileStreak();
      let milestoneData={ current:null, next:null, remaining:0 };
      if (window.HiStreakMilestones){ milestoneData=window.HiStreakMilestones.describeProgress(streakInfo.final); }
      const source= streakInfo.hibase!=null? 'HiBase' : (streakInfo.uiValue!=null? 'UI':'local');
      content.innerHTML='User: '+(user?.id||'anonymous')+'<br>'+
        'Tier: '+tier+'<br>'+
        'Streak: '+streakInfo.final+' ('+source+')<br>'+
        'Milestone: '+(milestoneData.current? milestoneData.current.name+'('+milestoneData.current.threshold+')':'none')+'<br>'+
        'Next: '+(milestoneData.next? milestoneData.next.name+'('+milestoneData.next.threshold+')':'‚Äî')+' | Remaining: '+milestoneData.remaining;
    }
    document.addEventListener('DOMContentLoaded', initProfileDebug);
    
    // Social Media Grade Avatar System - Instagram/Twitter Style
    let socialAvatarUploader = null;
    
    function openAvatarCrop() {
      console.log('ÔøΩ Opening social media grade avatar uploader...');
      
      // Initialize social avatar uploader if not already done
      if (!socialAvatarUploader && window.SocialAvatarUploader) {
        try {
          socialAvatarUploader = new window.SocialAvatarUploader({
            onSave: async (blob, originalFile) => {
              console.log('üíæ Avatar saved:', {
                size: blob.size,
                type: blob.type,
                originalName: originalFile.name
              });
              
              // Convert to display URL
              const url = URL.createObjectURL(blob);
              
              // Update profile avatar immediately (like Instagram)
              updateProfileAvatar(url);
              
              // Show success message
              showToast('Profile photo updated! üéâ');
              
              // In production, upload to Supabase storage here
              console.log('ÔøΩ Production: Upload blob to Supabase storage');
              console.log('üìù Production: Update user profile with new avatar URL');
              
              // Gold Standard: Upload to Supabase Storage
              try {
                showToast('Uploading your photo... üì§');
                const publicUrl = await uploadAvatarToSupabase(blob, originalFile);
                await updateProfileInDatabase(publicUrl);
                
                // Update with permanent URL
                updateProfileAvatar(publicUrl);
                currentProfile.avatar_url = publicUrl;
                showToast('Profile photo updated! üéâ');
                
                console.log('‚úÖ Avatar successfully stored:', publicUrl);
              } catch (error) {
                console.error('‚ùå Upload failed:', error);
                showToast('Photo saved locally. Will retry upload automatically.', 'warning');
              }
              
              // Clean up local URL
              setTimeout(() => URL.revokeObjectURL(url), 30000);
            }
          });
          
          console.log('‚úÖ Social Avatar Uploader initialized successfully');
        } catch (error) {
          console.error('‚ùå Failed to initialize SocialAvatarUploader:', error);
          showToast('Avatar system unavailable. Please refresh and try again.', 'error');
          return;
        }
      }
      
      // Trigger file selection - Instagram/Twitter style
      if (socialAvatarUploader) {
        socialAvatarUploader.selectFile();
      } else {
        console.error('‚ùå Social Avatar Uploader not available');
        showToast('Avatar system not ready. Please try again.', 'error');
      }
    }
    
    // Close avatar crop modal
    function closeAvatarCrop() {
      if (socialAvatarUploader && socialAvatarUploader.close) {
        socialAvatarUploader.close();
      }
      console.log('üîí Avatar crop modal closed');
    }
    
    // Gold Standard Supabase Avatar Upload Functions
    async function uploadAvatarToSupabase(blob, originalFile) {
      console.log('üì§ Uploading avatar to Supabase Storage...');
      
      // üöÄ INTEGRATION #2: Avatar uploads via HiBase (flagged rollout)
      const useHiBase = await window.HiFlags?.getFlag('hibase_profile_enabled');
      console.log(`üîÑ Avatar upload via ${useHiBase ? 'HiBase' : 'legacy'} path`);

      if (useHiBase) {
        // üéØ HiBase path: unified API
        console.log('üì¶ Avatar ‚Üí HiBase.uploadAvatar...');
        const userId = currentProfile.id || (await window.HiSupabase.getClient().auth.getUser()).data?.user?.id || generateStableUserId();
        
        const uploadResult = await window.HiBase.uploadAvatar(blob, userId);

        if (uploadResult.error) {
          throw new Error(`HiBase avatar upload failed: ${uploadResult.error.message}`);
        }

        console.log('‚úÖ Avatar uploaded via HiBase:', uploadResult.data.avatarUrl);
        
        // üìä Track HiBase usage
        import('./lib/monitoring/HiMonitor.js').then(m => 
          m.trackEvent('profile_avatar_upload', { 
            source: 'profile', 
            path: 'hibase'
          })
        ).catch(() => {});

        return uploadResult.data.avatarUrl;

      } else {
        // üîÑ Legacy path: direct Supabase calls
        console.log('üì¶ Avatar ‚Üí Legacy Supabase...');
        
        // Enhanced debugging and validation
        console.log('üîç Supabase client check:', {
          supabaseClient: !!window.supabaseClient,
          supabase: !!window.supabase,
          sb: !!window.sb
        });

        // Test bucket connectivity first
        await testSupabaseConnection();
        
        if (!window.supabaseClient && !window.sb) {
          throw new Error('Supabase client not initialized - check supabase-init.js loading');
        }
        
        const client = window.supabaseClient || window.sb;
        
        // Check if we need authentication for uploads
        const { data: session } = await client.auth.getSession();
        console.log('üîê Auth session:', {
          hasSession: !!session?.session,
          user: session?.session?.user?.id || 'anonymous'
        });
        
        // Generate filename using stable user identity
        const timestamp = Date.now();
        const userId = currentProfile.id || generateStableUserId();
        const fileExt = originalFile.name.split('.').pop() || 'jpg';
        const fileName = `avatar_${userId}_${timestamp}.${fileExt}`;
        
        // Try different upload strategies based on auth status
        let filePath, uploadResult;
        
        if (session?.session?.user) {
          // Authenticated upload - use auth user ID
          filePath = `${session.session.user.id}/${fileName}`;
          console.log('üë§ Authenticated upload to:', filePath);
        } else {
          // Anonymous but persistent - use stable user ID  
          const persistentUserId = currentProfile.id || generateStableUserId();
          filePath = `users/${persistentUserId}/${fileName}`;
          console.log('üîí Persistent anonymous upload to:', filePath);
        }
        
        console.log('üì¶ Upload details:', {
          fileName,
          filePath,
          blobSize: blob.size,
          blobType: blob.type
        });
        
        // Upload to Supabase Storage
        uploadResult = await client.storage
          .from('avatars')
          .upload(filePath, blob, {
            contentType: blob.type,
            upsert: false
          });
        
        console.log('üì§ Upload result:', uploadResult);
        
        if (uploadResult.error) {
          console.error('‚ùå Supabase upload error:', uploadResult.error);
          
          // Try fallback strategies
          if (uploadResult.error.message?.includes('new row violates row-level security') || 
              uploadResult.error.message?.includes('insufficient_privilege')) {
            
            console.log('üîÑ Trying anonymous upload fallback...');
            const fallbackPath = `temp/${fileName}`;
            
            const fallbackResult = await client.storage
              .from('avatars')
              .upload(fallbackPath, blob, {
                contentType: blob.type,
                upsert: true // Allow overwrite for temp files
              });
            
            if (fallbackResult.error) {
              throw new Error(`Upload failed: ${fallbackResult.error.message}`);
            }
            
            filePath = fallbackPath;
          } else {
            throw new Error(`Upload failed: ${uploadResult.error.message}`);
          }
        }
        
        // Get public URL
        const { data: urlData } = client.storage
          .from('avatars')
          .getPublicUrl(filePath);
        
        console.log('üîó Generated URL:', urlData.publicUrl);
        
        // üìä Track legacy usage
        import('./lib/monitoring/HiMonitor.js').then(m => 
          m.trackEvent('profile_avatar_upload', { 
            source: 'profile', 
            path: 'legacy'
          })
        ).catch(() => {});

        return urlData.publicUrl;
      }
    }
    
    async function updateProfileInDatabase(avatarUrl) {
      console.log('üìù Updating profile in database...');
      
      if (!window.supabaseClient) {
        throw new Error('Supabase client not initialized');
      }
      
      // üöÄ INTEGRATION #2: Profile updates via HiBase (flagged rollout)
      const useHiBase = await window.HiFlags?.getFlag('hibase_profile_enabled');
      console.log(`üîÑ Profile update via ${useHiBase ? 'HiBase' : 'legacy'} path`);

      if (useHiBase) {
        // üéØ HiBase path: unified API
        console.log('üì¶ Profile ‚Üí HiBase.updateProfile...');
        const userId = currentProfile.id || (await window.HiSupabase.getClient().auth.getUser()).data?.user?.id;
        
        const updateResult = await window.HiBase.updateProfile(userId, {
          avatar_url: avatarUrl,
          updated_at: new Date().toISOString()
        });

        if (updateResult.error) {
          console.error('HiBase profile update error:', updateResult.error);
          console.log('Avatar uploaded but HiBase profile update failed - will retry');
        }

        // üìä Track HiBase usage
        import('./lib/monitoring/HiMonitor.js').then(m => 
          m.trackEvent('profile_save', { 
            source: 'profile', 
            path: 'hibase'
          })
        ).catch(() => {});

      } else {
        // üîÑ Legacy path: direct Supabase calls
        console.log('üì¶ Profile ‚Üí Legacy Supabase...');
        
        // In a real app, you'd have a user ID from auth
        // For demo, we'll use the current profile username
        const { error } = await window.supabaseClient
          .from('profiles')
          .update({ avatar_url: avatarUrl, updated_at: new Date().toISOString() })
          .eq('username', currentProfile.username);
        
        if (error) {
          console.error('Database update error:', error);
          // Don't throw - avatar is uploaded, just log the error
          console.log('Avatar uploaded but profile update failed - will retry');
        }

        // üìä Track legacy usage
        import('./lib/monitoring/HiMonitor.js').then(m => 
          m.trackEvent('profile_save', { 
            source: 'profile', 
            path: 'legacy'
          })
        ).catch(() => {});
      }
      
      // üîß CACHE FIX: Update localStorage immediately after database update
      currentProfile.avatar_url = avatarUrl;
      currentProfile.updated_at = new Date().toISOString();
      
      // Get user ID for cache key
      const user = await window.HiSupabase.getClient().auth.getUser();
      const userId = currentProfile.id || user.data?.user?.id;
      
      if (userId) {
        const storageKey = `stayhi_profile_${userId}`;
        localStorage.setItem(storageKey, JSON.stringify(currentProfile));
        console.log('‚úÖ Profile cache updated with new avatar');
      }
      
      // Trigger profile refresh event for UI consistency
      window.dispatchEvent(new CustomEvent('profile:updated', { 
        detail: { avatar_url: avatarUrl, userId } 
      }));
      
      console.log('‚úÖ Profile avatar updated in database and cache');
    }
    
    function saveAvatar() {
      // Delegate to the existing saveCroppedAvatar function
      return saveCroppedAvatar();
    }
    
    function resetCropModalState() {
      // Reset UI elements
      document.getElementById('cropUploadArea').style.display = 'block';
      document.getElementById('cropPreviewContainer').style.display = 'none';
      document.getElementById('cropProcessing').style.display = 'none';
      document.getElementById('saveCropBtn').disabled = true;
      
      // Clear file input
      const fileInput = document.getElementById('avatarFileInput');
      if (fileInput) fileInput.value = '';
      
      currentCropImageFile = null;
    }
    
    function triggerFileSelect() {
      console.log('üñ±Ô∏è Upload area clicked, triggering file select...');
      const fileInput = document.getElementById('avatarFileInput');
      if (fileInput) {
        console.log('üìÅ File input found, details:', {
          type: fileInput.type,
          accept: fileInput.accept,
          disabled: fileInput.disabled,
          style: fileInput.style.cssText
        });
        
        // Test if we can programmatically trigger
        try {
          fileInput.click();
          console.log('‚úÖ File input click triggered successfully');
        } catch (error) {
          console.error('‚ùå Error triggering file input click:', error);
        }
      } else {
        console.error('‚ùå File input not found when clicked');
      }
    }
    
    // TEST FUNCTION: Call this from console to test file input directly
    function testFileInput() {
      console.log('üß™ Testing file input functionality...');
      const fileInput = document.getElementById('avatarFileInput');
      if (fileInput) {
        console.log('File input element:', fileInput);
        console.log('Event listeners:', getEventListeners ? getEventListeners(fileInput) : 'getEventListeners not available');
        fileInput.focus();
        fileInput.click();
      }
    }
    
    // Expose for console testing
    window.testFileInput = testFileInput;
    window.triggerFileSelect = triggerFileSelect;
    
    function setupFileInputHandler() {
      const fileInput = document.getElementById('avatarFileInput');
      if (!fileInput) {
        console.error('‚ùå avatarFileInput not found');
        return false;
      }
      
      // FIXED: Don't replace element - just attach handlers directly
      console.log('üìÅ Attaching handlers directly to existing element...');
      
      // Set up fresh event handlers on original element
      fileInput.addEventListener('change', handleImageUpload, { passive: false });
      
      // Add comprehensive debugging
      fileInput.addEventListener('click', () => {
        console.log('üìÅ File input CLICKED! This should show when you click it');
      });
      
      fileInput.addEventListener('focus', () => {
        console.log('üéØ File input FOCUSED!');
      });
      
      fileInput.addEventListener('input', () => {
        console.log('ÔøΩ File input changed (input event)');
      });
      
      console.log('‚úÖ File input handler setup complete - FIXED VERSION');
      return true;
    }
    
    function setupDragAndDrop() {
      const uploadArea = document.getElementById('cropUploadArea');
      if (!uploadArea) return;
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        uploadArea.style.background = 'rgba(78, 205, 196, 0.1)';
        uploadArea.style.borderColor = 'var(--tesla-primary)';
      }
      
      function unhighlight() {
        uploadArea.style.background = '';
        uploadArea.style.borderColor = '';
      }
      
      uploadArea.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          handleImageFile(files[0]);
        }
      }
    }
    
    function handleImageUpload(e) {
      console.log('üìÅ handleImageUpload triggered:', e.type, 'Files:', e.target.files.length);
      console.log('üìÇ Files object:', e.target.files);
      
      const file = e.target.files[0];
      if (file) {
        console.log('‚úÖ File selected:', {
          name: file.name,
          type: file.type,
          size: file.size,
          lastModified: file.lastModified
        });
        handleImageFile(file);
      } else {
        console.error('‚ùå No file selected, files array:', Array.from(e.target.files));
      }
    }
    
    function handleImageFile(file) {
      console.log('üñºÔ∏è Tesla handleImageFile called:', file.name, file.type, file.size);
      
      // Tesla-grade validation
      if (!file.type.startsWith('image/')) {
        showToast('Please select a valid image file', 'error');
        console.error('‚ùå Invalid file type:', file.type);
        return;
      }
      
      if (file.size > 10 * 1024 * 1024) { // 10MB limit
        showToast('Image size must be less than 10MB', 'error');
        console.error('‚ùå File too large:', file.size);
        return;
      }
      
      currentCropImageFile = file;
      console.log('‚úÖ File validation passed, processing...');
      
      // Show processing state
      const uploadArea = document.getElementById('cropUploadArea');
      const processingEl = document.getElementById('cropProcessing');
      
      if (uploadArea) uploadArea.style.display = 'none';
      if (processingEl) processingEl.style.display = 'block';
      
      console.log('üîÑ Showing processing state...');
      
      // Load and display image for cropping
      const reader = new FileReader();
      reader.onload = function(e) {
        console.log('üìñ FileReader loaded image data');
        
        const imgElement = document.getElementById('cropImagePreview');
        if (!imgElement) {
          console.error('‚ùå cropImagePreview element not found');
          return;
        }
        
        imgElement.src = e.target.result;
        console.log('üñºÔ∏è Image src set, waiting for load...');
        
        // Wait for image to load before showing preview
        imgElement.onload = function() {
          console.log('‚úÖ Image loaded in DOM, showing preview...');
          console.log('üñºÔ∏è Image loaded details:', {
            complete: imgElement.complete,
            naturalWidth: imgElement.naturalWidth,
            naturalHeight: imgElement.naturalHeight,
            width: imgElement.width,
            height: imgElement.height,
            src: imgElement.src.substring(0, 50) + '...'
          });
          
          // Show preview container
          setTimeout(() => {
            const processingEl = document.getElementById('cropProcessing');
            const previewContainer = document.getElementById('cropPreviewContainer');
            
            if (processingEl) processingEl.style.display = 'none';
            if (previewContainer) {
              previewContainer.style.display = 'block';
              console.log('‚úÖ Preview container is now visible');
            }
            
            console.log('üéØ Preview container shown, initializing Tesla cropper...');
            
            // Ensure image has rendered dimensions before cropper init
            setTimeout(() => {
              console.log('üîÑ Final check before cropper init:', {
                imgRect: imgElement.getBoundingClientRect(),
                containerRect: document.getElementById('cropPreview').getBoundingClientRect()
              });
              
              // Initialize Tesla cropper
              initializeTeslaCropper(imgElement);
            }, 100);
            
          }, 300); // Reduced delay for better UX
        };
        
        imgElement.onerror = function() {
          console.error('‚ùå Failed to load image in DOM');
          showToast('Failed to load image. Please try again.', 'error');
        };
      };
      
      reader.onerror = function() {
        console.error('‚ùå FileReader failed');
        showToast('Failed to read file. Please try again.', 'error');
      };
      
      reader.readAsDataURL(file);
    }
    
    function initializeTeslaCropper(imgElement) {
      console.log('üöÄ Initializing Tesla cropper...');
      console.log('Tesla classes available:', {
        TeslaAvatarCropper: !!window.TeslaAvatarCropper,
        TeslaAvatarUploader: !!window.TeslaAvatarUploader,
        teslaAvatarCropper: !!teslaAvatarCropper
      });
      
      // Debug DOM elements
      console.log('üîç DOM elements debug:', {
        imgElement: !!imgElement,
        imgSrc: imgElement ? imgElement.src?.substring(0, 50) + '...' : 'none',
        imgDimensions: imgElement ? `${imgElement.width}x${imgElement.height}` : 'none',
        cropPreview: !!document.getElementById('cropPreview'),
        cropPreviewContainer: !!document.getElementById('cropPreviewContainer')
      });
      
      // Ensure Tesla cropper is initialized
      // Lazy load cropper if library not yet present
      if (!window.TeslaAvatarCropper) {
        console.log('‚è≥ TeslaAvatarCropper not loaded yet, invoking lazy loader...');
        const loader = window.HiLazy ? window.HiLazy.loadTeslaAvatarCropper() : Promise.resolve(window.TeslaAvatarCropper);
        loader.then(() => {
          if (window.TeslaAvatarCropper && !teslaAvatarCropper) {
            console.log('üîß Creating new Tesla cropper instance (lazy)...');
            teslaAvatarCropper = new window.TeslaAvatarCropper();
            console.log('‚úÖ Tesla cropper instance created after lazy load:', !!teslaAvatarCropper);
            // Re-run initialization now that cropper is available
            initializeTeslaCropper(imgElement);
          }
        }).catch(err => {
          console.error('‚ùå Failed to load tesla-avatar-cropper.js lazily:', err);
          showToast('Failed to load cropper library. Retry later.', 'error');
        });
        return; // Exit until library loads
      }

      if (!teslaAvatarCropper && window.TeslaAvatarCropper) {
        console.log('üîß Creating new Tesla cropper instance (eager)...');
        teslaAvatarCropper = new window.TeslaAvatarCropper();
        console.log('‚úÖ Tesla cropper instance created:', !!teslaAvatarCropper);
      }
      
      if (teslaAvatarCropper) {
        const previewContainer = document.getElementById('cropPreview');
        if (previewContainer) {
          console.log('üìê Container info:', {
            containerRect: previewContainer.getBoundingClientRect(),
            containerStyle: getComputedStyle(previewContainer).position,
            imgLoaded: imgElement.complete,
            imgNaturalDimensions: `${imgElement.naturalWidth}x${imgElement.naturalHeight}`
          });
          
          try {
            console.log('üéØ Calling teslaAvatarCropper.initCropper...');
            const result = teslaAvatarCropper.initCropper(imgElement, previewContainer);
            console.log('üîß Cropper init result:', result);
            
            document.getElementById('saveCropBtn').disabled = false;
            
            console.log('‚úÖ Tesla cropper initialized successfully');
            showToast('Image loaded! Drag to adjust crop area üéØ');
          } catch (error) {
            console.error('‚ùå Tesla cropper initialization failed:', error);
            console.error('‚ùå Full error stack:', error.stack);
            showToast('Failed to initialize cropper. Please try again.', 'error');
          }
        } else {
          console.error('‚ùå cropPreview container not found');
        }
      } else {
        console.error('‚ùå Tesla cropper not available');
        showToast('Cropper not available. Please refresh and try again.', 'error');
      }
    }
    
    async function saveCroppedAvatar() {
      if (!teslaAvatarCropper || !currentCropImageFile) {
        showToast('No image to save', 'error');
        return;
      }
      
      try {
        // Show processing state
        document.getElementById('cropProcessing').style.display = 'block';
        document.getElementById('cropPreviewContainer').style.display = 'none';
        
        // Get cropped image data from Tesla cropper
        const croppedBlob = await teslaAvatarCropper.getCroppedImage(0.9);
        
        if (!croppedBlob) {
          throw new Error('Failed to generate cropped image');
        }
        
        // Tesla-grade upload with progress
        let avatarUrl;
        if (teslaAvatarUploader) {
          avatarUrl = await teslaAvatarUploader.uploadAvatar(croppedBlob, currentProfile.username);
        } else {
          // Fallback: Create data URL for demo
          avatarUrl = await blobToDataURL(croppedBlob);
        }
        
        // Update profile avatar
        updateProfileAvatar(avatarUrl);
        
        showToast('Tesla-grade avatar saved successfully! üöÄ');
        
        // üìä Analytics: Track successful profile save
        import('./lib/monitoring/HiMonitor.js').then(m => 
          m.trackEvent('profile_save', { avatar: true })
        ).catch(() => {}); // Silent fail
        
        closeAvatarCrop();
        
      } catch (error) {
        console.error('Avatar save error:', error);
        showToast('Failed to save avatar. Please try again.', 'error');
        
        // Reset to preview state
        document.getElementById('cropProcessing').style.display = 'none';
        document.getElementById('cropPreviewContainer').style.display = 'block';
      }
    }
    
    function updateProfileAvatar(avatarUrl) {
      const avatarEl = document.getElementById('profileAvatar');
      const placeholderEl = document.getElementById('avatarPlaceholder');
      
      console.log('üñºÔ∏è Updating profile avatar:', { avatarUrl, avatarEl: !!avatarEl, placeholderEl: !!placeholderEl });
      
      if (avatarEl && placeholderEl) {
        if (avatarUrl) {
          avatarEl.src = avatarUrl;
          avatarEl.style.display = 'block';
          placeholderEl.style.display = 'none';
          console.log('‚úÖ Avatar displayed:', avatarUrl);
        } else {
          avatarEl.style.display = 'none';
          placeholderEl.style.display = 'block';
          console.log('üì∑ Avatar placeholder displayed - no avatar URL');
        }
      } else {
        console.error('‚ùå Avatar elements not found:', { avatarEl: !!avatarEl, placeholderEl: !!placeholderEl });
      }
    }
    
    function blobToDataURL(blob) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    // Tesla-Grade Location Picker Integration
    function openLocationPicker() {
      console.log('üåç Opening location picker...');
      if (window.LocationPicker) {
        window.LocationPicker.show((result) => {
          const locationInput = document.getElementById('sheetLocationInput');
          if (locationInput) {
            locationInput.value = result.formatted;
            console.log('üìç Location selected:', result.formatted);
          }
        });
      } else {
        console.error('‚ùå LocationPicker not available');
      }
    }
    
    // Hi-Island Calendar Integration
    function openCalendar() {
      console.log('üìÖ Opening premium calendar...');
      
      // Integration with premium-calendar.js - use instance method
      if (window.hiCalendarInstance && typeof window.hiCalendarInstance.show === 'function') {
        window.hiCalendarInstance.show();
      } else if (window.PremiumCalendar) {
        // Initialize if not already done
        if (!window.hiCalendarInstance) {
          window.hiCalendarInstance = new window.PremiumCalendar();
        }
        window.hiCalendarInstance.show();
      } else {
        console.error('‚ùå Calendar not available - premium-calendar.js not loaded');
        // Fallback: Navigate to calendar page
        window.location.href = 'calendar.html';
      }
    }

    function openEditCalendar() {
      console.log('üìÖ Opening calendar from edit modal...');
      
      // Use the same premium calendar system
      if (window.PremiumCalendar && window.PremiumCalendar.show) {
        window.PremiumCalendar.show();
      } else {
        // Fallback: Navigate to calendar page
        window.location.href = 'calendar.html';
      }
    }

    async function testSupabaseConnection() {
      console.log('üîß Testing Supabase storage connection...');
      
      const client = window.supabaseClient || window.sb;
      if (!client) {
        throw new Error('No Supabase client available');
      }

      try {
        // Test 1: Check if we can access the avatars bucket
        console.log('üß™ Test 1: Checking bucket access...');
        const { data: buckets, error: bucketError } = await client.storage.listBuckets();
        
        if (bucketError) {
          console.warn('‚ö†Ô∏è Cannot list buckets:', bucketError.message);
          console.log('üîÑ Trying alternative bucket test...');
          
          // Alternative: try to list files in avatars bucket
          const { data: files, error: filesError } = await client.storage
            .from('avatars')
            .list('', { limit: 1 });
            
          if (filesError) {
            console.error('‚ùå Bucket not accessible:', filesError.message);
            throw new Error(`Avatars bucket not accessible: ${filesError.message}`);
          }
          
          console.log('‚úÖ Avatars bucket is accessible via file listing');
        } else {
          const avatarsBucket = buckets?.find(b => b.name === 'avatars');
          if (avatarsBucket) {
            console.log('‚úÖ Avatars bucket found:', avatarsBucket);
          } else {
            console.error('‚ùå Avatars bucket not found in:', buckets?.map(b => b.name));
            throw new Error('Avatars bucket does not exist');
          }
        }

        // Test 2: Check authentication status
        const { data: session } = await client.auth.getSession();
        console.log('üîê Auth status:', {
          authenticated: !!session?.session,
          userId: session?.session?.user?.id || 'none',
          role: session?.session?.user?.role || 'anonymous'
        });

        // Test 3: Check storage policies with a small test
        console.log('üß™ Test 3: Testing upload permissions...');
        const testBlob = new Blob(['test'], { type: 'text/plain' });
        const testPath = `test/${Date.now()}_test.txt`;
        
        const { error: testError } = await client.storage
          .from('avatars')
          .upload(testPath, testBlob, { upsert: false });
          
        if (testError) {
          console.warn('‚ö†Ô∏è Test upload failed:', testError.message);
          if (testError.message.includes('row-level security')) {
            console.log('üîí RLS policies blocking upload. Need to add anonymous upload policy.');
            console.log('üìã SQL to run in Supabase:');
            console.log(`
CREATE POLICY "Allow anonymous uploads to temp folder" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'avatars' 
  AND storage.foldername(name) = 'temp'
);`);
          }
        } else {
          console.log('‚úÖ Test upload succeeded - will clean up');
          // Clean up test file
          await client.storage.from('avatars').remove([testPath]);
        }
        
        console.log('üéØ Storage connection test complete');
        
      } catch (error) {
        console.error('üí• Storage connection test failed:', error);
        throw error;
      }
    }
    
    // Tesla-Grade Edit Profile System
    function editProfile() {
      console.log('üöÄ Opening Tesla edit profile modal...');
      const modal = document.getElementById('editProfileModal');
      modal.classList.add('active');
      
      // üîß WOZ FIX: Prevent clicks during slide-up animation (400ms)
      modal.style.pointerEvents = 'none';
      setTimeout(() => {
        modal.style.pointerEvents = 'auto';
      }, 400);
      
      // Populate current profile data
      populateEditForm();
      
      showToast('Edit your profile details below üìù');
    }
    
    function closeEditProfile() {
      const modal = document.getElementById('editProfileModal');
      modal.classList.remove('active');
    }
    
    // üîß WOZ FIX: Add defensive backdrop click handler
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('editProfileModal');
      
      if (!modal) {
        console.warn('‚ö†Ô∏è editProfileModal not found');
        return;
      }
      
      // Close modal when clicking backdrop (not content)
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          console.log('üéØ Backdrop clicked - closing modal');
          closeEditProfile();
          e.stopPropagation();
        }
      });
      
      // Close modal on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          console.log('‚å®Ô∏è Escape pressed - closing modal');
          closeEditProfile();
        }
      });
      
      console.log('‚úÖ Profile modal event listeners attached');
    });
    
    function populateEditForm() {
      const displayNameEl = document.getElementById('editDisplayName');
      const usernameEl = document.getElementById('editUsername');
      const bioEl = document.getElementById('editBio');
      const locationEl = document.getElementById('editLocation');
      
      if (displayNameEl) displayNameEl.value = currentProfile.display_name || '';
      if (usernameEl) usernameEl.value = currentProfile.username || '';
      if (bioEl) bioEl.value = currentProfile.bio || '';
      if (locationEl) locationEl.value = currentProfile.location || '';
      // Tesla Security: Public profile feature removed
      
      // Update bio counter
      updateBioCounter();
      
      // Setup form listeners
      setupEditFormListeners();
    }
    
    function setupEditFormListeners() {
      const bioTextarea = document.getElementById('editBio');
      const usernameInput = document.getElementById('editUsername');
      
      // Bio counter
      bioTextarea.addEventListener('input', updateBioCounter);
      
      // Username validation
      usernameInput.addEventListener('input', function() {
        let value = this.value.replace(/[^a-zA-Z0-9_]/g, '');
        if (value && !value.startsWith('@')) {
          value = '@' + value;
        }
        this.value = value;
      });
    }
    
    function updateBioCounter() {
      const bioTextarea = document.getElementById('editBio');
      const counter = document.getElementById('bioCounter');
      const length = bioTextarea.value.length;
      counter.textContent = `${length}/160`;
      
      if (length > 140) {
        counter.style.color = '#FFD93D'; // Warning color
      } else if (length > 160) {
        counter.style.color = '#FF6B6B'; // Error color
      } else {
        counter.style.color = ''; // Reset
      }
    }
    
    async function saveProfileChanges() {
      const formData = {
        display_name: document.getElementById('editDisplayName').value.trim(),
        username: document.getElementById('editUsername').value.replace('@', '').trim(),
        bio: document.getElementById('editBio').value.trim()
      };

      // Get location from LocationPicker input (Tesla-grade single source of truth)
      const locationInput = document.getElementById('sheetLocationInput');
      formData.location = locationInput ? locationInput.value.trim() : '';
      
      // Tesla-grade validation
      if (!formData.display_name) {
        showToast('Display name is required', 'error');
        return;
      }
      
      if (!formData.username || formData.username.length < 3) {
        showToast('Username must be at least 3 characters', 'error');
        return;
      }
      
      if (formData.bio.length > 160) {
        showToast('Bio must be 160 characters or less', 'error');
        return;
      }
      
      try {
        // üèÜ GOLD STANDARD: Use ProfileManager for updates
        if (window.ProfileManager && window.ProfileManager._initialized) {
          console.log('‚úÖ Saving profile via ProfileManager');
          
          const result = await window.ProfileManager.updateProfile(formData);
          
          if (!result.success) {
            throw new Error(result.error?.message || 'Profile update failed');
          }
          
          // Update current profile from ProfileManager
          const updatedProfile = window.ProfileManager.getProfile();
          Object.assign(currentProfile, updatedProfile);
          
          console.log('‚úÖ Profile saved via ProfileManager');
        } else {
          // Fallback to legacy method
          console.warn('‚ö†Ô∏è ProfileManager not available, using fallback');
          
          const client = window.supabaseClient || window.hiSupabase || window.sb || window.__HI_SUPABASE_CLIENT;
          if (!client) {
            throw new Error('No Supabase client available');
          }
          
          const { data: { user } } = await client.auth.getUser();
          const userId = user?.id;
          
          Object.assign(currentProfile, formData);
          if (userId && !currentProfile.id) currentProfile.id = userId;
          if (user?.email && !currentProfile.email) currentProfile.email = user.email;
          
          await saveProfileToStorage(currentProfile, userId);
        }
        
        // Update UI immediately for instant feedback
        updateProfileDisplay(currentProfile);
        
        // Close modal
        closeEditProfile();
        
        showToast('Profile saved successfully! üéâ', 'success');
        console.log('‚úÖ Profile persisted:', formData);
        
      } catch (error) {
        console.error('‚ùå Profile save error:', error);
        showToast('Failed to save profile. Please try again.', 'error');
      }
    }

    // Tesla-Grade Secure Multi-Layer Persistence Strategy
    async function saveProfileToStorage(profile, userId = null) {
      const profileData = {
        ...profile,
        last_updated: new Date().toISOString(),
        version: '1.0'
      };

      try {
        // Determine storage key based on authentication
        const storageKey = userId ? `stayhi_profile_${userId}` : 'stayhi_profile_demo';
        
        // Layer 1: User-specific Local Storage (immediate persistence)
        localStorage.setItem(storageKey, JSON.stringify(profileData));
        console.log(`üíæ Profile saved to localStorage: ${storageKey}`);

        // Layer 2: Supabase Database (cloud persistence) - ONLY for authenticated users
        const client = window.supabaseClient || window.hiSupabase || window.sb || window.__HI_SUPABASE_CLIENT;
        if (client && userId) {
          await saveProfileToSupabase(profileData);
        } else if (!userId) {
          console.log('üé≠ Demo profile - skipping Supabase sync');
        }

        // Layer 3: Session backup with user context
        sessionStorage.setItem(`stayhi_profile_backup_${userId || 'demo'}`, JSON.stringify(profileData));
        
      } catch (error) {
        console.error('Storage save error:', error);
        throw error;
      }
    }

    async function saveProfileToSupabase(profile) {
      try {Supabase client with fallback
        const client = window.supabaseClient || window.hiSupabase || window.sb || window.__HI_SUPABASE_CLIENT;
        if (!client) {
          console.warn('‚ö†Ô∏è No Supabase client available');
          return;
        }
        
        // Get authenticated user's UUID
        const { data: { user } } = await client.auth.getUser();
        if (!user) {
          console.warn('‚ö†Ô∏è No authenticated user - cannot save to Supabase');
          return;
        }

        console.log('üì§ SAVING TO SUPABASE:', {
          id: user.id,
          username: profile.username,
          display_name: profile.display_name,
          avatar_url: profile.avatar_url
        });

        const { data, error } = await c
        const { data, error } = await window.supabaseClient
          .from('profiles')
          .upsert({
            id: user.id, // Use auth user UUID, not username
            username: profile.username,
            display_name: profile.display_name,
            bio: profile.bio,
            location: profile.location,
            avatar_url: profile.avatar_url,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'id' // PRIMARY KEY is 'id', not 'username'
          });

        if (error) {
          console.error('‚ùå SUPABASE SAVE FAILED:', error);
          throw error; // Make it visible!
        } else {
          console.log('‚úÖ SUPABASE SAVE SUCCESS');
          console.log('üìä Saved data:', data);
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Supabase unavailable:', error.message);
        // Graceful degradation - localStorage still works
      }
    }
    
    function shareProfile() {
      const profileUrl = `${window.location.origin}/profile/${currentProfile.username}`;
      
      if (navigator.share) {
        navigator.share({
          title: `${currentProfile.display_name} on Stay Hi`,
          text: `Check out ${currentProfile.display_name}'s Hi profile!`,
          url: profileUrl
        });
      } else {
        navigator.clipboard.writeText(profileUrl);
        showToast('Profile link copied to clipboard! üìã');
      }
    }
    
    // Tesla-Grade Toast System
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      
      // Tesla-grade styling based on type
      const baseStyles = {
        position: 'fixed',
        bottom: '20px',
        left: '50%',
        transform: 'translateX(-50%)',
        padding: '12px 20px',
        borderRadius: '8px',
        color: 'white',
        fontWeight: '500',
        fontSize: '14px',
        zIndex: '3000',
        opacity: '0',
        transition: 'opacity 0.3s ease',
        maxWidth: '80vw',
        textAlign: 'center'
      };
      
      const typeStyles = {
        success: { background: 'rgba(78, 205, 196, 0.9)', border: '1px solid #4ECDC4' },
        error: { background: 'rgba(255, 107, 107, 0.9)', border: '1px solid #FF6B6B' },
        info: { background: 'rgba(255, 217, 61, 0.9)', border: '1px solid #FFD93D', color: '#000' }
      };
      
      // Apply styles
      Object.assign(toast.style, baseStyles, typeStyles[type] || typeStyles.success);
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      // Tesla-grade animation
      setTimeout(() => toast.style.opacity = '1', 10);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // Expose globally for Tesla avatar system
    window.showTeslaToast = showToast;
    
    // Tesla Profile Display Update System
    function updateProfileDisplay(profileData) {
      // üî• CRITICAL DEBUG: Log stack trace to see WHO is calling this
      console.log('üîÑ Updating profile display...', profileData);
      console.trace('üìç updateProfileDisplay call stack');
      console.log('üîç DEBUG: profileData fields:', {
        username: profileData?.username,
        display_name: profileData?.display_name,
        bio: profileData?.bio,
        location: profileData?.location,
        avatar_url: profileData?.avatar_url
      });
      
      // üõë CRITICAL: Don't update if profileData is empty/invalid
      if (!profileData || (!profileData.username && !profileData.display_name)) {
        console.error('‚ùå BLOCKED: updateProfileDisplay called with empty profileData!', profileData);
        return;
      }
      
      // Update username
      const usernameEl = document.getElementById('profileUsername');
      if (usernameEl && profileData.username) {
        usernameEl.textContent = `@${profileData.username}`;
      }
      
      // Update display name
      const displayNameEl = document.getElementById('profileDisplayName');
      if (displayNameEl) {
        displayNameEl.textContent = profileData.display_name || 'Stay Hi User';
      }
      
      // Update bio
      const bioEl = document.getElementById('profileBio');
      if (bioEl) {
        bioEl.textContent = profileData.bio || 'No bio yet. Click edit to add one!';
      }
      
      // Update location
      const locationEl = document.getElementById('profileLocation');
      if (locationEl) {
        locationEl.textContent = profileData.location || 'Location not set';
      }
      
      // Update joined date
      const joinedEl = document.getElementById('profileJoined');
      if (joinedEl && profileData.created_at) {
        const joinDate = new Date(profileData.created_at);
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        joinedEl.textContent = `Joined ${monthNames[joinDate.getMonth()]} ${joinDate.getFullYear()}`;
      }
      
      // Update avatar if available
      if (profileData.avatar_url) {
        updateProfileAvatar(profileData.avatar_url);
      }
      
      // üéØ GOLD STANDARD: Remove loading state to fade in real content (no flash)
      const profileInfo = document.querySelector('.profile-info');
      if (profileInfo) {
        profileInfo.setAttribute('data-profile-loading', 'false');
      }
      
      console.log('‚úÖ Profile display updated');
    }
    
    // Tesla Stats Display System (with animation)
    function animateStatsDisplay(statsData) {
      console.log('üìä Animating stats display...', statsData);
      
      // Update individual stat values with Tesla-grade animation
      Object.entries(statsData).forEach(([key, value], index) => {
        const statEl = document.querySelector(`[data-stat="${key}"]`);
        if (statEl) {
          // Tesla-grade counting animation
          setTimeout(() => {
            animateCounter(statEl, 0, value, 800);
          }, index * 100);
        }
      });
      
      console.log('‚úÖ Stats display updated');
    }
    
    function animateCounter(element, start, end, duration) {
      const range = end - start;
      const startTime = performance.now();
      
      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Tesla-grade easing
        const easeOutQuart = 1 - Math.pow(1 - progress, 4);
        const current = Math.floor(start + (range * easeOutQuart));
        
        element.textContent = current.toLocaleString();
        
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      
      requestAnimationFrame(update);
    }
    
    // Tesla Avatar System Validation
    function validateTeslaAvatarSystem() {
      console.log('üîç Validating Tesla Avatar System...');
      
      const validations = {
        'TeslaAvatarCropper': !!window.TeslaAvatarCropper,
        'TeslaAvatarUploader': !!window.TeslaAvatarUploader,
        'Avatar Modal': !!document.getElementById('avatarCropModal'),
        'File Input': !!document.getElementById('avatarFileInput'),
        'Preview Container': !!document.getElementById('cropPreviewContainer'),
        'Toast System': typeof showToast === 'function'
      };
      
      let allValid = true;
      Object.entries(validations).forEach(([name, isValid]) => {
        const status = isValid ? '‚úÖ' : '‚ùå';
        console.log(`${status} ${name}: ${isValid}`);
        if (!isValid) allValid = false;
      });
      
      if (allValid) {
        console.log('üöÄ Tesla Avatar System: READY');
        return true;
      } else {
        console.error('üö´ Tesla Avatar System: INCOMPLETE');
        return false;
      }
    }
    
    // Tesla System Initialization
    function initializeTeslaAvatarSystem() {
      console.log('üîß Initializing Tesla Avatar System...');
      
      // Wait for Tesla classes to be available
      let attempts = 0;
      const maxAttempts = 50; // 5 seconds max
      
      const checkInterval = setInterval(() => {
        attempts++;
        
        if (window.TeslaAvatarCropper && window.TeslaAvatarUploader) {
          clearInterval(checkInterval);
          console.log('‚úÖ Tesla classes available, system ready');
          validateTeslaAvatarSystem();
          return;
        }
        
        if (attempts >= maxAttempts) {
          clearInterval(checkInterval);
          console.error('‚ùå Tesla classes not available after 5 seconds');
          showToast('Avatar system failed to load. Please refresh the page.', 'error');
          return;
        }
        
        console.log(`‚è≥ Waiting for Tesla classes... (${attempts}/${maxAttempts})`);
      }, 100);
    }
    
    // Avatar system will be initialized from main DOMContentLoaded handler
    
    // Tesla-Grade Secure Data Loading
    // üõë WOZ DEFENSE: Resilient Supabase client getter (handles module loading race)
    async function getSupabaseClient(maxRetries = 10, delayMs = 100) {
      for (let i = 0; i < maxRetries; i++) {
        const client = window.supabaseClient || window.hiSupabase || window.sb || window.__HI_SUPABASE_CLIENT;
        if (client && client.auth) {
          if (i > 0) console.log(`‚úÖ Supabase client ready after ${i} retries`);
          return client;
        }
        if (i === 0) console.log('‚è≥ Waiting for Supabase client to initialize...');
        await new Promise(resolve => setTimeout(resolve, delayMs));
      }
      throw new Error('Supabase client not available after retries');
    }

    async function loadProfileData(sessionParam = null) {
      console.log('üîÑ Loading profile data with Tesla-grade security...');
      
      // Get session from parameter or ProfileManager
      const session = sessionParam || (await window.ProfileManager?.getSession?.());
      
      // Race mitigation: prevent duplicate secure loads triggered by timers + events
      if (window.__PROFILE_DATA_LOADED) {
        console.log('[ProfileRace] loadProfileData skipped (already loaded)');
        return;
      }
      
      try {
        // üèÜ GOLD STANDARD: Use ProfileManager as single source of truth
        if (!window.ProfileManager) {
          console.warn('‚ö†Ô∏è ProfileManager not available, using fallback');
          await loadProfileFallback();
          return;
        }
        
        console.log('‚úÖ Using ProfileManager as single source of truth');
        
        // üî• CRITICAL: ProfileManager._waitForAuth() hangs if called INSIDE auth-ready handler!
        // Manually set auth state to avoid circular wait
        if (session?.user && !window.ProfileManager._initialized) {
          console.log('üöÄ Manually initializing ProfileManager from auth-ready...');
          window.ProfileManager._userId = session.user.id;
          window.ProfileManager._authReady = true;
          
          // Load profile from database directly
          try {
            const sb = window.hiSupabase || window.supabase;
            if (sb) {
              const { data: dbProfile } = await sb
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();
              
              if (dbProfile) {
                window.ProfileManager._profile = dbProfile;
                console.log('‚úÖ Profile loaded from database:', dbProfile.username);
              }
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è Could not load profile from DB:', error);
          }
          
          window.ProfileManager._initialized = true;
        }
        
        // Check if user is authenticated
        const isAuth = window.ProfileManager.isAuthenticated();
        console.log('üîê Authentication status:', isAuth ? 'AUTHENTICATED ‚úÖ' : 'ANONYMOUS ‚ö†Ô∏è');
        
        if (!isAuth) {
          console.log('üö® Anonymous user detected - checking localStorage as fallback...');
          
          // üî• CRITICAL FIX: Check localStorage for session before redirecting
          // Prevents redirect when token refresh fails due to network issues (Brave Incognito)
          const localStorageKey = 'sb-gfcubvroxgfvjhacinic-auth-token';
          const localSession = localStorage.getItem(localStorageKey);
          
          if (localSession) {
            try {
              const parsed = JSON.parse(localSession);
              const hasValidSession = parsed?.access_token && parsed?.user?.id;
              
              if (hasValidSession) {
                console.log('‚úÖ Valid session found in localStorage - staying on page despite network failure');
                console.log('üîÑ Continuing to load profile from cached session...');
                // Don't redirect - session exists in localStorage, just network is failing
              } else {
                throw new Error('Invalid session format');
              }
            } catch (e) {
              console.error('‚ùå localStorage session parse failed:', e);
              // Only redirect if localStorage also has no valid session
              const isLocal = window.location.hostname === 'localhost';
              const signinPath = isLocal ? '/public/signin.html' : '/signin.html';
              const redirectUrl = signinPath + '?redirect=' + encodeURIComponent(window.location.pathname);
              console.log('üîÑ Redirecting to:', redirectUrl);
              window.location.href = redirectUrl;
              return;
            }
          } else {
            console.log('‚ùå No localStorage session found');
            // Redirect to signin
            const isLocal = window.location.hostname === 'localhost';
            const signinPath = isLocal ? '/public/signin.html' : '/signin.html';
            const redirectUrl = signinPath + '?redirect=' + encodeURIComponent(window.location.pathname);
            console.log('üîÑ Redirecting to:', redirectUrl);
            window.location.href = redirectUrl;
            return;
          }
        }
        
        // Get profile from ProfileManager (always current)
        const profile = window.ProfileManager.getProfile();
        const userId = window.ProfileManager.getUserId();
        
        console.log('‚úÖ Profile loaded from ProfileManager:', {
          id: userId,
          username: profile?.username,
          display_name: profile?.display_name
        });
        
        // Update current profile and UI
        Object.assign(currentProfile, profile);
        updateProfileDisplay(currentProfile);
        populateEditForm(currentProfile);
        
        // üéØ TESLA-GRADE: Load real user stats (non-blocking for instant page render)
        loadUserStats(userId);
        
        // üî• FIX: Remove tier loading spinner after auth complete
        const tierIndicator = document.getElementById('hi-tier-indicator');
        if (tierIndicator) {
          tierIndicator.removeAttribute('data-auth-loading');
          const tierText = tierIndicator.querySelector('.tier-text');
          if (tierText && tierText.classList.contains('tier-loading')) {
            // Wait for HiTier to initialize
            if (window.HiTier) {
              const tier = window.HiTier.getTier();
              tierText.textContent = tier.toUpperCase();
              tierText.classList.remove('tier-loading');
            } else {
              // Fallback if HiTier not ready yet
              setTimeout(() => {
                if (window.HiTier) {
                  const tier = window.HiTier.getTier();
                  tierText.textContent = tier.toUpperCase();
                  tierText.classList.remove('tier-loading');
                }
              }, 500);
            }
          }
        }
        
        console.log('‚úÖ Profile loaded successfully from ProfileManager');
        try { window.HiAudit?.log('profile_load_authenticated', { resource:'profile' }); } catch {}
        
      } catch (error) {
        console.error('‚ùå Profile loading error:', error);
        console.error('‚ùå Error stack:', error.stack);
        
        // Fallback to legacy method
        console.warn('‚ö†Ô∏è Falling back to legacy profile loading');
        await loadProfileFallback();
        
        try { window.HiAudit?.log('profile_load_error', { resource:'profile' }, { success:false, failureReason: error.message }); } catch {}
      }
      
      window.__PROFILE_DATA_LOADED = true;
    }
    
    // Fallback method (legacy)
    async function loadProfileFallback() {
      try {
        // üõë WOZ FIX: Wait for Supabase client to be ready
        console.log('üîê [FALLBACK] Checking authentication status...');
        const supabase = await getSupabaseClient();
        console.log('‚úÖ [FALLBACK] Supabase client obtained');
        
        // Check session
        const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
        const session = sessionData?.session;
        
        if (!session?.user) {
          console.log('üö® No Supabase session - checking localStorage as fallback...');
          
          // üî• CRITICAL FIX: Check localStorage before redirecting
          const localStorageKey = 'sb-gfcubvroxgfvjhacinic-auth-token';
          const localSession = localStorage.getItem(localStorageKey);
          
          if (localSession) {
            try {
              const parsed = JSON.parse(localSession);
              if (parsed?.access_token && parsed?.user?.id) {
                console.log('‚úÖ Valid session in localStorage - continuing despite network failure');
                // Continue loading profile using localStorage session
                const userId = parsed.user.id;
                // Continue with userId from localStorage...
                return; // Skip redirect
              }
            } catch (e) {
              console.error('‚ùå localStorage parse failed:', e);
            }
          }
          
          console.log('‚ùå No valid session in Supabase or localStorage - redirecting to signin');
          const isLocal = window.location.hostname === 'localhost';
          const signinPath = isLocal ? '/public/signin.html' : '/signin.html';
          window.location.href = signinPath + '?redirect=' + encodeURIComponent(window.location.pathname);
          return;
        }
        
        const userId = session.user.id;
        
        // Load from database
        console.log('üì• [FALLBACK] Loading from database for user:', userId);
        let profile = await loadAuthenticatedProfileFromSupabase(userId);
        
        if (!profile) {
          // Try localStorage
          const savedProfile = localStorage.getItem(`stayhi_profile_${userId}`);
          if (savedProfile) {
            try {
              profile = JSON.parse(savedProfile);
              console.log('üíæ Using localStorage fallback');
            } catch (e) {
              console.warn('‚ö†Ô∏è Invalid localStorage profile data');
            }
          }
        }
        
        if (!profile) {
          // Create new profile
          console.log('üìä Creating new authenticated profile...');
          profile = { ...currentProfile };
          profile.id = userId;
          profile.email = session.user.email || '';
          profile.username = profile.username || session.user.email?.split('@')[0] || `user_${userId.slice(-6)}`;
        }
        
        // Update current profile and UI
        Object.assign(currentProfile, profile);
        updateProfileDisplay(currentProfile);
        populateEditForm(currentProfile);
        
        // Load user stats (non-blocking for instant page render)
        loadUserStats(userId);
        
        console.log('‚úÖ Profile loaded via fallback method');
      } catch (error) {
        console.error('‚ùå Fallback profile loading error:', error);
      }
    }

    // Tesla-Grade Authenticated Supabase Loading
    async function loadAuthenticatedProfileFromSupabase(userId) {
      try {
        console.log('‚òÅÔ∏è Loading authenticated profile from Supabase for user:', userId);
        
        // üöÄ INTEGRATION #2: Profile reads via HiBase (flagged rollout)
        const useHiBase = await window.HiFlags?.getFlag('hibase_profile_enabled');
        console.log(`üîÑ Profile read via ${useHiBase ? 'HiBase' : 'legacy'} path`);

        let data, error;

        if (useHiBase) {
          // üéØ HiBase path: unified API
          console.log('üì¶ Profile ‚Üí HiBase.getProfile...');
          const profileResult = await window.HiBase.getProfile(userId);
          
          if (profileResult.error) {
            console.warn('‚ö†Ô∏è HiBase profile query failed:', profileResult.error.message);
            return null;
          }

          data = profileResult.data?.profile ? [profileResult.data.profile] : [];
          
          // üìä Track HiBase usage
          import('./lib/monitoring/HiMonitor.js').then(m => 
            m.trackEvent('profile_load', { 
              source: 'profile', 
              path: 'hibase'
            })
          ).catch(() => {});

        } else {
          // üîÑ Legacy path: direct Supabase calls  
          console.log('üì¶ Profile ‚Üí Legacy Supabase...');
          
          const result = await window.supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', userId)  // üîß FIXED: profiles table uses 'id' not 'user_id'
            .order('updated_at', { ascending: false })
            .limit(1);

          data = result.data;
          error = result.error;

          if (error) {
            console.warn('‚ö†Ô∏è Authenticated Supabase query failed:', error.message);
            return null;
          }

          // üìä Track legacy usage
          import('./lib/monitoring/HiMonitor.js').then(m => 
            m.trackEvent('profile_load', { 
              source: 'profile', 
              path: 'legacy'
            })
          ).catch(() => {});
        }

        if (data && data.length > 0) {
          console.log(`‚úÖ Authenticated profile loaded from ${useHiBase ? 'HiBase' : 'Supabase'}`);
          return data[0];
        }

        console.log('üìù No existing profile found for authenticated user');
        return null;
      } catch (error) {
        console.error('‚ùå Profile loading error:', error);
        return null;
      }
    }

    // Anonymous Demo Profile - NO DATABASE ACCESS
    async function loadAnonymousDemoProfile() {
      console.log('üé≠ Loading anonymous demo profile - NO real data access');
      
      // Anonymous users get a safe demo profile
      const demoProfile = {
        id: 'demo_' + Date.now(),
        username: 'Anonymous User',
        email: '',
        bio: 'This is a demo profile. Sign up to create your real profile!',
        location: '',
        avatar_url: '',
        created_at: new Date().toISOString(),
        is_demo: true
      };
      
      // Update UI with demo profile
      Object.assign(currentProfile, demoProfile);
      updateProfileDisplay(currentProfile);
      populateEditForm(currentProfile);
      
      // Anonymous users get zero stats
      await loadUserStats(null);
      
      // Modal will be triggered automatically by anonymous access modal system
      
      console.log('‚úÖ Anonymous demo profile loaded safely');
    }

    // Legacy function - DEPRECATED FOR SECURITY
    async function loadProfileFromSupabase() {
      try {
        console.warn('üö® DEPRECATED: loadProfileFromSupabase() bypasses authentication!');
        return null;
      } catch (error) {
        console.warn('‚ö†Ô∏è Supabase unavailable:', error.message);
        return null;
      }
    }

    function generateStableUserId() {
      // Create a stable ID based on browser fingerprint
      let stored = localStorage.getItem('stayhi_user_id');
      if (stored) return stored;
      
      // Generate stable ID from browser characteristics
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('StayHi', 2, 2);
      
      const fingerprint = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset(),
        canvas.toDataURL()
      ].join('|');
      
      // Simple hash function
      let hash = 0;
      for (let i = 0; i < fingerprint.length; i++) {
        const char = fingerprint.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
      }
      
      const userId = Math.abs(hash).toString(36);
      localStorage.setItem('stayhi_user_id', userId);
      return userId;
    }

    // populateEditForm defined earlier (line 2302) - duplicate removed to fix syntax error
    
    // updateStatsDisplay defined earlier (line 2573) - duplicate removed to fix syntax error
    
    // Tesla-Grade Simple Navigation System - Bulletproof Architecture
    function navigateToHiDashboard() {
      console.log('üöÄ Tesla-grade navigation: Returning to hi-dashboard');
      window.location.href = 'hi-dashboard.html';
    }
    
    // Expose globally for onclick handler
    window.navigateToHiDashboard = navigateToHiDashboard;
    
    // Old navigation system removed - using Tesla-grade SmartNavigation class instead
    
    // ‚úÖ REMOVED: Orphaned avatarInput code block (defined in DOMContentLoaded handler instead)
    
    // Global exposure for debugging and integration
    window.currentProfile = currentProfile;
    window.userStats = userStats;
    window.TeslaProfile = {
      openAvatarCrop,
      closeAvatarCrop,
      saveAvatar,
      openCalendar,
      openEditCalendar,
      editProfile,
      shareProfile,
      loadProfileData,
      showToast,
      testSupabaseConnection
    };
    
    // Expose membership modal for security system
    window.showMembershipModal = () => {
      if(window.AccessGate?.request){
        const decision = window.AccessGate.request('membership:upgrade');
        return !!decision.allow;
      }
      if (window.anonymousAccessModal) {
        window.anonymousAccessModal.showAccessModal();
        return false;
      }
      console.warn('‚ö†Ô∏è No AccessGate or AnonymousAccessModal for membership upgrade');
      return false;
    };
    
    // üî• CRITICAL: Expose loadProfileData to window for cross-script access
    // This REPLACES the placeholder set in HEAD
    window.__loadProfileData = loadProfileData;
    console.log('‚úÖ __loadProfileData function exposed (replaced placeholder)');
    
    console.log('‚úÖ Tesla Profile System Ready - WITH SECURITY BARRIERS');
    
    // üßë‚Äçüîß DEV TOOLS: Manual profile persistence testing
    window.testProfilePersistence = {
      save: () => saveProfileToStorage(currentProfile),
      load: () => loadProfileData(),
      clear: (userId) => {
        // üîí SECURITY: Clear user-specific cache only
        const key = userId ? `stayhi_profile_${userId}` : `stayhi_profile_${currentProfile.id}`;
        localStorage.removeItem(key);
        console.log('üßπ Cleared profile cache:', key);
      },
      showCurrent: () => console.log('Current Profile:', currentProfile),
      showSaved: (userId) => {
        const key = userId ? `stayhi_profile_${userId}` : `stayhi_profile_${currentProfile.id}`;
        console.log(`Saved Profile (${key}):`, JSON.parse(localStorage.getItem(key) || 'null'));
      }
    };
    console.log('üß™ Debug functions available: window.testProfilePersistence');
  </script>

  <script>
    // Initialize points balance and daily check-in
    document.addEventListener('hi:points-ready', async ()=>{
      console.log('üåü hi:points-ready event fired!');
      try {
        const { balance } = await HiPoints.getBalance();
        console.log('üí∞ Points balance loaded:', balance);
        const el = document.getElementById('pointsBalance'); if(el) el.textContent = balance;
      } catch(e){ console.error('‚ùå Error loading points balance:', e); }
    });
    
    // Wait for auth-ready to ensure Supabase client is loaded
    document.addEventListener('hi:auth-ready', ()=>{
      console.log('üîê Auth ready - initializing daily check-in button');
      const btn = document.getElementById('dailyCheckinBtn');
      const client = window.supabaseClient || window.hiSupabase;
      
      console.log('üîò Daily check-in button found:', !!btn);
      console.log('üîå Supabase client ready:', !!client);
      
      if(!btn) { console.error('‚ùå dailyCheckinBtn not found!'); return; }
      if(!client) { console.error('‚ùå Supabase client not ready!'); return; }
      
      console.log('‚úÖ Attaching click handler to daily check-in button');
      btn.addEventListener('click', async ()=>{
        console.log('üéØ Daily check-in button clicked!');
        const status = document.getElementById('checkinStatus');
        btn.disabled = true; btn.textContent = 'Checking...';
        try {
          console.log('üì° Calling award_daily_checkin RPC...');
          const { data, error } = await client.rpc('award_daily_checkin');
          console.log('üì¨ RPC response:', { data, error });
          if(error){ status.textContent = error.message; status.style.color = '#f66'; }
          else {
            if(data?.awarded){ status.textContent = `+${data.delta} today`; status.style.color = '#6c6'; }
            else { status.textContent = 'Already checked in today'; status.style.color = '#aaa'; }
            const el = document.getElementById('pointsBalance'); if(el && typeof data?.balance !== 'undefined') el.textContent = data.balance;
            try { await refreshLedger(); } catch(_){ }
          }
        } catch(e){ 
          console.error('‚ùå Check-in error:', e);
          const status = document.getElementById('checkinStatus'); 
          if(status){ status.textContent = 'Error: ' + e.message; status.style.color = '#f66'; } 
        }
        finally { btn.disabled = false; btn.textContent = 'Daily Check-in +5'; }
      });
    });

    async function refreshLedger(){
      if(!window.HiPoints) return;
      const list = document.getElementById('pointsLedger'); if(!list) return;
      const rows = await HiPoints.getLedger(10);
      list.innerHTML = rows.map(r=>{
        const sign = r.delta>0 ? '+' : '';
        const when = new Date(r.ts).toLocaleDateString();
        return `<li style="display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:8px 10px;background:rgba(255,255,255,0.05)">
          <div>
            <div style="font-weight:600">${sign}${r.delta} pts</div>
            <div style="opacity:.8;font-size:12px">${r.reason || 'adjustment'} ‚Ä¢ ${r.context || 'general'}</div>
          </div>
          <div style="opacity:.8;font-size:12px">${when}</div>
        </li>`;
      }).join('');
    }
    document.addEventListener('hi:points-ready', refreshLedger);
    document.addEventListener('hi:auth-ready', refreshLedger, { once:true });
  </script>
  
  <!-- Location Picker Functions -->
  <script src="./lib/boot/profile-locationpicker-log.js"></script>
  <script>
    const locationData = {
      'Canada': {
        'Ontario': ['Toronto', 'Ottawa', 'Mississauga', 'Brampton', 'Hamilton', 'London', 'Markham', 'Vaughan', 'Kitchener', 'Windsor'],
        'Quebec': ['Montreal', 'Quebec City', 'Laval', 'Gatineau', 'Longueuil', 'Sherbrooke', 'Levis', 'Saguenay', 'Trois-Rivi√®res'],
        'British Columbia': ['Vancouver', 'Surrey', 'Burnaby', 'Richmond', 'Abbotsford', 'Coquitlam', 'Delta', 'Saanich', 'North Vancouver'],
        'Alberta': ['Calgary', 'Edmonton', 'Red Deer', 'Lethbridge', 'St. Albert', 'Medicine Hat', 'Grande Prairie', 'Airdrie', 'Spruce Grove'],
        'Manitoba': ['Winnipeg', 'Brandon', 'Steinbach', 'Thompson', 'Portage la Prairie', 'Winkler', 'Selkirk', 'Dauphin']
      },
      'United Kingdom': {
        'England': ['London', 'Birmingham', 'Manchester', 'Liverpool', 'Leeds', 'Sheffield', 'Bristol', 'Newcastle', 'Nottingham', 'Leicester'],
        'Scotland': ['Glasgow', 'Edinburgh', 'Aberdeen', 'Dundee', 'Stirling', 'Perth', 'Inverness', 'Paisley', 'East Kilbride'],
        'Wales': ['Cardiff', 'Swansea', 'Newport', 'Wrexham', 'Barry', 'Caerphilly', 'Rhondda', 'Bridgend', 'Neath'],
        'Northern Ireland': ['Belfast', 'Derry', 'Lisburn', 'Newtownabbey', 'Bangor', 'Craigavon', 'Castlereagh', 'Ballymena', 'Newry']
      },
      'Australia': {
        'New South Wales': ['Sydney', 'Newcastle', 'Wollongong', 'Maitland', 'Wagga Wagga', 'Albury', 'Port Macquarie', 'Tamworth', 'Orange'],
        'Victoria': ['Melbourne', 'Geelong', 'Ballarat', 'Bendigo', 'Melton', 'Latrobe City', 'Frankston', 'Casey', 'Greater Dandenong'],
        'Queensland': ['Brisbane', 'Gold Coast', 'Townsville', 'Cairns', 'Toowoomba', 'Mackay', 'Rockhampton', 'Bundaberg', 'Hervey Bay'],
        'Western Australia': ['Perth', 'Fremantle', 'Rockingham', 'Mandurah', 'Bunbury', 'Kalgoorlie', 'Geraldton', 'Albany', 'Kwinana'],
        'South Australia': ['Adelaide', 'Mount Gambier', 'Whyalla', 'Murray Bridge', 'Port Lincoln', 'Port Augusta', 'Victor Harbor']
      },
      'Germany': {
        'Bavaria': ['Munich', 'Nuremberg', 'Augsburg', 'Regensburg', 'Ingolstadt', 'W√ºrzburg', 'F√ºrth', 'Erlangen', 'Bamberg'],
        'North Rhine-Westphalia': ['Cologne', 'D√ºsseldorf', 'Dortmund', 'Essen', 'Duisburg', 'Bochum', 'Wuppertal', 'Bielefeld', 'Bonn'],
        'Baden-W√ºrttemberg': ['Stuttgart', 'Mannheim', 'Karlsruhe', 'Freiburg', 'Heidelberg', 'Heilbronn', 'Ulm', 'Pforzheim', 'Reutlingen'],
        'Berlin': ['Berlin'],
        'Hamburg': ['Hamburg'],
        'Hesse': ['Frankfurt', 'Wiesbaden', 'Kassel', 'Darmstadt', 'Offenbach', 'Hanau', 'Marburg', 'Fulda', 'Gie√üen']
      },
      'France': {
        '√éle-de-France': ['Paris', 'Boulogne-Billancourt', 'Saint-Denis', 'Argenteuil', 'Montreuil', 'Cr√©teil', 'Nanterre', 'Versailles'],
        'Provence-Alpes-C√¥te dAzur': ['Marseille', 'Nice', 'Toulon', 'Aix-en-Provence', 'Antibes', 'Cannes', 'Avignon', 'Fr√©jus'],
        'Auvergne-Rh√¥ne-Alpes': ['Lyon', 'Grenoble', 'Saint-√âtienne', 'Villeurbanne', 'Clermont-Ferrand', 'Annecy', 'Chamb√©ry'],
        'Occitanie': ['Toulouse', 'Montpellier', 'N√Æmes', 'Perpignan', 'B√©ziers', 'Narbonne', 'Carcassonne', 'Albi'],
        'Hauts-de-France': ['Lille', 'Amiens', 'Roubaix', 'Tourcoing', 'Dunkirk', 'Calais', 'Valenciennes', 'Boulogne-sur-Mer']
      },
      'Japan': {
        'Tokyo': ['Tokyo', 'Shibuya', 'Shinjuku', 'Harajuku', 'Ginza', 'Akihabara', 'Roppongi', 'Ikebukuro'],
        'Osaka': ['Osaka', 'Sakai', 'Higashiosaka', 'Hirakata', 'Toyonaka', 'Suita', 'Takatsuki'],
        'Kanagawa': ['Yokohama', 'Kawasaki', 'Sagamihara', 'Fujisawa', 'Hiratsuka', 'Odawara', 'Yamato'],
        'Aichi': ['Nagoya', 'Toyota', 'Okazaki', 'Ichinomiya', 'Kasugai', 'Anjo', 'Kariya'],
        'Kyoto': ['Kyoto', 'Uji', 'Kameoka', 'Joyo', 'Muk≈ç', 'Nagaokaky≈ç', 'Ky≈çtanabe']
      },
      'South Korea': {
        'Seoul': ['Seoul', 'Gangnam', 'Hongdae', 'Myeongdong', 'Itaewon', 'Insadong', 'Jongno'],
        'Busan': ['Busan', 'Haeundae', 'Centum City', 'Seomyeon', 'Nampo-dong', 'Jagalchi'],
        'Incheon': ['Incheon', 'Songdo', 'Bupyeong', 'Namdong', 'Yeonsu', 'Seo-gu'],
        'Daegu': ['Daegu', 'Jung-gu', 'Dong-gu', 'Seo-gu', 'Nam-gu', 'Buk-gu'],
        'Gyeonggi': ['Suwon', 'Seongnam', 'Goyang', 'Yongin', 'Bucheon', 'Ansan', 'Anyang']
      },
      'China': {
        'Beijing': ['Beijing', 'Chaoyang', 'Haidian', 'Dongcheng', 'Xicheng', 'Fengtai', 'Shijingshan'],
        'Shanghai': ['Shanghai', 'Pudong', 'Huangpu', 'Xuhui', 'Changning', 'Jing\'an', 'Putuo'],
        'Guangdong': ['Guangzhou', 'Shenzhen', 'Dongguan', 'Foshan', 'Zhuhai', 'Zhongshan', 'Jiangmen'],
        'Zhejiang': ['Hangzhou', 'Ningbo', 'Wenzhou', 'Shaoxing', 'Huzhou', 'Jiaxing', 'Jinhua'],
        'Jiangsu': ['Nanjing', 'Suzhou', 'Wuxi', 'Changzhou', 'Nantong', 'Xuzhou', 'Yancheng']
      },
      'India': {
        'Maharashtra': ['Mumbai', 'Pune', 'Nagpur', 'Nashik', 'Aurangabad', 'Solapur', 'Amravati'],
        'Karnataka': ['Bangalore', 'Mysore', 'Hubli', 'Mangalore', 'Belgaum', 'Gulbarga', 'Davangere'],
        'Tamil Nadu': ['Chennai', 'Coimbatore', 'Madurai', 'Tiruchirappalli', 'Salem', 'Tirunelveli', 'Erode'],
        'Delhi': ['New Delhi', 'Delhi Cantonment', 'Karol Bagh', 'Lajpat Nagar', 'Rajouri Garden'],
        'West Bengal': ['Kolkata', 'Howrah', 'Durgapur', 'Asansol', 'Siliguri', 'Bardhaman', 'Malda']
      },
      'Brazil': {
        'S√£o Paulo': ['S√£o Paulo', 'Guarulhos', 'Campinas', 'S√£o Bernardo do Campo', 'Santos', 'Osasco', 'Ribeir√£o Preto'],
        'Rio de Janeiro': ['Rio de Janeiro', 'Nova Igua√ßu', 'Duque de Caxias', 'Niter√≥i', 'S√£o Gon√ßalo', 'Belford Roxo'],
        'Minas Gerais': ['Belo Horizonte', 'Uberl√¢ndia', 'Contagem', 'Juiz de Fora', 'Betim', 'Montes Claros'],
        'Bahia': ['Salvador', 'Feira de Santana', 'Vit√≥ria da Conquista', 'Cama√ßari', 'Itabuna', 'Juazeiro'],
        'Paran√°': ['Curitiba', 'Londrina', 'Maring√°', 'Ponta Grossa', 'Cascavel', 'S√£o Jos√© dos Pinhais']
      },
      'Mexico': {
        'Mexico City': ['Mexico City', 'Iztapalapa', 'Ecatepec', 'Guadalajara', 'Puebla', 'Tijuana', 'Le√≥n'],
        'Jalisco': ['Guadalajara', 'Zapopan', 'Tlaquepaque', 'Tonal√°', 'Puerto Vallarta', 'Lagos de Moreno'],
        'Nuevo Le√≥n': ['Monterrey', 'Guadalupe', 'San Nicol√°s de los Garza', 'Apodaca', 'Santa Catarina'],
        'Puebla': ['Puebla', 'Tehuac√°n', 'San Mart√≠n Texmelucan', 'Atlixco', 'San Pedro Cholula'],
        'Veracruz': ['Veracruz', 'Xalapa', 'Coatzacoalcos', 'C√≥rdoba', 'Poza Rica', 'Minatitl√°n']
      },
      'Italy': {
        'Lombardy': ['Milan', 'Brescia', 'Bergamo', 'Monza', 'Como', 'Cremona', 'Mantua'],
        'Lazio': ['Rome', 'Latina', 'Guidonia Montecelio', 'Fiumicino', 'Aprilia', 'Civitavecchia'],
        'Campania': ['Naples', 'Salerno', 'Giugliano', 'Torre del Greco', 'Pozzuoli', 'Caserta'],
        'Sicily': ['Palermo', 'Catania', 'Messina', 'Syracuse', 'Marsala', 'Ragusa', 'Trapani'],
        'Veneto': ['Venice', 'Verona', 'Padua', 'Vicenza', 'Treviso', 'Rovigo', 'Belluno']
      },
      'Spain': {
        'Madrid': ['Madrid', 'M√≥stoles', 'Alcal√° de Henares', 'Fuenlabrada', 'Legan√©s', 'Getafe'],
        'Catalonia': ['Barcelona', 'L\'Hospitalet', 'Badalona', 'Terrassa', 'Sabadell', 'Lleida'],
        'Andalusia': ['Seville', 'M√°laga', 'C√≥rdoba', 'Granada', 'Jerez', 'Almer√≠a', 'Huelva'],
        'Valencia': ['Valencia', 'Alicante', 'Castell√≥n', 'Elche', 'Torrent', 'Orihuela'],
        'Basque Country': ['Bilbao', 'Vitoria-Gasteiz', 'San Sebasti√°n', 'Barakaldo', 'Getxo']
      },
      'Netherlands': {
        'North Holland': ['Amsterdam', 'Haarlem', 'Zaanstad', 'Haarlemmermeer', 'Alkmaar', 'Hilversum'],
        'South Holland': ['The Hague', 'Rotterdam', 'Leiden', 'Zoetermeer', 'Dordrecht', 'Delft'],
        'North Brabant': ['Eindhoven', 'Tilburg', '\'s-Hertogenbosch', 'Breda', 'Helmond', 'Oss'],
        'Utrecht': ['Utrecht', 'Nieuwegein', 'Veenendaal', 'Houten', 'Vijfheerenlanden'],
        'Limburg': ['Maastricht', 'Heerlen', 'Sittard-Geleen', 'Kerkrade', 'Roermond']
      },
      'Switzerland': {
        'Zurich': ['Zurich', 'Winterthur', 'Uster', 'D√ºbendorf', 'Dietikon', 'Wetzikon'],
        'Bern': ['Bern', 'Biel/Bienne', 'Thun', 'K√∂niz', 'Steffisburg', 'Burgdorf'],
        'Vaud': ['Lausanne', 'Yverdon-les-Bains', 'Montreux', 'Renens', 'Nyon', 'Vevey'],
        'Geneva': ['Geneva', 'Vernier', 'Lancy', 'Meyrin', 'Carouge', 'Onex'],
        'Basel-Stadt': ['Basel', 'Riehen', 'Bettingen']
      },
      'Austria': {
        'Vienna': ['Vienna', 'D√∂bling', 'Favoriten', 'Floridsdorf', 'Donaustadt', 'Liesing'],
        'Styria': ['Graz', 'Leoben', 'Kapfenberg', 'Bruck an der Mur', 'Feldbach'],
        'Upper Austria': ['Linz', 'Wels', 'Steyr', 'Traun', 'Leonding', 'Amstetten'],
        'Tyrol': ['Innsbruck', 'Kufstein', 'Telfs', 'Schwaz', 'Hall in Tirol', 'W√∂rgl'],
        'Salzburg': ['Salzburg', 'Hallein', 'Saalfelden', 'Bad Ischl', 'St. Johann']
      },
      'Belgium': {
        'Brussels': ['Brussels', 'Schaerbeek', 'Anderlecht', 'Molenbeek', 'Uccle', 'Ixelles'],
        'Flanders': ['Antwerp', 'Ghent', 'Bruges', 'Leuven', 'Mechelen', 'Aalst', 'Kortrijk'],
        'Wallonia': ['Li√®ge', 'Charleroi', 'Namur', 'Mons', 'La Louvi√®re', 'Tournai']
      },
      'Sweden': {
        'Stockholm': ['Stockholm', 'S√∂dert√§lje', 'Nacka', 'Sundbyberg', 'Solna', 'T√§by'],
        'V√§stra G√∂taland': ['Gothenburg', 'Bor√•s', 'Trollh√§ttan', 'Uddevalla', 'Sk√∂vde'],
        'Sk√•ne': ['Malm√∂', 'Helsingborg', 'Lund', 'Kristianstad', 'Landskrona', 'Trelleborg'],
        'Uppsala': ['Uppsala', 'Enk√∂ping', 'H√•bo', 'Knivsta', 'Tierp', '√Ñlvkarleby'],
        'V√§rmland': ['Karlstad', 'Arvika', 'Kristinehamn', 'Filipstad', 'Hagfors']
      },
      'Norway': {
        'Oslo': ['Oslo', 'B√¶rum', 'Asker', 'L√∏renskog', 'Oppeg√•rd', 'Ski'],
        'Rogaland': ['Stavanger', 'Sandnes', 'Haugesund', 'Karm√∏y', 'Time', 'Gjesdal'],
        'Hordaland': ['Bergen', 'Ask√∏y', 'Os', 'Fjell', 'Sund', '√òygarden'],
        'Tr√∏ndelag': ['Trondheim', 'Steinkjer', 'Levanger', 'Verdal', 'Namsos'],
        'Nordland': ['Bod√∏', 'Narvik', 'Fauske', 'Mo i Rana', 'Rana', 'Vefsn']
      }
    };

    // Tesla-Grade Location System - Streamlined with LocationPicker Modal
  </script>
  
  <!-- Tesla-Grade Navigation System (externalized) -->
  <script src="./lib/boot/profile-navigation.js"></script>
  <!-- Seamless anonymous‚Üíauth profile merge -->
  <script src="./lib/profile/ProfileMerge.js"></script>
  <!-- Avatar precache dispatcher -->
  <script src="./lib/profile/avatar-precache.js"></script>
  <!-- Unified Auth Shim (removes dependency on progressive-auth.js) -->
  <script src="./lib/access/AuthShim.js"></script>
  <!-- Access telemetry + upgrade CTA + SW register -->
  <script src="./lib/access/AccessGateTelemetry.js"></script>
  <script src="./lib/access/AccessGateTelemetryExport.js"></script>
  <script src="./lib/boot/upgrade-cta.js"></script>
  <script src="./lib/boot/sw-register.js"></script>
  <script type="module">
    class SmartNavigation {
      constructor() {
        this.backBtn = document.getElementById('smartBackBtn');
        this.backText = document.getElementById('backDestination');
        this.defaultDestination = '/public/hi-dashboard.html';
        this.validSources = [
          '/public/hi-dashboard.html',
          '/public/hi-island-NEW.html', 
          '/public/hi-muscle.html',
          '/public/hi-calendar.html',
          '/public/hi-hiffirmations.html',
          '/public/hi-stats.html'
        ];
        this.init();
      }

      init() {
        if (!this.backBtn) return;
        
        this.setupBackDestination();
        this.backBtn.addEventListener('click', (e) => this.handleBackNavigation(e));
      }

      setupBackDestination() {
        try {
          // Method 1: Check referrer
          const referrer = document.referrer;
          if (referrer && this.isValidSource(referrer)) {
            const sourceName = this.getSourceName(referrer);
            this.updateBackButton(`Back to ${sourceName}`, referrer);
            return;
          }

          // Method 2: Check session storage for navigation history
          const navHistory = JSON.parse(sessionStorage.getItem('hiNavHistory') || '[]');
          const lastValidPage = navHistory.find(page => 
            page.url !== window.location.href && this.isValidSource(page.url)
          );
          
          if (lastValidPage) {
            this.updateBackButton(`Back to ${lastValidPage.name}`, lastValidPage.url);
            return;
          }

          // Method 3: Browser history check (limited but safe)
          if (history.length > 1) {
            this.updateBackButton('Back', 'history');
            return;
          }

          // Fallback: Dashboard
          this.updateBackButton('Back to Dashboard', this.defaultDestination);

        } catch (error) {
          console.log('Smart navigation setup:', error.message);
          this.updateBackButton('Back to Dashboard', this.defaultDestination);
        }
      }

      isValidSource(url) {
        if (!url) return false;
        return this.validSources.some(source => url.includes(source));
      }

      getSourceName(url) {
        if (url.includes('hi-dashboard')) return 'Dashboard';
        if (url.includes('hi-island')) return 'Hi Island';
        if (url.includes('hi-muscle')) return 'Hi Muscle';
        if (url.includes('hi-calendar')) return 'Calendar';
        if (url.includes('hi-hiffirmations')) return 'Hiffirmations';
        if (url.includes('hi-stats')) return 'Hi Stats';
        return 'Previous Page';
      }

      updateBackButton(text, destination) {
        if (this.backText) {
          this.backText.textContent = text;
        }
        this.backBtn.setAttribute('data-destination', destination);
        this.backBtn.setAttribute('title', text);
      }

      handleBackNavigation(e) {
        e.preventDefault();
        
        const destination = this.backBtn.getAttribute('data-destination');
        
        try {
          this.backBtn.classList.add('loading');
          
          if (destination === 'history') {
            // Use browser history if available and safe
            if (history.length > 1 && document.referrer) {
              history.back();
            } else {
              // Fallback to dashboard
              window.location.href = this.defaultDestination;
            }
          } else if (destination) {
            // Direct navigation to specific page
            window.location.href = destination;
          } else {
            // Ultimate fallback
            window.location.href = this.defaultDestination;
          }
          
          // Track navigation for analytics
          this.trackNavigation(destination);
          
        } catch (error) {
          console.log('Navigation error:', error.message);
          // Error fallback - always go to dashboard
          window.location.href = this.defaultDestination;
        }
      }

      trackNavigation(destination) {
        try {
          // Store navigation event for future smart routing
          const navEvent = {
            from: window.location.href,
            to: destination,
            timestamp: Date.now(),
            type: 'smart_back'
          };
          
          const navHistory = JSON.parse(sessionStorage.getItem('hiNavHistory') || '[]');
          navHistory.unshift(navEvent);
          // Keep last 10 navigation events
          navHistory.splice(10);
          sessionStorage.setItem('hiNavHistory', JSON.stringify(navHistory));
        } catch (error) {
          // Silent fail for analytics
        }
      }
    }

    // Tesla-Grade Unified Initialization - All Systems
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Tesla Profile System Initializing...');

      // üî• WOZ FIX: Wait for critical dependencies before proceeding
      if (window.DependencyManager) {
        try {
          console.log('‚è≥ Waiting for dependencies: auth, hiDB, HiSupabase, ProfileManager...');
          await window.DependencyManager.waitForDependencies(
            ['auth', 'hiDB', 'HiSupabase', 'ProfileManager'],
            10000 // 10 second timeout
          );
          console.log('‚úÖ All dependencies ready');
        } catch (error) {
          console.error('‚ö†Ô∏è Dependency timeout:', error);
          // Show user-friendly error UI
          document.body.innerHTML = `
            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:system-ui;text-align:center;padding:20px;">
              <div style="font-size:48px;margin-bottom:20px;">‚ö†Ô∏è</div>
              <h2 style="color:#333;margin-bottom:10px;">Loading timeout</h2>
              <p style="color:#666;margin-bottom:30px;">Profile couldn't load all dependencies in time</p>
              <button onclick="location.reload()" style="background:#ffd166;border:none;padding:12px 24px;border-radius:8px;font-size:16px;cursor:pointer;font-weight:600;">
                Reload Page
              </button>
            </div>
          `;
          return;
        }
      }

      // Debug instrumentation: when ?profiledebug=1 present, bypass anonymous gating and log auth/membership
      try {
        if (/profiledebug=1/i.test(location.search)) {
          console.log('[ProfileDebug] Active ‚Äì skipping anonymous gating modal.');
          window.__HI_PROFILE_DEBUG__ = true;
          // Lightweight debug HUD
          const hud = document.createElement('div');
          hud.id = 'profileDebugHud';
          hud.style.cssText = 'position:fixed;bottom:16px;right:16px;z-index:99999;background:rgba(255,209,102,.15);border:1px solid rgba(255,209,102,.4);color:#ffd166;padding:8px 10px;border-radius:10px;font:12px/1.3 system-ui;backdrop-filter:blur(6px)';
          hud.textContent = 'ProfileDebug ON';
          document.addEventListener('DOMContentLoaded', ()=>{ try{ document.body.appendChild(hud);}catch{} });
          const log = (...a)=>{ console.log('[ProfileDebug]', ...a); try{ hud.textContent = 'ProfileDebug: '+(a[0]||'event'); }catch{} };
          window.__HI_PROFILE_LOG__ = log;
          // Log auth state if available
          setTimeout(async ()=>{
            try {
              const sb = (window.HiSupabase?.getClient && window.HiSupabase.getClient()) || window.hiSupabase || null;
              if (sb?.auth?.getSession){
                const { data: { session } } = await sb.auth.getSession();
                log('session', !!session);
              } else {
                log('no supabase client');
              }
            } catch(e){ log('auth check error', e?.message); }
          }, 100);
          // Patch AccessGate if present later
          const patchAccessGate = ()=>{
            try {
              if (window.AccessGate && !window.AccessGate.__patched){
                const orig = window.AccessGate.request?.bind(window.AccessGate);
                if (typeof orig === 'function'){
                  window.AccessGate.request = function(token){ log('AccessGate.request', token); return orig(token); };
                  window.AccessGate.__patched = true;
                }
              }
            } catch{}
          };
          setInterval(patchAccessGate, 500);
          // Click navigation tracer
          document.addEventListener('click', (ev)=>{
            const t = ev.target.closest('a,button');
            if (!t) return;
            const href = t.getAttribute('href') || t.dataset?.destination || '';
            log('click', t.tagName, href);
          }, true);
          // Unload & visibility hooks
          ['visibilitychange','pagehide','beforeunload','popstate','hashchange'].forEach(evt=>{
            window.addEventListener(evt, ()=> log('event', evt));
          });
        }
      } catch {}
      
      // Debug code removed for production
      
      // Track current page visit for smart navigation
      try {
        const currentPage = {
          url: window.location.href,
          name: 'Profile',
          timestamp: Date.now()
        };
        
        const navHistory = JSON.parse(sessionStorage.getItem('hiNavHistory') || '[]');
        // Remove any existing entry for this page
        const filtered = navHistory.filter(page => page.url !== currentPage.url);
        // Add current page to front
        filtered.unshift(currentPage);
        // Keep last 10 pages
        filtered.splice(10);
        sessionStorage.setItem('hiNavHistory', JSON.stringify(filtered));
      } catch (error) {
        // Silent fail for tracking
      }

      // Initialize Tesla-Grade Smart Navigation
      const smartNav = new SmartNavigation();
      
      // üî• CRITICAL: Check session on page load (not just visibilitychange)
      (async function checkSessionOnLoad() {
        try {
          const sb = window.hiSupabase || window.supabase;
          if (!sb) {
            console.warn('[Profile] Supabase not ready yet - waiting for init...');
            return;
          }
          
          const { data: { session } } = await sb.auth.getSession();
          if (!session) {
            console.warn('[Profile] ‚ö†Ô∏è NO SESSION on page load - checking localStorage...');
            const token = localStorage.getItem('sb-gfcubvroxgfvjhacinic-auth-token');
            console.log('[Profile] localStorage token exists:', !!token);
            
            if (token) {
              console.log('[Profile] Token exists but session lost - restoring...');
              try {
                const parsed = JSON.parse(token);
                if (parsed?.access_token) {
                  const { data, error } = await sb.auth.setSession({
                    access_token: parsed.access_token,
                    refresh_token: parsed.refresh_token
                  });
                  if (data?.session) {
                    console.log('[Profile] ‚úÖ Session restored on page load');
                  } else {
                    console.error('[Profile] Session restore failed:', error);
                  }
                }
              } catch (e) {
                console.error('[Profile] Session parse error:', e);
              }
            }
          } else {
            console.log('[Profile] ‚úÖ Session active on page load');
          }
        } catch (e) {
          console.error('[Profile] Session check error:', e);
        }
      })();
      
      // Tesla-Grade Security: Load data with authentication check FIRST
      // then apply access gating only for anonymous users
      // ‚úÖ CRITICAL FIX: Wait for hi:auth-ready before gating (prevents race condition)
      let authCheckComplete = false;
      
      // üî• CRITICAL: Check if auth-ready already fired before we attached listener
      function handleAuthReady(e) {
        if (authCheckComplete) return; // Already processed
        authCheckComplete = true;
        const { session } = e?.detail || {};
        
        console.log('üîí Profile access check (auth-ready):', { 
          hasSession: !!session?.user, 
          userId: session?.user?.id 
        });
        
        // If session exists, user is authenticated - skip modal entirely
        if (session?.user) {
          console.log('‚úÖ Authenticated user - bypassing access gate, loading profile...');
        }
        
        // üéØ CRITICAL FIX: Don't await - let profile load in background for instant render
        console.log('üîÑ Starting profile load (non-blocking)');
        if (window.__loadProfileData) {
          window.__loadProfileData(session); // Fire-and-forget - page already rendered
        } else {
          console.error('‚ùå loadProfileData not found on window');
        }
      }
      
      // Add listener for future auth-ready events
      window.addEventListener('hi:auth-ready', handleAuthReady, { once: true });
      
      // üî• CRITICAL: Check if auth-ready ALREADY fired (race condition prevention)
      if (window.__hiAuthReady) {
        console.log('‚ö° Auth-ready already fired - calling handler immediately');
        handleAuthReady({ detail: window.__hiAuthReady });
      }
      
      // Fallback: If auth-ready doesn't fire in 5 seconds, load anyway
      setTimeout(async () => {
        if (authCheckComplete) return; // Auth already checked
        
        console.log('üîí Auth timeout - loading profile with fallback check...');
        // üéØ Don't await - let it load in background
        if (window.TeslaProfile?.loadProfileData) {
          window.TeslaProfile.loadProfileData();
        } else {
          loadProfileData();
        }
      }, 5000);
      
      // Initialize profile display
      setTimeout(() => {
        if (typeof updateProfileDisplay === 'function' && currentProfile) {
          updateProfileDisplay(currentProfile);
        } else {
          console.warn('‚ö†Ô∏è updateProfileDisplay function or currentProfile not available');
        }
        
        // üî• REMOVED: updateStatsDisplay(userStats) call
        // Stats are loaded and displayed by loadUserStats() in profile.html (line ~1729)
        // That function queries database directly and calls the correct updateStatsDisplay()
        // Do NOT call it again here with potentially stale userStats object
      }, 500);
      
      // Avatar file input handler
      const avatarInput = document.getElementById('avatarFileInput');
      if (avatarInput) {
        avatarInput.addEventListener('change', (e) => {
          if (e.target.files && e.target.files.length > 0) {
            handleImageUpload(e);
          }
        });
      }
      
      // Initialize Tesla Avatar System
      setTimeout(() => {
        initializeTeslaAvatarSystem();
      }, 100);
      
      showToast('Profile loaded successfully! üéâ');
      console.log('‚úÖ Tesla Profile System fully initialized');
      
      const menuBtn = document.getElementById('btnMenu');
      const navigationModal = document.getElementById('navigationModal');
      const closeBtn = document.getElementById('closeNavigation');
      const backdrop = document.getElementById('navigationBackdrop');

      if (menuBtn && navigationModal) {
        menuBtn.addEventListener('click', () => {
          navigationModal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        });

        [closeBtn, backdrop].forEach(el => {
          if (el) {
            el.addEventListener('click', () => {
              navigationModal.style.display = 'none';
              document.body.style.overflow = 'auto';
            });
          }
        });
      }

      // Calendar button (handled by profile-navigation.js - no duplicate listener needed)

      // Hiffirmations button  
      const hiffirmationsBtn = document.getElementById('hiffirmationsTrigger');
      if (hiffirmationsBtn) {
        hiffirmationsBtn.addEventListener('click', () => {
          console.log('‚ú® Hiffirmations clicked');
          // TODO: Open hiffirmations modal (existing functionality)
        });
      }

      // ‚úÖ Tier badge update handled by profile-navigation.js (external script loaded at line 3173)
      // Removed duplicate inline function to prevent double-firing on hi:auth-ready event
      setTimeout(() => {
        // Render tier perks using HiTier if available
        try {
          const container = document.getElementById('tierPerks');
          if(container && window.HiTier){
            const t2 = HiTier.isAtLeast('T2');
            const t3 = HiTier.isAtLeast('T3');
            container.innerHTML = ''+
              '<div class="stat-item"><div class="stat-value">‚úîÔ∏é</div><div class="stat-label">Core access</div></div>'+ 
              '<div class="stat-item"><div class="stat-value">Ôºã5</div><div class="stat-label">Daily check-in</div></div>'+ 
              (t2 ? '<div class="stat-item"><div class="stat-value">T2</div><div class="stat-label">Early drops</div></div>' : '<div class="stat-item"><div class="stat-value">Upgrade</div><div class="stat-label">Unlock early drops</div></div>')+
              (t3 ? '<div class="stat-item"><div class="stat-value">T3</div><div class="stat-label">Premium tools</div></div>' : '<div class="stat-item"><div class="stat-value">Pro</div><div class="stat-label">Unlock premium tools</div></div>');
          }
        } catch(_){}
      }, 1000);
      
      // üéâ Onboarding: Auto-open profile editor for new users
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('onboarding') === 'true') {
        console.log('üéâ Welcome! Starting profile setup...');
        
        setTimeout(() => {
          const modal = document.getElementById('editProfileModal');
          if (modal) {
            modal.classList.add('active');
            
            // Show welcome message
            const header = modal.querySelector('.crop-header h3');
            if (header) {
              header.textContent = 'üéâ Welcome to Hi! Set up your profile';
            }
            
            // Focus on display name field
            const displayNameInput = document.getElementById('editDisplayName');
            if (displayNameInput) {
              displayNameInput.focus();
            }
            
            // Remove onboarding param from URL without reload
            const newUrl = window.location.pathname;
            window.history.replaceState({}, '', newUrl);
            
            console.log('‚úÖ Onboarding modal opened');
          }
        }, 1500);
      }
    }); // ‚úÖ Close DOMContentLoaded handler
  </script>

  <!-- Progressive Enhancement Scripts (externalized) -->
  <script src="./lib/boot/profile-progressive.js"></script>
  <!-- Race mitigation to ensure single secure load after auth-ready -->
  <script src="./lib/boot/profile-race-mitigation.js"></script>

  <!-- HiFooter Component -->
  <script src="./ui/HiFooter/HiFooter.js" defer></script>
  <!-- Integrity handled by mc-access-core.js -->
  
  <!-- mc-quick-access removed (unified core) -->
</body>
</html>// Vercel cache bust: Wed Dec 10 16:46:26 EST 2025
// Force Vercel rebuild 1765408146
