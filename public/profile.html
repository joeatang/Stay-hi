<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Profile — Stay Hi</title>
  
  <!-- Tesla-Grade Performance: Essential Assets Only -->
  <script src="assets/avatar-utils.js"></script>
  <script src="assets/location-picker.js"></script>
  <script src="assets/performance-manager.js"></script>
  <script src="assets/image-optimizer.js"></script>
  <script src="assets/social-avatar-uploader.js"></script>
  <script src="assets/premium-calendar.js"></script>
  
  <!-- Supabase Integration -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/supabase-init.js"></script>
  
  <!-- Tesla CSS: Critical + Progressive Enhancement -->
  <link rel="stylesheet" href="assets/location-picker.css">
  <link rel="preload" href="assets/premium-ux.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="assets/premium-stats.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="assets/premium-calendar.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="assets/premium-ux.css">
    <link rel="stylesheet" href="assets/premium-stats.css">
    <link rel="stylesheet" href="assets/premium-calendar.css">
  </noscript>
  
  <style>
    /* Tesla-Grade Gold Standard Profile System */
    :root {
      --tesla-primary: #4ECDC4;
      --tesla-secondary: #FFD93D;
      --tesla-danger: #FF6B6B;
      --tesla-bg: linear-gradient(135deg, #0F0F23 0%, #1A1A2E 50%, #16213E 100%);
      --tesla-surface: rgba(255,255,255,0.05);
      --tesla-border: rgba(255,255,255,0.1);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui;
      background: var(--tesla-bg);
      color: white;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Back Navigation - Tesla Grade Mobile First */
    .back-navigation {
      position: fixed;
      top: env(safe-area-inset-top, 20px);
      left: 16px;
      z-index: 1000;
    }
    
    .nav-back {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(20px);
      border: 1px solid var(--tesla-border);
      border-radius: 12px;
      color: white;
      text-decoration: none;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      
      /* Tesla mobile touch target */
      min-height: 44px;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
    }
    
    @media (min-width: 768px) {
      .back-navigation {
        top: 20px;
        left: 20px;
      }
      
      .nav-back {
        font-size: 14px;
        min-height: auto;
      }
    }
    
    .nav-back:hover {
      background: rgba(78, 205, 196, 0.1);
      border-color: var(--tesla-primary);
      transform: translateX(-4px);
    }
    
    .nav-back::before {
      content: '←';
      font-size: 18px;
      font-weight: 600;
    }
    
    /* Profile Container - Mobile First */
    .profile-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 80px 16px 60px;
      
      /* Tesla mobile optimization */
      padding-bottom: env(safe-area-inset-bottom, 60px);
    }
    
    @media (min-width: 768px) {
      .profile-container {
        padding: 80px 24px 40px;
      }
    }
    
    /* Profile Hero Section - Mobile First */
    .profile-hero {
      text-align: center;
      margin-bottom: 24px;
      padding: 32px 20px;
      background: var(--tesla-surface);
      border-radius: 20px;
      border: 1px solid var(--tesla-border);
      
      /* Tesla mobile touch targets */
      min-height: 44px;
    }
    
    @media (min-width: 768px) {
      .profile-hero {
        margin-bottom: 40px;
        padding: 40px 24px;
        border-radius: 24px;
      }
    }
    
    /* Tesla Avatar - Mobile Optimized */
    .profile-avatar-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 0 auto 20px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid var(--tesla-primary);
      cursor: pointer;
      transition: all 0.3s ease;
      
      /* Tesla mobile touch target */
      min-width: 44px;
      min-height: 44px;
    }
    
    .profile-avatar-container:hover,
    .profile-avatar-container:active {
      transform: scale(1.05);
      box-shadow: 0 8px 32px rgba(78, 205, 196, 0.3);
    }
    
    @media (min-width: 768px) {
      .profile-avatar-container {
        width: 120px;
        height: 120px;
        margin: 0 auto 24px;
      }
    }
    
    /* Tesla Touch Feedback */
    @media (hover: none) {
      .profile-avatar-container:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
      }
    }
    
    .profile-avatar {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    
    .avatar-placeholder {
      width: 100%;
      height: 100%;
      background: var(--tesla-surface);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 8px;
    }
    
    .placeholder-content svg {
      opacity: 0.6;
    }
    
    .placeholder-text {
      font-size: 12px;
      opacity: 0.8;
    }
    
    .avatar-upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .profile-avatar-container:hover .avatar-upload-overlay {
      opacity: 1;
    }
    
    .upload-content {
      text-align: center;
    }
    
    .upload-text {
      font-size: 12px;
      margin-top: 8px;
    }
    
    .profile-info {
      margin-bottom: 24px;
    }
    
    .profile-display-name {
      font-size: 32px;
      font-weight: 700;
      color: white;
      margin-bottom: 4px;
    }
    
    .profile-username {
      font-size: 20px;
      font-weight: 500;
      color: var(--tesla-primary);
      margin-bottom: 12px;
      opacity: 0.9;
    }
    
    .profile-bio {
      font-size: 16px;
      opacity: 0.8;
      line-height: 1.5;
      margin-bottom: 8px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .profile-location {
      font-size: 14px;
      opacity: 0.6;
      margin-bottom: 8px;
    }
    
    .profile-joined {
      font-size: 12px;
      opacity: 0.5;
    }
    
    /* Profile Actions */
    .profile-actions {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .btn-tesla {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .btn-primary {
      background: var(--tesla-primary);
      color: #000;
    }
    
    .btn-primary:hover {
      background: #3eb3a6;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(78, 205, 196, 0.3);
    }
    
    .btn-secondary {
      background: var(--tesla-surface);
      color: white;
      border: 1px solid var(--tesla-border);
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--tesla-primary);
    }
    
    /* Dashboard Grid */
    .profile-dashboard {
      display: grid;
      gap: 24px;
      margin-top: 40px;
    }
    
    .dashboard-section {
      background: var(--tesla-surface);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--tesla-border);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .section-icon {
      font-size: 20px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
    }
    
    .stat-item {
      text-align: center;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--tesla-primary);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      opacity: 0.7;
    }
    
    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 16px;
    }
    
    .achievement {
      text-align: center;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      opacity: 0.5;
      transition: all 0.3s ease;
    }
    
    .achievement.unlocked {
      opacity: 1;
      background: rgba(78, 205, 196, 0.1);
      border: 1px solid rgba(78, 205, 196, 0.3);
    }
    
    .achievement-icon {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }
    
    .achievement-name {
      font-size: 12px;
      font-weight: 500;
    }
    
    /* Tesla Avatar Crop Modal - Mobile First */
    .tesla-crop-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(20px);
      display: flex;
      align-items: flex-end; /* Mobile: Bottom sheet */
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.2, 0, 0.2, 1);
      padding: 0;
    }
    
    .tesla-crop-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .tesla-crop-content {
      background: #1a1a2e;
      border-radius: 24px 24px 0 0; /* Mobile: Rounded top only */
      padding: 24px;
      width: 100%;
      max-width: 100vw;
      max-height: 90vh;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.2, 0, 0.2, 1);
      position: relative;
      overflow-y: auto;
    }
    
    .tesla-crop-modal.active .tesla-crop-content {
      transform: translateY(0);
    }
    
    /* Desktop: Center modal on larger screens */
    @media (min-width: 768px) {
      .tesla-crop-modal {
        align-items: center;
        padding: 20px;
      }
      
      .tesla-crop-content {
        border-radius: 16px;
        max-width: 500px;
        max-height: 80vh;
        transform: scale(0.9) translateY(20px);
      }
      
      .tesla-crop-modal.active .tesla-crop-content {
        transform: scale(1) translateY(0);
      }
    }
    
    .crop-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    
    .crop-header h3 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .tesla-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    
    .tesla-close:hover {
      background: rgba(255,255,255,0.1);
    }
    
    /* Upload Area Styles */
    .crop-upload-area {
      border: 2px dashed var(--tesla-border);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .crop-upload-area:hover {
      border-color: var(--tesla-primary);
      background: rgba(78, 205, 196, 0.05);
    }
    
    .upload-prompt svg {
      opacity: 0.6;
      margin-bottom: 16px;
    }
    
    .upload-prompt p {
      margin-bottom: 8px;
      font-size: 16px;
    }
    
    .upload-hint {
      font-size: 12px !important;
      opacity: 0.6;
    }
    
    /* Preview Container */
    .crop-preview-container {
      margin-bottom: 20px;
    }
    
    .crop-preview {
      position: relative;
      max-height: 300px;
      overflow: hidden;
      border-radius: 12px;
      background: var(--tesla-surface);
    }
    
    /* Processing Animation */
    .crop-processing {
      text-align: center;
      padding: 40px 20px;
    }
    
    .processing-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--tesla-border);
      border-top: 3px solid var(--tesla-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Edit Profile Form Styles */
    .edit-profile-form {
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--tesla-primary);
    }
    
    .form-group input[type="text"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      background: var(--tesla-surface);
      border: 1px solid var(--tesla-border);
      border-radius: 8px;
      color: white;
      font-size: 16px;
      transition: all 0.3s ease;
      font-family: inherit;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 12px center;
      background-repeat: no-repeat;
      background-size: 16px;
    }
    
    .form-group input[type="text"]:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--tesla-primary);
      background: rgba(78, 205, 196, 0.1);
      box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
    }

    .location-selects {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .location-selects select {
      margin-bottom: 0;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-hint {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 4px;
      display: block;
    }
    
    /* Tesla Toggle Switch */
    .toggle-label {
      display: flex !important;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      font-weight: 500 !important;
      margin-bottom: 0 !important;
    }
    
    .toggle-label input[type="checkbox"] {
      display: none;
    }
    
    .toggle-slider {
      width: 48px;
      height: 24px;
      background: var(--tesla-border);
      border-radius: 24px;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .toggle-slider::before {
      content: '';
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: all 0.3s ease;
    }
    
    .toggle-label input[type="checkbox"]:checked + .toggle-slider {
      background: var(--tesla-primary);
    }
    
    .toggle-label input[type="checkbox"]:checked + .toggle-slider::before {
      transform: translateX(24px);
    }
    
    .crop-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    /* Tesla Button System - Mobile First */
    .tesla-btn {
      padding: 14px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      
      /* Tesla mobile touch target */
      min-height: 48px;
      min-width: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      
      /* Tesla touch feedback */
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
    }
    
    .tesla-btn:active {
      transform: scale(0.95);
      transition: transform 0.1s ease;
    }
    
    @media (min-width: 768px) {
      .tesla-btn {
        padding: 12px 20px;
        font-size: 14px;
        min-height: auto;
      }
      
      .tesla-btn:active {
        transform: none;
      }
    }
    
    .tesla-btn.tesla-secondary {
      background: var(--tesla-surface);
      color: white;
    }
    
    .tesla-btn.tesla-primary {
      background: var(--tesla-primary);
      color: #000;
    }
    
    /* Toast Notifications */
    .success-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--tesla-primary);
      color: #000;
      padding: 16px 20px;
      border-radius: 12px;
      font-weight: 600;
      z-index: 3000;
      animation: toastSlideIn 0.3s ease;
    }
    
    @keyframes toastSlideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .profile-container {
        padding: 60px 16px 20px;
      }
      
      .profile-actions {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn-tesla {
        justify-content: center;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .achievements-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Tesla Navigation - Dynamic Context-Aware -->
  <div class="back-navigation">
    <a href="#" class="nav-back" id="dynamicBackNav">
      <span id="backNavText">Back</span>
    </a>
  </div>
  
  <!-- Profile Container -->
  <div class="profile-container">
    <!-- Profile Hero Section -->
    <section class="profile-hero">
      <div class="profile-avatar-container" onclick="openAvatarCrop()">
        <img id="profileAvatar" class="profile-avatar" src="" alt="Profile Avatar" />
        <div class="avatar-placeholder" id="avatarPlaceholder">
          <div class="placeholder-content">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span class="placeholder-text">Add Photo</span>
          </div>
        </div>
        <div class="avatar-upload-overlay">
          <div class="upload-content">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
              <circle cx="12" cy="13" r="3"/>
            </svg>
            <div class="upload-text">Update Photo</div>
          </div>
        </div>
        <input type="file" id="avatarFileInput" accept="image/jpeg,image/jpg,image/png,image/webp" style="display: none;" />
      </div>
      
      <div class="profile-info">
        <h1 id="profileDisplayName" class="profile-display-name">Stay Hi User</h1>
        <h2 id="profileUsername" class="profile-username">@user_abc123</h2>
        <p id="profileBio" class="profile-bio">Living life one Hi at a time! 👋 Spreading positivity everywhere I go.</p>
        <p id="profileLocation" class="profile-location">📍 Somewhere Awesome</p>
        <p id="profileJoined" class="profile-joined">Member since October 2025</p>
      </div>
      
      <div class="profile-actions">
        <button class="btn-tesla btn-primary" onclick="editProfile()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Edit Profile
        </button>
        
        <button class="btn-tesla btn-secondary" onclick="shareProfile()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
          Share Profile
        </button>
        
        <button class="btn-tesla btn-secondary" onclick="openCalendar()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          View Calendar
        </button>
      </div>
    </section>
    
    <!-- Dashboard Grid -->
    <div class="profile-dashboard">
      <!-- Statistics Section -->
      <section class="dashboard-section">
        <div class="section-header">
          <span class="section-icon">📊</span>
          <h3 class="section-title">Hi Statistics</h3>
        </div>
        <div class="stats-grid" id="statsGrid">
          <div class="stat-item">
            <div class="stat-value" data-stat="hi_moments">127</div>
            <div class="stat-label">Hi Moments</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" data-stat="current_streak">12</div>
            <div class="stat-label">Day Streak</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" data-stat="total_waves">89</div>
            <div class="stat-label">Hi Waves</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" data-stat="total_starts">23</div>
            <div class="stat-label">Hi Starts</div>
          </div>
        </div>
      </section>
      
      <!-- Achievements Section -->
      <section class="dashboard-section">
        <div class="section-header">
          <span class="section-icon">🏆</span>
          <h3 class="section-title">Achievements</h3>
        </div>
        <div class="achievements-grid" id="achievementsGrid">
          <div class="achievement unlocked">
            <span class="achievement-icon">👋</span>
            <div class="achievement-name">First Hi</div>
          </div>
          <div class="achievement unlocked">
            <span class="achievement-icon">🔥</span>
            <div class="achievement-name">Week Streak</div>
          </div>
          <div class="achievement">
            <span class="achievement-icon">⭐</span>
            <div class="achievement-name">Popular</div>
          </div>
          <div class="achievement unlocked">
            <span class="achievement-icon">🌍</span>
            <div class="achievement-name">Explorer</div>
          </div>
          <div class="achievement">
            <span class="achievement-icon">👥</span>
            <div class="achievement-name">Social</div>
          </div>
          <div class="achievement">
            <span class="achievement-icon">🎖️</span>
            <div class="achievement-name">Veteran</div>
          </div>
        </div>
      </section>
    </div>
  </div>
  
  <!-- Social Avatar Uploader will create its own overlay dynamically -->

  <!-- Tesla Edit Profile Modal -->
  <div class="tesla-crop-modal" id="editProfileModal">
    <div class="tesla-crop-content">
      <div class="crop-header">
        <h3>Edit Profile</h3>
        <button onclick="closeEditProfile()" class="tesla-close">×</button>
      </div>
      
      <form id="editProfileForm" class="edit-profile-form">
        <div class="form-group">
          <label for="editDisplayName">Display Name</label>
          <input type="text" id="editDisplayName" placeholder="Your display name" maxlength="50">
        </div>
        
        <div class="form-group">
          <label for="editUsername">Username</label>
          <input type="text" id="editUsername" placeholder="@username" maxlength="30">
          <small class="form-hint">Only letters, numbers, and underscores</small>
        </div>
        
        <div class="form-group">
          <label for="editBio">Bio</label>
          <textarea id="editBio" placeholder="Tell us about yourself..." maxlength="160" rows="3"></textarea>
          <small class="form-hint" id="bioCounter">0/160</small>
        </div>
        
        <div class="form-group">
          <label for="sheetLocationInput">Location</label>
          <div class="location-input-container">
            <input type="text" id="sheetLocationInput" class="form-input" placeholder="Click to select location..." maxlength="100" readonly style="cursor: pointer;" onclick="openLocationPicker()" />
          </div>
          <p class="location-privacy">🔒 Only country and state/region are shared for privacy</p>
        </div>

        <div class="form-group">
          <label class="toggle-label">
            <input type="checkbox" id="editIsPublic">
            <span class="toggle-slider"></span>
            Public Profile
          </label>
          <small class="form-hint">Allow others to find and view your profile</small>
        </div>
      </form>
      
      <div class="crop-actions">
        <button onclick="closeEditProfile()" class="tesla-btn tesla-secondary">Cancel</button>
        <button onclick="saveProfileChanges()" class="tesla-btn tesla-primary">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    // Tesla-Grade Profile System - No Auth Barriers
    
    // Tesla Profile Data - Production Ready
    // Tesla-Grade Profile System - Persistent by Default
    let currentProfile = {
      username: '',
      display_name: 'Stay Hi User', 
      bio: 'Living life one Hi at a time! 👋',
      location: '',
      avatar_url: null,
      created_at: new Date().toISOString().split('T')[0],
      is_public: true,
      id: null
    };
    
    // Tesla Stats Data - Live Ready
    const userStats = {
      hi_moments: Math.floor(Math.random() * 200) + 50,
      current_streak: Math.floor(Math.random() * 30) + 1,
      longest_streak: Math.floor(Math.random() * 60) + 20,
      total_waves: Math.floor(Math.random() * 150) + 30,
      total_starts: Math.floor(Math.random() * 40) + 5,
      days_active: Math.floor(Math.random() * 100) + 10
    };
    
    // Social Media Grade Avatar System - Instagram/Twitter Style
    let socialAvatarUploader = null;
    
    function openAvatarCrop() {
      console.log('� Opening social media grade avatar uploader...');
      
      // Initialize social avatar uploader if not already done
      if (!socialAvatarUploader && window.SocialAvatarUploader) {
        try {
          socialAvatarUploader = new window.SocialAvatarUploader({
            onSave: async (blob, originalFile) => {
              console.log('💾 Avatar saved:', {
                size: blob.size,
                type: blob.type,
                originalName: originalFile.name
              });
              
              // Convert to display URL
              const url = URL.createObjectURL(blob);
              
              // Update profile avatar immediately (like Instagram)
              updateProfileAvatar(url);
              
              // Show success message
              showToast('Profile photo updated! 🎉');
              
              // In production, upload to Supabase storage here
              console.log('� Production: Upload blob to Supabase storage');
              console.log('📝 Production: Update user profile with new avatar URL');
              
              // Gold Standard: Upload to Supabase Storage
              try {
                showToast('Uploading your photo... 📤');
                const publicUrl = await uploadAvatarToSupabase(blob, originalFile);
                await updateProfileInDatabase(publicUrl);
                
                // Update with permanent URL
                updateProfileAvatar(publicUrl);
                currentProfile.avatar_url = publicUrl;
                showToast('Profile photo updated! 🎉');
                
                console.log('✅ Avatar successfully stored:', publicUrl);
              } catch (error) {
                console.error('❌ Upload failed:', error);
                showToast('Photo saved locally. Will retry upload automatically.', 'warning');
              }
              
              // Clean up local URL
              setTimeout(() => URL.revokeObjectURL(url), 30000);
            }
          });
          
          console.log('✅ Social Avatar Uploader initialized successfully');
        } catch (error) {
          console.error('❌ Failed to initialize SocialAvatarUploader:', error);
          showToast('Avatar system unavailable. Please refresh and try again.', 'error');
          return;
        }
      }
      
      // Trigger file selection - Instagram/Twitter style
      if (socialAvatarUploader) {
        socialAvatarUploader.selectFile();
      } else {
        console.error('❌ Social Avatar Uploader not available');
        showToast('Avatar system not ready. Please try again.', 'error');
      }
    }
    
    // Gold Standard Supabase Avatar Upload Functions
    async function uploadAvatarToSupabase(blob, originalFile) {
      console.log('📤 Uploading avatar to Supabase Storage...');
      
      // Enhanced debugging and validation
      console.log('🔍 Supabase client check:', {
        supabaseClient: !!window.supabaseClient,
        supabase: !!window.supabase,
        sb: !!window.sb
      });

      // Test bucket connectivity first
      await testSupabaseConnection();
      
      if (!window.supabaseClient && !window.sb) {
        throw new Error('Supabase client not initialized - check supabase-init.js loading');
      }
      
      const client = window.supabaseClient || window.sb;
      
      // Check if we need authentication for uploads
      const { data: session } = await client.auth.getSession();
      console.log('🔐 Auth session:', {
        hasSession: !!session?.session,
        user: session?.session?.user?.id || 'anonymous'
      });
      
      // Generate filename using stable user identity
      const timestamp = Date.now();
      const userId = currentProfile.id || generateStableUserId();
      const fileExt = originalFile.name.split('.').pop() || 'jpg';
      const fileName = `avatar_${userId}_${timestamp}.${fileExt}`;
      
      // Try different upload strategies based on auth status
      let filePath, uploadResult;
      
      if (session?.session?.user) {
        // Authenticated upload - use auth user ID
        filePath = `${session.session.user.id}/${fileName}`;
        console.log('👤 Authenticated upload to:', filePath);
      } else {
        // Anonymous but persistent - use stable user ID  
        const persistentUserId = currentProfile.id || generateStableUserId();
        filePath = `users/${persistentUserId}/${fileName}`;
        console.log('🔒 Persistent anonymous upload to:', filePath);
      }
      
      console.log('📦 Upload details:', {
        fileName,
        filePath,
        blobSize: blob.size,
        blobType: blob.type
      });
      
      // Upload to Supabase Storage
      uploadResult = await client.storage
        .from('avatars')
        .upload(filePath, blob, {
          contentType: blob.type,
          upsert: false
        });
      
      console.log('📤 Upload result:', uploadResult);
      
      if (uploadResult.error) {
        console.error('❌ Supabase upload error:', uploadResult.error);
        
        // Try fallback strategies
        if (uploadResult.error.message?.includes('new row violates row-level security') || 
            uploadResult.error.message?.includes('insufficient_privilege')) {
          
          console.log('🔄 Trying anonymous upload fallback...');
          const fallbackPath = `temp/${fileName}`;
          
          const fallbackResult = await client.storage
            .from('avatars')
            .upload(fallbackPath, blob, {
              contentType: blob.type,
              upsert: true // Allow overwrite for temp files
            });
          
          if (fallbackResult.error) {
            throw new Error(`Upload failed: ${fallbackResult.error.message}`);
          }
          
          filePath = fallbackPath;
        } else {
          throw new Error(`Upload failed: ${uploadResult.error.message}`);
        }
      }
      
      // Get public URL
      const { data: urlData } = client.storage
        .from('avatars')
        .getPublicUrl(filePath);
      
      console.log('🔗 Generated URL:', urlData.publicUrl);
      return urlData.publicUrl;
    }
    
    async function updateProfileInDatabase(avatarUrl) {
      console.log('📝 Updating profile in database...');
      
      if (!window.supabaseClient) {
        throw new Error('Supabase client not initialized');
      }
      
      // In a real app, you'd have a user ID from auth
      // For demo, we'll use the current profile username
      const { error } = await window.supabaseClient
        .from('profiles')
        .update({ avatar_url: avatarUrl, updated_at: new Date().toISOString() })
        .eq('username', currentProfile.username);
      
      if (error) {
        console.error('Database update error:', error);
        // Don't throw - avatar is uploaded, just log the error
        console.log('Avatar uploaded but profile update failed - will retry');
      }
    }
    
    function saveAvatar() {
      // Delegate to the existing saveCroppedAvatar function
      return saveCroppedAvatar();
    }
    
    function resetCropModalState() {
      // Reset UI elements
      document.getElementById('cropUploadArea').style.display = 'block';
      document.getElementById('cropPreviewContainer').style.display = 'none';
      document.getElementById('cropProcessing').style.display = 'none';
      document.getElementById('saveCropBtn').disabled = true;
      
      // Clear file input
      const fileInput = document.getElementById('avatarFileInput');
      if (fileInput) fileInput.value = '';
      
      currentCropImageFile = null;
    }
    
    function triggerFileSelect() {
      console.log('🖱️ Upload area clicked, triggering file select...');
      const fileInput = document.getElementById('avatarFileInput');
      if (fileInput) {
        console.log('📁 File input found, details:', {
          type: fileInput.type,
          accept: fileInput.accept,
          disabled: fileInput.disabled,
          style: fileInput.style.cssText
        });
        
        // Test if we can programmatically trigger
        try {
          fileInput.click();
          console.log('✅ File input click triggered successfully');
        } catch (error) {
          console.error('❌ Error triggering file input click:', error);
        }
      } else {
        console.error('❌ File input not found when clicked');
      }
    }
    
    // TEST FUNCTION: Call this from console to test file input directly
    function testFileInput() {
      console.log('🧪 Testing file input functionality...');
      const fileInput = document.getElementById('avatarFileInput');
      if (fileInput) {
        console.log('File input element:', fileInput);
        console.log('Event listeners:', getEventListeners ? getEventListeners(fileInput) : 'getEventListeners not available');
        fileInput.focus();
        fileInput.click();
      }
    }
    
    // Expose for console testing
    window.testFileInput = testFileInput;
    window.triggerFileSelect = triggerFileSelect;
    
    function setupFileInputHandler() {
      const fileInput = document.getElementById('avatarFileInput');
      if (!fileInput) {
        console.error('❌ avatarFileInput not found');
        return false;
      }
      
      // FIXED: Don't replace element - just attach handlers directly
      console.log('📁 Attaching handlers directly to existing element...');
      
      // Set up fresh event handlers on original element
      fileInput.addEventListener('change', handleImageUpload, { passive: false });
      
      // Add comprehensive debugging
      fileInput.addEventListener('click', () => {
        console.log('📁 File input CLICKED! This should show when you click it');
      });
      
      fileInput.addEventListener('focus', () => {
        console.log('🎯 File input FOCUSED!');
      });
      
      fileInput.addEventListener('input', () => {
        console.log('� File input changed (input event)');
      });
      
      console.log('✅ File input handler setup complete - FIXED VERSION');
      return true;
    }
    
    function setupDragAndDrop() {
      const uploadArea = document.getElementById('cropUploadArea');
      if (!uploadArea) return;
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        uploadArea.style.background = 'rgba(78, 205, 196, 0.1)';
        uploadArea.style.borderColor = 'var(--tesla-primary)';
      }
      
      function unhighlight() {
        uploadArea.style.background = '';
        uploadArea.style.borderColor = '';
      }
      
      uploadArea.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          handleImageFile(files[0]);
        }
      }
    }
    
    function handleImageUpload(e) {
      console.log('📁 handleImageUpload triggered:', e.type, 'Files:', e.target.files.length);
      console.log('📂 Files object:', e.target.files);
      
      const file = e.target.files[0];
      if (file) {
        console.log('✅ File selected:', {
          name: file.name,
          type: file.type,
          size: file.size,
          lastModified: file.lastModified
        });
        handleImageFile(file);
      } else {
        console.error('❌ No file selected, files array:', Array.from(e.target.files));
      }
    }
    
    function handleImageFile(file) {
      console.log('🖼️ Tesla handleImageFile called:', file.name, file.type, file.size);
      
      // Tesla-grade validation
      if (!file.type.startsWith('image/')) {
        showToast('Please select a valid image file', 'error');
        console.error('❌ Invalid file type:', file.type);
        return;
      }
      
      if (file.size > 10 * 1024 * 1024) { // 10MB limit
        showToast('Image size must be less than 10MB', 'error');
        console.error('❌ File too large:', file.size);
        return;
      }
      
      currentCropImageFile = file;
      console.log('✅ File validation passed, processing...');
      
      // Show processing state
      const uploadArea = document.getElementById('cropUploadArea');
      const processingEl = document.getElementById('cropProcessing');
      
      if (uploadArea) uploadArea.style.display = 'none';
      if (processingEl) processingEl.style.display = 'block';
      
      console.log('🔄 Showing processing state...');
      
      // Load and display image for cropping
      const reader = new FileReader();
      reader.onload = function(e) {
        console.log('📖 FileReader loaded image data');
        
        const imgElement = document.getElementById('cropImagePreview');
        if (!imgElement) {
          console.error('❌ cropImagePreview element not found');
          return;
        }
        
        imgElement.src = e.target.result;
        console.log('🖼️ Image src set, waiting for load...');
        
        // Wait for image to load before showing preview
        imgElement.onload = function() {
          console.log('✅ Image loaded in DOM, showing preview...');
          console.log('🖼️ Image loaded details:', {
            complete: imgElement.complete,
            naturalWidth: imgElement.naturalWidth,
            naturalHeight: imgElement.naturalHeight,
            width: imgElement.width,
            height: imgElement.height,
            src: imgElement.src.substring(0, 50) + '...'
          });
          
          // Show preview container
          setTimeout(() => {
            const processingEl = document.getElementById('cropProcessing');
            const previewContainer = document.getElementById('cropPreviewContainer');
            
            if (processingEl) processingEl.style.display = 'none';
            if (previewContainer) {
              previewContainer.style.display = 'block';
              console.log('✅ Preview container is now visible');
            }
            
            console.log('🎯 Preview container shown, initializing Tesla cropper...');
            
            // Ensure image has rendered dimensions before cropper init
            setTimeout(() => {
              console.log('🔄 Final check before cropper init:', {
                imgRect: imgElement.getBoundingClientRect(),
                containerRect: document.getElementById('cropPreview').getBoundingClientRect()
              });
              
              // Initialize Tesla cropper
              initializeTeslaCropper(imgElement);
            }, 100);
            
          }, 300); // Reduced delay for better UX
        };
        
        imgElement.onerror = function() {
          console.error('❌ Failed to load image in DOM');
          showToast('Failed to load image. Please try again.', 'error');
        };
      };
      
      reader.onerror = function() {
        console.error('❌ FileReader failed');
        showToast('Failed to read file. Please try again.', 'error');
      };
      
      reader.readAsDataURL(file);
    }
    
    function initializeTeslaCropper(imgElement) {
      console.log('🚀 Initializing Tesla cropper...');
      console.log('Tesla classes available:', {
        TeslaAvatarCropper: !!window.TeslaAvatarCropper,
        TeslaAvatarUploader: !!window.TeslaAvatarUploader,
        teslaAvatarCropper: !!teslaAvatarCropper
      });
      
      // Debug DOM elements
      console.log('🔍 DOM elements debug:', {
        imgElement: !!imgElement,
        imgSrc: imgElement ? imgElement.src?.substring(0, 50) + '...' : 'none',
        imgDimensions: imgElement ? `${imgElement.width}x${imgElement.height}` : 'none',
        cropPreview: !!document.getElementById('cropPreview'),
        cropPreviewContainer: !!document.getElementById('cropPreviewContainer')
      });
      
      // Ensure Tesla cropper is initialized
      if (!teslaAvatarCropper && window.TeslaAvatarCropper) {
        console.log('🔧 Creating new Tesla cropper instance...');
        teslaAvatarCropper = new window.TeslaAvatarCropper();
        console.log('✅ Tesla cropper instance created:', !!teslaAvatarCropper);
      }
      
      if (teslaAvatarCropper) {
        const previewContainer = document.getElementById('cropPreview');
        if (previewContainer) {
          console.log('📐 Container info:', {
            containerRect: previewContainer.getBoundingClientRect(),
            containerStyle: getComputedStyle(previewContainer).position,
            imgLoaded: imgElement.complete,
            imgNaturalDimensions: `${imgElement.naturalWidth}x${imgElement.naturalHeight}`
          });
          
          try {
            console.log('🎯 Calling teslaAvatarCropper.initCropper...');
            const result = teslaAvatarCropper.initCropper(imgElement, previewContainer);
            console.log('🔧 Cropper init result:', result);
            
            document.getElementById('saveCropBtn').disabled = false;
            
            console.log('✅ Tesla cropper initialized successfully');
            showToast('Image loaded! Drag to adjust crop area 🎯');
          } catch (error) {
            console.error('❌ Tesla cropper initialization failed:', error);
            console.error('❌ Full error stack:', error.stack);
            showToast('Failed to initialize cropper. Please try again.', 'error');
          }
        } else {
          console.error('❌ cropPreview container not found');
        }
      } else {
        console.error('❌ Tesla cropper not available');
        showToast('Cropper not available. Please refresh and try again.', 'error');
      }
    }
    
    async function saveCroppedAvatar() {
      if (!teslaAvatarCropper || !currentCropImageFile) {
        showToast('No image to save', 'error');
        return;
      }
      
      try {
        // Show processing state
        document.getElementById('cropProcessing').style.display = 'block';
        document.getElementById('cropPreviewContainer').style.display = 'none';
        
        // Get cropped image data from Tesla cropper
        const croppedBlob = await teslaAvatarCropper.getCroppedImage(0.9);
        
        if (!croppedBlob) {
          throw new Error('Failed to generate cropped image');
        }
        
        // Tesla-grade upload with progress
        let avatarUrl;
        if (teslaAvatarUploader) {
          avatarUrl = await teslaAvatarUploader.uploadAvatar(croppedBlob, currentProfile.username);
        } else {
          // Fallback: Create data URL for demo
          avatarUrl = await blobToDataURL(croppedBlob);
        }
        
        // Update profile avatar
        updateProfileAvatar(avatarUrl);
        
        showToast('Tesla-grade avatar saved successfully! 🚀');
        closeAvatarCrop();
        
      } catch (error) {
        console.error('Avatar save error:', error);
        showToast('Failed to save avatar. Please try again.', 'error');
        
        // Reset to preview state
        document.getElementById('cropProcessing').style.display = 'none';
        document.getElementById('cropPreviewContainer').style.display = 'block';
      }
    }
    
    function updateProfileAvatar(avatarUrl) {
      const avatarEl = document.getElementById('profileAvatar');
      const placeholderEl = document.getElementById('avatarPlaceholder');
      
      console.log('🖼️ Updating profile avatar:', { avatarUrl, avatarEl: !!avatarEl, placeholderEl: !!placeholderEl });
      
      if (avatarEl && placeholderEl) {
        if (avatarUrl) {
          avatarEl.src = avatarUrl;
          avatarEl.style.display = 'block';
          placeholderEl.style.display = 'none';
          console.log('✅ Avatar displayed:', avatarUrl);
        } else {
          avatarEl.style.display = 'none';
          placeholderEl.style.display = 'block';
          console.log('📷 Avatar placeholder displayed - no avatar URL');
        }
      } else {
        console.error('❌ Avatar elements not found:', { avatarEl: !!avatarEl, placeholderEl: !!placeholderEl });
      }
    }
    
    function blobToDataURL(blob) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    // Tesla-Grade Location Picker Integration
    function openLocationPicker() {
      console.log('🌍 Opening location picker...');
      if (window.LocationPicker) {
        window.LocationPicker.show((result) => {
          const locationInput = document.getElementById('sheetLocationInput');
          if (locationInput) {
            locationInput.value = result.formatted;
            console.log('📍 Location selected:', result.formatted);
          }
        });
      } else {
        console.error('❌ LocationPicker not available');
      }
    }
    
    // Hi-Island Calendar Integration
    function openCalendar() {
      console.log('📅 Opening premium calendar...');
      
      // Integration with premium-calendar.js
      if (window.PremiumCalendar && window.PremiumCalendar.show) {
        window.PremiumCalendar.show();
      } else {
        // Fallback: Navigate to calendar page
        window.location.href = 'calendar.html';
      }
    }

    function openEditCalendar() {
      console.log('📅 Opening calendar from edit modal...');
      
      // Use the same premium calendar system
      if (window.PremiumCalendar && window.PremiumCalendar.show) {
        window.PremiumCalendar.show();
      } else {
        // Fallback: Navigate to calendar page
        window.location.href = 'calendar.html';
      }
    }

    async function testSupabaseConnection() {
      console.log('🔧 Testing Supabase storage connection...');
      
      const client = window.supabaseClient || window.sb;
      if (!client) {
        throw new Error('No Supabase client available');
      }

      try {
        // Test 1: Check if we can access the avatars bucket
        console.log('🧪 Test 1: Checking bucket access...');
        const { data: buckets, error: bucketError } = await client.storage.listBuckets();
        
        if (bucketError) {
          console.warn('⚠️ Cannot list buckets:', bucketError.message);
          console.log('🔄 Trying alternative bucket test...');
          
          // Alternative: try to list files in avatars bucket
          const { data: files, error: filesError } = await client.storage
            .from('avatars')
            .list('', { limit: 1 });
            
          if (filesError) {
            console.error('❌ Bucket not accessible:', filesError.message);
            throw new Error(`Avatars bucket not accessible: ${filesError.message}`);
          }
          
          console.log('✅ Avatars bucket is accessible via file listing');
        } else {
          const avatarsBucket = buckets?.find(b => b.name === 'avatars');
          if (avatarsBucket) {
            console.log('✅ Avatars bucket found:', avatarsBucket);
          } else {
            console.error('❌ Avatars bucket not found in:', buckets?.map(b => b.name));
            throw new Error('Avatars bucket does not exist');
          }
        }

        // Test 2: Check authentication status
        const { data: session } = await client.auth.getSession();
        console.log('🔐 Auth status:', {
          authenticated: !!session?.session,
          userId: session?.session?.user?.id || 'none',
          role: session?.session?.user?.role || 'anonymous'
        });

        // Test 3: Check storage policies with a small test
        console.log('🧪 Test 3: Testing upload permissions...');
        const testBlob = new Blob(['test'], { type: 'text/plain' });
        const testPath = `test/${Date.now()}_test.txt`;
        
        const { error: testError } = await client.storage
          .from('avatars')
          .upload(testPath, testBlob, { upsert: false });
          
        if (testError) {
          console.warn('⚠️ Test upload failed:', testError.message);
          if (testError.message.includes('row-level security')) {
            console.log('🔒 RLS policies blocking upload. Need to add anonymous upload policy.');
            console.log('📋 SQL to run in Supabase:');
            console.log(`
CREATE POLICY "Allow anonymous uploads to temp folder" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'avatars' 
  AND storage.foldername(name) = 'temp'
);`);
          }
        } else {
          console.log('✅ Test upload succeeded - will clean up');
          // Clean up test file
          await client.storage.from('avatars').remove([testPath]);
        }
        
        console.log('🎯 Storage connection test complete');
        
      } catch (error) {
        console.error('💥 Storage connection test failed:', error);
        throw error;
      }
    }
    
    // Tesla-Grade Edit Profile System
    function editProfile() {
      console.log('🚀 Opening Tesla edit profile modal...');
      const modal = document.getElementById('editProfileModal');
      modal.classList.add('active');
      
      // Populate current profile data
      populateEditForm();
      
      showToast('Edit your profile details below 📝');
    }
    
    function closeEditProfile() {
      const modal = document.getElementById('editProfileModal');
      modal.classList.remove('active');
    }
    
    function populateEditForm() {
      document.getElementById('editDisplayName').value = currentProfile.display_name || '';
      document.getElementById('editUsername').value = currentProfile.username || '';
      document.getElementById('editBio').value = currentProfile.bio || '';
      document.getElementById('editLocation').value = currentProfile.location || '';
      document.getElementById('editIsPublic').checked = currentProfile.is_public || false;
      
      // Update bio counter
      updateBioCounter();
      
      // Setup form listeners
      setupEditFormListeners();
    }
    
    function setupEditFormListeners() {
      const bioTextarea = document.getElementById('editBio');
      const usernameInput = document.getElementById('editUsername');
      
      // Bio counter
      bioTextarea.addEventListener('input', updateBioCounter);
      
      // Username validation
      usernameInput.addEventListener('input', function() {
        let value = this.value.replace(/[^a-zA-Z0-9_]/g, '');
        if (value && !value.startsWith('@')) {
          value = '@' + value;
        }
        this.value = value;
      });
    }
    
    function updateBioCounter() {
      const bioTextarea = document.getElementById('editBio');
      const counter = document.getElementById('bioCounter');
      const length = bioTextarea.value.length;
      counter.textContent = `${length}/160`;
      
      if (length > 140) {
        counter.style.color = '#FFD93D'; // Warning color
      } else if (length > 160) {
        counter.style.color = '#FF6B6B'; // Error color
      } else {
        counter.style.color = ''; // Reset
      }
    }
    
    async function saveProfileChanges() {
      const formData = {
        display_name: document.getElementById('editDisplayName').value.trim(),
        username: document.getElementById('editUsername').value.replace('@', '').trim(),
        bio: document.getElementById('editBio').value.trim(),
        is_public: document.getElementById('editIsPublic').checked
      };

      // Get location from LocationPicker input (Tesla-grade single source of truth)
      const locationInput = document.getElementById('sheetLocationInput');
      formData.location = locationInput ? locationInput.value.trim() : '';
      
      // Tesla-grade validation
      if (!formData.display_name) {
        showToast('Display name is required', 'error');
        return;
      }
      
      if (!formData.username || formData.username.length < 3) {
        showToast('Username must be at least 3 characters', 'error');
        return;
      }
      
      if (formData.bio.length > 160) {
        showToast('Bio must be 160 characters or less', 'error');
        return;
      }
      
      try {
        // Update current profile immediately
        Object.assign(currentProfile, formData);
        
        // Tesla-Grade Persistence: Multi-layer storage strategy
        await saveProfileToStorage(currentProfile);
        
        // Update UI immediately for instant feedback
        updateProfileDisplay(currentProfile);
        
        // Close modal
        closeEditProfile();
        
        showToast('Profile saved successfully! 🎉', 'success');
        console.log('✅ Profile persisted:', formData);
        
      } catch (error) {
        console.error('❌ Profile save error:', error);
        showToast('Failed to save profile. Please try again.', 'error');
      }
    }

    // Tesla-Grade Multi-Layer Persistence Strategy
    async function saveProfileToStorage(profile) {
      const profileData = {
        ...profile,
        last_updated: new Date().toISOString(),
        version: '1.0'
      };

      try {
        // Layer 1: Local Storage (immediate persistence)
        localStorage.setItem('stayhi_profile', JSON.stringify(profileData));
        console.log('💾 Profile saved to localStorage');

        // Layer 2: Supabase Database (cloud persistence)
        if (window.supabaseClient) {
          await saveProfileToSupabase(profileData);
        }

        // Layer 3: Session backup
        sessionStorage.setItem('stayhi_profile_backup', JSON.stringify(profileData));
        
      } catch (error) {
        console.error('Storage save error:', error);
        throw error;
      }
    }

    async function saveProfileToSupabase(profile) {
      try {
        const { data, error } = await window.supabaseClient
          .from('profiles')
          .upsert({
            id: profile.id || profile.username,
            username: profile.username,
            display_name: profile.display_name,
            bio: profile.bio,
            location: profile.location,
            avatar_url: profile.avatar_url,
            is_public: profile.is_public,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'username'
          });

        if (error) {
          console.warn('⚠️ Supabase save failed:', error.message);
          // Don't throw - localStorage still works
        } else {
          console.log('☁️ Profile synced to Supabase');
        }
      } catch (error) {
        console.warn('⚠️ Supabase unavailable:', error.message);
        // Graceful degradation - localStorage still works
      }
    }
    
    function shareProfile() {
      const profileUrl = `${window.location.origin}/profile/${currentProfile.username}`;
      
      if (navigator.share) {
        navigator.share({
          title: `${currentProfile.display_name} on Stay Hi`,
          text: `Check out ${currentProfile.display_name}'s Hi profile!`,
          url: profileUrl
        });
      } else {
        navigator.clipboard.writeText(profileUrl);
        showToast('Profile link copied to clipboard! 📋');
      }
    }
    
    // Tesla-Grade Toast System
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      
      // Tesla-grade styling based on type
      const baseStyles = {
        position: 'fixed',
        bottom: '20px',
        left: '50%',
        transform: 'translateX(-50%)',
        padding: '12px 20px',
        borderRadius: '8px',
        color: 'white',
        fontWeight: '500',
        fontSize: '14px',
        zIndex: '3000',
        opacity: '0',
        transition: 'opacity 0.3s ease',
        maxWidth: '80vw',
        textAlign: 'center'
      };
      
      const typeStyles = {
        success: { background: 'rgba(78, 205, 196, 0.9)', border: '1px solid #4ECDC4' },
        error: { background: 'rgba(255, 107, 107, 0.9)', border: '1px solid #FF6B6B' },
        info: { background: 'rgba(255, 217, 61, 0.9)', border: '1px solid #FFD93D', color: '#000' }
      };
      
      // Apply styles
      Object.assign(toast.style, baseStyles, typeStyles[type] || typeStyles.success);
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      // Tesla-grade animation
      setTimeout(() => toast.style.opacity = '1', 10);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // Expose globally for Tesla avatar system
    window.showTeslaToast = showToast;
    
    // Tesla Profile Display Update System
    function updateProfileDisplay(profileData) {
      console.log('🔄 Updating profile display...', profileData);
      
      // Update username
      const usernameEl = document.getElementById('profileUsername');
      if (usernameEl && profileData.username) {
        usernameEl.textContent = `@${profileData.username}`;
      }
      
      // Update display name
      const displayNameEl = document.getElementById('profileDisplayName');
      if (displayNameEl && profileData.display_name) {
        displayNameEl.textContent = profileData.display_name;
      }
      
      // Update bio
      const bioEl = document.getElementById('profileBio');
      if (bioEl) {
        bioEl.textContent = profileData.bio || 'No bio yet. Click edit to add one!';
      }
      
      // Update location
      const locationEl = document.getElementById('profileLocation');
      if (locationEl) {
        locationEl.textContent = profileData.location || 'Location not set';
      }
      
      // Update joined date
      const joinedEl = document.getElementById('profileJoined');
      if (joinedEl && profileData.created_at) {
        const joinDate = new Date(profileData.created_at);
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        joinedEl.textContent = `Joined ${monthNames[joinDate.getMonth()]} ${joinDate.getFullYear()}`;
      }
      
      // Update avatar if available
      if (profileData.avatar_url) {
        updateProfileAvatar(profileData.avatar_url);
      }
      
      console.log('✅ Profile display updated');
    }
    
    // Tesla Stats Display System
    function updateStatsDisplay(statsData) {
      console.log('📊 Updating stats display...', statsData);
      
      // Update individual stat values with Tesla-grade animation
      Object.entries(statsData).forEach(([key, value], index) => {
        const statEl = document.querySelector(`[data-stat="${key}"]`);
        if (statEl) {
          // Tesla-grade counting animation
          setTimeout(() => {
            animateCounter(statEl, 0, value, 800);
          }, index * 100);
        }
      });
      
      console.log('✅ Stats display updated');
    }
    
    function animateCounter(element, start, end, duration) {
      const range = end - start;
      const startTime = performance.now();
      
      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Tesla-grade easing
        const easeOutQuart = 1 - Math.pow(1 - progress, 4);
        const current = Math.floor(start + (range * easeOutQuart));
        
        element.textContent = current.toLocaleString();
        
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      
      requestAnimationFrame(update);
    }
    
    // Tesla Avatar System Validation
    function validateTeslaAvatarSystem() {
      console.log('🔍 Validating Tesla Avatar System...');
      
      const validations = {
        'TeslaAvatarCropper': !!window.TeslaAvatarCropper,
        'TeslaAvatarUploader': !!window.TeslaAvatarUploader,
        'Avatar Modal': !!document.getElementById('avatarCropModal'),
        'File Input': !!document.getElementById('avatarFileInput'),
        'Preview Container': !!document.getElementById('cropPreviewContainer'),
        'Toast System': typeof showToast === 'function'
      };
      
      let allValid = true;
      Object.entries(validations).forEach(([name, isValid]) => {
        const status = isValid ? '✅' : '❌';
        console.log(`${status} ${name}: ${isValid}`);
        if (!isValid) allValid = false;
      });
      
      if (allValid) {
        console.log('🚀 Tesla Avatar System: READY');
        return true;
      } else {
        console.error('🚫 Tesla Avatar System: INCOMPLETE');
        return false;
      }
    }
    
    // Tesla System Initialization
    function initializeTeslaAvatarSystem() {
      console.log('🔧 Initializing Tesla Avatar System...');
      
      // Wait for Tesla classes to be available
      let attempts = 0;
      const maxAttempts = 50; // 5 seconds max
      
      const checkInterval = setInterval(() => {
        attempts++;
        
        if (window.TeslaAvatarCropper && window.TeslaAvatarUploader) {
          clearInterval(checkInterval);
          console.log('✅ Tesla classes available, system ready');
          validateTeslaAvatarSystem();
          return;
        }
        
        if (attempts >= maxAttempts) {
          clearInterval(checkInterval);
          console.error('❌ Tesla classes not available after 5 seconds');
          showToast('Avatar system failed to load. Please refresh the page.', 'error');
          return;
        }
        
        console.log(`⏳ Waiting for Tesla classes... (${attempts}/${maxAttempts})`);
      }, 100);
    }
    
    // Auto-initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initializeTeslaAvatarSystem, 100);
    });
    
    // Progressive Data Loading
    async function loadProfileData() {
      console.log('🔄 Loading profile data...');
      
      try {
        // Tesla-Grade Loading Priority: localStorage → Supabase → demo fallback
        let profile = null;
        
        // Layer 1: Check localStorage first (fastest)
        const savedProfile = localStorage.getItem('stayhi_profile');
        if (savedProfile) {
          try {
            profile = JSON.parse(savedProfile);
            console.log('💾 Profile loaded from localStorage:', profile.username);
          } catch (e) {
            console.warn('⚠️ Invalid localStorage profile data');
          }
        }
        
        // Layer 2: Try Supabase if no local data or if we want to sync
        if (!profile && window.supabaseClient) {
          profile = await loadProfileFromSupabase();
        }
        
        // Layer 3: Use current profile as fallback but make it persistent
        if (!profile) {
          console.log('📊 No saved profile found, creating persistent profile...');
          profile = { ...currentProfile };
          // Generate stable user ID instead of random
          profile.id = generateStableUserId();
          profile.username = profile.username || `user_${profile.id.slice(-6)}`;
          await saveProfileToStorage(profile);
        }
        
        // Update current profile and UI
        Object.assign(currentProfile, profile);
        updateProfileDisplay(currentProfile);
        populateEditForm(currentProfile);
        
        console.log('✅ Profile loaded successfully:', currentProfile.username);
        
      } catch (error) {
        console.error('❌ Profile loading error:', error);
        // Ensure we always have a working profile
        populateEditForm(currentProfile);
      }
    }

    async function loadProfileFromSupabase() {
      try {
        // For now, we'll use username-based lookup
        // In production, you'd use proper user authentication
        const { data, error } = await window.supabaseClient
          .from('profiles')
          .select('*')
          .order('updated_at', { ascending: false })
          .limit(1);

        if (error) {
          console.warn('⚠️ Supabase query failed:', error.message);
          return null;
        }

        if (data && data.length > 0) {
          console.log('☁️ Profile loaded from Supabase');
          return data[0];
        }

        return null;
      } catch (error) {
        console.warn('⚠️ Supabase unavailable:', error.message);
        return null;
      }
    }

    function generateStableUserId() {
      // Create a stable ID based on browser fingerprint
      let stored = localStorage.getItem('stayhi_user_id');
      if (stored) return stored;
      
      // Generate stable ID from browser characteristics
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('StayHi', 2, 2);
      
      const fingerprint = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset(),
        canvas.toDataURL()
      ].join('|');
      
      // Simple hash function
      let hash = 0;
      for (let i = 0; i < fingerprint.length; i++) {
        const char = fingerprint.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
      }
      
      const userId = Math.abs(hash).toString(36);
      localStorage.setItem('stayhi_user_id', userId);
      return userId;
    }

    function populateEditForm(profile) {
      // Populate edit form with current data
      const displayNameEl = document.getElementById('editDisplayName');
      const usernameEl = document.getElementById('editUsername');
      const bioEl = document.getElementById('editBio');
      const publicEl = document.getElementById('editIsPublic');
      const locationEl = document.getElementById('sheetLocationInput');
      
      if (displayNameEl) displayNameEl.value = profile.display_name || '';
      if (usernameEl) usernameEl.value = profile.username || '';
      if (bioEl) bioEl.value = profile.bio || '';
      if (publicEl) publicEl.checked = profile.is_public !== false;
      if (locationEl) locationEl.value = profile.location || '';
      
      console.log('✅ Edit form populated:', {
        display_name: profile.display_name,
        username: profile.username,
        bio: profile.bio?.length || 0,
        location: profile.location,
        is_public: profile.is_public
      });
    }

    // Tesla-Grade Profile Display Update System (consolidated)
    function updateProfileDisplay(profileData) {
      console.log('🔄 Updating profile display...', profileData);
      
      // Update username
      const usernameEl = document.getElementById('profileUsername');
      if (usernameEl && profileData.username) {
        usernameEl.textContent = `@${profileData.username}`;
      }
      
      // Update display name
      const displayNameEl = document.getElementById('profileDisplayName');
      if (displayNameEl && profileData.display_name) {
        displayNameEl.textContent = profileData.display_name;
      }
      
      // Update bio
      const bioEl = document.getElementById('profileBio');
      if (bioEl) {
        bioEl.textContent = profileData.bio || 'No bio yet. Click edit to add one!';
      }
      
      // Update location
      const locationEl = document.getElementById('profileLocation');
      if (locationEl) {
        locationEl.textContent = profileData.location || 'Location not set';
      }
      
      // Update joined date
      const joinedEl = document.getElementById('profileJoined');
      if (joinedEl && profileData.created_at) {
        const joinDate = new Date(profileData.created_at);
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        joinedEl.textContent = `Joined ${monthNames[joinDate.getMonth()]} ${joinDate.getFullYear()}`;
      }
      
      // Update avatar if available
      if (profileData.avatar_url) {
        updateProfileAvatar(profileData.avatar_url);
      }
      
      console.log('✅ Profile display updated');
    }
    
    function updateStatsDisplay(stats) {
      const statsGrid = document.getElementById('statsGrid');
      if (!statsGrid) return;
      
      statsGrid.innerHTML = `
        <div class="stat-item">
          <div class="stat-value">${stats.hi_moments || 0}</div>
          <div class="stat-label">Hi Moments</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${stats.current_streak || 0}</div>
          <div class="stat-label">Day Streak</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${stats.total_waves || 0}</div>
          <div class="stat-label">Hi Waves</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${stats.total_starts || 0}</div>
          <div class="stat-label">Hi Starts</div>
        </div>
      `;
    }
    
    // Tesla-Grade Dynamic Navigation System
    function initDynamicNavigation() {
      const backNav = document.getElementById('dynamicBackNav');
      const backNavText = document.getElementById('backNavText');
      
      if (!backNav || !backNavText) return;
      
      // Navigation mapping - Tesla-grade contextual routing
      const navigationMap = {
        'hi-island-NEW.html': {
          url: 'hi-island-NEW.html',
          text: 'Back to Hi Island',
          icon: '🏝️'
        },
        'hi-island.html': {
          url: 'hi-island-NEW.html', // Always use NEW version
          text: 'Back to Hi Island',
          icon: '🏝️'
        },
        'index.html': {
          url: 'index.html',
          text: 'Back to Home',
          icon: '🏠'
        },
        'calendar.html': {
          url: 'calendar.html', 
          text: 'Back to Calendar',
          icon: '📅'
        },
        'hi-muscle.html': {
          url: 'hi-muscle.html',
          text: 'Back to Hi Muscle',
          icon: '💪'
        },
        'welcome.html': {
          url: 'index.html', // Welcome redirects to home
          text: 'Back to Home',
          icon: '🏠'
        }
      };
      
      // Default fallback navigation
      const defaultNav = {
        url: 'index.html',
        text: 'Back to Home', 
        icon: '🏠'
      };
      
      let targetNav = defaultNav;
      
      // Method 1: Check URL parameters (highest priority)
      const urlParams = new URLSearchParams(window.location.search);
      const fromParam = urlParams.get('from');
      if (fromParam && navigationMap[fromParam]) {
        targetNav = navigationMap[fromParam];
        console.log('🎯 Navigation from URL param:', fromParam);
      } 
      // Method 2: Check document.referrer (medium priority)
      else if (document.referrer) {
        try {
          const referrerUrl = new URL(document.referrer);
          const referrerPath = referrerUrl.pathname.split('/').pop() || 'index.html';
          
          if (navigationMap[referrerPath]) {
            targetNav = navigationMap[referrerPath];
            console.log('🔍 Navigation from referrer:', referrerPath);
          } else {
            console.log('🤔 Unknown referrer, using default:', referrerPath);
          }
        } catch (error) {
          console.log('📝 Invalid referrer URL, using default');
        }
      }
      // Method 3: Check localStorage for last page (lowest priority) 
      else {
        const lastPage = localStorage.getItem('stayhi_last_page');
        if (lastPage && navigationMap[lastPage]) {
          targetNav = navigationMap[lastPage];
          console.log('💾 Navigation from localStorage:', lastPage);
        }
      }
      
      // Apply navigation configuration
      backNav.href = targetNav.url;
      backNavText.textContent = targetNav.text;
      
      // Add icon if available
      if (targetNav.icon) {
        backNavText.innerHTML = `${targetNav.icon} ${targetNav.text}`;
      }
      
      console.log('🧭 Dynamic navigation configured:', targetNav);
      
      // Track this page visit for future navigation
      localStorage.setItem('stayhi_last_page', 'profile.html');
    }
    
    // Tesla-Grade Initialization
    document.addEventListener('DOMContentLoaded', () => {
      console.log('🚀 Tesla Profile System Initialized');
      
      // Initialize dynamic navigation first
      initDynamicNavigation();
      
      // Initialize profile display immediately
      updateProfileDisplay(currentProfile);
      updateStatsDisplay(userStats);
      
      showToast('Profile loaded successfully! 🎉');
      
      // Progressive enhancement: Load real data if available
      setTimeout(loadProfileData, 500);
      
      // Avatar file input handler
      const avatarInput = document.getElementById('avatarFileInput');
      if (avatarInput) {
        avatarInput.addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            openAvatarCrop();
          }
        });
      }
    });
    
    // Global exposure for debugging and integration
    window.currentProfile = currentProfile;
    window.userStats = userStats;
    window.TeslaProfile = {
      openAvatarCrop,
      closeAvatarCrop,
      saveAvatar,
      openCalendar,
      openEditCalendar,
      editProfile,
      shareProfile,
      loadProfileData,
      showToast,
      testSupabaseConnection
    };
    
    console.log('✅ Tesla Profile System Ready - No Auth Barriers');
    
    // Debug: Add test functions to window for manual testing
    window.testProfilePersistence = {
      save: () => saveProfileToStorage(currentProfile),
      load: () => loadProfileData(),
      clear: () => localStorage.removeItem('stayhi_profile'),
      showCurrent: () => console.log('Current Profile:', currentProfile),
      showSaved: () => console.log('Saved Profile:', JSON.parse(localStorage.getItem('stayhi_profile') || 'null'))
    };
    console.log('🧪 Debug functions available: window.testProfilePersistence');
  </script>
  
  <!-- Location Picker Functions -->
  <script>
    // Gold-standard global location data for worldwide users
    // Tesla-Grade: LocationPicker handles all global locations - eliminated 140+ lines of duplicate data
        'California': ['Los Angeles', 'San Francisco', 'San Diego', 'Sacramento', 'Oakland', 'Fresno', 'Long Beach', 'Riverside', 'Santa Ana', 'Irvine'],
        'New York': ['New York City', 'Buffalo', 'Rochester', 'Syracuse', 'Albany', 'Yonkers', 'New Rochelle', 'Mount Vernon', 'Schenectady', 'Utica'],
        'Texas': ['Houston', 'Dallas', 'Austin', 'San Antonio', 'Fort Worth', 'El Paso', 'Arlington', 'Corpus Christi', 'Plano', 'Irving'],
        'Florida': ['Miami', 'Orlando', 'Tampa', 'Jacksonville', 'St. Petersburg', 'Hialeah', 'Tallahassee', 'Fort Lauderdale', 'Port St. Lucie'],
        'Illinois': ['Chicago', 'Aurora', 'Rockford', 'Joliet', 'Naperville', 'Springfield', 'Peoria', 'Elgin', 'Waukegan'],
        'Pennsylvania': ['Philadelphia', 'Pittsburgh', 'Allentown', 'Erie', 'Reading', 'Scranton', 'Bethlehem', 'Lancaster', 'Harrisburg'],
        'Ohio': ['Columbus', 'Cleveland', 'Cincinnati', 'Toledo', 'Akron', 'Dayton', 'Parma', 'Canton', 'Youngstown'],
        'Georgia': ['Atlanta', 'Columbus', 'Augusta', 'Savannah', 'Athens', 'Sandy Springs', 'Roswell', 'Johns Creek', 'Albany'],
        'North Carolina': ['Charlotte', 'Raleigh', 'Greensboro', 'Durham', 'Winston-Salem', 'Fayetteville', 'Cary', 'Wilmington', 'High Point'],
        'Michigan': ['Detroit', 'Grand Rapids', 'Warren', 'Sterling Heights', 'Lansing', 'Ann Arbor', 'Flint', 'Dearborn', 'Livonia']
      },
      'Canada': {
        'Ontario': ['Toronto', 'Ottawa', 'Mississauga', 'Brampton', 'Hamilton', 'London', 'Markham', 'Vaughan', 'Kitchener', 'Windsor'],
        'Quebec': ['Montreal', 'Quebec City', 'Laval', 'Gatineau', 'Longueuil', 'Sherbrooke', 'Levis', 'Saguenay', 'Trois-Rivières'],
        'British Columbia': ['Vancouver', 'Surrey', 'Burnaby', 'Richmond', 'Abbotsford', 'Coquitlam', 'Delta', 'Saanich', 'North Vancouver'],
        'Alberta': ['Calgary', 'Edmonton', 'Red Deer', 'Lethbridge', 'St. Albert', 'Medicine Hat', 'Grande Prairie', 'Airdrie', 'Spruce Grove'],
        'Manitoba': ['Winnipeg', 'Brandon', 'Steinbach', 'Thompson', 'Portage la Prairie', 'Winkler', 'Selkirk', 'Dauphin']
      },
      'United Kingdom': {
        'England': ['London', 'Birmingham', 'Manchester', 'Liverpool', 'Leeds', 'Sheffield', 'Bristol', 'Newcastle', 'Nottingham', 'Leicester'],
        'Scotland': ['Glasgow', 'Edinburgh', 'Aberdeen', 'Dundee', 'Stirling', 'Perth', 'Inverness', 'Paisley', 'East Kilbride'],
        'Wales': ['Cardiff', 'Swansea', 'Newport', 'Wrexham', 'Barry', 'Caerphilly', 'Rhondda', 'Bridgend', 'Neath'],
        'Northern Ireland': ['Belfast', 'Derry', 'Lisburn', 'Newtownabbey', 'Bangor', 'Craigavon', 'Castlereagh', 'Ballymena', 'Newry']
      },
      'Australia': {
        'New South Wales': ['Sydney', 'Newcastle', 'Wollongong', 'Maitland', 'Wagga Wagga', 'Albury', 'Port Macquarie', 'Tamworth', 'Orange'],
        'Victoria': ['Melbourne', 'Geelong', 'Ballarat', 'Bendigo', 'Melton', 'Latrobe City', 'Frankston', 'Casey', 'Greater Dandenong'],
        'Queensland': ['Brisbane', 'Gold Coast', 'Townsville', 'Cairns', 'Toowoomba', 'Mackay', 'Rockhampton', 'Bundaberg', 'Hervey Bay'],
        'Western Australia': ['Perth', 'Fremantle', 'Rockingham', 'Mandurah', 'Bunbury', 'Kalgoorlie', 'Geraldton', 'Albany', 'Kwinana'],
        'South Australia': ['Adelaide', 'Mount Gambier', 'Whyalla', 'Murray Bridge', 'Port Lincoln', 'Port Augusta', 'Victor Harbor']
      },
      'Germany': {
        'Bavaria': ['Munich', 'Nuremberg', 'Augsburg', 'Regensburg', 'Ingolstadt', 'Würzburg', 'Fürth', 'Erlangen', 'Bamberg'],
        'North Rhine-Westphalia': ['Cologne', 'Düsseldorf', 'Dortmund', 'Essen', 'Duisburg', 'Bochum', 'Wuppertal', 'Bielefeld', 'Bonn'],
        'Baden-Württemberg': ['Stuttgart', 'Mannheim', 'Karlsruhe', 'Freiburg', 'Heidelberg', 'Heilbronn', 'Ulm', 'Pforzheim', 'Reutlingen'],
        'Berlin': ['Berlin'],
        'Hamburg': ['Hamburg'],
        'Hesse': ['Frankfurt', 'Wiesbaden', 'Kassel', 'Darmstadt', 'Offenbach', 'Hanau', 'Marburg', 'Fulda', 'Gießen']
      },
      'France': {
        'Île-de-France': ['Paris', 'Boulogne-Billancourt', 'Saint-Denis', 'Argenteuil', 'Montreuil', 'Créteil', 'Nanterre', 'Versailles'],
        'Provence-Alpes-Côte dAzur': ['Marseille', 'Nice', 'Toulon', 'Aix-en-Provence', 'Antibes', 'Cannes', 'Avignon', 'Fréjus'],
        'Auvergne-Rhône-Alpes': ['Lyon', 'Grenoble', 'Saint-Étienne', 'Villeurbanne', 'Clermont-Ferrand', 'Annecy', 'Chambéry'],
        'Occitanie': ['Toulouse', 'Montpellier', 'Nîmes', 'Perpignan', 'Béziers', 'Narbonne', 'Carcassonne', 'Albi'],
        'Hauts-de-France': ['Lille', 'Amiens', 'Roubaix', 'Tourcoing', 'Dunkirk', 'Calais', 'Valenciennes', 'Boulogne-sur-Mer']
      },
      'Japan': {
        'Tokyo': ['Tokyo', 'Shibuya', 'Shinjuku', 'Harajuku', 'Ginza', 'Akihabara', 'Roppongi', 'Ikebukuro'],
        'Osaka': ['Osaka', 'Sakai', 'Higashiosaka', 'Hirakata', 'Toyonaka', 'Suita', 'Takatsuki'],
        'Kanagawa': ['Yokohama', 'Kawasaki', 'Sagamihara', 'Fujisawa', 'Hiratsuka', 'Odawara', 'Yamato'],
        'Aichi': ['Nagoya', 'Toyota', 'Okazaki', 'Ichinomiya', 'Kasugai', 'Anjo', 'Kariya'],
        'Kyoto': ['Kyoto', 'Uji', 'Kameoka', 'Joyo', 'Mukō', 'Nagaokakyō', 'Kyōtanabe']
      },
      'South Korea': {
        'Seoul': ['Seoul', 'Gangnam', 'Hongdae', 'Myeongdong', 'Itaewon', 'Insadong', 'Jongno'],
        'Busan': ['Busan', 'Haeundae', 'Centum City', 'Seomyeon', 'Nampo-dong', 'Jagalchi'],
        'Incheon': ['Incheon', 'Songdo', 'Bupyeong', 'Namdong', 'Yeonsu', 'Seo-gu'],
        'Daegu': ['Daegu', 'Jung-gu', 'Dong-gu', 'Seo-gu', 'Nam-gu', 'Buk-gu'],
        'Gyeonggi': ['Suwon', 'Seongnam', 'Goyang', 'Yongin', 'Bucheon', 'Ansan', 'Anyang']
      },
      'China': {
        'Beijing': ['Beijing', 'Chaoyang', 'Haidian', 'Dongcheng', 'Xicheng', 'Fengtai', 'Shijingshan'],
        'Shanghai': ['Shanghai', 'Pudong', 'Huangpu', 'Xuhui', 'Changning', 'Jing\'an', 'Putuo'],
        'Guangdong': ['Guangzhou', 'Shenzhen', 'Dongguan', 'Foshan', 'Zhuhai', 'Zhongshan', 'Jiangmen'],
        'Zhejiang': ['Hangzhou', 'Ningbo', 'Wenzhou', 'Shaoxing', 'Huzhou', 'Jiaxing', 'Jinhua'],
        'Jiangsu': ['Nanjing', 'Suzhou', 'Wuxi', 'Changzhou', 'Nantong', 'Xuzhou', 'Yancheng']
      },
      'India': {
        'Maharashtra': ['Mumbai', 'Pune', 'Nagpur', 'Nashik', 'Aurangabad', 'Solapur', 'Amravati'],
        'Karnataka': ['Bangalore', 'Mysore', 'Hubli', 'Mangalore', 'Belgaum', 'Gulbarga', 'Davangere'],
        'Tamil Nadu': ['Chennai', 'Coimbatore', 'Madurai', 'Tiruchirappalli', 'Salem', 'Tirunelveli', 'Erode'],
        'Delhi': ['New Delhi', 'Delhi Cantonment', 'Karol Bagh', 'Lajpat Nagar', 'Rajouri Garden'],
        'West Bengal': ['Kolkata', 'Howrah', 'Durgapur', 'Asansol', 'Siliguri', 'Bardhaman', 'Malda']
      },
      'Brazil': {
        'São Paulo': ['São Paulo', 'Guarulhos', 'Campinas', 'São Bernardo do Campo', 'Santos', 'Osasco', 'Ribeirão Preto'],
        'Rio de Janeiro': ['Rio de Janeiro', 'Nova Iguaçu', 'Duque de Caxias', 'Niterói', 'São Gonçalo', 'Belford Roxo'],
        'Minas Gerais': ['Belo Horizonte', 'Uberlândia', 'Contagem', 'Juiz de Fora', 'Betim', 'Montes Claros'],
        'Bahia': ['Salvador', 'Feira de Santana', 'Vitória da Conquista', 'Camaçari', 'Itabuna', 'Juazeiro'],
        'Paraná': ['Curitiba', 'Londrina', 'Maringá', 'Ponta Grossa', 'Cascavel', 'São José dos Pinhais']
      },
      'Mexico': {
        'Mexico City': ['Mexico City', 'Iztapalapa', 'Ecatepec', 'Guadalajara', 'Puebla', 'Tijuana', 'León'],
        'Jalisco': ['Guadalajara', 'Zapopan', 'Tlaquepaque', 'Tonalá', 'Puerto Vallarta', 'Lagos de Moreno'],
        'Nuevo León': ['Monterrey', 'Guadalupe', 'San Nicolás de los Garza', 'Apodaca', 'Santa Catarina'],
        'Puebla': ['Puebla', 'Tehuacán', 'San Martín Texmelucan', 'Atlixco', 'San Pedro Cholula'],
        'Veracruz': ['Veracruz', 'Xalapa', 'Coatzacoalcos', 'Córdoba', 'Poza Rica', 'Minatitlán']
      },
      'Italy': {
        'Lombardy': ['Milan', 'Brescia', 'Bergamo', 'Monza', 'Como', 'Cremona', 'Mantua'],
        'Lazio': ['Rome', 'Latina', 'Guidonia Montecelio', 'Fiumicino', 'Aprilia', 'Civitavecchia'],
        'Campania': ['Naples', 'Salerno', 'Giugliano', 'Torre del Greco', 'Pozzuoli', 'Caserta'],
        'Sicily': ['Palermo', 'Catania', 'Messina', 'Syracuse', 'Marsala', 'Ragusa', 'Trapani'],
        'Veneto': ['Venice', 'Verona', 'Padua', 'Vicenza', 'Treviso', 'Rovigo', 'Belluno']
      },
      'Spain': {
        'Madrid': ['Madrid', 'Móstoles', 'Alcalá de Henares', 'Fuenlabrada', 'Leganés', 'Getafe'],
        'Catalonia': ['Barcelona', 'L\'Hospitalet', 'Badalona', 'Terrassa', 'Sabadell', 'Lleida'],
        'Andalusia': ['Seville', 'Málaga', 'Córdoba', 'Granada', 'Jerez', 'Almería', 'Huelva'],
        'Valencia': ['Valencia', 'Alicante', 'Castellón', 'Elche', 'Torrent', 'Orihuela'],
        'Basque Country': ['Bilbao', 'Vitoria-Gasteiz', 'San Sebastián', 'Barakaldo', 'Getxo']
      },
      'Netherlands': {
        'North Holland': ['Amsterdam', 'Haarlem', 'Zaanstad', 'Haarlemmermeer', 'Alkmaar', 'Hilversum'],
        'South Holland': ['The Hague', 'Rotterdam', 'Leiden', 'Zoetermeer', 'Dordrecht', 'Delft'],
        'North Brabant': ['Eindhoven', 'Tilburg', '\'s-Hertogenbosch', 'Breda', 'Helmond', 'Oss'],
        'Utrecht': ['Utrecht', 'Nieuwegein', 'Veenendaal', 'Houten', 'Vijfheerenlanden'],
        'Limburg': ['Maastricht', 'Heerlen', 'Sittard-Geleen', 'Kerkrade', 'Roermond']
      },
      'Switzerland': {
        'Zurich': ['Zurich', 'Winterthur', 'Uster', 'Dübendorf', 'Dietikon', 'Wetzikon'],
        'Bern': ['Bern', 'Biel/Bienne', 'Thun', 'Köniz', 'Steffisburg', 'Burgdorf'],
        'Vaud': ['Lausanne', 'Yverdon-les-Bains', 'Montreux', 'Renens', 'Nyon', 'Vevey'],
        'Geneva': ['Geneva', 'Vernier', 'Lancy', 'Meyrin', 'Carouge', 'Onex'],
        'Basel-Stadt': ['Basel', 'Riehen', 'Bettingen']
      },
      'Austria': {
        'Vienna': ['Vienna', 'Döbling', 'Favoriten', 'Floridsdorf', 'Donaustadt', 'Liesing'],
        'Styria': ['Graz', 'Leoben', 'Kapfenberg', 'Bruck an der Mur', 'Feldbach'],
        'Upper Austria': ['Linz', 'Wels', 'Steyr', 'Traun', 'Leonding', 'Amstetten'],
        'Tyrol': ['Innsbruck', 'Kufstein', 'Telfs', 'Schwaz', 'Hall in Tirol', 'Wörgl'],
        'Salzburg': ['Salzburg', 'Hallein', 'Saalfelden', 'Bad Ischl', 'St. Johann']
      },
      'Belgium': {
        'Brussels': ['Brussels', 'Schaerbeek', 'Anderlecht', 'Molenbeek', 'Uccle', 'Ixelles'],
        'Flanders': ['Antwerp', 'Ghent', 'Bruges', 'Leuven', 'Mechelen', 'Aalst', 'Kortrijk'],
        'Wallonia': ['Liège', 'Charleroi', 'Namur', 'Mons', 'La Louvière', 'Tournai']
      },
      'Sweden': {
        'Stockholm': ['Stockholm', 'Södertälje', 'Nacka', 'Sundbyberg', 'Solna', 'Täby'],
        'Västra Götaland': ['Gothenburg', 'Borås', 'Trollhättan', 'Uddevalla', 'Skövde'],
        'Skåne': ['Malmö', 'Helsingborg', 'Lund', 'Kristianstad', 'Landskrona', 'Trelleborg'],
        'Uppsala': ['Uppsala', 'Enköping', 'Håbo', 'Knivsta', 'Tierp', 'Älvkarleby'],
        'Värmland': ['Karlstad', 'Arvika', 'Kristinehamn', 'Filipstad', 'Hagfors']
      },
      'Norway': {
        'Oslo': ['Oslo', 'Bærum', 'Asker', 'Lørenskog', 'Oppegård', 'Ski'],
        'Rogaland': ['Stavanger', 'Sandnes', 'Haugesund', 'Karmøy', 'Time', 'Gjesdal'],
        'Hordaland': ['Bergen', 'Askøy', 'Os', 'Fjell', 'Sund', 'Øygarden'],
        'Trøndelag': ['Trondheim', 'Steinkjer', 'Levanger', 'Verdal', 'Namsos'],
        'Nordland': ['Bodø', 'Narvik', 'Fauske', 'Mo i Rana', 'Rana', 'Vefsn']
      }
    };

    // Tesla-Grade Location System - Streamlined with LocationPicker Modal
  </script>
  
  <!-- Progressive Enhancement Scripts -->
  <script>
    // Load premium features if available
    if (window.PremiumUX) {
      console.log('🎨 Premium UX loaded');
    }
    
    // Load location picker if available  
    if (window.LocationPicker) {
      console.log('📍 Location picker loaded');
    }
    
    // Load performance manager if available
    if (window.PerformanceManager) {
      window.PerformanceManager.init();
      console.log('⚡ Performance manager active');
    }
  </script>
</body>
</html>