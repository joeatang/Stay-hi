<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hi Gym — Stay Hi</title>

  <!-- 📱 PWA Configuration -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD166">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Hi Gym">

  <!-- Preload Supabase CDN for instant client init -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" as="script">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <!-- Tesla-grade auth system - health monitor first -->
  <script src="assets/url-path-fixer.js"></script>
  <script src="assets/supabase-init.js"></script>
  <!-- 🚀 Tesla-Grade Anonymous Access Modal System -->
  <script src="assets/anonymous-access-modal.js"></script>

  <!-- Global brand & Tesla performance -->
  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>
  <link rel="stylesheet" href="assets/premium-ux.css"/>
  <link rel="stylesheet" href="assets/premium-footer.css"/>
  <link rel="stylesheet" href="styles/modal-base.css">
  
  <!-- 🌟 Unified Share Sheet System -->
  <link rel="stylesheet" href="components/hi-share-sheet/share-sheet.css"/>
  <script src="components/hi-share-sheet/share-sheet.js" type="module"></script>

  <style>
    /* Tesla-Grade Hi Gym Styling - Mobile First */
    * { box-sizing: border-box; }
    
    body {
      background: radial-gradient(1200px 600px at 50% -220px, rgba(78, 205, 196, 0.15) 0%, rgba(78, 205, 196, 0) 60%), #0f1024;
      color: #e8ebff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      -webkit-text-size-adjust: 100%;
    }

    .wrap {
      max-width: 640px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Mobile-first responsive scaling */
    @media (min-width: 768px) {
      .wrap { padding: 24px; }
    }

    @media (min-width: 1024px) {
      .wrap { padding: 32px; }
    }

    .title{font-weight:900;text-align:center;margin:16px 0 8px;font-size:clamp(1.5rem, 4vw, 2.5rem);line-height:1.2}
    .subtitle{color:#cfd2ea;text-align:center;margin:0 0 24px;font-size:clamp(0.9rem, 2.5vw, 1.1rem);line-height:1.4;padding:0 8px}

    /* Mobile-first guidance card */
    .guidance-card {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 16px;
      padding: 20px;
      margin: 0 0 24px;
      text-align: center;
    }
    
    .guidance-title {
      font-weight: 800;
      font-size: 1.1rem;
      margin: 0 0 8px;
      color: #10b981;
    }
    
    .guidance-steps {
      font-size: 0.95rem;
      line-height: 1.5;
      color: #e8ebff;
    }
    
    .guidance-steps strong {
      color: #10b981;
      font-weight: 700;
    }

    /* stepper - mobile optimized */
    .stepper{display:flex;align-items:center;justify-content:center;gap:12px;margin:20px auto 24px;padding:0 16px}
    .dot{width:16px;height:16px;border-radius:50%;background:#2a2f56;border:3px solid #20264b;transition:all 0.3s ease}
    .dot.active{background:#10b981;border-color:#10b981;transform:scale(1.1)}
    .pipe{height:3px;width:32px;background:#2a2f56;transition:background 0.3s ease}
    .pipe.filled{background:#10b981}

    @media (min-width: 768px) {
      .stepper { gap: 16px; }
      .dot { width: 18px; height: 18px; }
      .pipe { width: 44px; }
    }

    /* Tesla-Grade Emotion Category Tabs */
    .tabs {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 16px 0 20px 0;
      margin-bottom: 20px;
      -webkit-overflow-scrolling: touch;
      /* Remove the old border-bottom for cleaner look */
    }
    
    .tab {
      position: relative;
      white-space: nowrap;
      padding: 16px 24px;
      border-radius: 20px;
      border: none;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      color: rgba(255, 255, 255, 0.7);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      min-height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      letter-spacing: -0.02em;
    }

    /* Category-specific styling */
    .tab[data-cat="hi"] {
      background: linear-gradient(135deg, 
        rgba(255, 157, 77, 0.15) 0%, 
        rgba(255, 133, 51, 0.25) 100%);
      border: 1px solid rgba(255, 157, 77, 0.2);
    }

    .tab[data-cat="neutral"] {
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.08) 0%, 
        rgba(255, 255, 255, 0.12) 100%);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .tab[data-cat="opportunity"] {
      background: linear-gradient(135deg, 
        rgba(78, 205, 196, 0.15) 0%, 
        rgba(78, 205, 196, 0.25) 100%);
      border: 1px solid rgba(78, 205, 196, 0.2);
    }

    /* Hover states with Tesla-grade precision */
    .tab:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
    }

    .tab[data-cat="hi"]:hover {
      background: linear-gradient(135deg, 
        rgba(255, 157, 77, 0.25) 0%, 
        rgba(255, 133, 51, 0.35) 100%);
      box-shadow: 
        0 8px 32px rgba(255, 133, 51, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .tab[data-cat="neutral"]:hover {
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.15) 0%, 
        rgba(255, 255, 255, 0.22) 100%);
    }

    .tab[data-cat="opportunity"]:hover {
      background: linear-gradient(135deg, 
        rgba(78, 205, 196, 0.25) 0%, 
        rgba(78, 205, 196, 0.35) 100%);
      box-shadow: 
        0 8px 32px rgba(78, 205, 196, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    /* Active/Selected state with premium feel */
    .tab[aria-selected="true"] {
      transform: translateY(-1px);
      color: #fff;
      font-weight: 700;
      box-shadow: 
        0 8px 24px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .tab[data-cat="hi"][aria-selected="true"] {
      background: linear-gradient(135deg, #ff9d4d 0%, #ff8533 100%);
      border-color: #ff8533;
      color: #1b0f02;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .tab[data-cat="neutral"][aria-selected="true"] {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-color: #cbd5e1;
      color: #334155;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .tab[data-cat="opportunity"][aria-selected="true"] {
      background: linear-gradient(135deg, #4ecdc4 0%, #44b3ac 100%);
      border-color: #44b3ac;
      color: #0f2027;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Responsive scaling */
    @media (min-width: 768px) {
      .tabs {
        gap: 16px;
        padding: 20px 0 24px 0;
      }
      
      .tab { 
        padding: 18px 28px; 
        font-size: 1rem;
        min-height: 60px;
        border-radius: 24px;
      }
    }

    @media (min-width: 1024px) {
      .tab {
        padding: 20px 32px;
        font-size: 1.05rem;
        border-radius: 28px;
      }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      .tab:hover {
        transform: none;
      }
      
      .tab:active {
        transform: translateY(1px) scale(0.98);
      }
    }

    /* search - mobile optimized */
    .search{display:flex;gap:10px;align-items:center;background:#fff;border:2px solid var(--hi-border);border-radius:16px;padding:12px;margin-bottom:16px}
    .search input{border:0;outline:0;width:100%;font-size:16px;color:#111;background:transparent}
    .search input::placeholder{color:#6b7280}

    /* grid - responsive */
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:16px}
    
    @media (min-width: 480px) { 
      .grid{grid-template-columns:repeat(2,1fr);} 
    }
    
    @media (min-width: 768px) { 
      .grid{grid-template-columns:repeat(3,1fr);gap:14px;} 
    }
    
    .chip{
      display:flex;gap:12px;align-items:center;
      background:#fff; border:2px solid var(--hi-border); border-radius:16px;
      padding:16px; cursor:pointer; text-align:left;
      transition:all .15s ease;
      min-height:72px;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .chip:hover{transform:translateY(-2px); box-shadow:0 12px 24px rgba(0,0,0,.2)}
    .chip:active{transform:translateY(0);transition:transform 0.1s ease}
    .chip .emo{font-size:24px;min-width:24px}
    .chip .name{font-weight:900;color:#111;font-size:1rem;line-height:1.2}
    .chip .desc{font-size:13px;color:#6b7280;line-height:1.3;margin-top:2px}
    .chip.selected{outline:3px solid var(--ring); border-color:#ffefc7; background:#fffaf0;transform:translateY(-2px)}

    @media (min-width: 768px) {
      .chip { 
        padding: 18px;
        min-height: 80px;
      }
      .chip .emo { font-size: 26px; }
      .chip .name { font-size: 1.1rem; }
      .chip .desc { font-size: 14px; }
    }

    .badges{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:16px 0}
    .pickTitle{font-weight:900;color:#fff;margin:20px 0 8px;font-size:1.1rem}

    /* Mobile-first action buttons */
    .actions{display:flex;gap:12px;justify-content:center;margin:24px 0;flex-wrap:wrap}
    .actions .hi-btn {
      min-height: 48px;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 700;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      min-width: 120px;
    }
    
    .actions .hi-btn--primary {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
    
    .actions .hi-btn--primary:hover {
      background: #059669;
      border-color: #059669;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
    }
    
    .actions .hi-btn--primary:disabled {
      background: #6b7280;
      border-color: #6b7280;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .actions .hi-btn--ghost {
      background: transparent;
      color: #e8ebff;
      border-color: #2f335e;
    }
    
    .actions .hi-btn--ghost:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #4f46e5;
      transform: translateY(-1px);
    }

    @media (min-width: 768px) {
      .actions .hi-btn {
        min-height: 52px;
        padding: 14px 24px;
        font-size: 1.1rem;
        min-width: 140px;
      }
    }

    textarea{width:100%;border:2px solid var(--hi-border);border-radius:16px;min-height:140px;padding:16px;font:inherit;background:#fff;color:#111;font-size:16px;line-height:1.5;resize:vertical}
    .hi-hint{color:#cfd2ea;font-size:0.9rem}

    /* sheet - mobile-first with desktop scaling */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:50}
    .sheet{
      /* Tesla-grade viewport centering - unified with index.html */
      position:fixed;
      top:50%;left:50%;
      transform:translate(-50%, -50%);
      width:min(500px, 90vw);
      background:#0f1024;
      border-radius:18px;border:1px solid #23264d;
      padding:24px 20px 32px;z-index:60;
      box-shadow:0 -10px 30px rgba(0,0,0,.35);color:#e8ebff;
      max-height:85vh;overflow-y:auto;
      min-height:300px;
      opacity:0;visibility:hidden;
      transition:all .3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    /* Desktop optimizations */
    @media (min-width: 768px) {
      .sheet {
        width:500px;max-width:90vw;
        padding:32px 28px 40px;
        min-height:350px;
      }
    }
    
    /* Tesla-grade show/hide animations for viewport-centered modal */
    .sheet.show {
      opacity:1;
      visibility:visible;
      animation:modalFadeIn .25s ease-out forwards;
    }
    .sheet.hide {
      animation:modalFadeOut .2s ease-in forwards;
    }
    
    @keyframes modalFadeIn{from{opacity:0;transform:translate(-50%, -50%) scale(0.95)}to{opacity:1;transform:translate(-50%, -50%) scale(1)}}
    @keyframes modalFadeOut{from{opacity:1;transform:translate(-50%, -50%) scale(1)}to{opacity:0;transform:translate(-50%, -50%) scale(0.95)}}
    
    .sheet.show + .sheet-backdrop{display:block}
    
    /* Tesla-grade mobile optimizations */
    @media (max-width: 540px) {
      .sheet {
        width:90vw;
        max-width:400px;
        padding:20px 16px 24px;
        min-height:300px;
        max-height:80vh;
      }
    }
    
    @media (max-width: 380px) {
      .sheet {
        width:95vw;
        padding:16px 12px 20px;
        max-height:85vh;
      }
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 0;flex-wrap:wrap;min-height:60px}
    
    /* Mobile-first button styling */
    .sheet .hi-btn {
      min-height:52px;
      padding:14px 20px;
      font-weight:700;
      border-radius:12px;
      font-size:16px;
      cursor:pointer;
      transition:all 0.2s ease;
      border:2px solid transparent;
      flex:1;
      max-width:160px;
    }
    
    .sheet .hi-btn--ghost {
      background:transparent;
      color:#e8ebff;
      border-color:#4f46e5;
    }
    
    .sheet .hi-btn--ghost:hover {
      background:rgba(79,70,229,0.1);
      border-color:#6366f1;
      transform:translateY(-1px);
    }
    
    .sheet .hi-btn--primary {
      background:#10b981;
      color:white;
      border-color:#10b981;
      box-shadow:0 4px 12px rgba(16,185,129,0.3);
    }
    
    .sheet .hi-btn--primary:hover {
      background:#059669;
      border-color:#059669;
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(16,185,129,0.4);
    }
    
    .sheet .hi-btn--primary:disabled {
      background:#6b7280;
      border-color:#6b7280;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }
    
    /* Desktop button enhancements */
    @media (min-width: 768px) {
      .sheet .hi-btn {
        min-height:56px;
        padding:16px 24px;
        font-size:17px;
        max-width:180px;
      }
      
      .row {
        padding:20px 0;
        gap:16px;
      }
    }
    .switch{position:relative;width:54px;height:32px;background:#2f335e;border-radius:999px;cursor:pointer;border:1px solid #23264d;transition:all 0.2s ease}
    .knob{position:absolute;top:3px;left:3px;width:24px;height:24px;border-radius:50%;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.2);transition:left .2s ease}
    .switch.on{background:#0a8a3a;border-color:#0a8a3a}
    .switch.on .knob{left:27px}
    .sheet h3{margin:8px 0 6px;font-size:20px;font-weight:700;line-height:1.3}
    .sheet .muted{font-size:15px;color:#cfd2ea;line-height:1.4;margin-bottom:4px}
    .hr{height:1px;background:#23264d;margin:16px 0}
    .field{display:flex;gap:12px;align-items:center;border:2px solid var(--hi-border);border-radius:14px;padding:14px;background:#fff;color:#111;margin-top:8px}
    .field input{border:0;outline:0;width:100%;font:inherit;font-size:16px}

    /* Desktop switch and field improvements */
    @media (min-width: 768px) {
      .switch{width:58px;height:34px}
      .knob{width:26px;height:26px}
      .switch.on .knob{left:29px}
      .sheet h3{font-size:22px;margin:12px 0 8px}
      .sheet .muted{font-size:16px}
      .field{padding:16px;font-size:17px}
      .field input{font-size:17px}
    }

    /* Enhanced celebratory toast */
    .toast{
      position:fixed;left:50%;bottom:30px;transform:translateX(-50%);
      background:linear-gradient(135deg, #10b981 0%, #059669 100%);
      color:#fff;padding:16px 24px;border-radius:16px;
      opacity:0;pointer-events:none;z-index:1000;
      font-weight:700;font-size:1rem;
      box-shadow:0 10px 30px rgba(16, 185, 129, 0.4);
      border:1px solid rgba(255,255,255,0.2);
      backdrop-filter:blur(10px);
      max-width:90vw;text-align:center;
    }
    .toast.show{
      opacity:1;
      animation:toastIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .toast.hide{
      animation:toastOut 0.3s ease-in-out forwards;
    }
    @keyframes toastIn{
      0%{opacity:0;transform:translateX(-50%) translateY(20px) scale(0.9)}
      100%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}
    }
    @keyframes toastOut{
      0%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}
      100%{opacity:0;transform:translateX(-50%) translateY(-20px) scale(0.95)}
    }
  </style>
</head>
<body data-tab="muscle" data-page="hi-muscle">
  <!-- Premium Enhanced Header -->
  <header id="app-header" class="premium-header-container"></header>

  <div class="wrap">
    <h1 class="title">Hi Gym</h1>
    <p class="subtitle">Your guided emotional fitness journey in 3 thoughtful steps</p>

    <!-- Enhanced guidance with step-by-step thinking -->
    <div class="guidance-card" id="guidanceCard">
      <div class="guidance-title">🧠 Welcome to Your Emotional Journey</div>
      <div class="guidance-steps">
        <strong>Step 1: Where Are You Now?</strong><br>
        Take a moment to honestly check in with yourself. What emotion best describes how you're feeling right now? Don't judge it—just notice it.<br><br>
        
        <strong>Step 2: Where Do You Want to Be?</strong><br>
        Think about what emotional state would serve you best today. What feeling would help you handle what's ahead?<br><br>
        
        <strong>Step 3: Bridge the Gap</strong><br>
        Reflect on why this shift matters to you right now. What will be different when you embody this new emotional state?
      </div>
    </div>

    <!-- Step-specific guidance -->
    <div class="step-guidance" id="stepGuidance" style="display:none;">
      <div id="step1Guide" class="step-guide" style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:12px;padding:16px;margin:0 0 16px;text-align:center;">
        <strong style="color:#10b981;">Step 1: How are you feeling right now?</strong><br>
        <span style="color:#e8ebff;font-size:0.9rem;">Be honest with yourself. There's no wrong answer—just awareness.</span>
      </div>
      <div id="step2Guide" class="step-guide" style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:12px;padding:16px;margin:0 0 16px;text-align:center;display:none;">
        <strong style="color:#10b981;">Step 2: Where do you want to be emotionally?</strong><br>
        <span style="color:#e8ebff;font-size:0.9rem;">Choose an emotion that would better serve you in this moment.</span>
      </div>
      <div id="step3Guide" class="step-guide" style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:12px;padding:16px;margin:0 0 16px;text-align:center;display:none;">
        <strong style="color:#10b981;">Step 3: Why does this shift matter to you?</strong><br>
        <span style="color:#e8ebff;font-size:0.9rem;">Write 1-2 honest lines about why moving to <span id="desiredEmotionHint">this feeling</span> would help you today.</span>
      </div>
    </div>

    <div class="stepper" aria-label="Progress">
      <div class="dot" id="s1"></div><div class="pipe" id="p1"></div><div class="dot" id="s2"></div><div class="pipe" id="p2"></div><div class="dot" id="s3"></div>
    </div>

    <div class="badges">
      <span class="hi-chip" id="badge-current" style="display:none"></span>
      <span class="hi-chip" id="badge-desired" style="display:none"></span>
    </div>

    <div class="tabs" role="tablist" aria-label="Emotion categories">
      <button class="tab" role="tab" aria-selected="true"  data-cat="hi">Hi Energy</button>
      <button class="tab" role="tab" aria-selected="false" data-cat="neutral">Neutral</button>
      <button class="tab" role="tab" aria-selected="false" data-cat="opportunity">Hi Opportunity</button>
    </div>

    <div class="search">
      <span>🔎</span><input id="search" placeholder="Search emotions (e.g., calm, joy, worry)"/>
      <button id="toggleView" class="hi-btn hi-btn--ghost" style="padding:8px 12px">Compact</button>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>

    <div id="journalCard" class="hi-card" style="display:none;margin-top:14px">
      <div class="pickTitle">Hi Thought</div>
      <p class="hi-hint" style="margin:.25rem 0 .6rem">
        In <b>1–2 honest lines</b>, tell your future self why shifting to
        <span id="desiredLabel">this vibe</span> matters <i>today</i>.
      </p>
      <textarea id="journal" maxlength="600" placeholder="e.g., Choosing calm helps me be present with my family tonight, even if the day was loud."></textarea>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
        <span class="hi-hint" id="count">0/600</span>
        <label class="hi-hint"><input type="checkbox" id="anon" /> Post as Anonymous</label>
      </div>
    </div>

    <div class="actions">
      <button id="back" class="hi-btn hi-btn--ghost">Back</button>
      <button id="next" class="hi-btn hi-btn--primary">Continue</button>
    </div>

    <div style="display:flex;gap:12px;justify-content:center;margin-top:16px;flex-wrap:wrap">
      <a class="hi-btn hi-btn--ghost" href="hi-island-NEW.html" style="min-height:48px;padding:12px 16px;display:flex;align-items:center">Go to Hi Island</a>
      <a class="hi-btn hi-btn--ghost" href="index.html" style="min-height:48px;padding:12px 16px;display:flex;align-items:center">Back to Home</a>
    </div>
  </div>

  <!-- Share Sheet -->
      <!-- Share Sheet with streamlined location -->
    <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" aria-hidden="true">
      <h3 id="sheetTitle">How do you want to share your journey?</h3>
      <p class="muted">We'll always save a private copy in <b>My Archive</b>.</p>

      <div class="row" style="margin-top:6px">
        <div>
          <div style="font-weight:800">Show on Hi Island</div>
          <div class="muted">Appear in the global General Shares feed</div>
        </div>
        <div id="togglePublic" class="switch on" role="switch" aria-checked="true" tabindex="0"><div class="knob" aria-hidden="true"></div></div>
      </div>

      <div class="row">
        <div>
          <div style="font-weight:800">Post as Anonymous</div>
          <div class="muted">Your name becomes "Hi Friend"</div>
        </div>
        <div id="toggleAnon" class="switch" role="switch" aria-checked="false" tabindex="0"><div class="knob" aria-hidden="true"></div></div>
      </div>

      <div class="hr"></div>
      
      <!-- Profile-first location architecture -->
      <div style="margin-bottom:12px;">
        <div style="font-weight:700;margin-bottom:4px;color:#e8ebff;">📍 Location (Optional)</div>
        <div class="muted" style="margin-bottom:8px;">
          <span id="locationEducation">Add your city and state to connect with others nearby. We never store your exact location.</span>
        </div>
        <div class="field" aria-label="Optional location">
          <span>📍</span><input id="locationInput" placeholder="e.g., Austin, TX or London, UK"/>
        </div>
        
        <!-- Enhanced profile-first traveling option -->
        <div id="travelingContainer" style="display:none;margin-top:8px;">
          <label class="switch-label" style="font-size:14px;color:#a6adc8;display:flex;align-items:center;gap:8px;">
            <div class="switch">
              <input type="checkbox" id="travelingToggle">
              <span class="slider"></span>
            </div>
            ✈️ I'm traveling (share from home location)
          </label>
        </div>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:24px;padding-top:20px;border-top:1px solid #23264d">
        <button id="cancelShare" class="hi-btn hi-btn--ghost">Cancel</button>
        <button id="confirmShare" class="hi-btn hi-btn--primary">Share Journey</button>
      </div>
    </div>
  <div id="backdrop" class="sheet-backdrop" aria-hidden="true"></div>

  <div id="toast" class="toast">Saved</div>

  <!-- order matters -->
  <script src="assets/supabase-init.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/db.js"></script>
  <script src="assets/geocoding-service.js"></script>
  <script src="assets/header.js" defer></script>
  <script src="assets/emotions.js"></script>
  <script src="assets/hi-gym.js"></script>

  <script>
  (async function(){
    console.log('� Hi-Muscle loading...');
    
    try { await hiAuth.ensureSessionMaybe?.(); } catch {}

    // ---------- Emotion data adapter ----------
    function getEmotionCatalog(){
      // Accept any of these shapes:
      // 1) window.HI_EMOTIONS = { categories:[{id,items:[{name,emoji,desc}]}] }
      // 2) window.emotions or window.EMOTIONS = { hi:[], neutral:[], opportunity:[] } OR array of {name,emoji,desc,cat}
      const H = (window.HI_EMOTIONS && window.HI_EMOTIONS.categories) ? window.HI_EMOTIONS
            : null;

      if (H) return H; // already in the right shape

      const raw = window.emotions || window.EMOTIONS || {};
      const byId = { hi:[], neutral:[], opportunity:[] };

      if (Array.isArray(raw)) {
        raw.forEach(x=>{
          const cat = (x.cat||'hi').toLowerCase();
          (byId[cat] || byId.hi).push({ name:x.name, emoji:x.emoji||'✨', desc:x.desc||'' });
        });
      } else {
        ['hi','neutral','opportunity'].forEach(id=>{
          const list = raw[id] || [];
          byId[id] = list.map(x => ({ name:x.name, emoji:x.emoji||'✨', desc:x.desc||'' }));
        });
      }

      return {
        categories: [
          { id:'hi',          items: byId.hi },
          { id:'neutral',     items: byId.neutral },
          { id:'opportunity', items: byId.opportunity }
        ]
      };
    }

    const CATALOG = getEmotionCatalog();

    const state = { step:1, current:null, desired:null, cat:'hi', q:'' };

    // Els
    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const toggleView = document.getElementById('toggleView');
    const nextBtn = document.getElementById('next');
    const backBtn = document.getElementById('back');
    const badgeCur = document.getElementById('badge-current');
    const badgeDes = document.getElementById('badge-desired');
    const journalCard = document.getElementById('journalCard');
    const journal = document.getElementById('journal');
    const count = document.getElementById('count');
    const desiredLabel = document.getElementById('desiredLabel');
    const s1 = document.getElementById('s1'), s2 = document.getElementById('s2'), s3 = document.getElementById('s3');
    const p1 = document.getElementById('p1'), p2 = document.getElementById('p2');
    const toastEl = document.getElementById('toast');

    // Sheet bits
    const sheet = document.getElementById('sheet');
    const backdrop = document.getElementById('backdrop');
    const togglePublic = document.getElementById('togglePublic');
    const toggleAnon = document.getElementById('toggleAnon');
    const locationInput = document.getElementById('locationInput');
    const cancelShare = document.getElementById('cancelShare');
    const confirmShare = document.getElementById('confirmShare');

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.setAttribute('aria-selected','false'));
        t.setAttribute('aria-selected','true');
        state.cat = t.dataset.cat;
        renderGrid();
      });
    });

    // Search / compact
    search.addEventListener('input', ()=>{ state.q = search.value.trim(); renderGrid(); });
    toggleView.addEventListener('click', ()=>{
      const descs = document.querySelectorAll('.desc');
      const compact = toggleView.textContent === 'Compact';
      toggleView.textContent = compact ? 'Comfort' : 'Compact';
      descs.forEach(d => d.style.display = compact ? 'none' : '');
    });

    // Nav with enhanced validation
    backBtn.addEventListener('click', ()=>{
      if (state.step === 1) { window.location.href='index.html'; return; }
      if (state.step === 2) { setStep(1); return; }
      if (state.step === 3) { setStep(2); return; }
    });
    
    nextBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      console.log('Next button clicked, step:', state.step, 'current:', state.current, 'desired:', state.desired);
      
      if (state.step === 1) {
        if (!state.current) {
          toast('Please choose how you feel right now');
          return;
        }
        setStep(2);
        return;
      }
      
      if (state.step === 2) {
        if (!state.desired) {
          toast('Please choose where you want to be emotionally');
          return;
        }
        setStep(3);
        return;
      }
      
      if (state.step === 3) {
        const journalText = journal.value.trim();
        console.log('Journal text length:', journalText.length);
        if (journalText.length < 10) {
          toast('Please write at least 10 characters in your reflection');
          journal.focus();
          return;
        }
        console.log('Opening unified share sheet for Hi Muscle...');
        try {
          // 🌟 TESLA-GRADE: Use unified share sheet with Hi Muscle journal data
          const journalText = journal.value.trim();
          
          // Pre-populate the share sheet with the Hi Muscle reflection
          if (window.openHiShareSheet) {
            window.openHiShareSheet('higym', { 
              prefilledText: journalText,
              currentEmoji: state.current?.emoji,
              desiredEmoji: state.desired?.emoji 
            });
          } else {
            console.error('❌ CRITICAL: Unified share sheet failed to initialize. Check console for module loading errors.');
            toast('Share system unavailable. Please refresh the page.', 'warning');
          }
        } catch (error) {
          console.error('Error opening share sheet:', error);
          toast('Something went wrong. Please try again.', 'warning');
        }
        return;
      }
    });

    // Switch helpers
    function setSwitch(el,on){ el.classList.toggle('on', !!on); el.setAttribute('aria-checked', on?'true':'false'); }
    function getSwitch(el){ return el.classList.contains('on'); }
    [togglePublic,toggleAnon].forEach(sw=>{
      sw.addEventListener('click', ()=> setSwitch(sw, !getSwitch(sw)));
      sw.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); setSwitch(sw, !getSwitch(sw)); }});
    });
    backdrop.addEventListener('click', closeSheet);
    cancelShare.addEventListener('click', closeSheet);
    
    function openSheet(){ 
      console.log('openSheet called, sheet element:', sheet, 'backdrop element:', backdrop);
      if (!sheet || !backdrop) {
        console.error('Sheet or backdrop element not found!');
        return;
      }
      sheet.classList.remove('hide'); 
      sheet.classList.add('show'); 
      sheet.setAttribute('aria-hidden','false'); 
      backdrop.style.display='block';
      console.log('Sheet opened, classes:', sheet.classList.toString());
    }
    
    function closeSheet(){ 
      console.log('closeSheet called');
      sheet.classList.remove('show'); 
      sheet.classList.add('hide'); 
      sheet.setAttribute('aria-hidden','true'); 
      setTimeout(()=>backdrop.style.display='none',180); 
    }

    // Writes
    confirmShare.addEventListener('click', async (e)=>{
      e.preventDefault();
      console.log('Share Journey button clicked');
      
      // Disable button to prevent double-clicks
      confirmShare.disabled = true;
      confirmShare.textContent = 'Sharing...';
      
      try {
        const text = journal.value.trim();
        const isAnon = getSwitch(toggleAnon);
        const loc = (locationInput.value||'').trim();

        console.log('Submitting Hi Gym journey:', { 
          current: state.current?.name, 
          desired: state.desired?.name, 
          textLength: text.length,
          isAnon,
          toIsland: true,  // Always share to island
          location: loc
        });

        // 🌟 TESLA-GRADE: Increment global Hi counter (same as unified share sheet)
        const LS_TOTAL = 'hi_total_count';
        const LS_GLOBAL = 'hi_global_shares';
        
        let total = parseInt(localStorage.getItem(LS_TOTAL) || '0', 10);
        let gStarts = parseInt(localStorage.getItem(LS_GLOBAL) || '0', 10);
        
        total += 1;
        gStarts += 1;
        
        localStorage.setItem(LS_TOTAL, String(total));
        localStorage.setItem(LS_GLOBAL, String(gStarts));
        
        console.log('📊 Global Hi counter incremented (hiGYM):', { total, gStarts });

        // Tesla-grade journey analytics
        const sessionData = {
          current: state.current,
          desired: state.desired,
          journal: text,
          duration: Date.now() - (state.startTime || Date.now()),
          timestamp: Date.now()
        };

        // Track emotional pattern
        const pattern = window.HiGym?.trackEmotionalPattern(sessionData);
        
        // Create celebration message
        const celebration = window.HiGym?.createJourneyCelebration(sessionData);

        // Always save to personal archive
        console.log('Saving to archive...');
        await window.hiDB.insertArchive({
          currentEmoji: state.current.emoji,
          desiredEmoji: state.desired.emoji,
          journal: text,
          text: text, // Gold standard: include text field for archive display
          location: loc,
          journeyType: pattern?.journeyType || 'exploration',
          origin: 'higym', // Gold standard: lowercase origin tag
          type: 'higym' // Gold standard: type tag for filtering
        });

        // Always share to Hi Island as part of the flow
        console.log('Sharing to Hi Island...');
        await window.hiDB.insertPublicShare({
          currentEmoji: state.current.emoji, 
          currentName: state.current.name,
          desiredEmoji: state.desired.emoji, 
          desiredName: state.desired.name,
          text, 
          isAnonymous: isAnon, 
          location: loc || null, // Clean pipe: null for no location
          isPublic: true,
          origin: 'higym', // Gold standard: lowercase origin tag
          journeyType: pattern?.journeyType || 'exploration',
          tags: ['emotional-journey', 'higym'] // Gold standard: lowercase tags
        });

        closeSheet();
        
        // 🎉 TESLA-GRADE: Premium celebration for emotional journey completion
        const celebrationMsg = celebration?.message || '🌟 Amazing emotional journey completed!';
        toast(celebrationMsg, 'celebration');
        
        // Premium UX celebration integration
        if (window.PremiumUX) {
          // Center-screen celebration from share button
          setTimeout(() => {
            window.PremiumUX.confetti({ 
              count: 25, 
              colors: ['#4ECDC4', '#FFD93D', '#FF6B6B', '#8A2BE2'] 
            });
          }, 100);
          window.PremiumUX.triggerHapticFeedback('celebration');
        }
        
        // Add subtle background glow animation
        setTimeout(() => {
          document.body.style.background = 'radial-gradient(1200px 600px at 50% -220px, rgba(78, 205, 196, 0.25) 0%, rgba(78, 205, 196, 0) 60%), #0f1024';
          setTimeout(() => {
            document.body.style.background = 'radial-gradient(1200px 600px at 50% -220px, rgba(78, 205, 196, 0.15) 0%, rgba(78, 205, 196, 0) 60%), #0f1024';
          }, 1000);
        }, 200);
        
        // Clear draft after successful submission
        localStorage.removeItem('hi-gym-draft');
        
        // Navigate to Hi Island to see the result
        setTimeout(() => window.location.href='hi-island-NEW.html', 2500);
        
      } catch (error) {
        console.error('Hi Gym submission error:', error);
        toast('Something went wrong. Please try again.', 'warning');
        
        // Re-enable button
        confirmShare.disabled = false;
        confirmShare.textContent = 'Share Journey';
      }
    });

    // Renderers
    function currentList(){
      const cat = (CATALOG.categories||[]).find(c=>c.id===state.cat) || (CATALOG.categories||[])[0] || {items:[]};
      let list = cat.items || [];
      
      // SMART FILTERING: If step 2 and current emotion is from Hi Opportunity, don't show Hi Opportunity emotions
      if (state.step === 2 && state.current) {
        const currentCat = findEmotionCategory(state.current.name);
        if (currentCat === 'opportunity' && state.cat === 'opportunity') {
          // Force switch to Hi Energy tab
          setTimeout(() => {
            const hiTab = document.querySelector('.tab[data-cat="hi"]');
            if (hiTab && !hiTab.getAttribute('aria-selected')) {
              hiTab.click();
            }
          }, 100);
          return []; // Return empty list for opportunity emotions
        }
      }
      
      if (state.q){
        const q = state.q.toLowerCase();
        list = list.filter(x => x.name?.toLowerCase().includes(q) || (x.desc||'').toLowerCase().includes(q));
      }
      return list;
    }

    function renderGrid(){
      const list = currentList();
      grid.innerHTML = '';
      if (!list.length){
        const empty = document.createElement('div');
        empty.className = 'hi-hint';
        empty.style.margin = '10px 0';
        empty.textContent = 'No emotions found here. Try another tab or search.';
        grid.appendChild(empty);
        validate(); return;
      }

      list.forEach(item=>{
        const div = document.createElement('button');
        div.type='button'; div.className='chip'; div.title=item.desc||item.name;
        div.innerHTML = `
          <span class="emo">${item.emoji||'✨'}</span>
          <div style="display:flex;flex-direction:column;align-items:flex-start">
            <span class="name">${item.name}</span>
            <span class="desc">${item.desc||''}</span>
          </div>`;
        const isSelected = (state.step===1 && state.current?.name===item.name) ||
                           (state.step===2 && state.desired?.name===item.name);
        if (isSelected) {
          div.classList.add('selected');
          // Tesla-Grade Debug: Log selection state
          console.log(`🎯 Selected: ${item.name} (Step ${state.step}, Current: ${state.current?.name}, Desired: ${state.desired?.name})`);
        }

        div.addEventListener('click', ()=>{
          let targetEmotion = item;
          
          if (state.step === 1) {
            state.current = targetEmotion;
            // Tesla-Grade Fix: Clear desired emotion when selecting new current emotion
            state.desired = null;
            setStep(2);
            // Ensure UI updates immediately
            renderGrid();
          } else if (state.step === 2) {
            // Tesla-grade smart validation
            const validation = window.HiGym.validateEmotionalSelection(state.current, targetEmotion);
            if (!validation.valid) {
              toast(validation.reason);
              if (validation.suggestion) {
                // Auto-suggest better emotions
                setTimeout(() => {
                  state.q = validation.suggestion[0];
                  search.value = state.q;
                  renderGrid();
                }, 1000);
              }
              return;
            }
            
            state.desired = targetEmotion;
            setStep(3);
            // Ensure UI updates immediately
            renderGrid();
          } else {
            // Step 3: Allow changing current emotion
            state.current = targetEmotion;
            state.desired = null;
            setStep(2);
          }
          
          saveDraft();
        });

        grid.appendChild(div);
      });

      validate();
    }

    function renderBadges(){
      if (state.current){
        badgeCur.style.display='';
        badgeCur.innerHTML = `Current: ${state.current.emoji} <b>${state.current.name}</b>`;
      } else badgeCur.style.display='none';

      if (state.desired){
        badgeDes.style.display='';
        badgeDes.innerHTML = `Desired: ${state.desired.emoji} <b>${state.desired.name}</b>`;
      } else badgeDes.style.display='none';
    }

    function setStep(n){
      state.step = Math.max(1, Math.min(3, n));
      
      // Update stepper dots and pipes
      s1.classList.toggle('active', state.step >= 1);
      s2.classList.toggle('active', state.step >= 2);
      s3.classList.toggle('active', state.step >= 3);
      p1.classList.toggle('filled', state.step >= 2);
      p2.classList.toggle('filled', state.step >= 3);

      // Show/hide guidance cards
      const guidanceCard = document.getElementById('guidanceCard');
      const stepGuidance = document.getElementById('stepGuidance');
      const step1Guide = document.getElementById('step1Guide');
      const step2Guide = document.getElementById('step2Guide');
      const step3Guide = document.getElementById('step3Guide');
      const desiredEmotionHint = document.getElementById('desiredEmotionHint');

      // Hide main guidance once user starts engaging
      if (state.step > 1 || state.current) {
        guidanceCard.style.display = 'none';
        stepGuidance.style.display = '';
      } else {
        guidanceCard.style.display = '';
        stepGuidance.style.display = 'none';
      }

      // Show step-specific guidance
      step1Guide.style.display = (state.step === 1) ? '' : 'none';
      step2Guide.style.display = (state.step === 2) ? '' : 'none';
      step3Guide.style.display = (state.step === 3) ? '' : 'none';

      // Smart filtering: no double-low selections
      if (state.step === 2 && state.current) {
        const currentCat = findEmotionCategory(state.current.name);
        if (currentCat === 'opportunity') {
          // Switch to Hi Energy tab if coming from opportunity emotion
          document.querySelector('.tab[data-cat="hi"]').click();
        }
      }

      // Update desired emotion hint in step 3
      if (state.step === 3 && state.desired && desiredEmotionHint) {
        desiredEmotionHint.textContent = state.desired.name.toLowerCase();
      }

      renderBadges();
      renderGrid();
      
      // Show/hide journal card
      journalCard.style.display = (state.step === 3) ? '' : 'none';
      if (state.step === 3 && state.desired) {
        desiredLabel.textContent = state.desired.name;
      }

      validate();
      saveDraft();
    }

    function findEmotionCategory(emotionName) {
      for (const cat of CATALOG.categories) {
        if (cat.items.some(item => item.name === emotionName)) {
          return cat.id;
        }
      }
      return 'hi'; // default
    }

    function validate(){
      const step = state.step;
      let canContinue = false;

      if (step === 1) {
        canContinue = !!state.current;
        nextBtn.textContent = 'Continue to Step 2';
      } else if (step === 2) {
        canContinue = !!state.current && !!state.desired;
        nextBtn.textContent = 'Continue to Reflection';
      } else if (step === 3) {
        const journalText = journal.value.trim();
        canContinue = !!state.current && !!state.desired && journalText.length >= 10;
        nextBtn.textContent = 'Share Your Journey';
      }

      nextBtn.disabled = !canContinue;
      nextBtn.style.opacity = canContinue ? '1' : '0.6';
      nextBtn.style.cursor = canContinue ? 'pointer' : 'not-allowed';
      
      backBtn.textContent = (step === 1) ? 'Exit' : 'Back';
    }

    function saveDraft(){
      try {
        localStorage.setItem('hi-gym-draft', JSON.stringify({
          step: state.step,
          current: state.current,
          desired: state.desired,
          journal: journal.value,
          timestamp: Date.now()
        }));
      } catch {}
    }

    function loadDraft(){
      try {
        const saved = localStorage.getItem('hi-gym-draft');
        if (!saved) return;
        
        const draft = JSON.parse(saved);
        const age = Date.now() - (draft.timestamp || 0);
        
        // Clear old drafts (24 hours)
        if (age > 24 * 60 * 60 * 1000) {
          localStorage.removeItem('hi-gym-draft');
          return;
        }

        state.current = draft.current;
        state.desired = draft.desired;
        journal.value = draft.journal || '';
        setStep(draft.step || 1);
        updateCharCount();
        
        // 🌟 Show discrete "Start Fresh" option when draft loaded
        console.log('💾 Draft restored. Press Ctrl+Shift+R to start fresh.');
      } catch {}
    }

    function startFresh(){
      localStorage.removeItem('hi-gym-draft');
      state.current = null;
      state.desired = null;
      state.step = 1;
      journal.value = '';
      setStep(1);
      updateCharCount();
      toast('✨ Started fresh! Ready for your new emotional journey.', 'default');
    }

    // 🌟 TESLA-GRADE: Add keyboard shortcut for hard reset
    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'R') {
        e.preventDefault();
        startFresh();
      }
    });

    function updateCharCount(){
      const len = journal.value.length;
      count.textContent = `${len}/600`;
      count.style.color = len > 580 ? '#ef4444' : '';
    }

    function toast(msg, type = 'default'){
      console.log('Toast:', msg);
      toastEl.textContent = msg;
      
      // Style based on type
      if (type === 'celebration') {
        toastEl.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        toastEl.style.boxShadow = '0 10px 30px rgba(16, 185, 129, 0.4)';
      } else if (type === 'warning') {
        toastEl.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
        toastEl.style.boxShadow = '0 10px 30px rgba(245, 158, 11, 0.4)';
      } else {
        toastEl.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        toastEl.style.boxShadow = '0 10px 30px rgba(16, 185, 129, 0.4)';
      }
      
      toastEl.classList.remove('hide');
      toastEl.classList.add('show');
      
      setTimeout(() => {
        toastEl.classList.remove('show');
        toastEl.classList.add('hide');
      }, type === 'celebration' ? 3000 : 2000);
    }

    // Journal character counting
    journal.addEventListener('input', () => {
      updateCharCount();
      validate();
      saveDraft();
    });

    // Enhanced profile-first location management with traveling support
    async function loadUserLocation() {
      try {
        const userProfile = await window.hiDB.getUserProfile();
        const locationEducation = document.getElementById('locationEducation');
        const travelingContainer = document.getElementById('travelingContainer');
        const travelingToggle = document.getElementById('travelingToggle');
        
        if (userProfile?.location) {
          // User has set location - show traveling option and auto-populate
          locationInput.value = userProfile.location;
          travelingContainer.style.display = '';
          locationEducation.innerHTML = `<strong>Great!</strong> Using your saved location: <strong>${userProfile.location}</strong>. This helps build your local Hi community.`;
          
          // Handle traveling toggle
          travelingToggle.addEventListener('change', function() {
            if (this.checked) {
              // Store original location and clear input for manual entry
              this.dataset.homeLocation = userProfile.location;
              locationInput.value = '';
              locationInput.placeholder = 'Where are you traveling? (e.g., Paris, France)';
              locationEducation.innerHTML = `✈️ <strong>Traveling mode:</strong> Will post from your travel location but keep <strong>${userProfile.location}</strong> as your home base.`;
            } else {
              // Restore home location
              locationInput.value = userProfile.location;
              locationInput.placeholder = 'e.g., Austin, TX or London, UK';
              locationEducation.innerHTML = `<strong>Great!</strong> Using your saved location: <strong>${userProfile.location}</strong>. This helps build your local Hi community.`;
            }
          });
        } else {
          // New user - hide traveling option, emphasize community benefits
          travelingContainer.style.display = 'none';
          locationEducation.innerHTML = `<strong>Optional but powerful:</strong> Adding your city/state helps you connect with others nearby and see how your community feels. Posts without location appear as "Global Community" shares.`;
        }
        
      } catch (error) {
        console.log('Could not load user location:', error);
        const locationEducation = document.getElementById('locationEducation');
        const travelingContainer = document.getElementById('travelingContainer');
        if (locationEducation) {
          locationEducation.innerHTML = `<strong>Connect locally:</strong> Add your city and state to find others nearby. Leave blank to share with the global community.`;
        }
        if (travelingContainer) {
          travelingContainer.style.display = 'none';
        }
      }
    }

    // Initialize
    state.startTime = Date.now(); // Track session duration
    loadDraft();
    loadUserLocation();
    setStep(state.step || 1);
    validate();

    // Tesla-grade smart suggestions on load
    window.addEventListener('load', () => {
      if (state.current && !state.desired && window.HiGym) {
        const suggestions = window.HiGym.suggestOptimalEmotions(state.current);
        if (suggestions.length > 0) {
          // Subtle suggestion in search placeholder
          search.placeholder = `Try: ${suggestions.slice(0, 2).join(', ')}...`;
        }
      }
    });

    })();
  </script>
  <script src="assets/premium-ux.js"></script>
  <script src="assets/premium-footer.js" defer></script>
  
  <!-- 🚀 PWA Manager -->
  <script src="assets/pwa-manager.js"></script>
</body>
</html>
