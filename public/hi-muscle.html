<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Build Your Hi Muscle â€” Stay Hi</title>
  <link rel="stylesheet" href="assets/create-parity.css"/>
  <style>
    :root{
      --hi-green:#006400;
      --hi-amber:#F5A623;
      --ink:#111;
      --muted:#666;
      --bg:#FFFDF9;
      --chip:#ffffff;
      --chip-b:#e9e9e9;
      --ring:#ffd78a;
    }
    body{background:var(--bg); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .title{font-weight:900;color:var(--ink);text-align:center;margin:8px 0 12px}
    .subtitle{color:var(--muted);text-align:center;margin:0 0 16px}
    /* stepper */
    .stepper{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px auto 16px}
    .dot{width:12px;height:12px;border-radius:50%;background:#e5e5e5;border:2px solid #ddd}
    .dot.active{background:var(--hi-green);border-color:var(--hi-green)}
    .pipe{height:2px;width:44px;background:#e5e5e5}
    .pipe.filled{background:var(--hi-green)}
    /* tabs */
    .tabs{display:flex;gap:6px;overflow:auto;border-bottom:1px solid #eee;padding-bottom:6px;margin-bottom:10px}
    .tab{white-space:nowrap;padding:8px 12px;border-radius:999px;border:1px solid var(--chip-b);background:var(--chip);font-weight:700;color:#333;cursor:pointer}
    .tab[aria-selected="true"]{background:#111;color:#fff;border-color:#111}
    /* search */
    .search{display:flex;gap:8px;align-items:center;background:#fff;border:1px solid #eee;border-radius:12px;padding:8px 10px}
    .search input{border:0;outline:0;width:100%;font-size:16px}
    /* grid of chips */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    @media (max-width:720px){ .grid{grid-template-columns:repeat(2,1fr);} }
    .chip{
      display:flex;gap:8px;align-items:center;
      background:var(--chip); border:1px solid var(--chip-b); border-radius:14px;
      padding:10px 12px; cursor:pointer; position:relative;
      transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .chip:hover{transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.05)}
    .chip .emo{font-size:20px}
    .chip .name{font-weight:800;color:#222}
    .chip .desc{font-size:12px;color:#666;line-height:1.2}
    .chip.selected{outline:3px solid var(--ring); border-color:#ffefc7; background:#fffaf0}
    .pickTitle{font-weight:900;color:#222;margin:14px 0 6px}
    .actions{display:flex;gap:10px;justify-content:center;margin:16px 0}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
         padding:12px 16px;border-radius:14px;font-weight:900;cursor:pointer;border:1px solid transparent}
    .btn-primary{background:var(--hi-green);color:#fff}
    .btn-ghost{background:#fff;border-color:#ddd;color:#111}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    /* journal */
    .card{background:#fff;border:1px solid #eee;border-radius:16px;padding:14px}
    textarea{width:100%;border:1px solid #e4e4e4;border-radius:12px;min-height:110px;padding:12px;font:inherit}
    .hint{color:var(--muted);font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid #eee;border-radius:999px;padding:8px 10px;font-weight:700}
    .inline{display:flex;gap:10px;flex-wrap:wrap}
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#000;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none}
    .toast.show{opacity:1;transition:opacity .2s}
  </style>
</head>
<body>
  <header id="app-header"></header>

  <div class="wrap">
    <h1 class="title">Build Your Hi Muscle</h1>
    <p class="subtitle">Pick your <b>current vibe</b>, then your <b>desired vibe</b>. Reflect for 1â€“2 lines. Drop your Hi.</p>

    <!-- stepper -->
    <div class="stepper" aria-label="Progress">
      <div class="dot" id="s1"></div><div class="pipe" id="p1"></div><div class="dot" id="s2"></div>
    </div>

    <!-- selection badges -->
    <div class="inline" style="justify-content:center;margin-bottom:8px">
      <span class="badge" id="badge-current" style="display:none"></span>
      <span class="badge" id="badge-desired" style="display:none"></span>
    </div>

    <!-- tabs + search -->
    <div class="tabs" role="tablist" aria-label="Emotion categories">
      <button class="tab" role="tab" id="tab-hi" aria-selected="true" data-cat="hi">Hi Energy</button>
      <button class="tab" role="tab" id="tab-neutral" aria-selected="false" data-cat="neutral">Neutral</button>
      <button class="tab" role="tab" id="tab-opportunity" aria-selected="false" data-cat="opportunity">Hi Opportunity</button>
    </div>

    <div class="search">
      <span>ðŸ”Ž</span><input id="search" placeholder="Search emotions (e.g., calm, joy, worry)"/>
      <button id="toggleView" class="btn btn-ghost" style="padding:8px 10px">Compact</button>
    </div>

    <!-- grid -->
    <div id="grid" class="grid" aria-live="polite"></div>

    <!-- journal card (appears after both selected) -->
    <div id="journalCard" class="card" style="display:none;margin-top:14px">
      <div class="pickTitle">Hi Reflection (why this vibe matters)</div>
      <textarea id="journal" maxlength="600" placeholder="One or two honest lines. What would Hi look or feel like right now?"></textarea>
      <div class="inline" style="justify-content:space-between;margin-top:6px">
        <span class="hint" id="count">0/600</span>
        <label class="hint"><input type="checkbox" id="anon" /> Share anonymously</label>
      </div>
    </div>

    <!-- actions -->
    <div class="actions">
      <button id="back" class="btn btn-ghost">Back</button>
      <button id="next" class="btn btn-primary" disabled>Continue</button>
    </div>

    <div class="inline" style="justify-content:center;margin-top:8px">
      <a class="btn btn-ghost" href="hi-island.html">Go to Hi Island</a>
      <a class="btn btn-ghost" href="index.html">Back to Home</a>
    </div>
  </div>

  <div id="toast" class="toast">Saved</div>

  <!-- header/menu injection -->
  <script src="assets/header.js" defer></script>

  <!-- Supabase client + auth guard -->
  <script src="assets/supabase-init.js"></script>
  <script src="assets/auth.js"></script>

  <!-- emotions data -->
  <script src="assets/emotions.js"></script>

  <script>
  (async function(){
    // Require login; keep this here so local dev with file:// can still preview if you used the dev flag
    try { await hiAuth.requireAuth(); } catch {}

    const state = {
      step: 1,                         // 1=current, 2=desired, 3=journal
      current: null,
      desired: null,
      compact: false,
      cat: 'hi',
      q: ''
    };

    // Elements
    const grid = document.getElementById('grid');
    const tabs = document.querySelectorAll('.tab');
    const search = document.getElementById('search');
    const toggleView = document.getElementById('toggleView');
    const nextBtn = document.getElementById('next');
    const backBtn = document.getElementById('back');
    const badgeCur = document.getElementById('badge-current');
    const badgeDes = document.getElementById('badge-desired');
    const journalCard = document.getElementById('journalCard');
    const journal = document.getElementById('journal');
    const count = document.getElementById('count');
    const toast = document.getElementById('toast');
    const s1 = document.getElementById('s1'), s2 = document.getElementById('s2'), p1 = document.getElementById('p1');

    function setStep(n){
      state.step = n;
      s1.classList.toggle('active', n >= 1);
      s2.classList.toggle('active', n >= 2);
      p1.classList.toggle('filled', n >= 2);
      nextBtn.textContent = (n === 3) ? 'Drop Your Hi' : 'Continue';
      renderGrid();
      renderBadges();
      journalCard.style.display = (n === 3) ? '' : 'none';
      validate();
    }

    function toastShow(t){ toast.textContent = t; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1400); }
    function saveDraft(){
      const draft = {
        current: state.current, desired: state.desired,
        text: journal.value.trim(), anon: document.getElementById('anon').checked
      };
      try { localStorage.setItem('hi_draft', JSON.stringify(draft)); } catch {}
    }
    function loadDraft(){
      try {
        const raw = localStorage.getItem('hi_draft'); if(!raw) return;
        const d = JSON.parse(raw);
        state.current = d.current || null;
        state.desired = d.desired || null;
        journal.value = d.text || '';
        document.getElementById('anon').checked = !!d.anon;
      } catch {}
    }

    function renderBadges(){
      if (state.current){
        badgeCur.style.display = '';
        badgeCur.innerHTML = `Current: ${state.current.emoji} <b>${state.current.name}</b>`;
      } else badgeCur.style.display = 'none';

      if (state.desired){
        badgeDes.style.display = '';
        badgeDes.innerHTML = `Desired: ${state.desired.emoji} <b>${state.desired.name}</b>`;
      } else badgeDes.style.display = 'none';
    }

    function currentList(){
      const cat = window.HI_EMOTIONS.categories.find(c => c.id === state.cat) || window.HI_EMOTIONS.categories[0];
      let list = cat.items;
      if (state.q) {
        const q = state.q.toLowerCase();
        list = list.filter(x => x.name.toLowerCase().includes(q) || (x.desc||'').toLowerCase().includes(q));
      }
      return list;
    }

    function renderGrid(){
      const list = currentList();
      grid.innerHTML = '';
      grid.classList.toggle('grid-compact', state.compact);

      list.forEach(item => {
        const div = document.createElement('button');
        div.type = 'button';
        div.className = 'chip';
        div.setAttribute('data-name', item.name);
        div.setAttribute('title', item.desc || item.name);

        div.innerHTML = `
          <span class="emo">${item.emoji}</span>
          <div style="display:flex;flex-direction:column;align-items:flex-start">
            <span class="name">${item.name}</span>
            ${state.compact ? '' : `<span class="desc">${item.desc || ''}</span>`}
          </div>
        `;

        const isSelected = (state.step === 1 && state.current?.name === item.name) ||
                           (state.step === 2 && state.desired?.name === item.name);
        if (isSelected) div.classList.add('selected');

        div.addEventListener('click', () => {
          if (state.step === 1) {
            state.current = item;
            setStep(2);
          } else if (state.step === 2) {
            state.desired = item;
            setStep(3);
          } else {
            // In journal step, clicking lets you tweak selection again
            state.current = item;
            state.desired = null;
            setStep(2);
          }
          saveDraft();
        });

        grid.appendChild(div);
      });
    }

    function validate(){
      if (state.step === 1) { nextBtn.disabled = !state.current; return; }
      if (state.step === 2) { nextBtn.disabled = !state.desired; return; }
      if (state.step === 3) {
        const ok = !!(state.current && state.desired && journal.value.trim().length >= 10);
        nextBtn.disabled = !ok; return;
      }
    }

    // events
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.setAttribute('aria-selected','false'));
      t.setAttribute('aria-selected','true');
      state.cat = t.dataset.cat;
      renderGrid();
    }));

    search.addEventListener('input', () => { state.q = search.value.trim(); renderGrid(); });
    toggleView.addEventListener('click', () => {
      state.compact = !state.compact;
      toggleView.textContent = state.compact ? 'Comfort' : 'Compact';
      renderGrid();
    });
    backBtn.addEventListener('click', () => {
      if (state.step === 1) { window.location.href = 'index.html'; return; }
      if (state.step === 2) { setStep(1); return; }
      if (state.step === 3) { setStep(2); return; }
    });
    nextBtn.addEventListener('click', async () => {
      if (state.step < 3) { setStep(state.step + 1); return; }

      // Final submit (MVP: stage to localStorage; Step 7 will post to Supabase)
      const payload = {
        currentEmoji: state.current.emoji,
        currentName: state.current.name,
        desiredEmoji: state.desired.emoji,
        desiredName: state.desired.name,
        journal: journal.value.trim(),
        isAnonymous: document.getElementById('anon').checked,
        createdAt: new Date().toISOString()
      };
      try {
        localStorage.setItem('hi_staged_share', JSON.stringify(payload));
        toastShow('Saved â€” weâ€™ll light up Hi Island next step');
        setTimeout(()=> window.location.href = 'hi-island.html', 800);
      } catch(e){
        alert('Could not save locally. We will wire the database next.');
      }
    });

    journal.addEventListener('input', () => {
      count.textContent = `${journal.value.length}/600`;
      validate(); saveDraft();
    });

    // init
    loadDraft();
    renderBadges();
    renderGrid();
    validate();
    if (state.current && state.desired) setStep(3); else if (state.current) setStep(2); else setStep(1);
  })();
  </script>
</body>
</html>
