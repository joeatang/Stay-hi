<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Build Your Hi Muscle ‚Äî Stay Hi</title>

  <!-- Brand + shared styles -->
  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>

  <style>
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .title{font-weight:900;color:var(--hi-ink);text-align:center;margin:8px 0 6px;font-size:var(--fs-h1)}
    .subtitle{color:var(--hi-muted);text-align:center;margin:0 0 16px;font-size:.98rem}

    /* stepper */
    .stepper{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px auto 16px}
    .dot{width:12px;height:12px;border-radius:50%;background:#e5e5e5;border:2px solid #ddd}
    .dot.active{background:var(--hi-green);border-color:var(--hi-green)}
    .pipe{height:2px;width:44px;background:#e5e5e5}
    .pipe.filled{background:var(--hi-green)}

    /* tabs + search */
    .tabs{display:flex;gap:6px;overflow:auto;border-bottom:1px solid var(--hi-border);padding-bottom:6px;margin-bottom:10px}
    .tab{white-space:nowrap;padding:8px 12px;border-radius:999px;border:1px solid var(--hi-border);background:#fff;font-weight:700;color:#333;cursor:pointer}
    .tab[aria-selected="true"]{background:#111;color:#fff;border-color:#111}
    .search{display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--hi-border);border-radius:12px;padding:8px 10px}
    .search input{border:0;outline:0;width:100%;font-size:16px}

    /* grid of emotion chips */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    @media (max-width:720px){ .grid{grid-template-columns:repeat(2,1fr);} }
    .chip{
      display:flex;gap:8px;align-items:center;
      background:#fff; border:1px solid var(--hi-border); border-radius:14px;
      padding:10px 12px; cursor:pointer; position:relative;
      transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease;
      text-align:left;
    }
    .chip:hover{transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.05)}
    .chip .emo{font-size:20px}
    .chip .name{font-weight:800;color:#222}
    .chip .desc{font-size:12px;color:var(--hi-muted);line-height:1.2}
    .chip.selected{outline:3px solid var(--ring); border-color:#ffefc7; background:#fffaf0}

    .pickTitle{font-weight:900;color:#222;margin:14px 0 6px}

    .actions{display:flex;gap:10px;justify-content:center;margin:16px 0;flex-wrap:wrap}

    textarea{width:100%;border:1px solid var(--hi-border);border-radius:12px;min-height:120px;padding:12px;font:inherit;background:#fff;color:var(--hi-ink)}
    .badges{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:8px}
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#000;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;z-index:1000}
    .toast.show{opacity:1;transition:opacity .2s}

    /* Share sheet */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:50}
    .sheet{position:fixed;left:0;right:0;bottom:-100%;background:var(--hi-bg);border-radius:18px 18px 0 0;border:1px solid var(--hi-border);padding:16px 14px;z-index:60;box-shadow:0 -10px 30px rgba(0,0,0,.12)}
    .sheet.show + .sheet-backdrop{display:block}
    .sheet.show{animation:sheetIn .25s ease-out forwards}
    .sheet.hide{animation:sheetOut .2s ease-in forwards}
    @keyframes sheetIn{from{bottom:-100%}to{bottom:0}}
    @keyframes sheetOut{from{bottom:0}to{bottom:-100%}}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;flex-wrap:wrap}
    .switch{position:relative;width:44px;height:26px;background:#e8e8e8;border-radius:999px;cursor:pointer;border:1px solid var(--hi-border)}
    .knob{position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.2);transition:left .15s}
    .switch.on{background:#0a8a3a;border-color:#0a8a3a}
    .switch.on .knob{left:22px}
    .sheet h3{margin:4px 0 2px;font-size:16px}
    .sheet .muted{font-size:13px;color:var(--hi-muted)}
    .hr{height:1px;background:var(--hi-border);margin:8px 0}
    .field{display:flex;gap:8px;align-items:center;border:1px solid var(--hi-border);border-radius:12px;padding:8px 10px;background:#fff}
    .field input{border:0;outline:0;width:100%;font:inherit}
  </style>
</head>
<body data-tab="muscle">
  <!-- Shared header -->
  <header id="app-header" class="header"></header>

  <div class="wrap">
    <h1 class="title">Build Your Hi Muscle</h1>
    <p class="subtitle">Pick your <b>current vibe</b>, then your <b>desired vibe</b>. Reflect for 1‚Äì2 lines. Drop your Hi.</p>

    <!-- stepper -->
    <div class="stepper" aria-label="Progress">
      <div class="dot" id="s1"></div><div class="pipe" id="p1"></div><div class="dot" id="s2"></div><div class="pipe" id="p2"></div><div class="dot" id="s3"></div>
    </div>

    <!-- badges -->
    <div class="badges">
      <span class="hi-chip" id="badge-current" style="display:none"></span>
      <span class="hi-chip" id="badge-desired" style="display:none"></span>
    </div>

    <!-- tabs + search -->
    <div class="tabs" role="tablist" aria-label="Emotion categories">
      <button class="tab" role="tab" aria-selected="true"  data-cat="hi">Hi Energy</button>
      <button class="tab" role="tab" aria-selected="false" data-cat="neutral">Neutral</button>
      <button class="tab" role="tab" aria-selected="false" data-cat="opportunity">Hi Opportunity</button>
    </div>

    <div class="search">
      <span>üîé</span><input id="search" placeholder="Search emotions (e.g., calm, joy, worry)"/>
      <button id="toggleView" class="hi-btn hi-btn--ghost" style="padding:8px 10px">Compact</button>
    </div>

    <!-- grid -->
    <div id="grid" class="grid" aria-live="polite"></div>

    <!-- Hi Thought -->
    <div id="journalCard" class="hi-card" style="display:none;margin-top:14px">
      <div class="pickTitle">Hi Thought</div>
      <p class="hi-hint" style="margin:.25rem 0 .6rem">
        In <b>1‚Äì2 honest lines</b>, tell your future self why shifting to
        <span id="desiredLabel">this vibe</span> matters <i>today</i>.
      </p>
      <textarea id="journal" maxlength="600" placeholder="e.g., Choosing calm helps me be present with my family tonight, even if the day was loud."></textarea>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
        <span class="hi-hint" id="count">0/600</span>
        <label class="hi-hint"><input type="checkbox" id="anon" /> Post as Anonymous</label>
      </div>
    </div>

    <!-- actions -->
    <div class="actions">
      <button id="back" class="hi-btn hi-btn--ghost">Back</button>
      <button id="next" class="hi-btn hi-btn--primary" disabled>Continue</button>
    </div>

    <div style="display:flex;gap:10px;justify-content:center;margin-top:8px;flex-wrap:wrap">
      <a class="hi-btn hi-btn--ghost" href="hi-island.html">Go to Hi Island</a>
      <a class="hi-btn hi-btn--ghost" href="index.html">Back to Home</a>
    </div>
  </div>

  <!-- Share Sheet -->
  <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" aria-hidden="true">
    <h3 id="sheetTitle">How do you want to drop your Hi?</h3>
    <p class="muted" style="color:var(--hi-muted)">We‚Äôll always save a private copy in <b>My Archive</b>.</p>

    <div class="row" style="margin-top:6px">
      <div>
        <div style="font-weight:800">Show on Hi Island</div>
        <div class="muted" style="color:var(--hi-muted)">Appear in the global General Shares feed</div>
      </div>
      <div id="togglePublic" class="switch on" role="switch" aria-checked="true" tabindex="0"><div class="knob" aria-hidden="true"></div></div>
    </div>

    <div class="row">
      <div>
        <div style="font-weight:800">Post as Anonymous</div>
        <div class="muted" style="color:var(--hi-muted)">Your name becomes ‚ÄúHi Friend‚Äù</div>
      </div>
      <div id="toggleAnon" class="switch" role="switch" aria-checked="false" tabindex="0"><div class="knob" aria-hidden="true"></div></div>
    </div>

    <div class="hr"></div>
    <div class="field" aria-label="Optional location">
      <span>üìç</span><input id="locationInput" placeholder="City, State (optional)"/>
    </div>

    <div class="row" style="justify-content:flex-end">
      <button id="cancelShare" class="hi-btn hi-btn--ghost">Cancel</button>
      <button id="confirmShare" class="hi-btn hi-btn--primary">Drop Hi</button>
    </div>
  </div>
  <div id="backdrop" class="sheet-backdrop" aria-hidden="true"></div>

  <div id="toast" class="toast">Saved</div>

  <!-- DATA & APP SCRIPTS (order matters) -->
  <script src="assets/supabase-init.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/db.js"></script>
  <script src="assets/header.js" defer></script>
  <script src="assets/emotions.js"></script>

  <script>
  (async function(){
    // Let signed-out users still play locally (offline fallback will queue).
    try { await hiAuth.ensureSessionMaybe?.(); } catch {}

    const state = {
      step: 1,                // 1=current, 2=desired, 3=journal
      current: null,
      desired: null,
      cat: 'hi',
      q: ''
    };

    // Elements
    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const toggleView = document.getElementById('toggleView');
    const nextBtn = document.getElementById('next');
    const backBtn = document.getElementById('back');
    const badgeCur = document.getElementById('badge-current');
    const badgeDes = document.getElementById('badge-desired');
    const journalCard = document.getElementById('journalCard');
    const journal = document.getElementById('journal');
    const count = document.getElementById('count');
    const desiredLabel = document.getElementById('desiredLabel');
    const s1 = document.getElementById('s1'), s2 = document.getElementById('s2'), s3 = document.getElementById('s3');
    const p1 = document.getElementById('p1'), p2 = document.getElementById('p2');
    const toastEl = document.getElementById('toast');

    // Share sheet bits
    const sheet = document.getElementById('sheet');
    const backdrop = document.getElementById('backdrop');
    const togglePublic = document.getElementById('togglePublic');
    const toggleAnon = document.getElementById('toggleAnon');
    const locationInput = document.getElementById('locationInput');
    const cancelShare = document.getElementById('cancelShare');
    const confirmShare = document.getElementById('confirmShare');

    // Tabs
    document.querySelectorAll('.tab').forEach(t => {
      t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.setAttribute('aria-selected','false'));
        t.setAttribute('aria-selected','true');
        state.cat = t.dataset.cat;
        renderGrid();
      });
    });

    // Search + compact
    search.addEventListener('input', () => { state.q = search.value.trim(); renderGrid(); });
    toggleView.addEventListener('click', () => {
      const descs = document.querySelectorAll('.desc');
      const compact = toggleView.textContent === 'Compact';
      toggleView.textContent = compact ? 'Comfort' : 'Compact';
      descs.forEach(d => d.style.display = compact ? 'none' : '');
    });

    // Nav buttons
    backBtn.addEventListener('click', () => {
      if (state.step === 1) { window.location.href = 'index.html'; return; }
      if (state.step === 2) { setStep(1); return; }
      if (state.step === 3) { setStep(2); return; }
    });
    nextBtn.addEventListener('click', () => {
      if (state.step < 3) { setStep(state.step + 1); return; }
      openSheet(); // final step ‚Üí share options
    });

    // Share sheet helpers
    function setSwitch(el, on){
      el.classList.toggle('on', !!on);
      el.setAttribute('aria-checked', on ? 'true' : 'false');
    }
    function getSwitch(el){ return el.classList.contains('on'); }
    [togglePublic, toggleAnon].forEach(sw=>{
      sw.addEventListener('click', ()=> setSwitch(sw, !getSwitch(sw)));
      sw.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); setSwitch(sw, !getSwitch(sw)); }});
    });
    backdrop.addEventListener('click', closeSheet);
    cancelShare.addEventListener('click', closeSheet);

    function openSheet(){
      sheet.classList.remove('hide');
      sheet.classList.add('show');
      sheet.setAttribute('aria-hidden','false');
      backdrop.style.display = 'block';
    }
    function closeSheet(){
      sheet.classList.remove('show');
      sheet.classList.add('hide');
      sheet.setAttribute('aria-hidden','true');
      setTimeout(()=>{ backdrop.style.display = 'none';}, 180);
    }

    // Confirm share ‚Üí write to DB (with hiDB offline queue)
    confirmShare.addEventListener('click', async () => {
      const text = journal.value.trim();
      const isAnon = getSwitch(toggleAnon) || document.getElementById('anon').checked;
      const toIsland = getSwitch(togglePublic);
      const loc = (locationInput.value || '').trim();

      // 1) Private archive (always)
      await window.hiDB.insertArchive({
        currentEmoji: state.current.emoji,
        desiredEmoji: state.desired.emoji,
        journal: text,
        location: loc
      });

      // 2) Optional public share
      if (toIsland) {
        await window.hiDB.insertPublicShare({
          currentEmoji: state.current.emoji,
          currentName: state.current.name,
          desiredEmoji: state.desired.emoji,
          desiredName: state.desired.name,
          text,
          isAnonymous: isAnon,
          location: loc,
          isPublic: true
        });
      }

      closeSheet();
      toast('Hi dropped ‚ú®');
      setTimeout(()=> window.location.href = 'hi-island.html', 650);
    });

    // Renderers
    function currentList(){
      const cat = window.HI_EMOTIONS?.categories?.find(c => c.id === state.cat) || window.HI_EMOTIONS.categories[0];
      let list = cat.items || [];
      if (state.q) {
        const q = state.q.toLowerCase();
        list = list.filter(x => x.name.toLowerCase().includes(q) || (x.desc||'').toLowerCase().includes(q));
      }
      return list;
    }

    function renderGrid(){
      const list = currentList();
      grid.innerHTML = '';
      list.forEach(item => {
        const div = document.createElement('button');
        div.type = 'button';
        div.className = 'chip';
        div.setAttribute('title', item.desc || item.name);
        div.innerHTML = `
          <span class="emo">${item.emoji}</span>
          <div style="display:flex;flex-direction:column;align-items:flex-start">
            <span class="name">${item.name}</span>
            <span class="desc">${item.desc || ''}</span>
          </div>
        `;
        const isSelected = (state.step === 1 && state.current?.name === item.name) ||
                           (state.step === 2 && state.desired?.name === item.name);
        if (isSelected) div.classList.add('selected');

        div.addEventListener('click', () => {
          if (state.step === 1) {
            state.current = item; setStep(2);
          } else if (state.step === 2) {
            state.desired = item; setStep(3);
          } else {
            // In journal step, clicking lets you tweak selection again
            state.current = item; state.desired = null; setStep(2);
          }
          saveDraft();
        });

        grid.appendChild(div);
      });
    }

    function renderBadges(){
      if (state.current){
        badgeCur.style.display = '';
        badgeCur.innerHTML = `Current: ${state.current.emoji} <b>${state.current.name}</b>`;
      } else badgeCur.style.display = 'none';

      if (state.desired){
        badgeDes.style.display = '';
        badgeDes.innerHTML = `Desired: ${state.desired.emoji} <b>${state.desired.name}</b>`;
      } else badgeDes.style.display = 'none';
    }

    function setStep(n){
      state.step = n;
      s1.classList.toggle('active', n >= 1);
      s2.classList.toggle('active', n >= 2);
      s3.classList.toggle('active', n >= 3);
      p1.classList.toggle('filled', n >= 2);
      p2.classList.toggle('filled', n >= 3);
      nextBtn.textContent = (n === 3) ? 'Drop Your Hi' : 'Continue';
      journalCard.style.display = (n === 3) ? '' : 'none';
      if (n === 3 && state.desired) desiredLabel.textContent = `${state.desired.emoji} ${state.desired.name}`;
      renderGrid(); renderBadges(); validate();
    }

    function validate(){
      if (state.step === 1) { nextBtn.disabled = !state.current; return; }
      if (state.step === 2) { nextBtn.disabled = !state.desired; return; }
      if (state.step === 3) {
        const ok = !!(state.current && state.desired && journal.value.trim().length >= 10);
        nextBtn.disabled = !ok; return;
      }
    }

    function toast(msg, ttl=1400){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ttl); }
    function saveDraft(){
      const draft = { current: state.current, desired: state.desired, text: journal.value.trim(), anon: document.getElementById('anon').checked };
      try { localStorage.setItem('hi_draft', JSON.stringify(draft)); } catch {}
    }
    function loadDraft(){
      try {
        const raw = localStorage.getItem('hi_draft'); if(!raw) return;
        const d = JSON.parse(raw);
        state.current = d.current || null;
        state.desired = d.desired || null;
        journal.value = d.text || '';
        document.getElementById('anon').checked = !!d.anon;
      } catch {}
    }

    journal.addEventListener('input', () => { count.textContent = `${journal.value.length}/600`; validate(); saveDraft(); });

    // init
    loadDraft();
    setStep(state.current && state.desired ? 3 : state.current ? 2 : 1);
    setSwitch(togglePublic, true);
    setSwitch(toggleAnon, false);
  })();
  </script>
</body>
</html>
