<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hi Gym ‚Äî Stay Hi</title>

  <!-- üì± PWA Configuration -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD166">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Hi Gym">

  <!-- Preload Supabase CDN for instant client init -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" as="script">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <!-- üé¨ CRITICAL: Inline Blocking Splash Screen (Prevents FOUC) -->
  <style id="splash-critical-css">
    /* GOLD STANDARD: Force splash visible IMMEDIATELY */
    body { 
      visibility: hidden !important; 
    }
    body.splash-ready {
      visibility: visible !important;
    }
    .hi-splash-instant {
      position: fixed !important;
      top: 0 !important; 
      left: 0 !important; 
      right: 0 !important; 
      bottom: 0 !important;
      z-index: 999999 !important;
      background: linear-gradient(135deg, 
        rgba(26, 29, 58, 1) 0%,
        rgba(37, 43, 82, 1) 25%,
        rgba(45, 30, 79, 1) 50%,
        rgba(55, 35, 70, 1) 75%,
        rgba(26, 29, 58, 1) 100%) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      opacity: 1 !important;
      visibility: visible !important;
    }
    .hi-splash-logo {
      width: 140px;
      height: 140px;
      border-radius: 32px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      animation: logoGlow 3s ease-in-out infinite;
    }
    @keyframes logoGlow {
      0%, 100% { 
        transform: scale(1);
        filter: drop-shadow(0 0 20px rgba(255, 122, 24, 0.4));
      }
      50% { 
        transform: scale(1.05);
        filter: drop-shadow(0 0 30px rgba(255, 122, 24, 0.6));
      }
    }
  </style>
  <script>
    // üöÄ GOLD STANDARD: Show body immediately, hide splash after load
    document.addEventListener('DOMContentLoaded', function() {
      document.body.classList.add('splash-ready');
    });
    
    window.splashStartTime = performance.now();
    window.addEventListener('load', function() {
      const splash = document.getElementById('instant-splash');
      if (!splash) return;
      
      const elapsed = performance.now() - window.splashStartTime;
      const minDuration = window.innerWidth <= 768 ? 1400 : 1200;
      const remaining = Math.max(0, minDuration - elapsed);
      
      setTimeout(() => {
        splash.style.transition = 'opacity 0.3s ease-out';
        splash.style.opacity = '0';
        setTimeout(() => splash.remove(), 300);
      }, remaining);
    }, { once: true });
  </script>

  
  <!-- üöÄ DEPENDENCY MANAGER: Prevents race conditions on first load -->
  <script src="./lib/boot/dependency-manager.js"></script>
  <!-- Tesla-grade auth system - health monitor first -->
  <script src="assets/url-path-fixer.js"></script>
  <!-- üî• FIX: Load HiSupabase.v3.js (actual client) + AuthReady.js for tier data -->
  <script src="./lib/HiSupabase.v3.js"></script>
  <script src="./lib/AuthReady.js" type="module"></script>
  <!-- Auth resilience for mobile session persistence -->
  <script src="./lib/auth/auth-resilience.js"></script>
  <!-- Unified Access Gate (replaces legacy anonymous modal) -->
  <script src="assets/hi-paths.js"></script>
  <!-- üéØ TIER CONFIG - Must load BEFORE HiMembership -->
  <script src="lib/config/TIER_CONFIG.js"></script>
  <script src="lib/membership/HiMembershipBridge.js"></script>
  <script src="lib/HiBrandTiers.js" async></script>
  <script src="lib/access/AccessGate.js"></script>
  <script src="components/AccessGateModal.js"></script>
  <!-- Unified Admin Access Manager -->
  <script src="./lib/admin/AdminAccessManager.js"></script>
  <!-- Access telemetry + upgrade handlers + SW register -->
  <script src="./lib/access/AccessGateTelemetry.js"></script>
  <script src="./lib/access/AccessGateTelemetryExport.js"></script>
  <script src="./lib/boot/upgrade-cta.js"></script>
  <script src="./lib/boot/sw-register.js"></script>
  
  <!-- üîê Authentication System (Tesla-Grade Progressive Auth) -->
  <script src="assets/post-auth-path.js"></script>
  <!-- Unified Auth Shim replaces progressive-auth.js -->
  <script src="lib/access/AuthShim.js"></script>

  <!-- üåü WOZNIAK-GRADE: Gold Standard Modal System (Unified Auth/Share Modals) -->
  <script src="lib/HiGoldStandardModal.js" async></script>
  
  <!-- üéØ TESLA-GRADE: Hi-Muscle Onboarding System -->
  <script src="assets/hi-muscle-onboarding.js" async></script>

  <!-- Global brand & Tesla performance -->
  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>
  <link rel="stylesheet" href="assets/premium-ux.css"/>
  <link rel="stylesheet" href="./ui/HiFooter/HiFooter.css"/>
  <link rel="stylesheet" href="./ui/HiModal/HiModal.css">
  
  <!-- üåü WOZNIAK-GRADE: Unified Share Sheet System (Auth Required v2.1.0) -->
  <link rel="stylesheet" href="ui/HiShareSheet/HiShareSheet.css?v=2.1.0"/>
  <link rel="stylesheet" href="ui/HiScale/HiScale.css?v=20241222-hi-scale"/>
  <script src="ui/HiScale/HiScale.js?v=20241231-global-export" type="module"></script>
  <script src="ui/HiShareSheet/HiShareSheet.js?v=2.1.0-auth" type="module"></script>
  
  <!-- üéØ TESLA-GRADE: Total His Tracking System (Hi-Muscle Support) -->
  <script src="lib/stats/GoldStandardTracker.js" type="module"></script>
  
  <!-- Tesla-Grade Milestone Celebration System -->
  <script src="assets/milestone-celebration-system.js" defer></script>
  
  <!-- Tesla-Grade Contextual Spotlight System -->
  <script src="assets/contextual-spotlight-system.js" defer></script>
  
  <!-- Tesla-Grade Smart Conversion System -->
  <script src="assets/smart-conversion-system.js" defer></script>

  <!-- üß≠ Tesla-Grade Navigation System -->
  <link rel="stylesheet" href="./lib/navigation/HiStandardNavigation.css"/>
  
  <!-- üìÖ Premium Calendar System -->
  <link rel="stylesheet" href="assets/premium-calendar.css?v=20241222-streak-fix"/>

  <style>
    /* Tesla-Grade Hi Gym Styling - Mobile First */
    * { box-sizing: border-box; }
    
    body {
      background: radial-gradient(1200px 600px at 50% -220px, rgba(78, 205, 196, 0.15) 0%, rgba(78, 205, 196, 0) 60%), #0f1024;
      color: #e8ebff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh; /* iOS 14 fallback */
      min-height: 100dvh; /* iOS 15.4+: Dynamic viewport */
      -webkit-text-size-adjust: 100%;
    }

    .wrap {
      max-width: 640px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100vh; /* iOS 14 fallback */
      min-height: 100dvh; /* iOS 15.4+: Dynamic viewport */
      display: flex;
      flex-direction: column;
    }

    /* Mobile-first responsive scaling */
    @media (min-width: 768px) {
      .wrap { padding: 24px; }
    }

    @media (min-width: 1024px) {
      .wrap { padding: 32px; }
    }

    .title{font-weight:900;text-align:center;margin:16px 0 8px;font-size:clamp(1.5rem, 4vw, 2.5rem);line-height:1.2}
    .subtitle{color:#cfd2ea;text-align:center;margin:0 0 24px;font-size:clamp(0.9rem, 2.5vw, 1.1rem);line-height:1.4;padding:0 8px}

    /* Mobile-first guidance card */
    .guidance-card {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 16px;
      padding: 20px;
      margin: 0 0 24px;
      text-align: center;
    }
    
    .guidance-title {
      font-weight: 800;
      font-size: 1.1rem;
      margin: 0 0 8px;
      color: #10b981;
    }
    
    .guidance-steps {
      font-size: 0.95rem;
      line-height: 1.5;
      color: #e8ebff;
    }
    
    .guidance-steps strong {
      color: #10b981;
      font-weight: 700;
    }

    /* stepper - mobile optimized */
    .stepper{display:flex;align-items:center;justify-content:center;gap:12px;margin:20px auto 24px;padding:0 16px}
    .dot{width:16px;height:16px;border-radius:50%;background:#2a2f56;border:3px solid #20264b;transition:all 0.3s ease}
    .dot.active{background:#10b981;border-color:#10b981;transform:scale(1.1)}
    .pipe{height:3px;width:32px;background:#2a2f56;transition:background 0.3s ease}
    .pipe.filled{background:#10b981}

    @media (min-width: 768px) {
      .stepper { gap: 16px; }
      .dot { width: 18px; height: 18px; }
      .pipe { width: 44px; }
    }

    /* üéØ TESLA-GRADE: Sticky Progress Bar - Mobile First */
    .sticky-progress-bar {
      position: sticky;
      top: calc(60px + env(safe-area-inset-top));
      z-index: 100;
      background: linear-gradient(135deg, 
        rgba(78, 205, 196, 0.15) 0%, 
        rgba(107, 91, 149, 0.15) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(78, 205, 196, 0.3);
      border-radius: 16px;
      padding: 12px 16px;
      margin: 16px 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .progress-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .progress-label {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 500;
    }

    .progress-label strong {
      color: #10b981;
      font-weight: 700;
    }

    .progress-description {
      font-size: 0.95rem;
      color: #fff;
      font-weight: 600;
    }

    .progress-dots-mini {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .mini-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .mini-dot.active {
      background: #10b981;
      transform: scale(1.2);
    }

    @media (min-width: 768px) {
      .sticky-progress-bar {
        padding: 16px 20px;
        border-radius: 20px;
      }
      
      .progress-label {
        font-size: 0.9rem;
      }
      
      .progress-description {
        font-size: 1.05rem;
      }
      
      .mini-dot {
        width: 12px;
        height: 12px;
      }
    }

    /* üåü GOLD STANDARD: Sticky Step Guidance - Universal Top Position */
    .floating-step-guidance {
      position: sticky;
      top: calc(60px + env(safe-area-inset-top)); /* Below nav, respects notch */
      z-index: 150;
      background: linear-gradient(135deg, 
        rgba(16, 185, 129, 0.96) 0%, 
        rgba(5, 150, 105, 0.96) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 12px 16px;
      margin: 0 0 16px 0;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      border-radius: 0 0 16px 16px; /* Rounded bottom for sleek look */
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-top: none;
      animation: slideDownFade 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      transition: all 0.3s ease;
    }

    @keyframes slideDownFade {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .sticky-step-guide {
      text-align: center;
      color: #fff;
      max-width: 640px;
      margin: 0 auto;
    }

    .step-label {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.85;
      margin-bottom: 4px;
    }

    .step-question {
      font-size: 0.95rem;
      font-weight: 800;
      margin-bottom: 4px;
      line-height: 1.25;
    }

    .step-hint {
      font-size: 0.8rem;
      opacity: 0.9;
      line-height: 1.35;
    }

    /* Tablet & Desktop: More breathing room */
    @media (min-width: 768px) {
      .floating-step-guidance {
        top: calc(70px + env(safe-area-inset-top));
        padding: 16px 24px;
        margin: 0 16px 20px 16px;
        border-radius: 16px; /* Full rounded on desktop */
        border-top: 1px solid rgba(255, 255, 255, 0.25);
      }

      .step-label {
        font-size: 0.75rem;
        margin-bottom: 6px;
      }

      .step-question {
        font-size: 1.1rem;
        margin-bottom: 6px;
      }

      .step-hint {
        font-size: 0.9rem;
      }
    }

    /* Large desktop: Constrain width */
    @media (min-width: 1024px) {
      .floating-step-guidance {
        margin: 0 auto 24px;
        max-width: 640px;
        padding: 18px 28px;
      }
    }

    /* üéØ TESLA-GRADE: Step Progress Indicator (Mobile First) */
    .step-progress {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      padding: 16px 0;
      margin-bottom: 12px;
    }

    .step-progress-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .step-progress-dot.active {
      width: 24px;
      border-radius: 4px;
      background: #FFD166;
      box-shadow: 0 2px 8px rgba(255, 209, 102, 0.4);
    }

    .step-progress-dot.completed {
      background: rgba(78, 205, 196, 0.8);
    }

    /* Tesla-Grade Emotion Category Tabs */
    .tabs {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 16px 0 20px 0;
      margin-bottom: 20px;
      -webkit-overflow-scrolling: touch;
      /* Remove the old border-bottom for cleaner look */
    }
    
    .tab {
      position: relative;
      white-space: nowrap;
      padding: 16px 24px;
      border-radius: 20px;
      border: none;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      color: rgba(255, 255, 255, 0.7);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      min-height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      letter-spacing: -0.02em;
    }

    /* Category-specific styling */
    .tab[data-cat="hi"] {
      background: linear-gradient(135deg, 
        rgba(255, 157, 77, 0.15) 0%, 
        rgba(255, 133, 51, 0.25) 100%);
      border: 1px solid rgba(255, 157, 77, 0.2);
    }

    .tab[data-cat="neutral"] {
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.08) 0%, 
        rgba(255, 255, 255, 0.12) 100%);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .tab[data-cat="opportunity"] {
      background: linear-gradient(135deg, 
        rgba(78, 205, 196, 0.15) 0%, 
        rgba(78, 205, 196, 0.25) 100%);
      border: 1px solid rgba(78, 205, 196, 0.2);
    }

    /* Hover states with Tesla-grade precision */
    .tab:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
    }

    .tab[data-cat="hi"]:hover {
      background: linear-gradient(135deg, 
        rgba(255, 157, 77, 0.25) 0%, 
        rgba(255, 133, 51, 0.35) 100%);
      box-shadow: 
        0 8px 32px rgba(255, 133, 51, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .tab[data-cat="neutral"]:hover {
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.15) 0%, 
        rgba(255, 255, 255, 0.22) 100%);
    }

    .tab[data-cat="opportunity"]:hover {
      background: linear-gradient(135deg, 
        rgba(78, 205, 196, 0.25) 0%, 
        rgba(78, 205, 196, 0.35) 100%);
      box-shadow: 
        0 8px 32px rgba(78, 205, 196, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    /* Active/Selected state with premium feel */
    .tab[aria-selected="true"] {
      transform: translateY(-1px);
      color: #fff;
      font-weight: 700;
      box-shadow: 
        0 8px 24px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .tab[data-cat="hi"][aria-selected="true"] {
      background: linear-gradient(135deg, #ff9d4d 0%, #ff8533 100%);
      border-color: #ff8533;
      color: #1b0f02;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .tab[data-cat="neutral"][aria-selected="true"] {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-color: #cbd5e1;
      color: #334155;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .tab[data-cat="opportunity"][aria-selected="true"] {
      background: linear-gradient(135deg, #4ecdc4 0%, #44b3ac 100%);
      border-color: #44b3ac;
      color: #0f2027;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Responsive scaling */
    @media (min-width: 768px) {
      .tabs {
        gap: 16px;
        padding: 20px 0 24px 0;
      }
      
      .tab { 
        padding: 18px 28px; 
        font-size: 1rem;
        min-height: 60px;
        border-radius: 24px;
      }
    }

    @media (min-width: 1024px) {
      .tab {
        padding: 20px 32px;
        font-size: 1.05rem;
        border-radius: 28px;
      }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      .tab:hover {
        transform: none;
      }
      
      .tab:active {
        transform: translateY(1px) scale(0.98);
      }
    }

    /* search - mobile optimized */
    .search{display:flex;gap:10px;align-items:center;background:#fff;border:2px solid var(--hi-border);border-radius:16px;padding:12px;margin-bottom:16px}
    .search input{border:0;outline:0;width:100%;font-size:16px;color:#111;background:transparent}
    .search input::placeholder{color:#6b7280}

    /* Hi Energy grid - perfect responsive scaling */
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:16px;
      padding:0 4px;
    }
    
    @media (min-width: 480px) { 
      .grid{
        grid-template-columns:repeat(2,1fr);
        gap:12px;
      } 
    }
    
    @media (min-width: 768px) { 
      .grid{
        grid-template-columns:repeat(3,1fr);
        gap:14px;
        padding:0;
      } 
    }
    
    @media (min-width: 1024px) {
      .grid{
        grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
        gap:16px;
      }
    }
    
    /* üåü HI ENERGY EMOTIONAL BUTTONS: Perfectly Sized with Hi Vibe Colors */
    .chip{
      display:flex;gap:8px;align-items:center;
      background:rgba(15, 16, 36, 0.8);
      border:1px solid rgba(255, 209, 102, 0.2);
      border-radius:12px;
      padding:12px 16px;
      cursor:pointer;
      text-align:left;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height:56px;
      box-shadow:
        0 2px 8px rgba(255, 209, 102, 0.1),
        0 1px 2px rgba(0,0,0,0.1);
      backdrop-filter:blur(10px);
      position:relative;
      overflow:hidden;
    }

    /* Hi Energy color scheme based on app's golden theme */
    .chip[data-category="hi"] {
      border-color:rgba(255, 209, 102, 0.4);
      background:linear-gradient(135deg, 
        rgba(255, 209, 102, 0.15) 0%, 
        rgba(15, 16, 36, 0.9) 100%);
    }
    
    .chip[data-category="neutral"] {
      border-color:rgba(207, 210, 234, 0.3);
      background:linear-gradient(135deg, 
        rgba(207, 210, 234, 0.1) 0%, 
        rgba(15, 16, 36, 0.9) 100%);
    }
    
    .chip[data-category="opportunity"] {
      border-color:rgba(78, 205, 196, 0.4);
      background:linear-gradient(135deg, 
        rgba(78, 205, 196, 0.15) 0%, 
        rgba(15, 16, 36, 0.9) 100%);
    }

    /* üéØ GOLD STANDARD: Haptic-like button press feedback (Mobile First) */
    .chip:active {
      transform: translateY(2px) scale(0.98);
      transition: transform 0.1s ease;
      box-shadow:
        0 2px 8px rgba(255, 209, 102, 0.3),
        inset 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    /* Hi Energy hover states with golden glow */
    .chip:hover{
      transform:translateY(-2px) scale(1.02);
      box-shadow:
        0 8px 25px rgba(255, 209, 102, 0.3),
        0 4px 12px rgba(0,0,0,0.2);
      border-color:rgba(255, 209, 102, 0.6);
    }

    .chip[data-category="hi"]:hover {
      border-color:rgba(255, 209, 102, 0.8);
      background:linear-gradient(135deg, 
        rgba(255, 209, 102, 0.25) 0%, 
        rgba(15, 16, 36, 0.95) 100%);
      box-shadow:
        0 8px 25px rgba(255, 209, 102, 0.4),
        0 4px 12px rgba(255, 209, 102, 0.2);
    }

    .chip[data-category="neutral"]:hover {
      border-color:rgba(207, 210, 234, 0.6);
      background:linear-gradient(135deg, 
        rgba(207, 210, 234, 0.2) 0%, 
        rgba(15, 16, 36, 0.95) 100%);
    }

    .chip[data-category="opportunity"]:hover {
      border-color:rgba(78, 205, 196, 0.7);
      background:linear-gradient(135deg, 
        rgba(78, 205, 196, 0.25) 0%, 
        rgba(15, 16, 36, 0.95) 100%);
      box-shadow:
        0 8px 25px rgba(78, 205, 196, 0.3),
        0 4px 12px rgba(78, 205, 196, 0.15);
    }

    /* Active state handled above for better mobile experience */
    
    /* Properly sized emoji */
    .chip .emo{
      font-size:20px;
      min-width:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:transform 0.3s ease;
      flex-shrink:0;
    }
    
    .chip:hover .emo {
      transform:scale(1.1);
    }
    
    /* Hi Energy text styling that fits properly */
    .chip .name{
      font-weight:700;
      color:#FFD166;
      font-size:0.9rem;
      line-height:1.2;
      letter-spacing:-0.01em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    
    .chip .desc{
      font-size:0.75rem;
      color:#cfd2ea;
      line-height:1.3;
      margin-top:2px;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-line-clamp:2;
      line-clamp:2;
      -webkit-box-orient:vertical;
    }

    /* Hi Energy selected state with golden highlight */
    .chip.selected{
      transform:translateY(-3px) scale(1.05);
      border-width:2px;
      box-shadow:
        0 12px 30px rgba(255, 209, 102, 0.4),
        0 6px 15px rgba(255, 209, 102, 0.2);
    }

    .chip.selected[data-category="hi"] {
      border-color:#FFD166;
      background:linear-gradient(135deg, 
        rgba(255, 209, 102, 0.3) 0%, 
        rgba(15, 16, 36, 0.95) 100%);
      box-shadow:
        0 12px 30px rgba(255, 209, 102, 0.5),
        0 6px 15px rgba(255, 209, 102, 0.3);
    }

    .chip.selected[data-category="neutral"] {
      border-color:#cfd2ea;
      background:linear-gradient(135deg, 
        rgba(207, 210, 234, 0.2) 0%, 
        rgba(15, 16, 36, 0.95) 100%);
      box-shadow:
        0 12px 30px rgba(207, 210, 234, 0.3),
        0 6px 15px rgba(207, 210, 234, 0.2);
    }

    .chip.selected[data-category="opportunity"] {
      border-color:#4ECDC4;
      background:linear-gradient(135deg, 
        rgba(78, 205, 196, 0.3) 0%, 
        rgba(15, 16, 36, 0.95) 100%);
      box-shadow:
        0 12px 30px rgba(78, 205, 196, 0.4),
        0 6px 15px rgba(78, 205, 196, 0.2);
    }

    .chip.selected .emo {
      transform:scale(1.15);
      filter:drop-shadow(0 2px 4px rgba(255, 209, 102, 0.3));
    }

    .chip.selected .name {
      color:#ffffff;
      font-weight:800;
      text-shadow:0 1px 2px rgba(0,0,0,0.3);
    }

    .chip.selected .desc {
      color:#e8ebff;
    }

    /* Hi Energy pulse animation */
    .chip.selected::before {
      content:'';
      position:absolute;
      top:-1px;left:-1px;right:-1px;bottom:-1px;
      border-radius:13px;
      background:linear-gradient(45deg, transparent, rgba(255, 209, 102, 0.2), transparent);
      animation:hiEnergyPulse 2s ease-in-out infinite;
      z-index:-1;
    }

    @keyframes hiEnergyPulse {
      0%, 100% { opacity:0.5; transform:scale(1); }
      50% { opacity:0.8; transform:scale(1.01); }
    }

    /* Perfect responsive scaling */
    @media (min-width: 768px) {
      .chip { 
        padding: 14px 18px;
        min-height: 64px;
        border-radius: 14px;
      }
      .chip .emo { font-size: 22px; min-width: 22px; }
      .chip .name { font-size: 1rem; }
      .chip .desc { font-size: 0.8rem; }
      .chip.selected::before { border-radius: 15px; }
    }

    @media (min-width: 1024px) {
      .chip {
        padding: 16px 20px;
        min-height: 68px;
        border-radius: 16px;
      }
      .chip .emo { font-size: 24px; }
      .chip .name { font-size: 1.05rem; }
      .chip .desc { font-size: 0.85rem; }
    }

    /* üéØ GOLD STANDARD: Touch optimizations for mobile */
    @media (hover: none) and (pointer: coarse) {
      .chip:hover {
        transform: none;
      }
      
      .chip:active {
        transform: translateY(2px) scale(0.98);
        box-shadow:
          0 2px 8px rgba(255, 209, 102, 0.3),
          inset 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      
      /* Larger touch targets on mobile */
      .chip {
        min-height: 80px;
        padding: 16px 20px;
      }
      
      .chip .emo {
        font-size: 28px;
      }
    }

    /* Hi Energy accessibility */
    .chip:focus-visible {
      outline: 2px solid #FFD166;
      outline-offset: 2px;
    }

    /* Loading state with Hi colors */
    .chip.loading {
      opacity: 0.7;
      cursor: wait;
      pointer-events: none;
    }

    .chip.loading .emo::after {
      content: '';
      position: absolute;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(255, 209, 102, 0.3);
      border-top: 2px solid #FFD166;
      border-radius: 50%;
      animation: hiEnergySpinner 1s linear infinite;
    }

    @keyframes hiEnergySpinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* üåü HI ENERGY EMOTIONAL JOURNEY BADGES */
    .badges{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      margin:16px 0;
      padding:12px 0;
    }
    
    .hi-chip {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 16px;
      border-radius:20px;
      font-weight:700;
      font-size:0.85rem;
      letter-spacing:-0.01em;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter:blur(10px);
      box-shadow:0 2px 8px rgba(255, 209, 102, 0.2);
      border:1px solid rgba(255, 209, 102, 0.3);
      max-width:160px;
    }
    
    #badge-current {
      background:linear-gradient(135deg, 
        rgba(255, 209, 102, 0.2) 0%, 
        rgba(15, 16, 36, 0.9) 100%);
      color:#FFD166;
      border-color:rgba(255, 209, 102, 0.4);
    }
    
    #badge-desired {
      background:linear-gradient(135deg, 
        rgba(78, 205, 196, 0.2) 0%, 
        rgba(15, 16, 36, 0.9) 100%);
      color:#4ECDC4;
      border-color:rgba(78, 205, 196, 0.4);
    }
    
    .hi-chip:hover {
      transform:translateY(-1px) scale(1.02);
      box-shadow:0 4px 16px rgba(255, 209, 102, 0.3);
    }
    
    /* Hi Energy journey arrow animation */
    .badges::after {
      content:'‚Üí';
      font-size:1.2rem;
      font-weight:900;
      color:#FFD166;
      opacity:0;
      transform:translateX(-8px);
      transition:all 0.3s ease;
      position:absolute;
      margin-left:-6px;
    }
    
    .badges.show-arrow::after {
      opacity:1;
      transform:translateX(0);
    }
    
    .pickTitle{
      font-weight:800;
      color:#FFD166;
      margin:20px 0 10px;
      font-size:1.1rem;
      text-align:center;
      letter-spacing:-0.01em;
    }

    /* Mobile-first action buttons */
    .actions{display:flex;gap:12px;justify-content:center;margin:24px 0;flex-wrap:wrap}
    .actions .hi-btn {
      min-height: 48px;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 700;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      min-width: 120px;
    }
    
    .actions .hi-btn--primary {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
    
    .actions .hi-btn--primary:hover {
      background: #059669;
      border-color: #059669;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
    }
    
    .actions .hi-btn--primary:disabled {
      background: #6b7280;
      border-color: #6b7280;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .actions .hi-btn--ghost {
      background: transparent;
      color: #e8ebff;
      border-color: #2f335e;
    }
    
    .actions .hi-btn--ghost:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #4f46e5;
      transform: translateY(-1px);
    }

    @media (min-width: 768px) {
      .actions .hi-btn {
        min-height: 52px;
        padding: 14px 24px;
        font-size: 1.1rem;
        min-width: 140px;
      }
    }

    textarea{width:100%;border:2px solid var(--hi-border);border-radius:16px;min-height:140px;padding:16px;font:inherit;background:#fff;color:#111;font-size:16px;line-height:1.5;resize:vertical}
    .hi-hint{color:#cfd2ea;font-size:0.9rem}

    /* sheet - mobile-first with desktop scaling */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:50}
    .sheet{
      /* Tesla-grade viewport centering - unified with index.html */
      position:fixed;
      top:50%;left:50%;
      transform:translate(-50%, -50%);
      width:min(500px, 90vw);
      background:#0f1024;
      border-radius:18px;border:1px solid #23264d;
      padding:24px 20px 32px;z-index:60;
      box-shadow:0 -10px 30px rgba(0,0,0,.35);color:#e8ebff;
      max-height:85vh;overflow-y:auto;
      min-height:300px;
      opacity:0;visibility:hidden;
      transition:all .3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    /* Desktop optimizations */
    @media (min-width: 768px) {
      .sheet {
        width:500px;max-width:90vw;
        padding:32px 28px 40px;
        min-height:350px;
      }
    }
    
    /* Tesla-grade show/hide animations for viewport-centered modal */
    .sheet.show {
      opacity:1;
      visibility:visible;
      animation:modalFadeIn .25s ease-out forwards;
    }
    .sheet.hide {
      animation:modalFadeOut .2s ease-in forwards;
    }
    
    @keyframes modalFadeIn{from{opacity:0;transform:translate(-50%, -50%) scale(0.95)}to{opacity:1;transform:translate(-50%, -50%) scale(1)}}
    @keyframes modalFadeOut{from{opacity:1;transform:translate(-50%, -50%) scale(1)}to{opacity:0;transform:translate(-50%, -50%) scale(0.95)}}
    
    /* üéØ WOZ-GRADE: Journal card attention pulse animation */
    @keyframes journalCardPulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      50% { transform: scale(1.02); box-shadow: 0 0 20px 10px rgba(16, 185, 129, 0.3); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }
    
    .sheet.show + .sheet-backdrop{display:block}
    
    /* Tesla-grade mobile optimizations */
    @media (max-width: 540px) {
      .sheet {
        width:90vw;
        max-width:400px;
        padding:20px 16px 24px;
        min-height:300px;
        max-height:80vh;
      }
    }
    
    @media (max-width: 380px) {
      .sheet {
        width:95vw;
        padding:16px 12px 20px;
        max-height:85vh;
      }
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 0;flex-wrap:wrap;min-height:60px}
    
    /* Mobile-first button styling */
    .sheet .hi-btn {
      min-height:52px;
      padding:14px 20px;
      font-weight:700;
      border-radius:12px;
      font-size:16px;
      cursor:pointer;
      transition:all 0.2s ease;
      border:2px solid transparent;
      flex:1;
      max-width:160px;
    }
    
    .sheet .hi-btn--ghost {
      background:transparent;
      color:#e8ebff;
      border-color:#4f46e5;
    }
    
    .sheet .hi-btn--ghost:hover {
      background:rgba(79,70,229,0.1);
      border-color:#6366f1;
      transform:translateY(-1px);
    }
    
    .sheet .hi-btn--primary {
      background:#10b981;
      color:white;
      border-color:#10b981;
      box-shadow:0 4px 12px rgba(16,185,129,0.3);
    }
    
    .sheet .hi-btn--primary:hover {
      background:#059669;
      border-color:#059669;
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(16,185,129,0.4);
    }
    
    .sheet .hi-btn--primary:disabled {
      background:#6b7280;
      border-color:#6b7280;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }
    
    /* Desktop button enhancements */
    @media (min-width: 768px) {
      .sheet .hi-btn {
        min-height:56px;
        padding:16px 24px;
        font-size:17px;
        max-width:180px;
      }
      
      .row {
        padding:20px 0;
        gap:16px;
      }
    }
    .switch{position:relative;width:54px;height:32px;background:#2f335e;border-radius:999px;cursor:pointer;border:1px solid #23264d;transition:all 0.2s ease}
    .knob{position:absolute;top:3px;left:3px;width:24px;height:24px;border-radius:50%;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.2);transition:left .2s ease}
    .switch.on{background:#0a8a3a;border-color:#0a8a3a}
    .switch.on .knob{left:27px}
    .sheet h3{margin:8px 0 6px;font-size:20px;font-weight:700;line-height:1.3}
    .sheet .muted{font-size:15px;color:#cfd2ea;line-height:1.4;margin-bottom:4px}
    .hr{height:1px;background:#23264d;margin:16px 0}
    .field{display:flex;gap:12px;align-items:center;border:2px solid var(--hi-border);border-radius:14px;padding:14px;background:#fff;color:#111;margin-top:8px}
    .field input{border:0;outline:0;width:100%;font:inherit;font-size:16px}

    /* Desktop switch and field improvements */
    @media (min-width: 768px) {
      .switch{width:58px;height:34px}
      .knob{width:26px;height:26px}
      .switch.on .knob{left:29px}
      .sheet h3{font-size:22px;margin:12px 0 8px}
      .sheet .muted{font-size:16px}
      .field{padding:16px;font-size:17px}
      .field input{font-size:17px}
    }

    /* Enhanced celebratory toast */
    .toast{
      position:fixed;left:50%;bottom:30px;transform:translateX(-50%);
      background:linear-gradient(135deg, #10b981 0%, #059669 100%);
      color:#fff;padding:16px 24px;border-radius:16px;
      opacity:0;pointer-events:none;z-index:1000;
      font-weight:700;font-size:1rem;
      box-shadow:0 10px 30px rgba(16, 185, 129, 0.4);
      border:1px solid rgba(255,255,255,0.2);
      backdrop-filter:blur(10px);
      max-width:90vw;text-align:center;
    }
    .toast.show{
      opacity:1;
      animation:toastIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .toast.hide{
      animation:toastOut 0.3s ease-in-out forwards;
    }
    @keyframes toastIn{
      0%{opacity:0;transform:translateX(-50%) translateY(20px) scale(0.9)}
      100%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}
    }
    @keyframes toastOut{
      0%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}
      100%{opacity:0;transform:translateX(-50%) translateY(-20px) scale(0.95)}
    }
    
    /* Tesla-Grade Header - Dashboard Standard */
    .tesla-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
    }

    .header-left {
      display: flex;
      align-items: center;
      width: 60px;
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      width: 140px;
      gap: 8px;
    }
    
    .tier-indicator {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 11px;
      font-weight: 600;
      color: var(--hi-tier-color, #6B7280);
      transition: all 0.3s ease;
      cursor: default;
      min-width: 60px;
      text-align: center;
    }
    
    .tier-indicator:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }
    
    .tier-text {
      white-space: nowrap;
    }
    
    .hiffirmations-header-pill {
      display: flex;
      align-items: center;
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 11px;
      font-weight: 600;
      color: #6B7280;
      transition: all 0.3s ease;
      cursor: pointer;
      min-width: 90px;
      text-align: center;
      margin-left: 8px;
    }
    
    .hiffirmations-header-pill:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }

    .brand-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-hi-logo {
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .brand-text {
      font-size: 18px;
      font-weight: 600;
      color: #FFD166;
      letter-spacing: -0.5px;
    }

    .calendar-btn, .menu-btn, .home-nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: #FFD166;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .calendar-btn:hover, .menu-btn:hover, .home-nav-btn:hover {
      background: rgba(255, 209, 102, 0.2);
      transform: translateY(-1px);
    }

    /* Navigation Modal */
    .navigation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .navigation-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .navigation-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(400px, 90vw);
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 24px;
      padding: 24px;
      color: white;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .navigation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .navigation-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #FFD166;
    }

    .close-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-nav-btn:hover {
      background: rgba(255, 0, 0, 0.2);
    }

    .navigation-menu {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .nav-section-title {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      text-decoration: none;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .nav-item.admin-item {
      background: rgba(255, 215, 0, 0.1);
      border-color: rgba(255, 215, 0, 0.2);
    }

    .nav-item.admin-item:hover {
      background: rgba(255, 215, 0, 0.2);
    }

    .nav-icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    /* Account for fixed header */
    body[data-page="hi-muscle"] {
      padding-top: 60px;
    }

    /* Floating Refresh Button */
    .floating-refresh {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #FFD166 0%, #F4A261 100%);
      border: none;
      border-radius: 50%;
      color: #1E2A4A;
      font-size: 20px;
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(255, 209, 102, 0.3);
    }

    .floating-refresh:hover {
      transform: translateY(-2px) rotate(90deg);
      box-shadow: 0 6px 20px rgba(255, 209, 102, 0.4);
    }

    .floating-refresh:active {
      transform: translateY(0) rotate(180deg);
    }

    /* Floating Hiffirmations System */
    .floating-hiffirmations {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #E91E63 0%, #9C27B0 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      z-index: 999;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(233, 30, 99, 0.3);
      animation: gentlePulse 4s infinite;
    }

    .floating-hiffirmations:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 20px rgba(233, 30, 99, 0.4);
      animation-play-state: paused;
    }

    .floating-hiffirmations:active {
      transform: translateY(0) scale(0.95);
    }

    @keyframes gentlePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    /* Hiffirmation Popup */
    .hiffirmation-popup {
      position: fixed;
      bottom: 85px;
      left: 20px;
      max-width: 280px;
      background: rgba(26, 32, 56, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 16px 20px;
      color: white;
      font-size: 14px;
      line-height: 1.4;
      transform: translateY(20px) scale(0.9);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 1000;
      pointer-events: none;
    }

    .hiffirmation-popup.show {
      transform: translateY(0) scale(1);
      opacity: 1;
      pointer-events: auto;
    }

    .hiffirmation-popup::before {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 28px;
      width: 16px;
      height: 16px;
      background: rgba(26, 32, 56, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-top: none;
      border-left: none;
      transform: rotate(45deg);
      border-radius: 0 0 4px 0;
    }
  </style>
  
  <!-- Tier Loading Skeleton CSS -->
  <link rel="stylesheet" href="./assets/tier-loading-skeleton.css">
</head>
<body data-tab="muscle" data-page="hi-muscle">
  <!-- üé¨ STATIC SPLASH: First element rendered -->
  <div class="hi-splash-instant" id="instant-splash">
    <img src="assets/brand/hi-logo-dark.png" alt="Hi" class="hi-splash-logo" />
  </div>
  
  <!-- Tesla-Grade Dashboard Header -->
  <header class="tesla-header">
    <div class="header-left">
      <button class="calendar-btn" onclick="showCalendar()">
        üìÖ
      </button>
      
      <button class="home-nav-btn" onclick="navigateToHome()" aria-label="Go to Hi Today" title="Navigate to Hi Today">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9,22 9,12 15,12 15,22"/>
        </svg>
      </button>
    </div>
    
    <div class="header-center">
      <div class="brand-container">
        <img src="./assets/brand/hi-logo-light.png" alt="Hi" class="brand-hi-logo">
        <span class="brand-text">Hi Muscle</span>
      </div>
    </div>
    
    <div class="header-right">
      <div id="hi-tier-indicator" class="tier-indicator" title="Loading tier..." data-auth-loading="true">
        <span class="tier-text tier-loading">‚è≥</span>
      </div>
      <button class="menu-btn" onclick="openNavigation()">
        <span style="font-size: 18px;">‚ò∞</span>
      </button>
    </div>
  </header>

  <!-- Navigation Modal -->
  <div id="navigationModal" class="navigation-modal">
    <div class="navigation-backdrop" onclick="closeNavigation()"></div>
    <div class="navigation-content">
      <div class="navigation-header">
        <h3>Hi Navigation</h3>
        <button class="close-nav-btn" onclick="closeNavigation()">‚úï</button>
      </div>
      
      <nav class="navigation-menu">
        <div>
          <div class="nav-section-title">Core</div>
          <a href="/public/hi-dashboard.html" class="nav-item">
            <span class="nav-icon">üè†</span>
            Dashboard
          </a>
          <a href="/public/profile.html" class="nav-item">
            <span class="nav-icon">üë§</span>
            Profile
          </a>
          <a href="/public/hi-island-NEW.html" class="nav-item">
            <span class="nav-icon">üèùÔ∏è</span>
            Hi Island
          </a>
          <a href="/public/hi-muscle.html" class="nav-item" style="background: rgba(255, 209, 102, 0.2); border-color: rgba(255, 209, 102, 0.3);">
            <span class="nav-icon">üí™</span>
            Hi Muscle
          </a>
        </div>
        
        <div>
          <div class="nav-section-title">Tools</div>
          <a href="#" onclick="showCalendar(); closeNavigation(); return false;" class="nav-item">
            <span class="nav-icon">üìÖ</span>
            Calendar
          </a>
          <a href="/public/hi-stats.html" class="nav-item">
            <span class="nav-icon">üìä</span>
            Hi Stats
          </a>
        </div>
        
        <div>
          <div class="nav-section-title">Admin</div>
          <a href="hi-mission-control.html" class="nav-item admin-item" data-mc-link>
            <span class="nav-icon">üéõÔ∏è</span>
            <span>Hi Mission Control</span>
          </a>
        </div>
      </nav>
    </div>
  </div>
  <script>
    (function(){
      function resolveMC(){ try { return window.hiPaths?.resolve ? window.hiPaths.resolve('hi-mission-control.html') : 'hi-mission-control.html'; } catch { return 'hi-mission-control.html'; } }
      function attach(){
        document.querySelectorAll('[data-mc-link]').forEach(a=>{
          const href = resolveMC(); a.setAttribute('href', href);
          if (!a.__mcBound){
            a.__mcBound = true;
            a.addEventListener('click', function(e){
              if (window.HiMissionControlAccess){ e.preventDefault(); window.HiMissionControlAccess.openGate(); }
            });
          }
        });
      }
      attach();
      window.addEventListener('hi:admin-confirmed', attach);
    })();
  </script>

  <div class="wrap">
    <h1 class="title">Hi Gym</h1>
    <p class="subtitle">Your guided emotional fitness journey in 3 thoughtful steps</p>

    <!-- Enhanced guidance with step-by-step thinking -->
    <div class="guidance-card" id="guidanceCard">
      <div class="guidance-title">üß† Welcome to Your Emotional Journey</div>
      <div class="guidance-steps">
        <strong>Step 1: Where Are You Now?</strong><br>
        Take a moment to honestly check in with yourself. What emotion best describes how you're feeling right now? Don't judge it‚Äîjust notice it.<br><br>
        
        <strong>Step 2: Where Do You Want to Be?</strong><br>
        Think about what emotional state would serve you best today. What feeling would help you handle what's ahead?<br><br>
        
        <strong>Step 3: Bridge the Gap</strong><br>
        Reflect on why this shift matters to you right now. What will be different when you embody this new emotional state?
      </div>
    </div>

    <!-- Step-specific guidance -->
    <div class="step-guidance" id="stepGuidance" style="display:none;">
      <div id="step1Guide" class="step-guide" style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:12px;padding:16px;margin:0 0 16px;text-align:center;">
        <strong style="color:#10b981;">Step 1: How are you feeling right now?</strong><br>
        <span style="color:#e8ebff;font-size:0.9rem;">Be honest with yourself. There's no wrong answer‚Äîjust awareness.</span>
      </div>
      <div id="step2Guide" class="step-guide" style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:12px;padding:16px;margin:0 0 16px;text-align:center;display:none;">
        <strong style="color:#10b981;">Step 2: Where do you want to be emotionally?</strong><br>
        <span style="color:#e8ebff;font-size:0.9rem;">Choose an emotion that would better serve you in this moment.</span>
      </div>
      <div id="step3Guide" class="step-guide" style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:12px;padding:16px;margin:0 0 16px;text-align:center;display:none;">
        <strong style="color:#10b981;">Step 3: Why does this shift matter to you?</strong><br>
        <span style="color:#e8ebff;font-size:0.9rem;">Write 1-2 honest lines about why moving to <span id="desiredEmotionHint">this feeling</span> would help you today.</span>
      </div>
    </div>

    <div class="stepper" aria-label="Progress">
      <div class="dot" id="s1"></div><div class="pipe" id="p1"></div><div class="dot" id="s2"></div><div class="pipe" id="p2"></div><div class="dot" id="s3"></div>
    </div>

    <div class="badges">
      <span class="hi-chip" id="badge-current" style="display:none"></span>
      <span class="hi-chip" id="badge-desired" style="display:none"></span>
    </div>

    <div class="tabs" role="tablist" aria-label="Emotion categories">
      <button class="tab" role="tab" aria-selected="true"  data-cat="hi">Hi Energy</button>
      <button class="tab" role="tab" aria-selected="false" data-cat="neutral">Neutral</button>
      <button class="tab" role="tab" aria-selected="false" data-cat="opportunity">Hi Opportunity</button>
    </div>

    <div class="search">
      <span>üîé</span><input id="search" placeholder="Search emotions (e.g., calm, joy, worry)"/>
      <button id="toggleView" class="hi-btn hi-btn--ghost" style="padding:8px 12px">Compact</button>
    </div>

    <!-- üåü INLINE SELECTION BADGES: Immediate visual feedback -->
    <div id="inlineSelectionBadges" style="display:none;background:rgba(78,205,196,0.1);border:1px solid rgba(78,205,196,0.3);border-radius:12px;padding:12px 16px;margin:0 0 16px;text-align:center;animation:slideInFromTop 0.4s cubic-bezier(0.4,0,0.2,1);">
      <div id="inlineCurrentBadge" style="display:none;margin-bottom:8px;">
        <span style="color:#10b981;font-weight:600;">‚úÖ You feel:</span>
        <span id="inlineCurrentLabel" style="color:#e8ebff;font-weight:500;margin-left:6px;"></span>
      </div>
      <div id="inlineDesiredBadge" style="display:none;">
        <span style="color:#10b981;font-weight:600;">üéØ Moving to:</span>
        <span id="inlineDesiredLabel" style="color:#e8ebff;font-weight:500;margin-left:6px;"></span>
      </div>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>

    <div id="journalCard" class="hi-card" style="display:none;margin-top:14px">
      <div class="pickTitle">Hi Thought</div>
      <p class="hi-hint" style="margin:.25rem 0 .6rem">
        In <b>1‚Äì2 honest lines</b>, tell your future self why shifting to
        <span id="desiredLabel">this vibe</span> matters <i>today</i>.
      </p>
      <textarea id="journal" maxlength="600" placeholder="e.g., Choosing calm helps me be present with my family tonight, even if the day was loud."></textarea>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
        <span class="hi-hint" id="count">0/600</span>
        <label class="hi-hint"><input type="checkbox" id="anon" /> Post as Anonymous</label>
      </div>
    </div>

    <div class="actions">
      <button id="back" class="hi-btn hi-btn--ghost">Back</button>
      <button id="next" class="hi-btn hi-btn--primary">Continue</button>
    </div>

    <div style="display:flex;gap:12px;justify-content:center;margin-top:16px;flex-wrap:wrap">
      <a class="hi-btn hi-btn--ghost" href="hi-island-NEW.html" style="min-height:48px;padding:12px 16px;display:flex;align-items:center">Go to Hi Island</a>
      <a class="hi-btn hi-btn--ghost" href="index.html" style="min-height:48px;padding:12px 16px;display:flex;align-items:center">Back to Home</a>
    </div>
  </div>

  <!-- Share Sheet -->
      <!-- Share Sheet with streamlined location -->
    <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" aria-hidden="true">
      <h3 id="sheetTitle">How do you want to share your journey?</h3>
      <p class="muted">We'll always save a private copy in <b>My Archive</b>.</p>

      <div class="row" style="margin-top:6px">
        <div>
          <div style="font-weight:800">Show on Hi Island</div>
          <div class="muted">Appear in the global General Shares feed</div>
        </div>
        <div id="togglePublic" class="switch on" role="switch" aria-checked="true" tabindex="0"><div class="knob" aria-hidden="true"></div></div>
      </div>

      <div class="row">
        <div>
          <div style="font-weight:800">Post as Anonymous</div>
          <div class="muted">Your name becomes "Hi Friend"</div>
        </div>
        <div id="toggleAnon" class="switch" role="switch" aria-checked="false" tabindex="0"><div class="knob" aria-hidden="true"></div></div>
      </div>

      <div class="hr"></div>
      
      <!-- Profile-first location architecture -->
      <div style="margin-bottom:12px;">
        <div style="font-weight:700;margin-bottom:4px;color:#e8ebff;">üìç Location (Optional)</div>
        <div class="muted" style="margin-bottom:8px;">
          <span id="locationEducation">Add your city and state to connect with others nearby. We never store your exact location.</span>
        </div>
        <div class="field" aria-label="Optional location">
          <span>üìç</span><input id="locationInput" placeholder="e.g., Austin, TX or London, UK"/>
        </div>
        
        <!-- Enhanced profile-first traveling option -->
        <div id="travelingContainer" style="display:none;margin-top:8px;">
          <label class="switch-label" style="font-size:14px;color:#a6adc8;display:flex;align-items:center;gap:8px;">
            <div class="switch">
              <input type="checkbox" id="travelingToggle">
              <span class="slider"></span>
            </div>
            ‚úàÔ∏è I'm traveling (share from home location)
          </label>
        </div>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:24px;padding-top:20px;border-top:1px solid #23264d">
        <button id="cancelShare" class="hi-btn hi-btn--ghost">Cancel</button>
        <button id="confirmShare" class="hi-btn hi-btn--primary">Share Journey</button>
      </div>
    </div>
  <div id="backdrop" class="sheet-backdrop" aria-hidden="true"></div>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved</div>

  <!-- ‚úÖ FIX: Remove duplicate HiSupabase load - already loaded in <head> at line 90 -->
  <!-- HiSupabase.js loaded earlier ensures client exists before page renders -->
  <script src="assets/auth.js"></script>
  <script src="./lib/HiDB.js"></script>
  
  <!-- üöÄ INTEGRATION #1A: HiBase + HiFlags for HiGYM shares (flagged rollout) -->
  <script src="./lib/flags/HiFlags.js" type="module"></script>
  <script src="./lib/hibase/index.js" type="module"></script>
  <script src="assets/geocoding-service.js"></script>
  <!-- Header: Using Tesla-Grade Dashboard Header (no HiHeader.js needed) -->
  <script src="assets/emotions.js"></script>
  <script src="assets/hi-gym.js"></script>

  <script>
  (async function(){
    console.log('üí™ Hi-Muscle loading...');
    
    // üöÄ SURGICAL FIX: Wait for critical dependencies before rendering
    if (window.DependencyManager) {
      console.log('‚è≥ Waiting for Hi Muscle dependencies...');
      const result = await window.DependencyManager.waitForDependencies([
        'auth',
        'hiDB',
        'HiSupabase',
        'HiBrandTiers'
      ], 8000); // 8 second timeout
      
      if (!result.success) {
        console.error('‚ùå Dependencies failed:', result.missing);
        const wrap = document.querySelector('.wrap');
        if (wrap) {
          wrap.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; max-width: 400px; margin: 0 auto;">
              <div style="font-size: 3rem; margin-bottom: 20px;">üîÑ</div>
              <div style="font-weight: 700; font-size: 1.2rem; margin-bottom: 12px; color: #FFD166;">Loading Issue</div>
              <div style="font-size: 0.95rem; margin-bottom: 24px; color: #cfd2ea; line-height: 1.5;">
                Some components didn't load properly. This usually fixes itself on refresh.
              </div>
              <button onclick="location.reload()" style="padding: 14px 28px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transition: transform 0.2s;">
                Reload Page
              </button>
            </div>
          `;
        }
        return; // Stop initialization
      }
      console.log('‚úÖ All dependencies ready in ' + result.loaded.length + ' checks');
    }
    
    try { await hiAuth.ensureSessionMaybe?.(); } catch {}

    // üéØ Initialize global stats variables (required for Total His tracking)
    if (window.gTotalHis === undefined) window.gTotalHis = 0;
    if (window.gWaves === undefined) window.gWaves = 0; 
    if (window.gUsers === undefined) window.gUsers = 0;
    console.log('‚úÖ Global stats initialized:', { gTotalHis: window.gTotalHis, gWaves: window.gWaves, gUsers: window.gUsers });

    // ---------- Wait for emotions.js to load ----------
    await waitForEmotions();
    
    async function waitForEmotions() {
      let attempts = 0;
      while (!window.HI_EMOTIONS && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      if (!window.HI_EMOTIONS) {
        console.warn('‚ö†Ô∏è emotions.js failed to load, using fallback data');
      } else {
        console.log('‚úÖ HI_EMOTIONS loaded:', window.HI_EMOTIONS);
      }
    }

    // ---------- Emotion data adapter ----------
    function getEmotionCatalog(){
      // Accept any of these shapes:
      // 1) window.HI_EMOTIONS = { categories:[{id,items:[{name,emoji,desc}]}] }
      // 2) window.emotions or window.EMOTIONS = { hi:[], neutral:[], opportunity:[] } OR array of {name,emoji,desc,cat}
      const H = (window.HI_EMOTIONS && window.HI_EMOTIONS.categories) ? window.HI_EMOTIONS
            : null;

      if (H) return H; // already in the right shape

      const raw = window.emotions || window.EMOTIONS || {};
      const byId = { hi:[], neutral:[], opportunity:[] };

      if (Array.isArray(raw)) {
        raw.forEach(x=>{
          const cat = (x.cat||'hi').toLowerCase();
          (byId[cat] || byId.hi).push({ name:x.name, emoji:x.emoji||'‚ú®', desc:x.desc||'' });
        });
      } else {
        ['hi','neutral','opportunity'].forEach(id=>{
          const list = raw[id] || [];
          byId[id] = list.map(x => ({ name:x.name, emoji:x.emoji||'‚ú®', desc:x.desc||'' }));
        });
      }

      return {
        categories: [
          { id:'hi',          items: byId.hi },
          { id:'neutral',     items: byId.neutral },
          { id:'opportunity', items: byId.opportunity }
        ]
      };
    }

    const CATALOG = getEmotionCatalog();

    const state = { step:1, current:null, desired:null, cat:'hi', q:'' };

    // Els
    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const toggleView = document.getElementById('toggleView');
    const nextBtn = document.getElementById('next');
    const backBtn = document.getElementById('back');
    const badgeCur = document.getElementById('badge-current');
    const badgeDes = document.getElementById('badge-desired');
    const journalCard = document.getElementById('journalCard');
    const journal = document.getElementById('journal');
    const count = document.getElementById('count');
    const desiredLabel = document.getElementById('desiredLabel');
    const s1 = document.getElementById('s1'), s2 = document.getElementById('s2'), s3 = document.getElementById('s3');
    const p1 = document.getElementById('p1'), p2 = document.getElementById('p2');
    const toastEl = document.getElementById('toast');

    // Sheet bits
    const sheet = document.getElementById('sheet');
    const backdrop = document.getElementById('backdrop');
    const togglePublic = document.getElementById('togglePublic');
    const toggleAnon = document.getElementById('toggleAnon');
    const locationInput = document.getElementById('locationInput');
    const cancelShare = document.getElementById('cancelShare');
    const confirmShare = document.getElementById('confirmShare');

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.setAttribute('aria-selected','false'));
        t.setAttribute('aria-selected','true');
        state.cat = t.dataset.cat;
        renderGrid();
      });
    });

    // Search / compact
    search.addEventListener('input', ()=>{ state.q = search.value.trim(); renderGrid(); });
    toggleView.addEventListener('click', ()=>{
      const descs = document.querySelectorAll('.desc');
      const compact = toggleView.textContent === 'Compact';
      toggleView.textContent = compact ? 'Comfort' : 'Compact';
      descs.forEach(d => d.style.display = compact ? 'none' : '');
    });

    // Nav with enhanced validation
    backBtn.addEventListener('click', ()=>{
      if (state.step === 1) { window.location.href='index.html'; return; }
      if (state.step === 2) { setStep(1); return; }
      if (state.step === 3) { setStep(2); return; }
    });
    
    nextBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      console.log('Next button clicked, step:', state.step, 'current:', state.current, 'desired:', state.desired);
      
      if (state.step === 1) {
        if (!state.current) {
          toast('Please choose how you feel right now');
          return;
        }
        setStep(2);
        return;
      }
      
      if (state.step === 2) {
        if (!state.desired) {
          toast('Please choose where you want to be emotionally');
          return;
        }
        setStep(3);
        return;
      }
      
      if (state.step === 3) {
        const journalText = journal.value.trim();
        console.log('Journal text length:', journalText.length);
        if (journalText.length < 10) {
          toast('Please write at least 10 characters in your reflection');
          journal.focus();
          return;
        }
        console.log('Opening unified share sheet for Hi Muscle...');
        try {
          // üåü TESLA-GRADE: Use unified share sheet with Hi Muscle journal data
          const journalText = journal.value.trim();
          
          console.log('üí™ [Hi-Muscle] Share button clicked!');
          // Pre-populate the share sheet with the Hi Muscle reflection
          if (window.openHiShareSheet) {
            console.log('‚úÖ Opening Hi-Muscle share sheet with data:', { journalText, currentEmoji: state.current?.emoji, desiredEmoji: state.desired?.emoji });
            window.openHiShareSheet('higym', { 
              prefilledText: journalText,
              currentEmoji: state.current?.emoji,
              desiredEmoji: state.desired?.emoji 
            });
          } else {
            console.error('‚ùå CRITICAL: Unified share sheet failed to initialize. Check console for module loading errors.');
            console.log('üîç Available globals:', Object.keys(window).filter(k => k.includes('Hi')));
            toast('Share system unavailable. Please refresh the page.', 'warning');
          }
        } catch (error) {
          console.error('Error opening share sheet:', error);
          toast('Something went wrong. Please try again.', 'warning');
        }
        return;
      }
    });

    // Switch helpers
    function setSwitch(el,on){ el.classList.toggle('on', !!on); el.setAttribute('aria-checked', on?'true':'false'); }
    function getSwitch(el){ return el.classList.contains('on'); }
    [togglePublic,toggleAnon].forEach(sw=>{
      sw.addEventListener('click', ()=> setSwitch(sw, !getSwitch(sw)));
      sw.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); setSwitch(sw, !getSwitch(sw)); }});
    });
    backdrop.addEventListener('click', closeSheet);
    cancelShare.addEventListener('click', closeSheet);
    
    function openSheet(){ 
      console.log('openSheet called, sheet element:', sheet, 'backdrop element:', backdrop);
      if (!sheet || !backdrop) {
        console.error('Sheet or backdrop element not found!');
        return;
      }
      sheet.classList.remove('hide'); 
      sheet.classList.add('show'); 
      sheet.setAttribute('aria-hidden','false'); 
      backdrop.style.display='block';
      console.log('Sheet opened, classes:', sheet.classList.toString());
    }
    
    function closeSheet(){ 
      console.log('closeSheet called');
      sheet.classList.remove('show'); 
      sheet.classList.add('hide'); 
      sheet.setAttribute('aria-hidden','true'); 
      setTimeout(()=>backdrop.style.display='none',180); 
    }

    // Writes
    confirmShare.addEventListener('click', async (e)=>{
      e.preventDefault();
      console.log('Share Journey button clicked');
      
      // üöÄ TESLA-GRADE: Check authentication FIRST for proper UX
      let isAuthenticated = false;
      let userId = null;
      
      try {
        // Ensure HiSupabase is available before attempting auth check
        if (window.HiSupabase && window.HiSupabase.getClient) {
          const { data: { user } } = await window.HiSupabase.getClient().auth.getUser();
          isAuthenticated = !!user;
          userId = user?.id;
        } else {
          console.log('HiSupabase not initialized, user is anonymous');
          isAuthenticated = false;
        }
      } catch (error) {
        console.log('Authentication check failed, user is anonymous:', error.message);
        isAuthenticated = false;
      }
      
      if (!isAuthenticated) {
        // Anonymous user - show upgrade prompt
        confirmShare.disabled = false;
        confirmShare.textContent = 'Share Journey';
        
        const shouldUpgrade = confirm(`üåü Your emotional journey looks amazing!\n\nJoin Hi to:\n‚Ä¢ Save your journey forever\n‚Ä¢ Share with the community\n‚Ä¢ Track your emotional growth\n‚Ä¢ Get personalized insights\n\nWould you like to sign up or log in?`);
        
        if (shouldUpgrade) {
          window.location.href = '/signin.html?redirect=' + encodeURIComponent(window.location.pathname + '?journey=completed');
        }
        return;
      }
      
      // Authenticated user - proceed with sharing
      confirmShare.disabled = true;
      confirmShare.textContent = 'Sharing...';
      
      try {
        const text = journal.value.trim();
        const isAnon = getSwitch(toggleAnon);
        const loc = (locationInput.value||'').trim();

        console.log('Submitting Hi Gym journey:', { 
          current: state.current?.name, 
          desired: state.desired?.name, 
          textLength: text.length,
          isAnon,
          toIsland: true,  // Always share to island
          location: loc
        });

        // üåü TESLA-GRADE: Increment global Hi counter (same as unified share sheet)
        const LS_TOTAL = 'hi_total_count';
        const LS_GLOBAL = 'hi_global_shares';
        
        let total = parseInt(localStorage.getItem(LS_TOTAL) || '0', 10);
        let gStarts = parseInt(localStorage.getItem(LS_GLOBAL) || '0', 10);
        
        total += 1;
        gStarts += 1;
        
        localStorage.setItem(LS_TOTAL, String(total));
        localStorage.setItem(LS_GLOBAL, String(gStarts));
        
        console.log('üìä Global Hi counter incremented (hiGYM):', { total, gStarts });

        // Tesla-grade journey analytics
        const sessionData = {
          current: state.current,
          desired: state.desired,
          journal: text,
          duration: Date.now() - (state.startTime || Date.now()),
          timestamp: Date.now()
        };

        // Track emotional pattern
        const pattern = window.HiGym?.trackEmotionalPattern(sessionData);
        
        // Create celebration message
        const celebration = window.HiGym?.createJourneyCelebration(sessionData);

        // üöÄ INTEGRATION #1A: HiGYM shares via HiBase (flagged rollout)
        const useHiBase = await window.HiFlags?.getFlag('hibase_shares_enabled');
        console.log(`üîÑ HiGYM submission via ${useHiBase ? 'HiBase' : 'legacy'} path`);

        if (useHiBase) {
          // üéØ HiBase path: unified API with structured payload
          console.log('üì¶ HiGYM ‚Üí HiBase.insertShare...');
          
          // Format content with emotional journey: emoji ‚Üí emoji + journal
          const formattedContent = `${state.current.emoji} ‚Üí ${state.desired.emoji} ${text}`;
          
          const shareResult = await window.HiBase.insertShare({
            type: 'HiGYM',
            text: formattedContent, // Include emojis in content
            visibility: isAnon ? 'anonymous' : 'public',
            user_id: userId, // Already retrieved above
            emotion_from: state.current?.name,
            emotion_to: state.desired?.name,
            location: loc || null,
            metadata: {
              currentEmoji: state.current.emoji,
              desiredEmoji: state.desired.emoji,
              journeyType: pattern?.journeyType || 'exploration',
              tags: ['emotional-journey', 'higym'],
              origin: 'higym',
              type: 'higym'
            },
            origin: 'higym' // Also pass at top level for HiDB
          });

          if (shareResult.error) {
            throw new Error(`HiBase insertion failed: ${shareResult.error.message}`);
          }

          // üìä Track HiBase usage
          import('./lib/monitoring/HiMonitor.js').then(m => 
            m.trackEvent('hibase_share_success', { 
              source: 'higym', 
              path: 'hibase'
            })
          ).catch(() => {});

          // üöÄ INTEGRATION #5: HiGYM streak tracking via HiBase (flagged rollout)
          const useHiBaseStreaks = await window.HiFlags?.getFlag('hibase_streaks_enabled');
          console.log(`üîÑ HiGYM streak tracking via ${useHiBaseStreaks ? 'HiBase' : 'legacy'} path`);

          if (useHiBaseStreaks) {
            try {
              // üéØ HiBase streak path for HiGYM completion
              console.log('üì¶ HiGYM Streak ‚Üí HiBase.updateStreak...');
              // Use userId from earlier authentication check
              
              if (userId && userId !== 'anonymous') {
                const streakResult = await window.HiBase.updateStreak(userId, {
                  hiDate: new Date().toISOString().split('T')[0],
                  type: 'HiGYM',
                  emotion_from: state.current?.name,
                  emotion_to: state.desired?.name
                });

                if (streakResult.error) {
                  console.warn('‚ö†Ô∏è HiBase HiGYM streak update failed:', streakResult.error);
                } else {
                  console.log('‚úÖ HiGYM streak updated via HiBase:', streakResult.data.message);
                  
                  // Show HiGYM-specific streak celebration
                  if (streakResult.data.milestone) {
                    setTimeout(() => {
                      if (window.toast) {
                        const gymMessage = `üí™ HiGYM Streak: ${streakResult.data.streak?.current} days! ${streakResult.data.message}`;
                        window.toast(gymMessage, 'celebration');
                      }
                    }, 1500);
                  }
                }
              }

              // üìä Track HiBase streak usage for HiGYM
              import('./lib/monitoring/HiMonitor.js').then(m => 
                m.trackEvent('streak_update', { 
                  path: 'hibase', 
                  type: 'HiGYM',
                  source: 'higym',
                  emotion_from: state.current?.name,
                  emotion_to: state.desired?.name
                })
              ).catch(() => {});

            } catch (error) {
              console.warn('‚ö†Ô∏è HiBase HiGYM streak tracking failed:', error);
            }
          } else {
            // üîÑ Legacy HiGYM streak tracking
            console.log('üì¶ HiGYM Streak ‚Üí Legacy tracking...');
            
            // Legacy streak logic for HiGYM would go here
            
            // üìä Track legacy streak usage
            import('./lib/monitoring/HiMonitor.js').then(m => 
              m.trackEvent('streak_update', { 
                path: 'legacy', 
                type: 'HiGYM',
                source: 'higym'
              })
            ).catch(() => {});
          }

        } else {
          // üîÑ Legacy path: direct hiDB calls
          console.log('üì¶ HiGYM ‚Üí Legacy hiDB...');
          
          // Format content with emotional journey: emoji ‚Üí emoji + journal
          const formattedContent = `${state.current.emoji} ‚Üí ${state.desired.emoji} ${text}`;
          
          // Always save to personal archive
          console.log('Saving to archive...');
          await window.hiDB.insertArchive({
            currentEmoji: state.current.emoji,
            desiredEmoji: state.desired.emoji,
            journal: text,
            text: formattedContent, // Include emojis in text field
            location: loc,
            journeyType: pattern?.journeyType || 'exploration',
            origin: 'higym', // Gold standard: lowercase origin tag
            type: 'higym' // Gold standard: type tag for filtering
          });

          // Always share to Hi Island as part of the flow
          console.log('Sharing to Hi Island...');
          await window.hiDB.insertPublicShare({
            currentEmoji: state.current.emoji, 
            currentName: state.current.name,
            desiredEmoji: state.desired.emoji, 
            desiredName: state.desired.name,
            text: formattedContent, // Include emojis in content
            isAnonymous: isAnon, 
            location: loc || null, // Clean pipe: null for no location
            isPublic: true,
            origin: 'higym', // Gold standard: lowercase origin tag
            journeyType: pattern?.journeyType || 'exploration',
            tags: ['emotional-journey', 'higym'], // Gold standard: lowercase tags
            metadata: {
              origin: 'higym',
              type: 'higym'
            }
          });

          // üìä Track legacy usage
          import('./lib/monitoring/HiMonitor.js').then(m => 
            m.trackEvent('hibase_share_success', { 
              source: 'higym', 
              path: 'legacy'
            })
          ).catch(() => {});

          // üîÑ Legacy HiGYM streak tracking (since HiBase shares are legacy too)
          const useHiBaseStreaks = await window.HiFlags?.getFlag('hibase_streaks_enabled');
          console.log(`üîÑ HiGYM streak tracking via ${useHiBaseStreaks ? 'HiBase' : 'legacy'} path (in legacy share context)`);

          if (useHiBaseStreaks) {
            try {
              // Even in legacy share mode, we can still use HiBase streaks if enabled
              console.log('üì¶ HiGYM Streak ‚Üí HiBase.updateStreak (legacy share context)...');
              // Use userId from earlier authentication check
              
              if (userId && userId !== 'anonymous') {
                const streakResult = await window.HiBase.updateStreak(userId, {
                  hiDate: new Date().toISOString().split('T')[0],
                  type: 'HiGYM',
                  emotion_from: state.current?.name,
                  emotion_to: state.desired?.name
                });

                if (streakResult.error) {
                  console.warn('‚ö†Ô∏è HiBase HiGYM streak update failed (legacy context):', streakResult.error);
                } else {
                  console.log('‚úÖ HiGYM streak updated via HiBase (legacy context):', streakResult.data.message);
                }
              }

              // üìä Track HiBase streak usage in legacy share context
              import('./lib/monitoring/HiMonitor.js').then(m => 
                m.trackEvent('streak_update', { 
                  path: 'hibase', 
                  type: 'HiGYM',
                  source: 'higym',
                  share_path: 'legacy',
                  emotion_from: state.current?.name,
                  emotion_to: state.desired?.name
                })
              ).catch(() => {});

            } catch (error) {
              console.warn('‚ö†Ô∏è HiBase HiGYM streak tracking failed (legacy context):', error);
            }
          } else {
            // üìä Track legacy streak usage
            import('./lib/monitoring/HiMonitor.js').then(m => 
              m.trackEvent('streak_update', { 
                path: 'legacy', 
                type: 'HiGYM',
                source: 'higym',
                share_path: 'legacy'
              })
            ).catch(() => {});
          }
        }

        closeSheet();
        
        // üìä Analytics: Track successful gym submission
        import('./lib/monitoring/HiMonitor.js').then(m => 
          m.trackEvent('gym_submit', { 
            moodFrom: state.current?.name,
            moodTo: state.desired?.name,
            journeyType: pattern?.journeyType || 'exploration'
          })
        ).catch(() => {}); // Silent fail
        
        // üéâ TESLA-GRADE: Premium celebration for emotional journey completion
        const celebrationMsg = celebration?.message || 'üåü Amazing emotional journey completed!';
        toast(celebrationMsg, 'celebration');
        
        // Premium UX celebration integration
        if (window.PremiumUX) {
          // Center-screen celebration from share button
          setTimeout(() => {
            window.PremiumUX.confetti({ 
              count: 25, 
              colors: ['#4ECDC4', '#FFD93D', '#FF6B6B', '#8A2BE2'] 
            });
          }, 100);
          window.PremiumUX.triggerHapticFeedback('celebration');
        }
        
        // Add subtle background glow animation
        setTimeout(() => {
          document.body.style.background = 'radial-gradient(1200px 600px at 50% -220px, rgba(78, 205, 196, 0.25) 0%, rgba(78, 205, 196, 0) 60%), #0f1024';
          setTimeout(() => {
            document.body.style.background = 'radial-gradient(1200px 600px at 50% -220px, rgba(78, 205, 196, 0.15) 0%, rgba(78, 205, 196, 0) 60%), #0f1024';
          }, 1000);
        }, 200);
        
        // Clear draft after successful submission
        localStorage.removeItem('hi-gym-draft');
        
        // Navigate to Hi Island to see the result
        setTimeout(() => window.location.href='hi-island-NEW.html', 2500);
        
      } catch (error) {
        console.error('Hi Gym submission error:', error);
        toast('Something went wrong. Please try again.', 'warning');
        
        // Re-enable button
        confirmShare.disabled = false;
        confirmShare.textContent = 'Share Journey';
      }
    });

    // Renderers
    function currentList(){
      const cat = (CATALOG.categories||[]).find(c=>c.id===state.cat) || (CATALOG.categories||[])[0] || {items:[]};
      let list = cat.items || [];
      
      // SMART FILTERING: If step 2 and current emotion is from Hi Opportunity, don't show Hi Opportunity emotions
      if (state.step === 2 && state.current) {
        const currentCat = findEmotionCategory(state.current.name);
        if (currentCat === 'opportunity' && state.cat === 'opportunity') {
          // Force switch to Hi Energy tab
          setTimeout(() => {
            const hiTab = document.querySelector('.tab[data-cat="hi"]');
            if (hiTab && !hiTab.getAttribute('aria-selected')) {
              hiTab.click();
            }
          }, 100);
          return []; // Return empty list for opportunity emotions
        }
      }
      
      if (state.q){
        const q = state.q.toLowerCase();
        list = list.filter(x => x.name?.toLowerCase().includes(q) || (x.desc||'').toLowerCase().includes(q));
      }
      
      return list;
    }

    /* üåü HI ENERGY EMOTIONAL BUTTON RENDERING: Enhanced UX with Smart Interactions */
    function renderGrid(){
      const list = currentList();
      grid.innerHTML = '';
      
      if (!list.length){
        // Tesla-grade empty state design
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.style.cssText = `
          text-align: center;
          padding: 40px 20px;
          background: rgba(255,255,255,0.05);
          border: 2px dashed rgba(255,255,255,0.2);
          border-radius: 20px;
          margin: 20px 0;
          color: #cfd2ea;
        `;
        empty.innerHTML = `
          <div style="font-size: 2rem; margin-bottom: 12px;">üîç</div>
          <div style="font-weight: 600; margin-bottom: 4px;">No emotions found</div>
          <div style="font-size: 0.9rem; opacity: 0.8;">Try another category or search term</div>
        `;
        grid.appendChild(empty);
        validate(); 
        return;
      }

      // Tesla-grade staggered animation entrance
      list.forEach((item, index) => {
        const div = document.createElement('button');
        div.type = 'button';
        div.className = 'chip';
        div.title = item.desc || item.name;
        
        // Enhanced category data attribute for styling
        const category = findEmotionCategory(item.name);
        div.setAttribute('data-category', category);
        
        // Tesla-grade enhanced button structure
        div.innerHTML = `
          <span class="emo" role="img" aria-label="${item.name} emoji">${item.emoji||'‚ú®'}</span>
          <div style="display:flex;flex-direction:column;align-items:flex-start;min-width:0;flex:1;">
            <span class="name">${item.name}</span>
            <span class="desc">${item.desc||''}</span>
          </div>
        `;
        
        // Enhanced selection state detection
        const isSelected = (state.step === 1 && state.current?.name === item.name) ||
                           (state.step === 2 && state.desired?.name === item.name);
        
        if (isSelected) {
          div.classList.add('selected');
          div.setAttribute('aria-selected', 'true');
          console.log(`üéØ [Tesla-UI] Selected: ${item.name} (Step ${state.step})`);
        } else {
          div.setAttribute('aria-selected', 'false');
        }

        // Tesla-grade staggered entrance animation
        div.style.opacity = '0';
        div.style.transform = 'translateY(20px)';
        setTimeout(() => {
          div.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
          div.style.opacity = '1';
          div.style.transform = 'translateY(0)';
        }, index * 50); // Stagger by 50ms per item

        // Enhanced click handler with haptic feedback
        div.addEventListener('click', async () => {
          // Tesla-grade haptic feedback
          if (window.PremiumUX?.triggerHapticFeedback) {
            window.PremiumUX.triggerHapticFeedback('selection');
          }
          
          // Loading state
          div.classList.add('loading');
          
          let targetEmotion = item;
          let shouldProceed = true;
          
          if (state.step === 1) {
            // Step 1: Select current emotion
            state.current = targetEmotion;
            state.desired = null; // Clear any previous desired selection
            console.log(`üåü Current emotion selected: ${targetEmotion.name}`);
            
            // üéØ WOZ-GRADE: Celebrate selection with haptic + visual feedback
            if (window.PremiumUX?.triggerHapticFeedback) {
              window.PremiumUX.triggerHapticFeedback('success');
            }
            
            setTimeout(() => {
              div.classList.remove('loading');
              
              // üöÄ DRAMATIC SCROLL TO TOP: Hand-hold user to Step 2
              window.scrollTo({ top: 0, behavior: 'smooth' });
              
              // Show step transition announcement
              showStepTransitionAnnouncement('Step 2: Where Do You Want to Be?', 'üéØ');
              
              // Advance to Step 2 after scroll starts
              setTimeout(() => {
                setStep(2);
                renderGrid(); // Re-render with new selection
              }, 400); // Wait for scroll to start
            }, 200);
            
          } else if (state.step === 2) {
            // Step 2: Select desired emotion with smart validation
            if (window.HiGym?.validateEmotionalSelection) {
              const validation = window.HiGym.validateEmotionalSelection(state.current, targetEmotion);
              if (!validation.valid) {
                div.classList.remove('loading');
                toast(validation.reason, 'warning');
                
                // Smart suggestion system
                if (validation.suggestion) {
                  setTimeout(() => {
                    state.q = validation.suggestion[0];
                    search.value = state.q;
                    renderGrid();
                  }, 1500);
                }
                shouldProceed = false;
              }
            }
            
            if (shouldProceed) {
              state.desired = targetEmotion;
              console.log(`üéØ Emotional journey: ${state.current.name} ‚Üí ${targetEmotion.name}`);
              
              // üéØ WOZ-GRADE: Celebrate journey with haptic + visual feedback
              if (window.PremiumUX?.triggerHapticFeedback) {
                window.PremiumUX.triggerHapticFeedback('success');
              }
              
              setTimeout(() => {
                div.classList.remove('loading');
                
                // üöÄ DRAMATIC SCROLL TO TOP: Hand-hold user to Step 3
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Show step transition announcement
                showStepTransitionAnnouncement('Step 3: Reflect on Your Journey', '‚úçÔ∏è');
                
                // Advance to Step 3 after scroll starts
                setTimeout(() => {
                  setStep(3);
                  renderGrid(); // Re-render with new selection
                }, 400); // Wait for scroll to start
              }, 200);
            }
            
          } else if (state.step === 3) {
            // Step 3: Allow changing current emotion (reset journey)
            state.current = targetEmotion;
            state.desired = null;
            console.log(`üîÑ Journey reset with new current: ${targetEmotion.name}`);
            
            setTimeout(() => {
              div.classList.remove('loading');
              setStep(2);
              renderGrid();
            }, 200);
          }
          
          if (shouldProceed) {
            // saveDraft(); // Disabled - fresh check-in each visit
          }
        });

        // Tesla-grade accessibility enhancements
        div.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            div.click();
          }
        });

        // Enhanced hover states for better UX feedback
        div.addEventListener('mouseenter', () => {
          if (window.PremiumUX?.triggerHapticFeedback) {
            window.PremiumUX.triggerHapticFeedback('light');
          }
        });

        grid.appendChild(div);
      });

      validate();
    }

    /* üåü WOZ FIX: Update inline selection badges for immediate visual feedback */
    function updateInlineSelectionBadges() {
      const container = document.getElementById('inlineSelectionBadges');
      const currentBadge = document.getElementById('inlineCurrentBadge');
      const desiredBadge = document.getElementById('inlineDesiredBadge');
      const currentLabel = document.getElementById('inlineCurrentLabel');
      const desiredLabel = document.getElementById('inlineDesiredLabel');
      
      // Show container if we have any selection
      if (state.current || state.desired) {
        container.style.display = '';
        
        // Show current emotion selection
        if (state.current) {
          currentBadge.style.display = '';
          currentLabel.textContent = `${state.current.emoji || ''} ${state.current.name}`;
        } else {
          currentBadge.style.display = 'none';
        }
        
        // Show desired emotion selection
        if (state.desired) {
          desiredBadge.style.display = '';
          desiredLabel.textContent = `${state.desired.emoji || ''} ${state.desired.name}`;
        } else {
          desiredBadge.style.display = 'none';
        }
      } else {
        container.style.display = 'none';
      }
    }

    /* üåü TESLA-GRADE ENHANCED BADGES RENDERING */
    function renderBadges(){
      const badgesContainer = document.querySelector('.badges');
      
      if (state.current){
        badgeCur.style.display = '';
        badgeCur.innerHTML = `
          <span style="font-size:1.2rem;">${state.current.emoji}</span>
          <span>Current: <strong>${state.current.name}</strong></span>
        `;
        badgeCur.style.animation = 'badgeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
      } else {
        badgeCur.style.display = 'none';
      }

      if (state.desired){
        badgeDes.style.display = '';
        badgeDes.innerHTML = `
          <span style="font-size:1.2rem;">${state.desired.emoji}</span>
          <span>Desired: <strong>${state.desired.name}</strong></span>
        `;
        badgeDes.style.animation = 'badgeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
        badgeDes.style.animationDelay = '0.1s';
      } else {
        badgeDes.style.display = 'none';
      }
      
      // Tesla-grade journey arrow animation
      if (state.current && state.desired && badgesContainer) {
        badgesContainer.classList.add('show-arrow');
      } else if (badgesContainer) {
        badgesContainer.classList.remove('show-arrow');
      }
      
      // Add badge entrance animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes badgeSlideIn {
          0% { opacity: 0; transform: translateY(-10px) scale(0.95); }
          100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes slideInFromTop {
          0% { opacity: 0; transform: translateY(-20px); }
          100% { opacity: 1; transform: translateY(0); }
        }
      `;
      if (!document.head.querySelector('#badge-animations')) {
        style.id = 'badge-animations';
        document.head.appendChild(style);
      }
    }

    // üéØ WOZ-GRADE: Dramatic step transition announcement
    function showStepTransitionAnnouncement(message, emoji) {
      // Create or reuse announcement overlay
      let announcement = document.getElementById('stepTransitionAnnouncement');
      if (!announcement) {
        announcement = document.createElement('div');
        announcement.id = 'stepTransitionAnnouncement';
        announcement.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) scale(0.8);
          background: linear-gradient(135deg, rgba(16, 185, 129, 0.98) 0%, rgba(5, 150, 105, 0.98) 100%);
          color: white;
          padding: 32px 48px;
          border-radius: 24px;
          font-size: 24px;
          font-weight: 800;
          text-align: center;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
          z-index: 10000;
          opacity: 0;
          pointer-events: none;
          backdrop-filter: blur(10px);
          border: 2px solid rgba(255, 255, 255, 0.3);
        `;
        document.body.appendChild(announcement);
      }
      
      announcement.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 16px;">${emoji}</div>
        <div>${message}</div>
      `;
      
      // Dramatic entrance animation
      announcement.style.opacity = '0';
      announcement.style.transform = 'translate(-50%, -50%) scale(0.8)';
      
      setTimeout(() => {
        announcement.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
        announcement.style.opacity = '1';
        announcement.style.transform = 'translate(-50%, -50%) scale(1)';
      }, 50);
      
      // Dramatic exit animation
      setTimeout(() => {
        announcement.style.transition = 'all 0.3s ease-out';
        announcement.style.opacity = '0';
        announcement.style.transform = 'translate(-50%, -50%) scale(0.9)';
      }, 1800);
    }

    function setStep(n){
      state.step = Math.max(1, Math.min(3, n));
      
      // Update stepper dots and pipes
      s1.classList.toggle('active', state.step >= 1);
      s2.classList.toggle('active', state.step >= 2);
      s3.classList.toggle('active', state.step >= 3);
      p1.classList.toggle('filled', state.step >= 2);
      p2.classList.toggle('filled', state.step >= 3);

      // üåü WOZ FIX: Control floating step guidance
      const guidanceCard = document.getElementById('guidanceCard');
      const floatingGuidance = document.getElementById('floatingStepGuidance');
      const step1Guide = document.getElementById('step1Guide');
      const step2Guide = document.getElementById('step2Guide');
      const step3Guide = document.getElementById('step3Guide');
      const desiredEmotionHint = document.getElementById('desiredEmotionHint');

      // Hide main guidance once user starts engaging
      if (state.step > 1 || state.current) {
        guidanceCard.style.display = 'none';
        if (floatingGuidance) floatingGuidance.style.display = '';
      } else {
        guidanceCard.style.display = '';
        if (floatingGuidance) floatingGuidance.style.display = 'none';
      }

      // Show step-specific guidance in floating banner
      if (step1Guide) step1Guide.style.display = (state.step === 1) ? '' : 'none';
      if (step2Guide) step2Guide.style.display = (state.step === 2) ? '' : 'none';
      if (step3Guide) step3Guide.style.display = (state.step === 3) ? '' : 'none';

      // Smart filtering: no double-low selections
      if (state.step === 2 && state.current) {
        const currentCat = findEmotionCategory(state.current.name);
        if (currentCat === 'opportunity') {
          // Switch to Hi Energy tab if coming from opportunity emotion
          document.querySelector('.tab[data-cat="hi"]').click();
        }
      }

      // Update desired emotion hint in step 3
      if (state.step === 3 && state.desired && desiredEmotionHint) {
        desiredEmotionHint.textContent = state.desired.name.toLowerCase();
      }

      renderBadges();
      renderGrid();
      
      // Show/hide journal card
      journalCard.style.display = (state.step === 3) ? '' : 'none';
      if (state.step === 3 && state.desired) {
        desiredLabel.textContent = state.desired.name;
        
        // ÔøΩ WOZ-GRADE: Scroll to journal + auto-focus after step announcement
        setTimeout(() => {
          journalCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
          
          // Add visual pulse to journal card to draw attention
          journalCard.style.animation = 'journalCardPulse 0.6s ease-out';
          
          setTimeout(() => {
            const journalTextarea = document.getElementById('journal');
            if (journalTextarea) {
              journalTextarea.focus();
              // Haptic feedback when focus lands
              if (window.PremiumUX?.triggerHapticFeedback) {
                window.PremiumUX.triggerHapticFeedback('light');
              }
            }
          }, 700); // Focus after scroll completes
        }, 1000); // Wait for step announcement to finish
      }

      // üåü WOZ FIX: Update inline selection badges for immediate visual feedback
      updateInlineSelectionBadges();

      validate();
      // saveDraft(); // Disabled - fresh check-in each visit
      
      // üéØ TESLA-GRADE: Update sticky progress bar
      updateStickyProgress(state.step);
    }

    // üéØ TESLA-GRADE: Sticky Progress Bar Update Function
    function updateStickyProgress(step) {
      const descriptions = [
        'How do you feel?',
        'Where do you want to be?',
        'Reflect on your journey'
      ];
      
      const stepNumber = document.getElementById('stepNumber');
      const stepDescription = document.getElementById('stepDescription');
      const miniDots = document.querySelectorAll('.mini-dot');
      
      if (stepNumber) stepNumber.textContent = step;
      if (stepDescription) stepDescription.textContent = descriptions[step - 1];
      
      miniDots.forEach((dot, index) => {
        dot.classList.toggle('active', index < step);
      });
    }

    function findEmotionCategory(emotionName) {
      for (const cat of CATALOG.categories) {
        if (cat.items.some(item => item.name === emotionName)) {
          return cat.id;
        }
      }
      return 'hi'; // default
    }

    function validate(){
      const step = state.step;
      let canContinue = false;

      if (step === 1) {
        canContinue = !!state.current;
        nextBtn.textContent = 'Continue to Step 2';
      } else if (step === 2) {
        canContinue = !!state.current && !!state.desired;
        nextBtn.textContent = 'Continue to Reflection';
      } else if (step === 3) {
        const journalText = journal.value.trim();
        canContinue = !!state.current && !!state.desired && journalText.length >= 10;
        nextBtn.textContent = 'Share Your Journey';
      }

      nextBtn.disabled = !canContinue;
      nextBtn.style.opacity = canContinue ? '1' : '0.6';
      nextBtn.style.cursor = canContinue ? 'pointer' : 'not-allowed';
      
      backBtn.textContent = (step === 1) ? 'Exit' : 'Back';
    }

    function saveDraft(){
      try {
        localStorage.setItem('hi-gym-draft', JSON.stringify({
          step: state.step,
          current: state.current,
          desired: state.desired,
          journal: journal.value,
          timestamp: Date.now()
        }));
      } catch {}
    }

    function loadDraft(){
      try {
        const saved = localStorage.getItem('hi-gym-draft');
        if (!saved) return;
        
        const draft = JSON.parse(saved);
        const age = Date.now() - (draft.timestamp || 0);
        
        // Clear old drafts (24 hours)
        if (age > 24 * 60 * 60 * 1000) {
          localStorage.removeItem('hi-gym-draft');
          return;
        }

        state.current = draft.current;
        state.desired = draft.desired;
        journal.value = draft.journal || '';
        setStep(draft.step || 1);
        updateCharCount();
        
        // üåü Show discrete "Start Fresh" option when draft loaded
        console.log('üíæ Draft restored. Press Ctrl+Shift+R to start fresh.');
      } catch {}
    }

    function startFresh(){
      localStorage.removeItem('hi-gym-draft');
      state.current = null;
      state.desired = null;
      state.step = 1;
      journal.value = '';
      setStep(1);
      updateCharCount();
      toast('‚ú® Started fresh! Ready for your new emotional journey.', 'default');
    }

    // üåü TESLA-GRADE: Add keyboard shortcut for hard reset
    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'R') {
        e.preventDefault();
        startFresh();
      }
    });

    function updateCharCount(){
      const len = journal.value.length;
      count.textContent = `${len}/600`;
      count.style.color = len > 580 ? '#ef4444' : '';
    }

    function toast(msg, type = 'default'){
      console.log('Toast:', msg);
      toastEl.textContent = msg;
      
      // Style based on type
      if (type === 'celebration') {
        toastEl.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        toastEl.style.boxShadow = '0 10px 30px rgba(16, 185, 129, 0.4)';
      } else if (type === 'warning') {
        toastEl.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
        toastEl.style.boxShadow = '0 10px 30px rgba(245, 158, 11, 0.4)';
      } else {
        toastEl.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        toastEl.style.boxShadow = '0 10px 30px rgba(16, 185, 129, 0.4)';
      }
      
      toastEl.classList.remove('hide');
      toastEl.classList.add('show');
      
      setTimeout(() => {
        toastEl.classList.remove('show');
        toastEl.classList.add('hide');
      }, type === 'celebration' ? 3000 : 2000);
    }

    // Journal character counting
    journal.addEventListener('input', () => {
      updateCharCount();
      validate();
      // saveDraft(); // Disabled - fresh check-in each visit
    });

    // Enhanced profile-first location management with traveling support
    async function loadUserLocation() {
      try {
        // Safety check: ensure HiDB is available
        if (!window.hiDB || typeof window.hiDB.getUserProfile !== 'function') {
          console.warn('üíæ HiDB not ready, skipping user location load');
          return;
        }
        
        const userProfile = await window.hiDB.getUserProfile();
        const locationEducation = document.getElementById('locationEducation');
        const travelingContainer = document.getElementById('travelingContainer');
        const travelingToggle = document.getElementById('travelingToggle');
        
        if (userProfile?.location) {
          // User has set location - show traveling option and auto-populate
          locationInput.value = userProfile.location;
          travelingContainer.style.display = '';
          locationEducation.innerHTML = `<strong>Great!</strong> Using your saved location: <strong>${userProfile.location}</strong>. This helps build your local Hi community.`;
          
          // Handle traveling toggle
          travelingToggle.addEventListener('change', function() {
            if (this.checked) {
              // Store original location and clear input for manual entry
              this.dataset.homeLocation = userProfile.location;
              locationInput.value = '';
              locationInput.placeholder = 'Where are you traveling? (e.g., Paris, France)';
              locationEducation.innerHTML = `‚úàÔ∏è <strong>Traveling mode:</strong> Will post from your travel location but keep <strong>${userProfile.location}</strong> as your home base.`;
            } else {
              // Restore home location
              locationInput.value = userProfile.location;
              locationInput.placeholder = 'e.g., Austin, TX or London, UK';
              locationEducation.innerHTML = `<strong>Great!</strong> Using your saved location: <strong>${userProfile.location}</strong>. This helps build your local Hi community.`;
            }
          });
        } else {
          // New user - hide traveling option, emphasize community benefits
          travelingContainer.style.display = 'none';
          locationEducation.innerHTML = `<strong>Optional but powerful:</strong> Adding your city/state helps you connect with others nearby and see how your community feels. Posts without location appear as "Global Community" shares.`;
        }
        
      } catch (error) {
        console.log('Could not load user location:', error);
        const locationEducation = document.getElementById('locationEducation');
        const travelingContainer = document.getElementById('travelingContainer');
        if (locationEducation) {
          locationEducation.innerHTML = `<strong>Connect locally:</strong> Add your city and state to find others nearby. Leave blank to share with the global community.`;
        }
        if (travelingContainer) {
          travelingContainer.style.display = 'none';
        }
      }
    }

    // Initialize Hi-Muscle emotional journey
    state.startTime = Date.now(); // Track session duration
    // üß† GOLD STANDARD: Don't load drafts - fresh emotional check-in each time
    // loadDraft(); // Commented out - defeats purpose of "how do you feel NOW"
    loadUserLocation();
    setStep(state.step || 1);
    validate();

    // Tesla-grade smart suggestions on load
    window.addEventListener('load', () => {
      if (state.current && !state.desired && window.HiGym) {
        const suggestions = window.HiGym.suggestOptimalEmotions(state.current);
        if (suggestions.length > 0) {
          // Subtle suggestion in search placeholder
          search.placeholder = `Try: ${suggestions.slice(0, 2).join(', ')}...`;
        }
      }
    });

    // üéØ WOZNIAK-GRADE: Initialize HiShareSheet v2.1.0-auth (No Anonymous Sharing)
    // Load and initialize HiShareSheet with access to local variables
    import('./ui/HiShareSheet/HiShareSheet.js?v=2.1.0-auth').then(({ HiShareSheet }) => {
      // üèÜ GOLD STANDARD: Load clean tracker + Hi OS Enhancement
      import('./lib/stats/GoldStandardTracker.js').then(async ({ trackShareSubmission }) => {
        try {
          // Make tracker globally available
          window.trackShareSubmission = trackShareSubmission;
          console.log('‚úÖ Gold Standard tracker loaded for Hi-Muscle');
          
          // üöÄ HI OS ENHANCEMENT: Load enhancement layer
          try {
            await import('./lib/stats/HiOSEnhancementLayer.js');
            console.log('üöÄ Hi OS Enhancement Layer loaded for Hi-Muscle');
          } catch (error) {
            console.warn('‚ö†Ô∏è Hi OS enhancement optional - continuing without:', error);
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Failed to load tracker:', error);
        }
        
        const shareSheet = new HiShareSheet({ 
          origin: 'higym',
          onSuccess: (shareData) => {
            console.log('‚úÖ HiGYM share successful!', shareData);
            
            // üéØ GOLD STANDARD: Direct tracker call
            if (window.trackShareSubmission) {
              console.log('üéØ Using Gold Standard tracker...');
              window.trackShareSubmission('higym', {
                submissionType: shareData.visibility || 'public',
                pageOrigin: 'hi-muscle', 
                origin: 'higym',
                timestamp: Date.now()
              });
            } else {
              console.log('‚ö†Ô∏è Gold Standard tracker not available');
            }
            
            // Reset Hi-Muscle form after successful submission - NOW WITH PROPER SCOPE ACCESS
            console.log('üîÑ Resetting Hi-Muscle form for new journey...');
            state.current = null;
            state.desired = null;
            state.step = 1;
            journal.value = '';
            localStorage.removeItem('hi-gym-draft');
            setStep(1);
            updateCharCount();
            
            // Clear any selected emotion visual states
            document.querySelectorAll('.emotion.selected').forEach(el => el.classList.remove('selected'));
            
            // Show success message
            toast('‚ú® Journey shared successfully! Ready for your next emotional journey.', 'success');
            
            console.log('‚úÖ Hi-Muscle form completely reset - ready for new journey');
          }
        });
        shareSheet.init();
        
        // üéØ TESLA-GRADE: Backup form reset when modal closes (safety net)
        document.addEventListener('hi-share-sheet:closed', () => {
          if (state.step === 3 && !state.current && !state.desired) {
            // Form was shared and cleared, ensure UI is fully reset
            console.log('üîÑ Backup reset triggered on modal close');
            setStep(1);
          }
        });
        
        // üîß WOZNIAK-GRADE: Override window.openHiShareSheet with auth check + tracking
        // MATCH EXACT PATTERN: Use same signature as original HiShareSheet.init()
        window.openHiShareSheet = async (origin = 'higym', options = {}) => {
          console.log('üí™ [HiGYM] Opening share sheet with tracking-enabled instance:', { origin, options });
          
          // üîí WOZNIAK-GRADE: Multi-source auth check
          // Check membership systems first (already loaded from auth-ready)
          const hasMembership = !!(window.HiMembership?.tier || window.unifiedMembership?.membershipStatus?.tier || window.__hiMembership?.tier);
          
          // Check session as fallback
          let hasSession = false;
          if (!hasMembership && window.supabase?.auth?.getSession) {
            try {
              const { data } = await window.supabase.auth.getSession();
              hasSession = !!data?.session;
            } catch (err) {
              console.warn('‚ö†Ô∏è Session check failed:', err);
            }
          }
          
          // User is authenticated if EITHER membership exists OR session exists
          const canShare = hasMembership || hasSession;
          
          console.log('üîç [HiGYM] Share access check:', { 
            hasMembership,
            hasSession, 
            canShare,
            tier: window.HiMembership?.tier || window.unifiedMembership?.membershipStatus?.tier || window.__hiMembership?.tier,
            sources: {
              HiMembership: !!window.HiMembership?.tier,
              unifiedMembership: !!window.unifiedMembership?.membershipStatus?.tier,
              __hiMembership: !!window.__hiMembership?.tier
            }
          });
          
          if (!canShare) {
            console.log('üîí User cannot share - showing Hi Muscle auth modal');
            
            // Store journey data for post-auth continuation
            localStorage.setItem('pendingHiMuscleJourney', JSON.stringify({
              origin,
              options,
              timestamp: Date.now(),
              action: 'share-journey'
            }));
            
            // üåü Show beautiful Hi Muscle auth modal with fitness benefits
            if (window.showShareAuthModal) {
              window.showShareAuthModal('hi-muscle', {
                title: 'Join Hi Fitness Community',
                benefits: [
                  'üí™ Track your emotional fitness journey over time',
                  'üéØ Share breakthrough moments with the community', 
                  'üèÜ Unlock wellness achievements and streaks',
                  'üåü Connect with others on similar journeys'
                ],
                onPrimary: () => {
                  window.location.href = '/signin.html?redirect=' + encodeURIComponent(window.location.pathname) + '&action=journey';
                },
                onSecondary: () => {
                  window.location.href = '/signup.html?redirect=' + encodeURIComponent(window.location.pathname) + '&action=journey';
                }
              });
            } else if (window.showAuthModal) {
              // Fallback to general auth modal
              window.showAuthModal('hi-muscle');
            } else {
              // Last resort
              console.warn('‚ö†Ô∏è No auth modals available, redirecting to auth');
              window.location.href = '/signin.html?action=journey';
            }
            return; // Stop here for anonymous users
          }
          
          // ‚úÖ Authenticated user - proceed with share sheet
          shareSheet.origin = origin;
          shareSheet.prefilledData = options; // Store prefilled data for Hi Muscle integration
          shareSheet.open(); // Call without parameters - data comes from this.prefilledData
        };
        
        console.log('‚úÖ Hi-Muscle HiShareSheet initialized with Total His tracking');

        // üåü WOZNIAK-GRADE: Handle post-auth journey continuation
        const pendingJourney = localStorage.getItem('pendingHiMuscleJourney');
        if (pendingJourney) {
          try {
            const journeyData = JSON.parse(pendingJourney);
            console.log('üîÑ Processing pending Hi Muscle journey after auth:', journeyData);
            
            // Clear the pending journey
            localStorage.removeItem('pendingHiMuscleJourney');
            
            // Auto-continue the journey sharing after successful auth
            if (journeyData.action === 'share-journey') {
              setTimeout(() => {
                console.log('‚úÖ Auto-continuing Hi Muscle journey share after auth');
                window.openHiShareSheet(journeyData.origin, journeyData.options);
              }, 1000); // Small delay to ensure everything is loaded
            }
          } catch (error) {
            console.error('‚ùå Failed to process pending Hi Muscle journey:', error);
            localStorage.removeItem('pendingHiMuscleJourney'); // Clean up on error
          }
        }
      });
    });

    })();
  </script>

  <!-- HiShareSheet now initialized within main script scope for proper variable access -->

  <script src="assets/premium-ux.js"></script>
  
  <!-- Tesla-Grade Header JavaScript -->
  <script>
    // Navigation Modal Control
    function openNavigation() {
      const modal = document.getElementById('navigationModal');
      if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => {
          modal.style.opacity = '1';
          modal.style.visibility = 'visible';
        }, 10);
      }
    }

    function closeNavigation() {
      const modal = document.getElementById('navigationModal');
      if (modal) {
        modal.style.opacity = '0';
        modal.style.visibility = 'hidden';
        setTimeout(() => {
          modal.style.display = 'none';
        }, 300);
      }
    }

    // Calendar functionality - lazy loaded
    function showCalendar() {
      const ensureShow = () => {
        if (window.hiCalendarInstance?.show) { window.hiCalendarInstance.show(); return true; }
        if (window.PremiumCalendar) {
          if (!window.hiCalendarInstance) { console.log('üìÖ Initializing calendar on Hi Muscle (lazy)...'); window.hiCalendarInstance = new window.PremiumCalendar(); }
          if (window.hiCalendarInstance?.show) { window.hiCalendarInstance.show(); return true; }
        }
        return false;
      };
      if (ensureShow()) return;
      if (window.HiLazy) {
        console.log('‚è≥ Loading premium-calendar.js via HiLazy (muscle)...');
        window.HiLazy.loadPremiumCalendar().then(() => {
          if (!ensureShow()) {
            console.error('‚ùå Calendar instance not ready after lazy load');
            alert('üìÖ Calendar failed to initialize after load.');
          }
        }).catch(err => {
          console.error('‚ùå Failed to load premium-calendar.js lazily:', err);
          alert('üìÖ Calendar failed to load.');
        });
      } else {
        console.error('‚ùå HiLazy unavailable; cannot load calendar');
        alert('üìÖ Calendar is loading... Please try again in a moment.');
      }
    }

    // Home navigation functionality
    function navigateToHome() {
      window.location.href = 'hi-dashboard.html';
    }

    // ‚ú® Tier Display Update System (synced with dashboard/profile logic)
    function updateBrandTierDisplay(eventOrTier) {
      const tierIndicator = document.getElementById('hi-tier-indicator');
      if (!tierIndicator) return;
      if (!window.HiBrandTiers) return;
      
      let tierKey = 'anonymous';
      
      // ‚úÖ CRITICAL: Check hi:auth-ready event detail FIRST (authoritative source from database)
      if (eventOrTier?.detail?.membership?.tier) {
        tierKey = eventOrTier.detail.membership.tier;
      } else if (typeof eventOrTier === 'string') {
        tierKey = eventOrTier;
      } else if (window.__hiMembership?.tier) {
        tierKey = window.__hiMembership.tier;
      } else if (window.unifiedMembership?.membershipStatus?.tier) {
        tierKey = window.unifiedMembership.membershipStatus.tier;
      } else if (window.HiMembership?.currentUser?.tierInfo?.name) {
        tierKey = window.HiMembership.currentUser.tierInfo.name.toLowerCase();
      }
      
      window.HiBrandTiers.updateTierPill(tierIndicator, tierKey, {
        showEmoji: false,
        useGradient: false
      });
      
      console.log('üé´ [Hi Muscle] Tier updated:', tierKey, eventOrTier?.detail?.membership ? `(from auth-ready event, DB tier: ${eventOrTier.detail.membership.tier})` : '(from fallback)');
    }
    
    // Initialize tier display - WAIT for auth-ready event
    window.addEventListener('membershipStatusChanged', () => updateBrandTierDisplay());
    window.addEventListener('hi:auth-ready', (e) => {
      console.log('üîî [Hi Muscle] hi:auth-ready received, tier:', e.detail?.membership?.tier);
      updateBrandTierDisplay(e);
    });
    
    // Fallback updates
    setTimeout(() => { 
      if (window.__hiMembership?.tier || window.unifiedMembership?.membershipStatus?.tier) {
        updateBrandTierDisplay(); 
      }
    }, 3000);

    // Initialize header on DOM load
    document.addEventListener('DOMContentLoaded', () => {
      // Track current page visit for smart navigation
      try {
        const currentPage = {
          url: window.location.href,
          name: 'Hi Muscle',
          timestamp: Date.now()
        };
        
        const navHistory = JSON.parse(sessionStorage.getItem('hiNavHistory') || '[]');
        // Remove any existing entry for this page
        const filtered = navHistory.filter(page => page.url !== currentPage.url);
        // Add current page to front
        filtered.unshift(currentPage);
        // Keep last 10 pages
        filtered.splice(10);
        sessionStorage.setItem('hiNavHistory', JSON.stringify(filtered));
      } catch (error) {
        // Silent fail for tracking
      }

      // Tier update handled by event listeners above
      
      // Add keyboard navigation support
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeNavigation();
        }
      });
    });
  </script>

  <!-- HiFooter Integration -->
  <script src="./ui/HiFooter/HiFooter.js" defer></script>
  <!-- Integrity handled by mc-access-core.js -->
  <link rel="stylesheet" href="./ui/HiFooter/HiFooter.css">
  
  <!-- üß≠ Tesla-Grade Navigation System -->
  <!-- Tesla Navigation System removed - Home nav now in header -->
  
  <!-- Centralized Streak Milestones (load before premium calendar) -->
  <script src="./lib/streaks/HiStreakMilestones.js"></script>
  <!-- Centralized streak milestone toast component -->
  <script src="./lib/streaks/HiMilestoneToast.js"></script>
  <!-- üïí Premium Calendar System lazy loaded -->
  <script src="./lib/lazy/lazy-loaders.js"></script>
  
  <!-- ÔøΩüöÄ PWA Manager -->
  <script src="assets/pwa-manager.js"></script>

  <script>
    // Add floating refresh button
    function addFloatingRefresh() {
      if (!document.querySelector('.floating-refresh')) {
        const refreshButton = document.createElement('button');
        refreshButton.className = 'floating-refresh';
        refreshButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
        refreshButton.addEventListener('click', () => {
          location.reload();
        });
        document.body.appendChild(refreshButton);
      }
    }
    
    // Initialize refresh button after page load
    addFloatingRefresh();

    // Floating Hiffirmations System - Hi Muscle Context
    class FloatingHiffirmations {
      constructor() {
        this.currentPage = 'muscle';
        this.lastShown = 0;
        this.cooldownPeriod = 30000; // 30 seconds
        this.messageHistory = [];
        this.maxHistorySize = 5;
        this.init();
      }

      init() {
        this.createFloatingButton();
        this.setupEventListeners();
        // Start gentle activity-based triggers after page settles
        setTimeout(() => this.startActivityTriggers(), 5000);
      }

      createFloatingButton() {
        const button = document.createElement('button');
        button.className = 'floating-hiffirmations';
        button.innerHTML = '‚ú®';
        button.setAttribute('aria-label', 'Emotional Strength Inspiration');
        button.setAttribute('title', 'Grow with intention');
        
        const popup = document.createElement('div');
        popup.className = 'hiffirmation-popup';
        popup.setAttribute('role', 'tooltip');
        
        document.body.appendChild(button);
        document.body.appendChild(popup);
        
        this.button = button;
        this.popup = popup;
      }

      setupEventListeners() {
        this.button.addEventListener('click', () => {
          this.showContextualMessage();
        });

        // Close popup on click outside
        document.addEventListener('click', (e) => {
          if (!this.button.contains(e.target) && !this.popup.contains(e.target)) {
            this.hidePopup();
          }
        });
      }

      getContextualMessages() {
        const userTier = this.getUserTier();
        const emotionalIntensity = this.getEmotionalIntensity();
        const timeOfDay = this.getTimeOfDay();
        const growthStage = this.getGrowthStage();
        
        // Base growth messages
        const baseMessages = [
          "üí™ Emotional growth takes courage",
          "üî• You're becoming who you're meant to be",
          "üå± Progress over perfection always",
          "üéØ Every step forward counts",
          "‚ö° Your strength is building daily"
        ];

        // Standard tier - deeper growth wisdom
        const standardMessages = [
          "üèîÔ∏è You're stronger than any challenge",
          "üåü Resilience is your hidden superpower",
          "üíé Pressure creates diamonds like you",
          "üöÄ Your growth mindset is unstoppable",
          "ü¶ã Transformation happens in small moments",
          "‚≠ê Your emotional fitness is improving"
        ];

        // Premium tier - mastery of inner work
        const premiumMessages = [
          "üî• You transform obstacles into opportunities",
          "‚≠ê Your emotional intelligence is expanding",
          "üåà You're mastering the art of inner strength",
          "üí´ Every challenge reveals more of your power",
          "üé≠ You architect your own transformation",
          "ü¶Ñ Your inner work changes everything"
        ];

        // Emotional intensity-aware messages
        const intensityMessages = this.getIntensityMessages(emotionalIntensity, userTier);
        
        // Growth stage-specific messages
        const stageMessages = this.getGrowthStageMessages(growthStage, userTier);
        
        // Time-aware growth messages
        const timeMessages = this.getTimeAwareGrowthMessages(timeOfDay, userTier);

        // Build intelligent message pool
        let messagePool = [...baseMessages];
        
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messagePool.push(...standardMessages);
        }
        if (userTier === 'PREMIUM') {
          messagePool.push(...premiumMessages);
        }
        
        messagePool.push(...intensityMessages);
        messagePool.push(...stageMessages);
        messagePool.push(...timeMessages);

        return messagePool;
      }

      getEmotionalIntensity() {
        if (this.activityScore > 18) return 'intense';
        if (this.activityScore > 8) return 'focused';
        return 'gentle';
      }

      getGrowthStage() {
        const patterns = this.growthPattern || {};
        if (patterns.emotionSelections > 3 && patterns.formInteractions > 2) return 'deep_work';
        if (patterns.emotionSelections > 1) return 'engaged';
        return 'beginning';
      }

      getTimeOfDay() {
        const hour = new Date().getHours();
        if (hour < 12) return 'morning';
        if (hour < 17) return 'afternoon';
        return 'evening';
      }

      getIntensityMessages(intensity, userTier) {
        const intensityMessages = {
          gentle: {
            base: ["üå∏ Gentle steps create lasting change", "üíù Honor your own pace"],
            standard: ["üå± Soft strength builds deep roots", "üåä Gentle waves move mountains"],
            premium: ["üßò‚Äç‚ôÄÔ∏è You master the art of gentle power", "‚ú® Gentle consistency transforms everything"]
          },
          focused: {
            base: ["üéØ Focused effort builds real strength", "üî• Your attention creates transformation"],
            standard: ["üí™ Focused growth compounds beautifully", "‚ö° Your concentration is your superpower"],
            premium: ["üöÄ You channel focus into masterful growth", "üíé Focused intention becomes reality"]
          },
          intense: {
            base: ["üèîÔ∏è Intense work forges unshakeable strength", "üî• You're in the forge of transformation"],
            standard: ["‚ö° Intense growth creates breakthroughs", "üí´ Your commitment is extraordinary"],
            premium: ["üåü You alchemize intensity into mastery", "ü¶ã Intense transformation is your specialty"]
          }
        };

        const messages = [...intensityMessages[intensity].base];
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messages.push(...intensityMessages[intensity].standard);
        }
        if (userTier === 'PREMIUM') {
          messages.push(...intensityMessages[intensity].premium);
        }

        return messages;
      }

      getGrowthStageMessages(stage, userTier) {
        const stageMessages = {
          beginning: {
            base: ["üå± Every expert was once a beginner", "üëã Welcome to your growth journey"],
            standard: ["üéØ Starting is the hardest part - you're doing it", "‚≠ê Your courage to begin changes everything"],
            premium: ["üöÄ You honor the power of fresh starts", "üíé Beginning again is advanced practice"]
          },
          engaged: {
            base: ["üî• Your engagement accelerates growth", "üí™ Active participation builds strength"],
            standard: ["üåü Engaged growth creates lasting change", "‚ö° Your involvement deepens the transformation"],
            premium: ["üé≠ You master the art of engaged growth", "ü¶ã Engaged practice becomes transformation"]
          },
          deep_work: {
            base: ["üèîÔ∏è Deep work creates profound shifts", "üíé You're mining pure emotional gold"],
            standard: ["üåä Deep engagement unlocks hidden strength", "üî• Your depth of practice is remarkable"],
            premium: ["üåü You architect transformation through depth", "‚ö° Deep work is your path to mastery"]
          }
        };

        const messages = [...stageMessages[stage].base];
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messages.push(...stageMessages[stage].standard);
        }
        if (userTier === 'PREMIUM') {
          messages.push(...stageMessages[stage].premium);
        }

        return messages;
      }

      getTimeAwareGrowthMessages(timeOfDay, userTier) {
        const timeMessages = {
          morning: {
            base: ["üåÖ Morning growth sets a powerful tone", "‚òÄÔ∏è Early emotional work energizes the day"],
            standard: ["üí™ Morning strength training for the soul", "üå± Dawn practice cultivates daily resilience"],
            premium: ["üéØ You architect transformation with morning intention", "üî• Morning growth becomes daily mastery"]
          },
          afternoon: {
            base: ["üåû Midday growth maintains momentum", "‚ö° Afternoon strength building pays dividends"],
            standard: ["üöÄ Sustained growth work compounds beautifully", "üíé Afternoon practice deepens resilience"],
            premium: ["üåü You sustain transformation with masterful consistency", "ü¶ã Afternoon growth becomes lifestyle mastery"]
          },
          evening: {
            base: ["üåô Evening growth completes the circle", "‚ú® Twilight reflection integrates learning"],
            standard: ["üåü Evening practice honors the day's journey", "üí´ Reflective growth builds wisdom"],
            premium: ["üé≠ Evening growth transforms daily experience", "ü¶Ñ You complete each day stronger than you began"]
          }
        };

        const messages = [...timeMessages[timeOfDay].base];
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messages.push(...timeMessages[timeOfDay].standard);
        }
        if (userTier === 'PREMIUM') {
          messages.push(...timeMessages[timeOfDay].premium);
        }

        return messages;
      }

      displayMessage(message, type = 'contextual') {
        // Growth-specific message display
        this.popup.textContent = message;
        this.popup.setAttribute('data-message-type', type);
        
        if (type === 'growth') {
          this.popup.style.background = 'rgba(233, 30, 99, 0.1)';
          this.popup.style.borderColor = 'rgba(233, 30, 99, 0.3)';
        } else {
          this.popup.style.background = 'rgba(26, 32, 56, 0.95)';
          this.popup.style.borderColor = 'rgba(255, 255, 255, 0.15)';
        }
        
        this.popup.classList.add('show');
        
        const baseTime = type === 'growth' ? 6000 : 4000; // Growth messages stay longer
        const lengthBonus = Math.min(2000, message.length * 50);
        const hideDelay = baseTime + lengthBonus;
        
        setTimeout(() => {
          this.hidePopup();
        }, hideDelay);

        this.trackGrowthMessage(message, type);
      }

      trackGrowthMessage(message, type) {
        if (!window.hiAnalytics) return;
        
        window.hiAnalytics.track('growth_hiffirmation_shown', {
          message_type: type,
          growth_context: 'hi_muscle',
          user_tier: this.getUserTier(),
          emotional_intensity: this.getEmotionalIntensity(),
          growth_stage: this.getGrowthStage(),
          activity_score: this.activityScore,
          emotion_selections: this.growthPattern?.emotionSelections || 0
        });
      }

      getUserTier() {
        // Integration with existing tier system
        const tierElement = document.getElementById('hi-tier-indicator');
        if (tierElement) {
          const tierText = tierElement.querySelector('.tier-text')?.textContent;
          if (tierText === 'Premium') return 'PREMIUM';
          if (tierText === 'Standard') return 'STANDARD';
        }
        return 'ANONYMOUS';
      }

      showContextualMessage() {
        const now = Date.now();
        if (now - this.lastShown < this.cooldownPeriod) return;

        const messages = this.getContextualMessages();
        const availableMessages = messages.filter(msg => !this.messageHistory.includes(msg));
        
        if (availableMessages.length === 0) {
          this.messageHistory = []; // Reset history if all used
          this.showContextualMessage(); // Retry
          return;
        }

        const message = availableMessages[Math.floor(Math.random() * availableMessages.length)];
        this.displayMessage(message);
        
        // Update history
        this.messageHistory.push(message);
        if (this.messageHistory.length > this.maxHistorySize) {
          this.messageHistory.shift();
        }
        
        this.lastShown = now;
      }

      displayMessage(message) {
        this.popup.textContent = message;
        this.popup.classList.add('show');
        
        // Auto-hide after 4 seconds
        setTimeout(() => {
          this.hidePopup();
        }, 4000);
      }

      hidePopup() {
        this.popup.classList.remove('show');
      }

      startActivityTriggers() {
        // Smart growth-focused triggers for emotional fitness context
        this.activityScore = 0;
        this.growthMilestones = ['emotion-selection', 'journey-completion', 'share-growth'];
        this.setupGrowthTriggers();
        this.setupSmartGrowthTiming();
        this.trackGrowthPattern();
      }

      setupGrowthTriggers() {
        // Trigger inspirational messages after growth milestones
        
        // Emotion selection milestone
        const emotionButtons = document.querySelectorAll('.mood-btn, [data-emotion]');
        emotionButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            setTimeout(() => {
              this.showGrowthMessage('emotion-selection');
            }, 2500);
          });
        });

        // Journey completion milestone (form submission)
        const submitButton = document.querySelector('#btnSubmit, [type="submit"]');
        if (submitButton) {
          submitButton.addEventListener('click', () => {
            setTimeout(() => {
              this.showGrowthMessage('journey-completion');
            }, 3000);
          });
        }

        // Share/vulnerability milestone
        const shareElements = document.querySelectorAll('[data-action="share"], .share-btn');
        shareElements.forEach(element => {
          element.addEventListener('click', () => {
            setTimeout(() => {
              this.showGrowthMessage('share-growth');
            }, 2000);
          });
        });
      }

      showGrowthMessage(growthType) {
        const now = Date.now();
        if (now - this.lastShown < 25000) return; // Growth-specific cooldown

        const growthMessages = this.getGrowthMessages(growthType);
        const message = growthMessages[Math.floor(Math.random() * growthMessages.length)];
        this.displayMessage(message, 'growth');
        this.lastShown = now;
      }

      getGrowthMessages(growthType) {
        const userTier = this.getUserTier();
        
        const growthMap = {
          'emotion-selection': {
            base: ["üí™ Naming emotions builds strength", "üéØ Awareness is the first step"],
            standard: ["üå± Emotional honesty cultivates growth", "‚ö° You're developing emotional intelligence"],
            premium: ["ü¶ã You master the art of emotional awareness", "üíé Conscious feeling transforms into wisdom"]
          },
          'journey-completion': {
            base: ["üèîÔ∏è Every journey strengthens you", "‚ú® Completion builds resilience"],
            standard: ["üöÄ Your commitment to growth is powerful", "üåü Each journey expands your capacity"],
            premium: ["üé≠ You architect transformation through practice", "‚≠ê Your growth journey inspires others"]
          },
          'share-growth': {
            base: ["ü§ù Sharing growth multiplies strength", "üåà Vulnerability creates connection"],
            standard: ["üí´ Your openness builds community", "üî• Authentic sharing lights paths for others"],
            premium: ["üåü You model courageous emotional leadership", "ü¶Ñ Your vulnerability transforms environments"]
          }
        };

        const messageSet = growthMap[growthType] || growthMap['emotion-selection'];
        let messages = [...messageSet.base];
        
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messages.push(...messageSet.standard);
        }
        if (userTier === 'PREMIUM') {
          messages.push(...messageSet.premium);
        }

        return messages;
      }

      setupSmartGrowthTiming() {
        // Growth-focused smart timing that respects emotional work
        let growthTimer;
        let emotionalIntensity = 'gentle'; // gentle, focused, intense
        
        const calculateEmotionalIntensity = () => {
          if (this.activityScore > 18) emotionalIntensity = 'intense';
          else if (this.activityScore > 8) emotionalIntensity = 'focused';
          else emotionalIntensity = 'gentle';
        };

        const getGrowthInterval = () => {
          const intervals = {
            gentle: 210000,   // 3.5 minutes - gentle encouragement
            focused: 270000,  // 4.5 minutes - respect the work
            intense: 330000   // 5.5 minutes - don't interrupt deep work
          };
          return intervals[emotionalIntensity] + Math.random() * 60000;
        };

        const resetGrowthTimer = () => {
          clearTimeout(growthTimer);
          calculateEmotionalIntensity();
          
          growthTimer = setTimeout(() => {
            if (this.shouldShowGrowthMessage()) {
              this.showContextualMessage();
            }
            resetGrowthTimer();
          }, getGrowthInterval());
        };

        // Track growth-specific interactions
        ['click', 'focus', 'input', 'selection'].forEach(event => {
          document.addEventListener(event, (e) => {
            this.activityScore += this.getGrowthWeight(e);
            setTimeout(() => { this.activityScore = Math.max(0, this.activityScore - 1); }, 40000);
          }, { passive: true });
        });

        resetGrowthTimer();
      }

      getGrowthWeight(event) {
        const weights = {
          click: 3,
          focus: 1,
          input: 4,      // Form input is high-value growth work
          selection: 5   // Emotion selection is deep work
        };

        // Bonus for growth-related elements
        if (event.target && event.target.closest('.mood-btn, [data-emotion], form, textarea')) {
          return (weights[event.type] || 1) * 2;
        }

        return weights[event.type] || 1;
      }

      shouldShowGrowthMessage() {
        const now = Date.now();
        if (now - this.lastShown < 90000) return false; // 1.5 minutes minimum for emotional work

        // Don't interrupt intense emotional processing
        if (this.activityScore > 25) return false;

        return true;
      }

      trackGrowthPattern() {
        this.growthPattern = {
          sessionStart: Date.now(),
          emotionSelections: 0,
          formInteractions: 0,
          shareActions: 0,
          deepWork: 0
        };

        // Track growth-specific behaviors
        document.addEventListener('click', (e) => {
          if (e.target.closest('.mood-btn, [data-emotion]')) {
            this.growthPattern.emotionSelections++;
          }
          if (e.target.closest('form, textarea, input')) {
            this.growthPattern.formInteractions++;
          }
          if (e.target.closest('[data-action="share"]')) {
            this.growthPattern.shareActions++;
          }
        });

        document.addEventListener('focus', (e) => {
          if (e.target.closest('textarea, input[type="text"]')) {
            this.growthPattern.deepWork++;
          }
        });
      }
    }

    // Initialize floating Hiffirmations system
    const floatingHiffirmations = new FloatingHiffirmations();

    // Quote Card Generation System (Tesla-Grade)
    class HiQuoteCardGenerator {
      constructor() {
        this.brandColors = {
          primary: '#FFD166',
          secondary: '#F4A261',
          accent: '#E76F51',
          background: '#1E2A4A',
          backgroundSecondary: '#2D4A87',
          text: '#FFFFFF',
          textSecondary: 'rgba(255, 255, 255, 0.8)'
        };
        
        this.socialFormats = {
          instagram_post: { width: 1080, height: 1080 },
          instagram_story: { width: 1080, height: 1920 },
          twitter_card: { width: 1200, height: 675 },
          square: { width: 800, height: 800 }
        };
      }

      async generateQuoteCard(message, options = {}) {
        const {
          userTier = 'ANONYMOUS',
          format = 'square',
          context = 'muscle'
        } = options;

        const dimensions = this.socialFormats[format];
        const canvas = this.createCanvas(dimensions.width, dimensions.height);
        const ctx = canvas.getContext('2d');

        await this.drawBackground(ctx, canvas, userTier);
        await this.drawQuoteText(ctx, message, canvas, userTier);
        await this.drawBranding(ctx, canvas, userTier, context);
        
        return canvas.toDataURL('image/png', 0.9);
      }

      createCanvas(width, height) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        return canvas;
      }

      async drawBackground(ctx, canvas, userTier) {
        const { width, height } = canvas;
        let gradient;
        
        switch(userTier) {
          case 'PREMIUM':
            gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, this.brandColors.primary);
            gradient.addColorStop(0.3, this.brandColors.secondary);
            gradient.addColorStop(0.7, this.brandColors.accent);
            gradient.addColorStop(1, this.brandColors.background);
            break;
          case 'STANDARD':
            gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, this.brandColors.background);
            gradient.addColorStop(0.5, this.brandColors.backgroundSecondary);
            gradient.addColorStop(1, this.brandColors.secondary);
            break;
          default:
            gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, this.brandColors.background);
            gradient.addColorStop(1, this.brandColors.backgroundSecondary);
        }
        
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, width, height);
        
        if (userTier === 'PREMIUM') {
          this.addPremiumTexture(ctx, canvas);
        }
      }

      addPremiumTexture(ctx, canvas) {
        ctx.globalAlpha = 0.1;
        for (let i = 0; i < 50; i++) {
          const x = Math.random() * canvas.width;
          const y = Math.random() * canvas.height;
          const size = Math.random() * 3 + 1;
          
          ctx.fillStyle = this.brandColors.primary;
          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.globalAlpha = 1;
      }

      async drawQuoteText(ctx, message, canvas, userTier) {
        const { width, height } = canvas;
        const centerX = width / 2;
        const centerY = height / 2;
        
        const fontSize = this.getFontSize(message.length, canvas);
        const fontFamily = userTier === 'PREMIUM' ? 
          'Georgia, "Times New Roman", serif' : 
          '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        
        ctx.fillStyle = this.brandColors.text;
        ctx.font = `${fontSize}px ${fontFamily}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        const lines = this.wrapText(ctx, message, width * 0.8);
        const lineHeight = fontSize * 1.4;
        const totalTextHeight = lines.length * lineHeight;
        const startY = centerY - (totalTextHeight / 2);
        
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetY = 2;
        
        lines.forEach((line, index) => {
          const y = startY + (index * lineHeight);
          ctx.fillText(line, centerX, y);
        });
        
        ctx.shadowColor = 'transparent';
      }

      getFontSize(textLength, canvas) {
        const baseSize = Math.min(canvas.width, canvas.height) / 20;
        if (textLength < 30) return Math.min(baseSize * 1.2, 48);
        if (textLength < 60) return Math.min(baseSize, 40);
        return Math.min(baseSize * 0.8, 32);
      }

      wrapText(ctx, text, maxWidth) {
        const words = text.split(' ');
        const lines = [];
        let currentLine = '';
        
        for (const word of words) {
          const testLine = currentLine + (currentLine ? ' ' : '') + word;
          const metrics = ctx.measureText(testLine);
          
          if (metrics.width > maxWidth && currentLine !== '') {
            lines.push(currentLine);
            currentLine = word;
          } else {
            currentLine = testLine;
          }
        }
        
        if (currentLine) {
          lines.push(currentLine);
        }
        
        return lines;
      }

      async drawBranding(ctx, canvas, userTier, context = 'muscle') {
        const { width, height } = canvas;
        const brandingY = height - 80;
        
        ctx.fillStyle = this.brandColors.textSecondary;
        ctx.font = '24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('‚Äî Stay Hi Community ‚Äî', width / 2, brandingY);
        
        ctx.font = '18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.fillStyle = this.brandColors.primary;
        ctx.fillText('stay-hi.app', width / 2, brandingY + 35);
        
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
          ctx.fillStyle = this.brandColors.textSecondary;
          const tierText = userTier === 'PREMIUM' ? '‚ú® Premium Member' : '‚≠ê Standard Member';
          ctx.fillText(tierText, width / 2, brandingY - 25);
        }
      }

      async dataURLToBlob(dataURL) {
        return new Promise(resolve => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            canvas.toBlob(resolve, 'image/png', 0.9);
          };
          
          img.src = dataURL;
        });
      }
    }

    // Initialize quote card generator for Hi Muscle
    window.HiQuoteCardGenerator = new HiQuoteCardGenerator();
  </script>
  
  <!-- mc-quick-access replaced by mc-access-core.js -->
</body>
</html>
