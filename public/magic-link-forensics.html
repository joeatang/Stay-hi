<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ MAGIC LINK FORENSICS</title>
    <style>
        body {
            background: #0a0a0a;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            padding: 20px;
        }
        .terminal {
            background: rgba(0,0,0,0.9);
            border: 2px solid #00ff41;
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
            max-height: 500px;
            overflow-y: auto;
            font-size: 13px;
        }
        .critical { color: #ff0040; font-weight: bold; }
        .success { color: #40ff00; font-weight: bold; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
        button {
            background: #003300;
            color: #00ff41;
            border: 2px solid #00ff41;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 4px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        button:hover { background: #004400; }
        .url-box {
            background: rgba(0,50,0,0.3);
            border: 1px solid #00ff41;
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>üî¨ MAGIC LINK FORENSICS</h1>
    <p>Surgical analysis of magic link URL structure and session creation</p>

    <div>
        <button onclick="analyzeCurrentURL()">üîç ANALYZE CURRENT URL</button>
        <button onclick="simulatePostAuth()">üß™ SIMULATE POST-AUTH FLOW</button>
        <button onclick="testSessionLogic()">üë§ TEST SESSION VALIDATION</button>
        <button onclick="clearLog()">üóëÔ∏è CLEAR</button>
    </div>

    <div class="terminal" id="log"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        const CONFIG = {
            SUPABASE_URL: 'https://gfcubvroxgfvjhacinic.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmY3VidnJveGdmdmpoYWNpbmljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MTIyNjYsImV4cCI6MjA3NDQ4ODI2Nn0.5IlxofMPFNdKsEueM_dhgsJP9wI-GnZRUM9hfR0zE1g'
        };

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toISOString().substr(11, 12);
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${timestamp}] ${message}`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function analyzeCurrentURL() {
            log('üîç ANALYZING CURRENT URL STRUCTURE', 'success');
            log('='.repeat(60), 'info');

            const url = window.location.href;
            const urlObj = new URL(url);

            log(`üìç Full URL: ${url}`, 'info');
            log(`üåê Origin: ${urlObj.origin}`, 'info');
            log(`üìÇ Pathname: ${urlObj.pathname}`, 'info');
            log(`üîç Search: ${urlObj.search}`, 'info');
            log(`#Ô∏è‚É£ Hash: ${urlObj.hash}`, 'info');

            // Parse search parameters
            log('üîé SEARCH PARAMETERS:', 'success');
            const searchParams = new URLSearchParams(urlObj.search);
            if (searchParams.toString()) {
                for (const [key, value] of searchParams) {
                    log(`   ‚Ä¢ ${key}: ${value}`, 'info');
                    
                    // Analyze parameter types
                    if (key === 'code') {
                        log(`     ‚Ü≥ OAuth authorization code detected`, 'warning');
                    } else if (key === 'token') {
                        log(`     ‚Ü≥ Magic link token detected`, 'warning');
                    } else if (key === 'error') {
                        log(`     ‚Ü≥ Authentication error detected`, 'critical');
                    }
                }
            } else {
                log('   No search parameters found', 'info');
            }

            // Parse hash parameters
            log('üîé HASH PARAMETERS:', 'success');
            if (urlObj.hash) {
                const hashParams = new URLSearchParams(urlObj.hash.substring(1));
                if (hashParams.toString()) {
                    for (const [key, value] of hashParams) {
                        log(`   ‚Ä¢ ${key}: ${value.substring(0, 20)}...`, 'info');
                        
                        if (key === 'access_token') {
                            log(`     ‚Ü≥ JWT access token detected`, 'warning');
                        } else if (key === 'refresh_token') {
                            log(`     ‚Ü≥ Refresh token detected`, 'warning');
                        }
                    }
                } else {
                    log('   Hash present but no parameters', 'info');
                }
            } else {
                log('   No hash parameters found', 'info');
            }

            // Determine expected authentication type
            log('üéØ AUTHENTICATION TYPE ANALYSIS:', 'success');
            if (searchParams.has('code')) {
                log('   Type: OAuth PKCE Flow', 'info');
                log('   Expected: exchangeCodeForSession()', 'info');
            } else if (hashParams && (hashParams.has('access_token') || hashParams.has('refresh_token'))) {
                log('   Type: Magic Link Token Flow', 'info');
                log('   Expected: setSession()', 'info');
            } else if (searchParams.has('token')) {
                log('   Type: Magic Link URL Parameter', 'info');
                log('   Expected: Custom token processing', 'info');
            } else {
                log('   Type: No authentication parameters detected', 'warning');
                log('   Issue: This might be why authentication fails', 'critical');
            }
        }

        async function simulatePostAuth() {
            log('üß™ SIMULATING POST-AUTH PROCESSING LOGIC', 'success');
            log('='.repeat(60), 'info');

            try {
                // Initialize Supabase
                log('üì° Initializing Supabase client...', 'info');
                const supabaseClient = window.supabase.createClient(
                    CONFIG.SUPABASE_URL,
                    CONFIG.SUPABASE_ANON_KEY,
                    {
                        auth: {
                            persistSession: true,
                            autoRefreshToken: true,
                            detectSessionInUrl: true  // KEY: This should auto-detect magic link
                        }
                    }
                );
                log('‚úÖ Supabase client initialized', 'success');

                // Check if Supabase auto-detected session from URL
                log('üë§ Checking for auto-detected session...', 'info');
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

                if (sessionError) {
                    log(`‚ùå Session check error: ${sessionError.message}`, 'critical');
                } else if (session) {
                    log(`‚úÖ Session found: ${session.user.email}`, 'success');
                    log(`üîë Access token: ${session.access_token.substring(0, 20)}...`, 'info');
                    log(`üîÑ Refresh token: ${session.refresh_token.substring(0, 20)}...`, 'info');
                    log(`‚è∞ Expires: ${new Date(session.expires_at * 1000).toISOString()}`, 'info');
                } else {
                    log('‚ùå No session found - This is the problem!', 'critical');
                    
                    // Investigate why no session
                    log('üîç INVESTIGATING SESSION FAILURE...', 'warning');
                    
                    // Check URL detection
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlHash = window.location.hash;
                    
                    log(`üîç URL has search params: ${urlParams.toString() ? 'YES' : 'NO'}`, 'info');
                    log(`üîç URL has hash: ${urlHash ? 'YES' : 'NO'}`, 'info');
                    
                    if (!urlParams.toString() && !urlHash) {
                        log('üéØ ROOT CAUSE: Magic link URL has no auth parameters!', 'critical');
                        log('üí° SOLUTION: Check Supabase magic link configuration', 'warning');
                    }
                }

                // Test auth state change listener
                log('üëÇ Testing auth state change listener...', 'info');
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    log(`üîî Auth event: ${event}`, 'warning');
                    if (session) {
                        log(`üë§ Session updated: ${session.user.email}`, 'success');
                    } else {
                        log('üë§ Session cleared', 'info');
                    }
                });

            } catch (error) {
                log(`üí• Simulation failed: ${error.message}`, 'critical');
            }
        }

        async function testSessionLogic() {
            log('üë§ TESTING SESSION VALIDATION LOGIC', 'success');
            log('='.repeat(60), 'info');

            try {
                const supabaseClient = window.supabase.createClient(
                    CONFIG.SUPABASE_URL,
                    CONFIG.SUPABASE_ANON_KEY,
                    {
                        auth: {
                            persistSession: true,
                            autoRefreshToken: true,
                            detectSessionInUrl: true
                        }
                    }
                );

                // Test different session scenarios
                const scenarios = [
                    'Current session check',
                    'User metadata check', 
                    'Token refresh test',
                    'Session persistence test'
                ];

                for (const scenario of scenarios) {
                    log(`üß™ Testing: ${scenario}`, 'info');
                    
                    switch (scenario) {
                        case 'Current session check':
                            const { data: { session } } = await supabaseClient.auth.getSession();
                            log(`   Result: ${session ? 'Session exists' : 'No session'}`, session ? 'success' : 'critical');
                            break;
                            
                        case 'User metadata check':
                            const { data: { user } } = await supabaseClient.auth.getUser();
                            log(`   Result: ${user ? 'User exists' : 'No user'}`, user ? 'success' : 'warning');
                            break;
                            
                        case 'Token refresh test':
                            try {
                                const { data, error } = await supabaseClient.auth.refreshSession();
                                log(`   Result: ${error ? 'Refresh failed' : 'Refresh succeeded'}`, error ? 'critical' : 'success');
                            } catch (e) {
                                log(`   Result: Refresh error - ${e.message}`, 'critical');
                            }
                            break;
                            
                        case 'Session persistence test':
                            const stored = localStorage.getItem(`sb-${CONFIG.SUPABASE_URL.split('//')[1].split('.')[0]}-auth-token`);
                            log(`   Result: ${stored ? 'Session stored in localStorage' : 'No stored session'}`, stored ? 'success' : 'warning');
                            break;
                    }
                }

                // Analyze redirect logic
                log('üîÄ ANALYZING REDIRECT LOGIC...', 'success');
                log('Current page would redirect based on:', 'info');
                log('‚Ä¢ Session exists ‚Üí index.html', 'info');
                log('‚Ä¢ No session ‚Üí back to signin/welcome', 'warning');
                log('‚Ä¢ Error ‚Üí error handling', 'critical');

            } catch (error) {
                log(`üí• Session test failed: ${error.message}`, 'critical');
            }
        }

        // Auto-analyze on load
        setTimeout(() => {
            log('üî¨ Magic Link Forensics ready', 'success');
            log('This page will analyze magic link URL structure and session creation', 'info');
            analyzeCurrentURL();
        }, 500);
    </script>
</body>
</html>