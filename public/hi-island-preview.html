<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hi Island ‚Äî Stay Hi</title>

  <!-- Brand + shared UI -->
  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>

  <!-- Leaflet (interactive map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <style>
    body{ background: var(--hi-bg); }
    .wrap{ max-width: 1040px; margin: 0 auto; padding: 16px; }

    /* Map hero */
    .mapwrap{
      position: relative; overflow: hidden; border-radius: 18px;
      border: 1px solid var(--hi-border); box-shadow: var(--shadow);
      background: radial-gradient(1200px 600px at 50% -220px, rgba(255, 210, 140, .5) 0%, rgba(255, 210, 140, 0) 60%), var(--grad-sunrise);
      min-height: 360px;
      display: grid; grid-template-rows: auto 1fr;
      color: #241203;
    }
    .mapwrap .hero{
      padding: 12px 14px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .mapwrap .title{ font-size: var(--fs-h1); font-weight: 900; text-shadow: 0 1px 0 #ffffff80; }
    .mapwrap .sub{ font-size: .95rem; color: #3d2a16; }
    #globe{
      height: 260px; margin: 0 10px 10px; border-radius: 14px;
      border:1px solid var(--hi-border); box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    .leaflet-container{ border-radius:14px; }

    /* Tabs */
    .tabs{ display:flex; gap:6px; overflow:auto; border-bottom:1px solid var(--hi-border); padding-bottom:6px; margin:12px 0; }
    .tab{ white-space:nowrap; padding:8px 12px; border-radius:999px; border:1px solid var(--hi-border); background:#fff; font-weight:700; color:#111; cursor:pointer }
    .tab[aria-selected="true"]{ background:#111; color:#fff; border-color:#111 }

    /* Lists */
    .list{ display:flex; flex-direction:column; gap:10px; }
    .card{ background:#fff; border:1px solid var(--hi-border); border-radius:16px; padding:14px; box-shadow: var(--shadow); }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .meta{ display:flex; gap:8px; align-items:center; color: var(--hi-muted); font-size: .9rem; }
    .pill{ display:inline-flex; gap:6px; align-items:center; padding:4px 8px; border-radius:999px; border:1px solid var(--hi-border); background:#fff; font-weight:700; }
    .emo{ font-size: 18px; }
    .text{ margin:8px 0 4px; line-height:1.35; }
    .muted{ color: var(--hi-muted); }

    .empty{ text-align:center; padding:20px; color: var(--hi-muted); }
    .section{ display:none }
    .section[aria-hidden="false"]{ display:block }

    @media (min-width: 920px){
      .grid2{ display:grid; grid-template-columns: 1.6fr .8fr; gap:16px; }
    }
  </style>
</head>
<body data-tab="island">
  <!-- Shared header -->
  <header id="app-header" class="header"></header>

  <main class="wrap">
    <!-- Map / hero -->
    <section class="mapwrap" aria-label="Hi Island ‚Äì world map">
      <div class="hero">
        <div>
          <div class="title">Hi Island</div>
          <div class="sub">A gentle stream of Hi Shares from around the world</div>
        </div>
        <a class="hi-btn hi-btn--primary" href="hi-muscle.html">Drop a Hi</a>
      </div>
      <div id="globe" aria-label="Interactive world map"></div>
    </section>

    <!-- Tabs -->
    <nav class="tabs" role="tablist" aria-label="Hi Island tabs">
      <button class="tab" id="tab-general" role="tab" aria-selected="true" data-target="general">General Shares</button>
      <button class="tab" id="tab-archive" role="tab" aria-selected="false" data-target="archive">My Archive</button>
      <button class="tab" id="tab-trends" role="tab" aria-selected="false" data-target="trends">Emotional Trends</button>
      <button class="tab" id="tab-milestones" role="tab" aria-selected="false" data-target="milestones">Points Milestones</button>
      <button class="tab" id="tab-show" role="tab" aria-selected="false" data-target="show">Hi Show Shares</button>
    </nav>

    <!-- Content sections -->
    <section id="sec-general" class="section" aria-hidden="false" aria-labelledby="tab-general">
      <div class="row" style="margin:8px 0 12px">
        <div class="muted">Public feed (latest first). Anonymous posts show as ‚ÄúHi Friend‚Äù.</div>
        <a class="hi-btn hi-btn--ghost" href="hi-muscle.html">Write a Hi Thought</a>
      </div>
      <div id="generalList" class="list" aria-live="polite" aria-busy="true"></div>
    </section>

    <section id="sec-archive" class="section" aria-hidden="true" aria-labelledby="tab-archive">
      <div class="row" style="margin:8px 0 12px">
        <div class="muted">Private to you. Only you can see these entries.</div>
        <a class="hi-btn hi-btn--ghost" href="hi-muscle.html">Write a Hi Thought</a>
      </div>
      <div id="archiveList" class="list" aria-live="polite" aria-busy="true"></div>
    </section>

    <!-- Placeholders for future steps -->
    <section id="sec-trends" class="section" aria-hidden="true" aria-labelledby="tab-trends">
      <div class="card muted">Emotional Trends coming soon.</div>
    </section>

    <section id="sec-milestones" class="section" aria-hidden="true" aria-labelledby="tab-milestones">
      <div class="card muted">Points & Milestones coming soon.</div>
    </section>

    <section id="sec-show" class="section" aria-hidden="true" aria-labelledby="tab-show">
      <div class="card muted">Hi Show Shares coming soon.</div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Scripts: header ‚Üí supabase ‚Üí auth ‚Üí db ‚Üí page logic -->
  <script src="assets/header.js" defer></script>

  <script src="assets/supabase-init.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/db.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

  <!-- Island logic (Step 2B will add this file) -->
  <script src="assets/island.js" defer></script>

  <script>
    (async function(){
      // Allow signed-out users to view public feed; archive tab will request session on click.
      try { await hiAuth.ensureSessionMaybe?.(); } catch {}

      const toastEl = document.getElementById('toast');
      const generalList = document.getElementById('generalList');
      const archiveList = document.getElementById('archiveList');

      function toast(msg, ttl=1600){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ttl); }

      // Tabs
      const tabs = document.querySelectorAll('.tab');
      const sections = {
        general: document.getElementById('sec-general'),
        archive: document.getElementById('sec-archive'),
        trends: document.getElementById('sec-trends'),
        milestones: document.getElementById('sec-milestones'),
        show: document.getElementById('sec-show')
      };
      tabs.forEach(t => {
        t.addEventListener('click', () => {
          tabs.forEach(x => x.setAttribute('aria-selected','false'));
          t.setAttribute('aria-selected','true');
          const target = t.dataset.target;
          Object.entries(sections).forEach(([key,sec]) => sec.setAttribute('aria-hidden', key===target? 'false':'true'));
          if (target === 'archive' && !archiveList.dataset.loaded) {
            loadArchive();
          }
        });
      });

      // Render helpers
      function fmtDate(iso){
        try { return new Date(iso).toLocaleString([], { month:'short', day:'numeric', hour:'numeric', minute:'2-digit' }); }
        catch { return ''; }
      }
      function el(tag, attrs={}, html=''){
        const n = document.createElement(tag);
        for (const [k,v] of Object.entries(attrs)){ if(k==='class') n.className=v; else n.setAttribute(k,v); }
        n.innerHTML = html;
        return n;
      }

      function renderGeneral(list){
        generalList.innerHTML = '';
        if (!list?.length){
          generalList.appendChild(el('div', {class:'empty'}, 'No public shares yet. Be the first to drop a Hi ‚ú®'));
          generalList.setAttribute('aria-busy','false');
          return;
        }
        for (const it of list){
          const head = el('div', {class:'meta'},
            `<span class="emo">${it.currentEmoji}</span>
             <span>‚Üí</span>
             <span class="emo">${it.desiredEmoji}</span>
             <span class="pill">${it.isAnonymous ? 'Hi Friend' : (it.userName || 'You')}</span>
             ${it.location ? `<span class="pill" title="Location">üìç ${it.location}</span>` : ''}
             <span class="muted">${fmtDate(it.createdAt)}</span>`
          );
          const text = el('div', {class:'text'}, it.text);
          const card = el('div', {class:'card'});
          card.appendChild(head);
          card.appendChild(text);
          generalList.appendChild(card);
        }
        generalList.setAttribute('aria-busy','false');
      }

      function renderArchive(list){
        archiveList.innerHTML = '';
        if (!list?.length){
          archiveList.appendChild(el('div', {class:'empty'}, 'Your archive is empty. Write a Hi Thought and it will appear here.'));
          archiveList.setAttribute('aria-busy','false');
          return;
        }
        for (const it of list){
          const head = el('div', {class:'meta'},
            `<span class="emo">${it.currentEmoji}</span>
             <span>‚Üí</span>
             <span class="emo">${it.desiredEmoji}</span>
             ${it.location ? `<span class="pill">üìç ${it.location}</span>` : ''}
             <span class="muted">${fmtDate(it.createdAt)}</span>`
          );
          const text = el('div', {class:'text'}, it.journalEntry);
          const card = el('div', {class:'card'});
          card.appendChild(head);
          card.appendChild(text);
          archiveList.appendChild(card);
        }
        archiveList.setAttribute('aria-busy','false');
      }

      // Data loads (DB ‚Üí local fallback handled inside hiDB)
      async function loadGeneral(){
        try{
          generalList.setAttribute('aria-busy','true');
          const list = await window.hiDB.fetchPublicShares({ limit: 100 });
          renderGeneral(list);
          // Also update the map markers (island.js exposes HiIsland.updateMarkers)
          try { window.HiIsland?.updateMarkers?.(list); } catch {}
        }catch(e){
          renderGeneral([]);
          console.warn('general load error', e);
          toast('Could not load public shares. Showing local items if any.');
        }
      }
      async function loadArchive(){
        try{
          archiveList.setAttribute('aria-busy','true');
          const mine = await window.hiDB.fetchMyArchive({ limit: 200 });
          renderArchive(mine);
          archiveList.dataset.loaded = '1';
        }catch(e){
          renderArchive([]);
          console.warn('archive load error', e);
          toast('Could not load your archive. Showing local items if any.');
        }
      }

      // Boot the map (island.js)
      window.addEventListener('DOMContentLoaded', () => {
        try { window.HiIsland?.init?.(); } catch(e){ console.warn('map init failed', e); }
      });

      // Initial load
      loadGeneral();

      // Try to sync any queued writes (e.g., from offline ‚ÄúDrop Hi‚Äù)
      try { await window.hiDB.syncPending(); } catch {}
    })();
  </script>
</body>
</html>
