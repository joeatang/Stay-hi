<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ LIVE USER EXPERIENCE TEST</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="assets/config.js"></script>
    <style>
        body {
            background: #0F0F23;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            padding: 20px;
        }
        .console-panel {
            background: rgba(0,0,0,0.8);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .action-panel {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }
        button {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
        }
        input {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 8px;
            margin: 8px;
            width: 280px;
        }
        .timestamp { color: #888; }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .warning { color: #fbbf24; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <h1>üéØ LIVE USER EXPERIENCE TEST</h1>
    <p style="color: #fbbf24;">This mirrors exactly what happens when a user tries to sign in.</p>

    <div class="action-panel">
        <h3>üî• Test Real Signin Process</h3>
        <input type="email" id="testEmail" value="test@gmail.com" placeholder="Enter any email">
        <button onclick="performRealSignin()">üöÄ SIGNIN (Watch Console)</button>
        <button onclick="clearConsole()">üßπ Clear Console</button>
    </div>

    <div class="console-panel" id="console">
        <div class="timestamp">[System Ready]</div>
        <div class="info">Enter an email above and click SIGNIN to see exactly what happens...</div>
    </div>

    <div class="action-panel">
        <h3>üìä Quick Status Check</h3>
        <button onclick="checkSigninPageStatus()">Check Signin Page</button>
        <button onclick="testSupabaseDirectly()">Test Supabase API</button>
        <button onclick="testDOMElements()">Test DOM Elements</button>
    </div>

    <script>
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.innerHTML = `<span class="timestamp">[${timestamp}]</span> <span class="${type}">${message}</span>`;
            console.appendChild(div);
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '<div class="timestamp">[Console Cleared]</div>';
        }

        async function performRealSignin() {
            const email = document.getElementById('testEmail').value;
            log('üöÄ Starting real signin process...', 'info');
            log(`üìß Email: ${email}`, 'info');
            
            try {
                log('üîó Initializing Supabase client...', 'info');
                
                // Initialize exactly like the signin page does
                const { createClient } = supabase;
                const supabaseClient = createClient(
                    'https://gfcubvroxgfvjhacinic.supabase.co',
                    window.SUPABASE_ANON_KEY
                );
                
                log('‚úÖ Supabase client created', 'success');
                log('üì§ Sending magic link request...', 'warning');
                
                // Make the exact same API call as signin page
                const { data, error } = await supabaseClient.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: `${window.location.origin}/post-auth.html`
                    }
                });

                log('üì® API Response received', 'info');
                
                if (error) {
                    log(`‚ùå Error occurred: ${error.message}`, 'error');
                    log(`üîç Error code: ${error.error_code || 'none'}`, 'error');
                    log(`üîç Full error: ${JSON.stringify(error, null, 2)}`, 'error');
                    
                    // Test if this would trigger error handling
                    if (error.error_code === 'email_address_invalid') {
                        log('üéØ THIS IS THE EXACT ERROR OUR SYSTEM SHOULD CATCH!', 'warning');
                        log('üîß Testing handleConfigurationError logic...', 'warning');
                        
                        // Simulate what should happen
                        testErrorHandling(error);
                    } else {
                        log(`‚ö†Ô∏è  This is a different error than expected (${error.error_code})`, 'warning');
                    }
                } else {
                    log('‚úÖ Success! Magic link sent', 'success');
                    log(`üìã Response data: ${JSON.stringify(data, null, 2)}`, 'success');
                    log('‚ö†Ô∏è  This means Supabase is working - error may be resolved!', 'warning');
                }

            } catch (networkError) {
                log(`üåê Network Error: ${networkError.message}`, 'error');
                log('üîß Testing fallback error handling...', 'warning');
                testErrorHandling({ message: 'Network error occurred' });
            }
        }

        function testErrorHandling(error) {
            log('üß™ Simulating handleConfigurationError function...', 'info');
            
            try {
                // Simulate the error handling logic from signin.html
                log('üìù Error detection logic:', 'info');
                log(`  ‚Ä¢ Has error_code: ${!!error.error_code}`, 'info');
                log(`  ‚Ä¢ Error code is email_address_invalid: ${error.error_code === 'email_address_invalid'}`, 'info');
                
                if (error.error_code === 'email_address_invalid') {
                    log('‚úÖ Error matches expected pattern!', 'success');
                    log('üé® DOM elements that should become visible:', 'info');
                    log('  ‚Ä¢ configError div (explanation)', 'info');
                    log('  ‚Ä¢ demoOption div (demo mode button)', 'info');
                    log('  ‚Ä¢ signinForm should be disabled', 'info');
                    
                    log('üîç Checking if signin page DOM elements exist...', 'warning');
                    
                    // Test if we can reach the signin page DOM
                    fetch('/signin.html')
                        .then(response => response.text())
                        .then(html => {
                            const hasConfigError = html.includes('id="configError"');
                            const hasDemoOption = html.includes('id="demoOption"');
                            const hasErrorHandling = html.includes('handleConfigurationError');
                            
                            log(`üìã Signin page analysis:`, 'info');
                            log(`  ‚Ä¢ configError element exists: ${hasConfigError ? '‚úÖ' : '‚ùå'}`, hasConfigError ? 'success' : 'error');
                            log(`  ‚Ä¢ demoOption element exists: ${hasDemoOption ? '‚úÖ' : '‚ùå'}`, hasDemoOption ? 'success' : 'error');
                            log(`  ‚Ä¢ handleConfigurationError function exists: ${hasErrorHandling ? '‚úÖ' : '‚ùå'}`, hasErrorHandling ? 'success' : 'error');
                            
                            if (hasConfigError && hasDemoOption && hasErrorHandling) {
                                log('üéØ ALL COMPONENTS PRESENT! Error handling should work.', 'success');
                                log('üí° If user still sees issues, check browser console on actual signin page', 'warning');
                            } else {
                                log('‚ùå Missing components - this explains the issue!', 'error');
                            }
                        })
                        .catch(err => {
                            log(`‚ùå Could not analyze signin page: ${err.message}`, 'error');
                        });
                } else {
                    log('‚ùì Error does not match email_address_invalid pattern', 'warning');
                    log('üîß Generic error handling should still show user-friendly message', 'info');
                }
                
            } catch (handlingError) {
                log(`üí• Error in error handling simulation: ${handlingError.message}`, 'error');
            }
        }

        async function checkSigninPageStatus() {
            log('üîç Checking signin page status...', 'info');
            
            try {
                const response = await fetch('/signin.html');
                log(`üì° HTTP Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`üìè Content Length: ${response.headers.get('content-length')} bytes`, 'info');
                
                if (response.ok) {
                    const content = await response.text();
                    const hasTitle = content.includes('<title>');
                    const hasSupabase = content.includes('supabase');
                    const hasErrorHandling = content.includes('handleConfigurationError');
                    
                    log('üìÑ Content analysis:', 'info');
                    log(`  ‚Ä¢ Has HTML title: ${hasTitle ? '‚úÖ' : '‚ùå'}`, hasTitle ? 'success' : 'error');
                    log(`  ‚Ä¢ Has Supabase integration: ${hasSupabase ? '‚úÖ' : '‚ùå'}`, hasSupabase ? 'success' : 'error');
                    log(`  ‚Ä¢ Has error handling: ${hasErrorHandling ? '‚úÖ' : '‚ùå'}`, hasErrorHandling ? 'success' : 'error');
                }
            } catch (error) {
                log(`‚ùå Failed to check signin page: ${error.message}`, 'error');
            }
        }

        async function testSupabaseDirectly() {
            log('üß™ Testing Supabase API directly...', 'info');
            
            try {
                const response = await fetch('https://gfcubvroxgfvjhacinic.supabase.co/auth/v1/otp', {
                    method: 'POST',
                    headers: {
                        'apikey': window.SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        options: {
                            emailRedirectTo: `${window.location.origin}/post-auth.html`
                        }
                    })
                });

                const data = await response.json();
                
                log(`üåê API Response:`, 'info');
                log(`  ‚Ä¢ Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`  ‚Ä¢ Error Code: ${data.error_code || 'none'}`, data.error_code ? 'error' : 'success');
                log(`  ‚Ä¢ Message: ${data.msg || data.message || 'success'}`, data.msg || data.message ? 'error' : 'success');
                
                if (data.error_code === 'email_address_invalid') {
                    log('üéØ Perfect! API returns expected error that should trigger demo mode', 'success');
                } else if (response.ok) {
                    log('‚úÖ API working normally - Supabase may be fixed!', 'success');
                } else {
                    log('‚ùì Unexpected error response', 'warning');
                }

            } catch (error) {
                log(`üåê Network error: ${error.message}`, 'error');
            }
        }

        function testDOMElements() {
            log('üîç Testing DOM elements (would need iframe for full test)', 'info');
            log('üí° For complete DOM test, use the failure-investigation.html page', 'warning');
            log('üéØ Key elements to check on signin page:', 'info');
            log('  ‚Ä¢ configError (id="configError")', 'info');
            log('  ‚Ä¢ demoOption (id="demoOption")', 'info');
            log('  ‚Ä¢ signinForm (id="signinForm")', 'info');
            log('  ‚Ä¢ errorDetails (id="errorDetails")', 'info');
        }

        // Auto-initialize
        window.addEventListener('DOMContentLoaded', () => {
            log('üéØ Live User Experience Test Ready', 'success');
            log('üí° Click "SIGNIN" above to simulate exact user experience', 'info');
        });
    </script>
</body>
</html>