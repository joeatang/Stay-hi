<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P0 Production Parity Diagnostic</title>
    <style>
        * { box-sizing: border-box; }
        body {
            background: #0f1024;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            margin: 0;
        }
        .diagnostic-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            border-left: 4px solid #4ECDC4;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .pass { background: #1a4e3f; border-left: 4px solid #4CAF50; }
        .fail { background: #4e1a1a; border-left: 4px solid #f44336; }
        .pending { background: #4e4e1a; border-left: 4px solid #FFC107; }
        .summary {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            text-align: center;
        }
        .json-output {
            margin: 20px 0;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .metric { 
            display: inline-block; 
            margin: 10px; 
            padding: 10px 15px; 
            background: #2d3748; 
            border-radius: 4px; 
        }
    </style>
</head>
<body>
    <div class="diagnostic-header">
        <h1>üî¨ P0 Production Parity Diagnostic</h1>
        <p>Verifying surgical fixes and measuring pass rate against 85% SLO requirement</p>
    </div>

    <div id="testResults"></div>
    <div id="summary"></div>
    <div id="jsonOutput"></div>

    <script type="module">
        const results = document.getElementById('testResults');
        const summary = document.getElementById('summary');
        const jsonOutput = document.getElementById('jsonOutput');

        const testResults = [];
        let passCount = 0;
        let totalTests = 0;

        function logTest(name, passed, details = '') {
            totalTests++;
            if (passed) passCount++;
            
            const result = {
                test: name,
                passed: passed,
                details: details,
                timestamp: new Date().toISOString()
            };
            testResults.push(result);

            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <strong>${passed ? '‚úÖ' : '‚ùå'} ${name}</strong><br>
                ${details}
            `;
            results.appendChild(div);
        }

        function updateSummary() {
            const passRate = ((passCount / totalTests) * 100).toFixed(1);
            const meetsRequirement = passRate >= 85;
            
            summary.innerHTML = `
                <div class="summary">
                    <h2>P0 Diagnostic Results</h2>
                    <div class="metric">Tests Passed: ${passCount}/${totalTests}</div>
                    <div class="metric">Pass Rate: ${passRate}%</div>
                    <div class="metric">SLO Status: ${meetsRequirement ? '‚úÖ MEETS 85% REQUIREMENT' : '‚ùå BELOW 85% REQUIREMENT'}</div>
                </div>
            `;

            const diagnosticData = {
                timestamp: new Date().toISOString(),
                passRate: parseFloat(passRate),
                passCount: passCount,
                totalTests: totalTests,
                meetsRequirement: meetsRequirement,
                sloThreshold: 85,
                fixes: [
                    'HiSupabase 404 shim (P0 Fix 1)',
                    'S-DASH DOM anchors (P0 Fix 2)', 
                    'S-ISL/3 feed scripts (P0 Fix 3)'
                ],
                tests: testResults
            };

            jsonOutput.innerHTML = `
                <div class="test-section">
                    <h3>JSON Evidence for P0 Closure</h3>
                    <div class="json-output">${JSON.stringify(diagnosticData, null, 2)}</div>
                </div>
            `;
        }

        async function runDiagnostic() {
            console.log('üî¨ Starting P0 Production Parity Diagnostic');

            // Test 1: HiSupabase 404 Shim (P0 Fix 1)
            try {
                const response = await fetch('./lib/HiSupabase.js');
                const text = await response.text();
                const hasShim = text.includes('export * from') && text.includes('HiSupabase.v3.js');
                logTest('P0 Fix 1: HiSupabase 404 Shim', 
                       response.ok && hasShim, 
                       `HTTP ${response.status}, Contains v3 shim: ${hasShim}`);
            } catch (error) {
                logTest('P0 Fix 1: HiSupabase 404 Shim', false, `Error: ${error.message}`);
            }

            // Test 2: S-DASH DOM Anchors (P0 Fix 2)
            try {
                const response = await fetch('./hi-dashboard.html');
                const text = await response.text();
                const hasStatsRow = text.includes('id="statsRow"');
                const hasMedallion = text.includes('id="hiMedallion"');
                const hasSDashComment = text.includes('S-DASH');
                logTest('P0 Fix 2: S-DASH DOM Anchors', 
                       response.ok && hasStatsRow && hasMedallion, 
                       `HTTP ${response.status}, statsRow: ${hasStatsRow}, medallion: ${hasMedallion}, S-DASH markers: ${hasSDashComment}`);
            } catch (error) {
                logTest('P0 Fix 2: S-DASH DOM Anchors', false, `Error: ${error.message}`);
            }

            // Test 3: S-ISL/3 Feed Scripts (P0 Fix 3)
            try {
                const pageResponse = await fetch('./hi-island-NEW.html');
                const pageText = await pageResponse.text();
                const hasHiFeedImport = pageText.includes('lib/hifeed');
                const hasS_ISL_Comment = pageText.includes('S-ISL');

                const scriptResponse = await fetch('./lib/hifeed/anchors.js');
                const scriptExists = scriptResponse.ok;

                logTest('P0 Fix 3: S-ISL/3 Feed Scripts', 
                       pageResponse.ok && scriptExists && hasHiFeedImport, 
                       `Page HTTP ${pageResponse.status}, Script HTTP ${scriptResponse.status}, HiFeed imports: ${hasHiFeedImport}, S-ISL markers: ${hasS_ISL_Comment}`);
            } catch (error) {
                logTest('P0 Fix 3: S-ISL/3 Feed Scripts', false, `Error: ${error.message}`);
            }

            // Test 4: Flag System Integration
            try {
                const response = await fetch('./lib/flags/HiFlags.js');
                const text = await response.text();
                const hasNormalization = text.includes('hiFlagEnabled');
                logTest('Flag System Integration', 
                       response.ok && hasNormalization, 
                       `HTTP ${response.status}, Has normalization functions: ${hasNormalization}`);
            } catch (error) {
                logTest('Flag System Integration', false, `Error: ${error.message}`);
            }

            // Test 5: Boot Guard Implementation (P1 Step 2)
            try {
                const response = await fetch('./lib/HiDash.boot.js');
                const text = await response.text();
                const hasBootLogic = text.includes('ensureAnchor') && text.includes('injectStatsRow');
                logTest('Boot Guard Implementation', 
                       response.ok && hasBootLogic, 
                       `HTTP ${response.status}, Has injection logic: ${hasBootLogic}`);
            } catch (error) {
                logTest('Boot Guard Implementation', false, `Error: ${error.message}`);
            }

            // Test 6: Dashboard Module Integration
            try {
                const response = await fetch('./hi-dashboard.html');
                const text = await response.text();
                const hasWireModule = text.includes('HiDash.wire.js');
                const hasCTAModule = text.includes('HiDash.cta.js');
                const hasBootModule = text.includes('HiDash.boot.js');
                logTest('Dashboard Module Integration', 
                       response.ok && hasWireModule && hasCTAModule && hasBootModule, 
                       `HTTP ${response.status}, Wire: ${hasWireModule}, CTA: ${hasCTAModule}, Boot: ${hasBootModule}`);
            } catch (error) {
                logTest('Dashboard Module Integration', false, `Error: ${error.message}`);
            }

            // Test 7: Core Files Accessibility
            try {
                const coreFiles = [
                    './welcome.html',
                    './hi-dashboard.html', 
                    './hi-island-NEW.html'
                ];

                let allAccessible = true;
                let accessDetails = [];

                for (const file of coreFiles) {
                    try {
                        const response = await fetch(file);
                        const accessible = response.ok;
                        if (!accessible) allAccessible = false;
                        accessDetails.push(`${file.replace('./', '')}: ${response.status}`);
                    } catch (err) {
                        allAccessible = false;
                        accessDetails.push(`${file.replace('./', '')}: ERROR`);
                    }
                }

                logTest('Core Files Accessibility', allAccessible, accessDetails.join(', '));
            } catch (error) {
                logTest('Core Files Accessibility', false, `Error: ${error.message}`);
            }

            updateSummary();
            console.log('üî¨ P0 Diagnostic Complete:', { passCount, totalTests, passRate: (passCount/totalTests*100).toFixed(1) });
        }

        // Run diagnostic after page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runDiagnostic, 1000);
        });
    </script>
</body>
</html>