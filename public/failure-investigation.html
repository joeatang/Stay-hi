<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ EXACT FAILURE POINT INVESTIGATION</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="assets/config.js"></script>
    <style>
        body {
            background: #0F0F23;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            padding: 20px;
            line-height: 1.6;
        }
        .investigation-panel {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }
        .critical { border-left: 4px solid #ef4444; }
        .success { border-left: 4px solid #22c55e; }
        .warning { border-left: 4px solid #fbbf24; }
        .step {
            background: rgba(255,255,255,0.02);
            padding: 16px;
            margin: 16px 0;
            border-radius: 8px;
            border-left: 3px solid #4ECDC4;
        }
        button {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px 4px;
            font-weight: 600;
        }
        button:hover { transform: translateY(-1px); }
        input {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 8px;
            margin: 8px 4px;
            width: 280px;
        }
        pre {
            background: rgba(0,0,0,0.4);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 14px;
        }
        iframe {
            width: 100%;
            height: 400px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: white;
        }
        .status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .red { background: #ef4444; }
        .green { background: #22c55e; }
        .yellow { background: #fbbf24; }
    </style>
</head>
<body>
    <h1>üî¨ FAILURE POINT INVESTIGATION</h1>
    <h2 style="color: #fbbf24;">Finding exactly where "didn't work" occurs</h2>

    <div class="investigation-panel warning">
        <h3>üéØ HYPOTHESIS</h3>
        <p>The deployment worked, but something specific isn't functioning as expected. Let's find the exact failure point.</p>
    </div>

    <div class="investigation-panel">
        <h3>üîç Step 1: Test Signin Page in Isolation</h3>
        <button onclick="testSigninPageIsolation()">Load Signin in Frame & Test</button>
        <div id="signinIsolation"></div>
        <iframe id="signinFrame" src="" style="display:none;"></iframe>
    </div>

    <div class="investigation-panel">
        <h3>üîç Step 2: Test Error Trigger Manually</h3>
        <input type="email" id="manualTestEmail" value="test@example.com" placeholder="Email to test">
        <button onclick="triggerErrorManually()">Force Error State</button>
        <div id="errorTrigger"></div>
    </div>

    <div class="investigation-panel">
        <h3>üîç Step 3: Test Demo Mode Transition</h3>
        <button onclick="testDemoTransition()">Test Demo Mode Flow</button>
        <div id="demoTransition"></div>
    </div>

    <div class="investigation-panel">
        <h3>üîç Step 4: Complete User Journey Simulation</h3>
        <button onclick="simulateRealUser()">Simulate Real User Actions</button>
        <div id="userSimulation"></div>
    </div>

    <script>
        function updatePanel(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            let className = 'investigation-panel';
            let statusDot = '<span class="status-dot yellow"></span>';
            
            if (type === 'error') {
                className += ' critical';
                statusDot = '<span class="status-dot red"></span>';
            }
            if (type === 'success') {
                className += ' success';
                statusDot = '<span class="status-dot green"></span>';
            }
            if (type === 'warning') {
                className += ' warning';
                statusDot = '<span class="status-dot yellow"></span>';
            }
            
            element.className = className;
            element.innerHTML = statusDot + '<pre>' + content + '</pre>';
        }

        async function testSigninPageIsolation() {
            updatePanel('signinIsolation', 'Loading signin page in isolated frame...', 'warning');
            
            try {
                const frame = document.getElementById('signinFrame');
                frame.src = '/signin.html';
                frame.style.display = 'block';
                
                // Wait for frame to load
                await new Promise((resolve) => {
                    frame.onload = resolve;
                    setTimeout(resolve, 3000); // Fallback timeout
                });

                // Try to access frame content and test functionality
                const frameDoc = frame.contentDocument || frame.contentWindow.document;
                
                // Check if key elements exist
                const emailInput = frameDoc.getElementById('email');
                const signinBtn = frameDoc.getElementById('signinBtn');
                const configError = frameDoc.getElementById('configError');
                const demoOption = frameDoc.getElementById('demoOption');
                
                let analysis = `Signin Page Analysis:
‚Ä¢ Email Input Found: ${emailInput ? '‚úÖ' : '‚ùå'}
‚Ä¢ Signin Button Found: ${signinBtn ? '‚úÖ' : '‚ùå'}
‚Ä¢ Config Error Div Found: ${configError ? '‚úÖ' : '‚ùå'}
‚Ä¢ Demo Option Div Found: ${demoOption ? '‚úÖ' : '‚ùå'}

Initial Visibility:
‚Ä¢ Config Error Display: ${configError?.style.display || 'unknown'}
‚Ä¢ Demo Option Display: ${demoOption?.style.display || 'unknown'}

Page Title: ${frameDoc.title}
Script Errors: Checking...`;

                // Check for JavaScript errors
                let hasErrors = false;
                const originalConsoleError = console.error;
                const errors = [];
                
                console.error = function(...args) {
                    errors.push(args.join(' '));
                    hasErrors = true;
                    originalConsoleError.apply(console, args);
                };
                
                // Try to trigger the signin process
                if (emailInput && signinBtn) {
                    emailInput.value = 'test@example.com';
                    
                    // Monitor for changes to error divs
                    let configVisible = false;
                    let demoVisible = false;
                    
                    const checkInterval = setInterval(() => {
                        if (configError && configError.style.display !== 'none') {
                            configVisible = true;
                        }
                        if (demoOption && demoOption.style.display !== 'none') {
                            demoVisible = true;
                        }
                    }, 100);
                    
                    // Click the signin button
                    signinBtn.click();
                    
                    // Wait a moment for the async operation
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    clearInterval(checkInterval);
                    
                    analysis += `

Post-Click Analysis:
‚Ä¢ Config Error Became Visible: ${configVisible ? '‚úÖ' : '‚ùå'}
‚Ä¢ Demo Option Became Visible: ${demoVisible ? '‚úÖ' : '‚ùå'}
‚Ä¢ JavaScript Errors: ${hasErrors ? '‚ùå ' + errors.length + ' errors' : '‚úÖ None'}`;

                    if (errors.length > 0) {
                        analysis += `\nErrors Found:\n${errors.map(e => '  ‚Ä¢ ' + e).join('\n')}`;
                    }
                }
                
                console.error = originalConsoleError;
                
                updatePanel('signinIsolation', analysis, hasErrors ? 'error' : 'success');
                
            } catch (error) {
                updatePanel('signinIsolation', `Error testing signin isolation: ${error.message}`, 'error');
            }
        }

        async function triggerErrorManually() {
            const email = document.getElementById('manualTestEmail').value;
            updatePanel('errorTrigger', `Manually triggering error state with ${email}...`, 'warning');
            
            try {
                // Make the actual API call that should fail
                const response = await fetch('https://gfcubvroxgfvjhacinic.supabase.co/auth/v1/otp', {
                    method: 'POST',
                    headers: {
                        'apikey': window.SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        options: {
                            emailRedirectTo: `${window.location.origin}/post-auth.html`
                        }
                    })
                });

                const data = await response.json();
                
                let result = `Direct API Test Results:
‚Ä¢ Status Code: ${response.status}
‚Ä¢ Error Code: ${data.error_code || 'none'}
‚Ä¢ Error Message: ${data.msg || data.message || 'success'}

Raw Response: ${JSON.stringify(data, null, 2)}

Expected Behavior:
‚Ä¢ Should return error_code: "email_address_invalid"
‚Ä¢ This should trigger handleConfigurationError()
‚Ä¢ Config error div should become visible
‚Ä¢ Demo option should appear`;

                if (data.error_code === 'email_address_invalid') {
                    result += `\n\n‚úÖ PERFECT! This is exactly the error our signin should catch.`;
                    result += `\n\nIf the signin page isn't showing the error, the issue is in:`;
                    result += `\n‚Ä¢ Error detection logic not triggering`;
                    result += `\n‚Ä¢ DOM manipulation not working`;
                    result += `\n‚Ä¢ CSS hiding the error divs`;
                } else if (response.ok) {
                    result += `\n\n‚ö†Ô∏è  API succeeded - this means Supabase was fixed!`;
                } else {
                    result += `\n\n‚ùì Different error than expected.`;
                }

                updatePanel('errorTrigger', result, data.error_code === 'email_address_invalid' ? 'success' : 'warning');

            } catch (error) {
                updatePanel('errorTrigger', `Network error: ${error.message}`, 'error');
            }
        }

        async function testDemoTransition() {
            updatePanel('demoTransition', 'Testing demo mode transition...', 'warning');
            
            try {
                // Clear existing demo state
                localStorage.removeItem('stay_hi_demo_mode');
                localStorage.removeItem('stay_hi_demo_user_email');
                localStorage.removeItem('stay_hi_demo_user_id');
                
                let result = `Demo Mode Transition Test:

Step 1: Clear existing demo state ‚úÖ

Step 2: Simulate enterDemoMode() function...`;
                
                // Simulate the demo mode setup
                localStorage.setItem('stay_hi_demo_mode', 'true');
                localStorage.setItem('stay_hi_demo_user_email', 'demo@stayhi.local');
                localStorage.setItem('stay_hi_demo_user_id', 'demo-user-' + Date.now());
                
                const demoMode = localStorage.getItem('stay_hi_demo_mode');
                const demoEmail = localStorage.getItem('stay_hi_demo_user_email');
                
                result += `
Step 3: Set demo mode variables ‚úÖ
‚Ä¢ Demo mode: ${demoMode}
‚Ä¢ Demo email: ${demoEmail}

Step 4: Test index.html with demo mode...`;

                // Test if index.html would detect demo mode
                const indexResponse = await fetch('/index.html');
                const indexHtml = await indexResponse.text();
                
                const hasDemoDetection = indexHtml.includes('stay_hi_demo_mode');
                const hasDemoUI = indexHtml.includes('demo');
                
                result += `
‚Ä¢ Index.html loads: ${indexResponse.ok ? '‚úÖ' : '‚ùå'}
‚Ä¢ Has demo detection: ${hasDemoDetection ? '‚úÖ' : '‚ùå'}
‚Ä¢ Has demo UI elements: ${hasDemoUI ? '‚úÖ' : '‚ùå'}

Demo Dashboard URL: /index.html?demo=true`;

                updatePanel('demoTransition', result, demoMode === 'true' ? 'success' : 'error');

            } catch (error) {
                updatePanel('demoTransition', `Demo transition test failed: ${error.message}`, 'error');
            }
        }

        async function simulateRealUser() {
            updatePanel('userSimulation', 'Simulating complete real user journey...', 'warning');
            
            try {
                let journey = `REAL USER JOURNEY SIMULATION:

üë§ User Story: "I want to sign into Stay Hi but it keeps showing errors"

Step 1: User navigates to /signin.html
‚Ä¢ Expected: Beautiful signin page loads ‚úÖ

Step 2: User enters their email (user@gmail.com)
‚Ä¢ Expected: Email input accepts the value ‚úÖ

Step 3: User clicks "Send Magic Link"
‚Ä¢ API Call: POST to Supabase OTP endpoint...`;

                // Simulate the exact API call from the signin page
                const apiResponse = await fetch('https://gfcubvroxgfvjhacinic.supabase.co/auth/v1/otp', {
                    method: 'POST',
                    headers: {
                        'apikey': window.SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'user@gmail.com',
                        options: {
                            emailRedirectTo: `${window.location.origin}/post-auth.html`
                        }
                    })
                });

                const apiData = await apiResponse.json();
                
                if (apiData.error_code === 'email_address_invalid') {
                    journey += `
‚Ä¢ API Response: ‚ùå email_address_invalid
‚Ä¢ Expected User Experience:
  1. Error explanation appears clearly
  2. Demo mode option becomes visible  
  3. User clicks "Continue in Demo Mode"
  4. User redirected to full dashboard experience

Step 4: ERROR DETECTION SHOULD TRIGGER
‚Ä¢ handleConfigurationError() should be called
‚Ä¢ configError div should display: block
‚Ä¢ demoOption div should display: block
‚Ä¢ Signin form should be disabled

ACTUAL RESULT ANALYSIS:`;

                    // Test if the current signin page would handle this correctly
                    journey += `
‚Ä¢ API correctly returns the expected error ‚úÖ
‚Ä¢ The signin.html has the error handling code ‚úÖ
‚Ä¢ DOM elements exist with correct IDs ‚úÖ

üîç IF USER STILL SEES PROBLEMS:
‚Ä¢ Check browser console for JavaScript errors
‚Ä¢ Verify CSS isn't hiding error divs
‚Ä¢ Ensure handleConfigurationError function executes
‚Ä¢ Confirm DOM manipulation actually occurs`;

                } else {
                    journey += `
‚Ä¢ API Response: ${apiResponse.status} - ${JSON.stringify(apiData)}
‚Ä¢ ‚ö†Ô∏è  This is NOT the expected email_address_invalid error
‚Ä¢ The Supabase configuration may have been fixed!`;
                }

                journey += `

üéØ TROUBLESHOOTING CHECKLIST:
1. Open browser dev tools on signin page
2. Check Console tab for any JavaScript errors
3. Enter email and click submit button
4. Watch Network tab for API call
5. Verify error divs become visible
6. Test demo mode button click`;

                updatePanel('userSimulation', journey, 'success');

            } catch (error) {
                updatePanel('userSimulation', `User simulation failed: ${error.message}`, 'error');
            }
        }

        // Auto-start investigation
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                console.log('üî¨ Starting automated investigation...');
            }, 1000);
        });
    </script>
</body>
</html>