<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Setup Diagnostic</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.81.1/dist/umd/supabase.min.js"></script>
  <style>
    body { 
      font-family: -apple-system, system-ui, sans-serif; 
      max-width: 800px; 
      margin: 40px auto; 
      padding: 20px;
      background: #0f172a;
      color: #e2e8f0;
    }
    .status { 
      padding: 16px; 
      margin: 12px 0; 
      border-radius: 8px;
      border-left: 4px solid;
    }
    .success { background: rgba(16, 185, 129, 0.1); border-color: #10b981; }
    .error { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; }
    .warning { background: rgba(245, 158, 11, 0.1); border-color: #f59e0b; }
    .info { background: rgba(59, 130, 246, 0.1); border-color: #3b82f6; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 8px 4px;
    }
    button:hover { background: #2563eb; }
    pre { 
      background: #1e293b; 
      padding: 12px; 
      border-radius: 6px; 
      overflow-x: auto;
      font-size: 13px;
    }
    h2 { color: #60a5fa; margin-top: 32px; }
  </style>
</head>
<body>
  <h1>üîê Admin Setup Diagnostic</h1>
  <p>This page will help diagnose and fix admin access issues.</p>

  <div id="output"></div>

  <h2>Actions</h2>
  <button onclick="checkStatus()">üîç Check Current Status</button>
  <button onclick="addMeAsAdmin()">‚ûï Add Me as Super Admin</button>
  <button onclick="testAdminRPC()">üß™ Test Admin RPC</button>
  <button onclick="clearCache()">üóëÔ∏è Clear Admin Cache</button>

  <script>
    const SUPABASE_URL = 'https://gfcubvroxgfvjhacinic.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmY3VidnJveGdmdmpoYWNpbmljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MTIyNjYsImV4cCI6MjA3NDQ4ODI2Nn0.5IlxofMPFNdKsEueM_dhgsJP9wI-GnZRUM9hfR0zE1g';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const output = document.getElementById('output');

    function log(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = msg;
      output.appendChild(div);
    }

    async function checkStatus() {
      output.innerHTML = '';
      log('üîç Checking authentication status...', 'info');

      try {
        // Check session
        const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
        if (sessionError || !sessionData.session) {
          log('‚ùå Not signed in. Please <a href="signin.html" style="color:#60a5fa">sign in first</a>', 'error');
          return;
        }

        const user = sessionData.session.user;
        log(`‚úÖ Signed in as: <strong>${user.email}</strong><br>User ID: <code>${user.id}</code>`, 'success');

        // Check admin_roles table
        log('üîç Checking admin_roles table...', 'info');
        const { data: adminRoles, error: rolesError } = await supabase
          .from('admin_roles')
          .select('*')
          .eq('email', user.email);

        if (rolesError) {
          log(`‚ö†Ô∏è Error querying admin_roles: ${rolesError.message}`, 'warning');
          log(`This might mean the table doesn't exist or RLS is blocking. Check Supabase dashboard.`, 'warning');
          return;
        }

        if (!adminRoles || adminRoles.length === 0) {
          log(`‚ùå You are NOT in the admin_roles table<br>Email: ${user.email}<br>Click "Add Me as Super Admin" below to fix this.`, 'error');
          return;
        }

        const role = adminRoles[0];
        log(`‚úÖ Found admin role:<br><pre>${JSON.stringify(role, null, 2)}</pre>`, 'success');

        if (!role.is_active) {
          log('‚ö†Ô∏è Role exists but is_active = false. Need to activate it.', 'warning');
        }

      } catch (err) {
        log(`‚ùå Error: ${err.message}`, 'error');
      }
    }

    async function addMeAsAdmin() {
      output.innerHTML = '';
      log('‚ûï Adding you as super admin...', 'info');

      try {
        const { data: sessionData } = await supabase.auth.getSession();
        if (!sessionData.session) {
          log('‚ùå Not signed in', 'error');
          return;
        }

        const user = sessionData.session.user;
        
        // Try to insert
        const { data, error } = await supabase
          .from('admin_roles')
          .insert({
            user_id: user.id,
            email: user.email,
            role_type: 'super_admin',
            created_by: user.id,
            is_active: true
          })
          .select();

        if (error) {
          log(`‚ö†Ô∏è Insert failed: ${error.message}`, 'warning');
          log(`You might need to run this SQL in Supabase Dashboard:<br><pre>INSERT INTO admin_roles (user_id, email, role_type, created_by, is_active)
VALUES ('${user.id}', '${user.email}', 'super_admin', '${user.id}', true)
ON CONFLICT (user_id) DO UPDATE SET is_active = true, role_type = 'super_admin';</pre>`, 'info');
          return;
        }

        log(`‚úÖ Successfully added as super admin!<br><pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
        log('Now try accessing Mission Control again', 'success');

      } catch (err) {
        log(`‚ùå Error: ${err.message}`, 'error');
      }
    }

    async function testAdminRPC() {
      output.innerHTML = '';
      log('üß™ Testing check_admin_access_v2 RPC...', 'info');

      try {
        const { data, error } = await supabase.rpc('check_admin_access_v2', {
          p_required_role: 'admin',
          p_ip_address: null
        });

        if (error) {
          log(`‚ùå RPC Error: ${error.message}`, 'error');
          return;
        }

        log(`RPC Response:<br><pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');

        const row = Array.isArray(data) ? data[0] : data;
        const granted = (typeof data === 'boolean' && data === true) || row?.access_granted || row?.has_access;

        if (granted) {
          log('‚úÖ Admin access GRANTED! You should be able to access Mission Control.', 'success');
        } else {
          log(`‚ùå Admin access DENIED<br>Reason: ${row?.reason || 'unknown'}`, 'error');
        }

      } catch (err) {
        log(`‚ùå Error: ${err.message}`, 'error');
      }
    }

    function clearCache() {
      try {
        localStorage.removeItem('hi_admin_state');
        sessionStorage.removeItem('hi_admin_access');
        sessionStorage.removeItem('hi_admin_redirect_done');
        log('‚úÖ Cleared admin cache. Refresh the page and try Mission Control again.', 'success');
      } catch (err) {
        log(`‚ùå Error clearing cache: ${err.message}`, 'error');
      }
    }

    // Auto-run status check on load
    setTimeout(checkStatus, 500);
  </script>
</body>
</html>
