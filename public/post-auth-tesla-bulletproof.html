<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Signing you in… — Stay Hi</title>
  <meta name="robots" content="noindex" />
  <link rel="stylesheet" href="assets/create-parity.css" />
  <style>
    /* Tesla-Grade Gold Standard Auth Processing UI */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      min-height: 100vh;
      display: grid;
      place-items: center;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #0F0F23 0%, #1A1A2E 25%, #16213E 50%, #2D1B69 75%, #4A1A40 100%);
      background-size: 400% 400%;
      animation: gradientFlow 15s ease infinite;
      color: white;
      overflow-x: hidden;
    }
    
    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .box {
      max-width: 480px;
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.3),
        0 10px 25px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      padding: 40px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.8), transparent);
      animation: shimmer 2s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
    
    .row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 8px;
    }
    
    .spin {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top-color: #FFD700;
      border-right-color: #4ECDC4;
      border-radius: 50%;
      animation: teslaSpinner 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      position: relative;
    }
    
    .spin::after {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes teslaSpinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.8; }
    }
    
    .ok {
      font-size: 24px;
      font-weight: 700;
      color: #22c55e;
      margin-bottom: 12px;
      text-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);
    }
    
    .err {
      font-size: 24px;
      font-weight: 700;
      color: #ef4444;
      margin-bottom: 12px;
      text-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
    }
    
    .muted {
      color: rgba(255, 255, 255, 0.7);
      font-size: 16px;
      line-height: 1.5;
    }
    
    .debug-info {
      margin-top: 20px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      text-align: left;
      font-size: 12px;
      font-family: monospace;
      color: rgba(255, 255, 255, 0.6);
      max-height: 200px;
      overflow-y: auto;
    }
    
    .retry-btn {
      background: linear-gradient(135deg, #4ECDC4, #44A08D);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s ease;
    }
    
    .retry-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(78, 205, 196, 0.3);
    }
  </style>
</head>
<body>
  <div class="box">
    <!-- Processing State -->
    <div id="working" style="display: block;">
      <div class="row">
        <div class="spin"></div>
        <div>Completing authentication…</div>
      </div>
      <p class="muted">Please wait while we finalize your login.</p>
    </div>

    <!-- Success State -->
    <div id="done" style="display: none;">
      <div class="ok">Authentication Complete</div>
      <p class="muted">Redirecting to your personalized profile…</p>
    </div>

    <!-- Error State -->
    <div id="oops" style="display: none;">
      <div class="err">Authentication Failed</div>
      <p class="muted" id="oopsMsg">Something went wrong during sign-in.</p>
      <button class="retry-btn" onclick="retryAuth()">Try Again</button>
      <div class="debug-info" id="debugInfo" style="display: none;"></div>
    </div>
  </div>

  <!-- Tesla-Grade Bulletproof Authentication Processing -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
  // Tesla-grade configuration - self-contained, no external dependencies
  const CONFIG = {
    SUPABASE_URL: 'https://gfcubvroxgfvjhacinic.supabase.co',
    SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmY3VidnJveGdmdmpoYWNpbmljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MTIyNjYsImV4cCI6MjA3NDQ4ODI2Nn0.5IlxofMPFNdKsEueM_dhgsJP9wI-GnZRUM9hfR0zE1g'
  };
  
  // Global state
  let supabaseClient = null;
  let debugLog = [];

  // Tesla-grade logging with visual feedback
  function log(message, level = 'info') {
    const timestamp = new Date().toISOString();
    const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
    debugLog.push(logEntry);
    console.log(logEntry);
    
    // Update debug info if visible
    const debugDiv = document.getElementById('debugInfo');
    if (debugDiv && debugDiv.style.display !== 'none') {
      debugDiv.textContent = debugLog.join('\n');
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }
  }

  // Bulletproof Supabase initialization
  async function initializeSupabase() {
    try {
      log('Initializing Supabase client', 'info');
      
      if (!window.supabase) {
        throw new Error('Supabase library not loaded');
      }

      supabaseClient = window.supabase.createClient(
        CONFIG.SUPABASE_URL,
        CONFIG.SUPABASE_ANON_KEY,
        {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            flowType: 'pkce'
          }
        }
      );

      log('Supabase client initialized successfully', 'info');
      return true;

    } catch (error) {
      log(`Supabase initialization failed: ${error.message}`, 'error');
      return false;
    }
  }

  // Utility functions
  const $ = (selector) => document.querySelector(selector);
  const go = (path) => {
    log(`Redirecting to: ${path}`, 'info');
    // Ensure path is safe and relative
    if (!path.startsWith('http') && !path.includes('..')) {
      const cleanPath = path.replace(/^\/+/, '');
      window.location.href = cleanPath;
    } else {
      window.location.href = 'index.html';
    }
  };

  // Parse tokens from URL hash (magic link format)
  function tokensFromHash() {
    if (!location.hash) return null;
    try {
      const h = new URLSearchParams(location.hash.replace(/^#/, ''));
      const access_token = h.get('access_token');
      const refresh_token = h.get('refresh_token');
      if (access_token && refresh_token) return { access_token, refresh_token };
    } catch (error) {
      log(`Error parsing hash tokens: ${error.message}`, 'error');
    }
    return null;
  }

  // Parse OAuth parameters from URL search
  function oauthFromSearch() {
    try {
      const params = new URLSearchParams(location.search);
      const code = params.get('code');
      const error = params.get('error');
      const error_description = params.get('error_description');
      
      return { code, error, error_description };
    } catch (error) {
      log(`Error parsing search params: ${error.message}`, 'error');
      return {};
    }
  }

  // Show error with detailed information
  function showError(message, details = '') {
    log(`Authentication error: ${message}`, 'error');
    
    $('#working').style.display = 'none';
    $('#done').style.display = 'none';
    $('#oops').style.display = 'block';
    
    $('#oopsMsg').textContent = message;
    
    if (details) {
      log(`Error details: ${details}`, 'error');
    }
  }

  // Show success and redirect
  function showSuccess(redirectPath = 'index.html') {
    log('Authentication successful', 'info');
    
    $('#working').style.display = 'none';
    $('#oops').style.display = 'none';
    $('#done').style.display = 'block';
    
    // Redirect after showing success message
    setTimeout(() => go(redirectPath), 1200);
  }

  // Retry authentication
  function retryAuth() {
    log('Retrying authentication process', 'info');
    
    $('#oops').style.display = 'none';
    $('#working').style.display = 'block';
    
    // Clear debug log and restart
    debugLog = [];
    setTimeout(finishAuth, 500);
  }

  // Main authentication processing function
  async function finishAuth() {
    try {
      log('Starting Tesla-grade authentication process', 'info');

      // Initialize Supabase client
      const initialized = await initializeSupabase();
      if (!initialized) {
        showError('Failed to initialize authentication system');
        return;
      }

      // Analyze URL parameters
      const oauthParams = oauthFromSearch();
      const tokens = tokensFromHash();
      
      log(`OAuth params: code=${!!oauthParams.code}, error=${oauthParams.error || 'none'}`, 'info');
      log(`Magic link tokens: ${tokens ? 'present' : 'none'}`, 'info');

      // Handle OAuth errors first
      if (oauthParams.error) {
        const errorMsg = oauthParams.error_description || oauthParams.error;
        showError(`Authentication failed: ${errorMsg}`);
        return;
      }

      // Step 1: Try OAuth code exchange (PKCE flow)
      if (oauthParams.code) {
        log('Attempting OAuth code exchange', 'info');
        try {
          const codeResult = await supabaseClient.auth.exchangeCodeForSession(window.location.href);
          if (codeResult.error) {
            log(`Code exchange failed: ${codeResult.error.message}`, 'error');
          } else {
            log('Code exchange successful', 'info');
          }
        } catch (codeError) {
          log(`Code exchange exception: ${codeError.message}`, 'error');
        }
      }

      // Step 2: Try magic link token setting (legacy flow)
      if (tokens) {
        log('Attempting magic link token session', 'info');
        try {
          const tokenResult = await supabaseClient.auth.setSession(tokens);
          if (tokenResult.error) {
            log(`Token session failed: ${tokenResult.error.message}`, 'error');
          } else {
            log('Token session successful', 'info');
            // Clear tokens from URL for security
            history.replaceState({}, document.title, location.pathname + location.search);
          }
        } catch (tokenError) {
          log(`Token session exception: ${tokenError.message}`, 'error');
        }
      }

      // Step 3: Check for active session
      log('Checking for active session', 'info');
      const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
      
      if (sessionError) {
        log(`Session check error: ${sessionError.message}`, 'error');
        showError('Session validation failed', sessionError.message);
        return;
      }

      if (!session) {
        log('No active session found after authentication attempts', 'error');
        showError('Authentication failed - no valid session created');
        return;
      }

      log(`User authenticated: ${session.user.email}`, 'info');

      // Step 4: Optional membership check (non-blocking)
      try {
        log('Checking membership status', 'info');
        const { data: user } = await supabaseClient.auth.getUser();
        if (user?.user?.id) {
          const { data: membership, error: memberError } = await supabaseClient
            .from('memberships')
            .select('expires_at')
            .eq('user_id', user.user.id)
            .gt('expires_at', new Date().toISOString())
            .limit(1)
            .maybeSingle();
          
          if (memberError) {
            log(`Membership check error (non-critical): ${memberError.message}`, 'warning');
          } else {
            const hasMembership = !!membership;
            localStorage.setItem('hi_member', hasMembership ? '1' : '0');
            log(`Membership status: ${hasMembership ? 'active' : 'none'}`, 'info');
          }
        }
      } catch (membershipError) {
        log(`Membership check failed (non-critical): ${membershipError.message}`, 'warning');
      }

      // Step 5: Determine redirect destination
      const nextParam = new URLSearchParams(location.search).get('next');
      const redirectPath = nextParam && !nextParam.startsWith('http') && !nextParam.includes('..') 
        ? nextParam.replace(/^\/+/, '') 
        : 'index.html';

      log(`Redirecting to: ${redirectPath}`, 'info');
      showSuccess(redirectPath);

    } catch (error) {
      log(`Authentication process failed: ${error.message}`, 'error');
      showError('Authentication system error', error.message);
    }
  }

  // Toggle debug info visibility
  function toggleDebug() {
    const debugDiv = document.getElementById('debugInfo');
    if (debugDiv.style.display === 'none') {
      debugDiv.style.display = 'block';
      debugDiv.textContent = debugLog.join('\n');
      debugDiv.scrollTop = debugDiv.scrollHeight;
    } else {
      debugDiv.style.display = 'none';
    }
  }

  // Handle file:// protocol for local development
  if (location.protocol === 'file:') {
    log('Local file development mode detected', 'info');
    localStorage.setItem('hi_dev_user', 'dev@example.com');
    go('index.html');
  } else {
    // Production mode - wait for DOM and start authentication
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', finishAuth);
    } else {
      finishAuth();
    }
  }

  // Add debug info toggle on triple-click
  document.addEventListener('click', (event) => {
    if (event.detail === 3) {
      toggleDebug();
    }
  });

  // Global error handlers
  window.addEventListener('error', (event) => {
    log(`Global JavaScript error: ${event.error?.message || event.message}`, 'error');
  });

  window.addEventListener('unhandledrejection', (event) => {
    log(`Unhandled promise rejection: ${event.reason}`, 'error');
  });
  </script>
</body>
</html>