<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Signing you in… — Stay Hi</title>
  <meta name="robots" content="noindex" />
  <link rel="stylesheet" href="assets/create-parity.css" />
  <style>
    body{min-height:100vh;display:grid;place-items:center;background:linear-gradient(135deg,#F5A623 0%,#FFC107 100%)}
    .box{max-width:560px;width:92vw;background:#FFFDF9;border:1px solid #eee;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:22px}
    .row{display:flex;align-items:center;gap:12px}
    .spin{width:18px;height:18px;border:3px solid #eee;border-top-color:#006400;border-radius:50%;animation:sp 800ms linear infinite}
    @keyframes sp{to{transform:rotate(1turn)}}
    .muted{color:#666}
    .ok{color:#0b6a2b}
    .err{color:#8b0000}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:1px solid #e4e4e4;background:#fff;font-weight:700;cursor:pointer}
  </style>
</head>
<body>

  <main class="box" role="main">
    <div id="working" class="row">
      <div class="spin" aria-hidden="true"></div>
      <div>
        <div style="font-weight:800">Finishing sign-in…</div>
        <div class="muted" id="sub">One moment while we set your session.</div>
      </div>
    </div>

    <div id="done" style="display:none">
      <div style="font-weight:800" class="ok">Signed in ✔</div>
      <p class="muted">Taking you back to Home…</p>
      <button class="btn" onclick="go('/')">Go now</button>
    </div>

    <div id="oops" style="display:none">
      <div style="font-weight:800" class="err">Couldn’t complete sign-in</div>
      <p class="muted" id="oopsMsg">The link may be expired. You can request a new one.</p>
      <div class="row" style="gap:8px">
        <button class="btn" onclick="go('signin.html')">Back to Sign in</button>
        <button class="btn" onclick="go('/')">Home</button>
      </div>
    </div>
  </main>

  <!-- Use unified Supabase client -->
  <script src="assets/supabase-init.js"></script>
  <script>
  // Wait for Supabase client to be ready
  let supabase;
  
  function waitForSupabase() {
    return new Promise((resolve) => {
      if (window.sb) {
        supabase = window.sb;
        resolve();
      } else {
        window.addEventListener('supabase-ready', () => {
          supabase = window.sb;
          resolve();
        });
      }
    });
  }

  const $ = (s)=>document.querySelector(s);
  const go = (p)=>{ window.location.href = p; };

  // Utility: parse tokens from hash (older magic-link format)
  function tokensFromHash() {
    if (!location.hash) return null;
    const h = new URLSearchParams(location.hash.replace(/^#/, ''));
    const access_token = h.get('access_token');
    const refresh_token = h.get('refresh_token');
    if (access_token && refresh_token) return { access_token, refresh_token };
    return null;
  }

  async function finishAuth() {
    try {
      // 1) OAuth/code flow (safe to call even if no code present)
      await supabase.auth.exchangeCodeForSession(window.location.href).catch(()=>{});

      // 2) Magic link with tokens in URL hash (older / email magic-link)
      const t = tokensFromHash();
      if (t) {
        await supabase.auth.setSession(t);
        // scrub tokens from the URL
        history.replaceState({}, document.title, location.pathname);
      }

      // 3) Do we have a session now?
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error('No active session');

      // Optional: quick membership look (non-blocking). You set this table in Step 2.
      try {
        const { data: me } = await supabase.auth.getUser();
        if (me?.user?.id) {
          const { data: rows } = await supabase
            .from('memberships')
            .select('expires_at')
            .eq('user_id', me.user.id)
            .gt('expires_at', new Date().toISOString())
            .limit(1)
            .maybeSingle();
          // cache a tiny flag for the UI; your app can read this.
          localStorage.setItem('hi_member', rows ? '1' : '0');
        }
      } catch(_) {}

      // Success UI + redirect
      $('#working').style.display = 'none';
      $('#done').style.display = 'block';
      setTimeout(()=>go('index.html'), 900);
    } catch (err) {
      console.error(err);
      $('#working').style.display = 'none';
      $('#oopsMsg').textContent = err.message || 'Something went wrong.';
      $('#oops').style.display = 'block';
    }
  }

  // If opened as file:// during local build, allow you to pass through
  if (location.protocol === 'file:') {
    localStorage.setItem('hi_dev_user', 'dev@example.com');
    go('index.html');
  } else {
    // Wait for Supabase to be ready before finishing auth
    waitForSupabase().then(() => {
      finishAuth();
    });
  }
  </script>
</body>
</html>
