<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Stay Hi ‚Äî Today</title>

  <!-- Brand + shared styles -->
  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>

  <style>
    /* Layout */
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .center{display:grid;place-items:center}
    .spaced{display:flex;flex-direction:column;align-items:center;gap:12px}

    /* 7-day strip */
    .weekstrip{display:flex;gap:10px;justify-content:center;margin:10px 0 14px}
    .weekdot{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:40px}
    .weekdot .lbl{font-size:11px;opacity:.85;color:#cfd2ea}
    .weekdot .c{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;border:1px solid #2a2e55;color:#cfd2ea}
    .weekdot .c.met{background:linear-gradient(135deg, #ffd166, #ff7a18); color:#111; border-color:#0000}

    /* Hi medallion */
    .hi-medal{
      width:min(360px,72vw); aspect-ratio:1/1; border-radius:999px;
      background:#0f1022; border:1px solid #23264d; box-shadow:0 14px 40px rgba(0,0,0,.35);
      position:relative; overflow:hidden;
    }
    /* inner glow rings */
    .hi-medal::before, .hi-medal::after{
      content:""; position:absolute; inset:10%; border-radius:50%;
      border:10px solid #1d2242;
    }
    .hi-medal::after{ inset:22% }
    /* Hi logo */
    .hi-logo{
      position:absolute; inset:0; display:grid; place-items:center;
      font-weight:900; font-size:clamp(42px, 8vw, 72px);
      color:#ffffff; text-shadow:0 2px 0 #ffffff20;
      letter-spacing:.5px;
    }
    .hi-logo .hand{
      position:absolute; top:16px; left:50%; transform:translateX(-50%);
      background:#fff; color:#111; border:1px solid var(--hi-border);
      padding:6px 12px; border-radius:999px; font-weight:800; font-size:14px;
      box-shadow:0 6px 16px rgba(0,0,0,.25)
    }

    /* Counters row */
    .counters{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:6px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #2a2e55;background:#0f1228;color:#cfd2ea;font-weight:800}

    /* Actions */
    .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px}

    /* Share sheet (reused from muscle page style) */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:50}
    .sheet{position:fixed;left:0;right:0;bottom:-100%;background:var(--hi-bg);border-radius:18px 18px 0 0;border:1px solid var(--hi-border);padding:16px 14px;z-index:60;box-shadow:0 -10px 30px rgba(0,0,0,.12)}
    .sheet.show + .sheet-backdrop{display:block}
    .sheet.show{animation:sheetIn .25s ease-out forwards}
    .sheet.hide{animation:sheetOut .2s ease-in forwards}
    @keyframes sheetIn{from{bottom:-100%}to{bottom:0}}
    @keyframes sheetOut{from{bottom:0}to{bottom:-100%}}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;flex-wrap:wrap}
    .switch{position:relative;width:44px;height:26px;background:#e8e8e8;border-radius:999px;cursor:pointer;border:1px solid var(--hi-border)}
    .knob{position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.2);transition:left .15s}
    .switch.on{background:#0a8a3a;border-color:#0a8a3a}
    .switch.on .knob{left:22px}
    .field{display:flex;gap:8px;align-items:center;border:1px solid var(--hi-border);border-radius:12px;padding:8px 10px;background:#fff}
    .field input{border:0;outline:0;width:100%;font:inherit}
    textarea{width:100%;border:1px solid var(--hi-border);border-radius:12px;min-height:100px;padding:12px;font:inherit;background:#fff;color:var(--hi-ink)}
    .muted{color:var(--hi-muted)}

    /* Announcement bar */
    .announce{display:none;align-items:center;gap:8px;justify-content:center;margin:8px auto 6px}
    .announce .txt{display:flex;align-items:center;gap:10px;font-weight:800;color:#e8ebff}
    .badge{display:inline-flex;align-items:center;gap:6px;font-weight:800;font-size:.75rem;padding:.25rem .5rem;border-radius:999px;background:#111;color:#fff}
    .marquee{display:block;overflow:hidden;white-space:nowrap}
    .marquee span{display:inline-block;animation:mar 14s linear infinite}
    @keyframes mar{from{transform:translateX(0)}to{transform:translateX(-50%)}}
  </style>
</head>
<body class="sunrise" data-tab="today">
  <!-- Header -->
  <header id="app-header" class="header"></header>

  <!-- Announcement rotator -->
  <div id="announceWrap" class="announce">
    <div id="announceTxt" class="txt"></div>
  </div>

  <main class="wrap">
    <!-- 7-day strip -->
    <div id="weekStrip" class="weekstrip" aria-label="Your week"></div>

    <!-- Card -->
    <section class="panel center" aria-label="Hi panel" style="padding:18px">
      <div class="spaced" style="width:100%">
        <!-- Hi medallion -->
        <div class="hi-medal" style="margin:0 auto">
          <div class="hi-logo">
            <div class="hand">üëã Global Hi-5</div>
            <div>Hi</div>
          </div>
        </div>

        <!-- Counters -->
        <div class="counters">
          <span class="pill">Today <b id="todayCount">0</b></span>
          <span class="pill">Streak <b id="streakLen">0</b> üî•</span>
          <span class="pill">Total Hi-5s <b id="totalCount">0</b></span>
        </div>

        <!-- Primary action -->
        <div class="actions">
          <button id="hiBtn" class="hi-btn hi-btn--primary" style="min-width:280px">Self Hi-5</button>
        </div>
      </div>
    </section>

    <!-- Links -->
    <div class="center" style="margin-top:10px">
      <a class="hi-btn hi-btn--ghost" href="hi-island.html">Go to Hi Island</a>
    </div>
  </main>

  <!-- Share Sheet -->
  <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" aria-hidden="true">
    <h3 id="sheetTitle">Want to capture this Hi moment?</h3>
    <p class="muted">We‚Äôll always save a private copy in <b>My Archive</b>. You can also share to the public feed.</p>

    <div class="row" style="margin-top:6px">
      <div>
        <div style="font-weight:800">Show on Hi Island</div>
        <div class="muted">Appear in the global General Shares feed</div>
      </div>
      <div id="togglePublic" class="switch on" role="switch" aria-checked="true" tabindex="0"><div class="knob" aria-hidden="true"></div></div>
    </div>

    <div class="row">
      <div>
        <div style="font-weight:800">Post as Anonymous</div>
        <div class="muted">Your name becomes ‚ÄúHi Friend‚Äù</div>
      </div>
      <div id="toggleAnon" class="switch" role="switch" aria-checked="false" tabindex="0"><div class="knob" aria-hidden="true"></div></div>
    </div>

    <div class="field" aria-label="Optional location">
      <span>üìç</span><input id="locationInput" placeholder="City, State (optional)"/>
    </div>

    <div style="margin-top:8px">
      <textarea id="journal" maxlength="500" placeholder="What was the Hi moment you just noticed? (1‚Äì2 lines)"></textarea>
    </div>

    <div class="row" style="justify-content:flex-end">
      <button id="cancelShare" class="hi-btn hi-btn--ghost">Not now</button>
      <button id="confirmShare" class="hi-btn hi-btn--primary">Save / Share</button>
    </div>
  </div>
  <div id="backdrop" class="sheet-backdrop" aria-hidden="true"></div>

  <!-- toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- scripts (order matters) -->
  <script src="assets/supabase-init.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/db.js"></script>
  <script src="assets/header.js" defer></script>

  <script>
  (async function(){
    // Allow signed-out usage; hiDB will queue if offline/no session
    try { await hiAuth.ensureSessionMaybe?.(); } catch {}

    /* ===============================
       Storage keys & helpers
       =============================== */
    const LS = {
      hist: 'hi5.history',     // map yyyy-mm-dd -> count
      total:'hi5.total',        // total count
      last :'hi5.lastDate',     // last day we pressed
      streak:'hi5.streak',      // current streak length
      gFive:'hi.globalFives',   // local global Hi-5 (cosmetic)
      gStart:'hi.globalStarts'  // (kept for rotator balance)
    };
    const read=(k,def)=>{ try{ const v=localStorage.getItem(k); return v==null?def:JSON.parse(v) }catch{ return def } };
    const write=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} };
    const todayKey=(d=new Date())=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const weekStartMonday=(d=new Date())=>{const x=new Date(d);const day=(x.getDay()+6)%7;x.setDate(x.getDate()-day);x.setHours(0,0,0,0);return x};

    /* ===============================
       State
       =============================== */
    let history = read(LS.hist, {});
    let total   = Number(read(LS.total, 0)) || 0;
    let streak  = Number(read(LS.streak, 0)) || 0;
    let lastDay = read(LS.last, '');

    let gFives  = Number(localStorage.getItem(LS.gFive)  || 0) || 0;
    let gStarts = Number(localStorage.getItem(LS.gStart) || 0) || 0; // not used but keeps banner format

    /* ===============================
       Elements
       =============================== */
    const todayCount = document.getElementById('todayCount');
    const streakLen  = document.getElementById('streakLen');
    const totalCount = document.getElementById('totalCount');
    const weekStrip  = document.getElementById('weekStrip');
    const hiBtn      = document.getElementById('hiBtn');

    const sheet      = document.getElementById('sheet');
    const backdrop   = document.getElementById('backdrop');
    const togglePublic = document.getElementById('togglePublic');
    const toggleAnon   = document.getElementById('toggleAnon');
    const locationInput= document.getElementById('locationInput');
    const journal      = document.getElementById('journal');
    const cancelShare  = document.getElementById('cancelShare');
    const confirmShare = document.getElementById('confirmShare');

    const toastEl   = document.getElementById('toast');
    const announceWrap=document.getElementById('announceWrap');
    const announceTxt =document.getElementById('announceTxt');

    /* ===============================
       UI helpers
       =============================== */
    function toast(msg, ttl=1400){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ttl); }

    function setSwitch(el, on){ el.classList.toggle('on', !!on); el.setAttribute('aria-checked', on?'true':'false'); }
    function getSwitch(el){ return el.classList.contains('on'); }
    [togglePublic, toggleAnon].forEach(sw=>{
      sw.addEventListener('click', ()=> setSwitch(sw, !getSwitch(sw)));
      sw.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); setSwitch(sw,!getSwitch(sw)); }});
    });

    function openSheet(){ sheet.classList.remove('hide'); sheet.classList.add('show'); sheet.setAttribute('aria-hidden','false'); backdrop.style.display='block'; }
    function closeSheet(){ sheet.classList.remove('show'); sheet.classList.add('hide'); sheet.setAttribute('aria-hidden','true'); setTimeout(()=>backdrop.style.display='none', 180); }
    backdrop.addEventListener('click', closeSheet);
    cancelShare.addEventListener('click', closeSheet);

    /* ===============================
       Week strip / counters
       =============================== */
    function renderWeekStrip(){
      weekStrip.innerHTML='';
      const start=weekStartMonday(new Date());
      for(let i=0;i<7;i++){
        const d=new Date(start); d.setDate(start.getDate()+i);
        const k=todayKey(d); const done=(history[k]||0) >= 1;
        const lbl=d.toLocaleDateString(undefined,{weekday:'short'}).toUpperCase();
        const el=document.createElement('div'); el.className='weekdot';
        el.innerHTML=`<div class="lbl">${lbl}</div><div class="c ${done?'met':''}">${done?'‚úì':'‚óã'}</div>`;
        weekStrip.appendChild(el);
      }
    }
    function renderCounters(){
      todayCount.textContent = Number(history[todayKey()]||0);
      streakLen.textContent  = streak;
      totalCount.textContent = total;
    }

    /* ===============================
       Rotator
       =============================== */
    function dailyHiNote(date=new Date()){
      const key=`${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
      let h=0; for(let i=0;i<key.length;i++) h=(h*31+key.charCodeAt(i))|0;
      const pick=arr=>arr[Math.abs(h++%arr.length)];
      const verbs=["Carry your Hi","Choose Hi","Breathe Hi","Start with Hi","Move Hi","Speak Hi","Believe in Hi","Aim Hi","Soar Hi","Flow Hi","Shine Hi","Rise Hi"];
      const closers=["‚Äî small Hi‚Äôs change big days.","and let courage follow.","and let kindness ripple.","and brighten a corner.","and pass a Hi forward."];
      return `${pick(verbs)} ${pick(closers)}`;
    }
    let rotT, rotIdx=0, notes=[];
    function setRot(i){
      if(!notes.length){ announceWrap.style.display='none'; return; }
      rotIdx = i % notes.length;
      const n = notes[rotIdx];
      announceWrap.style.display='flex';
      if(n.type==='note'){
        const text=n.text;
        const dur = Math.min(22, Math.max(10, text.length/7));
        announceTxt.innerHTML = `<span class="badge">NOTE</span><div class="marquee" style="--marquee-dur:${dur}s"><span>${text}&nbsp;&nbsp;&nbsp;</span></div>`;
      }else{
        announceTxt.innerHTML = `<span class="badge">${n.type==='starts'?'STARTS':'HI'}</span>${n.text}`;
      }
    }
    function updateRotator(){
      notes = [
        {type:'starts', text:`üèÅ Global Hi Starts: ${gStarts.toLocaleString()}`},
        {type:'global', text:`üåç Global Hi-5s: ${gFives.toLocaleString()}`},
        {type:'note',   text:`üí° ${dailyHiNote()}`}
      ];
      setRot(rotIdx);
      clearInterval(rotT);
      rotT = setInterval(()=> setRot((rotIdx+1)%notes.length), 5500);
    }

    /* ===============================
       Core: record a Hi-5
       =============================== */
    function bumpStreak(today){
      if(!lastDay){ streak = 1; }
      else{
        const last = new Date(lastDay), cur = new Date(today);
        last.setHours(0,0,0,0); cur.setHours(0,0,0,0);
        const diffDays = Math.round((cur-last)/86400000);
        if(diffDays === 0){ /* same day, keep streak */ }
        else if(diffDays === 1){ streak += 1; }
        else{ streak = 1; }
      }
      lastDay = today;
      write(LS.last, lastDay); write(LS.streak, streak);
    }

    async function recordHi5(){
      const key = todayKey();
      history[key] = (history[key]||0) + 1;
      total += 1;
      gFives += 1; // local cosmetic counter

      write(LS.hist, history); write(LS.total, total);
      localStorage.setItem(LS.gFive, String(gFives));

      bumpStreak(key);
      renderCounters(); renderWeekStrip(); updateRotator();

      // Prompt to journal/share
      openSheet();
    }

    /* ===============================
       Persist journal/share
       =============================== */
    confirmShare.addEventListener('click', async ()=>{
      const text = (journal.value||'').trim();
      const isAnon = getSwitch(toggleAnon);
      const toIsland = getSwitch(togglePublic);
      const loc = (locationInput.value||'').trim();
      try{
        // 1) Always store private archive
        await window.hiDB?.insertArchive?.({
          currentEmoji:'üëã', desiredEmoji:'üëã',
          journal: text, location: loc
        });
        // 2) Optional public share
        if (toIsland){
          await window.hiDB?.insertPublicShare?.({
            currentEmoji:'üëã', currentName:'Hi-5',
            desiredEmoji:'üëã', desiredName:'Hi-5',
            text, isAnonymous:isAnon, location:loc, isPublic:true
          });
        }
        toast('Saved ‚ú®');
        closeSheet();
      }catch(e){
        console.warn('save/share error', e);
        toast('Saved locally. Will sync when online.');
        closeSheet();
      }finally{
        journal.value=''; locationInput.value='';
        setSwitch(toggleAnon,false); setSwitch(togglePublic,true);
      }
    });

    /* ===============================
       Events & boot
       =============================== */
    hiBtn.addEventListener('click', recordHi5);

    renderCounters();
    renderWeekStrip();
    updateRotator();
    setSwitch(togglePublic,true);
    setSwitch(toggleAnon,false);
  })();
  </script>
</body>
</html>
