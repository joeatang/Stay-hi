<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Stay Hi — Today</title>

  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>

  <style>
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .stack{display:flex;flex-direction:column;gap:12px}
    .center{display:flex;flex-direction:column;align-items:center}

    /* Rotator */
    .announce{display:flex;align-items:center;gap:10px;justify-content:center;margin:10px auto;padding:8px 10px;border-radius:12px;border:1px solid #23264d;background:#0f1020;color:#e8ebff;max-width:820px}
    .announce .txt{display:flex;align-items:center;gap:8px;flex:1;min-width:0;overflow:hidden}
    .pill{display:inline-flex;align-items:center;background:#111;color:#fff;border-radius:999px;padding:2px 8px;font-weight:900}
    .badge{font-size:.7rem;letter-spacing:.02em}
    .marquee{display:block;white-space:nowrap}
    .marquee > span{display:inline-block;padding-right:40px}
    .scroll{display:inline-block;will-change:transform;animation:mar 16s linear infinite}
    @keyframes mar{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

    /* Ring / meter */
    .ring{ position:relative; margin:0 auto; width:min(520px,90vw); }
    .ring svg{ width:100%; height:auto; display:block }
    .goal-marker{ position:absolute; inset:0; transform-origin:50% 50%; pointer-events:none }
    .goal-marker i{ position:absolute; left:50%; top:6px; transform:translateX(-50%); width:10px; height:10px; border-radius:50%; background:#F5A623; box-shadow:0 1px 4px #0009 }

    /* Center stack inside ring */
    .ringCenter{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:5; display:flex; flex-direction:column; align-items:center; gap:8px; width:70%; pointer-events:none }
    .centerBtn{
      pointer-events:auto;
      padding:10px 14px; border-radius:999px; font-weight:900;
      border:1px solid var(--hi-border); background:#fff; color:#111;
      box-shadow:0 8px 20px rgba(0,0,0,.12);
    }
    .timerRead{ font-size:40px; text-align:center; color:#fff; text-shadow:0 2px 8px #000a; backdrop-filter: blur(2px); }
    @media (min-width:420px){ .timerRead{ font-size:46px } }
    .subCenter{ font-size:.95rem; color:#e8ebff; text-shadow:0 1px 6px #0009 }

    .burst{ position:absolute; inset:0; pointer-events:none; z-index:4 }
    .burst span{ position:absolute; font-size:26px; will-change:transform,opacity }
    @keyframes waveUp { 0%{ transform:translate(-50%,-50%) scale(var(--s,1)); opacity:.9 }
      100%{ transform:translate(calc(-50% + var(--dx,0px)),-240%) scale(calc(var(--s,1)*.9)); opacity:0 } }

    .hud{display:flex;justify-content:center;gap:10px;margin:8px 0;flex-wrap:wrap}
    .hud .dot{width:10px;height:10px;border-radius:50%}
    .hud .today{background:#22c55e}.hud .goal{background:#f59e0b}

    .legend{display:flex;gap:14px;justify-content:center;color:#cfd2ea;font-size:.9rem}
    .legend .sw{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 16px;border-radius:14px;font-weight:900;cursor:pointer;border:1px solid var(--hi-border);background:#fff;color:#111;z-index:3;position:relative}
    .btn.primary{background:var(--grad-ember);color:#fff;border-color:transparent}
    .chips{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;justify-content:center;padding:8px 12px;border-radius:999px;font-weight:800;background:#fff;border:1px solid var(--hi-border);color:#111;z-index:3}

    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#000;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;z-index:1000}
    .toast.show{opacity:1;transition:opacity .2s}

    /* Calendar */
    .calendar-backdrop{ position:fixed; inset:0; background:#0009; display:none; place-items:center; z-index:700 }
    .calendar{ background:#101010; color:#fff; border:1px solid #ffffff1a; border-radius:18px; width:min(720px,92vw); }
    .calendar .hd{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #ffffff1a }
    .calendar .grid7{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px; padding:14px }
    .calendar .cell{ height:66px; border-radius:10px; display:grid; place-items:center; border:1px solid #ffffff1a; background:#ffffff0f }
    .calendar .cell.met{ background:#0a5; border-color:#0a5 }
  </style>
</head>
<body class="sunrise" data-tab="today">
  <header id="app-header" class="header"></header>

  <main class="page wrap">
    <!-- Rotator -->
    <div id="announceWrap" class="announce">
      <div id="announceTxt" class="txt">…</div>
      <button id="announceX" class="btn" style="width:auto;padding:4px 10px" type="button">✕</button>
    </div>

    <!-- HUD -->
    <div class="hud">
      <span class="dot today"></span><span class="lead">Hi mins today</span>
      &nbsp;&nbsp;<span class="dot goal"></span><span class="lead"><b id="goalLblTop">14m</b> target</span>
    </div>

    <!-- Meter -->
    <section class="panel stack" aria-label="Hi meter">
      <div class="ring" id="ringBox" aria-label="Tap background to send a Hi">
        <svg viewBox="0 0 220 220" aria-hidden="true">
          <defs>
            <linearGradient id="goalGrad" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%"  stop-color="#10b981"/>
              <stop offset="100%" stop-color="#059669"/>
            </linearGradient>
            <linearGradient id="goalGradMet" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%"  stop-color="#ffd166"/>
              <stop offset="100%" stop-color="#ff7a18"/>
            </linearGradient>
          </defs>
          <circle cx="110" cy="110" r="98" stroke="#1f2748" stroke-width="8" fill="none"/>
          <circle id="dayArc"  cx="110" cy="110" r="98" stroke="#0aa15a" stroke-width="8" fill="none"
                  stroke-linecap="round" stroke-dasharray="0 1000"/>
          <circle cx="110" cy="110" r="82" stroke="#1f2748" stroke-width="18" fill="none"/>
          <circle id="goalArc" cx="110" cy="110" r="82" stroke="url(#goalGrad)" stroke-width="18" fill="none"
                  stroke-linecap="round" stroke-dasharray="0 1000"/>
        </svg>

        <!-- Center content inside ring -->
        <div class="ringCenter" aria-hidden="false">
          <button id="hi5Btn" class="centerBtn" type="button">👋 Global Hi-5</button>
          <div class="timerRead" id="readout">00:00:00</div>
          <div class="subCenter">Today <b id="todayLbl">0m</b> • Target <b id="goalLbl">14m</b></div>
        </div>

        <div class="goal-marker" id="goalMarker"><i></i></div>
        <div class="burst" id="burst"></div>
      </div>

      <!-- legend -->
      <div class="legend">
        <span><span class="sw" style="background:#0aa15a"></span>Day progress</span>
        <span><span class="sw" style="background:#ffd166"></span>Goal met</span>
        <span><span class="sw" style="background:#ff7a18"></span>Goal surge</span>
      </div>

      <!-- quick add + action -->
      <div class="chips">
        <button class="chip" data-add="1"  type="button">+1 min</button>
        <button class="chip" data-add="5"  type="button">+5 min</button>
        <button class="chip" data-add="10" type="button">+10 min</button>
      </div>
      <div class="center" style="gap:10px">
        <button id="toggle" class="btn primary" type="button">Stay Hi</button>
      </div>
    </section>
  </main>

  <!-- Calendar modal -->
  <div id="calWrap" class="calendar-backdrop">
    <div class="calendar" role="dialog" aria-modal="true" aria-labelledby="calLabel">
      <div class="hd">
        <button id="calPrev" class="btn" style="width:auto;padding:4px 10px" type="button">‹</button>
        <div id="calLabel" class="h1" style="font-size:1.1rem;margin:0"></div>
        <button id="calNext" class="btn" style="width:auto;padding:4px 10px" type="button">›</button>
      </div>
      <div class="grid7" style="margin-bottom:6px;color:#cfd2ea;font-size:12px">
        <div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div><div>SUN</div>
      </div>
      <div id="calGrid" class="grid7"></div>
      <div style="text-align:right;padding:0 14px 14px">
        <button id="calClose" class="btn" style="width:auto;padding:8px 12px" type="button">Close</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    /* ---------- helpers & storage ---------- */
    const pad2=n=>String(n).padStart(2,'0');
    const todayKey=(d=new Date())=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    function dailyHiNote(date=new Date()){
      const key=\`\${date.getFullYear()}-\${date.getMonth()}-\${date.getDate()}\`;
      let h=0; for(let i=0;i<key.length;i++) h=(h*31+key.charCodeAt(i))|0;
      const pick=arr=>arr[Math.abs(h++%arr.length)];
      const verbs=["Rise Hi","Shine Hi","Lead with Hi","Start with Hi","Carry your Hi","Breathe Hi","Choose Hi","Stay Hi","Move Hi","Speak Hi","Believe in Hi","Aim Hi","Soar Hi","Flow Hi"];
      const closers=["— small Hi’s change big days.","and let courage follow.","and watch doors open.","and pass a Hi forward.","and brighten a corner.","and meet the moment.","and lift someone with you.","and let kindness ripple."];
      return \`\${pick(verbs)} \${pick(closers)}\`;
    }
    const LS={ goal:"hi.goalMin", hist:"hi.history", start:"hi.sessionStart", gFive:"hi.globalFives", gStart:"hi.globalStarts" };
    const read=(k,def)=>{ try{ const v=localStorage.getItem(k); return v==null?def:JSON.parse(v) }catch{ return def } };
    const write=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} };

    /* ---------- state ---------- */
    let goalMin = Number(read(LS.goal, null));
    if(!goalMin || goalMin < 1){ goalMin = 14; write(LS.goal, 14); } // enforce 14m default
    let history = read(LS.hist, {});
    let sessionStart = Number(localStorage.getItem(LS.start) || 0) || 0;
    let sessionActive = !!sessionStart;
    let gFives  = Number(localStorage.getItem(LS.gFive)  || 0) || 0;
    let gStarts = Number(localStorage.getItem(LS.gStart) || 0) || 0;

    /* ---------- els ---------- */
    const ringBox=document.getElementById('ringBox');
    const hi5Btn=document.getElementById('hi5Btn');
    const readout=document.getElementById('readout');
    const goalLblTop=document.getElementById('goalLblTop');
    const goalLbl=document.getElementById('goalLbl');
    const todayLbl=document.getElementById('todayLbl');
    const goalMarker=document.getElementById('goalMarker');
    const dayArc=document.getElementById('dayArc');
    const goalArc=document.getElementById('goalArc');
    const toastEl=document.getElementById('toast');

    const calWrap=document.getElementById('calWrap');
    const calLabel=document.getElementById('calLabel');
    const calGrid=document.getElementById('calGrid');

    const R_DAY=98, C_DAY=2*Math.PI*R_DAY;
    const R_GOAL=82, C_GOAL=2*Math.PI*R_GOAL;

    function toast(msg, ttl=1600){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ttl); }

    function getTodayMins(){ return Number(history[todayKey()]||0) }
    function setTodayMins(m){ history[todayKey()]=m; write(LS.hist, history) }
    function liveSec(){ return sessionActive ? Math.max(0, Math.floor((Date.now()-sessionStart)/1000)) : 0 }
    function fmtHMS(sec){ const h=pad2(Math.floor(sec/3600)), m=pad2(Math.floor((sec%3600)/60)), s=pad2(sec%60); return \`\${h}:\${m}:\${s}\` }

    /* ---------- ring render (smooth per second) ---------- */
    function renderRing(){
      const live = liveSec();                 // seconds
      const todayMin = getTodayMins();        // saved minutes
      const totalMinFloat = todayMin + (live/60);  // fractional minutes for smooth fill

      // Day arc
      const dayP = Math.min(1, totalMinFloat / 1440);
      dayArc.setAttribute('stroke-dasharray', \`\${(dayP*C_DAY).toFixed(2)} \${C_DAY.toFixed(2)}\`);

      // Goal arc
      const goalP = Math.min(1, totalMinFloat / Math.max(1, goalMin));
      goalArc.setAttribute('stroke-dasharray', \`\${(goalP*C_GOAL).toFixed(2)} \${C_GOAL.toFixed(2)}\`);
      goalArc.setAttribute('stroke', totalMinFloat>=goalMin ? 'url(#goalGradMet)' : 'url(#goalGrad)');

      // marker
      const goalDeg = Math.min(360, (goalMin/1440)*360);
      goalMarker.style.transform = \`rotate(\${goalDeg}deg)\`;

      readout.textContent = fmtHMS(live);
      goalLblTop.textContent = goalMin+'m';
      goalLbl.textContent = goalMin+'m';
      todayLbl.textContent = Math.floor(totalMinFloat)+'m';
    }

    /* ---------- interactions ---------- */
    function addBurst(n=12, emoji='👋'){
      const host=document.querySelector('.burst');
      for(let i=0;i<n;i++){
        const s=document.createElement('span');
        const x=50+(Math.random()-0.5)*10, y=48+(Math.random()-0.5)*6;
        s.textContent=emoji; s.style.left=x+'%'; s.style.top=y+'%';
        s.style.transform='translate(-50%,-50%)';
        s.style.setProperty('--dx', ((Math.random()-0.5)*160)+'px');
        s.style.setProperty('--s', (0.9+Math.random()*0.35));
        s.style.animation = \`waveUp 1100ms cubic-bezier(.22,1,.36,1) \${(Math.random()*180)|0}ms forwards\`;
        host.appendChild(s);
        setTimeout(()=>s.remove(), 1400);
      }
    }

    function incHi5(){
      try{ navigator?.vibrate?.(35) }catch{}
      gFives += 1; localStorage.setItem(LS.gFive, String(gFives));
      addBurst(14,'👋'); toast('👋 +1 Global Hi-5');
      renderRotator(); renderRing();
    }
    hi5Btn.addEventListener('click', incHi5);
    ringBox.addEventListener('click', (e)=>{ if(!e.target.closest('button,input')) incHi5(); });

    document.getElementById('toggle').addEventListener('click', ()=>{
      if(!sessionActive){
        sessionStart = Date.now(); sessionActive = true;
        localStorage.setItem(LS.start, String(sessionStart));
        gStarts += 1; localStorage.setItem(LS.gStart, String(gStarts));
        toast('🏁 Hi session started');
      }else{
        const end=Date.now(); const mins=Math.floor(Math.max(0, end-sessionStart)/60000);
        setTodayMins(getTodayMins()+mins);
        sessionStart=0; sessionActive=false; localStorage.removeItem(LS.start);
        toast(\`✨ +\${mins}m added\`);
      }
      renderRotator(); renderRing();
    });

    document.querySelectorAll('.chip[data-add]').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        const n = Number(ch.dataset.add||0);
        setTodayMins(getTodayMins()+n);
        toast(\`➕ \${n}m added\`);
        renderRotator(); renderRing();
      });
    });

    /* ---------- calendar ---------- */
    function renderCal(){
      const base=new Date(); const first=new Date(base.getFullYear(), base.getMonth(), 1);
      calLabel.textContent = base.toLocaleDateString(undefined,{month:'long',year:'numeric'});
      calGrid.innerHTML='';
      const firstWeekday=(first.getDay()+6)%7;
      for(let i=0;i<firstWeekday;i++){ const d=document.createElement('div'); d.className='cell'; d.style.opacity='.35'; calGrid.appendChild(d); }
      const d=new Date(first);
      while(d.getMonth()===first.getMonth()){
        const k=todayKey(d); const mins=Number(history[k]||0);
        const cell=document.createElement('div'); cell.className='cell'+(mins>=goalMin?' met':'');
        cell.innerHTML=\`<div>\${d.getDate()}</div><div style="font-size:10px;opacity:.8">\${mins?mins+'m':''}</div>\`;
        calGrid.appendChild(cell); d.setDate(d.getDate()+1);
      }
      while(calGrid.children.length%7!==0){ const c=document.createElement('div'); c.className='cell'; c.style.opacity='.35'; calGrid.appendChild(c); }
    }
    function openCal(){ calWrap.style.display='grid'; renderCal(); }
    function closeCal(){ calWrap.style.display='none'; }
    document.getElementById('calClose').addEventListener('click', closeCal);
    // Optional future month nav:
    document.getElementById('calPrev').addEventListener('click', ()=>{});
    document.getElementById('calNext').addEventListener('click', ()=>{});
    // Header integrations:
    window.addEventListener('open-calendar', openCal);         // event-based
    window.HI_OPEN_CAL = openCal;                              // function-based
    document.addEventListener('click', (e)=>{                  // data attribute fallback
      const t=e.target.closest('[data-open-calendar]'); if(t){ e.preventDefault(); openCal(); }
    });

    /* ---------- rotator ---------- */
    const wrap = document.getElementById('announceWrap');
    const txt  = document.getElementById('announceTxt');
    const close= document.getElementById('announceX');

    function marqueeify(text){
      // two copies to make infinite scroll feel right
      txt.innerHTML = `
        <span class="pill"><span class="badge">NOTE</span></span>
        <div class="marquee"><div class="scroll">
          <span>${text}</span><span>${text}</span>
        </div></div>`;
    }
    let rotIdx=0, rotT;
    function dataNotes(){
      return [
        {type:'starts', text:\`🏁 Global Hi Starts: \${gStarts.toLocaleString()}\`},
        {type:'global', text:\`🌍 Global Hi’s: \${gFives.toLocaleString()}\`},
        {type:'note',   text:\`💡 \${dailyHiNote()}\`}
      ];
    }
    function renderRotator(){
      const notes=dataNotes();
      const n = notes[rotIdx%notes.length];
      if (n.type==='note'){ wrap.style.display='flex'; marqueeify(n.text); }
      else { wrap.style.display='flex'; txt.innerHTML=\`<span class="pill"><span class="badge">\${n.type==='starts'?'STARTS':'HI'}</span></span>\${n.text}\`; }
    }
    function startRotator(){
      clearInterval(rotT);
      renderRotator();
      rotT=setInterval(()=>{ rotIdx=(rotIdx+1)%3; renderRotator(); }, 5500);
    }
    close.onclick = ()=>{ wrap.style.display='none'; clearInterval(rotT); };

    /* ---------- boot ---------- */
    goalLblTop.textContent=goalMin+'m';
    goalLbl.textContent=goalMin+'m';
    startRotator();
    renderRing();
    setInterval(()=>{ if(sessionActive) renderRing(); }, 1000);
  </script>

  <script src="assets/header.js" defer></script>
  <script src="assets/tabs.js" defer></script>
</body>
</html>
