<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Stay Hi — Today</title>

  <!-- Global theme + shared UI -->
  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>

  <style>
    /* Layout */
    body.sunrise{ min-height:100dvh; display:flex; flex-direction:column }
    main.page{ flex:1; display:grid; place-items:start; padding:16px }
    @media (min-width:880px){ main.page{ place-items:center } }

    /* Announcement bar (under header, above legend) */
    .announce{
      position:relative; display:flex; align-items:center; justify-content:center; gap:10px;
      height:40px; margin:8px auto 10px; width:min(960px,94vw);
      border:1px solid var(--hi-border); border-radius:999px; background:#fff; color:#111;
      box-shadow: var(--shadow); padding:0 14px;
    }
    .announce .txt{ display:flex; align-items:center; gap:8px; width:100%; justify-content:center; font-weight:700 }
    .announce .pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--hi-border); border-radius:999px; background:#fff; }
    .announce .badge{ font-size:.75rem; font-weight:900; background:#111; color:#fff; padding:.15rem .5rem; border-radius:999px }
    .announce .marquee{ overflow:hidden; white-space:nowrap }
    .announce .marquee span{ display:inline-block; padding-left:100%; animation:marq var(--marquee-dur,16s) linear infinite }
    @keyframes marq { 0%{ transform:translateX(0) } 100%{ transform:translateX(-100%) } }
    .announce .x{ position:absolute; right:8px; height:28px }

    /* Panel card */
    .panel{
      width:min(1040px,96vw);
      background:#0e1220; color:#e8ebff;
      border:1px solid #23264d; border-radius:22px;
      box-shadow:0 22px 60px rgba(0,0,0,.35);
      padding:22px;
    }

    /* Ring */
    .ring{ position:relative; margin:10px auto; width:min(540px,86vw); aspect-ratio:1/1 }
    .ring svg{ width:100%; height:100% }
    .goal-marker{ position:absolute; inset:0; transform-origin:50% 50%; pointer-events:none }
    .goal-marker i{ position:absolute; left:50%; top:6px; transform:translateX(-50%); width:10px; height:10px; border-radius:50%; background:#F5A623; box-shadow:0 1px 4px #0009 }

    /* Center badge + logo */
    .hi-medal{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:auto }
    .hi-logo{ position:relative; width:min(360px,60%); aspect-ratio:1/1; display:grid; place-items:center }
    .hi-mark{ width:min(180px,40%); height:auto; display:block; filter:drop-shadow(0 6px 18px rgba(0,0,0,.35)) }
    .hand{
      position:absolute; top:10%; left:50%; transform:translateX(-50%);
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
      border-radius:999px; border:1px solid var(--hi-border); background:#fff; color:#111; font-weight:900;
      box-shadow:0 10px 22px rgba(0,0,0,.22);
    }

    /* Timer read / legend (we keep a small readout for fun) */
    .read{ text-align:center; margin-top:6px }
    .timerRead{ font-size:40px; line-height:1; font-weight:900 }
    @media (min-width:420px){ .timerRead{ font-size:46px } }
    .subline{ opacity:.85 }

    /* Week strip (streak) */
    .weekstrip{ display:flex; gap:8px; justify-content:center; margin:8px auto 6px; color:#cfd2ea; font-size:12px }
    .weekdot{ display:grid; place-items:center; gap:4px; }
    .weekdot .c{ width:28px; height:20px; border-radius:10px; display:grid; place-items:center; border:1px solid #31365f; }
    .weekdot .c.met{ color:#fff; background: linear-gradient(135deg, #ffd166, #ff7a18); }

    /* Legend dots */
    .hud{display:flex;justify-content:center;gap:12px;margin:8px 0 6px;flex-wrap:wrap;color:#cfd2ea}
    .hud .dot{width:10px;height:10px;border-radius:50%}
    .hud .today{background:#22c55e}.hud .goal{background:#f59e0b}.hud .surge{background:#ffb020}

    /* Actions */
    .actions{ display:flex; justify-content:center; margin-top:14px }
    .hi-btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:14px 16px; border-radius:14px; font-weight:900; cursor:pointer; border:1px solid var(--hi-border) }
    .hi-btn--primary{ color:#fff; background:var(--grad-ember); border-color:transparent; width:min(960px,94vw) }
    .hi-btn--ghost{ background:#fff; color:#111 }

    /* Toast + bursts */
    .toast{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#000; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; z-index:1000 }
    .toast.show{ opacity:1; transition:opacity .2s }

    .burst{ position:absolute; inset:0; pointer-events:none }
    .burst span{ position:absolute; font-size:26px; will-change:transform,opacity }
    @keyframes waveUp {
      0%{ transform:translate(-50%,-50%) scale(var(--s,1)); opacity:.9 }
      100%{ transform:translate(calc(-50% + var(--dx,0px)),-260%) scale(calc(var(--s,1)*.9)); opacity:0 }
    }

    /* Confetti (subtle) */
    .confetti{ position:fixed; inset:0; pointer-events:none; z-index:900 }
    .confetti i{ position:absolute; width:8px; height:8px; background:#fff; opacity:0; border-radius:2px }

    /* Share sheet */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:50}
    .sheet{position:fixed;left:0;right:0;bottom:-100%;background:var(--hi-bg);border-radius:18px 18px 0 0;border:1px solid var(--hi-border);padding:16px 14px;z-index:60;box-shadow:0 -10px 30px rgba(0,0,0,.12)}
    .sheet.show + .sheet-backdrop{display:block}
    .sheet.show{animation:sheetIn .25s ease-out forwards}
    .sheet.hide{animation:sheetOut .2s ease-in forwards}
    @keyframes sheetIn{from{bottom:-100%}to{bottom:0}}
    @keyframes sheetOut{from{bottom:0}to{bottom:-100%}}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;flex-wrap:wrap}
    .switch{position:relative;width:44px;height:26px;background:#e8e8e8;border-radius:999px;cursor:pointer;border:1px solid var(--hi-border)}
    .knob{position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.2);transition:left .15s}
    .switch.on{background:#0a8a3a;border-color:#0a8a3a}
    .switch.on .knob{left:22px}
    .field{display:flex;gap:8px;align-items:center;border:1px solid var(--hi-border);border-radius:12px;padding:8px 10px;background:#fff}
    .field input, .field textarea{border:0;outline:0;width:100%;font:inherit}
  </style>
</head>
<body class="sunrise" data-tab="today">
  <!-- Header -->
  <header id="app-header" class="header"></header>

  <!-- Announcement -->
  <div id="announceWrap" class="announce">
    <div id="announceTxt" class="txt"></div>
    <button id="announceX" class="hi-btn hi-btn--ghost x" aria-label="Dismiss">✕</button>
  </div>

  <main class="page">
    <section class="panel" aria-label="Hi home">
      <!-- Week strip (streak) -->
      <div id="weekStrip" class="weekstrip" aria-label="Your week"></div>

      <!-- Ring -->
      <div class="ring" id="ringBox" aria-label="Tap the center to send a playful Global Hi-5">
        <svg viewBox="0 0 220 220" aria-hidden="true">
          <defs>
            <linearGradient id="goalGrad" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%"  stop-color="#10b981"/>
              <stop offset="100%" stop-color="#059669"/>
            </linearGradient>
            <linearGradient id="goalGradMet" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%"  stop-color="#ffd166"/>
              <stop offset="100%" stop-color="#ff7a18"/>
            </linearGradient>
          </defs>
          <!-- Outer progress (fun: fills to today's personal tally mod 24m) -->
          <circle cx="110" cy="110" r="98" stroke="#1f2748" stroke-width="8" fill="none"/>
          <circle id="dayArc" cx="110" cy="110" r="98" stroke="#0aa15a" stroke-width="8" fill="none"
                  stroke-linecap="round" stroke-dasharray="0 1000"/>
          <!-- Inner goal ring (fixed to 14m “nice target”) -->
          <circle cx="110" cy="110" r="82" stroke="#1f2748" stroke-width="18" fill="none"/>
          <circle id="goalArc" cx="110" cy="110" r="82" stroke="url(#goalGrad)" stroke-width="18" fill="none"
                  stroke-linecap="round" stroke-dasharray="0 1000"/>
        </svg>

        <!-- marker for “goal” -->
        <div class="goal-marker" id="goalMarker"><i></i></div>

        <!-- Playful center -->
        <div class="hi-medal" id="medal">
          <div class="hi-logo">
            <div class="hand">👋 Global Hi-5</div>
            <!-- Swap this path to your real logo -->
            <img class="hi-mark" src="assets/brand/hi-logo.svg" alt="Stay Hi"/>
          </div>
          <div class="burst" id="burst"></div>
        </div>
      </div>

      <!-- Small read + legend -->
      <div class="read">
        <div class="timerRead" id="readout">00:00:00</div>
        <div class="subline">Today <b id="todayLbl">0</b> • Streak <b id="streakLbl">0</b> • Total <b id="totalLbl">0</b></div>
      </div>

      <div class="hud" aria-label="Legend">
        <span class="dot today"></span><span class="lead">Day progress</span>
        <span class="dot goal"></span><span class="lead">14m goal</span>
        <span class="dot surge"></span><span class="lead">Goal surge</span>
      </div>

      <!-- Primary action -->
      <div class="actions">
        <button id="markHi" class="hi-btn hi-btn--primary">Mark My Hi-5</button>
      </div>
    </section>
  </main>

  <!-- Share Sheet -->
  <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" aria-hidden="true">
    <h3 id="sheetTitle">Want to capture your Hi moment?</h3>
    <p class="hi-hint" style="color:var(--hi-muted)">A private copy is saved to <b>My Archive</b>. You can also appear on <b>Hi Island</b>.</p>

    <div class="field" style="margin-top:6px">
      <span>📝</span>
      <textarea id="journal" placeholder="Optional — 1–2 honest lines about your Hi moment…" maxlength="600"></textarea>
    </div>

    <div class="row" style="margin-top:6px">
      <div>
        <div style="font-weight:800">Show on Hi Island</div>
        <div class="hi-hint" style="color:var(--hi-muted)">Appear in the global General Shares feed</div>
      </div>
      <div id="togglePublic" class="switch on" role="switch" aria-checked="true" tabindex="0"><div class="knob" aria-hidden="true"></div></div>
    </div>

    <div class="row">
      <div>
        <div style="font-weight:800">Post as Anonymous</div>
        <div class="hi-hint" style="color:var(--hi-muted)">Your name becomes “Hi Friend”</div>
      </div>
      <div id="toggleAnon" class="switch" role="switch" aria-checked="false" tabindex="0"><div class="knob" aria-hidden="true"></div></div>
    </div>

    <div class="field" aria-label="Optional location">
      <span>📍</span><input id="locationInput" placeholder="City, State (optional)"/>
    </div>

    <div class="row" style="justify-content:flex-end">
      <button id="cancelShare" class="hi-btn hi-btn--ghost">Skip</button>
      <button id="confirmShare" class="hi-btn hi-btn--primary" style="width:auto">Save</button>
    </div>
  </div>
  <div id="backdrop" class="sheet-backdrop" aria-hidden="true"></div>

  <!-- Toast + confetti layer -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <!-- Shared scripts -->
  <script src="assets/header.js" defer></script>
  <script src="assets/supabase-init.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/db.js"></script>

  <script>
  (async function(){
    // allow anonymous play (offline ok)
    try { await hiAuth.ensureSessionMaybe?.(); } catch {}

    /* ---------- tiny utils ---------- */
    const pad2=n=>String(n).padStart(2,'0');
    const todayKey=(d=new Date())=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const weekStartMonday=(d=new Date())=>{const x=new Date(d);const day=(x.getDay()+6)%7;x.setDate(x.getDate()-day);x.setHours(0,0,0,0);return x};
    const read=(k,def)=>{ try{ const v=localStorage.getItem(k); return v==null?def:JSON.parse(v) }catch{ return def } };
    const write=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} };

    function dailyHiNote(date=new Date()){
      const key=`${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
      let h=0; for(let i=0;i<key.length;i++) h=(h*31+key.charCodeAt(i))|0;
      const pick=arr=>arr[Math.abs(h++%arr.length)];
      const verbs=["Rise Hi","Shine Hi","Lead with Hi","Start with Hi","Carry your Hi","Breathe Hi","Choose Hi","Stay Hi","Move Hi","Speak Hi","Believe in Hi","Aim Hi","Soar Hi","Flow Hi"];
      const closers=["— small Hi’s change big days.","and let courage follow.","and watch doors open.","and pass a Hi forward.","and brighten a corner.","and meet the moment.","and lift someone with you.","and let kindness ripple."];
      return `${pick(verbs)} ${pick(closers)}`;
    }

    /* ---------- state ---------- */
    const LS={
      total:"hi.total",
      streak:"hi.streak",
      last:"hi.lastDate",
      today:"hi.todayCount",
      globalFives:"hi.globalFives"
    };

    let total = Number(read(LS.total, 0))||0;
    let streak = Number(read(LS.streak, 0))||0;
    let lastDate = read(LS.last, '');
    let todayCount = Number(read(LS.today, 0))||0;
    let globalFives = Number(localStorage.getItem(LS.globalFives)||0)||0;

    /* ---------- els ---------- */
    const ringBox = document.getElementById('ringBox');
    const dayArc  = document.getElementById('dayArc');
    const goalArc = document.getElementById('goalArc');
    const goalMarker = document.getElementById('goalMarker');
    const medal = document.getElementById('medal');
    const burst = document.getElementById('burst');

    const readout = document.getElementById('readout');
    const todayLbl= document.getElementById('todayLbl');
    const streakLbl= document.getElementById('streakLbl');
    const totalLbl = document.getElementById('totalLbl');

    const weekStrip = document.getElementById('weekStrip');
    const toastEl = document.getElementById('toast');

    const markBtn = document.getElementById('markHi');

    // sheet
    const sheet = document.getElementById('sheet');
    const backdrop = document.getElementById('backdrop');
    const togglePublic = document.getElementById('togglePublic');
    const toggleAnon   = document.getElementById('toggleAnon');
    const locationInput= document.getElementById('locationInput');
    const journal = document.getElementById('journal');
    const cancelShare = document.getElementById('cancelShare');
    const confirmShare= document.getElementById('confirmShare');

    // rotator
    const wrap = document.getElementById('announceWrap');
    const txt  = document.getElementById('announceTxt');
    const close= document.getElementById('announceX');
    let notes = []; let idx=0; let rotT;

    /* ---------- visuals ---------- */
    function toast(msg, ttl=1500){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ttl); }

    function addBurst(n=12, emoji='👋'){
      for(let i=0;i<n;i++){
        const s=document.createElement('span');
        const x=50+(Math.random()-0.5)*12, y=48+(Math.random()-0.5)*8;
        s.textContent=emoji; s.style.left=x+'%'; s.style.top=y+'%';
        s.style.transform='translate(-50%,-50%)';
        s.style.setProperty('--dx', ((Math.random()-0.5)*160)+'px');
        s.style.setProperty('--s', (0.9+Math.random()*0.35));
        s.style.animation = `waveUp 1100ms cubic-bezier(.22,1,.36,1) ${(Math.random()*180)|0}ms forwards`;
        burst.appendChild(s);
        setTimeout(()=>s.remove(), 1400);
      }
    }

    function confettiBurst(){
      const layer=document.getElementById('confetti');
      for(let i=0;i<110;i++){
        const p=document.createElement('i');
        const x=Math.random()*100, d=600+Math.random()*700, delay=Math.random()*120;
        p.style.left=x+'%'; p.style.top='-10px';
        const size=6+Math.random()*6;
        p.style.width=size+'px'; p.style.height=size+'px';
        p.style.opacity='1';
        p.style.background = ['#ffd166','#ff7a18','#10b981','#60a5fa','#f472b6'][i%5];
        p.animate([{transform:`translateY(0) rotate(0deg)`, opacity:1},{transform:`translateY(${window.innerHeight+120}px) rotate(${120+Math.random()*240}deg)`, opacity:0.9}],{duration:d, delay, easing:'cubic-bezier(.22,1,.36,1)'});
        setTimeout(()=>p.remove(), d+delay+60);
        layer.appendChild(p);
      }
    }

    /* ---------- streak + ring ---------- */
    const R_DAY=98, C_DAY=2*Math.PI*R_DAY;
    const R_GOAL=82, C_GOAL=2*Math.PI*R_GOAL;
    const GOAL_MIN = 14;

    function renderWeekStrip(){
      weekStrip.innerHTML='';
      const start=weekStartMonday(new Date());
      for(let i=0;i<7;i++){
        const d=new Date(start); d.setDate(start.getDate()+i);
        const k=todayKey(d); const done=(read(LS.today,0)&&k===todayKey()) ? todayCount>0 : (read('hi.history.'+k,0)||0) > 0;
        const lbl=d.toLocaleDateString(undefined,{weekday:'short'}).toUpperCase();
        const el=document.createElement('div'); el.className='weekdot';
        el.innerHTML=`<div class="lbl">${lbl}</div><div class="c ${done?'met':''}">${done?'✓':'○'}</div>`;
        weekStrip.appendChild(el);
      }
    }

    function renderRing(){
      // fun “progress”: (todayCount minutes proxy) → fill outer / inner
      const dayMin = Math.min(24, todayCount); // cap for look
      const dayP = Math.min(1, dayMin / 24);
      dayArc.setAttribute('stroke-dasharray', `${(dayP*C_DAY).toFixed(1)} ${C_DAY.toFixed(1)}`);

      const goalP = Math.min(1, dayMin / GOAL_MIN);
      goalArc.setAttribute('stroke-dasharray', `${(goalP*C_GOAL).toFixed(1)} ${C_GOAL.toFixed(1)}`);
      goalArc.setAttribute('stroke', dayMin>=GOAL_MIN ? 'url(#goalGradMet)' : 'url(#goalGrad)');

      const goalDeg = Math.min(360, (GOAL_MIN/1440)*360);
      goalMarker.style.transform = `rotate(${goalDeg}deg)`;

      // playful chrono
      const now=new Date();
      readout.textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
      todayLbl.textContent = todayCount;
      streakLbl.textContent = streak;
      totalLbl.textContent = total;
      renderWeekStrip();
    }

    setInterval(renderRing, 1000);

    /* ---------- rotator ---------- */
    function marqueeify(text){
      const dur = Math.min(22, Math.max(10, text.length/7));
      txt.innerHTML = `<span class="pill"><span class="badge">NOTE</span></span><div class="marquee" style="--marquee-dur:${dur}s"><span>${text}&nbsp;&nbsp;&nbsp;</span></div>`;
    }
    function setRot(i){
      idx = i % notes.length;
      const n = notes[idx];
      wrap.style.display='flex';
      if (n.type === 'note'){
        marqueeify(n.text);
      } else {
        txt.innerHTML = `<span class="pill"><span class="badge">${n.type==='starts'?'STARTS':'HI'}</span></span>${n.text}`;
      }
    }
    function updateRotator(){
      notes = [
        {type:'starts', text:`🏁 Global Starts: ${total.toLocaleString()}`},            // local-proxy for demo
        {type:'global', text:`🌍 Global Hi-5s: ${globalFives.toLocaleString()}`},
        {type:'note',   text:`💡 ${dailyHiNote()}`}
      ];
      setRot(idx);
      clearInterval(rotT);
      rotT = setInterval(()=> setRot((idx+1)%notes.length), 5500);
    }
    close.onclick = ()=>{ wrap.style.display='none'; clearInterval(rotT); };

    /* ---------- interactions ---------- */
    // playful global hi-5 (tap logo)
    medal.addEventListener('click', (e)=>{
      // ignore if sheet is open
      if (sheet.getAttribute('aria-hidden')==='false') return;
      try{ navigator?.vibrate?.(25) }catch{}
      globalFives += 1; localStorage.setItem(LS.globalFives, String(globalFives));
      addBurst(12,'👋'); toast('👋 Global Hi-5');
      updateRotator(); renderRing();
    });

    // main action (personal)
    markBtn.addEventListener('click', ()=>{
      const k=todayKey();
      if (lastDate !== k){ // new day → streak handling
        const dLast = lastDate ? new Date(lastDate) : null;
        const dYesterday = new Date(); dYesterday.setDate(dYesterday.getDate()-1);
        const same = dLast && (dLast.toDateString() === dYesterday.toDateString());
        streak = same ? (streak+1) : 1;
        todayCount = 0;
      }
      lastDate = k;
      todayCount += 1;
      total += 1;
      write(LS.total, total); write(LS.streak, streak); write(LS.last, lastDate); write(LS.today, todayCount);

      // subtle confetti
      confettiBurst();

      // open sheet to capture (optional) and write to DB
      openSheet();
      updateRotator(); renderRing();
    });

    function setSwitch(el, on){
      el.classList.toggle('on', !!on);
      el.setAttribute('aria-checked', on ? 'true' : 'false');
    }
    function getSwitch(el){ return el.classList.contains('on'); }
    ;[togglePublic, toggleAnon].forEach(sw=>{
      sw.addEventListener('click', ()=> setSwitch(sw, !getSwitch(sw)));
      sw.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); setSwitch(sw, !getSwitch(sw)); }});
    });

    backdrop.addEventListener('click', closeSheet);
    cancelShare.addEventListener('click', closeSheet);

    function openSheet(){
      sheet.classList.remove('hide');
      sheet.classList.add('show');
      sheet.setAttribute('aria-hidden','false');
      backdrop.style.display = 'block';
      try{ journal.focus(); }catch{}
    }
    function closeSheet(){
      sheet.classList.remove('show');
      sheet.classList.add('hide');
      sheet.setAttribute('aria-hidden','true');
      setTimeout(()=>{ backdrop.style.display = 'none'; }, 200);
    }

    // Save to DB (always archive; Island optional)
    confirmShare.addEventListener('click', async ()=>{
      const isAnon = getSwitch(toggleAnon);
      const toIsland = getSwitch(togglePublic);
      const loc = (locationInput.value||'').trim();
      const text = (journal.value||'').trim() || 'Marked a Hi-5 ✨';

      try{
        // always archive private
        await window.hiDB?.insertArchive?.({
          currentEmoji: '👋',
          desiredEmoji: '✨',
          journal: text,
          location: loc
        });

        if (toIsland){
          await window.hiDB?.insertPublicShare?.({
            currentEmoji: '👋', currentName: 'Hi-5',
            desiredEmoji: '✨', desiredName: 'Uplift',
            text, isAnonymous: isAnon, location: loc, isPublic: true
          });
        }
      }catch(e){
        console.warn('DB write error (will be queued if supported)', e);
      }

      toast('Hi saved ✨');
      journal.value=''; locationInput.value='';
      closeSheet();
    });

    /* ---------- boot ---------- */
    updateRotator();
    renderRing();
  })();
  </script>
</body>
</html>
