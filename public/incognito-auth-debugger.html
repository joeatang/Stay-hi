<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incognito Auth Debugger ‚Äî Stay Hi</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="assets/config.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui;
            background: linear-gradient(135deg, #0F0F23 0%, #1A1A2E 50%, #16213E 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #4ECDC4, #FFD700);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border-left: 4px solid #4ECDC4;
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4ECDC4;
        }
        
        .test-result {
            font-family: 'Courier New', monospace;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status.pass {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .status.fail {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .status.warn {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .btn {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.3);
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4ECDC4;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #4ECDC4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üîç Incognito Auth Debugger</div>
            <p>Comprehensive authentication testing for incognito/private browsing mode</p>
        </div>
        
        <div class="test-section">
            <div class="test-title">üåê Environment Detection</div>
            <div id="envResults" class="test-result">Running environment tests...</div>
            <button class="btn" onclick="runEnvironmentTests()">Refresh Environment Tests</button>
        </div>
        
        <div class="test-section">
            <div class="test-title">üîß Supabase Initialization</div>
            <div id="supabaseResults" class="test-result">Testing Supabase connection...</div>
            <button class="btn" onclick="runSupabaseTests()">Test Supabase Connection</button>
        </div>
        
        <div class="test-section">
            <div class="test-title">üîê Authentication Status</div>
            <div id="authResults" class="test-result">Checking authentication status...</div>
            <button class="btn" onclick="runAuthTests()">Check Auth Status</button>
        </div>
        
        <div class="test-section">
            <div class="test-title">üìß Magic Link Test</div>
            <div class="input-group">
                <label for="testEmail">Test Email:</label>
                <input type="email" id="testEmail" placeholder="test@example.com" value="test@stayhi.app">
            </div>
            <div id="magicLinkResults" class="test-result">Ready to test magic link...</div>
            <button class="btn" onclick="testMagicLink()">Send Test Magic Link</button>
        </div>
        
        <div class="test-section">
            <div class="test-title">üíæ Storage Tests</div>
            <div id="storageResults" class="test-result">Testing storage capabilities...</div>
            <button class="btn" onclick="runStorageTests()">Test Storage</button>
        </div>
        
        <div class="test-section">
            <div class="test-title">üîÑ Navigation Tests</div>
            <div id="navResults" class="test-result">Testing page navigation...</div>
            <button class="btn" onclick="runNavigationTests()">Test Navigation</button>
        </div>
        
        <div class="test-section">
            <div class="test-title">‚ö° Quick Actions</div>
            <button class="btn" onclick="clearAllStorage()">Clear All Storage</button>
            <button class="btn" onclick="testSigninPage()">Test Signin Page</button>
            <button class="btn" onclick="testAuthCallback()">Test Auth Callback</button>
            <button class="btn" onclick="exportResults()">Export Test Results</button>
        </div>
    </div>
    
    <script>
        let supabaseClient = null;
        let testResults = {};
        
        // Initialize Supabase
        async function initializeSupabase() {
            try {
                if (!window.supabase) {
                    throw new Error('Supabase library not loaded');
                }
                
                const SUPABASE_URL = window.SUPABASE_URL || 'https://gfcubvroxgfvjhacinic.supabase.co';
                const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmY3VidnJveGdmdmpoYWNpbmljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MTIyNjYsImV4cCI6MjA3NDQ4ODI2Nn0.5IlxofMPFNdKsEueM_dhgsJP9wI-GnZRUM9hfR0zE1g';
                
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: true
                    }
                });
                
                window.supabaseClient = supabaseClient;
                window.sb = supabaseClient;
                
                return supabaseClient;
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                throw error;
            }
        }
        
        function updateResults(elementId, results) {
            const element = document.getElementById(elementId);
            element.innerHTML = results;
            testResults[elementId] = results;
        }
        
        function createStatus(status, text) {
            return `<span class="status ${status}">${text}</span>`;
        }
        
        async function runEnvironmentTests() {
            console.log('üåê Running environment tests...');
            
            let results = '';
            
            // Check if incognito mode
            const isIncognito = await (async function() {
                try {
                    const fs = await navigator.storage.estimate();
                    return fs.quota < 120000000; // Usually less than 120MB in incognito
                } catch {
                    return true; // Assume incognito if can't check
                }
            })();
            
            results += `üïµÔ∏è Incognito Mode: ${createStatus(isIncognito ? 'warn' : 'pass', isIncognito ? 'DETECTED' : 'Normal')}\n`;
            results += `üåç Location: ${location.origin}\n`;
            results += `üìÑ Path: ${location.pathname}\n`;
            results += `üîó Full URL: ${location.href}\n`;
            results += `üì± User Agent: ${navigator.userAgent.substring(0, 100)}...\n`;
            results += `üç™ Cookies Enabled: ${createStatus(navigator.cookieEnabled ? 'pass' : 'fail', navigator.cookieEnabled)}\n`;
            results += `üíæ Local Storage: ${createStatus(typeof(Storage) !== 'undefined' ? 'pass' : 'fail', typeof(Storage) !== 'undefined' ? 'Available' : 'Not Available')}\n`;
            
            // Network connectivity test
            try {
                const response = await fetch(location.origin, { method: 'HEAD' });
                results += `üåê Network: ${createStatus(response.ok ? 'pass' : 'fail', response.ok ? 'Connected' : 'Disconnected')}\n`;
            } catch (error) {
                results += `üåê Network: ${createStatus('fail', 'Error: ' + error.message)}\n`;
            }
            
            updateResults('envResults', results);
        }
        
        async function runSupabaseTests() {
            console.log('üîß Running Supabase tests...');
            
            let results = '';
            
            try {
                // Test Supabase library loading
                results += `üìö Supabase Library: ${createStatus(window.supabase ? 'pass' : 'fail', window.supabase ? 'Loaded' : 'Not Loaded')}\n`;
                
                if (!supabaseClient) {
                    await initializeSupabase();
                }
                
                results += `üîß Client Initialization: ${createStatus(supabaseClient ? 'pass' : 'fail', supabaseClient ? 'Success' : 'Failed')}\n`;
                
                if (supabaseClient) {
                    // Test basic connection
                    const { data, error } = await supabaseClient.auth.getSession();
                    results += `üîó Connection Test: ${createStatus(!error ? 'pass' : 'fail', !error ? 'Connected' : 'Error: ' + error.message)}\n`;
                    
                    // Test auth methods
                    results += `üîê Auth Methods Available: ${createStatus(typeof supabaseClient.auth.signInWithOtp === 'function' ? 'pass' : 'fail', typeof supabaseClient.auth.signInWithOtp === 'function' ? 'Yes' : 'No')}\n`;
                    
                    // Test current session
                    results += `üë§ Current Session: ${createStatus(data?.session ? 'pass' : 'warn', data?.session ? 'Active' : 'None')}\n`;
                    if (data?.session) {
                        results += `üìß User Email: ${data.session.user?.email || 'Unknown'}\n`;
                        results += `‚è∞ Expires: ${new Date(data.session.expires_at * 1000).toLocaleString()}\n`;
                    }
                }
                
            } catch (error) {
                results += `‚ùå Error: ${error.message}\n`;
                console.error('Supabase test error:', error);
            }
            
            updateResults('supabaseResults', results);
        }
        
        async function runAuthTests() {
            console.log('üîê Running authentication tests...');
            
            let results = '';
            
            try {
                if (!supabaseClient) {
                    await initializeSupabase();
                }
                
                // Test session retrieval
                const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
                results += `üìã Session Check: ${createStatus(!sessionError ? 'pass' : 'fail', !sessionError ? 'Success' : 'Error')}\n`;
                
                if (sessionError) {
                    results += `   Error: ${sessionError.message}\n`;
                }
                
                // Test user retrieval  
                const { data: userData, error: userError } = await supabaseClient.auth.getUser();
                results += `üë§ User Check: ${createStatus(!userError ? 'pass' : 'fail', !userError ? 'Success' : 'Error')}\n`;
                
                if (userError) {
                    results += `   Error: ${userError.message}\n`;
                }
                
                // Authentication status
                const isAuthenticated = sessionData?.session && !sessionError;
                results += `üîì Authentication Status: ${createStatus(isAuthenticated ? 'pass' : 'warn', isAuthenticated ? 'Authenticated' : 'Not Authenticated')}\n`;
                
                if (isAuthenticated) {
                    results += `üìß Email: ${sessionData.session.user.email}\n`;
                    results += `üÜî User ID: ${sessionData.session.user.id}\n`;
                    results += `‚è∞ Session Expires: ${new Date(sessionData.session.expires_at * 1000).toLocaleString()}\n`;
                }
                
                // Test auth state change listener
                results += `üëÇ Auth Listener: ${createStatus(typeof supabaseClient.auth.onAuthStateChange === 'function' ? 'pass' : 'fail', 'Available')}\n`;
                
            } catch (error) {
                results += `‚ùå Error: ${error.message}\n`;
                console.error('Auth test error:', error);
            }
            
            updateResults('authResults', results);
        }
        
        async function testMagicLink() {
            console.log('üìß Testing magic link...');
            
            let results = '';
            const email = document.getElementById('testEmail').value;
            
            if (!email) {
                results += `‚ùå Error: Please enter an email address\n`;
                updateResults('magicLinkResults', results);
                return;
            }
            
            try {
                if (!supabaseClient) {
                    await initializeSupabase();
                }
                
                results += `üìß Sending magic link to: ${email}\n`;
                results += `üîó Redirect URL: ${location.origin}/post-auth.html\n`;
                
                const { data, error } = await supabaseClient.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: `${location.origin}/post-auth.html?test=true`
                    }
                });
                
                if (error) {
                    results += `‚ùå Magic Link Error: ${createStatus('fail', error.message)}\n`;
                } else {
                    results += `‚úÖ Magic Link Sent: ${createStatus('pass', 'Success')}\n`;
                    if (data) {
                        results += `üìä Response Data: ${JSON.stringify(data, null, 2)}\n`;
                    }
                }
                
            } catch (error) {
                results += `‚ùå Error: ${error.message}\n`;
                console.error('Magic link test error:', error);
            }
            
            updateResults('magicLinkResults', results);
        }
        
        async function runStorageTests() {
            console.log('üíæ Running storage tests...');
            
            let results = '';
            
            try {
                // Test localStorage
                const testKey = 'stayhi_test_' + Date.now();
                const testValue = 'test_data_' + Math.random();
                
                localStorage.setItem(testKey, testValue);
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                results += `üíæ LocalStorage: ${createStatus(retrieved === testValue ? 'pass' : 'fail', retrieved === testValue ? 'Working' : 'Failed')}\n`;
                
                // Test sessionStorage
                sessionStorage.setItem(testKey, testValue);
                const sessionRetrieved = sessionStorage.getItem(testKey);
                sessionStorage.removeItem(testKey);
                
                results += `üì¶ SessionStorage: ${createStatus(sessionRetrieved === testValue ? 'pass' : 'fail', sessionRetrieved === testValue ? 'Working' : 'Failed')}\n`;
                
                // Check existing auth data
                const authKeys = Object.keys(localStorage).filter(key => 
                    key.includes('supabase') || key.includes('sb-') || key.includes('auth')
                );
                
                results += `üîë Auth Keys Found: ${authKeys.length}\n`;
                authKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    results += `   ${key}: ${value ? value.substring(0, 50) + '...' : 'null'}\n`;
                });
                
                // Test storage quota
                if (navigator.storage && navigator.storage.estimate) {
                    const estimate = await navigator.storage.estimate();
                    results += `üìä Storage Quota: ${(estimate.quota / (1024 * 1024)).toFixed(2)} MB\n`;
                    results += `üìä Storage Used: ${(estimate.usage / (1024 * 1024)).toFixed(2)} MB\n`;
                }
                
            } catch (error) {
                results += `‚ùå Error: ${error.message}\n`;
                console.error('Storage test error:', error);
            }
            
            updateResults('storageResults', results);
        }
        
        async function runNavigationTests() {
            console.log('üîÑ Running navigation tests...');
            
            let results = '';
            
            try {
                // Test key pages accessibility
                const pages = [
                    'welcome.html',
                    'signin.html', 
                    'signup.html',
                    'post-auth.html',
                    'index.html'
                ];
                
                for (const page of pages) {
                    try {
                        const response = await fetch(page, { method: 'HEAD' });
                        results += `üìÑ ${page}: ${createStatus(response.ok ? 'pass' : 'fail', response.ok ? `HTTP ${response.status}` : `HTTP ${response.status}`)}\n`;
                    } catch (error) {
                        results += `üìÑ ${page}: ${createStatus('fail', 'Network Error')}\n`;
                    }
                }
                
                // Test current page security
                results += `üîí Current Page Security: HTTPS=${location.protocol === 'https:'}\n`;
                results += `üö™ Same Origin: ${createStatus(location.origin === window.origin ? 'pass' : 'warn', location.origin === window.origin ? 'Yes' : 'Different')}\n`;
                
            } catch (error) {
                results += `‚ùå Error: ${error.message}\n`;
                console.error('Navigation test error:', error);
            }
            
            updateResults('navResults', results);
        }
        
        function clearAllStorage() {
            try {
                localStorage.clear();
                sessionStorage.clear();
                console.log('üßπ All storage cleared');
                alert('All storage cleared! You may need to refresh the page.');
            } catch (error) {
                console.error('Error clearing storage:', error);
                alert('Error clearing storage: ' + error.message);
            }
        }
        
        function testSigninPage() {
            window.open('signin.html', '_blank');
        }
        
        function testAuthCallback() {
            window.open('post-auth.html', '_blank');
        }
        
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: location.href,
                testResults: testResults
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stayhi-auth-debug-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Auto-run tests on load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Starting incognito auth debugger...');
            
            await runEnvironmentTests();
            await runSupabaseTests();
            await runAuthTests();
            await runStorageTests();
            await runNavigationTests();
            
            console.log('‚úÖ All tests completed');
        });
    </script>
</body>
</html>