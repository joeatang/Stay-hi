<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Invite Management ‚Äî Stay Hi</title>
  
  <!-- Core dependencies -->
  <script src="assets/supabase-init.js"></script>
  <script src="assets/admin-auth.js"></script>
  <script src="assets/admin-codes.js"></script>
  <script src="assets/admin-ui.js"></script>
  
  <!-- Shared styles -->
  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>
  
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      font-family: system-ui, -apple-system, sans-serif;
      color: white;
    }
    .admin-container { max-width: 1200px; margin: 0 auto; }
    .admin-header { text-align: center; margin-bottom: 40px; }
    .admin-header h1 { font-size: 2.5rem; margin: 0 0 8px 0; font-weight: 900; }
    .admin-header p { opacity: 0.9; margin: 0; }
    
    #admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .stat-number { font-size: 2.5rem; font-weight: 900; color: #FFD93D; margin-bottom: 8px; }
    .stat-label { opacity: 0.8; font-size: 0.9rem; }
    
    .code-generator {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 32px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .code-generator h2 { margin: 0 0 24px 0; font-size: 1.5rem; }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 12px;
      align-items: end;
    }
    .form-input {
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 14px;
    }
    .form-input::placeholder { color: rgba(255,255,255,0.6); }
    .form-label { display: block; margin-bottom: 4px; font-size: 13px; opacity: 0.8; }
    .generate-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #4ECDC4, #44B3A8);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .generate-btn:hover { transform: translateY(-2px); }
    .generate-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    
    #code-result {
      display: none;
      background: rgba(78,205,196,0.2);
      border: 2px solid #4ECDC4;
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
      text-align: center;
    }
    .code-display {
      font-family: 'Monaco', monospace;
      font-size: 1.5rem;
      font-weight: 900;
      color: #4ECDC4;
      margin-bottom: 12px;
      letter-spacing: 2px;
    }
    .copy-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      background: #FFD93D;
      color: #1a1a1a;
      font-weight: 600;
      cursor: pointer;
    }
    
    .codes-section {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 32px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .codes-section h2 { margin: 0 0 24px 0; font-size: 1.5rem; }
    .codes-table {
      width: 100%;
      border-collapse: collapse;
    }
    .codes-table th,
    .codes-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .codes-table th {
      background: rgba(255,255,255,0.05);
      font-weight: 700;
      color: #4ECDC4;
    }
    .code-text {
      background: rgba(78,205,196,0.1);
      padding: 4px 8px;
      border-radius: 4px;
      font-family: monospace;
    }
    .status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .status-active { background: rgba(78,205,196,0.2); color: #4ECDC4; }
    .status-expired { background: rgba(255,107,107,0.2); color: #FF6B6B; }
    .status-used { background: rgba(255,209,61,0.2); color: #FFD93D; }
    .status-deactivated { background: rgba(150,150,150,0.2); color: #999; }
    .action-btn, .action-btn-danger {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      margin-right: 4px;
    }
    .action-btn { background: rgba(78,205,196,0.2); color: #4ECDC4; }
    .action-btn-danger { background: rgba(255,107,107,0.2); color: #FF6B6B; }
    .empty-state {
      text-align: center;
      padding: 40px;
      opacity: 0.7;
    }
    .muted { opacity: 0.7; font-size: 0.9rem; }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 1000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    .toast.show { opacity: 1; transform: translateX(0); }
    .toast-success { background: #10b981; color: white; }
    .toast-error { background: #ef4444; color: white; }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <h1>üéõÔ∏è Invite Management</h1>
      <p>Generate and manage invite codes for Stay Hi</p>
    </div>

    <!-- Stats Dashboard -->
    <div id="admin-stats"></div>

    <!-- Code Generator -->
    <div class="code-generator">
      <h2>Generate Invite Code</h2>
      <div style="margin-bottom:18px; font-size:15px; color:#222; background:rgba(255,255,255,0.12); border-radius:8px; padding:12px;">
        <strong>How it works:</strong> Generate codes for users to access Stay Hi. <br>
        <span style="color:#4ECDC4">24 Hours</span>: Temporary access for events/demos.<br>
        <span style="color:#FFD93D">1 Week</span>: Extended trial for beta testers.<br>
        <span style="color:#A259FF">Unique</span>: Single-use, never expires (VIP/personal).<br>
        <span style="color:#222">Max Uses</span>: How many times this code can be used.<br>
        <span style="color:#222">Notes</span>: Add context (recipient, purpose, etc).<br>
        <span style="color:#222">All codes can be upgraded to paid access later‚Äîusers keep their data.</span>
      </div>
      <form id="code-form" onsubmit="return false;">
        <div class="form-grid">
          <div>
            <label class="form-label" title="Type of code: 24h, 1 week, or unique single-use">Code Type</label>
            <select id="code-type" class="form-input" style="color:#222; background:#fff;">
              <option value="24h">24 Hours</option>
              <option value="1week">1 Week</option>
              <option value="unique">Unique (Single Use)</option>
            </select>
          </div>
          <div>
            <label class="form-label" title="How many times this code can be used">Max Uses</label>
            <input type="number" id="max-uses" class="form-input" value="10" min="1" style="color:#222; background:#fff;" />
          </div>
          <div>
            <label class="form-label" title="Add notes for context (e.g., recipient, event)">Notes (Optional)</label>
            <input type="text" id="notes" class="form-input" placeholder="e.g., Beta testers" style="color:#222; background:#fff;" />
          </div>
          <div>
            <label class="form-label" title="Click to generate code">&nbsp;</label>
            <button type="submit" id="generate-btn" class="generate-btn">‚ö° Generate</button>
          </div>
        </div>
      </form>
      <div id="code-result"></div>
    </div>

    <!-- Active Codes -->
    <div class="codes-section">
      <h2>Active Invite Codes</h2>
      <div id="codes-table"></div>
    </div>
  </div>

  <script src="assets/header.js"></script>
  <script>
    // App initialization
    (async function() {
      console.log('[admin-app] Initializing...');

      // Check admin auth
      const user = await AdminAuth.requireAdmin();
      if (!user) return; // Redirected if not admin

      // Load and display codes
      async function refreshCodes() {
        const result = await AdminCodes.loadCodes();
        if (result.success) {
          const stats = AdminCodes.calculateStats(result.codes);
          AdminUI.renderStats(stats);
          AdminUI.renderCodesTable(result.codes);
        }
      }

      await refreshCodes();

      // Handle code generation
      document.getElementById('code-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        AdminUI.setLoading('generate-btn', true);

        const type = document.getElementById('code-type').value;
        const maxUses = parseInt(document.getElementById('max-uses').value);
        const notes = document.getElementById('notes').value;

        const result = await AdminCodes.generateCode(type, { maxUses, notes });

        if (result.success) {
          AdminUI.showGeneratedCode(result.code);
          AdminUI.showToast('‚úÖ Code generated successfully!', 'success');
          await refreshCodes();
        } else {
          AdminUI.showToast('‚ùå Failed to generate code', 'error');
        }

        AdminUI.setLoading('generate-btn', false);
      });

      // Handle code deactivation
      window.addEventListener('admin-deactivate-code', async (e) => {
        const result = await AdminCodes.deactivateCode(e.detail.codeId);
        if (result.success) {
          AdminUI.showToast('‚úÖ Code deactivated', 'success');
          await refreshCodes();
        } else {
          AdminUI.showToast('‚ùå Failed to deactivate code', 'error');
        }
      });

      console.log('[admin-app] ‚úÖ Ready');
    })();
  </script>
</body>
</html>
