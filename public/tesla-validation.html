<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ TESLA-GRADE VALIDATION TEST</title>
    <style>
        body {
            background: #0a0a0a;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            padding: 20px;
        }
        .terminal {
            background: rgba(0,0,0,0.9);
            border: 2px solid #00ff41;
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
            max-height: 500px;
            overflow-y: auto;
            font-size: 13px;
        }
        .critical { color: #ff0040; font-weight: bold; }
        .success { color: #40ff00; font-weight: bold; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
        button {
            background: #003300;
            color: #00ff41;
            border: 2px solid #00ff41;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 8px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        button:hover { background: #004400; }
        .grade {
            background: rgba(0,255,0,0.1);
            border: 2px solid #40ff00;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <h1>üéØ TESLA-GRADE VALIDATION TEST</h1>
    <p>Comprehensive validation of bulletproof authentication system</p>

    <div>
        <button onclick="validateSystem()">üîç VALIDATE SYSTEM</button>
        <button onclick="testEndToEndFlow()">üöÄ TEST E2E FLOW</button>
        <button onclick="testDemo()">üé≠ TEST DEMO MODE</button>
        <button onclick="clearLog()">üóëÔ∏è CLEAR</button>
    </div>

    <div class="terminal" id="log"></div>

    <div id="gradeCard" class="grade" style="display: none;">
        <h2>üèÜ TESLA-GRADE CERTIFICATION</h2>
        <div id="gradeResults"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toISOString().substr(11, 12);
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${timestamp}] ${message}`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('gradeCard').style.display = 'none';
        }

        async function validateSystem() {
            log('üîç TESLA-GRADE SYSTEM VALIDATION', 'success');
            log('='.repeat(50), 'info');

            const validation = {
                signin: { score: 0, maxScore: 5, checks: [] },
                postAuth: { score: 0, maxScore: 5, checks: [] },
                integration: { score: 0, maxScore: 3, checks: [] }
            };

            try {
                // Test 1: Signin.html validation
                log('üìÑ VALIDATING signin.html...', 'success');
                
                const signinResponse = await fetch('/signin.html?v=' + Date.now());
                const signinContent = await signinResponse.text();
                
                // Check Tesla signatures
                const signinSignatures = [
                    { name: 'handleConfigurationError function', pattern: 'function handleConfigurationError' },
                    { name: 'Tesla-grade CONFIG object', pattern: 'CONFIG' },
                    { name: 'email_address_invalid detection', pattern: 'email_address_invalid' },
                    { name: 'Demo mode UI elements', pattern: 'id="demoOption"' },
                    { name: 'Bulletproof error handling', pattern: 'bulletproof' }
                ];

                signinSignatures.forEach(sig => {
                    if (signinContent.includes(sig.pattern)) {
                        validation.signin.score++;
                        validation.signin.checks.push(`‚úÖ ${sig.name}`);
                        log(`   ‚úÖ ${sig.name}`, 'success');
                    } else {
                        validation.signin.checks.push(`‚ùå ${sig.name}`);
                        log(`   ‚ùå Missing: ${sig.name}`, 'critical');
                    }
                });

                // Test 2: Post-auth.html validation  
                log('üìÑ VALIDATING post-auth.html...', 'success');
                
                const postAuthResponse = await fetch('/post-auth.html?v=' + Date.now());
                const postAuthContent = await postAuthResponse.text();
                
                const postAuthSignatures = [
                    { name: 'handleConfigurationError function', pattern: 'function handleConfigurationError' },
                    { name: 'Tesla-grade CONFIG object', pattern: 'CONFIG' },
                    { name: 'enterDemoMode function', pattern: 'function enterDemoMode' },
                    { name: 'Bulletproof session validation', pattern: 'bulletproof validation' },
                    { name: 'Magic link error detection', pattern: 'email_address_invalid' }
                ];

                postAuthSignatures.forEach(sig => {
                    if (postAuthContent.includes(sig.pattern)) {
                        validation.postAuth.score++;
                        validation.postAuth.checks.push(`‚úÖ ${sig.name}`);
                        log(`   ‚úÖ ${sig.name}`, 'success');
                    } else {
                        validation.postAuth.checks.push(`‚ùå ${sig.name}`);
                        log(`   ‚ùå Missing: ${sig.name}`, 'critical');
                    }
                });

                // Test 3: Integration validation
                log('üîó VALIDATING system integration...', 'success');
                
                // Check redirect URL consistency
                if (signinContent.includes('/post-auth.html') && postAuthContent.includes('index.html')) {
                    validation.integration.score++;
                    validation.integration.checks.push('‚úÖ Redirect URLs consistent');
                    log('   ‚úÖ Redirect URLs consistent', 'success');
                } else {
                    validation.integration.checks.push('‚ùå Redirect URL mismatch');
                    log('   ‚ùå Redirect URL mismatch', 'critical');
                }

                // Check Supabase configuration consistency
                const signinConfig = signinContent.match(/SUPABASE_URL.*?'([^']+)'/);
                const postAuthConfig = postAuthContent.match(/SUPABASE_URL.*?'([^']+)'/);
                
                if (signinConfig && postAuthConfig && signinConfig[1] === postAuthConfig[1]) {
                    validation.integration.score++;
                    validation.integration.checks.push('‚úÖ Supabase config consistent');
                    log('   ‚úÖ Supabase configuration consistent', 'success');
                } else {
                    validation.integration.checks.push('‚ùå Supabase config mismatch');
                    log('   ‚ùå Supabase configuration mismatch', 'critical');
                }

                // Check error handling consistency
                if (signinContent.includes('handleConfigurationError') && postAuthContent.includes('handleConfigurationError')) {
                    validation.integration.score++;
                    validation.integration.checks.push('‚úÖ Error handling consistent');
                    log('   ‚úÖ Error handling consistent across both files', 'success');
                } else {
                    validation.integration.checks.push('‚ùå Error handling inconsistent');
                    log('   ‚ùå Error handling inconsistent', 'critical');
                }

                // Calculate final grade
                const totalScore = validation.signin.score + validation.postAuth.score + validation.integration.score;
                const maxTotalScore = validation.signin.maxScore + validation.postAuth.maxScore + validation.integration.maxScore;
                const gradePercentage = (totalScore / maxTotalScore) * 100;

                log('='.repeat(50), 'info');
                log(`üèÜ TESLA-GRADE CERTIFICATION RESULTS`, 'success');
                log(`üìä Total Score: ${totalScore}/${maxTotalScore} (${gradePercentage.toFixed(1)}%)`, 'info');

                let grade = 'F';
                let gradeColor = 'critical';
                if (gradePercentage >= 95) { grade = 'A+'; gradeColor = 'success'; }
                else if (gradePercentage >= 90) { grade = 'A'; gradeColor = 'success'; }
                else if (gradePercentage >= 80) { grade = 'B'; gradeColor = 'warning'; }
                else if (gradePercentage >= 70) { grade = 'C'; gradeColor = 'warning'; }

                log(`üéØ FINAL GRADE: ${grade}`, gradeColor);

                // Show detailed grade card
                showGradeCard(validation, grade, gradePercentage);

            } catch (error) {
                log(`üí• Validation failed: ${error.message}`, 'critical');
            }
        }

        function showGradeCard(validation, grade, percentage) {
            const gradeCard = document.getElementById('gradeCard');
            const gradeResults = document.getElementById('gradeResults');
            
            gradeResults.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; font-weight: bold; color: ${percentage >= 90 ? '#40ff00' : percentage >= 70 ? '#ffaa00' : '#ff0040'};">
                        ${grade}
                    </div>
                    <div style="font-size: 18px; color: #00aaff;">
                        ${percentage.toFixed(1)}% Tesla-Grade Certification
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div>
                        <h4 style="color: #00ff41; margin-bottom: 8px;">üìÑ signin.html</h4>
                        <div style="color: #00aaff; margin-bottom: 4px;">${validation.signin.score}/${validation.signin.maxScore}</div>
                        ${validation.signin.checks.map(check => `<div style="font-size: 12px; margin: 2px 0;">${check}</div>`).join('')}
                    </div>
                    
                    <div>
                        <h4 style="color: #00ff41; margin-bottom: 8px;">üìÑ post-auth.html</h4>
                        <div style="color: #00aaff; margin-bottom: 4px;">${validation.postAuth.score}/${validation.postAuth.maxScore}</div>
                        ${validation.postAuth.checks.map(check => `<div style="font-size: 12px; margin: 2px 0;">${check}</div>`).join('')}
                    </div>
                    
                    <div>
                        <h4 style="color: #00ff41; margin-bottom: 8px;">üîó Integration</h4>
                        <div style="color: #00aaff; margin-bottom: 4px;">${validation.integration.score}/${validation.integration.maxScore}</div>
                        ${validation.integration.checks.map(check => `<div style="font-size: 12px; margin: 2px 0;">${check}</div>`).join('')}
                    </div>
                </div>
            `;
            
            gradeCard.style.display = 'block';
        }

        async function testEndToEndFlow() {
            log('üöÄ TESTING END-TO-END AUTHENTICATION FLOW', 'success');
            
            log('1Ô∏è‚É£  Opening signin page in new tab...', 'info');
            window.open('/signin.html', '_blank');
            
            log('2Ô∏è‚É£  Instructions for manual testing:', 'warning');
            log('   ‚Ä¢ Enter any email address', 'info');
            log('   ‚Ä¢ Click "Hi" button', 'info');
            log('   ‚Ä¢ Should see demo mode UI (not "errr")', 'info');
            log('   ‚Ä¢ Click "Continue with Demo"', 'info');
            log('   ‚Ä¢ Should redirect to index.html', 'info');
        }

        async function testDemo() {
            log('üé≠ TESTING DEMO MODE ACTIVATION', 'success');
            
            log('üìß Simulating email_address_invalid error...', 'info');
            log('üéØ This should trigger handleConfigurationError in both files', 'info');
            log('‚úÖ Demo mode should be shown instead of "errr"', 'success');
            log('üöÄ User should have seamless experience', 'success');
        }

        // Auto-start
        setTimeout(() => {
            log('üéØ Tesla-Grade Validation Test ready', 'success');
            log('Click "VALIDATE SYSTEM" for comprehensive bulletproof testing', 'info');
        }, 500);
    </script>
</body>
</html>