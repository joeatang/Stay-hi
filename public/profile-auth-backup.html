<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Profile â€” Stay Hi</title>
  
  <!-- ðŸ”¥ CRITICAL: Supabase CDN - Must load FIRST before supabase-init.js -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" as="script">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  
  <!-- Core Systems -->
  <script src="assets/supabase-init.js"></script>
  
  <!-- Auth guard - must be first -->
  <script src="assets/url-path-fixer.js"></script>
  <script src="assets/auth-health-monitor.js"></script>
  <script src="assets/auth-guard.js?v=enhanced-logging"></script>
  <script src="assets/demo-auth.js"></script>
  
  <!-- Tesla-Grade Performance Optimization -->
  <script src="assets/performance-manager.js"></script>
  <script src="assets/image-optimizer.js"></script>
  <script src="assets/avatar-utils.js"></script>
  <script src="assets/location-picker.js"></script>
  
  <!-- Critical CSS will be bundled by performance manager -->
  <link rel="preload" href="assets/theme.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="assets/theme.css"></noscript>
  <link rel="preload" href="assets/location-picker.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="assets/location-picker.css"></noscript>
  
  <!-- Non-critical CSS lazy loaded -->
  <link rel="preload" href="assets/premium-ux.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="assets/premium-stats.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="assets/premium-calendar.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="assets/premium-footer.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="assets/premium-ux.css">
    <link rel="stylesheet" href="assets/premium-stats.css">
    <link rel="stylesheet" href="assets/premium-calendar.css">
    <link rel="stylesheet" href="assets/premium-footer.css">
  </noscript>
  
  <style>
    /* Tesla-Inspired Gold Standard Profile */
    :root {
      --profile-accent: #4ECDC4;
      --profile-secondary: #FFD93D;
      --profile-danger: #FF6B6B;
      --profile-success: #4ECDC4;
    }
    

    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui;
      background: linear-gradient(135deg, #0F0F23 0%, #1A1A2E 50%, #16213E 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }
    
    /* Force profile content to display */
    .profile-container {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* Header overrides removed to match index.html gold standard */
    
    /* Ensure profile container starts below header */
    .profile-container {
      margin-top: 0;
      padding-top: 0;
    }
    
    /* Ensure no stray elements appear */
    body::before, body::after {
      display: none !important;
    }
    
    /* Ensure profile loads properly */
    .profile-hero, .profile-header, .profile-info, .profile-stats, .achievements {
      display: block !important;
      visibility: visible !important;
    }
    
    /* Hide any index.html elements that might appear */
    .hi-medal, .weekstrip, .announce, .center, .spaced {
      display: none !important;
    }
    
    /* Hide edit controls for shared profiles */
    body.viewing-shared-profile .avatar-upload-overlay,
    body.viewing-shared-profile .btn-tesla:not(.btn-secondary),
    body.viewing-shared-profile #editSection,
    body.viewing-shared-profile input[type="file"] {
      display: none !important;
    }
    
    /* Show public view indicator for shared profiles */
    body.viewing-shared-profile .profile-title::after {
      content: " (Public View)";
      font-size: 18px;
      opacity: 0.7;
      font-weight: 400;
    }
    
    /* Tesla-Grade Edit Profile Sheet Modal */
    .edit-sheet-overlay {
      position: fixed !important;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 999999 !important; /* Supreme z-index for guaranteed visibility */
      display: none;
      align-items: flex-end;
      justify-content: center;
      padding: 0;
      animation: fadeIn 0.3s ease;
    }
    
    .edit-sheet-overlay.show {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    .edit-sheet {
      background: var(--glass-bg);
      backdrop-filter: blur(30px);
      border: 1px solid var(--glass-border);
      border-radius: 24px 24px 0 0;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      color: white;
      box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.5);
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .edit-sheet-overlay.show .edit-sheet {
      transform: translateY(0);
    }
    
    .edit-sheet-header {
      position: sticky;
      top: 0;
      background: rgba(15, 15, 35, 0.95);
      backdrop-filter: blur(20px);
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }
    
    .edit-sheet-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }
    
    .edit-sheet-close {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .edit-sheet-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    
    .edit-sheet-body {
      padding: 24px;
    }
    
    /* Edit sheet specific input styles */
    .edit-sheet .form-input {
      background: #ffffff !important;
      color: #000000 !important;
      -webkit-text-fill-color: #000000 !important;
      font-weight: 500;
    }
    
    .edit-sheet .form-input::placeholder {
      color: rgba(0, 0, 0, 0.4) !important;
      -webkit-text-fill-color: rgba(0, 0, 0, 0.4) !important;
    }
    
    .edit-sheet .form-input:-webkit-autofill {
      -webkit-box-shadow: 0 0 0 30px #ffffff inset !important;
      -webkit-text-fill-color: #000000 !important;
    }
    
    .edit-sheet-footer {
      position: sticky;
      bottom: 0;
      background: rgba(15, 15, 35, 0.95);
      backdrop-filter: blur(20px);
      padding: 20px 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    @media (min-width: 768px) {
      .edit-sheet-overlay {
        align-items: center;
        padding: 20px;
      }
      
      .edit-sheet {
        border-radius: 24px;
        max-height: 85vh;
      }
    }
    
    /* Hide old edit section */
    #editSection {
      display: none !important;
    }
    
    /* TESLA GOLD STANDARD AVATAR CROP CSS */
    .tesla-sheet-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      z-index: 999999;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }
    
    .tesla-sheet-modal.active {
      display: flex;
    }
    
    .tesla-sheet-content {
      background: var(--glass-bg);
      backdrop-filter: blur(30px);
      border: 1px solid var(--glass-border);
      border-radius: 24px 24px 0 0;
      width: 100%;
      max-width: 450px;
      max-height: 80vh;
      color: white;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.25,0.8,0.25,1);
    }
    
    .tesla-sheet-modal.active .tesla-sheet-content {
      transform: translateY(0);
    }
    
    .tesla-sheet-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .tesla-sheet-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    
    .tesla-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    
    .tesla-close:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .tesla-sheet-body {
      padding: 20px;
    }
    
    .tesla-crop-area {
      position: relative;
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    
    .tesla-sheet-footer {
      padding: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    #teslaCanvas {
      width: 260px;
      height: 260px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      cursor: grab;
      position: relative;
    }
    
    #teslaCanvas:active { cursor: grabbing; }
    
    .tesla-crop-circle {
      position: absolute;
      top: 50%; left: 50%;
      width: 180px; height: 180px;
      border: 3px solid #4ECDC4;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      box-shadow: 0 0 0 200px rgba(0,0,0,0.5);
    }
    
    .tesla-controls {
      margin-top: 16px;
    }
    
    .tesla-label {
      display: block;
      font-size: 14px;
      color: rgba(255,255,255,0.8);
      margin-bottom: 8px;
    }
    
    .tesla-range {
      width: 100%;
      -webkit-appearance: none;
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      outline: none;
    }
    
    .tesla-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px; height: 18px;
      background: #4ECDC4;
      border-radius: 50%;
      cursor: pointer;
    }
    
    .tesla-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tesla-secondary {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .tesla-primary {
      background: linear-gradient(135deg, #4ECDC4, #FFD93D);
      color: black;
    }
    
    .tesla-btn:hover {
      transform: translateY(-1px);
    }
    
    /* Tesla-Grade Success Animation */
    @keyframes tesla-success {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .tesla-success {
      animation: tesla-success 0.6s ease-in-out !important;
      background: linear-gradient(135deg, #4ECDC4, #50E3C2) !important;
      
      .crop-header h3 {
        font-size: 20px;
      }
    }
    
    @media (max-width: 480px) {
      .crop-content {
        padding: 20px;
        border-radius: 16px 16px 0 0;
      }
      
      .crop-preview {
        height: 250px;
        max-width: 250px;
      }
      
      .crop-circle {
        width: 160px;
        height: 160px;
      }
      
      #cropCanvas {
        border-radius: 16px;
      }
    }
    
    /* Form note styling */
    .form-note {
      padding: 16px;
      background: rgba(78, 205, 196, 0.05);
      border: 1px solid rgba(78, 205, 196, 0.15);
      border-radius: 12px;
      margin: 16px 0;
    }
    
    /* Tesla-Style Toast Notifications */
    .tesla-toast {
      position: fixed;
      top: 24px;
      right: 24px;
      background: var(--glass-bg);
      backdrop-filter: blur(25px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      transform: translateX(calc(100% + 24px));
      transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
      z-index: 10000;
      max-width: 320px;
    }
    
    .tesla-toast.show {
      transform: translateX(0);
    }
    
    .tesla-toast-error {
      border-color: rgba(255, 107, 107, 0.3);
      background: linear-gradient(135deg, 
        rgba(255, 107, 107, 0.1), 
        rgba(0, 0, 0, 0.8)
      );
    }
    
    .tesla-toast-success {
      border-color: rgba(78, 205, 196, 0.3);
      background: linear-gradient(135deg, 
        rgba(78, 205, 196, 0.1), 
        rgba(0, 0, 0, 0.8)
      );
    }
    
    .tesla-toast-info {
      border-color: rgba(255, 217, 61, 0.3);
      background: linear-gradient(135deg, 
        rgba(255, 217, 61, 0.1), 
        rgba(0, 0, 0, 0.8)
      );
    }
    
    .toast-icon {
      font-size: 18px;
      flex-shrink: 0;
    }
    
    .toast-message {
      flex: 1;
      line-height: 1.4;
    }
    
    @media (max-width: 480px) {
      .tesla-toast {
        right: 12px;
        left: 12px;
        max-width: none;
        transform: translateY(-100px);
      }
      
      .tesla-toast.show {
        transform: translateY(0);
      }
    }
    
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 30% 30%, rgba(78, 205, 196, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 70% 70%, rgba(255, 217, 61, 0.08) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    .profile-container {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 24px 24px 24px;
      animation: profileFadeIn 1.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    /* Clean Back Navigation */
    .back-navigation {
      margin-bottom: 32px;
      padding-top: 16px;
    }
    
    .back-to-home {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 16px 24px;
      background: var(--glass-bg);
      backdrop-filter: blur(25px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .back-to-home:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(78, 205, 196, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(78, 205, 196, 0.2);
    }
    
    .back-to-home svg {
      transition: transform 0.3s ease;
    }
    
    .back-to-home:hover svg {
      transform: translateX(-2px);
    }
    
    /* Clean Profile Header */
    .profile-header {
      margin-bottom: 40px;
      padding: 24px 8px;
    }
    
    .profile-title-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    
    .profile-title {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #4ECDC4 0%, #FFD93D 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }
    
    .share-profile-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .share-profile-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(78, 205, 196, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(78, 205, 196, 0.2);
    }
    
    .nav-back {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 24px;
      background: var(--glass-bg);
      backdrop-filter: blur(25px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
    }
    
    .nav-back::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .nav-back:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
    }
    
    .nav-back:hover::before {
      opacity: 1;
    }
    
    .quick-stats {
      display: flex;
      gap: 16px;
      justify-content: center;
    }
    
    .stat-badge {
      background: var(--glass-bg);
      backdrop-filter: blur(25px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 12px 20px;
      color: white;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .stat-badge:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(78, 205, 196, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(78, 205, 196, 0.15);
    }
    
    .quick-stats {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .stat-badge {
      padding: 12px 20px;
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      color: white;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .stat-badge:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }
    
    /* Hero Profile Section */
    .profile-hero {
      background: var(--glass-bg);
      backdrop-filter: blur(30px);
      border: 1px solid var(--glass-border);
      border-radius: 32px;
      padding: 48px;
      margin-bottom: 32px;
      box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      color: white;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .profile-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
      transition: left 0.8s ease;
    }
    
    .profile-hero:hover::before {
      left: 100%;
    }
    
    .avatar-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      margin-bottom: 40px;
    }
    
    .profile-avatar-container {
      position: relative;
      display: inline-block;
      /* Tesla-Grade Container Stability */
      width: 140px;
      height: 140px;
      /* Prevent container from affecting image */
      overflow: hidden;
      border-radius: 50%;
      /* GPU acceleration for smooth interactions */
      transform: translateZ(0);
      will-change: auto;
      /* Prevent layout shifts */
      flex-shrink: 0;
    }
    
    .profile-avatar {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      object-fit: cover;
      object-position: center center;
      border: 4px solid rgba(255, 255, 255, 0.2);
      background: var(--gradient-premium);
      box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        0 0 40px rgba(78, 205, 196, 0.2);
      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor: pointer;
      /* Tesla-Grade Image Stability */
      display: block;
      /* Prevent aspect ratio distortion */
      aspect-ratio: 1 / 1;
      /* Smooth image rendering */
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      /* Prevent image dragging */
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
      /* Ensure proper placeholder centering */
      text-align: center;
      line-height: 140px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
      /* Prevent text selection */
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    /* Hide alt text when image is loaded */
    .profile-avatar[src]:not([src=""]) {
      color: transparent;
      text-indent: -9999px;
    }
    
    /* Tesla-Grade Avatar Placeholder */
    .avatar-placeholder {
      position: absolute;
      inset: 4px; /* Account for border */
      border-radius: 50%;
      background: linear-gradient(135deg, 
        rgba(78, 205, 196, 0.1), 
        rgba(255, 217, 61, 0.1));
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      pointer-events: none;
    }
    
    .avatar-placeholder.hidden {
      opacity: 0;
      visibility: hidden;
    }
    
    .placeholder-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
    }
    
    .placeholder-text {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    /* Tesla-Grade Toast Notifications */
    .tesla-toast {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui;
    }
    
    .tesla-toast .toast-content {
      display: flex !important;
      align-items: center !important;
      gap: 12px !important;
      padding: 16px 20px !important;
      position: relative !important;
    }
    
    .tesla-toast .toast-icon {
      flex-shrink: 0 !important;
    }
    
    .tesla-toast-success .toast-icon {
      color: #4ECDC4 !important;
    }
    
    .tesla-toast-error .toast-icon {
      color: #FF6B6B !important;
    }
    
    .tesla-toast-warning .toast-icon {
      color: #FFD93D !important;
    }
    
    .tesla-toast-info .toast-icon {
      color: #6C7CE7 !important;
    }
    
    .tesla-toast .toast-message {
      flex: 1 !important;
      font-size: 14px !important;
      font-weight: 500 !important;
      line-height: 1.4 !important;
    }
    
    .tesla-toast .toast-close {
      background: none !important;
      border: none !important;
      color: rgba(255, 255, 255, 0.6) !important;
      cursor: pointer !important;
      padding: 4px !important;
      border-radius: 6px !important;
      transition: all 0.2s ease !important;
      flex-shrink: 0 !important;
    }
    
    .tesla-toast .toast-close:hover {
      background-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    .tesla-toast .toast-progress {
      position: absolute !important;
      bottom: 0 !important;
      left: 0 !important;
      height: 3px !important;
      transition: width 4000ms linear !important;
    }
    
    .tesla-toast-success .toast-progress {
      background: #4ECDC4 !important;
    }
    
    .tesla-toast-error .toast-progress {
      background: #FF6B6B !important;
    }
    
    .tesla-toast-warning .toast-progress {
      background: #FFD93D !important;
    }
    
    .tesla-toast-info .toast-progress {
      background: #6C7CE7 !important;
    }
    
    .profile-avatar:hover {
      /* Tesla-Grade Hover: No stretching, pure enhancement */
      transform: scale(1.05) translateZ(0);
      box-shadow: 
        0 35px 70px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.3),
        0 0 60px rgba(78, 205, 196, 0.4);
      /* Maintain aspect ratio during hover */
      width: 140px;
      height: 140px;
      /* Smooth GPU-accelerated transformation */
      will-change: transform;
      /* Prevent layout shifts */
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }
    
    /* Tesla-Grade Avatar Upload */
    .avatar-upload-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
      backdrop-filter: blur(20px);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
      cursor: pointer;
      border: 2px solid transparent;
      overflow: hidden;
    }
    
    .avatar-upload-overlay::before {
      content: '';
      position: absolute;
      inset: -2px;
      background: linear-gradient(45deg, #4ECDC4, #FFD93D, #4ECDC4);
      border-radius: 50%;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.6s ease;
    }
    
    .profile-avatar-container:hover .avatar-upload-overlay {
      opacity: 1;
      /* Maintain overlay size to prevent stretching */
      transform: translateZ(0);
      border-color: rgba(78, 205, 196, 0.6);
      /* Tesla-Grade Stability */
      width: 100%;
      height: 100%;
    }
    
    .profile-avatar-container:hover .avatar-upload-overlay::before {
      opacity: 0.7;
    }
    
    .upload-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      color: white;
      text-align: center;
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
      z-index: 2;
    }
    
    .upload-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
    }
    
    .upload-icon svg {
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
    }
    
    .upload-text {
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 0 2px 12px rgba(0, 0, 0, 0.7);
      opacity: 0.95;
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
    }
    
    .avatar-upload-overlay:hover .upload-content {
      transform: translateY(-2px);
    }
    
    .avatar-upload-overlay:hover .upload-icon {
      background: rgba(78, 205, 196, 0.2);
      transform: scale(1.1);
    }
    
    .avatar-upload-overlay:hover .upload-icon svg {
      transform: scale(1.1);
      stroke: #4ECDC4;
    }
    
    .avatar-upload-overlay:hover .upload-text {
      opacity: 1;
      color: #4ECDC4;
    }
    
    /* Processing State */
    .avatar-upload-overlay.processing {
      opacity: 1 !important;
      background: linear-gradient(135deg, rgba(78, 205, 196, 0.3), rgba(255, 217, 61, 0.2));
      transform: scale(1.05) !important;
      cursor: wait;
    }
    
    .avatar-upload-overlay.processing::before {
      opacity: 1;
      animation: rotate 2s linear infinite;
    }
    
    .avatar-upload-overlay.processing .upload-content {
      opacity: 0;
      transform: scale(0.8);
    }
    
    .upload-progress {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 3;
    }
    
    .avatar-upload-overlay.processing .upload-progress {
      opacity: 1;
    }
    
    .progress-ring {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    
    .progress-circle {
      transition: stroke-dashoffset 0.5s cubic-bezier(0.23, 1, 0.32, 1);
      transform-origin: center;
      animation: progress-spin 2s linear infinite;
    }
    
    .progress-text {
      color: white;
      font-size: 12px;
      font-weight: 600;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @keyframes progress-spin {
      from { transform: rotate(-90deg); }
      to { transform: rotate(270deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }
    
    .profile-info {
      text-align: center;
    }
    
    .profile-username {
      font-size: 28px;
      font-weight: 800;
      color: white;
      margin: 0 0 8px 0;
      background: linear-gradient(135deg, #4ECDC4 0%, #FFD93D 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    /* Email display removed for privacy */
    
    .profile-joined {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.5);
      margin: 0;
    }
    
    .profile-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 32px;
    }
    
    /* Tesla-Style Buttons */
    .btn-tesla {
      position: relative;
      padding: 16px 32px;
      border: none;
      border-radius: 16px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      backdrop-filter: blur(15px);
      overflow: hidden;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-tesla::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.6s ease;
    }
    
    .btn-tesla:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: var(--gradient-premium);
      color: white;
      box-shadow: 0 8px 25px rgba(78, 205, 196, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(78, 205, 196, 0.4);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    /* Dashboard Grid */
    .profile-dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin-bottom: 32px;
    }
    
    .dashboard-section {
      background: var(--glass-bg);
      backdrop-filter: blur(25px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 32px;
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      color: white;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .dashboard-section:hover {
      transform: translateY(-4px);
      box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .section-icon {
      font-size: 24px;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: white;
      margin: 0;
    }
    
    /* Statistics Display */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
    }
    
    .stat-item {
      text-align: center;
      padding: 20px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .stat-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, #4ECDC4 0%, #FFD93D 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 13px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.7);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Achievements */
    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 16px;
    }
    
    .achievement-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .achievement-badge.unlocked {
      border-color: rgba(255, 215, 0, 0.5);
      background: rgba(255, 215, 0, 0.1);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
    }
    
    .achievement-badge.unlocked::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 215, 0, 0.1) 50%, transparent 70%);
      animation: achievement-shine 3s ease-in-out infinite;
    }
    
    @keyframes achievement-shine {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }
    
    .achievement-badge:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .achievement-icon {
      font-size: 32px;
      margin-bottom: 12px;
      transition: transform 0.3s ease;
    }
    
    .achievement-badge:hover .achievement-icon {
      transform: scale(1.1) rotate(5deg);
    }
    
    .achievement-name {
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.3;
    }
    
    .achievement-progress {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 4px;
    }
    
    /* Edit Profile Form */
    .edit-form {
      background: var(--glass-bg);
      backdrop-filter: blur(25px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 32px;
      box-shadow: var(--shadow-premium);
      color: white;
      margin-top: 32px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    .form-label {
      font-size: 14px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 4px;
    }
    
    .form-input {
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 14px;
      color: #1a1a1a !important;
      font-size: 16px;
      font-weight: 500;
      backdrop-filter: blur(10px);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      resize: vertical;
      -webkit-text-fill-color: #1a1a1a !important;
    }
    
    /* Override autofill styles */
    .form-input:-webkit-autofill,
    .form-input:-webkit-autofill:hover,
    .form-input:-webkit-autofill:focus,
    .form-input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0 30px rgba(255, 255, 255, 0.95) inset !important;
      -webkit-text-fill-color: #1a1a1a !important;
      color: #1a1a1a !important;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #4ECDC4;
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
      transform: translateY(-1px);
    }
    
    .form-input::placeholder {
      color: rgba(26, 26, 26, 0.5) !important;
      -webkit-text-fill-color: rgba(26, 26, 26, 0.5) !important;
    }
    
    /* Location Input with Geo-tagging */
    .location-input-container {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .location-input-container .form-input {
      flex: 1;
    }
    
    .location-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(78, 205, 196, 0.1);
      border: 1px solid rgba(78, 205, 196, 0.3);
      border-radius: 12px;
      color: #4ECDC4;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .location-btn:hover {
      background: rgba(78, 205, 196, 0.2);
      border-color: rgba(78, 205, 196, 0.5);
      transform: translateY(-1px);
    }
    
    .location-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .location-privacy {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      margin: 8px 0 0 0;
      font-style: italic;
    }
    
    .file-upload-area {
      position: relative;
      padding: 32px;
      border: 2px dashed rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.05);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .file-upload-area:hover {
      border-color: #4ECDC4;
      background: rgba(78, 205, 196, 0.1);
    }
    
    .file-upload-area.dragover {
      border-color: #4ECDC4;
      background: rgba(78, 205, 196, 0.15);
      transform: scale(1.02);
    }
    
    .upload-text {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }
    
    .file-input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }
    
    /* Status Messages */
    .status-message {
      padding: 16px 20px;
      border-radius: 14px;
      margin: 20px 0;
      font-weight: 600;
      text-align: center;
      backdrop-filter: blur(10px);
      animation: statusSlideIn 0.4s ease-out;
    }
    
    @keyframes statusSlideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .status-success {
      background: rgba(76, 175, 80, 0.15);
      border: 1px solid rgba(76, 175, 80, 0.3);
      color: #81C784;
    }
    
    .status-error {
      background: rgba(244, 67, 54, 0.15);
      border: 1px solid rgba(244, 67, 54, 0.3);
      color: #EF5350;
    }
    
    .status-info {
      background: rgba(33, 150, 243, 0.15);
      border: 1px solid rgba(33, 150, 243, 0.3);
      color: #64B5F6;
    }
    
    /* Loading States */
    .loading-spinner {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    
    .loading-dots {
      display: inline-flex;
      gap: 4px;
    }
    
    .loading-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      animation: loadingPulse 1.4s ease-in-out infinite both;
    }
    
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes loadingPulse {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1.2); opacity: 1; }
    }
    
    /* Share modal removed for cleaner interface */
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 1024px) {
      .profile-dashboard {
        grid-template-columns: 1fr;
        gap: 24px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }
    
    @media (max-width: 768px) {
      .profile-container {
        padding: 16px;
      }
      
      .profile-title-section {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
      
      .profile-title {
        font-size: 2rem;
      }
      
      .quick-stats {
        justify-content: center;
        flex-wrap: wrap;
        gap: 12px;
      }
      
      /* Header padding override removed to use default gold standard */
      
      .profile-hero {
        padding: 32px 24px;
      }
      
      .profile-avatar {
        width: 120px;
        height: 120px;
      }
      
      .profile-actions {
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      
      .btn-tesla {
        width: 100%;
        justify-content: center;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .achievements-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .quick-stats {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .edit-form {
        padding: 24px;
      }
    }
    
    /* Animations */
    @keyframes profileFadeIn {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }
    
    .shake-animation {
      animation: shake 0.5s ease-in-out;
    }
    
    /* Tesla Processing Animations */
    .tesla-processing {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .tesla-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      animation: tesla-spin 0.8s linear infinite;
    }
    
    .tesla-checkmark {
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, #4ECDC4, #44B3A8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 10px;
      font-weight: bold;
      animation: tesla-checkmark-pop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @keyframes tesla-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes tesla-checkmark-pop {
      0% { 
        transform: scale(0) rotate(-45deg);
        opacity: 0;
      }
      50% { 
        transform: scale(1.2) rotate(0deg);
        opacity: 1;
      }
      100% { 
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }
    
    /* Enhanced Upload Processing States */
    .upload-step.processing {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      animation: tesla-processing-pulse 1.5s ease-in-out infinite;
    }
    
    .upload-step.complete {
      background: linear-gradient(135deg, #4ECDC4 0%, #44B3A8 100%);
      color: white;
      animation: tesla-success-glow 0.6s ease-out;
    }
    
    @keyframes tesla-processing-pulse {
      0%, 100% { 
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 30px rgba(102, 126, 234, 0.6);
        transform: scale(1.02);
      }
    }
    
    @keyframes tesla-success-glow {
      0% { 
        box-shadow: 0 0 0 rgba(78, 205, 196, 0);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 25px rgba(78, 205, 196, 0.6);
        transform: scale(1.05);
      }
      100% { 
        box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
        transform: scale(1);
      }
    }
  </style>
</head>
<body data-tab="profile">

  
  <!-- Header removed for clean profile focus -->
  
  <div class="profile-container">
    <!-- Clean Back Navigation -->
    <div class="back-navigation">
      <a href="index.html" class="back-to-home">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M19 12H5"/>
          <path d="M12 19l-7-7 7-7"/>
        </svg>
        Back to Home
      </a>
    </div>
    
    <!-- Clean Profile Header -->
    <header class="profile-header">
      <div class="profile-title-section">
        <h1 class="profile-title">Your Profile</h1>
      </div>
    </header>
    
    <!-- Profile Hero Section -->
    <section class="profile-hero" id="profileHero" style="opacity: 0; transition: opacity 0.3s ease;">
      <div class="avatar-section">
        <div class="profile-avatar-container" id="avatarContainer">
          <img id="profileAvatar" class="profile-avatar" src="" alt="" />
          <div class="avatar-placeholder" id="avatarPlaceholder">
            <div class="placeholder-content">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span class="placeholder-text">Add Photo</span>
            </div>
          </div>
          <div class="avatar-upload-overlay" id="avatarUploadOverlay">
            <div class="upload-content">
              <div class="upload-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                  <circle cx="12" cy="13" r="3"/>
                </svg>
              </div>
              <span class="upload-text">Update Photo</span>
            </div>
            <div class="upload-progress" id="uploadProgress">
              <div class="progress-ring">
                <svg width="60" height="60" viewBox="0 0 60 60">
                  <circle cx="30" cy="30" r="25" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2"/>
                  <circle cx="30" cy="30" r="25" fill="none" stroke="#4ECDC4" stroke-width="3" 
                          stroke-linecap="round" stroke-dasharray="157" stroke-dashoffset="157" 
                          class="progress-circle"/>
                </svg>
                <div class="progress-text">Processing...</div>
              </div>
            </div>
          </div>
          <input type="file" id="avatarFileInput" accept="image/jpeg,image/jpg,image/png,image/webp,image/avif" style="display: none;" />
        </div>
        
        <div class="profile-info">
          <h2 id="profileUsername" class="profile-username">@username</h2>
          <p id="profileBio" class="profile-bio" style="
            font-size: 15px;
            color: rgba(255, 255, 255, 0.8);
            margin: 8px 0 0 0;
            line-height: 1.5;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
          "></p>
          <p id="profileLocation" style="
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin: 4px 0 0 0;
            display: none;
          "></p>
          <p id="profileJoined" class="profile-joined">Member since October 2025</p>
          <div id="locationStatus" class="location-status" style="display: none;"></div>
        </div>
      </div>
      
      <div class="profile-actions">
        <button class="btn-tesla btn-primary" onclick="editProfile()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Edit Profile
        </button>
        
        <button class="btn-tesla btn-secondary" onclick="shareProfile()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
          Share Profile
        </button>
        
        <button class="btn-tesla btn-secondary" onclick="openCalendar()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          View Calendar
        </button>
        
        <!-- Debug: Test Tesla Crop System -->
        <button class="btn-tesla btn-primary" onclick="testTeslaCrop()" style="margin-top: 12px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
            <polyline points="10,17 15,12 10,7"/>
            <line x1="15" y1="12" x2="3" y2="12"/>
          </svg>
          ðŸ”§ Test Avatar Crop
        </button>
        
        <!-- Emergency Profile Load -->
        <button class="btn-tesla btn-secondary" onclick="emergencyProfileLoad()" style="margin-top: 12px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="m2 17 10 5 10-5"/>
            <path d="m2 12 10 5 10-5"/>
          </svg>
          ðŸ†˜ Force Load Profile
        </button>
      </div>
    </section>
    
    <!-- Dashboard Grid -->
    <div class="profile-dashboard">
      <!-- Statistics Section -->
      <section class="dashboard-section">
        <div class="section-header">
          <span class="section-icon">ï¿½</span>
          <h3 class="section-title">Hi Statistics</h3>
        </div>
        <div class="stats-grid" id="statsGrid">
          <!-- Stats populated by JavaScript -->
        </div>
      </section>
      
      <!-- Achievements Section -->
      <section class="dashboard-section">
        <div class="section-header">
          <span class="section-icon">ðŸ†</span>
          <h3 class="section-title">Achievements</h3>
        </div>
        <div class="achievements-grid" id="achievementsGrid">
          <!-- Achievements populated by JavaScript -->
        </div>
      </section>
    </div>
    
    <!-- Edit Profile Form -->
    <section class="edit-form" id="editSection" style="display: none;">
      <div class="section-header">
        <span class="section-icon">âœï¸</span>
        <h3 class="section-title">Edit Your Profile</h3>
      </div>
      
      <form id="profileForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="usernameInput">Username</label>
            <input type="text" id="usernameInput" class="form-input" placeholder="Choose your username" maxlength="30" />
          </div>
          
          <div class="form-group">
            <label class="form-label" for="displayNameInput">Display Name</label>
            <input type="text" id="displayNameInput" class="form-input" placeholder="Your display name" maxlength="50" />
          </div>
          
          <div class="form-group full-width">
            <label class="form-label" for="bioInput">Bio</label>
            <textarea id="bioInput" class="form-input" placeholder="Tell us about yourself..." maxlength="200" rows="3"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="locationInput">Location</label>
            <div class="location-input-container">
              <input type="text" id="locationInput" class="form-input" placeholder="City, State" maxlength="100" readonly />
            </div>
            <p class="location-privacy">ðŸ”’ Only city and state are shared for privacy</p>
          </div>
          
          <!-- Profile picture upload is handled via avatar overlay above -->
          <div class="form-note">
            <p style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin: 0;">
              ðŸ’¡ Click on your profile picture above to change it
            </p>
          </div>
        </div>
        
        <div style="display: flex; gap: 16px; justify-content: flex-end;">
          <button type="button" class="btn-tesla btn-secondary" onclick="cancelEdit()">Cancel</button>
          <button type="submit" class="btn-tesla btn-primary" id="saveButton">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
              <polyline points="17,21 17,13 7,13 7,21"></polyline>
              <polyline points="7,3 7,8 15,8"></polyline>
            </svg>
            Save Changes
          </button>
        </div>
      </form>
      
      <div id="statusMessage"></div>
    </section>
  </div>

  <!-- Tesla-Grade Edit Profile Sheet Modal -->
  <div class="edit-sheet-overlay" id="editSheetOverlay">
    <div class="edit-sheet">
      <div class="edit-sheet-header">
        <h2 class="edit-sheet-title">
          <span>âœï¸</span>
          <span>Edit Profile</span>
        </h2>
        <button class="edit-sheet-close" onclick="closeEditSheet()" aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <div class="edit-sheet-body">
        <form id="profileSheetForm">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="sheetUsernameInput">Username</label>
              <input type="text" id="sheetUsernameInput" class="form-input" placeholder="Choose your username" maxlength="30" />
            </div>
            
            <div class="form-group">
              <label class="form-label" for="sheetDisplayNameInput">Display Name</label>
              <input type="text" id="sheetDisplayNameInput" class="form-input" placeholder="Your display name" maxlength="50" />
            </div>
            
            <div class="form-group full-width">
              <label class="form-label" for="sheetBioInput">Bio</label>
              <textarea id="sheetBioInput" class="form-input" placeholder="Tell us about yourself..." maxlength="200" rows="3"></textarea>
            </div>
            
            <div class="form-group full-width">
              <label class="form-label" for="sheetLocationInput">Location</label>
              <div class="location-input-container">
                <input type="text" id="sheetLocationInput" class="form-input" placeholder="Click to select location..." maxlength="100" readonly style="cursor: pointer;" onclick="openLocationPicker()" />
              </div>
              <p class="location-privacy">ðŸ”’ Only country and state/region are shared for privacy</p>
            </div>
            
            <div class="form-note full-width">
              <p style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin: 0;">
                ðŸ’¡ Close this sheet and click on your profile picture to change it
              </p>
            </div>
          </div>
        </form>
      </div>
      
      <div class="edit-sheet-footer">
        <button type="button" class="btn-tesla btn-secondary" onclick="closeEditSheet()">Cancel</button>
        <button type="button" class="btn-tesla btn-primary" id="sheetSaveButton" onclick="saveProfileFromSheet()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17,21 17,13 7,13 7,21"></polyline>
            <polyline points="7,3 7,8 15,8"></polyline>
          </svg>
          Save Changes
        </button>
      </div>
    </div>
  </div>

  <!-- TESLA GOLD STANDARD AVATAR CROP -->
  <div id="teslaAvatarCrop" class="tesla-sheet-modal">
    <div class="tesla-sheet-content">
      <div class="tesla-sheet-header">
        <h3>âœ‚ï¸ Crop Avatar</h3>
        <button onclick="TeslaAvatarCrop.close()" class="tesla-close">Ã—</button>
      </div>
      
      <div class="tesla-sheet-body">
        <div class="tesla-crop-area">
          <canvas id="teslaCanvas" width="260" height="260"></canvas>
          <div class="tesla-crop-circle"></div>
        </div>
        
        <div class="tesla-controls">
          <label class="tesla-label">Zoom</label>
          <input type="range" id="teslaZoom" min="0.5" max="2.5" step="0.1" value="1" class="tesla-range">
        </div>
      </div>
      
      <div class="tesla-sheet-footer">
        <button onclick="TeslaAvatarCrop.close()" class="tesla-btn tesla-secondary">Cancel</button>
        <button onclick="TeslaAvatarCrop.save()" class="tesla-btn tesla-primary">Save Avatar</button>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>

    

    
    // Global Modal Functions (accessible to onclick handlers)
    function editProfile() {
      console.log('ðŸš€ Tesla-Grade editProfile() initiated');
      
      const overlay = document.getElementById('editSheetOverlay');
      
      if (!overlay) {
        console.error('âŒ CRITICAL: editSheetOverlay element not found');
        alert('Edit profile modal not available');
        return;
      }
      
      console.log('âœ… Modal element discovered:', overlay);
      
      // Bulletproof modal activation with guaranteed z-index supremacy
      console.log('ðŸŽ¯ Activating Tesla-Grade modal with z-index supremacy...');
      
      // Force reset any problematic states
      overlay.classList.remove('hide', 'hidden');
      overlay.removeAttribute('hidden');
      overlay.style.display = 'none'; // Reset first
      
      // Apply bulletproof styling with z-index supremacy
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.right = '0';
      overlay.style.bottom = '0';
      overlay.style.zIndex = '999999'; // Supreme z-index
      overlay.style.background = 'rgba(0, 0, 0, 0.8)';
      overlay.style.backdropFilter = 'blur(8px)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'flex-end';
      overlay.style.justifyContent = 'center';
      overlay.style.visibility = 'visible';
      overlay.style.opacity = '1';
      overlay.style.pointerEvents = 'auto';
      
      // Add show class for animations
      overlay.classList.add('show');
      
      // Lock body scroll
      document.body.style.overflow = 'hidden';
      document.documentElement.style.overflow = 'hidden';
      
      console.log('ðŸ’« Tesla-Grade modal activated with z-index:', overlay.style.zIndex);
      
      // Focus management
      setTimeout(() => {
        const firstInput = document.getElementById('sheetUsernameInput');
        if (firstInput) {
          firstInput.focus();
          console.log('ðŸŽ¯ Focus applied to username input');
        }
      }, 300);
      
      console.log('ðŸ† Tesla-Grade editProfile() completed successfully');
    }
    
    function openCalendar() {
      console.log('ðŸš€ Tesla-Grade openCalendar() initiated');
      
      // Simple calendar system activation
      if (window.PremiumCalendar && window.PremiumCalendar.show) {
        console.log('âœ… Activating PremiumCalendar');
        window.PremiumCalendar.show();
        return;
      }
      
      alert('Calendar not available. Please try again later.');
    }
    
    function closeEditSheet() {
      const overlay = document.getElementById('editSheetOverlay');
      if (overlay) {
        overlay.classList.remove('show');
        overlay.style.display = 'none';
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
      }
    }
    
    function openLocationPicker() {
      console.log('ðŸŒ Opening Tesla-Grade location picker');
      if (window.LocationPicker && window.LocationPicker.show) {
        window.LocationPicker.show((result) => {
          console.log('ðŸ“ Location selected:', result);
          const locationInput = document.getElementById('sheetLocationInput');
          if (locationInput && result.formatted) {
            locationInput.value = result.formatted;
            console.log('âœ… Location input updated:', result.formatted);
          }
        });
      } else {
        console.error('âŒ LocationPicker not available');
        alert('Location picker not available. Please try again.');
      }
    }
    
    // Check if we have auth tokens in the URL hash and redirect to post-auth for processing
    if (location.hash && location.hash.includes('access_token')) {
      console.log('ðŸ” Found auth tokens, redirecting to post-auth for processing...');
      location.href = `post-auth.html${location.hash}`;
      // Stop execution to prevent further initialization
    } else {
      // Continue with normal initialization
      initProfile();
    }

    function initProfile() {
      // Profile data state
      let currentUser = null;
    let currentProfile = null;
    let userStats = null;
    let isEditing = false;
    let isViewingSharedProfile = false;
    let sharedProfileUsername = null;
    
    // Helper function to safely get current user
    async function getCurrentUser() {
      if (currentUser) return currentUser;
      
      // Try to get from Supabase session
      if (window.supabaseClient) {
        try {
          const { data: { user } } = await window.supabaseClient.auth.getUser();
          if (user) {
            currentUser = user;
            return user;
          }
        } catch (error) {
          console.warn('Failed to get Supabase user:', error);
        }
      }
      
      // Fallback to localStorage
      const storedUser = localStorage.getItem('user');
      if (storedUser) {
        try {
          currentUser = JSON.parse(storedUser);
          return currentUser;
        } catch (error) {
          console.warn('Failed to parse stored user:', error);
        }
      }
      
      return null;
    }
    
    // Initialize profile on page load - Tesla-grade timing
    document.addEventListener('DOMContentLoaded', async () => {
      checkIfSharedProfile();
      
      // ðŸ”¥ TESLA BYPASS: Check for bypass flags first
      const forceLoad = localStorage.getItem('force_profile_load') === 'true';
      const bypassDemo = localStorage.getItem('bypass_demo_mode') === 'true';
      const urlBypass = window.location.search.includes('bypass=true');
      
      if (forceLoad || bypassDemo || urlBypass) {
        console.log('ðŸ”¥ BYPASS MODE: Forcing real profile data load...');
        
        // Clear bypass flags
        localStorage.removeItem('force_profile_load');
        localStorage.removeItem('bypass_demo_mode');
        
        // Force load real data
        const realData = await attemptRealDataLoad();
        if (realData) {
          console.log('âœ… BYPASS SUCCESS: Real profile data loaded!');
          currentProfile = realData;
          updateProfileDisplay();
          setupEventListeners();
          return;
        } else {
          console.log('âš ï¸ BYPASS: No real data found, continuing normal flow');
        }
      }
      
      // Wait for auth-guard to complete before initializing
      if (window.userAuthenticated === undefined) {
        console.log('ðŸ”„ Waiting for auth-guard to complete...');
        
        // Wait for auth-guard completion with timeout
        let attempts = 0;
        const maxAttempts = 50; // 5 seconds max
        
        while (window.userAuthenticated === undefined && attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }
        
        if (window.userAuthenticated === undefined) {
          console.warn('âš ï¸ Auth-guard timeout - proceeding with unknown auth state');
        }
      }
      
      console.log('âœ… Auth-guard complete, auth status:', window.userAuthenticated);
      await initializeProfile();
      setupEventListeners();
    });
    
    // Load profile from localStorage for persistence
    function readFromLocalStorage() {
      try {
        const savedProfile = localStorage.getItem('stayhi_profile');
        if (savedProfile) {
          return JSON.parse(savedProfile);
        }
        return null;
      } catch (error) {
        console.warn('Failed to read from localStorage:', error);
        return null;
      }
    }
    
    // Save profile to localStorage for persistence
    function saveToLocalStorage(profileData) {
      try {
        localStorage.setItem('stayhi_profile', JSON.stringify(profileData));
        console.log('ðŸ’¾ Saved profile to localStorage');
      } catch (error) {
        console.warn('Failed to save to localStorage:', error);
      }
    }
    
    // Check if we're viewing a shared profile
    function checkIfSharedProfile() {
      const urlParams = new URLSearchParams(window.location.search);
      sharedProfileUsername = urlParams.get('username');
      isViewingSharedProfile = !!sharedProfileUsername;
      
      if (isViewingSharedProfile) {
        console.log(`Viewing shared profile: ${sharedProfileUsername}`);
        // Hide edit-only elements for shared profiles
        document.body.classList.add('viewing-shared-profile');
      }
    }
    
    // Demo profile data for gold standard display
    function loadDemoProfile() {
      currentProfile = {
        id: 'demo-user',
        username: 'demo_user',
        display_name: 'Demo User',
        created_at: '2025-01-01T00:00:00Z',
        avatar_url: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face',
        location: 'Austin, TX'
      };
      
      userStats = {
        total_hi_moments: 127,
        current_streak: 12,
        longest_streak: 45,
        avg_daily_moments: 3.2,
        total_points: 2850,
        achievements_unlocked: 8
      };
      
      updateProfileDisplay();
      renderStats(userStats);
      renderAchievements([
        { id: 'first_hi', name: 'First Hi', icon: 'ðŸ‘‹', unlocked: true, progress: '1/1', description: 'Share your first Hi moment' },
        { id: 'streak_7', name: '7 Day Streak', icon: 'ðŸ”¥', unlocked: true, progress: '7/7', description: 'Maintain a 7-day Hi streak' },
        { id: 'early_bird', name: 'Early Bird', icon: 'ðŸŒ…', unlocked: true, progress: '10/10', description: 'Share 10 morning Hi moments' },
        { id: 'consistent', name: 'Consistent', icon: 'ðŸ“…', unlocked: false, progress: '12/30', description: 'Share Hi moments for 30 days' },
        { id: 'social', name: 'Social Butterfly', icon: 'ðŸ¦‹', unlocked: false, progress: '5/25', description: 'Share 25 public Hi moments' },
        { id: 'mindful', name: 'Mindful Master', icon: 'ðŸ§˜', unlocked: false, progress: '3/50', description: 'Complete 50 mindfulness sessions' }
      ]);
    }

    // Initialize everything
    async function initializeProfile() {
      try {
        if (isViewingSharedProfile) {
          await loadSharedProfile();
        } else {
          // ðŸ”’ CORRECT ORDER: Load user first, then Supabase profile (don't overwrite with localStorage)
          await loadCurrentUser();
          
          // ðŸš€ FALLBACK: If no profile loaded, setup demo profile
          if (!currentProfile) {
            console.log('ðŸŽ­ No profile loaded - setting up demo profile');
            setupDemoProfile();
            loadDemoProfile(); // Load demo stats and data
          } else {
            await loadUserProfile(); // This fetches latest from Supabase AND writes to localStorage
          }
        }
        await loadUserStats();
        await loadAchievements();
        updateAllDisplays();
      } catch (error) {
        console.error('Failed to initialize profile:', error);
        console.log('ðŸŽ­ Profile initialization failed - falling back to demo profile');
        setupDemoProfile();
        loadDemoProfile();
        updateAllDisplays();
      }
    }
    
    // Load authenticated user (for own profile) - Tesla-grade hybrid mode
    async function loadCurrentUser() {
      try {
        if (window.supabaseClient) {
          const { data: { user }, error } = await window.supabaseClient.auth.getUser();
          if (error) throw error;
          if (!user) {
            // ðŸ”¥ TESLA BYPASS: Try to load real data even if no current session
            console.log('ðŸ”¥ No current user session - attempting to load cached profile data...');
            const realProfileData = await attemptRealDataLoad();
            if (realProfileData) {
              console.log('âœ… Found real profile data - using instead of demo');
              currentProfile = realProfileData;
              updateProfileDisplay();
              return;
            }
            
            // Check if we're in hybrid mode before redirecting
            if (window.userAuthenticated === false) {
              console.log('ðŸŽ­ Profile running in hybrid mode - showing local features');
              setupDemoProfile();
              return;
            }
            // Only redirect if auth-guard hasn't already handled this
            if (window.userAuthenticated === undefined) {
              console.log('ðŸ”„ Waiting for auth-guard to complete...');
              setTimeout(loadCurrentUser, 100);
              return;
            }
            window.location.href = 'signin.html';
            return;
          }
          currentUser = user;
          
          // ðŸ”§ TESLA FIX: Fetch complete profile from database
          await fetchUserProfile(user.id);
        } else {
          // Fallback for when Supabase isn't available
          console.warn('Supabase client not available - using hybrid mode');
          if (window.userAuthenticated === false) {
            setupDemoProfile();
            return;
          }
        }
      } catch (error) {
        console.error('Auth error:', error);
        // Only redirect if not in hybrid mode
        if (window.userAuthenticated !== false) {
          window.location.href = 'signin.html';
        } else {
          console.log('ðŸŽ­ Auth error in hybrid mode - showing local profile');
          setupDemoProfile();
        }
      }
    }

    // ï¿½ TESLA BYPASS: Attempt to load real profile data even without session
    async function attemptRealDataLoad() {
      console.log('ðŸ” Searching for real profile data...');
      
      // Check localStorage for any non-demo profile data
      const profileKeys = ['stayhi_profile', 'user_profile', 'profile', 'currentUser'];
      
      for (const key of profileKeys) {
        const data = localStorage.getItem(key);
        if (data) {
          try {
            const parsed = JSON.parse(data);
            // Check if this looks like real data (not demo)
            if (parsed.display_name && 
                parsed.display_name !== 'Demo User' && 
                parsed.display_name !== 'Stay Hi User' &&
                !parsed.display_name.includes('demo')) {
              console.log(`ðŸŽ¯ Found real profile data in ${key}:`, parsed.display_name);
              return parsed;
            }
          } catch (e) {
            console.warn(`Invalid data in ${key}`);
          }
        }
      }
      
      // Try to get session data from localStorage auth tokens
      try {
        const authKeys = Object.keys(localStorage).filter(key => 
          key.includes('supabase') && localStorage.getItem(key).includes('access_token')
        );
        
        if (authKeys.length > 0) {
          console.log('ðŸ” Found auth tokens - attempting database lookup...');
          
          // Try to extract user ID from token data and fetch profile
          for (const authKey of authKeys) {
            try {
              const authData = JSON.parse(localStorage.getItem(authKey));
              if (authData.user && authData.user.id) {
                console.log('ðŸŽ¯ Found user ID in auth data - fetching profile...');
                
                const { data: profile, error } = await window.supabaseClient
                  .from('profiles')
                  .select('*')
                  .eq('id', authData.user.id)
                  .single();
                  
                if (!error && profile && profile.display_name) {
                  console.log('âœ… Retrieved real profile from database!');
                  return profile;
                }
              }
            } catch (e) {
              // Continue to next auth key
            }
          }
        }
      } catch (tokenError) {
        console.warn('Token search failed:', tokenError);
      }
      
      console.log('âŒ No real profile data found');
      return null;
    }

    // ï¿½ðŸ”§ TESLA FIX: Fetch complete user profile from database
    async function fetchUserProfile(userId) {
      try {
        console.log('ðŸŽ¯ Fetching complete profile for user:', userId);
        
        // Fetch from profiles table
        const { data: profile, error } = await window.supabaseClient
          .from('profiles')
          .select('*')
          .eq('id', userId)
          .single();
          
        if (error) {
          console.warn('Profile fetch error:', error);
          // If no profile in DB, create from auth user data
          await createProfileFromAuthUser();
          return;
        }
        
        if (profile) {
          console.log('âœ… Profile loaded:', profile);
          
          // Store in localStorage for consistency with hi-island
          localStorage.setItem('stayhi_profile', JSON.stringify(profile));
          localStorage.setItem('user', JSON.stringify(currentUser));
          
          // Update current profile
          currentProfile = profile;
          
          // Populate the form
          populateProfileForm(profile);
        }
        
      } catch (error) {
        console.error('Error fetching profile:', error);
        // Fallback to auth user data
        await createProfileFromAuthUser();
      }
    }
    
    // Create profile from auth user if no database profile exists
    async function createProfileFromAuthUser() {
      if (!currentUser) return;
      
      console.log('ðŸ“ Creating profile from auth user data');
      
      const profileData = {
        id: currentUser.id,
        username: currentUser.email?.split('@')[0] || 'user',
        display_name: currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User',
        avatar_url: currentUser.user_metadata?.avatar_url || null,
        bio: '',
        location: '',
        created_at: currentUser.created_at || new Date().toISOString()
      };
      
      // Store locally
      localStorage.setItem('stayhi_profile', JSON.stringify(profileData));
      currentProfile = profileData;
      
      // Populate form
      populateProfileForm(profileData);
    }
    
    // Populate profile form with data
    function populateProfileForm(profile) {
      console.log('ðŸ“ Populating profile form with:', profile);
      
      // Update form fields
      if (profile.display_name) {
        const displayNameField = document.querySelector('input[placeholder="Your display name"]');
        if (displayNameField) displayNameField.value = profile.display_name;
      }
      
      if (profile.bio) {
        const bioField = document.querySelector('textarea[placeholder="Tell us about yourself..."]');
        if (bioField) bioField.value = profile.bio;
      }
      
      if (profile.location) {
        const locationField = document.querySelector('input[placeholder="Your location"]');
        if (locationField) locationField.value = profile.location;
      }
      
      if (profile.username) {
        const usernameField = document.querySelector('input[placeholder="Choose a username"]');
        if (usernameField) usernameField.value = profile.username;
      }
      
      // Update avatar if available
      if (profile.avatar_url) {
        updateAvatarDisplay(profile.avatar_url);
      }
      
      console.log('âœ… Profile form populated');
    }
    
    // Update avatar display
    function updateAvatarDisplay(avatarUrl) {
      const avatarElements = document.querySelectorAll('.profile-avatar, .avatar-preview');
      avatarElements.forEach(element => {
        if (element.tagName === 'IMG') {
          element.src = avatarUrl;
        } else {
          element.style.backgroundImage = `url(${avatarUrl})`;
        }
      });
    }

    // Setup demo profile for hybrid mode (Tesla-grade local features)
    function setupDemoProfile() {
      console.log('ðŸŽ­ Setting up demo profile for hybrid mode');
      
      // Create a demo user profile
      currentProfile = {
        id: 'demo-user-' + Date.now(),
        username: 'demo_user',
        display_name: 'Demo User',
        avatar_url: null,
        bio: 'Exploring Stay Hi in demo mode',
        location: 'Local Device',
        created_at: new Date().toISOString()
      };
      
      // Set demo mode globally
      window.demoMode = true;
      
      // Add demo mode indicator
      const demoIndicator = document.createElement('div');
      demoIndicator.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
        background: linear-gradient(135deg, #ffd166, #ff7a18);
        color: white; text-align: center; padding: 8px;
        font-size: 14px; font-weight: 600;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      `;
      demoIndicator.innerHTML = `
        ðŸŽ­ Demo Mode â€¢ Profile stored locally â€¢ 
        <a href="signin.html" style="color: white; text-decoration: underline;">Sign in for full features</a>
      `;
      document.body.prepend(demoIndicator);
      document.body.style.marginTop = '40px';
      
      // Load or create local demo profile
      const localProfile = localStorage.getItem('demo-profile');
      if (localProfile) {
        try {
          const parsed = JSON.parse(localProfile);
          currentProfile = { ...currentProfile, ...parsed };
          console.log('ðŸ“± Loaded local demo profile');
        } catch (error) {
          console.warn('Failed to parse local profile, using defaults');
        }
      }
      
      // Update displays with demo data
      updateAllDisplays();
      
      console.log('âœ… Demo profile ready for hybrid mode experience');
    }
    
    // Load shared profile (public viewing)
    async function loadSharedProfile() {
      try {
        if (!window.supabaseClient) {
          showStatus('Unable to load shared profile - database unavailable', 'error');
          return;
        }
        
        // Look up user by username
        const { data: profileData, error } = await window.supabaseClient
          .from('profiles')
          .select('*')
          .eq('username', sharedProfileUsername)
          .eq('is_public', true) // Only show public profiles
          .single();
        
        if (error || !profileData) {
          showStatus('Profile not found or private', 'error');
          // Show fallback content
          document.querySelector('.profile-title').textContent = 'Profile Not Found';
          return;
        }
        
        currentProfile = profileData;
        
        // Create a fake user object for display purposes
        currentUser = {
          id: profileData.id,
          email: null, // Don't show email for shared profiles
          created_at: profileData.created_at
        };
        
        // Update page title
        document.title = `${profileData.display_name || profileData.username || 'User'}'s Profile â€” Stay Hi`;
        
      } catch (error) {
        console.error('Failed to load shared profile:', error);
        showStatus('Failed to load shared profile', 'error');
      }
    }
    
    // Load user profile from database
    async function loadUserProfile() {
      if (!currentUser || !window.supabaseClient) return;
      
      try {
        const { data, error } = await window.supabaseClient
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();
        
        if (error && error.code !== 'PGRST116') {
          throw error;
        }
        
        if (data) {
          // âœ… Got profile from Supabase - this is the SOURCE OF TRUTH
          currentProfile = data;
          
          // ðŸ”§ TESLA FIX: Auto-populate empty fields from auth data
          let needsUpdate = false;
          
          if (!currentProfile.display_name && currentUser.user_metadata?.full_name) {
            currentProfile.display_name = currentUser.user_metadata.full_name;
            needsUpdate = true;
          }
          
          if (!currentProfile.username && currentUser.email) {
            currentProfile.username = currentUser.email.split('@')[0];
            needsUpdate = true;
          }
          
          if (!currentProfile.avatar_url && currentUser.user_metadata?.avatar_url) {
            currentProfile.avatar_url = currentUser.user_metadata.avatar_url;
            needsUpdate = true;
          }
          
          if (!currentProfile.bio) {
            const name = currentProfile.display_name || currentProfile.username || 'User';
            currentProfile.bio = `Hi! I'm ${name}`;
            needsUpdate = true;
          }
          
          // Update database if we filled in missing fields
          if (needsUpdate) {
            try {
              const { data: updatedData, error: updateError } = await window.supabaseClient
                .from('profiles')
                .update({
                  display_name: currentProfile.display_name,
                  username: currentProfile.username,
                  avatar_url: currentProfile.avatar_url,
                  bio: currentProfile.bio
                })
                .eq('id', currentProfile.id)
                .select()
                .single();
                
              if (!updateError && updatedData) {
                currentProfile = updatedData;
                console.log('âœ… Auto-populated missing profile fields');
              }
            } catch (updateErr) {
              console.warn('âš ï¸ Could not auto-update profile:', updateErr);
            }
          }
          
          // Cache it to localStorage for offline access
          saveToLocalStorage(currentProfile);
          console.log('âœ… Loaded profile from Supabase:', currentProfile);
        } else {
          // No profile exists yet (new user) - auto-create from auth data
          console.log('ðŸ“ No profile found - creating from auth data');
          
          const authDisplayName = currentUser.user_metadata?.full_name || 
                                 currentUser.user_metadata?.name || 
                                 currentUser.email?.split('@')[0] || 
                                 'User';
          
          const authUsername = currentUser.email?.split('@')[0] || 
                              authDisplayName.toLowerCase().replace(/\s+/g, '') || 
                              'user';
          
          currentProfile = {
            id: currentUser.id,
            username: authUsername,
            display_name: authDisplayName,
            avatar_url: currentUser.user_metadata?.avatar_url || null,
            bio: `Hi! I'm ${authDisplayName}`,
            location: null,
            created_at: currentUser.created_at || new Date().toISOString()
          };
          
          // Save this auto-generated profile to database
          try {
            const { data, error } = await window.supabaseClient
              .from('profiles')
              .insert(currentProfile)
              .select()
              .single();
              
            if (!error && data) {
              currentProfile = data;
              console.log('âœ… Auto-created profile saved to database');
            }
          } catch (insertError) {
            console.warn('âš ï¸ Could not save auto-created profile:', insertError);
          }
          
          // Cache to localStorage
          saveToLocalStorage(currentProfile);
          console.log('âœ… Auto-created profile from auth data:', currentProfile);
        }
      } catch (error) {
        console.error('Failed to load profile:', error);
        // Try localStorage as fallback
        const savedProfile = readFromLocalStorage();
        if (savedProfile) {
          currentProfile = savedProfile;
          console.log('âš ï¸ Using localStorage fallback');
        } else {
          // Create default profile
          currentProfile = {
            id: currentUser.id,
            username: null,
            display_name: null,
            avatar_url: null,
            bio: null,
            location: null
          };
        }
      }
    }
    
    // Load user statistics
    async function loadUserStats() {
      try {
        // For shared profiles, only load from database
        if (isViewingSharedProfile) {
          if (currentUser && window.supabaseClient) {
            const { data, error } = await window.supabaseClient
              .from('user_stats')
              .select('*')
              .eq('user_id', currentUser.id)
              .single();
            
            userStats = data || {
              total_hi_moments: 0,
              current_streak: 0,
              total_waves: 0,
              total_starts: 0,
              days_active: 0,
              level: 1,
              experience_points: 0
            };
          }
          return;
        }
        
        // For own profile - try Supabase first, then localStorage
        if (currentUser && window.supabaseClient) {
          const { data, error } = await window.supabaseClient
            .from('user_stats')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();
          
          if (data) {
            userStats = data;
            return;
          }
        }
        
        // Fallback to localStorage (own profile only)
        const localStats = {
          total_hi_moments: parseInt(localStorage.getItem('hi5.total') || '0'),
          current_streak: parseInt(localStorage.getItem('hi5.streak') || '0'),
          total_waves: parseInt(localStorage.getItem('hi.waves') || '0'),
          total_starts: parseInt(localStorage.getItem('hi.starts') || '0'),
          days_active: Object.keys(JSON.parse(localStorage.getItem('hi5.history') || '{}')).length,
          level: Math.floor(parseInt(localStorage.getItem('hi5.total') || '0') / 10) + 1,
          experience_points: parseInt(localStorage.getItem('hi5.total') || '0') * 10
        };
        
        userStats = localStats;
        
        // Try to sync to database
        if (currentUser && window.supabaseClient && !isViewingSharedProfile) {
          await syncStatsToDatabase(localStats);
        }
      } catch (error) {
        console.error('Failed to load stats:', error);
        userStats = {
          total_hi_moments: 0,
          current_streak: 0,
          total_waves: 0,
          total_starts: 0,
          days_active: 0,
          level: 1,
          experience_points: 0
        };
      }
    }
    
    // Sync local stats to database
    async function syncStatsToDatabase(stats) {
      try {
        const { error } = await window.supabaseClient
          .from('user_stats')
          .upsert({
            user_id: currentUser.id,
            ...stats,
            updated_at: new Date().toISOString()
          });
        
        if (error) throw error;
      } catch (error) {
        console.error('Failed to sync stats:', error);
      }
    }
    
    // Load achievements
    async function loadAchievements() {
      try {
        let achievements = [];
        let userAchievements = [];
        
        if (window.supabaseClient && currentUser) {
          // Load achievements from database
          const { data: achievementsData } = await window.supabaseClient
            .from('achievements')
            .select('*')
            .eq('is_active', true);
          
          const { data: userAchievementsData } = await window.supabaseClient
            .from('user_achievements')
            .select('*')
            .eq('user_id', currentUser.id);
          
          achievements = achievementsData || [];
          userAchievements = userAchievementsData || [];
        }
        
        // Fallback achievements if database is empty
        if (achievements.length === 0) {
          achievements = [
            { id: 'first_hi', name: 'First Hi', icon: 'ðŸŽ‰', description: 'Complete your first Hi Moment' },
            { id: 'streak_7', name: '7 Day Streak', icon: 'ðŸ”¥', description: 'Maintain a 7-day Hi streak' },
            { id: 'hi_100', name: '100 Hi Moments', icon: 'ðŸ’¯', description: 'Complete 100 Hi Moments' },
            { id: 'wave_master', name: 'Wave Master', icon: 'ðŸŒŠ', description: 'Send 50 Hi Waves' },
            { id: 'streak_30', name: '30 Day Streak', icon: 'âš¡', description: 'Maintain a 30-day Hi streak' },
            { id: 'social_butterfly', name: 'Social Butterfly', icon: 'ðŸ¦‹', description: 'Share 10 public Hi Moments' }
          ];
        }
        
        // Calculate progress and unlock status
        const processedAchievements = achievements.map(achievement => {
          const userAchievement = userAchievements.find(ua => ua.achievement_id === achievement.id);
          const unlocked = !!userAchievement;
          
          let progress = '0/1';
          if (achievement.id === 'first_hi') {
            progress = `${Math.min(userStats.total_hi_moments, 1)}/1`;
          } else if (achievement.id === 'streak_7') {
            progress = `${Math.min(userStats.current_streak, 7)}/7`;
          } else if (achievement.id === 'streak_30') {
            progress = `${Math.min(userStats.current_streak, 30)}/30`;
          } else if (achievement.id === 'hi_100') {
            progress = `${Math.min(userStats.total_hi_moments, 100)}/100`;
          } else if (achievement.id === 'wave_master') {
            progress = `${Math.min(userStats.total_waves, 50)}/50`;
          }
          
          return {
            ...achievement,
            unlocked,
            progress
          };
        });
        
        renderAchievements(processedAchievements);
      } catch (error) {
        console.error('Failed to load achievements:', error);
      }
    }
    
    // Update all displays
    function updateAllDisplays() {
      updateProfileDisplay();
      updateStatsDisplay();
      // Clean interface without distracting quick stats
    }
    
    // Update profile display
    function updateProfileDisplay() {
      // ðŸ”’ FIXED: Don't require currentUser - we can display with just currentProfile
      if (!currentProfile) {
        console.warn('âš ï¸ updateProfileDisplay called but no currentProfile');
        return;
      }
      
      console.log('ðŸ”„ updateProfileDisplay - currentProfile:', currentProfile);
      
      // ðŸ”’ BULLETPROOF AVATAR PERSISTENCE
      // Update avatar with initials fallback (no Dicebear, no external fetching)
      // Avatar URL is ONLY changed when user explicitly uploads via crop modal
      const avatar = document.getElementById('profileAvatar');
      const placeholder = document.getElementById('avatarPlaceholder');
      
      // Get avatar URL from profile or user metadata - never regenerate or fetch
      const avatarUrl = currentProfile?.avatar_url || 
                       currentUser?.user_metadata?.avatar_url;
      
      console.log('ðŸ–¼ï¸ Avatar URL:', avatarUrl);
      
      // Handle avatar loading with initials fallback
      if (avatarUrl && avatarUrl !== '') {
        avatar.onload = () => {
          if (placeholder) {
            placeholder.classList.add('hidden');
          }
        };
        avatar.onerror = () => {
          // Fallback to initials on error
          avatar.style.display = 'none';
          if (placeholder) {
            updatePlaceholderWithInitials(placeholder);
            placeholder.classList.remove('hidden');
          }
        };
        avatar.src = avatarUrl;
        avatar.style.display = 'block';
      } else {
        // No avatar, show initials
        avatar.style.display = 'none';
        if (placeholder) {
          updatePlaceholderWithInitials(placeholder);
          placeholder.classList.remove('hidden');
        }
      }
      
      // Update display name (shown above username)
      const displayNameEl = document.getElementById('profileDisplayName');
      if (displayNameEl) {
        displayNameEl.textContent = currentProfile?.display_name || currentProfile?.username || 'Stay Hi User';
      }
      
      // Update username
      const username = document.getElementById('profileUsername');
      if (username) {
        if (isViewingSharedProfile) {
          username.textContent = currentProfile?.username ? `@${currentProfile.username}` : 'Unknown User';
        } else {
          username.textContent = currentProfile?.username ? `@${currentProfile.username}` : '@username';
        }
        console.log('ðŸ“ Updated username to:', username.textContent);
      } else {
        console.warn('âš ï¸ profileUsername element not found');
      }
      
      // Update bio
      const bioEl = document.getElementById('profileBio');
      if (bioEl) {
        if (currentProfile?.bio) {
          bioEl.textContent = currentProfile.bio;
          bioEl.style.display = 'block';
          console.log('ðŸ“ Updated bio to:', currentProfile.bio);
        } else {
          bioEl.style.display = 'none';
          console.log('ðŸ“ No bio to display');
        }
      } else {
        console.warn('âš ï¸ profileBio element not found');
      }
      
      // Update location
      const locationEl = document.getElementById('profileLocation');
      if (locationEl) {
        if (currentProfile?.location) {
          locationEl.textContent = `ðŸ“ ${currentProfile.location}`;
          locationEl.style.display = 'inline-block';
          console.log('ðŸ“ Updated location to:', currentProfile.location);
        } else {
          locationEl.style.display = 'none';
          console.log('ðŸ“ No location to display');
        }
      } else {
        console.warn('âš ï¸ profileLocation element not found');
      }
      
      // Email display removed for privacy
      
      // Update joined date - handle missing currentUser
      const joined = document.getElementById('profileJoined');
      if (joined) {
        const createdAt = currentUser?.created_at || currentProfile?.created_at || new Date().toISOString();
        const joinDate = new Date(createdAt).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long'
        });
        joined.textContent = `Member since ${joinDate}`;
      }
      
      // âœ¨ Fade in profile hero after data loads
      const profileHero = document.getElementById('profileHero');
      if (profileHero) {
        setTimeout(() => {
          profileHero.style.opacity = '1';
        }, 50);
      }
      
      // Update form inputs (only for own profile)
      if (currentProfile && !isViewingSharedProfile) {
        document.getElementById('usernameInput').value = currentProfile.username || '';
        document.getElementById('displayNameInput').value = currentProfile.display_name || '';
        document.getElementById('bioInput').value = currentProfile.bio || '';
        document.getElementById('locationInput').value = currentProfile.location || '';
      }
      
      // Update page title for shared profiles
      if (isViewingSharedProfile) {
        const displayName = currentProfile?.display_name || currentProfile?.username || 'Stay Hi User';
        document.querySelector('.profile-title').textContent = `${displayName}'s Profile`;
      }
    }
    
    // Update placeholder with user initials
    function updatePlaceholderWithInitials(placeholder) {
      if (!window.AvatarUtils) {
        console.warn('AvatarUtils not loaded, using generic placeholder');
        return;
      }
      
      const initials = window.AvatarUtils.getInitials(
        currentProfile?.display_name,
        currentProfile?.username,
        currentUser?.email
      );
      
      const colors = window.AvatarUtils.getColorFromString(
        currentUser?.email || currentProfile?.username || 'default'
      );
      
      placeholder.style.background = colors.background;
      placeholder.innerHTML = `
        <div style="
          color: ${colors.text};
          font-size: 48px;
          font-weight: 700;
          letter-spacing: 1px;
        ">${initials}</div>
      `;
    }
    
    // Update stats display
    function updateStatsDisplay() {
      if (!userStats) return;
      
      const statsGrid = document.getElementById('statsGrid');
      statsGrid.innerHTML = `
        <div class="stat-item" onclick="openCalendar()" title="Click to view calendar">
          <div class="stat-value">${userStats.total_hi_moments}</div>
          <div class="stat-label">Hi Moments</div>
        </div>
        <div class="stat-item" title="Current consecutive days">
          <div class="stat-value">${userStats.current_streak}</div>
          <div class="stat-label">Day Streak</div>
        </div>
        <div class="stat-item" title="Total Hi Waves sent">
          <div class="stat-value">${userStats.total_waves}</div>
          <div class="stat-label">Hi Waves</div>
        </div>
        <div class="stat-item" title="Total Hi Starts initiated">
          <div class="stat-value">${userStats.total_starts}</div>
          <div class="stat-label">Hi Starts</div>
        </div>
        <div class="stat-item" title="Days with Hi activity">
          <div class="stat-value">${userStats.days_active}</div>
          <div class="stat-label">Days Active</div>
        </div>
        <div class="stat-item" title="Current level based on experience">
          <div class="stat-value">${userStats.level}</div>
          <div class="stat-label">Level</div>
        </div>
      `;
    }
    
    // Quick stats removed for cleaner Tesla-grade interface
    
    // Render achievements
    function renderAchievements(achievements) {
      const achievementsGrid = document.getElementById('achievementsGrid');
      achievementsGrid.innerHTML = achievements.map(achievement => `
        <div class="achievement-badge ${achievement.unlocked ? 'unlocked' : ''}" 
             title="${achievement.description}">
          <div class="achievement-icon">${achievement.icon}</div>
          <div class="achievement-name">${achievement.name}</div>
          <div class="achievement-progress">${achievement.progress}</div>
        </div>
      `).join('');
    }
    
    // Tesla-Grade Event Management
    function setupEventListeners() {
      // Avatar upload system
      initializeAvatarUpload();
      
      // Profile form
      const profileForm = document.getElementById('profileForm');
      if (profileForm) {
        profileForm.addEventListener('submit', handleProfileSave);
      }
      
      // Modal systems
      initializeModals();
    }
    
    // Initialize avatar upload with Tesla precision
    async function initializeAvatarUpload() {
      try {
        // Initialize Tesla Avatar Uploader
        await window.teslaAvatarUploader.init();
        console.log('âœ… Tesla Avatar System initialized');
        
        const avatarInput = document.getElementById('avatarFileInput');
        const avatarOverlay = document.getElementById('avatarUploadOverlay');
        const avatarContainer = document.getElementById('avatarContainer');
        
        if (!avatarInput || !avatarOverlay || !avatarContainer) {
          console.warn('âš ï¸ Avatar elements not found');
          return;
        }
        
        // File input handler with Tesla system
        avatarInput.addEventListener('change', async (event) => {
          const file = event.target.files[0];
          if (!file) return;
          
          try {
            // Use Tesla Avatar Crop system
            if (window.TeslaAvatarCrop) {
              console.log('ðŸš€ Opening Tesla Avatar Crop modal...');
              await window.TeslaAvatarCrop.show(file);
            } else {
              console.error('âŒ TeslaAvatarCrop not available');
            }
          } catch (error) {
            console.error('âŒ Avatar upload failed:', error);
          }
        });
        
        // Click handler with smooth UX
        avatarOverlay.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          if (avatarOverlay.classList.contains('processing')) {
            return; // Prevent clicks during processing
          }
          
          triggerAvatarUpload();
        });
        
        // Hover effects
        avatarContainer.addEventListener('mouseenter', () => {
          if (!avatarOverlay.classList.contains('processing')) {
            // Add subtle haptic feedback
            if (window.PremiumUX) {
              window.PremiumUX.triggerHapticFeedback('ultraLight');
            }
          }
        });
        
      } catch (error) {
        console.error('âŒ Tesla Avatar System initialization failed:', error);
        // Fallback to basic upload if needed
        this.initializeBasicAvatarUpload();
      }
    }
    
    // Tesla Avatar System Integration
    function initializeBasicAvatarUpload() {
      console.log('ðŸš€ Tesla avatar crop system ready');
      
      const avatarInput = document.getElementById('avatarFileInput');
      const avatarOverlay = document.getElementById('avatarUploadOverlay');
      
      if (avatarInput && avatarOverlay) {
        // No additional change handler needed - already handled above with TeslaAvatarCrop
        avatarOverlay.addEventListener('click', triggerAvatarUpload);
      }
    }
    
    // Initialize modal systems
    function initializeModals() {
      const cropModal = document.getElementById('imageCropModal');
      const editSheet = document.getElementById('editSheetOverlay');
      
      if (cropModal) {
        cropModal.addEventListener('click', (e) => {
          if (e.target === e.currentTarget) {
            closeCropModal();
          }
        });
      }
      
      if (editSheet) {
        editSheet.addEventListener('click', (e) => {
          if (e.target === e.currentTarget) {
            closeEditSheet();
          }
        });
      }
      
      // Escape key handler
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (cropModal && cropModal.classList.contains('show')) {
            closeCropModal();
          } else if (editSheet && editSheet.classList.contains('show')) {
            closeEditSheet();
          }
        }
      });
    }
    
    // Trigger file picker with smooth animation
    function triggerAvatarUpload() {
      const input = document.getElementById('avatarFileInput');
      const overlay = document.getElementById('avatarUploadOverlay');
      
      if (!input || !overlay) return;
      
      // Add click animation
      overlay.style.transform = 'scale(0.98)';
      setTimeout(() => {
        overlay.style.transform = '';
      }, 150);
      
      // Reset and trigger
      input.value = '';
      input.click();
      
      // Haptic feedback
      if (window.PremiumUX) {
        window.PremiumUX.triggerHapticFeedback('light');
      }
    }
    
    // Image cropping variables
    let cropImage = null;
    let cropCanvas = null;
    let cropCtx = null;
    let imageScale = 1;
    let imageX = 0;
    let imageY = 0;
    let isDragging = false;
    let lastMouseX = 0;
    let lastMouseY = 0;
    
    // Tesla-Grade Avatar Upload Handler
    // LEGACY: handleAvatarUpload - Replaced by TeslaAvatarCrop system
    // async function handleAvatarUpload(event) { ... }
    
    // Advanced file validation
    function validateImageFile(file) {
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/avif'];
      const maxSize = 15 * 1024 * 1024; // 15MB for high-quality images
      
      if (!validTypes.includes(file.type)) {
        return {
          valid: false,
          message: 'Please select a JPEG, PNG, WebP, or AVIF image'
        };
      }
      
      if (file.size > maxSize) {
        return {
          valid: false,
          message: 'Image must be smaller than 15MB'
        };
      }
      
      if (file.size < 512) { // 512 bytes minimum
        return {
          valid: false,
          message: 'Image file appears to be corrupted'
        };
      }
      
      return { valid: true };
    }

    // Tesla-Grade Image Processing with Optimization
    async function processImageWithOptimization(file, overlay) {
      try {
        // Show processing feedback
        updateProcessingProgress(overlay, 10, 'Processing image...');
        
        let optimizedResult;
        let imageUrl;
        
        // Use image optimizer if available, otherwise fallback to direct processing
        if (window.imageOptimizer) {
          updateProcessingProgress(overlay, 20, 'Optimizing image...');
          
          optimizedResult = await window.imageOptimizer.optimizeImage(file, {
            maxWidth: 800,
            maxHeight: 800,
            quality: 0.9,
            generateThumbnail: true
          });
          
          imageUrl = URL.createObjectURL(optimizedResult.optimized);
          console.log(`[Avatar] Optimized: ${optimizedResult.compressionRatio}% smaller, ${optimizedResult.format}`);
        } else {
          // Fallback: Use original file
          console.warn('[Avatar] Image optimizer not available, using original file');
          imageUrl = URL.createObjectURL(file);
          optimizedResult = {
            original: file,
            optimized: file,
            originalSize: file.size,
            optimizedSize: file.size,
            compressionRatio: '0.0',
            format: file.type
          };
        }
        
        updateProcessingProgress(overlay, 50, 'Preparing for crop...');
        
        updateProcessingProgress(overlay, 70, 'Opening crop editor...');
        
        // Open crop modal with processed image
        await new Promise(resolve => setTimeout(resolve, 300)); // Smooth transition
        openCropModal(imageUrl, optimizedResult);
        
        updateProcessingProgress(overlay, 100, 'Ready to crop!');
        
        // End processing animation
        setTimeout(() => {
          endProcessingAnimation(overlay, true);
        }, 500);
        
      } catch (error) {
        console.error('Image processing failed:', error);
        throw error;
      }
    }

    // Update processing progress with smooth animations
    function updateProcessingProgress(overlay, percent, message) {
      const progressText = overlay.querySelector('.upload-text');
      const progressCircle = overlay.querySelector('.progress-circle');
      
      if (progressText) {
        progressText.textContent = message;
      }
      
      if (progressCircle) {
        const circumference = 157; // 2Ï€r where r=25
        const offset = circumference - (percent / 100) * circumference;
        progressCircle.style.strokeDashoffset = offset;
      }
    }
    
    // Tesla-style processing animation
    async function startProcessingAnimation(overlay) {
      return new Promise((resolve) => {
        overlay.classList.add('processing');
        
        // Smooth transition
        setTimeout(() => {
          // Animate progress circle
          const progressCircle = overlay.querySelector('.progress-circle');
          if (progressCircle) {
            progressCircle.style.strokeDashoffset = '78.5'; // 50% progress
          }
          resolve();
        }, 300);
      });
    }
    
    // Process image with progress feedback
    async function processImageWithProgress(file, overlay) {
      // Update progress to 75%
      const progressCircle = overlay.querySelector('.progress-circle');
      if (progressCircle) {
        progressCircle.style.strokeDashoffset = '39.25';
      }
      
      // Show crop modal
      await showImageCropModal(file);
      
      // Complete animation
      await endProcessingAnimation(overlay, true);
    }
    
    // End processing with success/error state
    async function endProcessingAnimation(overlay, success = true) {
      return new Promise((resolve) => {
        const progressCircle = overlay.querySelector('.progress-circle');
        
        if (success && progressCircle) {
          // Complete the circle
          progressCircle.style.strokeDashoffset = '0';
          progressCircle.style.stroke = '#4ECDC4';
        }
        
        setTimeout(() => {
          overlay.classList.remove('processing');
          
          if (progressCircle) {
            // Reset for next time
            progressCircle.style.strokeDashoffset = '157';
            progressCircle.style.stroke = '#4ECDC4';
          }
          
          resolve();
        }, success ? 800 : 400);
      });
    }
    
    // Tesla-Grade Toast Notification System
    function showTeslaToast(message, type = 'info', duration = 4000) {
      // Remove any existing toasts
      document.querySelectorAll('.tesla-toast').forEach(toast => toast.remove());
      
      const toast = document.createElement('div');
      toast.className = `tesla-toast tesla-toast-${type}`;
      
      const iconMap = {
        success: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="20,6 9,17 4,12"></polyline>
                  </svg>`,
        error: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>`,
        warning: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="m21,12l-3-5l-4-3l-6,0l-4,3l-3,5l3,5l4,3l6,0l4,-3l3,-5z"></path>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                  </svg>`,
        info: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                 <circle cx="12" cy="12" r="10"></circle>
                 <path d="m12,16l0,-4"></path>
                 <path d="m12,8l.01,0"></path>
               </svg>`
      };
      
      toast.innerHTML = `
        <div class="toast-content">
          <div class="toast-icon">${iconMap[type]}</div>
          <div class="toast-message">${message}</div>
          <button class="toast-close" onclick="this.parentElement.parentElement.remove()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="toast-progress"></div>
      `;
      
      // Add Tesla-grade styles
      Object.assign(toast.style, {
        position: 'fixed',
        top: '24px',
        right: '24px',
        background: 'rgba(15, 16, 34, 0.95)',
        backdropFilter: 'blur(20px)',
        border: '1px solid rgba(255, 255, 255, 0.1)',
        borderRadius: '16px',
        color: 'white',
        padding: '0',
        margin: '0',
        zIndex: '10000',
        transform: 'translateX(100%)',
        transition: 'all 0.4s cubic-bezier(0.23, 1, 0.32, 1)',
        boxShadow: '0 20px 40px rgba(0, 0, 0, 0.3)',
        maxWidth: '400px',
        minWidth: '300px',
        overflow: 'hidden'
      });
      
      document.body.appendChild(toast);
      
      // Animate in
      setTimeout(() => {
        toast.style.transform = 'translateX(0)';
      }, 100);
      
      // Auto remove
      setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 400);
      }, duration);
      
      return toast;
    }

    // Bridge function to open crop modal with optimized image
    async function openCropModal(imageUrl, optimizedResult) {
      try {
        console.log('[Avatar] Opening crop modal with optimized image');
        
        // Store optimization result for later use
        window.currentOptimizedResult = optimizedResult;
        
        // Convert URL to File-like object for existing crop system
        const response = await fetch(imageUrl);
        const blob = await response.blob();
        const file = new File([blob], 'avatar.jpg', { type: blob.type });
        
        // Use existing crop modal system
        await showImageCropModal(file);
        
      } catch (error) {
        console.error('[Avatar] Failed to open crop modal:', error);
        showTeslaToast('Failed to open image editor', 'error');
        throw error;
      }
    }
    
    // TESLA GOLD STANDARD AVATAR CROP SYSTEM
    window.TeslaAvatarCrop = {
      canvas: null,
      ctx: null,
      image: null,
      scale: 1,
      x: 0,
      y: 0,
      dragging: false,
      
      async show(file) {
        try {
          const dataUrl = await this.fileToDataURL(file);
          this.init();
          await this.loadImage(dataUrl);
          this.showModal();
        } catch (error) {
          console.error('Tesla Avatar Crop Error:', error);
          showTeslaToast('Failed to process image', 'error');
        }
      },
      
      init() {
        this.canvas = document.getElementById('teslaCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.scale = 1;
        this.x = 0;
        this.y = 0;
        this.setupEvents();
      },
      
      async loadImage(dataUrl) {
        return new Promise((resolve, reject) => {
          this.image = new Image();
          this.image.onload = () => {
            this.autoFit();
            this.draw();
            resolve();
          };
          this.image.onerror = reject;
          this.image.src = dataUrl;
        });
      },
      
      autoFit() {
        const minScale = Math.max(180/this.image.width, 180/this.image.height);
        this.scale = minScale * 1.1;
        this.x = (260 - this.image.width * this.scale) / 2;
        this.y = (260 - this.image.height * this.scale) / 2;
        document.getElementById('teslaZoom').value = this.scale;
      },
      
      draw() {
        this.ctx.clearRect(0, 0, 260, 260);
        if (this.image) {
          this.ctx.drawImage(this.image, this.x, this.y, 
            this.image.width * this.scale, this.image.height * this.scale);
        }
      },
      
      setupEvents() {
        const canvas = this.canvas;
        const zoom = document.getElementById('teslaZoom');
        
        zoom.oninput = () => {
          this.scale = parseFloat(zoom.value);
          this.draw();
        };
        
        canvas.onmousedown = (e) => this.startDrag(e);
        canvas.onmousemove = (e) => this.drag(e);
        canvas.onmouseup = () => this.dragging = false;
      },
      
      startDrag(e) {
        this.dragging = true;
        this.lastX = e.offsetX;
        this.lastY = e.offsetY;
      },
      
      drag(e) {
        if (!this.dragging) return;
        const dx = e.offsetX - this.lastX;
        const dy = e.offsetY - this.lastY;
        this.x += dx;
        this.y += dy;
        this.lastX = e.offsetX;
        this.lastY = e.offsetY;
        this.draw();
      },
      
      showModal() {
        document.getElementById('teslaAvatarCrop').classList.add('active');
      },
      
      close() {
        document.getElementById('teslaAvatarCrop').classList.remove('active');
      },
      
      async save() {
        try {
          const croppedCanvas = this.getCroppedImage();
          const blob = await this.canvasToBlob(croppedCanvas);
          const filename = `avatar_${Date.now()}.jpg`;
          await this.uploadAvatar(blob, filename);
          this.close();
        } catch (error) {
          console.error('Save Error:', error);
          showTeslaToast('Failed to save avatar', 'error');
        }
      },
      
      getCroppedImage() {
        const cropCanvas = document.createElement('canvas');
        cropCanvas.width = cropCanvas.height = 200;
        const cropCtx = cropCanvas.getContext('2d');
        
        const centerX = 260 / 2;
        const centerY = 260 / 2;
        const radius = 90;
        
        cropCtx.drawImage(this.canvas, 
          centerX - radius, centerY - radius, radius * 2, radius * 2,
          0, 0, 200, 200);
        
        return cropCanvas;
      },
      
      canvasToBlob(canvas) {
        return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
      },
      
      fileToDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      },
      
      async uploadAvatar(blob, filename) {
        const { data, error } = await window.supabase.storage
          .from('avatars')
          .upload(filename, blob, { cacheControl: '3600', upsert: false });
        
        if (error) throw error;
        
        const { data: { publicUrl } } = window.supabase.storage
          .from('avatars')
          .getPublicUrl(filename);
        
        if (currentProfile) {
          currentProfile.avatar_url = publicUrl;
          updateProfileDisplay();
        }
        showTeslaToast('Avatar updated successfully!', 'success');
      }
    };
    
    // INTEGRATION: Connect external tesla-avatar-cropper.js to our Tesla system
    window.showCropModalWithAnimation = (image) => {
      console.log('ðŸ”— External cropper â†’ Tesla Avatar Crop');
      if (image && image.src) {
        const file = dataURLtoFile(image.src, 'avatar.jpg');
        TeslaAvatarCrop.show(file);
      }
    };
    
    function dataURLtoFile(dataurl, filename) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while(n--) u8arr[n] = bstr.charCodeAt(n);
      return new File([u8arr], filename, {type:mime});
    }
    
    // Profile initialization when page loads
    // DEBUG: Test Tesla Crop System
    function testTeslaCrop() {
      console.log('ðŸ§ª Testing Tesla Crop System...');
      
      if (!window.TeslaAvatarCrop) {
        console.error('âŒ TeslaAvatarCrop not available');
        showTeslaToast('TeslaAvatarCrop system not found', 'error');
        return;
      }
      
      // Create a test canvas image
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 300;
      const ctx = canvas.getContext('2d');
      
      // Draw Tesla-style test pattern
      const gradient = ctx.createLinearGradient(0, 0, 300, 300);
      gradient.addColorStop(0, '#4ECDC4');
      gradient.addColorStop(1, '#FFD93D');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, 300, 300);
      ctx.fillStyle = '#0F0F23';
      ctx.font = '48px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('TEST', 150, 160);
      
      // Convert to blob and test crop system
      canvas.toBlob(async (blob) => {
        const file = new File([blob], 'test-avatar.png', { type: 'image/png' });
        console.log('âœ… Created test file:', file);
        
        try {
          await window.TeslaAvatarCrop.show(file);
          console.log('âœ… Tesla crop modal opened successfully');
          showTeslaToast('Tesla crop system working!', 'success');
        } catch (error) {
          console.error('âŒ Tesla crop failed:', error);
          showTeslaToast('Tesla crop system failed', 'error');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Use the proper initialization function
        await initializeProfile();
      } catch (error) {
        console.error('âŒ Profile initialization failed:', error);
        console.log('ðŸš€ Loading emergency fallback profile...');
        
        // Emergency fallback - force load demo profile
        emergencyProfileLoad();
      }
      
      // Setup location picker integration
      const locationInput = document.getElementById('sheetLocationInput');
      if (locationInput && window.LocationPicker) {
        locationInput.addEventListener('click', () => {
          window.LocationPicker.show((result) => {
            locationInput.value = result.formatted;
          });
        });
      }
    });
    
    // Auto-trigger emergency load if page is empty after 5 seconds
    setTimeout(() => {
      const usernameEl = document.getElementById('profileUsername');
      const statsGrid = document.getElementById('statsGrid');
      
      // Check if profile content is missing
      if (!usernameEl || !usernameEl.textContent || usernameEl.textContent === '@username' || 
          !statsGrid || statsGrid.children.length === 0) {
        console.log('â° Auto-triggering emergency profile load - no content detected');
        emergencyProfileLoad();
      }
    }, 5000);
    
    // Emergency profile loader - guaranteed to work
    function emergencyProfileLoad() {
      console.log('ðŸ†˜ Emergency profile load activated');
      
      // Force set global profile data
      window.currentProfile = {
        id: 'emergency-demo-user',
        username: 'demo_user',
        display_name: 'Demo User',
        avatar_url: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face',
        bio: 'Living life one Hi moment at a time! ðŸŒŸ Exploring the world of meaningful connections.',
        location: 'Austin, TX',
        created_at: new Date().toISOString()
      };
      
      window.userStats = {
        total_hi_moments: 127,
        current_streak: 12,
        longest_streak: 45,
        total_waves: 89,
        total_starts: 23,
        days_active: 18
      };
      
      // Force update displays
      setTimeout(() => {
        forceUpdateAllDisplays();
        showTeslaToast('Emergency profile loaded successfully! ðŸš€', 'success');
      }, 500);
    }
    
    // Force display update that bypasses all checks
    function forceUpdateAllDisplays() {
      const profile = window.currentProfile;
      const stats = window.userStats;
      
      if (!profile) return;
      
      // Update profile info
      const usernameEl = document.getElementById('profileUsername');
      const bioEl = document.getElementById('profileBio');
      const locationEl = document.getElementById('profileLocation');
      const avatarEl = document.getElementById('profileAvatar');
      
      if (usernameEl) usernameEl.textContent = `@${profile.username}`;
      if (bioEl) bioEl.textContent = profile.bio || 'No bio yet';
      if (locationEl) locationEl.innerHTML = `ðŸ“ ${profile.location || 'No location set'}`;
      if (avatarEl && profile.avatar_url) {
        avatarEl.src = profile.avatar_url;
        avatarEl.style.display = 'block';
      }
      
      // Update stats
      const statsGrid = document.getElementById('statsGrid');
      if (statsGrid && stats) {
        statsGrid.innerHTML = `
          <div class="stat-item">
            <div class="stat-value">${stats.total_hi_moments}</div>
            <div class="stat-label">Hi Moments</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${stats.current_streak}</div>
            <div class="stat-label">Day Streak</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${stats.total_waves}</div>
            <div class="stat-label">Hi Waves</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${stats.total_starts}</div>
            <div class="stat-label">Hi Starts</div>
          </div>
        `;
      }
      
      // Show achievements
      const achievementsGrid = document.getElementById('achievementsGrid');
      if (achievementsGrid) {
        achievementsGrid.innerHTML = `
          <div class="achievement unlocked">
            <span class="achievement-icon">ðŸ‘‹</span>
            <div class="achievement-name">First Hi</div>
          </div>
          <div class="achievement unlocked">
            <span class="achievement-icon">ðŸ”¥</span>
            <div class="achievement-name">Week Streak</div>
          </div>
          <div class="achievement">
            <span class="achievement-icon">â­</span>
            <div class="achievement-name">Popular</div>
          </div>
          <div class="achievement unlocked">
            <span class="achievement-icon">ðŸŒ</span>
            <div class="achievement-name">Explorer</div>
          </div>
          <div class="achievement">
            <span class="achievement-icon">ðŸ‘¥</span>
            <div class="achievement-name">Social</div>
          </div>
          <div class="achievement">
            <span class="achievement-icon">ðŸŽ–ï¸</span>
            <div class="achievement-name">Veteran</div>
          </div>
        `;
      }
      
      console.log('âœ… Profile display forced successfully');
    }
  </script>
  
  <!-- Tesla-Grade Debug Output Cleaner -->
  <script src="assets/profile-debug-cleaner.js"></script>
  
  <!-- Footer disabled for clean Tesla profile experience -->
</body>
</html>
