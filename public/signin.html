<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign in — Stay Hi</title>

  <!-- Your shared styles -->
  <link rel="stylesheet" href="assets/create-parity.css" />

  <style>
    body{min-height:100vh;background:linear-gradient(135deg,#F5A623 0%,#FFC107 100%);}
    .card{max-width:560px;margin:32px auto;background:#FFFDF9;border:1px solid #eee;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .card .hd{padding:18px 22px;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;gap:10px}
    .card .bd{padding:24px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:40px;height:40px}
    .brand span{font-weight:800;color:#111;font-size:18px}
    .muted{color:#666}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:12px;font-weight:700;border:1px solid transparent;cursor:pointer}
    .btn-primary{background:#006400;color:#fff}
    .btn-primary[disabled]{opacity:.6;cursor:not-allowed}
    .input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #e4e4e4;background:#fff;font-size:16px}
    .row{display:flex;gap:12px;align-items:center}
    .space{height:14px}
    .notice{border-radius:12px;padding:12px 14px;background:#f7f7f7;border:1px solid #eee;font-size:14px}
    .notice.ok{background:#e9f9ef;border-color:#c9efda;color:#0b6a2b}
    .notice.err{background:#fff1f1;border-color:#ffd2d2;color:#8b0000}
    .center{text-align:center}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;max-width:980px;margin:12px auto 0;padding:0 14px}
    .link{color:#111;text-decoration:underline}
    .dev{display:none;margin:14px auto 0;max-width:560px}
    .dev .btn{width:100%}
    @media (max-width:520px){ .card{margin:18px 12px} }
  </style>
</head>
<body>

  <!-- Shared header (logo / calendar / menu) gets injected here -->
  <header id="app-header"></header>

  <!-- Thin top bar with back link -->
  <div class="topbar">
    <a href="index.html" class="link">← Back to Home</a>
    <a href="signup.html" class="link">Need an invite? Sign up</a>
  </div>

  <main class="card" role="main" aria-labelledby="title">
    <div class="hd">
      <div class="brand">
        <img alt="Stay Hi" src="https://ucarecdn.com/4233fafa-2eee-45bf-bee2-eb6578070c5b/-/format/auto/"/>
        <span id="title">Sign in to Stay Hi</span>
      </div>
    </div>
    <div class="bd">
      <p class="muted">We’ll email you a secure link to sign in.</p>

      <form id="signinForm" class="form" autocomplete="on">
        <label for="email" class="muted">Email</label>
        <input id="email" name="email" type="email" required placeholder="you@domain.com" class="input" />
        <div class="space"></div>
        <button id="sendBtn" class="btn btn-primary" type="submit">Send sign-in link</button>
      </form>

      <div id="msg" class="notice" style="display:none;margin-top:14px;"></div>

      <div class="space"></div>
      <p class="muted" style="font-size:13px">
        Tip: the link opens a <b>Post-Auth</b> page that completes the session then returns you to Home.
      </p>
    </div>
  </main>

  <!-- Local-dev helper: only shows when opening the file:// directly -->
  <div id="devBox" class="dev">
    <div class="notice" style="margin-bottom:10px">
      Local preview detected. Magic links require an HTTP(S) origin. Use this temporary
      dev button to browse the app while we build (does not create a real session).
    </div>
    <button id="devLogin" class="btn">Developer quick sign-in (local only)</button>
  </div>

  <!-- Shared header JS (injects top app header) -->
  <script src="assets/header.js" defer></script>

  <!-- Supabase (no bundler needed) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  // ---- Configure your Supabase project (CLIENT ANON KEY is expected here) ----
  // You can set these on window from assets/app.js if you prefer:
  //   window.SUPABASE_URL = 'https://xxx.supabase.co';
  //   window.SUPABASE_ANON_KEY = 'eyJhbGciOi...';
  const SUPABASE_URL = window.SUPABASE_URL || 'https://YOUR-PROJECT.supabase.co';
  const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'YOUR_PUBLIC_ANON_KEY';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Compute redirect URL for magic link
  function computeRedirect() {
    // Works in staging/production; falls back to your prod domain if opened via file://
    const prod = 'https://stay-hi.vercel.app/post-auth.html';
    try {
      if (location.origin.startsWith('http')) {
        return location.origin.replace(/\/$/, '') + '/post-auth.html';
      }
    } catch(_) {}
    return prod;
  }

  // UI helpers
  const $ = (s)=>document.querySelector(s);
  const msg = $('#msg');
  function showMessage(text, kind='info'){
    msg.textContent = text;
    msg.className = 'notice ' + (kind==='ok' ? 'ok' : kind==='err' ? 'err' : '');
    msg.style.display = 'block';
  }

  // Form submit
  const form = $('#signinForm');
  const btn  = $('#sendBtn');

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.style.display = 'none';

    const email = (form.email.value || '').trim().toLowerCase();
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showMessage('Please enter a valid email address.', 'err');
      return;
    }

    btn.disabled = true;
    try {
      const redirectTo = computeRedirect();
      const { data, error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: redirectTo,
          shouldCreateUser: false   // this is for SIGN IN only
        }
      });
      if (error) throw error;
      showMessage('Check your email for the sign-in link. If it does not appear, check spam.', 'ok');
      form.reset();
    } catch (err) {
      console.error(err);
      showMessage(err.message || 'Could not send sign-in link.', 'err');
    } finally {
      btn.disabled = false;
    }
  });

  // Local dev helper (only when opening file://)
  if (location.protocol === 'file:') {
    const box = $('#devBox');
    box.style.display = 'block';
    $('#devLogin').addEventListener('click', ()=>{
      // Fake a lightweight “dev session” flag; your app can show limited UI when this exists.
      localStorage.setItem('hi_dev_user', 'dev@example.com');
      window.location.href = 'index.html';
    });
  }
  </script>
</body>
</html>
