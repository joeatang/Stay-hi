<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Sign in — Stay Hi</title>
  <link rel="stylesheet" href="assets/theme.css"/>
  <link rel="stylesheet" href="assets/create-parity.css"/>
  <style>
    .wrap{max-width:520px;margin:6vh auto;padding:16px}
    .brand{display:flex;align-items:center;gap:10px;justify-content:center;margin-bottom:10px}
    .brand .logo{width:38px;height:38px;border-radius:12px;background:var(--grad-ember)}
    .card{background:#fff;border:1px solid var(--hi-border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--hi-muted)}
    .success{display:none;margin-top:10px}
    .error{display:none;margin-top:10px;color:#b91c1c}
  </style>
</head>
<body>
  <header id="app-header"></header>

  <main class="wrap">
    <div class="brand">
      <div class="logo"></div>
      <h1 class="h1" style="margin:0">Stay Hi</h1>
    </div>

    <div class="card">
      <h2 class="h2" style="margin-top:0">Sign in</h2>
      <p class="muted" style="margin-top:0">We’ll email you a magic link. No password needed.</p>

      <label for="email" class="hint">Email</label>
      <input id="email" type="email" class="hi-input" placeholder="you@example.com" autocomplete="email" required />

      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <a href="index.html" class="hi-btn hi-btn--ghost">Cancel</a>
        <button id="send" class="hi-btn hi-btn--primary">Send magic link</button>
      </div>

      <div id="success" class="success hi-card">✅ Check your inbox for a link. Open it on this device to finish signing in.</div>
      <div id="err" class="error"></div>
    </div>

    <p class="hint" style="text-align:center;margin-top:14px">
      After signing in, you can <b>Drop Hi</b> and it will save to the database (and still work offline).
    </p>
  </main>

  <script src="assets/supabase-init.js"></script>
  <script src="assets/auth.js"></script>
  <script>
    (function(){
      const sb = window.sb; // from supabase-init.js
      const email = document.getElementById('email');
      const sendBtn = document.getElementById('send');
      const ok = document.getElementById('success');
      const err = document.getElementById('err');

      // If returning from a magic link, Supabase will set the session — bounce back to app
      (async () => {
        try {
          const { data: { session } } = await sb.auth.getSession();
          if (session) {
            const next = new URLSearchParams(location.search).get('next') || 'index.html';
            location.replace(next);
          }
        } catch {}
      })();

      sendBtn.addEventListener('click', async () => {
        err.style.display = 'none'; ok.style.display = 'none';

        const emailVal = (email.value || '').trim();
        if (!emailVal) { err.textContent = 'Enter a valid email.'; err.style.display = 'block'; return; }

        sendBtn.disabled = true; sendBtn.textContent = 'Sending…';
        try {
          // Use current URL as redirect so it lands back in app domain
          const redirectTo = `${location.origin}/signin.html?next=${encodeURIComponent(new URLSearchParams(location.search).get('next') || 'index.html')}`;
          const { error } = await sb.auth.signInWithOtp({ email: emailVal, options: { emailRedirectTo: redirectTo }});
          if (error) throw error;
          ok.style.display = 'block';
        } catch (e) {
          err.textContent = e.message || 'Could not send link.'; err.style.display = 'block';
        } finally {
          sendBtn.disabled = false; sendBtn.textContent = 'Send magic link';
        }
      });
    })();
  </script>

  <script src="assets/header.js" defer></script>
</body>
</html>
