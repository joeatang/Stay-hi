<!DOCTYPE html>
<html>
<head>
    <title>Tesla-Grade User Authentication Flow Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="assets/url-path-fixer.js"></script>
    <script src="assets/auth-guard.js?v=enhanced-logging"></script>
</head>
<body>
    <div style="font-family: system-ui; max-width: 800px; margin: 40px auto; padding: 20px;">
        <h1>üöÄ Tesla-Grade Authentication Flow Test</h1>
        
        <div id="status" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <p>Loading authentication status...</p>
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin: 20px 0;">
            <button onclick="testHiMuscle()" style="padding: 10px 20px;">üèãÔ∏è Test Hi-Muscle</button>
            <button onclick="testHiIsland()" style="padding: 10px 20px;">üèùÔ∏è Test Hi-Island</button>
            <button onclick="checkFullAuth()" style="padding: 10px 20px;">üîç Full Auth Check</button>
            <button onclick="clearAllAuth()" style="padding: 10px 20px;">üóëÔ∏è Clear Auth</button>
            <button onclick="signIn()" style="padding: 10px 20px;">‚úÖ Sign In</button>
        </div>
        
        <div id="logs" style="background: #000; color: #0f0; padding: 15px; border-radius: 8px; font-family: monospace; max-height: 400px; overflow-y: auto;">
            <p>Console logs will appear here...</p>
        </div>
    </div>
    
    <script>
        let originalConsoleLog = console.log;
        const logsDiv = document.getElementById('logs');
        
        // Intercept console.log to show in UI
        console.log = function(...args) {
            originalConsoleLog.apply(console, arguments);
            const logMessage = args.join(' ');
            logsDiv.innerHTML += `<p style="margin: 2px 0;">${new Date().toLocaleTimeString()}: ${logMessage}</p>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        };
        
        async function initSupabase() {
            if (!window.supabase) {
                const { createClient } = supabase;
                window.supabaseClient = createClient(
                    'https://ikmobwqxxulzrknzgwzj.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrbW9id3F4eHVsenJrbnpnd3pqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY0NDg3MjYsImV4cCI6MjA0MjAyNDcyNn0.eqRHJVtS4gj4n1PB7l_u9U_B76hOlGgSg7OhDbTRS6g'
                );
            }
            return window.supabaseClient;
        }
        
        async function checkFullAuth() {
            try {
                console.log('üîç Starting comprehensive auth check...');
                
                const client = await initSupabase();
                console.log('‚úÖ Supabase client initialized');
                
                const { data: { session }, error } = await client.auth.getSession();
                
                const status = document.getElementById('status');
                
                const authInfo = {
                    sessionExists: !!session,
                    userId: session?.user?.id || null,
                    email: session?.user?.email || null,
                    accessToken: session?.access_token ? 'Present' : 'Missing',
                    refreshToken: session?.refresh_token ? 'Present' : 'Missing',
                    currentUrl: window.location.href,
                    pathname: window.location.pathname,
                    userAgent: navigator.userAgent.substring(0, 100) + '...',
                    timestamp: new Date().toISOString()
                };
                
                console.log('üìä Auth Status:', JSON.stringify(authInfo, null, 2));
                
                // Test hybrid page detection
                const isHybridPage = location.pathname.endsWith('hi-muscle.html') || 
                                     location.pathname.endsWith('hi-island-NEW.html') ||
                                     location.pathname.endsWith('index.html') || 
                                     location.pathname === '/';
                
                console.log('üé≠ Hybrid page detected:', isHybridPage);
                
                status.innerHTML = `
                    <h3>Authentication Status:</h3>
                    <p><strong>Session:</strong> ${authInfo.sessionExists ? '‚úÖ Active' : '‚ùå None'}</p>
                    <p><strong>User:</strong> ${authInfo.email || 'Not signed in'}</p>
                    <p><strong>Access Token:</strong> ${authInfo.accessToken}</p>
                    <p><strong>Current Path:</strong> ${authInfo.pathname}</p>
                    <p><strong>Hybrid Mode:</strong> ${isHybridPage ? '‚úÖ Enabled' : '‚ùå Disabled'}</p>
                    <p><strong>Browser:</strong> ${authInfo.userAgent}</p>
                `;
                
                if (error) {
                    console.error('‚ùå Auth check error:', error);
                }
                
            } catch (error) {
                console.error('üí• Critical auth check failure:', error);
            }
        }
        
        async function testHiMuscle() {
            console.log('üèãÔ∏è Testing Hi-Muscle access...');
            console.log('Current location before redirect:', window.location.href);
            
            // Add timestamp to avoid caching issues
            window.location.href = `/hi-muscle.html?test=${Date.now()}`;
        }
        
        async function testHiIsland() {
            console.log('üèùÔ∏è Testing Hi-Island access...');
            window.location.href = `/hi-island-NEW.html?test=${Date.now()}`;
        }
        
        async function clearAllAuth() {
            try {
                console.log('üóëÔ∏è Clearing all authentication data...');
                
                const client = await initSupabase();
                await client.auth.signOut();
                
                // Clear local storage
                localStorage.clear();
                sessionStorage.clear();
                
                // Clear cookies (best effort)
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                console.log('‚úÖ All auth data cleared');
                
                // Reload to reset state
                setTimeout(() => window.location.reload(), 1000);
                
            } catch (error) {
                console.error('‚ùå Error clearing auth:', error);
            }
        }
        
        async function signIn() {
            console.log('‚úÖ Redirecting to sign in...');
            window.location.href = '/signin.html';
        }
        
        // Auto-check auth on load
        window.addEventListener('load', () => {
            console.log('üöÄ Tesla-Grade Auth Test Loaded');
            setTimeout(checkFullAuth, 500); // Delay to ensure everything is loaded
        });
        
        // Check initial state
        checkFullAuth();
    </script>
</body>
</html>