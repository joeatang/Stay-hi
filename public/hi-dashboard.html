<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,maximum-scale=1,shrink-to-fit=no"/>
  <title>Stay Hi ‚Äî Tesla Simplified</title>

  <!-- HI-OS S-ARCH/1: Webroot Guard (dev-only) -->
  <script>
    // Pass criteria: location.pathname must contain "/public/"
    (function() {
      const PASS = location.pathname.includes('/public/');
      const msg  = PASS ? 'GREEN ‚Äî served from /public (web root OK)'
                        : 'RED ‚Äî NOT served from /public (fix dev server root)';
      // Expose for other verifiers
      window.__HI_WEBROOT_OK = PASS;

      // Console signal
      const tag = '[HI-OS][WEBROOT]';
      if (PASS) {
        console.log(`${tag} ${msg}`);
      } else {
        console.error(`${tag} ${msg}`);
      }

      // Minimal UI badge injection (dev page only)
      try {
        const badge = document.createElement('div');
        badge.textContent = msg;
        badge.setAttribute('id', 'hi-webroot-guard');
        badge.style.position = 'fixed';
        badge.style.bottom = '12px';
        badge.style.right = '12px';
        badge.style.zIndex = '99999';
        badge.style.padding = '8px 10px';
        badge.style.fontFamily = 'system-ui,-apple-system,Segoe UI,Roboto,Arial';
        badge.style.fontSize = '12px';
        badge.style.borderRadius = '6px';
        badge.style.border = PASS ? '1px solid #1f7a1f' : '1px solid #a00';
        badge.style.background = PASS ? '#eaffea' : '#ffecec';
        badge.style.color = PASS ? '#0c540c' : '#7a0000';
        document.body.appendChild(badge);
      } catch (e) {
        console.warn('[HI-OS][WEBROOT] badge inject failed:', e);
      }
    })();
  </script>

  <!-- üì± PWA Configuration -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD166">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Stay Hi">

  <!-- Tesla-Grade Premium Scripts (Optimized Loading) -->
  <script src="assets/url-path-fixer.js" async></script>
  <!-- Resource Hints for Cross-Navigation Performance -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" as="script">
  <link rel="prefetch" href="hi-island-NEW.html">
  <link rel="prefetch" href="hi-muscle.html">
  <link rel="dns-prefetch" href="//stay-qwguz51c1-joeatangs-projects.vercel.app">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  
  <!-- Database & Hi Island Integration (Async) -->
  <script type="module" src="./lib/HiSupabase.v3.js"></script>
  <script src="assets/db.js" defer></script>
  
  <!-- üöÄ INTEGRATION #5: HiBase + HiFlags for Streaks system (flagged rollout) -->
  <script type="module" src="./lib/flags/HiFlags.js"></script>
  <script type="module" src="./lib/hibase/index.js"></script>

  <!-- üåü WOZNIAK-GRADE: Gold Standard Modal System (Unified Auth/Share Modals) -->
  <script src="lib/HiGoldStandardModal.js" async></script>
  
  <!-- üî• Phase 7: Hi Experience Layer Components (Async Loading) -->
  <script type="module" src="./lib/hifeed/index.js"></script>
  <script type="module" src="./ui/HiFeed/HiFeed.js"></script>
  <script type="module" src="./ui/HiStreaks/HiStreaks.js"></script>
  <script src="assets/hifeed-test-helper.js" async></script>
  <script src="assets/hifeed-verification.js" async></script>
  
  <!-- HiBase Integration (Flagged Rollout) -->
  <script type="module">
    // Import HiBase shares for flagged rollout
    window.HiBase_shares = await import('./lib/hibase/shares.js');
    console.log('üî• HiBase shares module loaded for dashboard integration');
  </script>
  
  <!-- HI-OS: Tesla-Grade Systems Integration - DISABLED for database-first system -->
  <!--
  <script type="module">
    // Load membership system first for access control
    await import('./lib/membership/MembershipSystem.js');
    
    import HiMetrics from './lib/HiMetrics.js';
    
    // Tesla-grade dashboard metrics with global variable compatibility
    async function initDashboardMetrics() {
      try {
        console.log('[Dashboard] Initializing HiMetrics adapter...');
        
        // Subscribe to metric updates for live dashboard
        const unsubscribe = HiMetrics.subscribe('dashboard-page', (metrics, cacheInfo) => {
          console.log('[Dashboard] Metrics updated:', metrics);
          
          // üö´ DISABLED: Don't override database-loaded values from DashboardStats.js
          // The Tesla-grade DashboardStats system handles global variables correctly
          // window.gWaves = metrics.waves || 0;
          // window.gTotalHis = metrics.hi5s || 0;
          // window.gUsers = 0; // Legacy fallback - not separated yet
          
          // Update debug badge (show during development only)
          if ((window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) || window.location.search.includes('debug=1')) {
            const debugEl = document.getElementById('hiMetricsDebugDash');
            const statusEl = document.getElementById('dashMetricsStatus');
            const cacheEl = document.getElementById('dashCacheAge');
            
            if (debugEl && statusEl && cacheEl) {
              debugEl.style.display = 'block';
              statusEl.textContent = cacheInfo?.fromCache ? '‚úÖ' : 'üîÑ';
              cacheEl.textContent = `Cache: ${cacheInfo?.ageSeconds || 0}s`;
            }
          }
          
          // Trigger UI update if legacy function exists
          if (window.updateGlobalStats) {
            window.updateGlobalStats();
          }
          
          // Load user streak data if function exists
          if (window.loadUserStreak) {
            window.loadUserStreak();
          }
        });
        
        // Load initial metrics (will use cache if available)
        const metrics = await HiMetrics.load();
        console.log('[Dashboard] ‚úÖ HiMetrics adapter initialized with globals', {
          gWaves: window.gWaves,
          gTotalHis: window.gTotalHis,
          gUsers: window.gUsers
        });
        
        // Store unsubscribe function for cleanup
        window.dashboardMetricsCleanup = unsubscribe;
        
        // Make legacy loader available for compatibility
        window.hiStatsLoader = () => HiMetrics.load();
        
      } catch (error) {
        console.error('[Dashboard] HiMetrics initialization failed:', error);
        
        // Legacy fallback for safety
        try {
          if (window.HiBase?.stats?.getMetrics) {
            const metrics = await window.HiBase.stats.getMetrics();
            console.log('üö® FALLBACK CODE EXECUTING - THIS IS THE BUG!', { metrics });
            console.log('üö® About to reset window.gWaves from', window.gWaves, 'to', metrics.waves?.data || 0);
            // üö´ DISABLED: This fallback was overriding database values
            // window.gWaves = metrics.waves?.data || 0;
            // window.gTotalHis = metrics.hi5s?.data || 0;
            // window.gUsers = 0;
            
            if (window.updateGlobalStats) {
              window.updateGlobalStats();
            }
            
            console.log('[Dashboard] ‚úÖ Fallback stats loaded');
          }
        } catch (fallbackError) {
          console.error('[Dashboard] Fallback also failed:', fallbackError);
        }
      }
    }
    
    // Initialize when DOM is ready
    window.addEventListener('DOMContentLoaded', initDashboardMetrics);
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (window.dashboardMetricsCleanup) {
        window.dashboardMetricsCleanup();
        console.log('[Dashboard] HiMetrics subscription cleaned up');
      }
    });
  </script>
  -->
  
  <!-- S-DASH Stats Row Wiring (Flag-Gated) - DISABLED for database-first system -->
  <!-- <script type="module" src="./lib/HiDash.wire.js"></script> -->
  
  <!-- S-DASH Hero CTA Wiring (Flag-Gated) -->
  <script type="module" src="./lib/HiDash.cta.js"></script>
  
  <!-- S-DASH Share CTA Wiring (Flag-Gated) -->
  <script type="module" src="./lib/HiDash.share.js"></script>
  
  <!-- S-DASH/8 Micro-Feedback System (Flag-Gated) -->
  <script type="module" src="./lib/HiDash.feedback.js"></script>
  
  <!-- P1/Step2: Dashboard boot guard -->
  <script type="module" src="./lib/HiDash.boot.js"></script>
  
  <!-- Premium Authentication & UX (Async) -->
  <script src="assets/progressive-auth.js" async></script>
  <script src="assets/anonymous-access-modal.js" async></script>
  <script src="./lib/HiMembership.js"></script>
  <script src="./lib/RealUserCount.js"></script>
  <script src="./lib/HiWavesRealtime.js"></script>
  <script src="assets/performance-manager.js"></script>
  
  <!-- Tesla-Grade Milestone Celebration System -->
  <script src="assets/milestone-celebration-system.js"></script>
  
  <!-- Tesla-Grade Contextual Spotlight System -->
  <script src="assets/contextual-spotlight-system.js"></script>
  
  <!-- Tesla-Grade Smart Conversion System -->
  <script src="assets/smart-conversion-system.js"></script>
  
  <!-- Premium CSS Integration -->
  <link rel="preload" href="assets/premium-ux.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="assets/premium-calendar.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="./ui/HiFooter/HiFooter.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="./ui/HiModal/HiModal.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  <!-- Tesla-Grade Navigation System -->
  <!-- Tesla Navigation System CSS removed - Home nav now in header -->
  
  <!-- Hi Share Sheet Component -->
  <link rel="preload" href="ui/HiShareSheet/HiShareSheet.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  <!-- HI DEV: Tesla-Grade HiMedallion Component -->
  <link rel="preload" href="ui/HiMedallion/HiMedallion.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  <noscript>
    <link rel="stylesheet" href="assets/premium-ux.css">
    <link rel="stylesheet" href="assets/premium-calendar.css">
    <link rel="stylesheet" href="assets/onboarding.css">
    <link rel="stylesheet" href="ui/HiFooter/HiFooter.css">
    <link rel="stylesheet" href="ui/HiModal/HiModal.css">
    <link rel="stylesheet" href="ui/HiShareSheet/HiShareSheet.css">
    <link rel="stylesheet" href="ui/HiMedallion/HiMedallion.css">
    <!-- HiNavigationSystem.css removed -->
    <link rel="stylesheet" href="./lib/navigation/HiStandardNavigation.css">
  </noscript>

  <!-- S-DASH/7: Hero polish + stats row styling -->
  <link rel="stylesheet" href="styles/hi-dashboard.css">

  <!-- HI DEV: Fast Brand Controls - Page-Specific Medallion Overrides -->
  <style>
    :root {
      /* Dashboard page flavor - energetic, action-oriented gradient */
      --hi-medallion-bg1: #FF9A3C;   /* warmer top */
      --hi-medallion-bg2: #D84B8A;   /* richer bottom */
      --hi-medallion-halo: rgba(255,255,255,0.22);
    }
    
    /* üèóÔ∏è WOZNIAK-GRADE: Rock-solid viewport stability */
    * {
      box-sizing: border-box;
    }
    
    html {
      overflow-x: hidden;
      width: 100%;
      -webkit-text-size-adjust: 100%;
    }
    
    body {
      background: linear-gradient(135deg, #2d1e4f 0%, #ff7a18 60%, #ffd166 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      width: 100%;
      max-width: 100vw;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow-x: hidden;
      position: relative;
    }

    /* Tesla-Grade Loading Shimmer Animation */
    .loading-shimmer {
      opacity: 0.7;
      animation: shimmer 1.5s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }

    /* üèóÔ∏è TESLA-GRADE: Universal viewport header with extreme device support */
    .tesla-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      max-width: 100vw;
      /* Tesla-grade dynamic height with safe area fallbacks */
      height: clamp(50px, calc(60px + env(safe-area-inset-top, 0px)), 100px);
      min-height: calc(44px + env(safe-area-inset-top, 10px)); /* Minimum touch target */
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px); /* Safari support */
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0 clamp(12px, 4vw, 24px) clamp(8px, 2vh, 12px);
      padding-top: clamp(8px, env(safe-area-inset-top, 10px), 20px);
      z-index: 1000;
      box-sizing: border-box;
      /* Tesla-grade universal support */
      contain: layout style paint;
    }

    .header-left {
      display: flex;
      align-items: center;
      width: 60px; /* Fixed width for symmetry */
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      width: 160px; /* Expanded for tier indicator + menu button */
      gap: 8px;
      overflow: visible !important;
      position: relative;
      z-index: 1002;
    }
    
    /* UX-First: Membership Tier Indicator */
    .tier-indicator {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 11px;
      font-weight: 600;
      color: var(--hi-tier-color, #6B7280);
      transition: all 0.3s ease;
      cursor: default;
      min-width: 60px;
      text-align: center;
    }
    
    .tier-indicator:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }
    
    .tier-text {
      white-space: nowrap;
    }
    
    /* Smart Hiffirmations Pill - Contextual Access */
    .hiffirmations-smart-pill {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      cursor: pointer;
      margin-right: 8px;
    }
    
    .hiffirmations-smart-pill:hover {
      background: rgba(255, 209, 102, 0.2);
      transform: translateY(-1px);
      border-color: rgba(255, 209, 102, 0.3);
    }
    
    .pill-icon {
      font-size: 14px;
      opacity: 0.9;
    }

    .brand-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-hi-logo {
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .brand-text {
      font-size: 18px;
      font-weight: 600;
      color: #FFD166;
      letter-spacing: -0.5px;
    }

    .calendar-btn, .menu-btn, .home-nav-btn {
      display: flex !important;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.15) !important;
      color: #FFD166 !important;
      cursor: pointer;
      transition: all 0.3s ease;
      visibility: visible !important;
      opacity: 1 !important;
      z-index: 10001 !important;
      position: relative !important;
      flex-shrink: 0 !important;
    }

    .calendar-btn:hover, .menu-btn:hover, .home-nav-btn:hover {
      background: rgba(255, 209, 102, 0.2);
      transform: translateY(-1px);
    }

    /* Global Stats Container - Tesla-Grade Universal Compatibility */
    /* üèóÔ∏è TESLA-GRADE: Universal device viewport optimization */
    .global-stats-container {
      display: flex;
      justify-content: center;
      gap: clamp(4px, 1.5vw, 12px);
      margin: 15px 0 20px;
      flex-wrap: nowrap;
      max-width: 100%;
      padding: 0 clamp(8px, 3vw, 20px);
      box-sizing: border-box;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      /* Tesla-grade scrollbar behavior */
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .global-stats-container::-webkit-scrollbar {
      display: none;
    }

    .global-stat {
      display: flex;
      align-items: center;
      gap: clamp(6px, 1vw, 10px);
      padding: clamp(8px, 2vw, 12px) clamp(10px, 2.5vw, 16px);
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      /* Tesla-grade universal sizing */
      min-width: clamp(70px, calc((100vw - 60px) / 4.2), 130px);
      flex: 1;
      max-width: clamp(100px, 25vw, 140px);
      /* Tesla-grade minimum touch target */
      min-height: 44px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .global-stat:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
      font-size: clamp(14px, 3.5vw, 16px);
      opacity: 0.9;
      flex-shrink: 0;
    }

    .stat-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 0;
      flex: 1;
    }

    .stat-number {
      font-size: clamp(14px, 3.5vw, 16px);
      font-weight: 700;
      color: #FFD166;
      line-height: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .stat-label {
      font-size: clamp(8px, 2.2vw, 10px);
      color: rgba(255, 255, 255, 0.7);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-top: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    /* üèóÔ∏è WOZNIAK-GRADE: Stable main content with safe area */
    .main-content {
      margin-top: calc(80px + env(safe-area-inset-top));
      padding: 20px min(20px, 4vw) 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: calc(100vh - 180px - env(safe-area-inset-top));
      max-width: 100%;
      box-sizing: border-box;
    }



    /* Hi Medallion Section - Zero-Scroll Optimized */
    .hi-medallion-section {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 260px; /* Optimized for viewport fit */
      margin: 20px 0 30px; /* Reduced top margin for above-fold priority */
      padding: 20px; /* Streamlined padding for space efficiency */
    }

    /* üèóÔ∏è HI OS GOLD STANDARD: Long-Press Ring Animation System */
    .hi-medallion {
      position: relative;
      transition: transform 0.2s ease;
    }

    /* üèóÔ∏è TESLA-GRADE: Thicker ring outline for substantial feel */
    .hi-medallion::after {
      content: '';
      position: absolute;
      top: -12px;
      left: -12px;
      right: -12px;
      bottom: -12px;
      border: 6px solid transparent;
      border-radius: 50%;
      opacity: 0;
      transform: scale(0.95);
      transition: all 0.3s cubic-bezier(0.2, 0.7, 0.2, 1);
      pointer-events: none;
    }

    .hi-medallion.long-press-active::after {
      opacity: 1;
      transform: scale(1);
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow: 
        0 0 30px rgba(255, 255, 255, 0.2),
        inset 0 0 20px rgba(255, 255, 255, 0.1);
    }

    .hi-medallion.long-press-filling::after {
      background: conic-gradient(from 0deg, #FFFFFF var(--progress, 0%), transparent var(--progress, 0%));
      border-color: rgba(255, 255, 255, 0.6);
      opacity: 0.95;
      box-shadow: 
        0 0 40px rgba(255, 255, 255, 0.3),
        inset 0 0 30px rgba(255, 255, 255, 0.15);
    }

    .hi-medallion.long-press-complete::after {
      border-color: #FFFFFF;
      background: rgba(255, 209, 102, 0.1);
      opacity: 1;
    }

    /* üèóÔ∏è HI OS: Floating button system removed - using medallion long-press */
    .floating-hi5-universal {
      display: none !important; /* Force hide any remaining floating buttons */
    }

    /* Hiffirmations Modal Trigger */
    .hiffirmations-trigger {
      margin: 20px 0;
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .hiffirmations-trigger:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    /* Tesla-Grade Animation Classes */
    .pulse-simplified {
      animation: pulse-simplified 0.6s ease-out;
    }

    @keyframes pulse-simplified {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .logo-pop-simplified {
      animation: logo-pop-simplified 0.4s ease-out;
    }

    @keyframes logo-pop-simplified {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    /* Tesla-Grade Logo Animation Class */
    .logo-animation-wrapper.logo-pop-simplified {
      animation: logo-pop-simplified 0.4s ease-out;
    }

    /* Emoji Burst Animation */
    @keyframes waveUp-simplified {
      0% {
        transform: translate(-50%, -50%) translateX(0) translateY(0) scale(var(--s, 1));
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) translateX(var(--dx, 0)) translateY(-80px) scale(0.3);
        opacity: 0;
      }
    }

    /* üéØ Mario-Style Number Burst Animation */
    @keyframes numberBurst {
      0% {
        transform: scale(1) translateY(0);
        color: inherit;
        text-shadow: none;
      }
      20% {
        transform: scale(1.3) translateY(-8px);
        color: #FF9A3C;
        text-shadow: 0 0 12px rgba(255, 154, 60, 0.6), 0 2px 4px rgba(0,0,0,0.3);
      }
      40% {
        transform: scale(1.15) translateY(-4px);
        color: #FFD166;
        text-shadow: 0 0 16px rgba(255, 209, 102, 0.8);
      }
      100% {
        transform: scale(1) translateY(0);
        color: inherit;
        text-shadow: none;
      }
    }

    /* Burst class for triggering animation */
    .stat-number.burst {
      animation: numberBurst 0.5s ease-out;
    }

    /* Mobile Optimizations */
    @media (max-width: 480px) {
      .tesla-header {
        padding: 0 16px;
      }
      
      .header-left {
        gap: 12px;
      }
      
      .header-right {
        width: 170px; /* Extra space for mobile touch targets */
        gap: 6px; /* Tighter spacing on mobile */
      }
      
      .calendar-btn, .menu-btn {
        width: 36px;
        height: 36px;
      }
      
      .tesla-logo {
        font-size: 16px;
      }
      
      .mini-stats {
        gap: 8px;
        font-size: 11px;
      }
      
      .mini-stat {
        padding: 3px 6px;
      }
      
      .hi-medal-simplified {
        width: min(180px, 45vw);
      }
      
      .self-hi5-enhanced {
        padding: 14px 28px;
        font-size: 16px;
        min-width: 160px;
      }
      
      .main-content {
        padding: 16px 16px 100px;
      }
      
      /* Tesla-grade mobile stats optimization */
      .global-stats-container {
        gap: clamp(4px, 1.5vw, 8px);
        padding: 0 clamp(8px, 3vw, 16px);
      }
      
      .global-stat {
        min-width: clamp(65px, calc((100vw - 50px) / 4), 90px);
        padding: clamp(6px, 1.5vw, 10px) clamp(6px, 2vw, 12px);
        gap: clamp(4px, 1vw, 8px);
        min-height: 44px; /* Tesla-grade minimum touch target */
      }
      
      /* Text scaling for mobile readability */
      .stat-number {
        font-size: clamp(10px, 3vw, 14px);
      }
      
      .stat-label {
        font-size: clamp(7px, 2vw, 9px);
      }
    }

    /* Extreme small devices (watches, mini phones) */
    @media (max-width: 320px) {
      .global-stats-container {
        gap: 3px;
        padding: 0 6px;
        margin: 10px 0 15px;
      }
      
      .global-stat {
        min-width: 72px;
        max-width: 76px;
        padding: 8px 6px;
        gap: 4px;
      }
      
      .tesla-header {
        padding: 0 8px 6px;
        padding-top: clamp(6px, env(safe-area-inset-top, 8px), 16px);
      }
    }

    /* Ultra-wide screens */
    @media (min-width: 1400px) {
      .main-content {
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
      }
      
      .global-stats-container {
        max-width: 800px;
        gap: 24px;
      }
      
      .global-stat {
        max-width: 200px;
        min-height: 52px;
        padding: 16px 20px;
      }
    }

    /* Tesla-grade landscape orientation optimizations */
    @media (orientation: landscape) and (max-height: 500px) {
      .tesla-header {
        height: clamp(40px, calc(50px + env(safe-area-inset-top, 0px)), 70px);
        min-height: calc(40px + env(safe-area-inset-top, 5px));
        padding-bottom: 6px;
      }
      
      .main-content {
        margin-top: calc(60px + env(safe-area-inset-top));
        padding: 10px clamp(12px, 4vw, 24px) 80px;
      }
      
      .hi-medallion-section {
        min-height: 180px;
        margin: 10px 0 20px;
        padding: 10px;
      }
      
      .global-stats-container {
        margin: 10px 0 15px;
        gap: clamp(6px, 2vw, 16px);
      }
    }

    /* Large screen optimizations */
    @media (min-width: 768px) {
      .main-content {
        padding: 40px 20px 120px;
      }
      
      .hi-medal-simplified {
        width: min(240px, 35vw);
      }
      
      /* Enhanced stats for larger screens */
      .global-stats-container {
        gap: clamp(12px, 2vw, 20px);
        max-width: 600px;
      }
      
      .global-stat {
        max-width: clamp(120px, 20vw, 180px);
        min-height: 48px;
        padding: 12px 16px;
      }
    }

    /* Navigation Modal */
    .navigation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .navigation-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .navigation-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .navigation-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(400px, 90vw);
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 24px;
      padding: 24px;
      color: white;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .navigation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .navigation-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #FFD166;
    }

    .close-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-nav-btn:hover {
      background: rgba(255, 0, 0, 0.2);
    }

    .navigation-menu {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .nav-section-title {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      text-decoration: none;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .nav-item.admin-item {
      background: rgba(255, 215, 0, 0.1);
      border-color: rgba(255, 215, 0, 0.2);
    }

    .nav-item.admin-item:hover {
      background: rgba(255, 215, 0, 0.2);
    }

    .nav-icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    /* Enhanced Weekly Progress Strip */
    .weekstrip {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 20px 0 30px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .weekdot {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 45px;
      transition: all 0.3s ease;
    }
    
    .weekdot:hover {
      transform: translateY(-2px);
    }
    
    .weekdot .lbl {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .weekdot .c {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 13px;
      font-weight: 600;
      border: 2px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.6);
      transition: all 0.3s ease;
    }
    
    .weekdot .c.met {
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
    }
    
    .weekdot .c.today {
      border-color: #FFD166;
      box-shadow: 0 0 0 2px rgba(255, 209, 102, 0.3);
    }

    /* üéñÔ∏è Evolution Enhancement: Milestone indicators */
    .weekdot.milestone {
      position: relative;
    }
    
    .weekdot .milestone-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, #FF6B6B, #FFD93D);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      animation: milestoneGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes milestoneGlow {
      0% { box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3); }
      100% { box-shadow: 0 4px 12px rgba(255, 217, 61, 0.5); }
    }

    /* üî• Hi Experience Layer Styles */
    #hiExperienceLayer {
      margin: 2rem 0;
    }

    .hi-experience-section {
      margin-bottom: 2rem;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
      overflow: hidden;
    }

    /* Responsive adjustments for experience layer */
    @media (max-width: 768px) {
      .hi-experience-section {
        margin: 1rem 0.5rem;
        border-radius: 0.75rem;
      }
    }

    /* Floating Refresh Button - Tesla Grade Positioning */
    .floating-refresh {
      position: fixed;
      bottom: 90px; /* Moved above footer */
      right: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #FFD166 0%, #F4A261 100%);
      border: none;
      border-radius: 50%;
      color: #1E2A4A;
      font-size: 20px;
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(255, 209, 102, 0.3);
    }

    .floating-refresh:hover {
      transform: translateY(-2px) rotate(90deg);
      box-shadow: 0 6px 20px rgba(255, 209, 102, 0.4);
    }

    .floating-refresh:active {
      transform: translateY(0) rotate(180deg);
    }

    /* Floating Hiffirmations System - Tesla Grade Positioning */
    .floating-hiffirmations {
      position: fixed;
      bottom: 90px; /* Moved above footer */
      left: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #E91E63 0%, #9C27B0 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      z-index: 999;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(233, 30, 99, 0.3);
      animation: gentlePulse 4s infinite;
    }

    .floating-hiffirmations:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 20px rgba(233, 30, 99, 0.4);
      animation-play-state: paused;
    }

    .floating-hiffirmations:active {
      transform: translateY(0) scale(0.95);
    }

    @keyframes gentlePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    /* Hiffirmation Popup */
    .hiffirmation-popup {
      position: fixed;
      bottom: 85px;
      left: 20px;
      max-width: 280px;
      background: rgba(26, 32, 56, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 16px 20px;
      color: white;
      font-size: 14px;
      line-height: 1.4;
      transform: translateY(20px) scale(0.9);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 1000;
      pointer-events: none;
    }

    .hiffirmation-popup.show {
      transform: translateY(0) scale(1);
      opacity: 1;
      pointer-events: auto;
    }

    .hiffirmation-popup::before {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 28px;
      width: 16px;
      height: 16px;
      background: rgba(26, 32, 56, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-top: none;
      border-left: none;
      transform: rotate(45deg);
      border-radius: 0 0 4px 0;
    }

    /* Floating Hiffirmation Share Button */
    .hiffirmation-share-mini {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      opacity: 0;
      pointer-events: none;
    }

    .hiffirmation-popup:hover .hiffirmation-share-mini,
    .hiffirmation-popup.show .hiffirmation-share-mini {
      opacity: 1;
      pointer-events: auto;
    }

    .hiffirmation-share-mini:hover {
      background: rgba(255, 209, 102, 0.2);
      border-color: rgba(255, 209, 102, 0.4);
      color: #FFD166;
      transform: scale(1.1);
    }
  </style>
</head>

<body data-page="hi-dashboard">
  <!-- Tesla-Grade Header - Centered Brand Prominence -->
  <header class="tesla-header">
    <!-- Smart Calendar & Home Access -->
    <div class="header-left">
      <button id="btnCal" class="calendar-btn" aria-label="Open calendar" title="View Hi Calendar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="3" ry="3"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      </button>
      
      <button id="btnHome" class="home-nav-btn" aria-label="Go to Hi Today" title="Navigate to Hi Today">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9,22 9,12 15,12 15,22"/>
        </svg>
      </button>
    </div>
    
    <!-- Centered Brand with Maximum Prominence -->
    <div class="header-center">
      <div class="brand-container">
        <img src="assets/brand/hi-logo-light.png" alt="Hi" class="brand-hi-logo" />
        <span class="brand-text">Stay Hi</span>
      </div>
    </div>
    
    <!-- Navigation & Smart Hiffirmation Access -->
    <div class="header-right">
      <!-- Contextual Hiffirmations Access -->
      <button id="hiffirmationsTrigger" class="hiffirmations-smart-pill" aria-label="Daily Hiffirmations" title="Daily Hiffirmations">
        <span class="pill-icon">‚ú®</span>
      </button>
      
      <!-- Membership Tier Indicator (UX-first implementation) -->
      <div id="hi-tier-indicator" class="tier-indicator" title="Your membership tier">
        <span class="tier-text">Anonymous</span>
      </div>
      
      <button id="btnMenu" class="menu-btn" aria-label="Open menu" title="Navigation Menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </header>

  <!-- Tesla-Grade Floating HiFirmation Button -->
  <button class="floating-hiffirmations" id="floatingHiffirmations" aria-label="Daily HiFirmations" title="Get inspired with daily HiFirmations">
    ‚ú®
  </button>

  <!-- S-DASH Flag-Gated DOM Anchors (Hidden Placeholders) -->
  <script>
    (async function initSDashAnchors() {
      try {
        // Wait for HiFlags to be available
        if (window.HiFlags) {
          const flags = await Promise.all([
            window.HiFlags.getFlag('hi_dash_v3', false),
            window.HiFlags.getFlag('hi_dash_stats_row_v1', false),
            window.HiFlags.getFlag('hi_dash_medallion_cta_v1', false),
            window.HiFlags.getFlag('hi_dash_share_cta_v1', false),
            window.HiFlags.getFlag('hi_dash_global_pill_v1', false)
          ]);
          
          const [dashV3, statsRow, medallionCta, shareCta, globalPill] = flags;
          
          // Only add anchors if hi_dash_v3 is enabled
          if (dashV3) {
            const container = document.createElement('div');
            container.id = 'sDashAnchors';
            container.style.display = 'none'; // Hidden placeholders
            
            let html = '';
            
            // Add statsRow and its children if flag enabled (S-DASH/7: personal first + global pill)
            if (statsRow) {
              html += '<div id="statsRow">';
              html += '<div id="statTotal"></div>';
              html += '<div id="stat7d"></div>';
              html += '<div id="statStreak"></div>';
              // S-DASH/7: global pill anchor (text populated by S-DASH/3)
              if (globalPill) {
                html += '<div id="globalPill" class="hi-global-pill" aria-live="polite"></div>';
              }
              html += '</div>';
            }
            
            // Add medallion anchor if flag enabled (S-DASH/7: now a proper button in main DOM)
            if (medallionCta) {
              html += '<div id="hiMedallion"></div>';
            }
            
            // Add share button anchor if flag enabled
            if (shareCta) {
              html += '<button id="giveHiBtn"></button>';
            }
            
            // S-DASH/7: global pill moved into stats row above
            
            container.innerHTML = html;
            document.body.appendChild(container);
            
            console.log('[S-DASH] Flag-gated anchors added:', { dashV3, statsRow, medallionCta, shareCta, globalPill });
          }
        }
      } catch (error) {
        console.warn('[S-DASH] Flag anchor setup failed:', error);
      }
    })();
  </script>

  <!-- Main Content -->
  <main class="main-content">
    
    <!-- S-DASH DOM Anchors (Required for Production Parity) -->
    <div id="statsRow" style="display: none;">
      <div id="statTotal"></div>
      <div id="stat7d"></div>
      <div id="statStreak"></div>
    </div>
    <div id="giveHiBtn" style="display: none;"></div>
    <div id="globalPill" class="hi-global-pill" style="display: none;" aria-live="polite"></div>
    
    <!-- Weekly Progress Strip (Context First) -->
    <div id="weekStrip" class="weekstrip" aria-label="Your week"></div>
    
    <!-- Global Stats Above Medallion (Your Favorite Combo!) -->
    <div class="global-stats-container">
      <div class="global-stat">
        <span class="stat-icon">üëã</span>
        <div class="stat-content">
          <span class="stat-number" id="globalHiWaves">...</span>
          <span class="stat-label">Hi Waves</span>
        </div>
      </div>
      <div class="global-stat">
        <span class="stat-icon">üî•</span>
        <div class="stat-content">
          <span class="stat-number" id="globalTotalHis">...</span>
          <span class="stat-label">Total His</span>
        </div>
      </div>
      <div class="global-stat">
        <span class="stat-icon">üë•</span>
        <div class="stat-content">
          <span class="stat-number" id="globalUsers">...</span>
          <span class="stat-label">Users</span>
        </div>
      </div>
      <div class="global-stat">
        <span class="stat-icon">‚ö°</span>
        <div class="stat-content">
          <span class="stat-number" id="userStreak">0</span>
          <span class="stat-label">Streak</span>
        </div>
      </div>
      <!-- HiMetrics Debug Badge (Development Only) -->
      <div class="global-stat" id="hiMetricsDebugDash" style="display: none !important; opacity: 0.7; font-size: 0.8rem;">
        <span class="stat-icon">üîß</span>
        <div class="stat-content">
          <span class="stat-number" id="dashMetricsStatus">init</span>
          <span class="stat-label" id="dashCacheAge">Cache: 0s</span>
        </div>
      </div>
    </div>
    
    <!-- HI DEV: Tesla-Grade HiMedallion Component -->
    <div id="hiMedallionContainer" class="hi-medallion-section">
      <!-- S-DASH/7: hero medallion -->
      <div id="hiMedallion"
           class="hi-medallion"
           role="button"
           tabindex="0"
           aria-label="Celebrate your extraordinary progress"
           aria-pressed="false"
           title="Celebrate your extraordinary progress">
        <div class="hi-medallion__base"></div>
        <div class="hi-medallion__edge"></div>
        <div class="hi-medallion__halo"></div>
        <!-- Your actual Hi logo -->
        <img src="./assets/brand/hi-logo-light.png" alt="Hi logo" class="hi-medallion__icon">
      </div>
      <!-- /S-DASH/7 -->
    </div>
    
    <!-- S-DASH/8: ARIA live region for micro-feedback -->
    <div id="hiLive" class="sr-only" aria-live="polite"></div>

    <!-- üî• NEW: Hi Experience Layer Components (Feature Flagged) -->
    <div id="hiExperienceLayer" style="display: none;">
      <!-- HiFeed Component Container -->
      <div id="hiFeedContainer" class="hi-experience-section"></div>
      
      <!-- HiStreaks Component Container -->
      <div id="hiStreaksContainer" class="hi-experience-section"></div>
    </div>



  </main>

  <!-- Floating Hi 5 Button - DISABLED: Using medallion long-press system
  <button class="floating-hi5-universal" id="selfHi5Enhanced">
    üëã Hi 5
  </button>
  END DISABLED FLOATING BUTTON -->
  <button class="floating-hi5-universal" id="selfHi5Enhanced">
    ‚ú® Celebrate This Moment
  </button>

  <!-- Navigation Menu Modal -->
  <div id="navigationModal" class="navigation-modal" style="display: none;">
    <div class="navigation-backdrop" id="navigationBackdrop"></div>
    <div class="navigation-content">
      <div class="navigation-header">
        <h3>Stay Hi Navigation</h3>
        <button id="closeNavigation" class="close-nav-btn">‚úï</button>
      </div>
      <div class="navigation-menu">
        <div class="nav-section">
          <div class="nav-section-title">Navigate</div>
          <a href="index.html" class="nav-item">
            <span class="nav-icon">üè†</span>
            <span>Hi Today</span>
          </a>
          <a href="hi-island-NEW.html" class="nav-item">
            <span class="nav-icon">üèùÔ∏è</span>
            <span>Hi Island</span>
          </a>
          <a href="hi-muscle.html" class="nav-item">
            <span class="nav-icon">üí™</span>
            <span>Hi Gym</span>
          </a>
          <a href="profile.html?from=hi-dashboard.html" class="nav-item">
            <span class="nav-icon">üë§</span>
            <span>Profile</span>
          </a>
        </div>
        <div class="nav-section" id="adminSection" style="display: none;">
          <div class="nav-section-title">Admin</div>
          <a href="hi-mission-control.html" class="nav-item admin-item">
            <span class="nav-icon">üéõÔ∏è</span>
            <span>Hi Mission Control</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tesla-Grade Simplified JavaScript
    // HI-OS: Stats variables now managed by initHiStatsOnce() system
    // Global variables declared in the init guard module above
    let clickAnimationFrame = null;

    // DOM Elements
    // const selfHi5Enhanced = document.getElementById('selfHi5Enhanced'); // DEPRECATED: Using medallion system
    const hiffirmationsTrigger = document.getElementById('hiffirmationsTrigger');

    // Header stats elements
    const headerHiWaves = document.getElementById('headerHiWaves');
    const headerTotalHis = document.getElementById('headerTotalHis');
    const headerUsers = document.getElementById('headerUsers');

    // Tesla-Grade Database Integration
    async function initializeDatabase() {
      try {
        if (typeof supabase !== 'undefined') {
          console.log('üéØ SURGICAL: Initializing Supabase client for hostname:', window.location.hostname);
          const { createClient } = supabase;
          const supabaseClient = createClient(
            'https://gfcubvroxgfvjhacinic.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmY3VidnJveGdmdmpoYWNpbmljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MTIyNjYsImV4cCI6MjA3NDQ4ODI2Nn0.5IlxofMPFNdKsEueM_dhgsJP9wI-GnZRUM9hfR0zE1g'
          );
          
          // Set both variable names for compatibility
          window.db = supabaseClient;
          window.supabase = supabaseClient;
          
          // HI-OS: Database connection established, stats handled by init guard
          console.log('‚úÖ Database connection ready for stats system');
        }
      } catch (error) {
        console.error('‚ùå Database connection failed:', error);
      }
      
      // HI-OS: Stats loading now handled by initHiStatsOnce() guard system
      // No direct function calls here to prevent duplicates
      console.log('üìä Dashboard init complete - stats handled by initHiStatsOnce()');
    }

    // HI-OS: Legacy loadMetricsFromHiBase function - REMOVED
    // This has been replaced by the unified stats init guard system
    // All stats loading now happens via initHiStatsOnce() to prevent duplicates

    // üöÄ INTEGRATION #5: Load user streak via HiBase (flagged rollout)
    async function loadUserStreak() {
      try {
        const useHiBaseStreaks = await window.HiFlags?.getFlag('hibase_streaks_enabled');
        console.log(`üîÑ Streak loading via ${useHiBaseStreaks ? 'HiBase' : 'legacy'} path`);

        if (useHiBaseStreaks) {
          // üéØ HiBase path: unified streak API
          console.log('üì¶ Streak ‚Üí HiBase.getUserStreak...');
          const currentUser = window.hiAuth?.getCurrentUser?.() || { id: 'anonymous' };
          
          if (currentUser.id && currentUser.id !== 'anonymous') {
            const streakResult = await window.HiBase.getUserStreak(currentUser.id);

            if (streakResult.error) {
              console.warn('‚ö†Ô∏è HiBase streak loading failed:', streakResult.error);
              updateStreakDisplay(0);
            } else {
              const currentStreak = streakResult.data.streak?.current || 0;
              console.log('‚úÖ Streak loaded via HiBase:', currentStreak);
              updateStreakDisplay(currentStreak);
            }
          } else {
            // üéØ TESLA GRADE: Hide streak UI for anonymous users (gold standard UX)
            console.log('üîí Anonymous user - hiding streak UI');
            hideStreakUI();
          }

          // üìä Track HiBase streak usage
          import('./lib/monitoring/HiMonitor.js').then(m => 
            m.trackEvent('streak_load', { 
              source: 'dashboard', 
              path: 'hibase'
            })
          ).catch(() => {});

        } else {
          // üîÑ Legacy path: load from localStorage or other system
          console.log('üì¶ Streak ‚Üí Legacy loading...');
          
          const currentUser = window.hiAuth?.getCurrentUser?.() || { id: 'anonymous' };
          
          if (currentUser.id && currentUser.id !== 'anonymous') {
            // Authenticated user - show streak
            const localStreak = localStorage.getItem('user_current_streak') || '0';
            updateStreakDisplay(parseInt(localStreak, 10));
          } else {
            // üéØ TESLA GRADE: Hide streak UI for anonymous users (gold standard UX)
            console.log('üîí Anonymous user - hiding streak UI (legacy path)');
            hideStreakUI();
          }
          
          // üìä Track legacy streak usage
          import('./lib/monitoring/HiMonitor.js').then(m => 
            m.trackEvent('streak_load', { 
              source: 'dashboard', 
              path: 'legacy'
            })
          ).catch(() => {});
        }

      } catch (error) {
        console.warn('‚ö†Ô∏è Streak loading failed:', error);
        updateStreakDisplay(0);
      }
    }

    // Update streak display in UI
    function updateStreakDisplay(streak) {
      const streakElement = document.getElementById('userStreak');
      if (streakElement) {
        streakElement.textContent = streak;
        
        // Add visual effects for high streaks
        if (streak >= 7) {
          streakElement.style.background = 'linear-gradient(45deg, #ff6b6b, #ffd93d)';
          streakElement.style.webkitBackgroundClip = 'text';
          streakElement.style.webkitTextFillColor = 'transparent';
        } else if (streak >= 3) {
          streakElement.style.color = '#ffd93d';
        } else {
          streakElement.style.color = '';
          streakElement.style.background = '';
          streakElement.style.webkitBackgroundClip = '';
          streakElement.style.webkitTextFillColor = '';
        }
      }
    }

    // üéØ TESLA GRADE: Hide streak UI for anonymous users (gold standard UX)
    function hideStreakUI() {
      // Hide individual streak stat
      const streakStat = document.querySelector('.user-stat:has(#userStreak)');
      if (streakStat) {
        streakStat.style.display = 'none';
        console.log('‚úÖ Streak stat hidden for anonymous user');
      }
      
      // Hide HiStreaks component container
      const streaksContainer = document.getElementById('hiStreaksContainer');
      if (streaksContainer) {
        streaksContainer.style.display = 'none';
        console.log('‚úÖ HiStreaks container hidden for anonymous user');
      }
      
      // Hide any other streak-related elements
      const streakElements = document.querySelectorAll('[id*="streak"], [class*="streak"]');
      streakElements.forEach(el => {
        // Only hide if it's specifically about user streaks, not global streaks
        if (el.id !== 'globalStreak' && !el.classList.contains('global-streak')) {
          el.style.display = 'none';
        }
      });
    }

    // Show error state for consistency
    function showStatsError() {
      const elements = ['globalHiWaves', 'globalTotalHis', 'globalUsers'];
      elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = 'Error';
          element.style.color = '#ff6b6b';
        }
      });
    }

    // üéØ SURGICAL: Anti-lag stats display with instant placeholders
    function updateGlobalStats() {
      const globalHiWaves = document.getElementById('globalHiWaves');
      const globalTotalHis = document.getElementById('globalTotalHis');
      const globalUsers = document.getElementById('globalUsers');
      
      // üöÄ TESLA GRADE: Smooth loading states without jarring jumps
      if (globalHiWaves) {
        if (window.gWaves !== null && window.gWaves !== undefined) {
          const formattedWaves = window.gWaves.toLocaleString();
          if (globalHiWaves.textContent !== formattedWaves) {
            globalHiWaves.textContent = formattedWaves;
          }
        } else {
          // Show elegant loading state for null/undefined values
          const currentText = globalHiWaves.textContent || globalHiWaves.innerText || '';
          if (!currentText.includes('...') && !currentText.includes('shimmer')) {
            globalHiWaves.innerHTML = '<span class="loading-shimmer">...</span>';
          }
        }
      }
      
      if (globalTotalHis) {
        if (window.gTotalHis !== null && window.gTotalHis !== undefined) {
          globalTotalHis.textContent = window.gTotalHis.toLocaleString();
        } else if (globalTotalHis.textContent === '...' || globalTotalHis.textContent === '') {
          globalTotalHis.textContent = '...';
        }
      }
      
      if (globalUsers) {
        if (window.gUsers !== null && window.gUsers !== undefined) {
          globalUsers.textContent = window.gUsers.toLocaleString();
        } else if (globalUsers.textContent === '...' || globalUsers.textContent === '') {
          globalUsers.textContent = '...';
        }
      }
    }

    // üõ°Ô∏è PROTECT: Dashboard's updateGlobalStats from being overridden by other systems
    const dashboardUpdateGlobalStats = updateGlobalStats;
    window.updateGlobalStats = dashboardUpdateGlobalStats;
    
    // Lock the function to prevent overwrites
    Object.defineProperty(window, 'updateGlobalStats', {
      value: dashboardUpdateGlobalStats,
      writable: false,
      configurable: false
    });
    
    console.log('üõ°Ô∏è Dashboard updateGlobalStats protected from override');

    // METRICS SEPARATION: Hi Wave Increment (medallion taps ‚Üí hi_events table only)
    async function incrementHiWave() {
      try {
        // Check if metrics separation is enabled via feature flag
        const useMetricsSeparation = await window.HiFlags?.getFlag('metrics_separation_enabled', true);
        
        if (!useMetricsSeparation) {
          console.log('üéØ Metrics separation disabled, using legacy medallion tracking...');
          // Fallback to legacy system (preserved for rollback)
          if (window.HiUnifiedStats?.trackMedallionTap) {
            return await window.HiUnifiedStats.trackMedallionTap();
          }
          return;
        }
        
        console.log('üéØ METRICS SEPARATION: Medallion tapped on hi-dashboard');
        
        // Use basic medallion tap tracking (Database deployment required)
        if (window.HiBase?.stats?.insertMedallionTap) {
          console.log('üéØ Using Hi Medallion tap tracking...');
          
          // Get current user (null for anonymous)
          const user = window.HiBase?.auth?.getCurrentUser();
          const userId = user?.data?.id || null;
          
          const result = await window.HiBase.stats.insertMedallionTap(userId);
          
          if (result.error) {
            console.error('‚ùå Medallion tap failed:', result.error);
            return;
          }
          
          console.log('‚úÖ HI MEDALLION TAP SUCCESS:', {
            newWaveCount: result.data,
            isAuthenticated: !!userId
          });
          
          // üåä TESLA GRADE: Force immediate Hi Waves refresh for real-time accuracy
          if (window.hiWavesRealtime) {
            await window.hiWavesRealtime.forceRefresh();
          }
          
          // Refresh dashboard metrics to show updated global waves
          setTimeout(() => initHiStatsOnce('medallion-tap-refresh'), 100);
          
        } else {
          console.error('‚ùå METRICS SEPARATION ERROR: HiBase.stats not available');
        }
      } catch (error) {
        console.error('üí• METRICS SEPARATION FAILURE: Medallion tap failed:', error);
      }
    }



    // HI DEV: Hi5 Counter (separate from HiWave medallion taps)
    async function incrementHi5Counter() {
      try {
        // Update Hi5 counter in localStorage and database
        const currentCount = parseInt(localStorage.getItem('hi5_count') || '0');
        const newCount = currentCount + 1;
        localStorage.setItem('hi5_count', newCount.toString());
        
        // Update database if available
        if (window.hiDB?.updateUserStats) {
          await window.hiDB.updateUserStats('hi5_count', newCount);
        }
        
        console.log('[HI DEV] Hi5 counter incremented to:', newCount);
        
        // Update UI display if element exists
        const hi5CountElement = document.querySelector('.hi5-count');
        if (hi5CountElement) {
          hi5CountElement.textContent = newCount;
        }
        
      } catch (error) {
        console.error('[HI DEV] Failed to increment Hi5 counter:', error);
      }
    }

    // üèóÔ∏è HI OS GOLD STANDARD: Self Hi5 Handler DEPRECATED 
    // Replaced by medallion long-press system for unified UX
    function setupSelfHi5Handler_DEPRECATED() {
      // DEPRECATED: This function is no longer used
      // All Hi 5 functionality moved to medallion long-press
      return;
      
      // HI DEV: Dedupe handlers - only bind once
      if (selfHi5Enhanced.__hi5HandlerBound) {
        console.log('[HI DEV] Hi5 handler already bound, skipping duplicate');
        return;
      }
      selfHi5Enhanced.__hi5HandlerBound = true;

      selfHi5Enhanced.addEventListener('click', async (e) => {
        e.preventDefault();
        
        try { 
          navigator?.vibrate?.(50); 
        } catch {}

        // Visual feedback
        selfHi5Enhanced.style.transform = 'scale(0.95)';
        setTimeout(() => {
          selfHi5Enhanced.style.transform = '';
        }, 150);

        // üîí ANONYMOUS ACCESS CONTROL: Check if user can share
        const canShare = window.hiAccessManager?.canAccess?.('shareCreation') || 
                        window.HiTierSystem?.hasCapability?.('drop_hi') ||
                        window.unifiedMembership?.hasAccess?.('shareCreation');
                        
        if (!canShare) {
          console.log('üîí Anonymous users cannot create shares - showing gold standard auth modal');
          
          // üåü WOZNIAK-GRADE: Use Hi Island-style beautiful auth modal
          if (window.showShareAuthModal) {
            window.showShareAuthModal('hi-dashboard', {
              title: 'Join Hi Dashboard Community',
              benefits: [
                'üìä Track your personal Hi streaks and stats',
                'üéØ Share Hi5 moments with the community', 
                'üèÜ Unlock dashboard achievements and rewards',
                'üí´ Access advanced Hi tracking features'
              ],
              onPrimary: () => {
                // Store context for after auth
                localStorage.setItem('pendingDashboardAction', JSON.stringify({
                  action: 'hi5-share',
                  context: 'dashboard',
                  timestamp: Date.now()
                }));
                window.location.href = '/signin.html?redirect=' + encodeURIComponent(window.location.pathname) + '&action=hi5';
              },
              onSecondary: () => {
                localStorage.setItem('pendingDashboardAction', JSON.stringify({
                  action: 'hi5-share', 
                  context: 'dashboard',
                  timestamp: Date.now()
                }));
                window.location.href = '/signup.html?redirect=' + encodeURIComponent(window.location.pathname) + '&action=hi5';
              }
            });
          } else if (window.showAuthModal) {
            // Fallback to general auth modal
            window.showAuthModal('hi-dashboard');
          } else if (window.showHiUpgradeModal) {
            // Legacy fallback
            window.showHiUpgradeModal('share_creation', {
              message: 'Sign in to share your Hi5 moments with the community! ‚ú®',
              feature: 'Hi5 Sharing'
            });
          } else {
            // Last resort fallback
            console.warn('‚ö†Ô∏è No auth modals available, redirecting to auth');
            window.location.href = '/signin.html?action=hi5';
          }
          return;
        }

        // üéØ TESLA GRADE: Use unified HiShareSheet instance (preventing duplicate shares)
        try {
          // Get the globally initialized HiShareSheet instance
          const shareSheetInstance = window.__hiComponentsInitialized?.shareSheetInstance;
          
          if (!shareSheetInstance) {
            console.warn('‚ö†Ô∏è HiShareSheet not yet initialized, waiting for unified initialization...');
            // Wait briefly for unified initialization
            setTimeout(() => {
              const retryInstance = window.__hiComponentsInitialized?.shareSheetInstance;
              if (retryInstance) {
                retryInstance.open({
                  context: 'dashboard',
                  preset: 'hi5',
                  prefilledText: '‚ú® Celebrating this moment of growth! ',
                  type: 'Hi5'
                });
              }
            }, 100);
            return;
          }
          
          // Open with Hi5 context (success handler configured in unified initialization)
          shareSheetInstance.open({
            context: 'dashboard',
            preset: 'hi5',
            prefilledText: '‚ú® Celebrating this moment of growth! ',
            type: 'Hi5'
          });
          
        } catch (error) {
          console.error('[HI DEV] Failed to open HiShareSheet for Hi5:', error);
          // HI DEV: NO fallback to HiWave - Hi5 and HiWave are separate flows
          // Show error message to user instead
          const errorMsg = document.createElement('div');
          errorMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#ff4444;color:white;padding:12px;border-radius:8px;z-index:9999;';
          errorMsg.textContent = 'Hi5 Share Sheet failed to load. Please try again.';
          document.body.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 3000);
        }
        
        // HI DEV: All Hi5 submission logic moved to HiShareSheet.persist()
        // This keeps the flow clean and maintains separation of concerns
      });
    }

    // Navigation Menu Handler
    function setupNavigationHandler() {
      const btnMenu = document.getElementById('btnMenu');
      const navigationModal = document.getElementById('navigationModal');
      const navigationBackdrop = document.getElementById('navigationBackdrop');
      const closeNavigation = document.getElementById('closeNavigation');

      if (!btnMenu || !navigationModal) return;

      const openNavigation = () => {
        navigationModal.classList.add('show');
        navigationModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Show admin section if user is admin (basic check)
        const adminSection = document.getElementById('adminSection');
        if (adminSection && (localStorage.getItem('isAdmin') === 'true' || window.location.href.includes('admin'))) {
          adminSection.style.display = 'block';
        }
      };

      const closeNavigationModal = () => {
        navigationModal.classList.remove('show');
        document.body.style.overflow = '';
        setTimeout(() => {
          if (!navigationModal.classList.contains('show')) {
            navigationModal.style.display = 'none';
          }
        }, 300);
      };

      btnMenu.addEventListener('click', openNavigation);
      closeNavigation.addEventListener('click', closeNavigationModal);
      navigationBackdrop.addEventListener('click', closeNavigationModal);
      
      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && navigationModal.classList.contains('show')) {
          closeNavigationModal();
        }
      });
    }

    // Hiffirmations Modal Handler
    function setupHiffirmationsHandler() {
      if (!hiffirmationsTrigger) return;

      hiffirmationsTrigger.addEventListener('click', (e) => {
        e.preventDefault();
        showHiffirmationsModal();
      });
    }

    // Floating HiFirmations Handler 
    function setupFloatingHiffirmationsHandler() {
      const floatingBtn = document.getElementById('floatingHiffirmations');
      if (!floatingBtn) return;

      floatingBtn.addEventListener('click', (e) => {
        e.preventDefault();
        showHiffirmationsModal();
        
        // Tesla-grade haptic feedback
        if (window.PremiumUX) {
          window.PremiumUX.triggerHapticFeedback('medium');
        }
      });
    }

    // Tesla-Grade Daily Hiffirmation Generator (Consistent Daily Messages)
    function getDailyHiffirmation(date = new Date()) {
      const key = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
      let hash = 0;
      for (let i = 0; i < key.length; i++) {
        hash = (hash * 31 + key.charCodeAt(i)) | 0;
      }
      
      const hiffirmations = [
        "‚ú® Stay Hi! You're on a Hi level of positive energy today",
        "üåü Your Hi vibes are lifting others to new Hi-ghts of joy", 
        "üí´ Hi there! You have the power to get someone Hi on life today",
        "üî• Hi amazing soul! Your authentic self is Hi-ly inspiring",
        "üåà Every Hi you share lifts our world to Hi-er dimensions",
        "‚≠ê Hi friend! You're exactly Hi enough, right Hi and now",
        "üíù Hi incredible human! Your presence gets everyone Hi on good vibes",
        "üå∫ Hi warrior! You're reaching Hi-er levels with each Hi moment",
        "üéØ Hi there! Trust your journey, you're flying Hi and amazing",
        "üíé Hi shining star! Your Hi energy can never be brought low",
        "üöÄ Hi unstoppable force! Your potential reaches the Hi-est peaks",
        "üå∏ Hi beautiful! You bring Hi-quality beauty to every moment",
        "‚ö° Hi energy! Your Hi frequency lights up every space you enter",
        "üèîÔ∏è Hi mountain mover! You're Hi above any challenge life brings",
        "üé® Hi creative soul! Your imagination paints the world in Hi definition",
        "üåä Hi flowing river! You ride Hi through all of life's changes",
        "üîÆ Hi intuitive being! Your inner wisdom operates on the Hi-est level",
        "ü¶ã Hi transformer! You're evolving into your Hi-est, most amazing self",
        "üåÖ Hi sunrise! Each day brings Hi-level opportunities just for you",
        "üí™ Hi resilient heart! Your bounce-back ability is Hi-ly remarkable",
        "üéµ Hi melody maker! Your soul sings in Hi-fi, beautiful frequencies",
        "üåü Hi beacon! You're a Hi-rise lighthouse of hope for others",
        "üïäÔ∏è Hi peaceful spirit! Serenity follows you to Hi-er ground",
        "üî• Hi passionate heart! Your fire lifts everyone to Hi-er ground",
        "üåª Hi sunflower! You're always growing toward the Hi-est light",
        "‚≠ê Hi dreamer! Your visions reach Hi into the realm of possibility",
        "üéØ Hi aligned soul! You're connected to your Hi-est purpose",
        "üí´ Hi magical being! Hi-level magic happens when you believe",
        "üåà Hi reality creator! You're painting Hi-definition beauty everywhere",
        "ü¶Ñ Hi unique spirit! Your one-of-a-kind nature is Hi-ly special"
      ];
      
      const selectedMessage = hiffirmations[Math.abs(hash % hiffirmations.length)];
      
      // Check if this is the daily HiFirmation or a Hi Boost
      const lastHiffirmationDate = localStorage.getItem('lastHiffirmationDate');
      const today = new Date().toDateString();
      const isDaily = lastHiffirmationDate !== today;
      
      if (isDaily) {
        localStorage.setItem('lastHiffirmationDate', today);
        return selectedMessage; // Full daily message
      } else {
        // Hi Boost - shorter, Hi Speak encouraging messages
        const hiBoosts = [
          "Stay Hi! Keep that Hi energy shining! ‚ú®",
          "Hi beautiful! You've got that Hi-level magic! üí™",
          "Hi amazing! Keep riding Hi! üöÄ",
          "Hi superstar! Stay on that Hi frequency! üåü",
          "Hi warrior! You're Hi above it all! ‚ö°",
          "Hi champion! Keep your Hi-ness flowing! üèÜ",
          "Hi brilliant! Trust your Hi intuition! üåà",
          "Hi phenomenal! You're Hi-ly valued! üíù",
          "Hi incredible! Keep flying Hi! ü¶Ö",
          "Hi wonderful! Stay Hi always! üåª"
        ];
        return hiBoosts[Math.floor(Math.random() * hiBoosts.length)];
      }
    }

    // Get countdown to next Hiffirmation (midnight local time)
    function getNextHiffirmationCountdown() {
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(0, 0, 0, 0);
      
      const timeLeft = tomorrow - now;
      const hours = Math.floor(timeLeft / (1000 * 60 * 60));
      const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
      
      return { hours, minutes, timeLeft };
    }

    // Premium Hiffirmations Modal
    function showHiffirmationsModal(customDate = null) {
      const targetDate = customDate || new Date();
      const dailyHiffirmation = getDailyHiffirmation(targetDate);
      const countdown = getNextHiffirmationCountdown();
      
      // Date display for non-today dates
      const isToday = !customDate || (
        targetDate.toDateString() === new Date().toDateString()
      );
      const dateLabel = isToday ? 'Today' : targetDate.toLocaleDateString('en-US', { 
        weekday: 'long', 
        month: 'short', 
        day: 'numeric' 
      });

      // Create modal with premium styling
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 15000;
        display: flex; align-items: center; justify-content: center;
        background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);
      `;
      
      modal.innerHTML = `
        <div style="
          background: rgba(15, 16, 34, 0.95); backdrop-filter: blur(25px);
          border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 24px;
          padding: 32px; max-width: 400px; width: 90vw; text-align: center; color: white;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); position: relative;
        ">
          <h3 style="margin: 0 0 8px; color: #FFD166; font-size: 24px;">‚ú® ${(() => {
            const lastDate = localStorage.getItem('lastHiffirmationDate');
            const todayString = new Date().toDateString();
            const isDailyHi = !customDate && (lastDate !== todayString);
            if (!isToday) return dateLabel + ' Hiffirmation';
            return isDailyHi ? 'Daily Hiffirmation' : 'Hi Boost';
          })()}</h3>
          
          <!-- Countdown Timer (only for daily) -->
          ${isToday && localStorage.getItem('lastHiffirmationDate') !== new Date().toDateString() ? `
          <div style="
            font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 20px;
            padding: 8px 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
          ">
            Next Daily Hiffirmation in ${countdown.hours}h ${countdown.minutes}m
          </div>
          ` : isToday ? `
          <div style="
            font-size: 12px; color: rgba(233, 30, 99, 0.8); margin-bottom: 20px;
            padding: 8px 12px; background: rgba(233, 30, 99, 0.1); border-radius: 8px;
            border: 1px solid rgba(233, 30, 99, 0.2);
          ">
            üöÄ Unlimited Hi Boosts available!
          </div>
          ` : ''}
          
          <!-- Daily Message -->
          <div style="font-size: 18px; line-height: 1.5; margin: 24px 0; color: rgba(255, 255, 255, 0.9);">
            ${dailyHiffirmation}
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
            <button class="hiffirmation-share" style="
              padding: 12px 20px; background: linear-gradient(135deg, #4ECDC4, #44A08D);
              border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer;
              transition: transform 0.2s ease;
            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
              Share This
            </button>
            <button class="hiffirmation-yesterday" style="
              padding: 12px 20px; background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; 
              color: white; font-weight: 600; cursor: pointer;
              transition: all 0.2s ease;
            " onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
              Yesterday's
            </button>
          </div>
          
          <!-- Hi Logo Branding -->
          <div style="margin-top: 32px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <img src="assets/brand/hi-logo-light.png" alt="Hi" style="width: 32px; height: 32px; opacity: 0.7;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';" />
            <div style="display: none; font-size: 24px; color: #FFD166; font-weight: bold;">Hi</div>
          </div>
          
          <!-- Close Button -->
          <button class="close-hiffirmation" style="
            position: absolute; top: 16px; right: 16px; width: 32px; height: 32px;
            border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.1);
            color: white; cursor: pointer; font-size: 16px;
            transition: background 0.2s ease;
          " onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
            ‚úï
          </button>
        </div>
      `;

      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';

      // Event handlers
      const closeModal = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      };

      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
      modal.querySelector('.close-hiffirmation').addEventListener('click', closeModal);
      
      // Yesterday's Hiffirmation button
      modal.querySelector('.hiffirmation-yesterday').addEventListener('click', () => {
        closeModal();
        setTimeout(() => {
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          showHiffirmationsModal(yesterday);
        }, 100);
      });
      
      // Enhanced Share button with Quote Card Generation
      modal.querySelector('.hiffirmation-share').addEventListener('click', async () => {
        const shareBtn = modal.querySelector('.hiffirmation-share');
        const originalText = shareBtn.textContent;
        
        try {
          // Show loading state
          shareBtn.textContent = 'Creating quote card...';
          shareBtn.style.background = 'linear-gradient(135deg, #FFD166, #F4A261)';
          
          // Get user tier for appropriate styling
          const userTier = getUserTierForSharing();
          
          // Generate beautiful quote card
          const quoteCardDataURL = await window.HiQuoteCardGenerator.generateQuoteCard(
            dailyHiffirmation, 
            { 
              userTier, 
              format: 'square' 
            }
          );
          
          // Convert to blob for sharing
          const blob = await window.HiQuoteCardGenerator.dataURLToBlob(quoteCardDataURL);
          const file = new File([blob], 'hiffirmation-quote-card.png', { type: 'image/png' });
          
          // Try native sharing with image
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            shareBtn.textContent = 'Sharing...';
            await navigator.share({
              title: 'Daily Hiffirmation from Stay Hi',
              text: `"${dailyHiffirmation}"\n\nShared from Stay Hi ‚ú®`,
              files: [file]
            });
            
            // Success feedback
            shareBtn.textContent = '‚úì Shared!';
            shareBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            
          } else if (navigator.share) {
            // Fallback: Share text and download image
            shareBtn.textContent = 'Downloading & copying...';
            
            // Download quote card
            const downloadLink = document.createElement('a');
            downloadLink.href = quoteCardDataURL;
            downloadLink.download = 'hiffirmation-quote-card.png';
            downloadLink.click();
            
            // Share text
            await navigator.share({
              title: 'Daily Hiffirmation from Stay Hi',
              text: `"${dailyHiffirmation}"\n\nShared from Stay Hi ‚ú®\n\nstay-hi.app`,
            });
            
            shareBtn.textContent = '‚úì Quote card downloaded & text shared!';
            shareBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            
          } else {
            // Final fallback: Download image and copy text
            shareBtn.textContent = 'Downloading...';
            
            // Download quote card
            const downloadLink = document.createElement('a');
            downloadLink.href = quoteCardDataURL;
            downloadLink.download = 'hiffirmation-quote-card.png';
            downloadLink.click();
            
            // Copy text to clipboard
            const textToCopy = `"${dailyHiffirmation}"\n\nShared from Stay Hi ‚ú®\nstay-hi.app`;
            await navigator.clipboard.writeText(textToCopy);
            
            shareBtn.textContent = '‚úì Quote card downloaded & text copied!';
            shareBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
          }
          
        } catch (error) {
          console.error('‚ùå Quote card sharing failed:', error);
          
          // Fallback to simple text sharing
          if (navigator.share) {
            await navigator.share({
              title: 'Daily Hiffirmation from Stay Hi',
              text: dailyHiffirmation,
              url: window.location.href
            });
          } else {
            await navigator.clipboard.writeText(dailyHiffirmation);
          }
          
          shareBtn.textContent = '‚úì Shared!';
          shareBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
        }
        
        // Reset button after 3 seconds
        setTimeout(() => {
          shareBtn.textContent = originalText;
          shareBtn.style.background = 'linear-gradient(135deg, #4ECDC4, #44A08D)';
        }, 3000);
      });

      // Helper function to get user tier for sharing
      function getUserTierForSharing() {
        const tierElement = document.getElementById('hi-tier-indicator');
        if (tierElement) {
          const tierText = tierElement.querySelector('.tier-text')?.textContent;
          if (tierText === 'Premium') return 'PREMIUM';
          if (tierText === 'Standard') return 'STANDARD';
        }
        return 'ANONYMOUS';
      }
    }

    // Weekly Progress Strip (Simplified)
    async function setupWeeklyProgress() {
      const weekStrip = document.getElementById('weekStrip');
      if (!weekStrip) return;

      const today = new Date();
      let html = '';
      
      // Get real user streak data
      const weeklyActivity = await getUserWeeklyActivity();
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const label = date.toLocaleDateString(undefined, { weekday: 'short' }).toUpperCase();
        const dayNum = date.getDate();
        const isToday = i === 0;
        const dateKey = date.toISOString().split('T')[0];
        const metClass = weeklyActivity.activeDays.includes(dateKey) ? 'met' : '';
        
        // üéñÔ∏è Evolution Enhancement: Add milestone indicator
        const milestoneClass = isToday && weeklyActivity.milestone?.current ? 'milestone' : '';
        
        html += `<div class="weekdot ${isToday ? 'today' : ''} ${milestoneClass}">
          <div class="lbl">${label}</div>
          <div class="c ${metClass}">${dayNum}</div>
          ${isToday && weeklyActivity.milestone?.current ? `<div class="milestone-badge">${weeklyActivity.milestone.current.emoji}</div>` : ''}
        </div>`;
      }
      
      weekStrip.innerHTML = html;
    }

    // üéØ Get user's weekly Hi activity (real streak data)
    async function getUserWeeklyActivity() {
      try {
        // Check if user is authenticated
        const currentUser = window.hiAuth?.getCurrentUser?.();
        console.log('üîç 7-Pill: Checking user auth:', currentUser?.id || 'anonymous');
        
        if (currentUser && currentUser.id && currentUser.id !== 'anonymous') {
          // Authenticated user: Get real streak data
          const streakResult = await window.HiBase?.streaks?.getUserStreak?.(currentUser.id);
          console.log('üìä 7-Pill: Streak result:', streakResult);
          
          if (streakResult?.data) {
            const weeklyData = generateWeeklyFromStreak(streakResult.data);
            console.log('‚úÖ 7-Pill: Using real streak data', weeklyData);
            return weeklyData;
          }
        }
        
        // Anonymous or error: Use motivational preview
        const previewData = generateAnonymousWeeklyPreview();
        console.log('üéØ 7-Pill: Using anonymous preview', previewData);
        return previewData;
        
      } catch (error) {
        console.log('üìä 7-Pill: Fallback mode due to error:', error);
        return generateAnonymousWeeklyPreview();
      }
    }

    // üî• Generate weekly activity from real streak data
    function generateWeeklyFromStreak(streakData) {
      const activeDays = [];
      const today = new Date();
      const currentStreak = streakData.current || 0;
      const lastHiDate = streakData.lastHiDate;
      
      // üéØ Evolution Hook: Check for milestone achievements
      const milestoneInfo = checkStreakMilestones(currentStreak);
      
      if (lastHiDate && currentStreak > 0) {
        // Calculate active days based on streak
        const streakStart = new Date(lastHiDate);
        streakStart.setDate(streakStart.getDate() - currentStreak + 1);
        
        for (let i = 0; i < currentStreak && i < 7; i++) {
          const activeDate = new Date(streakStart);
          activeDate.setDate(streakStart.getDate() + i);
          
          // Only include if within last 7 days
          const daysAgo = Math.floor((today - activeDate) / (1000 * 60 * 60 * 24));
          if (daysAgo >= 0 && daysAgo <= 6) {
            activeDays.push(activeDate.toISOString().split('T')[0]);
          }
        }
      }
      
      return { 
        activeDays, 
        source: 'real_streak',
        milestone: milestoneInfo // üöÄ Future enhancement hook
      };
    }

    // üéñÔ∏è Evolution Hook: Milestone detection (passive - no UI changes yet)
    function checkStreakMilestones(streak) {
      const milestones = [
        { threshold: 3, name: 'Hi Habit', emoji: 'üî•' },
        { threshold: 7, name: 'Week Keeper', emoji: 'üî•' },
        { threshold: 30, name: 'Monthly Hi', emoji: 'üî•' },
        { threshold: 100, name: 'Steady Light', emoji: 'üî•' }
      ];
      
      const achieved = milestones.filter(m => streak >= m.threshold);
      const latest = achieved[achieved.length - 1];
      const upcoming = milestones.find(m => streak < m.threshold);
      
      return {
        current: latest || null,
        next: upcoming || null,
        isNewMilestone: false // Will be enhanced in future phases
      };
    }

    // üíé Generate encouraging preview for anonymous users
    function generateAnonymousWeeklyPreview() {
      const activeDays = [];
      const today = new Date();
      
      // Show 2-3 recent days as "active" to encourage engagement
      const recentDays = Math.floor(Math.random() * 2) + 2; // 2-3 days
      for (let i = 0; i < recentDays; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        activeDays.push(date.toISOString().split('T')[0]);
      }
      
      return { activeDays, source: 'preview' };
    }

    // üåç Helper: Get current user location for hi island piping
    async function getCurrentUserLocation() {
      try {
        // Check localStorage cache first
        const cached = localStorage.getItem('hi_user_location');
        if (cached) {
          const locationData = JSON.parse(cached);
          if (Date.now() - locationData.timestamp < 24 * 60 * 60 * 1000) { // 24 hour cache
            return locationData.location;
          }
        }
        
        // Default to 'Virtual Hi Island' for dashboard hi5s
        return 'Virtual Hi Island';
      } catch (error) {
        console.warn('Location lookup failed, using default:', error);
        return 'Virtual Hi Island';
      }
    }

    // üéâ Helper: Show celebration message
    function showCelebrationMessage(message) {
      // Create temporary celebration overlay
      const celebration = document.createElement('div');
      celebration.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #FFD166, #FF7B24);
        color: #000;
        padding: 20px 30px;
        border-radius: 20px;
        font-size: 18px;
        font-weight: 600;
        box-shadow: 0 10px 30px rgba(255, 123, 24, 0.4);
        z-index: 10000;
        animation: celebrationPop 2s ease-out forwards;
      `;
      celebration.textContent = message;
      
      // Add animation keyframes
      if (!document.getElementById('celebrationStyles')) {
        const style = document.createElement('style');
        style.id = 'celebrationStyles';
        style.textContent = `
          @keyframes celebrationPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(celebration);
      setTimeout(() => celebration.remove(), 2000);
    }

    // üî• Phase 7: Hi Experience Layer Initialization (Feature Flagged)
    async function initializeHiExperienceLayer() {
      try {
        // Check if hifeed_enabled flag is active (cohort-aware)
        const { isEnabledCohort } = await import('./lib/flags/HiFlags.js');
        const { trackEvent } = await import('./lib/monitoring/HiMonitor.js');
        
        const hiFeedEnabled = await isEnabledCohort('hifeed_enabled');
        
        // Track flag evaluation for telemetry
        trackEvent('flag_check', {
          key: 'hifeed_enabled',
          enabled: hiFeedEnabled,
          rollout: true,
          location: 'dashboard'
        });
        
        console.log('üîç HiFeed flag check (dashboard - cohort):', { 
          flagEnabled: hiFeedEnabled,
          rollout: true
        });
        
        if (hiFeedEnabled) {
          console.log('üî• HiFeed enabled - initializing experience layer components');
          
          // Show the experience layer container
          const experienceLayer = document.getElementById('hiExperienceLayer');
          if (experienceLayer) {
            experienceLayer.style.display = 'block';
          }
          
          // Initialize HiFeed component
          if (window.HiFeed) {
            const hiFeed = new window.HiFeed('#hiFeedContainer');
            await hiFeed.initialize();
            console.log('‚úÖ HiFeed component initialized');
          }
          
          // Initialize HiStreaks component
          if (window.HiStreaks) {
            const hiStreaks = new window.HiStreaks('#hiStreaksContainer');
            await hiStreaks.initialize();
            console.log('‚úÖ HiStreaks component initialized');
          }
          
        } else {
          console.log('üö´ HiFeed disabled - experience layer components not loaded');
        }
        
      } catch (error) {
        console.error('‚ùå Hi Experience Layer initialization error:', error);
      }
    }

    // Tesla-Grade Initialization
    document.addEventListener('DOMContentLoaded', async () => {
      // Track current page visit for smart navigation
      try {
        const currentPage = {
          url: window.location.href,
          name: 'Dashboard',
          timestamp: Date.now()
        };
        
        const navHistory = JSON.parse(sessionStorage.getItem('hiNavHistory') || '[]');
        // Remove any existing entry for this page
        const filtered = navHistory.filter(page => page.url !== currentPage.url);
        // Add current page to front
        filtered.unshift(currentPage);
        // Keep last 10 pages
        filtered.splice(10);
        sessionStorage.setItem('hiNavHistory', JSON.stringify(filtered));
      } catch (error) {
        // Silent fail for tracking
      }

      // Initialize all components
      initializeDatabase();
      // setupSelfHi5Handler(); // DEPRECATED: Using medallion long-press system
      setupNavigationHandler();
      setupHiffirmationsHandler();
      setupFloatingHiffirmationsHandler();
      await setupWeeklyProgress();
      
      // Initialize global stats variables immediately
      // üöÄ TESLA GRADE: Smart loading states without jarring jumps
      const savedWaves = localStorage.getItem('dashboard_waves_cache');
      const savedTotal = localStorage.getItem('dashboard_total_cache');
      const savedUsers = localStorage.getItem('dashboard_users_cache');
      
      if (window.gWaves === undefined) {
        // Gold standard: Use cached value if recent, otherwise start with loading state
        const cacheTimestamp = localStorage.getItem('dashboard_waves_cache_time');
        const isRecentCache = cacheTimestamp && (Date.now() - parseInt(cacheTimestamp, 10)) < 30000;
        
        if (savedWaves && isRecentCache) {
          window.gWaves = parseInt(savedWaves, 10);
        } else {
          // üéØ GOLD STANDARD: Start with cached value or smart default instead of undefined
          window.gWaves = savedWaves ? parseInt(savedWaves, 10) : 1574; // Use last known good value
          // Mark for immediate refresh
          window._needsWavesRefresh = true;
        }
      }
      if (window.gTotalHis === undefined) {
        window.gTotalHis = savedTotal ? parseInt(savedTotal, 10) : 90;
        // Mark as temporary value to prevent jarring jumps
        window._gTotalHisIsTemporary = !savedTotal;
      }
      if (window.gUsers === undefined) {
        // üéØ DATABASE ONLY: Use cached database values, never fallback to hardcoded numbers
        const cachedUsers = localStorage.getItem('dashboard_users_cache');
        window.gUsers = cachedUsers ? parseInt(cachedUsers, 10) : 5; // Conservative estimate while loading
        window.initializeSmartUserCount?.();
      }
      
      // üéØ INSTANT UI UPDATE: Show cached/smart defaults immediately
      updateStatsUI();
      console.log('‚ö° Instant stats display with cached values:', { 
        waves: window.gWaves, 
        totalHis: window.gTotalHis, 
        users: window.gUsers 
      });
      
      // HI-OS: Initialize Tesla-grade stats system + Hi OS Enhancement Layer
      import('./ui/stats/initHiStats.js').then(async ({ initHiStatsOnce }) => {
        const { trackShareSubmission } = await import('./lib/stats/GoldStandardTracker.js');
        window.trackShareSubmission = trackShareSubmission;
        
        // üöÄ HI OS ENHANCEMENT: Load enhancement layer after base system
        try {
          await import('./lib/stats/HiOSEnhancementLayer.js');
          console.log('üöÄ Hi OS Enhancement Layer loaded for Hi-Dashboard');
        } catch (error) {
          console.warn('‚ö†Ô∏è Hi OS enhancement optional - continuing without:', error);
        }
        
        console.log('‚úÖ Gold Standard tracker loaded for Hi-Dashboard');
        console.log('üéØ Tesla-grade dashboard stats system initialized');
        
        // üéØ STATS: Handled by initHiStatsOnce() - no duplicate loading needed
      }).catch(error => {
        console.error('‚ùå Stats initialization failed:', error);
      });
      
      // UX-First: Update membership tier indicator when system loads
      setTimeout(() => {
        if (window.HiMembership && window.HiMembership.initialized) {
          const user = window.HiMembership.getCurrentUser();
          const tierIndicator = document.getElementById('hi-tier-indicator');
          if (tierIndicator && user) {
            const tierText = tierIndicator.querySelector('.tier-text');
            tierText.textContent = user.tierInfo.name;
            tierIndicator.style.color = user.tierInfo.color || '#6B7280';
            
            console.log('üé´ [UX] Membership tier displayed:', user.tierInfo.name);
          }
        }
      }, 1000);
      
      console.log('üéØ Stats loading managed by Hi-OS init guard - no direct calls');
      
      // üî• Phase 7: Initialize Hi Experience Layer (Feature Flagged)
      initializeHiExperienceLayer();
      
      // üöÄ SINGLE STATS LOADING: Let initHiStatsOnce() handle all database loading
      setTimeout(() => {
        updateStatsUI(); // Force immediate update with current values
        // üéØ No duplicate database calls - initHiStatsOnce() handles loading
      }, 50);
      
      setTimeout(() => {
        updateStatsUI(); // Second attempt after DOM settles
      }, 500);
      
      setTimeout(() => {
        updateStatsUI(); // Third attempt as final backup
      }, 1500);

    });

    // Calendar Integration
    function setupCalendarIntegration() {
      const btnCal = document.getElementById('btnCal');
      if (btnCal) {
        btnCal.addEventListener('click', () => {
          if (window.hiCalendarInstance) {
            window.hiCalendarInstance.show();
          } else {
            console.error('[HI DEV] Calendar not initialized');
          }
        });
      }
    }

    function setupHomeNavigation() {
      const btnHome = document.getElementById('btnHome');
      if (btnHome) {
        btnHome.addEventListener('click', () => {
          // Navigate to Hi Today (dashboard)
          window.location.href = 'hi-dashboard.html';
        });
      }
    }

    // üöÄ FAST STATS LOADING: Background loading with instant fallbacks
    async function loadCurrentStatsFromDatabase() {
      console.log('üîÑ Background loading real stats from database...');
      
      // üéØ STRATEGY: Load async in background, don't block UI
      setTimeout(async () => {
        try {
          // Quick Supabase client check (no long waits)
          let supabase = window.getSupabase?.() || window.supabaseClient || window.HiSupabase?.getClient?.() || window.supabase;
          
          // If no client immediately available, try a few quick attempts
          if (!supabase) {
            for (let i = 0; i < 5; i++) {
              await new Promise(resolve => setTimeout(resolve, 100));
              supabase = window.getSupabase?.() || window.supabaseClient || window.HiSupabase?.getClient?.() || window.supabase;
              if (supabase) break;
            }
          }
          
          if (!supabase) {
            console.log('ÔøΩ No Supabase client available, keeping smart defaults');
            return;
          }
          
          console.log('‚úÖ Supabase ready, fetching real stats...');
          
          // Try fastest queries first
          let realStatsLoaded = false;
          
          // 1. üöÄ TESLA GRADE: Enhanced stats loading with real user count
          try {
            if (window.loadEnhancedGlobalStats) {
              await window.loadEnhancedGlobalStats();
              realStatsLoaded = true;
            } else {
              // Fallback to standard loading
              const { data, error } = await supabase
                .from('global_community_stats')
                .select('total_his, hi_waves, total_users')
                .limit(1)
                .single();
                
              if (data && !error) {
                // Update with real values
                const oldTotalHis = window.gTotalHis;
                const oldWaves = window.gWaves;
                
                // Only update if we have a better value than temporary fallback
                if (data.total_his && (window._gTotalHisIsTemporary || data.total_his > window.gTotalHis)) {
                  window.gTotalHis = data.total_his;
                  window._gTotalHisIsTemporary = false;
                }
                window.gWaves = data.hi_waves || window.gWaves;
                // User count handled by RealUserCount.js system
                
                // Cache other stats
                localStorage.setItem('dashboard_waves_cache', window.gWaves.toString());
                localStorage.setItem('dashboard_total_cache', window.gTotalHis.toString());
                localStorage.setItem('dashboard_cache_timestamp', Date.now().toString());
                
                console.log('‚úÖ Stats loaded (fallback mode):', { 
                  totalHis: `${oldTotalHis} ‚Üí ${window.gTotalHis}`,
                  waves: `${oldWaves} ‚Üí ${window.gWaves}`,
                  users: window.gUsers
                });
                
                updateStatsUI();
                realStatsLoaded = true;
              }
            }
          } catch (err) {
            console.log('üìä Enhanced stats loading failed, trying fallback...');
          }
          
          // 2. Fallback to public_shares (just for Total His)
          if (!realStatsLoaded) {
            try {
              const { data: shareData, error: shareError } = await supabase
                .from('public_shares')
                .select('total_his')
                .limit(1)
                .single();
                
              if (shareData && !shareError && shareData.total_his) {
                const oldTotalHis = window.gTotalHis;
                // Only update if we don't already have a good value
                if (window._gTotalHisIsTemporary || shareData.total_his > window.gTotalHis) {
                  window.gTotalHis = shareData.total_his;
                  window._gTotalHisIsTemporary = false;
                }
                
                console.log('‚úÖ Total His updated from public_shares:', `${oldTotalHis} ‚Üí ${window.gTotalHis}`);
                updateStatsUI();
                realStatsLoaded = true;
              }
            } catch (err) {
              console.log('üìä public_shares query failed:', err);
            }
          }
          
          if (!realStatsLoaded) {
            console.log('üìä Real stats unavailable, smart defaults will be used');
          }
          
        } catch (error) {
          console.log('üìä Background stats loading failed, keeping defaults:', error);
        }
        
        // üåä TESLA GRADE: Start Hi Waves real-time system
        if (window.hiWavesRealtime) {
          setTimeout(async () => {
            const success = await window.hiWavesRealtime.initialize();
            if (success) {
              window.hiWavesRealtime.startRealTimeUpdates(3000); // Every 3 seconds for gold standard smooth updates
              console.log('üåä Hi Waves real-time system active');
            }
          }, 2000);
        }
      }, 100); // Very short delay to let page render first
    }
    
    // Helper function to update stats UI
    function updateStatsUI() {
      // Try multiple possible element IDs for Global Waves
      const globalTotalHis = document.getElementById('globalTotalHis');
      const globalHiWaves = document.getElementById('globalHiWaves') || 
                           document.getElementById('globalWaves') || 
                           document.getElementById('global-waves') ||
                           document.querySelector('[data-stat="waves"]') ||
                           document.querySelector('.global-waves');
      const globalUsers = document.getElementById('globalUsers') ||
                         document.getElementById('globalMembers') ||
                         document.querySelector('[data-stat="users"]');
      
      if (globalTotalHis && window.gTotalHis !== undefined) {
        globalTotalHis.textContent = window.gTotalHis.toLocaleString();
        console.log('‚úÖ Total His UI updated:', window.gTotalHis);
      }
      
      if (globalHiWaves && window.gWaves !== undefined) {
        globalHiWaves.textContent = window.gWaves.toLocaleString();
        console.log('‚úÖ Global Waves UI updated:', window.gWaves);
      } else {
        console.log('‚ö†Ô∏è Global Waves element not found. Available elements:');
        console.log('   - globalHiWaves:', !!document.getElementById('globalHiWaves'));
        console.log('   - globalWaves:', !!document.getElementById('globalWaves'));
        console.log('   - global-waves:', !!document.getElementById('global-waves'));
      }
      
      if (globalUsers && window.gUsers !== undefined) {
        globalUsers.textContent = window.gUsers.toLocaleString();
        console.log('‚úÖ Global Users UI updated:', window.gUsers);
      }
      
      // Also try to update any other possible stat displays
      document.querySelectorAll('.total-his-count, .global-total-his').forEach(el => {
        if (window.gTotalHis !== undefined) el.textContent = window.gTotalHis.toLocaleString();
      });
      
      document.querySelectorAll('.waves-count, .global-waves-count').forEach(el => {
        if (window.gWaves !== undefined) el.textContent = window.gWaves.toLocaleString();
      });
    }

    // METRICS SEPARATION: Debug exposure
    window.metricsDebug = {
      gWaves: () => gWaves,
      gTotalHis: () => gTotalHis,
      gUsers: () => gUsers,
      incrementHiWave,
      updateGlobalStats,
      loadCurrentStats: loadCurrentStatsFromDatabase
    };
  </script>

  <!-- Premium Component Scripts -->
  <script src="assets/premium-ux.js"></script>
  <script src="assets/premium-calendar.js"></script>
  <script src="./ui/HiFooter/HiFooter.js" defer></script>
  
  <!-- Hi Components: HiShareSheet + HiMedallion (Tesla-grade initialization) -->
  <script type="module">
    import { HiShareSheet } from './ui/HiShareSheet/HiShareSheet.js';
    import { mountHiMedallion } from './ui/HiMedallion/HiMedallion.js';
    
    // Tesla-grade component initialization with guards
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize components only once
      if (!window.__hiComponentsInitialized) {
        window.__hiComponentsInitialized = {};
      }
      
      // HiShareSheet - unified initialization (replaces duplicate at line 1008)
      if (!window.__hiComponentsInitialized.shareSheet) {
        const shareSheet = new HiShareSheet({ 
          origin: 'dashboard',
          onSuccess: async (shareData) => {
            const submissionId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            console.log('‚úÖ Dashboard share success handler called:', { submissionId, shareData });
            
            // üéØ TESLA GRADE: Increment Hi5 counter for Hi5 type shares
            if (shareData.type === 'Hi5') {
              console.log('üéØ Incrementing Hi5 counter for submission:', submissionId);
              await incrementHi5Counter();
              console.log('‚úÖ Hi5 counter incremented for submission:', submissionId);
            }
            
            // üöÄ TESLA GRADE: Refresh user count after new share
            if (window.loadRealUserCount) {
              setTimeout(window.loadRealUserCount, 1000);
            }
            
            // Track submission for Global Hi's counter (COMPREHENSIVE integration)
            if (window.trackShareSubmission) {
              window.trackShareSubmission('hi-dashboard', {
                submissionType: shareData.privacy || 'public',
                pageOrigin: 'hi-dashboard',
                origin: 'hi-dashboard',
                tag: shareData.type === 'Hi5' ? 'Hi5Ô∏è‚É£' : 'Hi Dashboard',
                timestamp: Date.now()
              });
            }
            
            // üìä Analytics tracking
            try {
              const { trackEvent } = await import('./lib/monitoring/HiMonitor.js');
              trackEvent('share_submit', {
                visibility: shareData.visibility || shareData.privacy,
                type: shareData.type || 'standard',
                origin: 'dashboard'
              });
            } catch (err) {
              console.log('Analytics tracking failed:', err);
            }
          }
        });
        shareSheet.init();
        
        // Store instance reference for button handlers
        window.__hiComponentsInitialized.shareSheet = true;
        window.__hiComponentsInitialized.shareSheetInstance = shareSheet;
      }

      // üåü WOZNIAK-GRADE: Handle post-auth dashboard actions
      const pendingAction = localStorage.getItem('pendingDashboardAction');
      if (pendingAction) {
        try {
          const actionData = JSON.parse(pendingAction);
          console.log('üîÑ Processing pending dashboard action after auth:', actionData);
          
          // Clear the pending action
          localStorage.removeItem('pendingDashboardAction');
          
          // Execute the pending action based on type
          if (actionData.action === 'hi5-share' && actionData.context === 'dashboard') {
            // Auto-trigger Hi5 share after successful auth
            setTimeout(() => {
              const shareSheetInstance = window.__hiComponentsInitialized?.shareSheetInstance;
              if (shareSheetInstance) {
                shareSheetInstance.open({
                  context: 'dashboard',
                  preset: 'hi5',
                  prefilledText: '‚ú® Celebrating this moment of growth! ',
                  type: 'Hi5'
                });
                console.log('‚úÖ Auto-opened Hi5 share sheet after auth');
              }
            }, 1000); // Small delay to ensure everything is loaded
          }
        } catch (error) {
          console.error('‚ùå Failed to process pending dashboard action:', error);
          localStorage.removeItem('pendingDashboardAction'); // Clean up on error
        }
      }
      
      // üèóÔ∏è HI OS GOLD STANDARD: Long-Press Hi 5 System Function
      function setupMedallionLongPress(medallionElement) {
        if (!medallionElement || medallionElement.__longPressSetup) return;
        medallionElement.__longPressSetup = true;
        
        let longPressTimer = null;
        let progressTimer = null;
        let startTime = 0;
        const LONG_PRESS_DURATION = 2000; // 2 seconds
        const PROGRESS_INTERVAL = 50; // Update every 50ms for smooth animation
        
        function startLongPress(e) {
          // Prevent context menu on mobile
          e.preventDefault();
          
          startTime = Date.now();
          medallionElement.classList.add('long-press-active', 'long-press-filling');
          
          // Haptic feedback on start
          try { navigator?.vibrate?.(20); } catch {}
          
          // Progress animation
          let progress = 0;
          progressTimer = setInterval(() => {
            const elapsed = Date.now() - startTime;
            progress = Math.min((elapsed / LONG_PRESS_DURATION) * 360, 360);
            medallionElement.style.setProperty('--progress', `${progress}deg`);
            
            if (progress >= 360) {
              clearInterval(progressTimer);
              completeLongPress();
            }
          }, PROGRESS_INTERVAL);
          
          // Fallback timer
          longPressTimer = setTimeout(() => {
            completeLongPress();
          }, LONG_PRESS_DURATION);
        }
        
        function cancelLongPress() {
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
          if (progressTimer) {
            clearInterval(progressTimer);
            progressTimer = null;
          }
          
          medallionElement.classList.remove('long-press-active', 'long-press-filling', 'long-press-complete');
          medallionElement.style.removeProperty('--progress');
        }
        
        function completeLongPress() {
          cancelLongPress();
          medallionElement.classList.add('long-press-complete');
          
          // Strong haptic feedback on completion
          try { navigator?.vibrate?.(100); } catch {}
          
          console.log('üéØ Long-press completed - triggering Hi 5 flow');
          
          // Trigger existing Hi 5 functionality
          triggerHi5Flow();
          
          // Clean up visual state after animation
          setTimeout(() => {
            medallionElement.classList.remove('long-press-complete');
          }, 500);
        }
        
        // Mobile-first event handling
        medallionElement.addEventListener('touchstart', startLongPress, { passive: false });
        medallionElement.addEventListener('mousedown', startLongPress);
        
        medallionElement.addEventListener('touchend', cancelLongPress);
        medallionElement.addEventListener('touchmove', cancelLongPress);
        medallionElement.addEventListener('mouseup', cancelLongPress);
        medallionElement.addEventListener('mouseleave', cancelLongPress);
        
        console.log('üèóÔ∏è Long-press system initialized for medallion');
      }
      
      // üéØ Hi 5 Flow Trigger Function (connects to existing system)
      function triggerHi5Flow() {
        // Use existing Hi 5 authentication and flow logic
        const canShare = window.hiAccessManager?.canAccess?.('shareCreation') || 
                        window.HiTierSystem?.hasCapability?.('drop_hi') ||
                        window.unifiedMembership?.hasAccess?.('shareCreation');
                        
        if (!canShare) {
          console.log('üîí Anonymous user long-press - showing auth modal');
          
          // Use existing auth modal system
          if (window.showShareAuthModal) {
            window.showShareAuthModal('hi-dashboard', {
              title: 'Join Hi Community for Self Hi 5',
              benefits: [
                '‚ú® Celebrate achievements that matter to you',
                'üìä Track your personal empowerment journey',
                'üéØ Share meaningful moments with the community'
              ],
              trigger: 'medallion-long-press',
              cta: 'Start Your Hi 5 Journey'
            });
          } else if (window.showAuthModal) {
            window.showAuthModal('hi-dashboard');
          } else {
            console.warn('‚ö†Ô∏è No auth modals available');
            window.location.href = '/welcome.html';
          }
        } else {
          console.log('‚úÖ Authenticated user - proceeding with Hi 5 creation');
          // TODO: Implement authenticated Hi 5 creation flow
          // This would open the Hi 5 ritual/creation interface
        }
      }

      // METRICS SEPARATION: Initialize HiMedallion with medallion tap handler
      const medallionContainer = document.getElementById('hiMedallionContainer');
      if (medallionContainer) {
        // Use existing medallion HTML with your logo (don't overwrite)
        import('./ui/HiMedallion/HiMedallion.js').then(({ mountHiMedallion }) => {
          // Find the existing medallion button element
          const medallionElement = medallionContainer.querySelector('#hiMedallion');
          if (medallionElement) {
            // Mount interactive behavior with direct tap tracking (UX-first fix)
            mountHiMedallion(medallionElement, {
              origin: 'dashboard',
              ariaLabel: 'Send positive energy to the Stay Hi community',
              onTap: () => {
                console.log('üèÖ Medallion tapped - tracking wave...');
                
                // Increment global waves immediately (initialize if needed)
                if (window.gWaves === undefined) {
                  window.gWaves = 0; // Initialize if not set yet
                }
                window.gWaves += 1;
                console.log('üåä Global waves updated:', window.gWaves);
                
                // üéØ JOBS-GRADE: 60fps UI update with RAF optimization
                requestAnimationFrame(() => {
                  const globalHiWavesEl = document.getElementById('globalHiWaves');
                  if (globalHiWavesEl) {
                    globalHiWavesEl.textContent = window.gWaves.toLocaleString();
                    
                    // Trigger Mario-style number burst (RAF-optimized)
                    globalHiWavesEl.classList.remove('burst');
                    requestAnimationFrame(() => {
                      globalHiWavesEl.classList.add('burst');
                      
                      // Clean up animation class after completion
                      setTimeout(() => {
                        requestAnimationFrame(() => {
                          globalHiWavesEl.classList.remove('burst');
                        });
                      }, 500);
                    });
                    
                    console.log('‚úÖ UI updated with RAF-optimized burst animation');
                  }
                });
                
                // Also call the unified stats update if available
                if (window.updateGlobalStats) {
                  window.updateGlobalStats();
                }
                
                // üéØ PERSIST TO DATABASE: Call increment_hi_wave to save to database
                if (window.supabase) {
                  window.supabase.rpc('increment_hi_wave').then(({ data, error }) => {
                    if (error) {
                      console.error('‚ùå Database wave increment failed:', error);
                    } else {
                      console.log('‚úÖ Wave persisted to database:', data);
                      // Update with actual database value to stay in sync
                      if (data && typeof data === 'number') {
                        window.gWaves = data;
                        
                        // üöÄ CACHE THE REAL VALUE: Persist for next page load
                        localStorage.setItem('dashboard_waves_cache', window.gWaves.toString());
                        localStorage.setItem('dashboard_cache_timestamp', Date.now().toString());
                        
                        // üåä TESLA GRADE: Update Hi Waves real-time system
                        if (window.hiWavesRealtime) {
                          window.hiWavesRealtime.updateWavesUI(window.gWaves);
                        }
                        
                        const globalHiWavesEl = document.getElementById('globalHiWaves');
                        if (globalHiWavesEl) {
                          globalHiWavesEl.textContent = window.gWaves.toLocaleString();
                        }
                        
                        console.log('üì¶ Waves cached for next load:', window.gWaves);
                      }
                    }
                  });
                }
                
                // Track in localStorage for persistence
                const personalTaps = parseInt(localStorage.getItem('user_medallion_taps') || '0', 10) + 1;
                localStorage.setItem('user_medallion_taps', personalTaps.toString());
              }
            });
            
            console.log('üéØ Tesla-grade HiMedallion mounted on dashboard with tap tracking');
            
            // üèóÔ∏è HI OS GOLD STANDARD: Long-Press Hi 5 System
            setupMedallionLongPress(medallionElement);
          }
        }).catch(error => {
          console.error('‚ùå Failed to load HiMedallion:', error);
        });
      }
    });
  </script>
  
  <!-- Initialize Premium Features -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // HI DEV: Calendar modal stacking fix (P2) - Initialize once only
      if (window.PremiumCalendar && !window.__hiCalendarInitialized) {
        window.__hiCalendarInitialized = true;
        window.hiCalendarInstance = new window.PremiumCalendar();
        console.log('[HI DEV] Calendar initialized once, stacking prevented');
        
        // Setup calendar integration
        setupCalendarIntegration();
        
        // Setup home navigation
        setupHomeNavigation();
      }
    });
  </script>

  <!-- üåç Tesla-Grade Unified Global Stats System -->
  <!-- DISABLED: Legacy stats system replaced by HiMetrics adapter -->
  <!-- <script src="assets/hi-unified-global-stats.js"></script> -->
  
  <!-- Tesla-Grade Navigation System removed - Home nav now in header -->
  <script>
    // Navigation system integration
    document.addEventListener('DOMContentLoaded', () => {
      // Update app state when dashboard is ready
      if (window.hiNavSystem) {
        window.hiNavSystem.updateAppState('ready');
        console.log('üß≠ Dashboard ready, navigation system active');
      }
      
      // Track dashboard page view
      if (window.hiNavSystem) {
        window.hiNavSystem.trackNavigation('dashboard_load');
      }
    });
    
    // Loading protection - if page takes too long, activate escape
    // Add floating refresh button
    function addFloatingRefresh() {
      if (!document.querySelector('.floating-refresh')) {
        const refreshButton = document.createElement('button');
        refreshButton.className = 'floating-refresh';
        refreshButton.innerHTML = 'üîÑ'; // Universal refresh emoji - no dependencies
        refreshButton.addEventListener('click', () => {
          location.reload();
        });
        document.body.appendChild(refreshButton);
      }
    }
    
    // Initialize refresh button after page load
    addFloatingRefresh();

    // Floating Hiffirmations System
    class FloatingHiffirmations {
      constructor() {
        this.currentPage = 'dashboard';
        this.lastShown = 0;
        this.cooldownPeriod = 30000; // 30 seconds
        this.messageHistory = [];
        this.maxHistorySize = 5;
        this.init();
      }

      init() {
        this.createFloatingButton();
        this.setupEventListeners();
        // Start gentle activity-based triggers after page settles
        setTimeout(() => this.startActivityTriggers(), 5000);
      }

      createFloatingButton() {
        const button = document.createElement('button');
        button.className = 'floating-hiffirmations';
        button.innerHTML = '‚ú®';
        button.setAttribute('aria-label', 'Contextual Hiffirmations');
        button.setAttribute('title', 'Get inspired');
        
        const popup = document.createElement('div');
        popup.className = 'hiffirmation-popup';
        popup.setAttribute('role', 'tooltip');
        
        document.body.appendChild(button);
        document.body.appendChild(popup);
        
        this.button = button;
        this.popup = popup;
      }

      setupEventListeners() {
        this.button.addEventListener('click', () => {
          this.showContextualMessage();
        });

        // Close popup on click outside
        document.addEventListener('click', (e) => {
          if (!this.button.contains(e.target) && !this.popup.contains(e.target)) {
            this.hidePopup();
          }
        });
      }

      getContextualMessages() {
        const userTier = this.getUserTier();
        const timeOfDay = this.getTimeOfDay();
        const engagementLevel = this.getEngagementLevel();
        
        // Base messages - universally inspiring
        const baseMessages = [
          "üåü Every Hi moment counts",
          "‚ú® You're creating positive ripples", 
          "üí´ Your journey matters today",
          "üéØ Small actions, big impact",
          "üíù You're exactly where you need to be"
        ];

        // Standard tier - enhanced motivation
        const standardMessages = [
          "üöÄ Your potential is unfolding beautifully",
          "üåà Progress happens one Hi at a time",
          "‚≠ê You're building something meaningful",
          "üî• Your energy lights up this space",
          "üí™ Your consistency is your superpower",
          "üåÖ Every day offers fresh possibilities"
        ];

        // Premium tier - personalized wisdom
        const premiumMessages = [
          "üíé Your unique light transforms everything",
          "üèîÔ∏è You're stronger than any challenge today",
          "üå∫ Growth happens in your comfort with discomfort",
          "‚ö° You're writing your own inspiring story",
          "ü¶Ñ Your authenticity creates lasting impact",
          "üé≠ You master the art of conscious living"
        ];

        // Time-sensitive contextual messages
        const timeContextMessages = this.getTimeContextMessages(timeOfDay, userTier);
        
        // Engagement-level specific messages
        const engagementMessages = this.getEngagementMessages(engagementLevel, userTier);

        // Build smart message pool
        let messagePool = [...baseMessages];
        
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messagePool.push(...standardMessages);
        }
        if (userTier === 'PREMIUM') {
          messagePool.push(...premiumMessages);
        }
        
        // Add contextual intelligence
        messagePool.push(...timeContextMessages);
        messagePool.push(...engagementMessages);

        return messagePool;
      }

      getTimeOfDay() {
        const hour = new Date().getHours();
        if (hour < 12) return 'morning';
        if (hour < 17) return 'afternoon';
        return 'evening';
      }

      getEngagementLevel() {
        if (this.activityScore > 20) return 'high';
        if (this.activityScore > 8) return 'medium';
        return 'low';
      }

      getTimeContextMessages(timeOfDay, userTier) {
        const timeMessages = {
          morning: {
            base: ["üåÖ Fresh energy for a new day", "‚òÄÔ∏è Your morning intention shapes everything"],
            standard: ["üå± Plant seeds of positivity today", "‚≠ê Morning momentum builds lasting change"],
            premium: ["üéØ Your morning mindset architects your reality", "üî• You're designing today with purpose"]
          },
          afternoon: {
            base: ["‚ö° Midday renewal brings clarity", "üåû Steady progress creates magic"],
            standard: ["üéØ Afternoon focus amplifies your impact", "üí™ Your persistence is paying dividends"],
            premium: ["üöÄ You're in the flow of purposeful action", "üíé Afternoon mastery builds lifetime habits"]
          },
          evening: {
            base: ["üåô Evening reflection deepens wisdom", "‚ú® Today's efforts become tomorrow's strength"],
            standard: ["üåü You're ending today stronger than you started", "üí´ Evening gratitude multiplies blessings"],
            premium: ["üé≠ Your evening presence honors the day's growth", "ü¶ã You transform experiences into wisdom"]
          }
        };

        const messages = [...timeMessages[timeOfDay].base];
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messages.push(...timeMessages[timeOfDay].standard);
        }
        if (userTier === 'PREMIUM') {
          messages.push(...timeMessages[timeOfDay].premium);
        }

        return messages;
      }

      getEngagementMessages(engagementLevel, userTier) {
        const engagementMessages = {
          low: {
            base: ["üå± Gentle steps forward count", "üíù Your presence here matters"],
            standard: ["üåä Flow finds you when you're ready", "‚≠ê Quiet moments build inner strength"],
            premium: ["üßò‚Äç‚ôÄÔ∏è Your stillness cultivates deeper wisdom", "üå∏ Gentle pace honors your authentic rhythm"]
          },
          medium: {
            base: ["üéØ Balanced energy serves you well", "üåà Steady progress creates lasting change"],
            standard: ["üí™ Your consistent effort compounds beautifully", "üî• Measured momentum builds sustainable success"],
            premium: ["‚ö° You master the art of intentional engagement", "üé≠ Your balanced approach inspires others"]
          },
          high: {
            base: ["üöÄ Your energy is contagious", "üî• Channel this momentum wisely"],
            standard: ["‚≠ê High energy focused creates miracles", "üíé Your enthusiasm lights up everything"],
            premium: ["üåü You're a force of nature in conscious action", "ü¶Ñ Your vibrant energy transforms environments"]
          }
        };

        const messages = [...engagementMessages[engagementLevel].base];
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messages.push(...engagementMessages[engagementLevel].standard);
        }
        if (userTier === 'PREMIUM') {
          messages.push(...engagementMessages[engagementLevel].premium);
        }

        return messages;
      }

      getUserTier() {
        // Integration with existing tier system
        const tierElement = document.getElementById('hi-tier-indicator');
        if (tierElement) {
          const tierText = tierElement.querySelector('.tier-text')?.textContent;
          if (tierText === 'Premium') return 'PREMIUM';
          if (tierText === 'Standard') return 'STANDARD';
        }
        return 'ANONYMOUS';
      }

      showContextualMessage() {
        const now = Date.now();
        if (now - this.lastShown < this.cooldownPeriod) return;

        const messages = this.getContextualMessages();
        const availableMessages = messages.filter(msg => !this.messageHistory.includes(msg));
        
        if (availableMessages.length === 0) {
          this.messageHistory = []; // Reset history if all used
          this.showContextualMessage(); // Retry
          return;
        }

        const message = availableMessages[Math.floor(Math.random() * availableMessages.length)];
        this.displayMessage(message);
        
        // Update history
        this.messageHistory.push(message);
        if (this.messageHistory.length > this.maxHistorySize) {
          this.messageHistory.shift();
        }
        
        this.lastShown = now;
      }

      displayMessage(message, type = 'contextual') {
        // Enhanced message display with type-aware styling and timing
        this.popup.innerHTML = `
          <span class="hiffirmation-text">${message}</span>
          <button class="hiffirmation-share-mini" title="Share as quote card">üì§</button>
        `;
        this.popup.setAttribute('data-message-type', type);
        
        // Add subtle type-specific styling
        if (type === 'milestone') {
          this.popup.style.background = 'rgba(233, 30, 99, 0.1)';
          this.popup.style.borderColor = 'rgba(233, 30, 99, 0.3)';
        } else {
          this.popup.style.background = 'rgba(26, 32, 56, 0.95)';
          this.popup.style.borderColor = 'rgba(255, 255, 255, 0.15)';
        }
        
        // Add share functionality
        const shareBtn = this.popup.querySelector('.hiffirmation-share-mini');
        shareBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          await this.shareFloatingMessage(message);
        });
        
        this.popup.classList.add('show');
        
        // Smart auto-hide timing based on message type and length
        const baseTime = type === 'milestone' ? 5000 : 4000; // Milestone messages stay longer
        const lengthBonus = Math.min(2000, message.length * 50); // Longer messages get more time
        const hideDelay = baseTime + lengthBonus;
        
        this.autoHideTimeout = setTimeout(() => {
          this.hidePopup();
        }, hideDelay);

        // Analytics: Track message effectiveness
        this.trackMessageShown(message, type);
      }

      async shareFloatingMessage(message) {
        const shareBtn = this.popup.querySelector('.hiffirmation-share-mini');
        const originalContent = shareBtn.innerHTML;
        
        try {
          shareBtn.innerHTML = '‚è≥';
          shareBtn.style.pointerEvents = 'none';
          
          // Get user tier
          const userTier = this.getUserTier();
          
          // Generate quote card with contextual branding
          const quoteCardDataURL = await window.HiQuoteCardGenerator.generateQuoteCard(
            message, 
            { 
              userTier, 
              format: 'square',
              context: this.currentPage 
            }
          );
          
          // Convert to blob
          const blob = await window.HiQuoteCardGenerator.dataURLToBlob(quoteCardDataURL);
          const file = new File([blob], `hi-${this.currentPage}-inspiration.png`, { type: 'image/png' });
          
          // Try sharing with image
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
              title: `Inspiration from Stay Hi`,
              text: `"${message}"\n\nShared from Stay Hi ‚ú®`,
              files: [file]
            });
            shareBtn.innerHTML = '‚úÖ';
          } else {
            // Fallback: Download image
            const downloadLink = document.createElement('a');
            downloadLink.href = quoteCardDataURL;
            downloadLink.download = `hi-${this.currentPage}-inspiration.png`;
            downloadLink.click();
            
            // Copy text
            const textToCopy = `"${message}"\n\nShared from Stay Hi ‚ú®\nstay-hi.app`;
            await navigator.clipboard.writeText(textToCopy);
            
            shareBtn.innerHTML = 'üì•';
          }
          
          // Reset after success
          setTimeout(() => {
            shareBtn.innerHTML = originalContent;
            shareBtn.style.pointerEvents = 'auto';
          }, 2000);
          
        } catch (error) {
          console.error('‚ùå Floating message sharing failed:', error);
          shareBtn.innerHTML = '‚ùå';
          setTimeout(() => {
            shareBtn.innerHTML = originalContent;
            shareBtn.style.pointerEvents = 'auto';
          }, 2000);
        }
      }

      trackMessageShown(message, type) {
        // Enhanced analytics for message effectiveness
        if (!window.hiAnalytics) return;
        
        window.hiAnalytics.track('hiffirmation_shown', {
          message_type: type,
          page_context: this.currentPage,
          user_tier: this.getUserTier(),
          activity_score: this.activityScore,
          session_messages: this.messageHistory.length,
          message_preview: message.substring(0, 20) + '...'
        });
      }

      hidePopup() {
        this.popup.classList.remove('show');
        if (this.autoHideTimeout) {
          clearTimeout(this.autoHideTimeout);
        }
      }

      startActivityTriggers() {
        // Smart contextual triggers with behavioral intelligence
        this.activityScore = 0;
        this.milestoneActions = ['selfHi5Enhanced', 'btnShare', 'hiffirmationsTrigger'];
        this.setupMilestoneTriggers();
        this.setupSmartTimingAlgorithm();
        this.trackUserEngagementPattern();
      }

      setupMilestoneTriggers() {
        // Trigger inspirational messages after meaningful user actions
        this.milestoneActions.forEach(actionId => {
          const element = document.getElementById(actionId);
          if (element) {
            element.addEventListener('click', () => {
              // Delay inspiration to avoid overwhelming user during their action
              setTimeout(() => {
                this.showMilestoneMessage(actionId);
              }, 2000);
            });
          }
        });

        // Hi-5 medallion interaction trigger
        const medallion = document.querySelector('.medallion, [data-action="hi-wave"]');
        if (medallion) {
          medallion.addEventListener('click', () => {
            setTimeout(() => {
              this.showMilestoneMessage('hi-wave');
            }, 1500);
          });
        }
      }

      showMilestoneMessage(actionType) {
        const now = Date.now();
        if (now - this.lastShown < 15000) return; // Reduced cooldown for milestones

        const milestoneMessages = this.getMilestoneMessages(actionType);
        const message = milestoneMessages[Math.floor(Math.random() * milestoneMessages.length)];
        this.displayMessage(message, 'milestone');
        this.lastShown = now;
      }

      getMilestoneMessages(actionType) {
        const userTier = this.getUserTier();
        
        const milestoneMap = {
          'selfHi5Enhanced': {
            base: ["üôå Self-love is the foundation", "‚ú® You're your biggest supporter"],
            standard: ["üíù Celebrating yourself creates ripples", "üåü Self-appreciation is magnetic"],
            premium: ["üëë You just modeled self-worth beautifully", "üíé Your self-love inspires others to do the same"]
          },
          'hi-wave': {
            base: ["üåä Every wave creates connection", "‚ú® You just brightened someone's day"],
            standard: ["üí´ Your Hi energy is contagious", "üî• Positive momentum is building"],
            premium: ["üöÄ You're a catalyst for community joy", "‚≠ê Your waves create lasting impact"]
          },
          'btnShare': {
            base: ["üì§ Sharing multiplies joy", "üåà Your story matters to someone"],
            standard: ["üéØ Vulnerability creates authentic connection", "üí™ You're inspiring others to be brave"],
            premium: ["üåü Your authentic sharing transforms communities", "üî• You're modeling courageous leadership"]
          }
        };

        const messageSet = milestoneMap[actionType] || milestoneMap['hi-wave'];
        let messages = [...messageSet.base];
        
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          messages.push(...messageSet.standard);
        }
        if (userTier === 'PREMIUM') {
          messages.push(...messageSet.premium);
        }

        return messages;
      }

      setupSmartTimingAlgorithm() {
        // Intelligent activity-based inspiration timing
        let activityTimer;
        let engagementLevel = 'low'; // low, medium, high
        
        const calculateEngagementLevel = () => {
          if (this.activityScore > 20) engagementLevel = 'high';
          else if (this.activityScore > 8) engagementLevel = 'medium';
          else engagementLevel = 'low';
        };

        const getSmartInterval = () => {
          const baseIntervals = {
            low: 300000,    // 5 minutes - user needs more encouragement
            medium: 240000, // 4 minutes - balanced engagement
            high: 180000    // 3 minutes - user is active, keep momentum
          };
          const variance = Math.random() * 60000; // ¬±1 minute randomness
          return baseIntervals[engagementLevel] + variance;
        };

        const resetSmartTimer = () => {
          clearTimeout(activityTimer);
          calculateEngagementLevel();
          
          activityTimer = setTimeout(() => {
            if (this.shouldShowSmartMessage()) {
              this.showContextualMessage();
            }
            resetSmartTimer(); // Reset for continuous operation
          }, getSmartInterval());
        };

        // Track meaningful user interactions for engagement scoring
        ['click', 'scroll', 'keypress', 'focus'].forEach(event => {
          document.addEventListener(event, (e) => {
            this.activityScore += this.getActivityWeight(e);
            // Decay activity score over time
            setTimeout(() => { this.activityScore = Math.max(0, this.activityScore - 1); }, 30000);
          }, { passive: true });
        });

        resetSmartTimer();
      }

      getActivityWeight(event) {
        // Weight different activities by engagement value
        const weights = {
          click: 3,     // Deliberate interaction
          scroll: 1,    // Passive engagement
          keypress: 2,  // Active input
          focus: 1      // Attention return
        };
        
        // Bonus weight for meaningful element interactions
        if (event.target) {
          if (event.target.closest('button, .medallion, [data-action]')) {
            return (weights[event.type] || 1) * 2;
          }
        }
        
        return weights[event.type] || 1;
      }

      shouldShowSmartMessage() {
        // Intelligent decision making for message timing
        const now = Date.now();
        const timeSinceLastMessage = now - this.lastShown;
        const minimumInterval = 45000; // 45 seconds absolute minimum
        
        if (timeSinceLastMessage < minimumInterval) return false;
        
        // Don't interrupt if user seems to be in a flow state
        const recentActivityScore = this.activityScore;
        if (recentActivityScore > 25) return false; // High activity = don't interrupt
        
        // Show message if user seems idle or needs encouragement
        if (recentActivityScore < 3 && timeSinceLastMessage > 180000) return true; // Idle user
        
        return true; // Default case
      }

      trackUserEngagementPattern() {
        // Track user behavior patterns for future personalization
        this.engagementPattern = {
          sessionStart: Date.now(),
          totalClicks: 0,
          milestoneActions: 0,
          messageInteractions: 0
        };

        // Track clicks on our floating button
        this.button.addEventListener('click', () => {
          this.engagementPattern.messageInteractions++;
        });

        // Enhanced milestone tracking
        document.addEventListener('click', (e) => {
          this.engagementPattern.totalClicks++;
          
          if (e.target.closest('.medallion, [data-action], button')) {
            this.engagementPattern.milestoneActions++;
          }
        });
      }
    }

    // Initialize floating Hiffirmations system
    const floatingHiffirmations = new FloatingHiffirmations();

    // Tesla-Grade Quote Card Generation System
    class HiQuoteCardGenerator {
      constructor() {
        this.brandColors = {
          primary: '#FFD166',
          secondary: '#F4A261',
          accent: '#E76F51',
          background: '#1E2A4A',
          backgroundSecondary: '#2D4A87',
          text: '#FFFFFF',
          textSecondary: 'rgba(255, 255, 255, 0.8)'
        };
        
        this.socialFormats = {
          instagram_post: { width: 1080, height: 1080 },
          instagram_story: { width: 1080, height: 1920 },
          twitter_card: { width: 1200, height: 675 },
          square: { width: 800, height: 800 } // Default format
        };
      }

      async generateQuoteCard(message, options = {}) {
        const {
          userTier = 'ANONYMOUS',
          format = 'square',
          customBranding = false
        } = options;

        const dimensions = this.socialFormats[format];
        const canvas = this.createCanvas(dimensions.width, dimensions.height);
        const ctx = canvas.getContext('2d');

        // Draw background with tier-specific styling
        await this.drawBackground(ctx, canvas, userTier);
        
        // Draw quote text with smart formatting
        await this.drawQuoteText(ctx, message, canvas, userTier);
        
        // Draw branding and attribution
        await this.drawBranding(ctx, canvas, userTier);
        
        return canvas.toDataURL('image/png', 0.9);
      }

      createCanvas(width, height) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        return canvas;
      }

      async drawBackground(ctx, canvas, userTier) {
        const { width, height } = canvas;
        
        // Create tier-specific gradient backgrounds
        let gradient;
        
        switch(userTier) {
          case 'PREMIUM':
            // Premium: Rich multi-color gradient
            gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, this.brandColors.primary);
            gradient.addColorStop(0.3, this.brandColors.secondary);
            gradient.addColorStop(0.7, this.brandColors.accent);
            gradient.addColorStop(1, this.brandColors.background);
            break;
            
          case 'STANDARD':
            // Standard: Elegant dual gradient
            gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, this.brandColors.background);
            gradient.addColorStop(0.5, this.brandColors.backgroundSecondary);
            gradient.addColorStop(1, this.brandColors.secondary);
            break;
            
          default:
            // Anonymous: Simple, clean gradient
            gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, this.brandColors.background);
            gradient.addColorStop(1, this.brandColors.backgroundSecondary);
        }
        
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, width, height);
        
        // Add subtle texture for Premium users
        if (userTier === 'PREMIUM') {
          this.addPremiumTexture(ctx, canvas);
        }
      }

      addPremiumTexture(ctx, canvas) {
        // Add subtle sparkle texture for premium users
        ctx.globalAlpha = 0.1;
        for (let i = 0; i < 50; i++) {
          const x = Math.random() * canvas.width;
          const y = Math.random() * canvas.height;
          const size = Math.random() * 3 + 1;
          
          ctx.fillStyle = this.brandColors.primary;
          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.globalAlpha = 1;
      }

      async drawQuoteText(ctx, message, canvas, userTier) {
        const { width, height } = canvas;
        const centerX = width / 2;
        const centerY = height / 2;
        
        // Configure font based on tier
        const fontSize = this.getFontSize(message.length, canvas);
        const fontFamily = userTier === 'PREMIUM' ? 
          'Georgia, "Times New Roman", serif' : 
          '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        
        ctx.fillStyle = this.brandColors.text;
        ctx.font = `${fontSize}px ${fontFamily}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        // Smart text wrapping
        const lines = this.wrapText(ctx, message, width * 0.8);
        const lineHeight = fontSize * 1.4;
        const totalTextHeight = lines.length * lineHeight;
        const startY = centerY - (totalTextHeight / 2);
        
        // Draw text with shadow for better readability
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetY = 2;
        
        lines.forEach((line, index) => {
          const y = startY + (index * lineHeight);
          ctx.fillText(line, centerX, y);
        });
        
        // Reset shadow
        ctx.shadowColor = 'transparent';
      }

      getFontSize(textLength, canvas) {
        const baseSize = Math.min(canvas.width, canvas.height) / 20;
        if (textLength < 30) return Math.min(baseSize * 1.2, 48);
        if (textLength < 60) return Math.min(baseSize, 40);
        return Math.min(baseSize * 0.8, 32);
      }

      wrapText(ctx, text, maxWidth) {
        const words = text.split(' ');
        const lines = [];
        let currentLine = '';
        
        for (const word of words) {
          const testLine = currentLine + (currentLine ? ' ' : '') + word;
          const metrics = ctx.measureText(testLine);
          
          if (metrics.width > maxWidth && currentLine !== '') {
            lines.push(currentLine);
            currentLine = word;
          } else {
            currentLine = testLine;
          }
        }
        
        if (currentLine) {
          lines.push(currentLine);
        }
        
        return lines;
      }

      async drawBranding(ctx, canvas, userTier) {
        const { width, height } = canvas;
        
        // Draw Hi logo branding at bottom
        const brandingY = height - 80;
        
        // Load and draw Hi logo
        try {
          const logoImg = new Image();
          logoImg.crossOrigin = 'anonymous';
          
          await new Promise((resolve, reject) => {
            logoImg.onload = resolve;
            logoImg.onerror = () => {
              // Fallback to text if logo fails to load
              ctx.fillStyle = this.brandColors.textSecondary;
              ctx.font = '24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
              ctx.textAlign = 'center';
              ctx.fillText('‚Äî Hi ‚Äî', width / 2, brandingY);
              resolve();
            };
            logoImg.src = 'assets/brand/hi-logo-light.png';
          });
          
          // Draw logo if loaded successfully
          if (logoImg.complete && logoImg.naturalHeight !== 0) {
            const logoSize = 32;
            ctx.drawImage(logoImg, (width / 2) - (logoSize / 2), brandingY - 20, logoSize, logoSize);
          }
        } catch (error) {
          // Fallback to Hi text
          ctx.fillStyle = this.brandColors.primary;
          ctx.font = '28px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('Hi', width / 2, brandingY);
        }
        
        // Add URL
        ctx.font = '18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.fillStyle = this.brandColors.primary;
        ctx.fillText('stay-hi.app', width / 2, brandingY + 35);
        
        // Add tier indicator for Standard/Premium
        if (userTier === 'STANDARD' || userTier === 'PREMIUM') {
          ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
          ctx.fillStyle = this.brandColors.textSecondary;
          const tierText = userTier === 'PREMIUM' ? '‚ú® Premium Member' : '‚≠ê Standard Member';
          ctx.fillText(tierText, width / 2, brandingY - 25);
        }
      }

      async dataURLToBlob(dataURL) {
        return new Promise(resolve => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            canvas.toBlob(resolve, 'image/png', 0.9);
          };
          
          img.src = dataURL;
        });
      }
    }

    // Initialize quote card generator
    window.HiQuoteCardGenerator = new HiQuoteCardGenerator();
  </script>
</body>
</html>/* Cache bust: Thu Nov 13 01:26:01 EST 2025 */
