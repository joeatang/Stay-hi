<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Stay Hi ‚Äî Tesla Simplified</title>

  <!-- HI-OS S-ARCH/1: Webroot Guard (dev-only) -->
  <script>
    // Pass criteria: location.pathname must contain "/public/"
    (function() {
      const PASS = location.pathname.includes('/public/');
      const msg  = PASS ? 'GREEN ‚Äî served from /public (web root OK)'
                        : 'RED ‚Äî NOT served from /public (fix dev server root)';
      // Expose for other verifiers
      window.__HI_WEBROOT_OK = PASS;

      // Console signal
      const tag = '[HI-OS][WEBROOT]';
      if (PASS) {
        console.log(`${tag} ${msg}`);
      } else {
        console.error(`${tag} ${msg}`);
      }

      // Minimal UI badge injection (dev page only)
      try {
        const badge = document.createElement('div');
        badge.textContent = msg;
        badge.setAttribute('id', 'hi-webroot-guard');
        badge.style.position = 'fixed';
        badge.style.bottom = '12px';
        badge.style.right = '12px';
        badge.style.zIndex = '99999';
        badge.style.padding = '8px 10px';
        badge.style.fontFamily = 'system-ui,-apple-system,Segoe UI,Roboto,Arial';
        badge.style.fontSize = '12px';
        badge.style.borderRadius = '6px';
        badge.style.border = PASS ? '1px solid #1f7a1f' : '1px solid #a00';
        badge.style.background = PASS ? '#eaffea' : '#ffecec';
        badge.style.color = PASS ? '#0c540c' : '#7a0000';
        document.body.appendChild(badge);
      } catch (e) {
        console.warn('[HI-OS][WEBROOT] badge inject failed:', e);
      }
    })();
  </script>

  <!-- üì± PWA Configuration -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD166">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Stay Hi">

  <!-- Tesla-Grade Premium Scripts -->
  <script src="assets/url-path-fixer.js"></script>
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" as="script">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  
  <!-- Database & Hi Island Integration -->
  <script src="./lib/HiSupabase.js"></script>
  <script src="assets/db.js"></script>
  
  <!-- üöÄ INTEGRATION #5: HiBase + HiFlags for Streaks system (flagged rollout) -->
  <script src="./lib/flags/HiFlags.js"></script>
  <script src="./lib/hibase/index.js"></script>
  
  <!-- üî• Phase 7: Hi Experience Layer Components (Feature Flagged) -->
  <script src="./lib/hifeed/index.js"></script>
  <script src="./ui/HiFeed/HiFeed.js"></script>
  <script src="./ui/HiStreaks/HiStreaks.js"></script>
  <script src="assets/hifeed-test-helper.js"></script>
  <script src="assets/hifeed-verification.js"></script>
  
  <!-- HiBase Integration (Flagged Rollout) -->
  <script type="module">
    // Import HiBase shares for flagged rollout
    window.HiBase_shares = await import('./lib/hibase/shares.js');
    console.log('üî• HiBase shares module loaded for dashboard integration');
  </script>
  
  <!-- HI-OS: Tesla-Grade HiMetrics Adapter (30s Cache + Dashboard Globals) -->
  <script type="module">
    import HiMetrics from './lib/HiMetrics.js';
    
    // Tesla-grade dashboard metrics with global variable compatibility
    async function initDashboardMetrics() {
      try {
        console.log('[Dashboard] Initializing HiMetrics adapter...');
        
        // Subscribe to metric updates for live dashboard
        const unsubscribe = HiMetrics.subscribe('dashboard-page', (metrics, cacheInfo) => {
          console.log('[Dashboard] Metrics updated:', metrics);
          
          // Update global variables for legacy dashboard code compatibility
          window.gWaves = metrics.waves || 0;
          window.gTotalHis = metrics.hi5s || 0;
          window.gUsers = 0; // Legacy fallback - not separated yet
          
          // Update debug badge (show during development)
          if (window.location.hostname === 'localhost' || window.location.search.includes('debug=1')) {
            const debugEl = document.getElementById('hiMetricsDebugDash');
            const statusEl = document.getElementById('dashMetricsStatus');
            const cacheEl = document.getElementById('dashCacheAge');
            
            if (debugEl && statusEl && cacheEl) {
              debugEl.style.display = 'block';
              statusEl.textContent = cacheInfo?.fromCache ? '‚úÖ' : 'üîÑ';
              cacheEl.textContent = `Cache: ${cacheInfo?.ageSeconds || 0}s`;
            }
          }
          
          // Trigger UI update if legacy function exists
          if (window.updateGlobalStats) {
            window.updateGlobalStats();
          }
          
          // Load user streak data if function exists
          if (window.loadUserStreak) {
            window.loadUserStreak();
          }
        });
        
        // Load initial metrics (will use cache if available)
        const metrics = await HiMetrics.load();
        console.log('[Dashboard] ‚úÖ HiMetrics adapter initialized with globals', {
          gWaves: window.gWaves,
          gTotalHis: window.gTotalHis,
          gUsers: window.gUsers
        });
        
        // Store unsubscribe function for cleanup
        window.dashboardMetricsCleanup = unsubscribe;
        
        // Make legacy loader available for compatibility
        window.hiStatsLoader = () => HiMetrics.load();
        
      } catch (error) {
        console.error('[Dashboard] HiMetrics initialization failed:', error);
        
        // Legacy fallback for safety
        try {
          if (window.HiBase?.stats?.getMetrics) {
            const metrics = await window.HiBase.stats.getMetrics();
            window.gWaves = metrics.waves?.data || 0;
            window.gTotalHis = metrics.hi5s?.data || 0;
            window.gUsers = 0;
            
            if (window.updateGlobalStats) {
              window.updateGlobalStats();
            }
            
            console.log('[Dashboard] ‚úÖ Fallback stats loaded');
          }
        } catch (fallbackError) {
          console.error('[Dashboard] Fallback also failed:', fallbackError);
        }
      }
    }
    
    // Initialize when DOM is ready
    window.addEventListener('DOMContentLoaded', initDashboardMetrics);
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (window.dashboardMetricsCleanup) {
        window.dashboardMetricsCleanup();
        console.log('[Dashboard] HiMetrics subscription cleaned up');
      }
    });
  </script>
  
  <!-- Premium Authentication & UX -->
  <script src="assets/progressive-auth.js"></script>
  <script src="assets/anonymous-access-modal.js"></script>
  <script src="./lib/HiMembership.js"></script>
  <script src="assets/performance-manager.js"></script>
  
  <!-- Tesla-Grade Onboarding System -->
  <script src="assets/onboarding.js"></script>
  
  <!-- Premium CSS Integration -->
  <link rel="preload" href="assets/premium-ux.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="assets/premium-calendar.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="./ui/HiFooter/HiFooter.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="./ui/HiModal/HiModal.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  <!-- Hi Share Sheet Component -->
  <link rel="preload" href="ui/HiShareSheet/HiShareSheet.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  <!-- HI DEV: Tesla-Grade HiMedallion Component -->
  <link rel="preload" href="ui/HiMedallion/HiMedallion.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  <noscript>
    <link rel="stylesheet" href="assets/premium-ux.css">
    <link rel="stylesheet" href="assets/premium-calendar.css">
    <link rel="stylesheet" href="ui/HiFooter/HiFooter.css">
    <link rel="stylesheet" href="ui/HiModal/HiModal.css">
    <link rel="stylesheet" href="ui/HiShareSheet/HiShareSheet.css">
    <link rel="stylesheet" href="ui/HiMedallion/HiMedallion.css">
  </noscript>

  <!-- HI DEV: Fast Brand Controls - Page-Specific Medallion Overrides -->
  <style>
    :root {
      /* Dashboard page flavor - energetic, action-oriented gradient */
      --hi-medallion-bg1: #FF9A3C;   /* warmer top */
      --hi-medallion-bg2: #D84B8A;   /* richer bottom */
      --hi-medallion-halo: rgba(255,255,255,0.22);
    }
    
    body {
      background: linear-gradient(135deg, #2d1e4f 0%, #ff7a18 60%, #ffd166 100%);
      min-height: 100vh;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow-x: hidden;
    }

    /* Tesla-Grade Header with Mini Stats */
    .tesla-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
    }

    .header-left {
      display: flex;
      align-items: center;
      width: 60px; /* Fixed width for symmetry */
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      width: 60px; /* Fixed width for symmetry */
    }

    .brand-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-hi-logo {
      width: 24px;
      height: 24px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .brand-text {
      font-size: 18px;
      font-weight: 600;
      color: #FFD166;
      letter-spacing: -0.5px;
    }

    .calendar-btn, .menu-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: #FFD166;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .calendar-btn:hover, .menu-btn:hover {
      background: rgba(255, 209, 102, 0.2);
      transform: translateY(-1px);
    }

    /* Global Stats Container */
    .global-stats-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0 30px;
      flex-wrap: wrap;
    }

    .global-stat {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      min-width: 100px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .global-stat:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
      font-size: 18px;
    }

    .stat-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .stat-number {
      font-size: 18px;
      font-weight: 700;
      color: #FFD166;
      line-height: 1;
    }

    .stat-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    /* Main Content Area */
    .main-content {
      margin-top: 80px;
      padding: 20px 20px 100px; /* Extra bottom padding for footer */
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: calc(100vh - 180px); /* Account for header + footer */
    }



    /* Hi Medallion Section */
    .hi-medallion-section {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
      margin: 20px 0;
      padding: 20px;
    }

    /* Enhanced Self Hi5 Button */
    .self-hi5-enhanced {
      margin: 30px 0;
      padding: 16px 32px;
      background: linear-gradient(135deg, #FF7A18 0%, #FFD166 100%);
      border: none;
      border-radius: 50px;
      color: #1a1a2e;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px rgba(255, 122, 24, 0.3);
      min-width: 180px;
    }

    .self-hi5-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(255, 122, 24, 0.4);
    }

    .self-hi5-enhanced:active {
      transform: translateY(0px);
    }

    /* Hiffirmations Modal Trigger */
    .hiffirmations-trigger {
      margin: 20px 0;
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .hiffirmations-trigger:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    /* Tesla-Grade Animation Classes */
    .pulse-simplified {
      animation: pulse-simplified 0.6s ease-out;
    }

    @keyframes pulse-simplified {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .logo-pop-simplified {
      animation: logo-pop-simplified 0.4s ease-out;
    }

    @keyframes logo-pop-simplified {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    /* Tesla-Grade Logo Animation Class */
    .logo-animation-wrapper.logo-pop-simplified {
      animation: logo-pop-simplified 0.4s ease-out;
    }

    /* Emoji Burst Animation */
    @keyframes waveUp-simplified {
      0% {
        transform: translate(-50%, -50%) translateX(0) translateY(0) scale(var(--s, 1));
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) translateX(var(--dx, 0)) translateY(-80px) scale(0.3);
        opacity: 0;
      }
    }

    /* Mobile Optimizations */
    @media (max-width: 480px) {
      .tesla-header {
        padding: 0 16px;
      }
      
      .header-left {
        gap: 12px;
      }
      
      .calendar-btn {
        width: 36px;
        height: 36px;
      }
      
      .tesla-logo {
        font-size: 16px;
      }
      
      .mini-stats {
        gap: 8px;
        font-size: 11px;
      }
      
      .mini-stat {
        padding: 3px 6px;
      }
      
      .hi-medal-simplified {
        width: min(180px, 45vw);
      }
      
      .self-hi5-enhanced {
        padding: 14px 28px;
        font-size: 16px;
        min-width: 160px;
      }
      
      .main-content {
        padding: 16px 16px 100px;
      }
    }

    /* Large screen optimizations */
    @media (min-width: 768px) {
      .main-content {
        padding: 40px 20px 120px;
      }
      
      .hi-medal-simplified {
        width: min(240px, 35vw);
      }
    }

    /* Navigation Modal */
    .navigation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .navigation-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .navigation-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .navigation-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(400px, 90vw);
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 24px;
      padding: 24px;
      color: white;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .navigation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .navigation-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #FFD166;
    }

    .close-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-nav-btn:hover {
      background: rgba(255, 0, 0, 0.2);
    }

    .navigation-menu {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .nav-section-title {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      text-decoration: none;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .nav-item.admin-item {
      background: rgba(255, 215, 0, 0.1);
      border-color: rgba(255, 215, 0, 0.2);
    }

    .nav-item.admin-item:hover {
      background: rgba(255, 215, 0, 0.2);
    }

    .nav-icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    /* Enhanced Weekly Progress Strip */
    .weekstrip {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 20px 0 30px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .weekdot {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 45px;
      transition: all 0.3s ease;
    }
    
    .weekdot:hover {
      transform: translateY(-2px);
    }
    
    .weekdot .lbl {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .weekdot .c {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 13px;
      font-weight: 600;
      border: 2px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.6);
      transition: all 0.3s ease;
    }
    
    .weekdot .c.met {
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
    }
    
    .weekdot .c.today {
      border-color: #FFD166;
      box-shadow: 0 0 0 2px rgba(255, 209, 102, 0.3);
    }

    /* üî• Hi Experience Layer Styles */
    #hiExperienceLayer {
      margin: 2rem 0;
    }

    .hi-experience-section {
      margin-bottom: 2rem;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
      overflow: hidden;
    }

    /* Responsive adjustments for experience layer */
    @media (max-width: 768px) {
      .hi-experience-section {
        margin: 1rem 0.5rem;
        border-radius: 0.75rem;
      }
    }
  </style>
</head>

<body data-page="hi-dashboard">
  <!-- Tesla-Grade Header with Centered Branding -->
  <header class="tesla-header">
    <div class="header-left">
      <button id="btnCal" class="calendar-btn" aria-label="Open calendar" title="View Hi Calendar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="3" ry="3"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      </button>
    </div>
    
    <!-- Centered Brand with Hi Logo -->
    <div class="header-center">
      <div class="brand-container">
        <img src="assets/brand/hi-logo-light.png" alt="Hi" class="brand-hi-logo" />
        <span class="brand-text">Stay Hi</span>
      </div>
    </div>
    
    <!-- Navigation Menu -->
    <div class="header-right">
      <button id="btnMenu" class="menu-btn" aria-label="Open menu" title="Navigation Menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </header>

  <!-- S-DASH Flag-Gated DOM Anchors (Hidden Placeholders) -->
  <script>
    (async function initSDashAnchors() {
      try {
        // Wait for HiFlags to be available
        if (window.HiFlags) {
          const flags = await Promise.all([
            window.HiFlags.getFlag('hi_dash_v3', false),
            window.HiFlags.getFlag('hi_dash_stats_row_v1', false),
            window.HiFlags.getFlag('hi_dash_medallion_cta_v1', false),
            window.HiFlags.getFlag('hi_dash_share_cta_v1', false),
            window.HiFlags.getFlag('hi_dash_global_pill_v1', false)
          ]);
          
          const [dashV3, statsRow, medallionCta, shareCta, globalPill] = flags;
          
          // Only add anchors if hi_dash_v3 is enabled
          if (dashV3) {
            const container = document.createElement('div');
            container.id = 'sDashAnchors';
            container.style.display = 'none'; // Hidden placeholders
            
            let html = '';
            
            // Add statsRow and its children if flag enabled
            if (statsRow) {
              html += '<div id="statsRow"><div id="statTotal"></div><div id="stat7d"></div><div id="statStreak"></div></div>';
            }
            
            // Add medallion anchor if flag enabled
            if (medallionCta) {
              html += '<div id="hiMedallion"></div>';
            }
            
            // Add share button anchor if flag enabled
            if (shareCta) {
              html += '<button id="giveHiBtn"></button>';
            }
            
            // Add global pill anchor if flag enabled
            if (globalPill) {
              html += '<div id="globalPill"></div>';
            }
            
            container.innerHTML = html;
            document.body.appendChild(container);
            
            console.log('[S-DASH] Flag-gated anchors added:', { dashV3, statsRow, medallionCta, shareCta, globalPill });
          }
        }
      } catch (error) {
        console.warn('[S-DASH] Flag anchor setup failed:', error);
      }
    })();
  </script>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Global Stats Above Weekly Progress -->
    <div class="global-stats-container">
      <div class="global-stat">
        <span class="stat-icon">üëã</span>
        <div class="stat-content">
          <span class="stat-number" id="globalHiWaves">...</span>
          <span class="stat-label">Hi Waves</span>
        </div>
      </div>
      <div class="global-stat">
        <span class="stat-icon">üî•</span>
        <div class="stat-content">
          <span class="stat-number" id="globalTotalHis">13</span>
          <span class="stat-label">Total His</span>
        </div>
      </div>
      <div class="global-stat">
        <span class="stat-icon">üë•</span>
        <div class="stat-content">
          <span class="stat-number" id="globalUsers">8</span>
          <span class="stat-label">Users</span>
        </div>
      </div>
      <div class="global-stat">
        <span class="stat-icon">‚ö°</span>
        <div class="stat-content">
          <span class="stat-number" id="userStreak">0</span>
          <span class="stat-label">Streak</span>
        </div>
      </div>
      <!-- HiMetrics Debug Badge -->
      <div class="global-stat" id="hiMetricsDebugDash" style="display: none; opacity: 0.7; font-size: 0.8rem;">
        <span class="stat-icon">üîß</span>
        <div class="stat-content">
          <span class="stat-number" id="dashMetricsStatus">init</span>
          <span class="stat-label" id="dashCacheAge">Cache: 0s</span>
        </div>
      </div>
    </div>
    
    <!-- HI DEV: Tesla-Grade HiMedallion Component -->
    <div id="hiMedallionContainer" class="hi-medallion-section"></div>
    
    <!-- Weekly Progress Strip -->
    <div id="weekStrip" class="weekstrip" aria-label="Your week"></div>

    <!-- üî• NEW: Hi Experience Layer Components (Feature Flagged) -->
    <div id="hiExperienceLayer" style="display: none;">
      <!-- HiFeed Component Container -->
      <div id="hiFeedContainer" class="hi-experience-section"></div>
      
      <!-- HiStreaks Component Container -->
      <div id="hiStreaksContainer" class="hi-experience-section"></div>
    </div>



    <!-- Enhanced Self Hi5 Button -->
    <button class="self-hi5-enhanced" id="selfHi5Enhanced">
      üôå Give Yourself a Hi5
    </button>

    <!-- Hiffirmations Modal Trigger -->
    <button class="hiffirmations-trigger" id="hiffirmationsTrigger">
      ‚ú® Daily Hiffirmations
    </button>
  </main>

  <!-- Navigation Menu Modal -->
  <div id="navigationModal" class="navigation-modal" style="display: none;">
    <div class="navigation-backdrop" id="navigationBackdrop"></div>
    <div class="navigation-content">
      <div class="navigation-header">
        <h3>Stay Hi Navigation</h3>
        <button id="closeNavigation" class="close-nav-btn">‚úï</button>
      </div>
      <div class="navigation-menu">
        <div class="nav-section">
          <div class="nav-section-title">Navigate</div>
          <a href="index.html" class="nav-item">
            <span class="nav-icon">üè†</span>
            <span>Hi Today</span>
          </a>
          <a href="hi-island-NEW.html" class="nav-item">
            <span class="nav-icon">üèùÔ∏è</span>
            <span>Hi Island</span>
          </a>
          <a href="hi-muscle.html" class="nav-item">
            <span class="nav-icon">üí™</span>
            <span>Hi Gym</span>
          </a>
          <a href="profile.html?from=hi-dashboard.html" class="nav-item">
            <span class="nav-icon">üë§</span>
            <span>Profile</span>
          </a>
        </div>
        <div class="nav-section" id="adminSection" style="display: none;">
          <div class="nav-section-title">Admin</div>
          <a href="hi-mission-control.html" class="nav-item admin-item">
            <span class="nav-icon">üéõÔ∏è</span>
            <span>Hi Mission Control</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tesla-Grade Simplified JavaScript
    // HI-OS: Stats variables now managed by initHiStatsOnce() system
    // Global variables declared in the init guard module above
    let clickAnimationFrame = null;

    // DOM Elements
    const selfHi5Enhanced = document.getElementById('selfHi5Enhanced');
    const hiffirmationsTrigger = document.getElementById('hiffirmationsTrigger');

    // Header stats elements
    const headerHiWaves = document.getElementById('headerHiWaves');
    const headerTotalHis = document.getElementById('headerTotalHis');
    const headerUsers = document.getElementById('headerUsers');

    // Tesla-Grade Database Integration
    async function initializeDatabase() {
      try {
        if (typeof supabase !== 'undefined') {
          console.log('üéØ SURGICAL: Initializing Supabase client for hostname:', window.location.hostname);
          const { createClient } = supabase;
          window.db = createClient(
            'https://gfcubvroxgfvjhacinic.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmY3VidnJveGdmdmpoYWNpbmljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MTIyNjYsImV4cCI6MjA3NDQ4ODI2Nn0.5IlxofMPFNdKsEueM_dhgsJP9wI-GnZRUM9hfR0zE1g'
          );
          
          // HI-OS: Database connection established, stats handled by init guard
          console.log('‚úÖ Database connection ready for stats system');
        }
      } catch (error) {
        console.error('‚ùå Database connection failed:', error);
      }
      
      // HI-OS: Stats loading now handled by initHiStatsOnce() guard system
      // No direct function calls here to prevent duplicates
      console.log('üìä Dashboard init complete - stats handled by initHiStatsOnce()');
    }

    // HI-OS: Legacy loadMetricsFromHiBase function - REMOVED
    // This has been replaced by the unified stats init guard system
    // All stats loading now happens via initHiStatsOnce() to prevent duplicates

    // üöÄ INTEGRATION #5: Load user streak via HiBase (flagged rollout)
    async function loadUserStreak() {
      try {
        const useHiBaseStreaks = await window.HiFlags?.getFlag('hibase_streaks_enabled');
        console.log(`üîÑ Streak loading via ${useHiBaseStreaks ? 'HiBase' : 'legacy'} path`);

        if (useHiBaseStreaks) {
          // üéØ HiBase path: unified streak API
          console.log('üì¶ Streak ‚Üí HiBase.getUserStreak...');
          const currentUser = window.hiAuth?.getCurrentUser?.() || { id: 'anonymous' };
          
          if (currentUser.id && currentUser.id !== 'anonymous') {
            const streakResult = await window.HiBase.getUserStreak(currentUser.id);

            if (streakResult.error) {
              console.warn('‚ö†Ô∏è HiBase streak loading failed:', streakResult.error);
              updateStreakDisplay(0);
            } else {
              const currentStreak = streakResult.data.streak?.current || 0;
              console.log('‚úÖ Streak loaded via HiBase:', currentStreak);
              updateStreakDisplay(currentStreak);
            }
          } else {
            // Anonymous user - no streak
            updateStreakDisplay(0);
          }

          // üìä Track HiBase streak usage
          import('./lib/monitoring/HiMonitor.js').then(m => 
            m.trackEvent('streak_load', { 
              source: 'dashboard', 
              path: 'hibase'
            })
          ).catch(() => {});

        } else {
          // üîÑ Legacy path: load from localStorage or other system
          console.log('üì¶ Streak ‚Üí Legacy loading...');
          
          // Legacy streak loading - could be from localStorage or existing system
          const localStreak = localStorage.getItem('user_current_streak') || '0';
          updateStreakDisplay(parseInt(localStreak, 10));
          
          // üìä Track legacy streak usage
          import('./lib/monitoring/HiMonitor.js').then(m => 
            m.trackEvent('streak_load', { 
              source: 'dashboard', 
              path: 'legacy'
            })
          ).catch(() => {});
        }

      } catch (error) {
        console.warn('‚ö†Ô∏è Streak loading failed:', error);
        updateStreakDisplay(0);
      }
    }

    // Update streak display in UI
    function updateStreakDisplay(streak) {
      const streakElement = document.getElementById('userStreak');
      if (streakElement) {
        streakElement.textContent = streak;
        
        // Add visual effects for high streaks
        if (streak >= 7) {
          streakElement.style.background = 'linear-gradient(45deg, #ff6b6b, #ffd93d)';
          streakElement.style.webkitBackgroundClip = 'text';
          streakElement.style.webkitTextFillColor = 'transparent';
        } else if (streak >= 3) {
          streakElement.style.color = '#ffd93d';
        } else {
          streakElement.style.color = '';
          streakElement.style.background = '';
          streakElement.style.webkitBackgroundClip = '';
          streakElement.style.webkitTextFillColor = '';
        }
      }
    }

    // Show error state for consistency
    function showStatsError() {
      const elements = ['globalHiWaves', 'globalTotalHis', 'globalUsers'];
      elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = 'Error';
          element.style.color = '#ff6b6b';
        }
      });
    }

    // üéØ SURGICAL: Anti-lag stats display with instant placeholders
    function updateGlobalStats() {
      const globalHiWaves = document.getElementById('globalHiWaves');
      const globalTotalHis = document.getElementById('globalTotalHis');
      const globalUsers = document.getElementById('globalUsers');
      
      // üöÄ INSTANT DISPLAY: Show placeholders immediately if loading
      if (globalHiWaves) {
        if (gWaves !== null && gWaves !== undefined) {
          globalHiWaves.textContent = gWaves.toLocaleString();
        } else if (globalHiWaves.textContent === '...' || globalHiWaves.textContent === '') {
          globalHiWaves.textContent = '...';
        }
      }
      
      if (globalTotalHis) {
        if (gTotalHis !== null && gTotalHis !== undefined) {
          globalTotalHis.textContent = gTotalHis.toLocaleString();
        } else if (globalTotalHis.textContent === '...' || globalTotalHis.textContent === '') {
          globalTotalHis.textContent = '...';
        }
      }
      
      if (globalUsers) {
        if (gUsers !== null && gUsers !== undefined) {
          globalUsers.textContent = gUsers.toLocaleString();
        } else if (globalUsers.textContent === '...' || globalUsers.textContent === '') {
          globalUsers.textContent = '...';
        }
      }
    }

    // METRICS SEPARATION: Hi Wave Increment (medallion taps ‚Üí hi_events table only)
    async function incrementHiWave() {
      try {
        // Check if metrics separation is enabled via feature flag
        const useMetricsSeparation = await window.HiFlags?.getFlag('metrics_separation_enabled', true);
        
        if (!useMetricsSeparation) {
          console.log('üéØ Metrics separation disabled, using legacy medallion tracking...');
          // Fallback to legacy system (preserved for rollback)
          if (window.HiUnifiedStats?.trackMedallionTap) {
            return await window.HiUnifiedStats.trackMedallionTap();
          }
          return;
        }
        
        console.log('üéØ METRICS SEPARATION: Medallion tapped on hi-dashboard');
        
        // Use basic medallion tap tracking (Database deployment required)
        if (window.HiBase?.stats?.insertMedallionTap) {
          console.log('üéØ Using Hi Medallion tap tracking...');
          
          // Get current user (null for anonymous)
          const user = window.HiBase?.auth?.getCurrentUser();
          const userId = user?.data?.id || null;
          
          const result = await window.HiBase.stats.insertMedallionTap(userId);
          
          if (result.error) {
            console.error('‚ùå Medallion tap failed:', result.error);
            return;
          }
          
          console.log('‚úÖ HI MEDALLION TAP SUCCESS:', {
            newWaveCount: result.data,
            isAuthenticated: !!userId
          });
          
          // Refresh dashboard metrics to show updated global waves
          setTimeout(loadMetricsFromHiBase, 100);
          
        } else {
          console.error('‚ùå METRICS SEPARATION ERROR: HiBase.stats not available');
        }
      } catch (error) {
        console.error('üí• METRICS SEPARATION FAILURE: Medallion tap failed:', error);
      }
    }



    // HI DEV: Hi5 Counter (separate from HiWave medallion taps)
    async function incrementHi5Counter() {
      try {
        // Update Hi5 counter in localStorage and database
        const currentCount = parseInt(localStorage.getItem('hi5_count') || '0');
        const newCount = currentCount + 1;
        localStorage.setItem('hi5_count', newCount.toString());
        
        // Update database if available
        if (window.hiDB?.updateUserStats) {
          await window.hiDB.updateUserStats('hi5_count', newCount);
        }
        
        console.log('[HI DEV] Hi5 counter incremented to:', newCount);
        
        // Update UI display if element exists
        const hi5CountElement = document.querySelector('.hi5-count');
        if (hi5CountElement) {
          hi5CountElement.textContent = newCount;
        }
        
      } catch (error) {
        console.error('[HI DEV] Failed to increment Hi5 counter:', error);
      }
    }

    // Enhanced Self Hi5 Handler (HI DEV: Enforced Hi5 flow)
    function setupSelfHi5Handler() {
      if (!selfHi5Enhanced) return;
      
      // HI DEV: Dedupe handlers - only bind once
      if (selfHi5Enhanced.__hi5HandlerBound) {
        console.log('[HI DEV] Hi5 handler already bound, skipping duplicate');
        return;
      }
      selfHi5Enhanced.__hi5HandlerBound = true;

      selfHi5Enhanced.addEventListener('click', async (e) => {
        e.preventDefault();
        
        try { 
          navigator?.vibrate?.(50); 
        } catch {}

        // Visual feedback
        selfHi5Enhanced.style.transform = 'scale(0.95)';
        setTimeout(() => {
          selfHi5Enhanced.style.transform = '';
        }, 150);

        // HI DEV: Use existing HiShareSheet instance (Tesla-grade single initialization)
        try {
          // Get the globally initialized HiShareSheet instance
          const shareSheetInstance = window.__hiComponentsInitialized?.shareSheetInstance;
          
          if (!shareSheetInstance) {
            throw new Error('HiShareSheet not initialized');
          }
          
          // Configure success handler for Hi5 flow
          shareSheetInstance.updateOptions({
            onSuccess: async (shareData) => {
              console.log('[HI DEV] Hi5 share submitted via Share Sheet:', shareData);
              
              // HI DEV: Increment Hi5 counter on successful submit ONLY
              await incrementHi5Counter();
              
              // HI DEV: Analytics via HiMonitor.trackEvent
              const { trackEvent } = await import('./lib/monitoring/HiMonitor.js');
              trackEvent('hi5_submit', {
                visibility: shareData.visibility,
                path: shareData.hibaseEnabled ? 'hibase' : 'legacy'
              });
            }
          });

          // Open with Hi5 context (centered modal)
          shareSheetInstance.open({
            context: 'dashboard',
            preset: 'hi5',
            prefilledText: 'üôå Giving myself a Hi5! ',
            type: 'Hi5'
          });
          
        } catch (error) {
          console.error('[HI DEV] Failed to open HiShareSheet for Hi5:', error);
          // HI DEV: NO fallback to HiWave - Hi5 and HiWave are separate flows
          // Show error message to user instead
          const errorMsg = document.createElement('div');
          errorMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#ff4444;color:white;padding:12px;border-radius:8px;z-index:9999;';
          errorMsg.textContent = 'Hi5 Share Sheet failed to load. Please try again.';
          document.body.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 3000);
        }
        
        // HI DEV: All Hi5 submission logic moved to HiShareSheet.persist()
        // This keeps the flow clean and maintains separation of concerns
      });
    }

    // Navigation Menu Handler
    function setupNavigationHandler() {
      const btnMenu = document.getElementById('btnMenu');
      const navigationModal = document.getElementById('navigationModal');
      const navigationBackdrop = document.getElementById('navigationBackdrop');
      const closeNavigation = document.getElementById('closeNavigation');

      if (!btnMenu || !navigationModal) return;

      const openNavigation = () => {
        navigationModal.classList.add('show');
        navigationModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Show admin section if user is admin (basic check)
        const adminSection = document.getElementById('adminSection');
        if (adminSection && (localStorage.getItem('isAdmin') === 'true' || window.location.href.includes('admin'))) {
          adminSection.style.display = 'block';
        }
      };

      const closeNavigationModal = () => {
        navigationModal.classList.remove('show');
        document.body.style.overflow = '';
        setTimeout(() => {
          if (!navigationModal.classList.contains('show')) {
            navigationModal.style.display = 'none';
          }
        }, 300);
      };

      btnMenu.addEventListener('click', openNavigation);
      closeNavigation.addEventListener('click', closeNavigationModal);
      navigationBackdrop.addEventListener('click', closeNavigationModal);
      
      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && navigationModal.classList.contains('show')) {
          closeNavigationModal();
        }
      });
    }

    // Hiffirmations Modal Handler
    function setupHiffirmationsHandler() {
      if (!hiffirmationsTrigger) return;

      hiffirmationsTrigger.addEventListener('click', (e) => {
        e.preventDefault();
        showHiffirmationsModal();
      });
    }

    // Tesla-Grade Daily Hiffirmation Generator (Consistent Daily Messages)
    function getDailyHiffirmation(date = new Date()) {
      const key = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
      let hash = 0;
      for (let i = 0; i < key.length; i++) {
        hash = (hash * 31 + key.charCodeAt(i)) | 0;
      }
      
      const hiffirmations = [
        "‚ú® You're radiating positive energy today",
        "üåü Your Hi moments create ripples of joy", 
        "üí´ You have the power to brighten someone's day",
        "üî• Your authentic self is your superpower",
        "üåà Every Hi you share makes the world brighter",
        "‚≠ê You're exactly where you need to be",
        "üíù Your presence is a gift to those around you",
        "üå∫ You're growing stronger with each Hi moment",
        "üéØ Trust your journey, you're doing amazing",
        "üíé Your unique light can't be dimmed",
        "üöÄ Your potential is limitless and inspiring",
        "üå∏ You bring beauty to every moment",
        "‚ö° Your energy lights up the room",
        "üèîÔ∏è You're stronger than any challenge",
        "üé® Your creativity makes the world more colorful",
        "üåä You flow with grace through life's changes",
        "üîÆ Your intuition guides you perfectly",
        "ü¶ã You're transforming into your best self",
        "üåÖ Each day brings new opportunities for you",
        "üí™ Your resilience is truly remarkable",
        "üéµ Your soul sings a beautiful melody",
        "üåü You're a beacon of hope for others",
        "üïäÔ∏è Peace follows you wherever you go",
        "üî• Your passion ignites positive change",
        "üåª You're growing toward the light every day",
        "‚≠ê Your dreams are valid and achievable",
        "üéØ You're aligned with your highest purpose",
        "üí´ Magic happens when you believe in yourself",
        "üåà You create your own beautiful reality",
        "ü¶Ñ Your uniqueness is your greatest strength"
      ];
      
      const dailyHiffirmation = hiffirmations[Math.abs(hash % hiffirmations.length)];
      return dailyHiffirmation;
    }

    // Get countdown to next Hiffirmation (midnight local time)
    function getNextHiffirmationCountdown() {
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(0, 0, 0, 0);
      
      const timeLeft = tomorrow - now;
      const hours = Math.floor(timeLeft / (1000 * 60 * 60));
      const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
      
      return { hours, minutes, timeLeft };
    }

    // Premium Hiffirmations Modal
    function showHiffirmationsModal(customDate = null) {
      const targetDate = customDate || new Date();
      const dailyHiffirmation = getDailyHiffirmation(targetDate);
      const countdown = getNextHiffirmationCountdown();
      
      // Date display for non-today dates
      const isToday = !customDate || (
        targetDate.toDateString() === new Date().toDateString()
      );
      const dateLabel = isToday ? 'Today' : targetDate.toLocaleDateString('en-US', { 
        weekday: 'long', 
        month: 'short', 
        day: 'numeric' 
      });

      // Create modal with premium styling
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 15000;
        display: flex; align-items: center; justify-content: center;
        background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);
      `;
      
      modal.innerHTML = `
        <div style="
          background: rgba(15, 16, 34, 0.95); backdrop-filter: blur(25px);
          border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 24px;
          padding: 32px; max-width: 400px; width: 90vw; text-align: center; color: white;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); position: relative;
        ">
          <h3 style="margin: 0 0 8px; color: #FFD166; font-size: 24px;">‚ú® ${isToday ? 'Daily' : dateLabel} Hiffirmation</h3>
          
          <!-- Countdown Timer (only for today) -->
          ${isToday ? `
          <div style="
            font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 20px;
            padding: 8px 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
          ">
            Next Hiffirmation in ${countdown.hours}h ${countdown.minutes}m
          </div>
          ` : ''}
          
          <!-- Daily Message -->
          <div style="font-size: 18px; line-height: 1.5; margin: 24px 0; color: rgba(255, 255, 255, 0.9);">
            ${dailyHiffirmation}
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
            <button class="hiffirmation-share" style="
              padding: 12px 20px; background: linear-gradient(135deg, #4ECDC4, #44A08D);
              border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer;
              transition: transform 0.2s ease;
            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
              Share This
            </button>
            <button class="hiffirmation-yesterday" style="
              padding: 12px 20px; background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; 
              color: white; font-weight: 600; cursor: pointer;
              transition: all 0.2s ease;
            " onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
              Yesterday's
            </button>
          </div>
          
          <!-- Close Button -->
          <button class="close-hiffirmation" style="
            position: absolute; top: 16px; right: 16px; width: 32px; height: 32px;
            border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.1);
            color: white; cursor: pointer; font-size: 16px;
            transition: background 0.2s ease;
          " onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
            ‚úï
          </button>
        </div>
      `;

      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';

      // Event handlers
      const closeModal = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      };

      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
      modal.querySelector('.close-hiffirmation').addEventListener('click', closeModal);
      
      // Yesterday's Hiffirmation button
      modal.querySelector('.hiffirmation-yesterday').addEventListener('click', () => {
        closeModal();
        setTimeout(() => {
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          showHiffirmationsModal(yesterday);
        }, 100);
      });
      
      // Share button
      modal.querySelector('.hiffirmation-share').addEventListener('click', () => {
        if (navigator.share) {
          navigator.share({
            title: 'Daily Hiffirmation from Stay Hi',
            text: dailyHiffirmation,
            url: window.location.href
          });
        } else {
          navigator.clipboard.writeText(dailyHiffirmation);
          // Visual feedback
          const shareBtn = modal.querySelector('.hiffirmation-share');
          const originalText = shareBtn.textContent;
          shareBtn.textContent = '‚úì Copied!';
          shareBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
          setTimeout(() => {
            shareBtn.textContent = originalText;
            shareBtn.style.background = 'linear-gradient(135deg, #4ECDC4, #44A08D)';
          }, 1500);
        }
      });
    }

    // Weekly Progress Strip (Simplified)
    function setupWeeklyProgress() {
      const weekStrip = document.getElementById('weekStrip');
      if (!weekStrip) return;

      const today = new Date();
      let html = '';
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const label = date.toLocaleDateString(undefined, { weekday: 'short' }).toUpperCase();
        const dayNum = date.getDate();
        const isToday = i === 0;
        const metClass = Math.random() > 0.3 ? 'met' : '';  // Simplified logic
        
        html += `<div class="weekdot">
          <div class="lbl">${label}</div>
          <div class="c ${metClass}">${dayNum}</div>
        </div>`;
      }
      
      weekStrip.innerHTML = html;
    }

    // üåç Helper: Get current user location for hi island piping
    async function getCurrentUserLocation() {
      try {
        // Check localStorage cache first
        const cached = localStorage.getItem('hi_user_location');
        if (cached) {
          const locationData = JSON.parse(cached);
          if (Date.now() - locationData.timestamp < 24 * 60 * 60 * 1000) { // 24 hour cache
            return locationData.location;
          }
        }
        
        // Default to 'Virtual Hi Island' for dashboard hi5s
        return 'Virtual Hi Island';
      } catch (error) {
        console.warn('Location lookup failed, using default:', error);
        return 'Virtual Hi Island';
      }
    }

    // üéâ Helper: Show celebration message
    function showCelebrationMessage(message) {
      // Create temporary celebration overlay
      const celebration = document.createElement('div');
      celebration.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #FFD166, #FF7B24);
        color: #000;
        padding: 20px 30px;
        border-radius: 20px;
        font-size: 18px;
        font-weight: 600;
        box-shadow: 0 10px 30px rgba(255, 123, 24, 0.4);
        z-index: 10000;
        animation: celebrationPop 2s ease-out forwards;
      `;
      celebration.textContent = message;
      
      // Add animation keyframes
      if (!document.getElementById('celebrationStyles')) {
        const style = document.createElement('style');
        style.id = 'celebrationStyles';
        style.textContent = `
          @keyframes celebrationPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(celebration);
      setTimeout(() => celebration.remove(), 2000);
    }

    // üî• Phase 7: Hi Experience Layer Initialization (Feature Flagged)
    async function initializeHiExperienceLayer() {
      try {
        // Check if hifeed_enabled flag is active (cohort-aware)
        const { isEnabledCohort } = await import('./lib/flags/HiFlags.js');
        const { trackEvent } = await import('./lib/monitoring/HiMonitor.js');
        
        const hiFeedEnabled = await isEnabledCohort('hifeed_enabled');
        
        // Track flag evaluation for telemetry
        trackEvent('flag_check', {
          key: 'hifeed_enabled',
          enabled: hiFeedEnabled,
          rollout: true,
          location: 'dashboard'
        });
        
        console.log('üîç HiFeed flag check (dashboard - cohort):', { 
          flagEnabled: hiFeedEnabled,
          rollout: true
        });
        
        if (hiFeedEnabled) {
          console.log('üî• HiFeed enabled - initializing experience layer components');
          
          // Show the experience layer container
          const experienceLayer = document.getElementById('hiExperienceLayer');
          if (experienceLayer) {
            experienceLayer.style.display = 'block';
          }
          
          // Initialize HiFeed component
          if (window.HiFeed) {
            const hiFeed = new window.HiFeed('#hiFeedContainer');
            await hiFeed.initialize();
            console.log('‚úÖ HiFeed component initialized');
          }
          
          // Initialize HiStreaks component
          if (window.HiStreaks) {
            const hiStreaks = new window.HiStreaks('#hiStreaksContainer');
            await hiStreaks.initialize();
            console.log('‚úÖ HiStreaks component initialized');
          }
          
        } else {
          console.log('üö´ HiFeed disabled - experience layer components not loaded');
        }
        
      } catch (error) {
        console.error('‚ùå Hi Experience Layer initialization error:', error);
      }
    }

    // Tesla-Grade Initialization
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize all components
      initializeDatabase();
      setupSelfHi5Handler();
      setupNavigationHandler();
      setupHiffirmationsHandler();
      setupWeeklyProgress();
      
      // HI-OS: Stats loading now handled by initHiStatsOnce() guard system
      console.log('üéØ Stats loading managed by Hi-OS init guard - no direct calls');
      
      // üî• Phase 7: Initialize Hi Experience Layer (Feature Flagged)
      initializeHiExperienceLayer();

    });

    // Calendar Integration
    function setupCalendarIntegration() {
      const btnCal = document.getElementById('btnCal');
      if (btnCal) {
        btnCal.addEventListener('click', () => {
          if (window.hiCalendarInstance) {
            window.hiCalendarInstance.show();
          } else {
            console.error('[HI DEV] Calendar not initialized');
          }
        });
      }
    }

    // METRICS SEPARATION: Debug exposure
    window.metricsDebug = {
      gWaves: () => gWaves,
      gTotalHis: () => gTotalHis,
      gUsers: () => gUsers,
      incrementHiWave,
      loadMetricsFromHiBase,
      updateGlobalStats
    };
  </script>

  <!-- Premium Component Scripts -->
  <script src="assets/premium-ux.js"></script>
  <script src="assets/premium-calendar.js"></script>
  <script src="./ui/HiFooter/HiFooter.js" defer></script>
  
  <!-- Hi Components: HiShareSheet + HiMedallion (Tesla-grade initialization) -->
  <script type="module">
    import { HiShareSheet } from './ui/HiShareSheet/HiShareSheet.js';
    import { mountHiMedallion } from './ui/HiMedallion/HiMedallion.js';
    
    // Tesla-grade component initialization with guards
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize components only once
      if (!window.__hiComponentsInitialized) {
        window.__hiComponentsInitialized = {};
      }
      
      // HiShareSheet - unified initialization (replaces duplicate at line 1008)
      if (!window.__hiComponentsInitialized.shareSheet) {
        const shareSheet = new HiShareSheet({ 
          origin: 'dashboard',
          onSuccess: () => {
            console.log('‚úÖ Dashboard Hi5 shared successfully!');
          }
        });
        shareSheet.init();
        
        // Store instance reference for button handlers
        window.__hiComponentsInitialized.shareSheet = true;
        window.__hiComponentsInitialized.shareSheetInstance = shareSheet;
      }
      
      // METRICS SEPARATION: Initialize HiMedallion with medallion tap handler
      const medallionContainer = document.getElementById('hiMedallionContainer');
      if (medallionContainer) {
        // First create the medallion HTML structure
        import('./ui/HiMedallion/HiMedallion.js').then(({ createHiMedallionHTML, mountHiMedallion }) => {
          // Create Tesla-grade medallion HTML
          medallionContainer.innerHTML = createHiMedallionHTML({
            id: 'dashboardMedallion',
            className: 'dashboard-medallion',
            dataAttributes: 'data-origin="dashboard" data-aria-label="Send positive energy to the Stay Hi community"'
          });
          
          // Find the created medallion element
          const medallionElement = medallionContainer.querySelector('.hi-medallion');
          if (medallionElement) {
            // Mount interactive behavior
            mountHiMedallion(medallionElement, {
              onTap: incrementHiWave, // Connect medallion tap to hi_events table
              origin: 'dashboard',
              ariaLabel: 'Send positive energy to the Stay Hi community'
            });
            
            console.log('üéØ Tesla-grade HiMedallion mounted on dashboard');
          }
        }).catch(error => {
          console.error('‚ùå Failed to load HiMedallion:', error);
        });
      }
    });
  </script>
  
  <!-- Initialize Premium Features -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // HI DEV: Calendar modal stacking fix (P2) - Initialize once only
      if (window.PremiumCalendar && !window.__hiCalendarInitialized) {
        window.__hiCalendarInitialized = true;
        window.hiCalendarInstance = new window.PremiumCalendar();
        console.log('[HI DEV] Calendar initialized once, stacking prevented');
        
        // Setup calendar integration
        setupCalendarIntegration();
      }
    });
  </script>

  <!-- üåç Tesla-Grade Unified Global Stats System -->
  <!-- DISABLED: Legacy stats system replaced by HiMetrics adapter -->
  <!-- <script src="assets/hi-unified-global-stats.js"></script> -->
</body>
</html>