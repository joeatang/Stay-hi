<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Stay Hi — Tesla Simplified</title>

  <!-- 📱 PWA Configuration -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD166">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Stay Hi">

  <!-- Tesla-Grade Premium Scripts -->
  <script src="assets/url-path-fixer.js"></script>
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" as="script">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  
  <!-- Database & Hi Island Integration -->
  <script src="assets/supabase-init.js"></script>
  <script src="assets/db.js"></script>
  
  <!-- Premium Authentication & UX -->
  <script src="assets/progressive-auth.js"></script>
  <script src="assets/anonymous-access-modal.js"></script>
  <script src="assets/unified-membership-system.js"></script>
  <script src="assets/performance-manager.js"></script>
  
  <!-- Tesla-Grade Onboarding System -->
  <script src="assets/onboarding.js"></script>
  
  <!-- Premium CSS Integration -->
  <link rel="preload" href="assets/premium-ux.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="assets/premium-calendar.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="assets/premium-footer.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="styles/modal-base.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  <!-- Hi Share Sheet Component -->
  <link rel="preload" href="components/hi-share-sheet/share-sheet.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  <noscript>
    <link rel="stylesheet" href="assets/premium-ux.css">
    <link rel="stylesheet" href="assets/premium-calendar.css">
    <link rel="stylesheet" href="assets/premium-footer.css">
    <link rel="stylesheet" href="styles/modal-base.css">
    <link rel="stylesheet" href="components/hi-share-sheet/share-sheet.css">
  </noscript>

  <style>
    body {
      background: linear-gradient(135deg, #2d1e4f 0%, #ff7a18 60%, #ffd166 100%);
      min-height: 100vh;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow-x: hidden;
    }

    /* Tesla-Grade Header with Mini Stats */
    .tesla-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
    }

    .header-left {
      display: flex;
      align-items: center;
      width: 60px; /* Fixed width for symmetry */
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      width: 60px; /* Fixed width for symmetry */
    }

    .brand-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-hi-logo {
      width: 24px;
      height: 24px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .brand-text {
      font-size: 18px;
      font-weight: 600;
      color: #FFD166;
      letter-spacing: -0.5px;
    }

    .calendar-btn, .menu-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: #FFD166;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .calendar-btn:hover, .menu-btn:hover {
      background: rgba(255, 209, 102, 0.2);
      transform: translateY(-1px);
    }

    /* Global Stats Container */
    .global-stats-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0 30px;
      flex-wrap: wrap;
    }

    .global-stat {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      min-width: 100px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .global-stat:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
      font-size: 18px;
    }

    .stat-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .stat-number {
      font-size: 18px;
      font-weight: 700;
      color: #FFD166;
      line-height: 1;
    }

    .stat-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    /* Main Content Area */
    .main-content {
      margin-top: 80px;
      padding: 20px 20px 100px; /* Extra bottom padding for footer */
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: calc(100vh - 180px); /* Account for header + footer */
    }

    /* 50% Scaled Medallion (Tesla Optimized) */
    .hi-medal-simplified {
      width: min(210px, 39vw); 
      aspect-ratio: 1/1; 
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.1) 0%, rgba(0, 0, 0, 0.8) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.1); 
      box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        0 0 60px rgba(255, 210, 102, 0.2);
      position: relative; 
      overflow: hidden; 
      transition: transform 0.25s cubic-bezier(0.25, 0.8, 0.25, 1),
                  box-shadow 0.25s ease;
      cursor: pointer;
      will-change: transform;
      user-select: none;
      margin: 20px auto; /* Center with auto margins */
      /* Tesla Architecture: Ensure container stability */
      transform-origin: center center;
    }

    .hi-medal-simplified:hover {
      transform: translateY(-5px) scale(1.02) translateZ(0);
      box-shadow: 
        0 35px 70px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        0 0 80px rgba(255, 210, 102, 0.4);
    }

    .hi-medal-simplified:active {
      transform: translateY(-2px) scale(0.98) translateZ(0);
    }

    /* Logo Container - Tesla Architecture: Separate Positioning from Animation */
    .hi-logo-simplified {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60%;
      height: 60%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none; /* Prevent logo from intercepting clicks */
    }

    /* Logo Animation Container - Independent from positioning */
    .hi-logo-simplified .logo-animation-wrapper {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .hi-mark-simplified {
      width: 100%;
      height: auto;
      max-width: 100px;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
    }

    /* Burst Animation Container */
    .burst-simplified {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    /* Enhanced Self Hi5 Button */
    .self-hi5-enhanced {
      margin: 30px 0;
      padding: 16px 32px;
      background: linear-gradient(135deg, #FF7A18 0%, #FFD166 100%);
      border: none;
      border-radius: 50px;
      color: #1a1a2e;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px rgba(255, 122, 24, 0.3);
      min-width: 180px;
    }

    .self-hi5-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(255, 122, 24, 0.4);
    }

    .self-hi5-enhanced:active {
      transform: translateY(0px);
    }

    /* Hiffirmations Modal Trigger */
    .hiffirmations-trigger {
      margin: 20px 0;
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .hiffirmations-trigger:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    /* Tesla-Grade Animation Classes */
    .pulse-simplified {
      animation: pulse-simplified 0.6s ease-out;
    }

    @keyframes pulse-simplified {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .logo-pop-simplified {
      animation: logo-pop-simplified 0.4s ease-out;
    }

    @keyframes logo-pop-simplified {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    /* Tesla-Grade Logo Animation Class */
    .logo-animation-wrapper.logo-pop-simplified {
      animation: logo-pop-simplified 0.4s ease-out;
    }

    /* Emoji Burst Animation */
    @keyframes waveUp-simplified {
      0% {
        transform: translate(-50%, -50%) translateX(0) translateY(0) scale(var(--s, 1));
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) translateX(var(--dx, 0)) translateY(-80px) scale(0.3);
        opacity: 0;
      }
    }

    /* Mobile Optimizations */
    @media (max-width: 480px) {
      .tesla-header {
        padding: 0 16px;
      }
      
      .header-left {
        gap: 12px;
      }
      
      .calendar-btn {
        width: 36px;
        height: 36px;
      }
      
      .tesla-logo {
        font-size: 16px;
      }
      
      .mini-stats {
        gap: 8px;
        font-size: 11px;
      }
      
      .mini-stat {
        padding: 3px 6px;
      }
      
      .hi-medal-simplified {
        width: min(180px, 45vw);
      }
      
      .self-hi5-enhanced {
        padding: 14px 28px;
        font-size: 16px;
        min-width: 160px;
      }
      
      .main-content {
        padding: 16px 16px 100px;
      }
    }

    /* Large screen optimizations */
    @media (min-width: 768px) {
      .main-content {
        padding: 40px 20px 120px;
      }
      
      .hi-medal-simplified {
        width: min(240px, 35vw);
      }
    }

    /* Navigation Modal */
    .navigation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .navigation-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .navigation-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .navigation-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(400px, 90vw);
      background: rgba(15, 16, 34, 0.95);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 24px;
      padding: 24px;
      color: white;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .navigation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .navigation-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #FFD166;
    }

    .close-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-nav-btn:hover {
      background: rgba(255, 0, 0, 0.2);
    }

    .navigation-menu {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .nav-section-title {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      text-decoration: none;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .nav-item.admin-item {
      background: rgba(255, 215, 0, 0.1);
      border-color: rgba(255, 215, 0, 0.2);
    }

    .nav-item.admin-item:hover {
      background: rgba(255, 215, 0, 0.2);
    }

    .nav-icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    /* Enhanced Weekly Progress Strip */
    .weekstrip {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 20px 0 30px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .weekdot {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 45px;
      transition: all 0.3s ease;
    }
    
    .weekdot:hover {
      transform: translateY(-2px);
    }
    
    .weekdot .lbl {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .weekdot .c {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 13px;
      font-weight: 600;
      border: 2px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.6);
      transition: all 0.3s ease;
    }
    
    .weekdot .c.met {
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
    }
    
    .weekdot .c.today {
      border-color: #FFD166;
      box-shadow: 0 0 0 2px rgba(255, 209, 102, 0.3);
    }
  </style>
</head>

<body>
  <!-- Tesla-Grade Header with Centered Branding -->
  <header class="tesla-header">
    <div class="header-left">
      <button id="btnCal" class="calendar-btn" aria-label="Open calendar" title="View Hi Calendar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="3" ry="3"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      </button>
    </div>
    
    <!-- Centered Brand with Hi Logo -->
    <div class="header-center">
      <div class="brand-container">
        <img src="assets/brand/hi-logo-light.png" alt="Hi" class="brand-hi-logo" />
        <span class="brand-text">Stay Hi</span>
      </div>
    </div>
    
    <!-- Navigation Menu -->
    <div class="header-right">
      <button id="btnMenu" class="menu-btn" aria-label="Open menu" title="Navigation Menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Global Stats Above Weekly Progress -->
    <div class="global-stats-container">
      <div class="global-stat">
        <span class="stat-icon">👋</span>
        <div class="stat-content">
          <span class="stat-number" id="globalHiWaves">...</span>
          <span class="stat-label">Hi Waves</span>
        </div>
      </div>
      <div class="global-stat">
        <span class="stat-icon">🔥</span>
        <div class="stat-content">
          <span class="stat-number" id="globalTotalHis">13</span>
          <span class="stat-label">Total His</span>
        </div>
      </div>
      <div class="global-stat">
        <span class="stat-icon">👥</span>
        <div class="stat-content">
          <span class="stat-number" id="globalUsers">8</span>
          <span class="stat-label">Users</span>
        </div>
      </div>
    </div>
    
    <!-- Weekly Progress Strip -->
    <div id="weekStrip" class="weekstrip" aria-label="Your week"></div>

    <!-- 50% Scaled Medallion -->
    <div class="hi-medal-simplified" id="hiMedalSimplified" aria-label="Tap to send Hi Wave">
      <div class="hi-logo-simplified" id="hiLogoSimplified">
        <div class="logo-animation-wrapper" id="logoAnimationWrapper">
          <img class="hi-mark-simplified" src="assets/brand/hi-logo-light.png" alt="Stay Hi" />
        </div>
      </div>
      <div class="burst-simplified" id="burstSimplified"></div>
    </div>

    <!-- Enhanced Self Hi5 Button -->
    <button class="self-hi5-enhanced" id="selfHi5Enhanced">
      🙌 Give Yourself a Hi5
    </button>

    <!-- Hiffirmations Modal Trigger -->
    <button class="hiffirmations-trigger" id="hiffirmationsTrigger">
      ✨ Daily Hiffirmations
    </button>
  </main>

  <!-- Navigation Menu Modal -->
  <div id="navigationModal" class="navigation-modal" style="display: none;">
    <div class="navigation-backdrop" id="navigationBackdrop"></div>
    <div class="navigation-content">
      <div class="navigation-header">
        <h3>Stay Hi Navigation</h3>
        <button id="closeNavigation" class="close-nav-btn">✕</button>
      </div>
      <div class="navigation-menu">
        <div class="nav-section">
          <div class="nav-section-title">Navigate</div>
          <a href="index.html" class="nav-item">
            <span class="nav-icon">🏠</span>
            <span>Hi Today</span>
          </a>
          <a href="hi-island-NEW.html" class="nav-item">
            <span class="nav-icon">🏝️</span>
            <span>Hi Island</span>
          </a>
          <a href="hi-muscle.html" class="nav-item">
            <span class="nav-icon">💪</span>
            <span>Hi Gym</span>
          </a>
          <a href="profile.html?from=hi-dashboard.html" class="nav-item">
            <span class="nav-icon">👤</span>
            <span>Profile</span>
          </a>
        </div>
        <div class="nav-section" id="adminSection" style="display: none;">
          <div class="nav-section-title">Admin</div>
          <a href="hi-mission-control.html" class="nav-item admin-item">
            <span class="nav-icon">🎛️</span>
            <span>Hi Mission Control</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tesla-Grade Simplified JavaScript
    // 🌍 UNIFIED STATS: No local variables - all data from Supabase via unified system
    let gWaves = null;        // Will be loaded from unified stats
    let gTotalHis = null;     // Will be loaded from unified stats  
    let gUsers = null;        // Will be loaded from unified stats
    let clickAnimationFrame = null;

    // DOM Elements
    const hiMedalSimplified = document.getElementById('hiMedalSimplified');
    const hiLogoSimplified = document.getElementById('hiLogoSimplified');
    const logoAnimationWrapper = document.getElementById('logoAnimationWrapper');
    const burstSimplified = document.getElementById('burstSimplified');
    const selfHi5Enhanced = document.getElementById('selfHi5Enhanced');
    const hiffirmationsTrigger = document.getElementById('hiffirmationsTrigger');

    // Header stats elements
    const headerHiWaves = document.getElementById('headerHiWaves');
    const headerTotalHis = document.getElementById('headerTotalHis');
    const headerUsers = document.getElementById('headerUsers');

    // Tesla-Grade Database Integration
    async function initializeDatabase() {
      try {
        if (typeof supabase !== 'undefined') {
          console.log('🎯 SURGICAL: Initializing Supabase client for hostname:', window.location.hostname);
          const { createClient } = supabase;
          window.db = createClient(
            'https://gfcubvroxgfvjhacinic.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmY3VidnJveGdmdmpoYWNpbmljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MTIyNjYsImV4cCI6MjA3NDQ4ODI2Nn0.5IlxofMPFNdKsEueM_dhgsJP9wI-GnZRUM9hfR0zE1g'
          );
          
          // Test database connection
          const { data, error } = await window.db.rpc('get_global_stats');
          if (!error && data && data.length > 0) {
            const stats = data[0];
            
            // 🎯 TESLA-GRADE: Correct field mapping from RPC response
            gWaves = stats.hi_waves || stats.total_hi_waves || 0;
            gTotalHis = stats.total_his || 0;
            gUsers = stats.total_users || stats.active_users_24h || 0;
            
            console.log('✅ Real global stats loaded:', { gWaves, gTotalHis, gUsers });
            updateGlobalStats();

          }
        }
      } catch (error) {
        console.error('❌ Database connection failed:', error);
      }
      
      // 🌍 LOAD STATS FROM UNIFIED SYSTEM - ensures identical data across all devices
      loadStatsFromUnifiedSystem();
    }

    // Load stats using unified system for cross-device consistency
    async function loadStatsFromUnifiedSystem() {
      try {
        if (window.HiUnifiedGlobalStats) {
          const stats = await window.HiUnifiedGlobalStats.getStats();
          
          if (stats.error) {
            console.error('❌ Unified stats system error:', stats.error_message);
            showStatsError();
            return;
          }
          
          // Update local variables from unified source
          gWaves = stats.hi_waves;
          gTotalHis = stats.total_his;
          gUsers = stats.total_users;
          
          console.log('✅ Stats loaded from unified system:', { gWaves, gTotalHis, gUsers });
          updateGlobalStats();
        } else {
          console.warn('⚠️ Unified stats system not ready, retrying...');
          setTimeout(loadStatsFromUnifiedSystem, 1000);
        }
      } catch (error) {
        console.error('❌ Failed to load from unified system:', error);
        showStatsError();
      }
    }

    // Show error state for consistency
    function showStatsError() {
      const elements = ['globalHiWaves', 'globalTotalHis', 'globalUsers'];
      elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = 'Error';
          element.style.color = '#ff6b6b';
        }
      });
    }

    // Update global stats display
    function updateGlobalStats() {
      const globalHiWaves = document.getElementById('globalHiWaves');
      const globalTotalHis = document.getElementById('globalTotalHis');
      const globalUsers = document.getElementById('globalUsers');
      
      if (globalHiWaves && gWaves !== null) globalHiWaves.textContent = gWaves.toLocaleString();
      if (globalTotalHis && gTotalHis !== null) globalTotalHis.textContent = gTotalHis.toLocaleString();
      if (globalUsers && gUsers !== null) globalUsers.textContent = gUsers.toLocaleString();
    }

    // Tesla-Grade Hi Wave Increment using unified tracking
    async function incrementHiWave() {
      try {
        console.log('🎯 SURGICAL: Medallion tapped on hi-dashboard');
        
        // � USE SURGICAL MEDALLION TAP TRACKING (1:1 with Global Waves)
        if (window.HiUnifiedStats && window.HiUnifiedStats.trackMedallionTap) {
          console.log('🎯 SURGICAL: Using unified stats medallion tracking...');
          const newCount = await window.HiUnifiedStats.trackMedallionTap();
          console.log('✅ SURGICAL SUCCESS: Medallion tap tracked, new count:', newCount);
          
          // Refresh the display immediately 
          setTimeout(loadStatsFromUnifiedSystem, 100);
          
        } else if (window.trackHiWave) {
          // Fallback to old system
          console.log('⚠️ SURGICAL FALLBACK: Using old trackHiWave system');
          const success = await window.trackHiWave(null, {
            source: 'hi-dashboard-medallion',
            timestamp: new Date().toISOString()
          });
          
          if (success) {
            console.log('✅ Hi wave tracked via unified system');
            setTimeout(loadStatsFromUnifiedSystem, 500);
          } else {
            console.warn('⚠️ Hi wave tracking failed via unified system');
          }
        } else {
          console.error('❌ SURGICAL ERROR: No tracking system available');
        }
      } catch (error) {
        console.error('💥 SURGICAL FAILURE: Medallion tap failed:', error);
      }
    }

    // Tesla-Grade Medallion Click Handler
    function setupMedallionHandler() {
      if (!hiMedalSimplified) return;

      hiMedalSimplified.addEventListener('click', async (e) => {
        e.preventDefault();
        
        // Cancel any pending animation
        if (clickAnimationFrame) {
          cancelAnimationFrame(clickAnimationFrame);
        }

        try { 
          navigator?.vibrate?.(25); 
        } catch {}

        // Increment Hi Wave
        await incrementHiWave();

        // Tesla-Grade Animation
        clickAnimationFrame = requestAnimationFrame(() => {
          // Immediate visual feedback - ONLY scale, maintain center origin
          hiMedalSimplified.style.transform = 'scale(0.98)';

          // Emoji burst animation
          for (let i = 0; i < 8; i++) {
            const emoji = document.createElement('span');
            const x = 50 + (Math.random() - 0.5) * 12;
            const y = 48 + (Math.random() - 0.5) * 8;
            
            emoji.textContent = '👋';
            emoji.style.position = 'absolute';
            emoji.style.left = x + '%';
            emoji.style.top = y + '%';
            emoji.style.transform = 'translate(-50%, -50%) translateZ(0)';
            emoji.style.setProperty('--dx', ((Math.random() - 0.5) * 120) + 'px');
            emoji.style.setProperty('--s', (0.8 + Math.random() * 0.4));
            emoji.style.animation = `waveUp-simplified 1000ms cubic-bezier(.22,1,.36,1) ${(Math.random() * 150) | 0}ms forwards`;
            emoji.style.willChange = 'transform, opacity';
            emoji.style.pointerEvents = 'none';
            emoji.style.fontSize = '16px';
            
            burstSimplified.appendChild(emoji);
            setTimeout(() => emoji.remove(), 1200);
          }

          // CSS Animation Classes - Tesla Architecture
          hiMedalSimplified.classList.remove('pulse-simplified');
          void hiMedalSimplified.offsetWidth;
          hiMedalSimplified.classList.add('pulse-simplified');

          // Logo animation on wrapper (preserves positioning)
          if (logoAnimationWrapper) {
            logoAnimationWrapper.classList.remove('logo-pop-simplified');
            void logoAnimationWrapper.offsetWidth;
            logoAnimationWrapper.classList.add('logo-pop-simplified');
          }

          // Reset transform
          setTimeout(() => {
            hiMedalSimplified.style.transform = '';
          }, 150);
        });
      });


    }

    // Enhanced Self Hi5 Handler
    function setupSelfHi5Handler() {
      if (!selfHi5Enhanced) return;

      selfHi5Enhanced.addEventListener('click', async (e) => {
        e.preventDefault();
        
        try { 
          navigator?.vibrate?.(50); 
        } catch {}

        // Visual feedback
        selfHi5Enhanced.style.transform = 'scale(0.95)';
        setTimeout(() => {
          selfHi5Enhanced.style.transform = '';
        }, 150);

        // Increment and celebrate
        await incrementHiWave();
        
        // 🏝️ HI ISLAND PIPING: Track global hi5 + personal user stats
        try {
          // Track global hi5 stat
          if (window.hiDB && window.hiDB.insertPublic) {
            const hi5Entry = {
              currentEmoji: '🙌',
              desiredEmoji: '✨',
              journal: 'Self Hi5 from Dashboard',
              location: await getCurrentUserLocation(),
              origin: 'dashboard',
              type: 'self_hi5'
            };
            
            await window.hiDB.insertPublic(hi5Entry);
            console.log('✅ Global hi5 tracked via Hi Island piping');
          }
          
          // Track personal user stats
          if (window.hiDB && window.hiDB.insertArchive) {
            const personalEntry = {
              currentEmoji: '🙌',
              desiredEmoji: '✨', 
              journal: 'Self Hi5 - Dashboard moment',
              location: await getCurrentUserLocation(),
              origin: 'dashboard',
              type: 'self_hi5'
            };
            
            await window.hiDB.insertArchive(personalEntry);
            console.log('✅ Personal hi5 stats tracked via Hi Island piping');
          }
        } catch (error) {
          console.warn('⚠️ Hi Island tracking failed (non-critical):', error);
        }
        
        // Open Self Hi5 share modal
        if (window.openHiShareSheet) {
          setTimeout(() => {
            window.openHiShareSheet('hi5');
          }, 300);
        } else {
          // Fallback: Show simple success message
          showCelebrationMessage('🎉 Hi5 shared! Keep spreading the positive energy!');
        }

      });
    }

    // Navigation Menu Handler
    function setupNavigationHandler() {
      const btnMenu = document.getElementById('btnMenu');
      const navigationModal = document.getElementById('navigationModal');
      const navigationBackdrop = document.getElementById('navigationBackdrop');
      const closeNavigation = document.getElementById('closeNavigation');

      if (!btnMenu || !navigationModal) return;

      const openNavigation = () => {
        navigationModal.classList.add('show');
        navigationModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Show admin section if user is admin (basic check)
        const adminSection = document.getElementById('adminSection');
        if (adminSection && (localStorage.getItem('isAdmin') === 'true' || window.location.href.includes('admin'))) {
          adminSection.style.display = 'block';
        }
      };

      const closeNavigationModal = () => {
        navigationModal.classList.remove('show');
        document.body.style.overflow = '';
        setTimeout(() => {
          if (!navigationModal.classList.contains('show')) {
            navigationModal.style.display = 'none';
          }
        }, 300);
      };

      btnMenu.addEventListener('click', openNavigation);
      closeNavigation.addEventListener('click', closeNavigationModal);
      navigationBackdrop.addEventListener('click', closeNavigationModal);
      
      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && navigationModal.classList.contains('show')) {
          closeNavigationModal();
        }
      });
    }

    // Hiffirmations Modal Handler
    function setupHiffirmationsHandler() {
      if (!hiffirmationsTrigger) return;

      hiffirmationsTrigger.addEventListener('click', (e) => {
        e.preventDefault();
        showHiffirmationsModal();
      });
    }

    // Tesla-Grade Daily Hiffirmation Generator (Consistent Daily Messages)
    function getDailyHiffirmation(date = new Date()) {
      const key = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
      let hash = 0;
      for (let i = 0; i < key.length; i++) {
        hash = (hash * 31 + key.charCodeAt(i)) | 0;
      }
      
      const hiffirmations = [
        "✨ You're radiating positive energy today",
        "🌟 Your Hi moments create ripples of joy", 
        "💫 You have the power to brighten someone's day",
        "🔥 Your authentic self is your superpower",
        "🌈 Every Hi you share makes the world brighter",
        "⭐ You're exactly where you need to be",
        "💝 Your presence is a gift to those around you",
        "🌺 You're growing stronger with each Hi moment",
        "🎯 Trust your journey, you're doing amazing",
        "💎 Your unique light can't be dimmed",
        "🚀 Your potential is limitless and inspiring",
        "🌸 You bring beauty to every moment",
        "⚡ Your energy lights up the room",
        "🏔️ You're stronger than any challenge",
        "🎨 Your creativity makes the world more colorful",
        "🌊 You flow with grace through life's changes",
        "🔮 Your intuition guides you perfectly",
        "🦋 You're transforming into your best self",
        "🌅 Each day brings new opportunities for you",
        "💪 Your resilience is truly remarkable",
        "🎵 Your soul sings a beautiful melody",
        "🌟 You're a beacon of hope for others",
        "🕊️ Peace follows you wherever you go",
        "🔥 Your passion ignites positive change",
        "🌻 You're growing toward the light every day",
        "⭐ Your dreams are valid and achievable",
        "🎯 You're aligned with your highest purpose",
        "💫 Magic happens when you believe in yourself",
        "🌈 You create your own beautiful reality",
        "🦄 Your uniqueness is your greatest strength"
      ];
      
      const dailyHiffirmation = hiffirmations[Math.abs(hash % hiffirmations.length)];
      return dailyHiffirmation;
    }

    // Get countdown to next Hiffirmation (midnight local time)
    function getNextHiffirmationCountdown() {
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(0, 0, 0, 0);
      
      const timeLeft = tomorrow - now;
      const hours = Math.floor(timeLeft / (1000 * 60 * 60));
      const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
      
      return { hours, minutes, timeLeft };
    }

    // Premium Hiffirmations Modal
    function showHiffirmationsModal(customDate = null) {
      const targetDate = customDate || new Date();
      const dailyHiffirmation = getDailyHiffirmation(targetDate);
      const countdown = getNextHiffirmationCountdown();
      
      // Date display for non-today dates
      const isToday = !customDate || (
        targetDate.toDateString() === new Date().toDateString()
      );
      const dateLabel = isToday ? 'Today' : targetDate.toLocaleDateString('en-US', { 
        weekday: 'long', 
        month: 'short', 
        day: 'numeric' 
      });

      // Create modal with premium styling
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 15000;
        display: flex; align-items: center; justify-content: center;
        background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);
      `;
      
      modal.innerHTML = `
        <div style="
          background: rgba(15, 16, 34, 0.95); backdrop-filter: blur(25px);
          border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 24px;
          padding: 32px; max-width: 400px; width: 90vw; text-align: center; color: white;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); position: relative;
        ">
          <h3 style="margin: 0 0 8px; color: #FFD166; font-size: 24px;">✨ ${isToday ? 'Daily' : dateLabel} Hiffirmation</h3>
          
          <!-- Countdown Timer (only for today) -->
          ${isToday ? `
          <div style="
            font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 20px;
            padding: 8px 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
          ">
            Next Hiffirmation in ${countdown.hours}h ${countdown.minutes}m
          </div>
          ` : ''}
          
          <!-- Daily Message -->
          <div style="font-size: 18px; line-height: 1.5; margin: 24px 0; color: rgba(255, 255, 255, 0.9);">
            ${dailyHiffirmation}
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
            <button class="hiffirmation-share" style="
              padding: 12px 20px; background: linear-gradient(135deg, #4ECDC4, #44A08D);
              border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer;
              transition: transform 0.2s ease;
            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
              Share This
            </button>
            <button class="hiffirmation-yesterday" style="
              padding: 12px 20px; background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; 
              color: white; font-weight: 600; cursor: pointer;
              transition: all 0.2s ease;
            " onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
              Yesterday's
            </button>
          </div>
          
          <!-- Close Button -->
          <button class="close-hiffirmation" style="
            position: absolute; top: 16px; right: 16px; width: 32px; height: 32px;
            border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.1);
            color: white; cursor: pointer; font-size: 16px;
            transition: background 0.2s ease;
          " onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
            ✕
          </button>
        </div>
      `;

      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';

      // Event handlers
      const closeModal = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      };

      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
      modal.querySelector('.close-hiffirmation').addEventListener('click', closeModal);
      
      // Yesterday's Hiffirmation button
      modal.querySelector('.hiffirmation-yesterday').addEventListener('click', () => {
        closeModal();
        setTimeout(() => {
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          showHiffirmationsModal(yesterday);
        }, 100);
      });
      
      // Share button
      modal.querySelector('.hiffirmation-share').addEventListener('click', () => {
        if (navigator.share) {
          navigator.share({
            title: 'Daily Hiffirmation from Stay Hi',
            text: dailyHiffirmation,
            url: window.location.href
          });
        } else {
          navigator.clipboard.writeText(dailyHiffirmation);
          // Visual feedback
          const shareBtn = modal.querySelector('.hiffirmation-share');
          const originalText = shareBtn.textContent;
          shareBtn.textContent = '✓ Copied!';
          shareBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
          setTimeout(() => {
            shareBtn.textContent = originalText;
            shareBtn.style.background = 'linear-gradient(135deg, #4ECDC4, #44A08D)';
          }, 1500);
        }
      });
    }

    // Weekly Progress Strip (Simplified)
    function setupWeeklyProgress() {
      const weekStrip = document.getElementById('weekStrip');
      if (!weekStrip) return;

      const today = new Date();
      let html = '';
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const label = date.toLocaleDateString(undefined, { weekday: 'short' }).toUpperCase();
        const dayNum = date.getDate();
        const isToday = i === 0;
        const metClass = Math.random() > 0.3 ? 'met' : '';  // Simplified logic
        
        html += `<div class="weekdot">
          <div class="lbl">${label}</div>
          <div class="c ${metClass}">${dayNum}</div>
        </div>`;
      }
      
      weekStrip.innerHTML = html;
    }

    // 🌍 Helper: Get current user location for hi island piping
    async function getCurrentUserLocation() {
      try {
        // Check localStorage cache first
        const cached = localStorage.getItem('hi_user_location');
        if (cached) {
          const locationData = JSON.parse(cached);
          if (Date.now() - locationData.timestamp < 24 * 60 * 60 * 1000) { // 24 hour cache
            return locationData.location;
          }
        }
        
        // Default to 'Virtual Hi Island' for dashboard hi5s
        return 'Virtual Hi Island';
      } catch (error) {
        console.warn('Location lookup failed, using default:', error);
        return 'Virtual Hi Island';
      }
    }

    // 🎉 Helper: Show celebration message
    function showCelebrationMessage(message) {
      // Create temporary celebration overlay
      const celebration = document.createElement('div');
      celebration.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #FFD166, #FF7B24);
        color: #000;
        padding: 20px 30px;
        border-radius: 20px;
        font-size: 18px;
        font-weight: 600;
        box-shadow: 0 10px 30px rgba(255, 123, 24, 0.4);
        z-index: 10000;
        animation: celebrationPop 2s ease-out forwards;
      `;
      celebration.textContent = message;
      
      // Add animation keyframes
      if (!document.getElementById('celebrationStyles')) {
        const style = document.createElement('style');
        style.id = 'celebrationStyles';
        style.textContent = `
          @keyframes celebrationPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(celebration);
      setTimeout(() => celebration.remove(), 2000);
    }

    // Tesla-Grade Initialization
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize all components
      initializeDatabase();
      setupMedallionHandler();
      setupSelfHi5Handler();
      setupNavigationHandler();
      setupHiffirmationsHandler();
      setupWeeklyProgress();
      
      // 🌍 PRIORITY: Load stats from unified system for cross-device consistency
      console.log('🎯 Loading stats from unified system for consistent data...');
      loadStatsFromUnifiedSystem();
      

    });

    // Calendar Integration
    function setupCalendarIntegration() {
      const btnCal = document.getElementById('btnCal');
      if (btnCal) {
        btnCal.addEventListener('click', () => {
          if (window.PremiumCalendar) {
            window.PremiumCalendar.show();
          } else {

          }
        });
      }
    }

    // Expose for debugging
    window.teslaDebug = {
      gWaves: () => gWaves,
      gTotalHis: () => gTotalHis,
      gUsers: () => gUsers,
      incrementHiWave,
      updateGlobalStats
    };
  </script>

  <!-- Premium Component Scripts -->
  <script src="assets/premium-ux.js"></script>
  <script src="assets/premium-calendar.js"></script>
  <script src="assets/premium-footer.js" defer></script>
  
  <!-- Hi Share Sheet Component -->
  <script type="module">
    import { HiShareSheet } from './components/hi-share-sheet/share-sheet.js';
    
    // Initialize Hi Share Sheet for dashboard hi5 functionality
    document.addEventListener('DOMContentLoaded', () => {
      const shareSheet = new HiShareSheet({ 
        origin: 'dashboard',
        onSuccess: () => {
          console.log('✅ Dashboard Hi5 shared successfully!');
        }
      });
      shareSheet.init();
    });
  </script>
  
  <!-- Initialize Premium Features -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize calendar integration
      setupCalendarIntegration();
      
      // Initialize premium calendar if available
      if (window.PremiumCalendar) {
        window.PremiumCalendar = new window.PremiumCalendar();
      }
    });
  </script>

  <!-- 🌍 Tesla-Grade Unified Global Stats System -->
  <script src="assets/hi-unified-global-stats.js"></script>
</body>
</html>