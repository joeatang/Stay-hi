<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiMetrics Testing Console</title>
    <style>
        body {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: #1a1a1a;
            color: #00ff41;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-family: inherit;
        }
        
        .test-button:hover {
            background: #005a9e;
        }
        
        .output {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .metric-display {
            display: inline-block;
            background: #333;
            padding: 8px 16px;
            border-radius: 4px;
            margin: 5px;
            border: 1px solid #555;
        }
        
        .status {
            color: #ffd700;
            font-weight: bold;
        }
        
        .error {
            color: #ff4444;
        }
        
        .success {
            color: #44ff44;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß HiMetrics Testing Console</h1>
            <p>Tesla-Grade Metrics Adapter Validation</p>
        </div>
        
        <!-- Live Metrics Display -->
        <div class="test-section">
            <h3>üìä Live Metrics</h3>
            <div class="metric-display">
                Hi Waves: <span id="wavesValue">...</span>
            </div>
            <div class="metric-display">
                Total Hi5s: <span id="hi5sValue">...</span>
            </div>
            <div class="metric-display">
                Cache Age: <span id="cacheAge">...</span>
            </div>
            <div class="metric-display">
                Status: <span id="metricsStatus" class="status">initializing...</span>
            </div>
        </div>
        
        <!-- Test Controls -->
        <div class="test-section">
            <h3>üß™ Test Controls</h3>
            <button class="test-button" onclick="testLoadMetrics()">Load Metrics</button>
            <button class="test-button" onclick="testForceRefresh()">Force Refresh</button>
            <button class="test-button" onclick="testCacheHit()">Test Cache Hit</button>
            <button class="test-button" onclick="testSubscription()">Test Subscription</button>
            <button class="test-button" onclick="clearOutput()">Clear Output</button>
        </div>
        
        <!-- Console Output -->
        <div class="test-section">
            <h3>üñ•Ô∏è Console Output</h3>
            <div id="output" class="output">
                HiMetrics Testing Console Ready...<br>
            </div>
        </div>
        
        <!-- Test Results -->
        <div class="test-section">
            <h3>‚úÖ Test Results</h3>
            <div id="testResults"></div>
        </div>
    </div>

    <!-- Load HiBase and HiMetrics -->
    <script type="module">
        // Import HiBase first
        import HiBase from '../hibase/index.js';
        window.HiBase = HiBase;
        
        // Import HiMetrics
        import HiMetrics from '../lib/HiMetrics.js';
        window.HiMetrics = HiMetrics;
        
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span><br>`;
            output.scrollTop = output.scrollHeight;
        }
        
        // Subscribe to metrics updates
        let unsubscribe = null;
        
        function initMetricsDisplay() {
            log('üîß Initializing HiMetrics display...');
            
            unsubscribe = HiMetrics.subscribe('test-console', (metrics, cacheInfo) => {
                log(`üìä Metrics updated: ${JSON.stringify(metrics)}`, 'success');
                
                // Update display
                document.getElementById('wavesValue').textContent = (metrics.waves || 0).toLocaleString();
                document.getElementById('hi5sValue').textContent = (metrics.hi5s || 0).toLocaleString();
                document.getElementById('cacheAge').textContent = `${cacheInfo?.ageSeconds || 0}s`;
                document.getElementById('metricsStatus').textContent = cacheInfo?.fromCache ? 'cached ‚úÖ' : 'fresh üîÑ';
            });
        }
        
        // Test functions
        window.testLoadMetrics = async () => {
            log('üß™ Testing HiMetrics.load()...');
            try {
                const metrics = await HiMetrics.load();
                log(`‚úÖ Metrics loaded: ${JSON.stringify(metrics)}`, 'success');
                addTestResult('Load Metrics', 'PASS', JSON.stringify(metrics));
            } catch (error) {
                log(`‚ùå Load failed: ${error.message}`, 'error');
                addTestResult('Load Metrics', 'FAIL', error.message);
            }
        };
        
        window.testForceRefresh = async () => {
            log('üß™ Testing force refresh...');
            try {
                const metrics = await HiMetrics.load(true);
                log(`‚úÖ Force refresh completed: ${JSON.stringify(metrics)}`, 'success');
                addTestResult('Force Refresh', 'PASS', 'Fresh data loaded');
            } catch (error) {
                log(`‚ùå Force refresh failed: ${error.message}`, 'error');
                addTestResult('Force Refresh', 'FAIL', error.message);
            }
        };
        
        window.testCacheHit = async () => {
            log('üß™ Testing cache hit behavior...');
            try {
                const start = Date.now();
                const metrics1 = await HiMetrics.load();
                const metrics2 = await HiMetrics.load();
                const duration = Date.now() - start;
                
                const sameData = JSON.stringify(metrics1) === JSON.stringify(metrics2);
                log(`‚úÖ Cache test: ${sameData ? 'CONSISTENT' : 'INCONSISTENT'} (${duration}ms)`, 'success');
                addTestResult('Cache Hit', sameData ? 'PASS' : 'FAIL', `${duration}ms duration`);
            } catch (error) {
                log(`‚ùå Cache test failed: ${error.message}`, 'error');
                addTestResult('Cache Hit', 'FAIL', error.message);
            }
        };
        
        window.testSubscription = () => {
            log('üß™ Testing subscription system...');
            
            let notifyCount = 0;
            const testUnsubscribe = HiMetrics.subscribe('test-sub', (metrics) => {
                notifyCount++;
                log(`üì° Test subscriber notified (#${notifyCount}): ${JSON.stringify(metrics)}`);
            });
            
            // Trigger a load to test notification
            setTimeout(async () => {
                await HiMetrics.load(true);
                setTimeout(() => {
                    testUnsubscribe();
                    const result = notifyCount > 0 ? 'PASS' : 'FAIL';
                    addTestResult('Subscription', result, `${notifyCount} notifications received`);
                    log(`‚úÖ Subscription test completed (${notifyCount} notifications)`, 'success');
                }, 500);
            }, 100);
        };
        
        window.clearOutput = () => {
            document.getElementById('output').innerHTML = 'Console cleared...<br>';
        };
        
        function addTestResult(testName, status, details) {
            const resultsDiv = document.getElementById('testResults');
            const statusClass = status === 'PASS' ? 'success' : 'error';
            resultsDiv.innerHTML += `
                <div class="metric-display">
                    <strong>${testName}:</strong> 
                    <span class="${statusClass}">${status}</span>
                    <small>${details}</small>
                </div>
            `;
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ HiMetrics Testing Console Initialized');
            initMetricsDisplay();
            
            // Auto-load initial metrics
            setTimeout(() => {
                testLoadMetrics();
            }, 1000);
        });
        
        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
                log('üßπ Subscription cleaned up');
            }
        });
    </script>
</body>
</html>