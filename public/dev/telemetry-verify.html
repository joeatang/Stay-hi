<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Hi Telemetry — Local Verify</title>
  
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 24px; background:#0f1022; color:#fff; }
    .wrap { max-width: 720px; margin: 0 auto; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; }
    h1 { margin: 0 0 12px; font-size: 20px; color:#FFD166; }
    label { display:block; font-weight:600; margin:12px 0 6px; }
    input[type=text], input[type=password] { width: 100%; padding: 10px 12px; border-radius: 8px; border:1px solid #333; background:#121431; color:#fff; }
    .row { display:flex; gap:12px; align-items:center; }
    .row > * { flex:1; }
    button { background: linear-gradient(135deg, #FFD166, #FF7B24); color:#111; border:none; padding:10px 16px; border-radius: 8px; font-weight:700; cursor:pointer; }
    button:disabled { opacity: 0.6; cursor: default; }
    .log { margin-top: 16px; background:#0c0e26; border:1px solid #222649; border-radius:8px; padding:12px; max-height: 320px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .ok { color:#10b981; }
    .err { color:#f87171; }
    .hint { color:#b3b7d1; font-size: 12px; }
  </style>
  <!-- Supabase UMD (pinned + SRI) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.81.1/dist/umd/supabase.min.js"
          integrity="sha384-XLEuzmdNfK1V09d59bu+Uv3EFtEp5kFP8BmseBq85CUpeFZXhUfqjk4ZeR/biZmS"
          crossorigin="anonymous"></script>
</head>
<body>
  <div class="wrap">
    <h1>Hi Telemetry — Local Verify</h1>
    <p class="hint">Use your Supabase Project URL and anon public key. Nothing is saved.</p>

    <label for="url">SUPABASE_URL</label>
    <input id="url" type="text" placeholder="https://YOUR-PROJECT.supabase.co" autocomplete="off"/>

    <div class="row">
      <div>
        <label for="key">SUPABASE_ANON_KEY</label>
        <input id="key" type="password" placeholder="eyJhbGciOi..." autocomplete="off"/>
      </div>
      <div style="flex:0 0 auto; align-self:flex-end;">
        <label style="display:flex; gap:8px; align-items:center; font-weight:500;">
          <input id="reveal" type="checkbox"/> Reveal
        </label>
      </div>
    </div>

    <div style="display:flex; gap:12px; align-items:center; margin-top:14px;">
      <button id="run">Run Verify</button>
      <span class="hint">Inserts into: perf_beacons, integrity_events, error_events, track_events</span>
    </div>

    <div class="log" id="log" aria-live="polite"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const log = (msg, cls) => {
      const el = document.createElement('div');
      if (cls) el.className = cls;
      el.textContent = msg;
      $('log').appendChild(el);
      $('log').scrollTop = $('log').scrollHeight;
    };

    $('reveal').addEventListener('change', (e) => {
      $('key').type = e.target.checked ? 'text' : 'password';
    });

    function nowMs(){ return Date.now(); }
    function randTag(){ return 'verify-' + Math.random().toString(36).slice(2,8); }

    async function verify(url, key){
      const client = window.supabase.createClient(url, key);
      const base = { ts: nowMs(), build_tag: randTag(), path: '/verify' };
      // perf_beacons
      {
        const payload = { ...base, ttfb:100.1, lcp:1200.5, fid:12.3, cls:0.01, fcp:600.2, tbt:45.6, long_tasks:0, resources:{ sample:true } };
        const { error } = await client.from('perf_beacons').insert(payload);
        if (error) throw new Error('perf_beacons: ' + error.message);
        log('✔ perf_beacons insert ok', 'ok');
      }
      // integrity_events
      {
        const payload = { ...base, src:'https://cdn.example.com/lib.js', event_type:'missing', expected:null, actual:null };
        const { error } = await client.from('integrity_events').insert(payload);
        if (error) throw new Error('integrity_events: ' + error.message);
        log('✔ integrity_events insert ok', 'ok');
      }
      // error_events
      {
        const payload = { ...base, type:'error', message:'Telemetry verify test', stack:'stack...', src:'verify.js', line:1, col:1 };
        const { error } = await client.from('error_events').insert(payload);
        if (error) throw new Error('error_events: ' + error.message);
        log('✔ error_events insert ok', 'ok');
      }
      // track_events
      {
        const payload = { ...base, event:'verify_event', data:{ ok:true } };
        const { error } = await client.from('track_events').insert(payload);
        if (error) throw new Error('track_events: ' + error.message);
        log('✔ track_events insert ok', 'ok');
      }
    }

    $('run').addEventListener('click', async () => {
      $('log').textContent = '';
      const url = $('url').value.trim();
      const key = $('key').value.trim();
      if (!url || !key){ log('Please enter both URL and anon key','err'); return; }
      $('run').disabled = true;
      log('Starting verification...');
      try {
        await verify(url, key);
        log('✅ All inserts succeeded — check Supabase tables for /verify rows', 'ok');
      } catch(e){
        log('❌ Failed: ' + (e && e.message ? e.message : e), 'err');
      } finally {
        $('run').disabled = false;
      }
    });
  </script>
</body>
</html>
