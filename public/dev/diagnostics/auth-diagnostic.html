<!DOCTYPE html>
<html>
<head>
    <title>üî• Tesla Auth Diagnostic</title>
    <style>
        body { font-family: system-ui; background: #1a1a2e; color: white; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: rgba(255,255,255,0.05); padding: 20px; margin: 20px 0; border-radius: 8px; }
        .btn { background: #00d4ff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0099cc; }
        .btn-danger { background: #ff4444; }
        .log-entry { background: #2a2a3e; padding: 10px; margin: 5px 0; border-radius: 4px; font-family: monospace; font-size: 13px; }
        .success { border-left: 4px solid #00ff88; }
        .error { border-left: 4px solid #ff4444; }
        .warning { border-left: 4px solid #ffaa00; }
        .info { border-left: 4px solid #00d4ff; }
        .data-display { background: #000; padding: 15px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Tesla Auth Diagnostic</h1>
        <p><strong>Mission:</strong> Find out why you're seeing demo mode when you have real profile data</p>
        
        <div class="section">
            <h3>üéØ Critical Auth Tests</h3>
            <button class="btn" onclick="fullAuthDiagnostic()">üöÄ Full Auth Diagnostic</button>
            <button class="btn" onclick="checkCurrentAuthState()">üîç Check Current Auth State</button>
            <button class="btn" onclick="testSupabaseConnection()">‚òÅÔ∏è Test Supabase Connection</button>
            <button class="btn" onclick="findRealProfileData()">üë§ Find Real Profile Data</button>
        </div>
        
        <div class="section">
            <h3>‚ö° Quick Fixes</h3>
            <button class="btn" onclick="forceReauth()">üîÑ Force Re-Authentication</button>
            <button class="btn" onclick="clearAuthCache()">üßπ Clear Auth Cache</button>
            <button class="btn btn-danger" onclick="emergencyAuthReset()">üö® Emergency Auth Reset</button>
        </div>
        
        <div class="section">
            <h3>üìä Diagnostic Log</h3>
            <div id="diagnosticLog"></div>
        </div>
        
        <div class="section">
            <h3>üíæ Auth Data State</h3>
            <div id="authDataState"></div>
        </div>
    </div>
    
    <script src="assets/config.js"></script>
    <script>
        let supabase;
        
        async function initSupabase() {
            try {
                if (supabase) return true;
                // Prefer canonical client if available
                if (typeof window.getSupabase === 'function') {
                    supabase = window.getSupabase();
                    return !!supabase;
                }
                if (window.HiSupabase?.getClient) {
                    supabase = window.HiSupabase.getClient();
                    return !!supabase;
                }
                // Fallback: wait for readiness event
                const ready = await new Promise((resolve) => {
                    let settled = false;
                    const onReady = (e) => { if (settled) return; settled = true; supabase = e.detail.client; resolve(true); };
                    window.addEventListener('supabase-ready', onReady, { once: true });
                    // Safety timeout; if UMD already present, use it
                    setTimeout(() => {
                        if (settled) return;
                        if (window.supabase?.createClient && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
                            try {
                                supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                                settled = true; resolve(true);
                            } catch(_) { resolve(false); }
                        } else {
                            resolve(false);
                        }
                    }, 500);
                });
                return ready && !!supabase;
            } catch { return false; }
        }
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('diagnosticLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function displayData(data, title) {
            const dataDiv = document.getElementById('authDataState');
            const section = document.createElement('div');
            section.innerHTML = `
                <h4>${title}</h4>
                <div class="data-display">${JSON.stringify(data, null, 2)}</div>
            `;
            dataDiv.appendChild(section);
        }
        
        async function fullAuthDiagnostic() {
            log('üî• Tesla-grade auth diagnostic starting...', 'info');
            
            // Step 1: Check window auth state
            log('1Ô∏è‚É£ Checking window.userAuthenticated state...', 'info');
            if (typeof window.userAuthenticated !== 'undefined') {
                log(`   window.userAuthenticated = ${window.userAuthenticated}`, window.userAuthenticated ? 'success' : 'error');
                if (!window.userAuthenticated) {
                    log('   üö® THIS IS WHY YOU\'RE IN DEMO MODE!', 'error');
                }
            } else {
                log('   window.userAuthenticated is undefined', 'warning');
            }
            
            // Step 2: Check Supabase init
            log('2Ô∏è‚É£ Initializing Supabase client...', 'info');
            const supabaseReady = await initSupabase();
            log(`   Supabase client: ${supabaseReady ? 'Ready' : 'Failed'}`, supabaseReady ? 'success' : 'error');
            
            if (!supabaseReady) {
                log('   üö® Supabase not available - this could be the issue!', 'error');
                return;
            }
            
            // Step 3: Check session
            log('3Ô∏è‚É£ Checking Supabase session...', 'info');
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            
            if (sessionError) {
                log(`   Session error: ${sessionError.message}`, 'error');
            } else if (session) {
                log(`   ‚úÖ Active session found!`, 'success');
                log(`   User: ${session.user.email}`, 'success');
                log(`   Expires: ${new Date(session.expires_at * 1000).toLocaleString()}`, 'info');
                displayData(session.user, 'Session User Data');
                
                // Step 4: Check if session is expired
                const now = Math.floor(Date.now() / 1000);
                if (session.expires_at < now) {
                    log('   üö® SESSION IS EXPIRED! This is the problem!', 'error');
                } else {
                    log('   ‚úÖ Session is still valid', 'success');
                }
                
            } else {
                log('   ‚ùå No active session', 'error');
                log('   üö® THIS IS WHY AUTH GUARD SETS userAuthenticated=false', 'error');
            }
            
            // Step 5: Check localStorage auth data
            log('4Ô∏è‚É£ Checking localStorage auth data...', 'info');
            const authKeys = Object.keys(localStorage).filter(key => 
                key.includes('supabase') || key.includes('sb-') || key.includes('auth')
            );
            
            if (authKeys.length > 0) {
                log(`   Found ${authKeys.length} auth-related localStorage keys`, 'success');
                authKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value && value.includes('access_token')) {
                        log(`   üìç ${key}: Contains access token`, 'success');
                    } else if (value) {
                        log(`   üìç ${key}: ${value.substring(0, 50)}...`, 'info');
                    }
                });
            } else {
                log('   ‚ùå No auth data in localStorage', 'error');
            }
            
            // Step 6: Test auth method
            log('5Ô∏è‚É£ Testing auth method from auth-guard...', 'info');
            try {
                // Replicate auth-guard logic
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    log(`   ‚úÖ Auth method works - User found: ${user.email}`, 'success');
                    log('   üîç So why is auth-guard setting userAuthenticated=false?', 'warning');
                } else {
                    log('   ‚ùå Auth method returns no user', 'error');
                }
            } catch (authError) {
                log(`   ‚ùå Auth method failed: ${authError.message}`, 'error');
            }
        }
        
        async function checkCurrentAuthState() {
            log('üîç Checking current authentication state...', 'info');
            
            const states = {
                'window.userAuthenticated': window.userAuthenticated,
                'window.demoMode': window.demoMode,
                'supabase available': typeof supabase !== 'undefined'
            };
            
            Object.entries(states).forEach(([key, value]) => {
                log(`   ${key}: ${value}`, typeof value === 'boolean' ? (value ? 'success' : 'error') : 'info');
            });
        }
        
        async function testSupabaseConnection() {
            log('‚òÅÔ∏è Testing Supabase connection...', 'info');
            
            try {
                await initSupabase();
                const { data, error } = await supabase.from('profiles').select('count', { count: 'exact' });
                
                if (error) {
                    log(`   Database connection failed: ${error.message}`, 'error');
                } else {
                    log('   ‚úÖ Database connection working', 'success');
                    log(`   Profiles table accessible`, 'success');
                }
            } catch (connError) {
                log(`   Connection test failed: ${connError.message}`, 'error');
            }
        }
        
        async function findRealProfileData() {
            log('üë§ Searching for your real profile data...', 'info');
            
            // Check localStorage for any profile data
            const profileKeys = ['stayhi_profile', 'user_profile', 'profile', 'currentUser', 'demo-profile'];
            
            profileKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        log(`   Found data in ${key}`, 'success');
                        if (parsed.display_name && parsed.display_name !== 'Demo User') {
                            log(`   üéØ Real data found: ${parsed.display_name}`, 'success');
                            displayData(parsed, `Real Profile Data (${key})`);
                        }
                    } catch (e) {
                        log(`   Invalid data in ${key}`, 'warning');
                    }
                }
            });
            
            // Try to fetch from database if we have auth
            try {
                await initSupabase();
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    const { data: profiles } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', session.user.id);
                        
                    if (profiles && profiles.length > 0) {
                        log(`   üéØ Found ${profiles.length} database profile(s)!`, 'success');
                        profiles.forEach((profile, i) => {
                            displayData(profile, `Database Profile ${i + 1}`);
                        });
                    }
                }
            } catch (dbError) {
                log(`   Database search failed: ${dbError.message}`, 'error');
            }
        }
        
        async function forceReauth() {
            log('üîÑ Forcing re-authentication...', 'info');
            
            try {
                await initSupabase();
                
                // Try to refresh the session
                const { data, error } = await supabase.auth.refreshSession();
                
                if (error) {
                    log(`   Refresh failed: ${error.message}`, 'error');
                    log('   Redirecting to sign-in...', 'info');
                    window.location.href = 'signin.html';
                } else {
                    log('   ‚úÖ Session refreshed successfully', 'success');
                    window.location.reload();
                }
            } catch (refreshError) {
                log(`   Re-auth failed: ${refreshError.message}`, 'error');
            }
        }
        
        function clearAuthCache() {
            log('üßπ Clearing authentication cache...', 'info');
            
            const authKeys = Object.keys(localStorage).filter(key => 
                key.includes('supabase') || key.includes('sb-') || key.includes('auth')
            );
            
            authKeys.forEach(key => {
                localStorage.removeItem(key);
                log(`   Removed ${key}`, 'success');
            });
            
            log('   Cache cleared - reloading page...', 'info');
            setTimeout(() => window.location.reload(), 1000);
        }
        
        function emergencyAuthReset() {
            if (!confirm('üö® This will completely reset your authentication. Continue?')) return;
            
            log('üö® Emergency auth reset initiated...', 'warning');
            
            // Clear all auth data
            localStorage.clear();
            sessionStorage.clear();
            
            log('   All storage cleared', 'warning');
            log('   Redirecting to sign-in...', 'info');
            
            setTimeout(() => {
                window.location.href = 'signin.html';
            }, 1000);
        }
        
        // Auto-diagnostic on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('üî• Tesla auth diagnostic ready', 'success');
                log('Click "Full Auth Diagnostic" to find why you\'re in demo mode', 'info');
            }, 500);
        });
    </script>
</body>
</html>